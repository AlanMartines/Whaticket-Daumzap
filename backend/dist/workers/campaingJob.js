const a572_0x368397=a572_0x22c7;(function(_0x2b22db,_0x2164fc){const _0x4dc9e4=a572_0x22c7,_0x593acf=_0x2b22db();while(!![]){try{const _0x3dd02d=parseInt(_0x4dc9e4(0xa9))/0x1+parseInt(_0x4dc9e4(0xec))/0x2+parseInt(_0x4dc9e4(0xce))/0x3+parseInt(_0x4dc9e4(0xd6))/0x4*(-parseInt(_0x4dc9e4(0x12e))/0x5)+-parseInt(_0x4dc9e4(0xef))/0x6+-parseInt(_0x4dc9e4(0x12d))/0x7*(parseInt(_0x4dc9e4(0xe7))/0x8)+parseInt(_0x4dc9e4(0x105))/0x9;if(_0x3dd02d===_0x2164fc)break;else _0x593acf['push'](_0x593acf['shift']());}catch(_0x4409f4){_0x593acf['push'](_0x593acf['shift']());}}}(a572_0x26a6,0x440c9));const a572_0x1dc437=(function(){let _0x39d164=!![];return function(_0xd6f857,_0x544ca6){const _0x42a0da=_0x39d164?function(){if(_0x544ca6){const _0x338947=_0x544ca6['apply'](_0xd6f857,arguments);return _0x544ca6=null,_0x338947;}}:function(){};return _0x39d164=![],_0x42a0da;};}()),a572_0x5b8cbf=a572_0x1dc437(this,function(){const _0x31553f=a572_0x22c7;return a572_0x5b8cbf[_0x31553f(0xe1)]()[_0x31553f(0xae)](_0x31553f(0x121))[_0x31553f(0xe1)]()[_0x31553f(0xdb)](a572_0x5b8cbf)[_0x31553f(0xae)](_0x31553f(0x121));});function a572_0x22c7(_0x185ea9,_0xd20d1c){const _0x1da7e7=a572_0x26a6();return a572_0x22c7=function(_0x5b8cbf,_0x1dc437){_0x5b8cbf=_0x5b8cbf-0xa6;let _0x26a688=_0x1da7e7[_0x5b8cbf];return _0x26a688;},a572_0x22c7(_0x185ea9,_0xd20d1c);}a572_0x5b8cbf();'use strict';var __createBinding=this&&this[a572_0x368397(0xe8)]||(Object['create']?function(_0xda45ec,_0x350da3,_0x3bf48b,_0x785ca1){const _0x220038=a572_0x368397;if(_0x785ca1===undefined)_0x785ca1=_0x3bf48b;var _0x56d6d0=Object[_0x220038(0xc3)](_0x350da3,_0x3bf48b);(!_0x56d6d0||(_0x220038(0xac)in _0x56d6d0?!_0x350da3[_0x220038(0x12b)]:_0x56d6d0[_0x220038(0xc6)]||_0x56d6d0[_0x220038(0xd9)]))&&(_0x56d6d0={'enumerable':!![],'get':function(){return _0x350da3[_0x3bf48b];}}),Object[_0x220038(0xf3)](_0xda45ec,_0x785ca1,_0x56d6d0);}:function(_0x227ac1,_0x3d9e16,_0x126b22,_0x5d2e7e){if(_0x5d2e7e===undefined)_0x5d2e7e=_0x126b22;_0x227ac1[_0x5d2e7e]=_0x3d9e16[_0x126b22];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a572_0x368397(0xa6)]?function(_0x34d693,_0x1ca8b3){const _0xac3e83=a572_0x368397;Object[_0xac3e83(0xf3)](_0x34d693,_0xac3e83(0x130),{'enumerable':!![],'value':_0x1ca8b3});}:function(_0x3ce69b,_0x5132ad){const _0x56f59f=a572_0x368397;_0x3ce69b[_0x56f59f(0x130)]=_0x5132ad;}),__importStar=this&&this[a572_0x368397(0x107)]||function(_0x119135){const _0x143947=a572_0x368397;if(_0x119135&&_0x119135[_0x143947(0x12b)])return _0x119135;var _0x5b7461={};if(_0x119135!=null){for(var _0x124657 in _0x119135)if(_0x124657!==_0x143947(0x130)&&Object['prototype']['hasOwnProperty'][_0x143947(0xf5)](_0x119135,_0x124657))__createBinding(_0x5b7461,_0x119135,_0x124657);}return __setModuleDefault(_0x5b7461,_0x119135),_0x5b7461;},__importDefault=this&&this[a572_0x368397(0xd7)]||function(_0x485550){const _0x1d2de6=a572_0x368397;return _0x485550&&_0x485550[_0x1d2de6(0x12b)]?_0x485550:{'default':_0x485550};};Object[a572_0x368397(0xf3)](exports,a572_0x368397(0x12b),{'value':!![]});function a572_0x26a6(){const _0x443919=['Error','PrepareContact','436316EhsUmC','ContactList\x20not\x20found\x20or\x20empty','whatsapp','2425398dAhQpr','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','contacts','milliseconds','defineProperty','confirmationMessage4','call',';delay=','../helpers/GetWhatsappWbot','logger','@sentry/node','join','deliveredAt','../services/WbotServices/SendWhatsAppMedia','-campaign','companyId','Campanhas\x20encontradas:\x20','public','../helpers/SendPresenceStatus','addSeconds','name','error','200250kRilmY','greaterInterval','__importStar','lte','../services/FileServices/ShowService','number','getCampaignValidConfirmationMessages','verifyAndFinalizeCampaign','data','all','getProcessedMessage','confirmationMessage3','-mainchannel','DispatchCampaign','{numero}','getMessageOptions','\x20failed\x20with\x20error:\x20','date-fns','user','message3','contactId','confirmationMessage1','completed','isArray','captureException','{nome}','add','variables','(((.+)+)+)+$','fileListId','calculateDelay','length','getIO','handleDispatchCampaign','handleVerifyCampaigns','trimEnd','message5','update','__esModule','sequelize','7gTVPFW','5GUhKEa','confirmationMessage2','default','../..','confirmationMessage','failed','Job\x20','mediaName','keys','longerIntervalAfter','emit','value','randomValue','../queues','message4','campaignQueue','messageInterval','create','@s.whatsapp.net','ProcessCampaign','76386nDxumM','findByPk','contactList','get',';Contato=','search','parse','findAll','reject','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','confirmationRequestedAt','email','findOrCreate','getSettings','Campaign\x20not\x20found','set','push','message','getContact','handlePrepareContact','getCampaign','confirmationMessage5','sendMessage','diff','moment/moment','includes','getOwnPropertyDescriptor','key','confirmation','writable','../utils/logger','PROGRAMADA','replace','message2','company-','getCampaignValidMessages','isEmpty','1520400BtebBM','message1','../models/Campaign','forEach','company','../models/Whatsapp','handleProcessCampaign','save','131204ZbEDWn','__importDefault','path','configurable','map','constructor','info','lodash','campaignId','options','entries','toString','trimStart','resolve','../models/CampaignShipping','isNil',',\x20Delay\x20Inicial=','862648qPPiGe','__createBinding','mediaPath'];a572_0x26a6=function(){return _0x443919;};return a572_0x26a6();}const bullmq_1=require('bullmq'),Campaign_1=__importDefault(require(a572_0x368397(0xd0))),sequelize_1=require(a572_0x368397(0x12c)),logger_1=require(a572_0x368397(0xc7)),moment_1=__importDefault(require(a572_0x368397(0xc1))),Sentry=__importStar(require(a572_0x368397(0xf9))),ContactList_1=__importDefault(require('../models/ContactList')),ContactListItem_1=__importDefault(require('../models/ContactListItem')),Whatsapp_1=__importDefault(require(a572_0x368397(0xd3))),CampaignShipping_1=__importDefault(require(a572_0x368397(0xe4))),queues_1=require(a572_0x368397(0x13b)),lodash_1=require(a572_0x368397(0xdd)),date_fns_1=require(a572_0x368397(0x116)),GetWhatsappWbot_1=__importDefault(require(a572_0x368397(0xf7))),path_1=__importDefault(require(a572_0x368397(0xd8))),ShowService_1=__importDefault(require(a572_0x368397(0x109))),SendWhatsAppMedia_1=require(a572_0x368397(0xfc)),socket_1=require('../libs/socket'),CampaignSetting_1=__importDefault(require('../models/CampaignSetting')),SendPresenceStatus_1=require(a572_0x368397(0x101));class CampaingJob{constructor(_0x1f431b,_0x1cd9d7){const _0x1317ef=a572_0x368397,_0xa8e0ee=new bullmq_1['Worker'](_0x1f431b,async _0x27f526=>{const _0x3bd1f2=a572_0x22c7;if(_0x27f526[_0x3bd1f2(0x103)]==='VerifyCampaigns')await this[_0x3bd1f2(0x127)](_0x27f526);else{if(_0x27f526[_0x3bd1f2(0x103)]===_0x3bd1f2(0xa8))await this[_0x3bd1f2(0xd4)](_0x27f526);else{if(_0x27f526[_0x3bd1f2(0x103)]===_0x3bd1f2(0xeb))await this[_0x3bd1f2(0xbc)](_0x27f526);else _0x27f526['name']===_0x3bd1f2(0x112)&&await this[_0x3bd1f2(0x126)](_0x27f526);}}},{'useWorkerThreads':![],'concurrency':0x64,'connection':_0x1cd9d7,'removeOnFail':{'count':0x0}});_0xa8e0ee['on'](_0x1317ef(0x11b),async _0x4eb5a7=>{const _0x310244=_0x1317ef;logger_1[_0x310244(0xf8)][_0x310244(0xdc)](_0x310244(0x134)+_0x4eb5a7[_0x310244(0x103)]+'\x20('+_0x4eb5a7['id']+')\x20completed');}),_0xa8e0ee['on'](_0x1317ef(0x133),async(_0x2e9c60,_0x5397e8)=>{const _0x2fe901=_0x1317ef;logger_1[_0x2fe901(0xf8)][_0x2fe901(0x104)](_0x2fe901(0x134)+_0x2e9c60[_0x2fe901(0x103)]+_0x2fe901(0x115)+_0x5397e8['message']);});}async[a572_0x368397(0xbb)](_0x57cb07){const _0xd1ab59=a572_0x368397;return ContactListItem_1[_0xd1ab59(0x130)][_0xd1ab59(0xaa)](_0x57cb07,{'attributes':['id',_0xd1ab59(0x103),_0xd1ab59(0x10a),_0xd1ab59(0xb4)]});}async['handlePrepareContact'](_0x3b7e24){const _0x34e2b0=a572_0x368397;try{const {contactId:_0x5ecc1f,campaignId:_0x3169be,delay:_0x5da89f,variables:_0x9a14c3}=_0x3b7e24[_0x34e2b0(0x10d)],_0x20fcd6=await this[_0x34e2b0(0xbd)](_0x3169be),_0x44fb96=await this[_0x34e2b0(0xbb)](_0x5ecc1f),_0x35014e={};_0x35014e['number']=_0x44fb96[_0x34e2b0(0x10a)],_0x35014e['contactId']=_0x5ecc1f,_0x35014e[_0x34e2b0(0xde)]=_0x3169be;const _0x1f6948=this[_0x34e2b0(0xcc)](_0x20fcd6);if(_0x1f6948['length']){const _0x4aeab8=(0x0,queues_1[_0x34e2b0(0x13a)])(0x0,_0x1f6948['length']),_0x40f61e=this['getProcessedMessage'](_0x1f6948[_0x4aeab8],_0x9a14c3,_0x44fb96);_0x35014e[_0x34e2b0(0xba)]='‌\x20'+_0x40f61e;}if(_0x20fcd6[_0x34e2b0(0xc5)]){const _0x2beee5=this['getCampaignValidConfirmationMessages'](_0x20fcd6);if(_0x2beee5['length']){const _0x552cfd=(0x0,queues_1[_0x34e2b0(0x13a)])(0x0,_0x2beee5[_0x34e2b0(0x124)]),_0x4f670c=this[_0x34e2b0(0x10f)](_0x2beee5[_0x552cfd],_0x9a14c3,_0x44fb96);_0x35014e[_0x34e2b0(0x132)]='‌\x20'+_0x4f670c;}}const [_0x40e818,_0x27463f]=await CampaignShipping_1[_0x34e2b0(0x130)][_0x34e2b0(0xb5)]({'where':{'campaignId':_0x35014e['campaignId'],'contactId':_0x35014e[_0x34e2b0(0x119)]},'defaults':_0x35014e});!_0x27463f&&_0x40e818[_0x34e2b0(0xfb)]===null&&_0x40e818[_0x34e2b0(0xb3)]===null&&(_0x40e818[_0x34e2b0(0xb8)](_0x35014e),await _0x40e818[_0x34e2b0(0xd5)]());if(_0x40e818['deliveredAt']===null&&_0x40e818[_0x34e2b0(0xb3)]===null){const _0x5c30a8=await queues_1[_0x34e2b0(0x13d)][_0x34e2b0(0x11f)]('DispatchCampaign',{'campaignId':_0x20fcd6['id'],'campaignShippingId':_0x40e818['id'],'contactListItemId':_0x5ecc1f},{'removeOnComplete':!![],'delay':_0x5da89f});await _0x40e818[_0x34e2b0(0x12a)]({'jobId':_0x5c30a8['id']});}await this[_0x34e2b0(0x10c)](_0x20fcd6);}catch(_0x590fa1){Sentry[_0x34e2b0(0x11d)](_0x590fa1),logger_1[_0x34e2b0(0xf8)][_0x34e2b0(0x104)]('campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20'+_0x590fa1[_0x34e2b0(0xba)]);}}async['verifyAndFinalizeCampaign'](_0x3dcaf9){const _0x3869de=a572_0x368397;if(!_0x3dcaf9[_0x3869de(0xab)])throw new sequelize_1[(_0x3869de(0xea))]('campaign.contactList\x20is\x20null\x20or\x20undefined');const {contacts:_0x3a5fd1}=_0x3dcaf9[_0x3869de(0xab)],_0x23a6d2=_0x3a5fd1[_0x3869de(0x124)],_0x46ac8c=await CampaignShipping_1[_0x3869de(0x130)]['count']({'where':{'campaignId':_0x3dcaf9['id'],'deliveredAt':{[sequelize_1['Op']['not']]:null}}});_0x23a6d2===_0x46ac8c&&await _0x3dcaf9[_0x3869de(0x12a)]({'status':'FINALIZADA','completedAt':(0x0,moment_1[_0x3869de(0x130)])()});const _0xc11929=(0x0,socket_1[_0x3869de(0x125)])();_0xc11929['to'](_0x3869de(0xcb)+_0x3dcaf9[_0x3869de(0xfe)]+_0x3869de(0x111))[_0x3869de(0x138)]('company-'+_0x3dcaf9[_0x3869de(0xfe)]+_0x3869de(0xfd),{'action':_0x3869de(0x12a),'record':_0x3dcaf9});}[a572_0x368397(0x123)](_0x1f3f8d,_0x37efb3,_0x187627,_0x1e061e,_0x10fed2){const _0x4351ef=(0x0,date_fns_1['differenceInSeconds'])(_0x37efb3,new Date());return _0x1f3f8d>_0x187627?_0x4351ef*0x3e8+_0x1e061e:_0x4351ef*0x3e8+_0x10fed2;}[a572_0x368397(0x10b)](_0x49ec5a){const _0x46ce12=a572_0x368397,_0x4a9596=[];return!(0x0,lodash_1[_0x46ce12(0xcd)])(_0x49ec5a[_0x46ce12(0x11a)])&&!(0x0,lodash_1['isNil'])(_0x49ec5a['confirmationMessage1'])&&_0x4a9596[_0x46ce12(0xb9)](_0x49ec5a[_0x46ce12(0x11a)]),!(0x0,lodash_1[_0x46ce12(0xcd)])(_0x49ec5a[_0x46ce12(0x12f)])&&!(0x0,lodash_1['isNil'])(_0x49ec5a[_0x46ce12(0x12f)])&&_0x4a9596[_0x46ce12(0xb9)](_0x49ec5a[_0x46ce12(0x12f)]),!(0x0,lodash_1[_0x46ce12(0xcd)])(_0x49ec5a[_0x46ce12(0x110)])&&!(0x0,lodash_1[_0x46ce12(0xe5)])(_0x49ec5a['confirmationMessage3'])&&_0x4a9596[_0x46ce12(0xb9)](_0x49ec5a[_0x46ce12(0x110)]),!(0x0,lodash_1[_0x46ce12(0xcd)])(_0x49ec5a['confirmationMessage4'])&&!(0x0,lodash_1[_0x46ce12(0xe5)])(_0x49ec5a[_0x46ce12(0xf4)])&&_0x4a9596[_0x46ce12(0xb9)](_0x49ec5a['confirmationMessage4']),!(0x0,lodash_1[_0x46ce12(0xcd)])(_0x49ec5a['confirmationMessage5'])&&!(0x0,lodash_1[_0x46ce12(0xe5)])(_0x49ec5a[_0x46ce12(0xbe)])&&_0x4a9596[_0x46ce12(0xb9)](_0x49ec5a[_0x46ce12(0xbe)]),_0x4a9596;}async[a572_0x368397(0x126)](_0x108810){const _0x36020a=a572_0x368397;try{const {data:_0x1d2afa}=_0x108810,{campaignShippingId:_0x5d96be,campaignId:_0x3d38d4}=_0x1d2afa,_0xb77918=await this[_0x36020a(0xbd)](_0x3d38d4),_0xe78b03=await(0x0,GetWhatsappWbot_1[_0x36020a(0x130)])(_0xb77918[_0x36020a(0xee)]);if(!_0xe78b03){logger_1[_0x36020a(0xf8)][_0x36020a(0x104)](_0x36020a(0xf0));return;}if(!_0xb77918[_0x36020a(0xee)]){logger_1['logger'][_0x36020a(0x104)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found');return;}if(!_0xe78b03?.[_0x36020a(0x117)]?.['id']){logger_1[_0x36020a(0xf8)][_0x36020a(0x104)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found');return;}logger_1['logger'][_0x36020a(0xdc)](_0x36020a(0xb2)+_0x3d38d4+';Registro='+_0x5d96be);const _0xc878dc=await CampaignShipping_1[_0x36020a(0x130)]['findByPk'](_0x5d96be,{'include':[{'model':ContactListItem_1['default'],'as':'contact'}]}),_0x217535=_0xc878dc[_0x36020a(0x10a)]+_0x36020a(0xa7);let _0x13f437=_0xc878dc[_0x36020a(0xba)][_0x36020a(0x128)]()[_0x36020a(0xe2)]();_0xb77918[_0x36020a(0xc5)]&&_0xc878dc[_0x36020a(0xc5)]===null&&(_0x13f437=_0xc878dc['confirmationMessage']);await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0xe78b03,_0x217535);if(!(0x0,lodash_1[_0x36020a(0xe5)])(_0xb77918[_0x36020a(0x122)]))try{const _0x468288=path_1['default'][_0x36020a(0xe3)](__dirname,_0x36020a(0x131),_0x36020a(0x100),_0x36020a(0xd2)+_0xb77918[_0x36020a(0xfe)]),_0x473326=await(0x0,ShowService_1['default'])(_0xb77918[_0x36020a(0x122)],_0xb77918[_0x36020a(0xfe)]),_0x5430ab=path_1[_0x36020a(0x130)][_0x36020a(0xe3)](_0x468288,'fileList',String(_0x473326['id']));for(const [_0xb113b4,_0xd71b0b]of _0x473326[_0x36020a(0xdf)][_0x36020a(0xe0)]()){const _0x2a1b5f=await(0x0,SendWhatsAppMedia_1[_0x36020a(0x114)])(_0xd71b0b[_0x36020a(0xd8)],path_1[_0x36020a(0x130)][_0x36020a(0xe3)](_0x5430ab,_0xd71b0b['path']),_0xd71b0b['name'],_0xb77918[_0x36020a(0xfe)]);await _0xe78b03[_0x36020a(0xbf)](_0x217535,{..._0x2a1b5f});}}catch(_0x4de7c7){logger_1[_0x36020a(0xf8)]['info'](_0x4de7c7);}if(_0xb77918[_0x36020a(0xe9)]){const _0x2862ef=path_1[_0x36020a(0x130)]['resolve'](__dirname,'../..',_0x36020a(0x100),_0x36020a(0xd2)+_0xb77918[_0x36020a(0xfe)]),_0x21c34d=path_1[_0x36020a(0x130)][_0x36020a(0xfa)](_0x2862ef,_0xb77918['mediaPath']),_0x52eefa=await(0x0,SendWhatsAppMedia_1[_0x36020a(0x114)])(_0xb77918[_0x36020a(0x135)],_0x21c34d,_0x13f437,_0xb77918[_0x36020a(0xfe)]);Object[_0x36020a(0x136)](_0x52eefa)[_0x36020a(0x124)]&&await _0xe78b03['sendMessage'](_0x217535,{..._0x52eefa});}else _0xb77918[_0x36020a(0xc5)]&&_0xc878dc['confirmation']===null?(await _0xe78b03['sendMessage'](_0x217535,{'text':_0x13f437}),await _0xc878dc[_0x36020a(0x12a)]({'confirmationRequestedAt':(0x0,moment_1[_0x36020a(0x130)])()})):await _0xe78b03[_0x36020a(0xbf)](_0x217535,{'text':_0x13f437});await _0xc878dc['update']({'deliveredAt':(0x0,moment_1['default'])()}),await this[_0x36020a(0x10c)](_0xb77918);const _0x65f570=(0x0,socket_1['getIO'])();_0x65f570['to'](_0x36020a(0xcb)+_0xb77918[_0x36020a(0xfe)]+_0x36020a(0x111))[_0x36020a(0x138)](_0x36020a(0xcb)+_0xb77918[_0x36020a(0xfe)]+_0x36020a(0xfd),{'action':_0x36020a(0x12a),'record':_0xb77918}),logger_1['logger'][_0x36020a(0xdc)]('Campanha\x20enviada\x20para:\x20Campanha='+_0x3d38d4+_0x36020a(0xad)+_0xc878dc['contact'][_0x36020a(0x103)]);}catch(_0x3420d2){Sentry[_0x36020a(0x11d)](_0x3420d2),logger_1[_0x36020a(0xf8)][_0x36020a(0x104)](_0x3420d2[_0x36020a(0xba)]);}}[a572_0x368397(0xcc)](_0x44a97f){const _0x3ede88=a572_0x368397,_0x1b4797=[];return!(0x0,lodash_1[_0x3ede88(0xcd)])(_0x44a97f['message1'])&&!(0x0,lodash_1['isNil'])(_0x44a97f['message1'])&&_0x1b4797[_0x3ede88(0xb9)](_0x44a97f[_0x3ede88(0xcf)]),!(0x0,lodash_1['isEmpty'])(_0x44a97f[_0x3ede88(0xca)])&&!(0x0,lodash_1[_0x3ede88(0xe5)])(_0x44a97f[_0x3ede88(0xca)])&&_0x1b4797['push'](_0x44a97f[_0x3ede88(0xca)]),!(0x0,lodash_1[_0x3ede88(0xcd)])(_0x44a97f[_0x3ede88(0x118)])&&!(0x0,lodash_1[_0x3ede88(0xe5)])(_0x44a97f[_0x3ede88(0x118)])&&_0x1b4797[_0x3ede88(0xb9)](_0x44a97f[_0x3ede88(0x118)]),!(0x0,lodash_1['isEmpty'])(_0x44a97f[_0x3ede88(0x13c)])&&!(0x0,lodash_1[_0x3ede88(0xe5)])(_0x44a97f[_0x3ede88(0x13c)])&&_0x1b4797['push'](_0x44a97f[_0x3ede88(0x13c)]),!(0x0,lodash_1['isEmpty'])(_0x44a97f[_0x3ede88(0x129)])&&!(0x0,lodash_1['isNil'])(_0x44a97f[_0x3ede88(0x129)])&&_0x1b4797[_0x3ede88(0xb9)](_0x44a97f[_0x3ede88(0x129)]),_0x1b4797;}[a572_0x368397(0x10f)](_0x3f1082,_0x5999da,_0x1df1cf){const _0x453f6d=a572_0x368397;let _0x3f8200=_0x3f1082;return _0x3f8200[_0x453f6d(0xc2)](_0x453f6d(0x11e))&&(_0x3f8200=_0x3f8200[_0x453f6d(0xc9)](/{nome}/g,_0x1df1cf[_0x453f6d(0x103)])),_0x3f8200[_0x453f6d(0xc2)]('{email}')&&(_0x3f8200=_0x3f8200[_0x453f6d(0xc9)](/{email}/g,_0x1df1cf[_0x453f6d(0xb4)])),_0x3f8200[_0x453f6d(0xc2)](_0x453f6d(0x113))&&(_0x3f8200=_0x3f8200['replace'](/{numero}/g,_0x1df1cf[_0x453f6d(0x10a)])),_0x5999da[_0x453f6d(0xd1)](_0x157408=>{const _0x46a172=_0x453f6d;if(_0x3f8200[_0x46a172(0xc2)]('{'+_0x157408[_0x46a172(0xc4)]+'}')){const _0x2cb632=new RegExp('{'+_0x157408[_0x46a172(0xc4)]+'}','g');_0x3f8200=_0x3f8200[_0x46a172(0xc9)](_0x2cb632,_0x157408[_0x46a172(0x139)]);}}),_0x3f8200;}async[a572_0x368397(0xb6)](_0x112c82){const _0x405b8d=a572_0x368397,_0x3c3820=await CampaignSetting_1[_0x405b8d(0x130)][_0x405b8d(0xb0)]({'where':{'companyId':_0x112c82[_0x405b8d(0xfe)]},'attributes':[_0x405b8d(0xc4),_0x405b8d(0x139)]});let _0x2f24a7=0x14,_0x21af86=0x14,_0x569903=0x3c,_0x13ab85=[];return _0x3c3820[_0x405b8d(0xd1)](_0x2151a3=>{const _0x39d23a=_0x405b8d;_0x2151a3[_0x39d23a(0xc4)]==='messageInterval'&&(_0x2f24a7=JSON[_0x39d23a(0xaf)](_0x2151a3[_0x39d23a(0x139)])),_0x2151a3['key']===_0x39d23a(0x137)&&(_0x21af86=JSON[_0x39d23a(0xaf)](_0x2151a3['value'])),_0x2151a3[_0x39d23a(0xc4)]===_0x39d23a(0x106)&&(_0x569903=JSON[_0x39d23a(0xaf)](_0x2151a3[_0x39d23a(0x139)])),_0x2151a3[_0x39d23a(0xc4)]===_0x39d23a(0x120)&&(_0x13ab85=JSON[_0x39d23a(0xaf)](_0x2151a3[_0x39d23a(0x139)]));}),{'messageInterval':_0x2f24a7,'longerIntervalAfter':_0x21af86,'greaterInterval':_0x569903,'variables':_0x13ab85};}async[a572_0x368397(0xd4)](_0x2677ee){const _0x2d3c3f=a572_0x368397;try{const {id:_0x5de64b}=_0x2677ee[_0x2d3c3f(0x10d)],_0x600cfc=await this[_0x2d3c3f(0xbd)](_0x5de64b),_0x557135=await this[_0x2d3c3f(0xb6)](_0x600cfc);if(!_0x600cfc)throw new sequelize_1[(_0x2d3c3f(0xea))](_0x2d3c3f(0xb7));if(!_0x600cfc[_0x2d3c3f(0xab)]||!_0x600cfc['contactList'][_0x2d3c3f(0xf1)])throw new sequelize_1['Error'](_0x2d3c3f(0xed));if(_0x600cfc){const {contacts:_0x3edc32}=_0x600cfc[_0x2d3c3f(0xab)];if((0x0,lodash_1[_0x2d3c3f(0x11c)])(_0x3edc32)){const _0x172b2a=_0x3edc32[_0x2d3c3f(0xda)](_0x1c4075=>({'contactId':_0x1c4075['id'],'campaignId':_0x600cfc['id'],'variables':_0x557135['variables']})),_0x105b14=(0x0,queues_1['parseToMilliseconds'])(_0x557135[_0x2d3c3f(0x137)]),_0xa60d7d=(0x0,queues_1['parseToMilliseconds'])(_0x557135[_0x2d3c3f(0x106)]),_0x5c4d7c=_0x557135[_0x2d3c3f(0x13e)];let _0x1890a8=_0x600cfc['scheduledAt'];const _0x387467=[];for(let _0x122e99=0x0;_0x122e99<_0x172b2a[_0x2d3c3f(0x124)];_0x122e99++){_0x1890a8=(0x0,date_fns_1[_0x2d3c3f(0x102)])(_0x1890a8,_0x122e99>_0x105b14?_0xa60d7d:_0x5c4d7c);const {contactId:_0xa07298,campaignId:_0xb3db65,variables:_0x4ae144}=_0x172b2a[_0x122e99],_0x3aeb8c=this[_0x2d3c3f(0x123)](_0x122e99,_0x1890a8,_0x105b14,_0xa60d7d,_0x5c4d7c),_0x5c7b7c=queues_1[_0x2d3c3f(0x13d)][_0x2d3c3f(0x11f)](_0x2d3c3f(0xeb),{'contactId':_0xa07298,'campaignId':_0xb3db65,'variables':_0x4ae144,'delay':_0x3aeb8c+(0x0,queues_1[_0x2d3c3f(0x13a)])(0x64,0x5dc)},{'removeOnComplete':!![]});_0x387467[_0x2d3c3f(0xb9)](_0x5c7b7c),logger_1[_0x2d3c3f(0xf8)]['info']('Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha='+_0x600cfc['id']+_0x2d3c3f(0xad)+_0x3edc32[_0x122e99][_0x2d3c3f(0x103)]+_0x2d3c3f(0xf6)+_0x3aeb8c);}await Promise[_0x2d3c3f(0x10e)](_0x387467),await _0x600cfc[_0x2d3c3f(0x12a)]({'status':'EM_ANDAMENTO'});}}}catch(_0x4b5ef8){logger_1[_0x2d3c3f(0xf8)][_0x2d3c3f(0x104)](_0x4b5ef8),Sentry[_0x2d3c3f(0x11d)](_0x4b5ef8);}}async[a572_0x368397(0xbd)](_0x2323d7){const _0x1d2feb=a572_0x368397,_0x51e646=await Campaign_1[_0x1d2feb(0x130)]['findByPk'](_0x2323d7,{'include':[{'model':ContactList_1[_0x1d2feb(0x130)],'as':_0x1d2feb(0xab),'attributes':['id',_0x1d2feb(0x103)],'include':[{'model':ContactListItem_1['default'],'as':_0x1d2feb(0xf1),'attributes':['id','name',_0x1d2feb(0x10a),_0x1d2feb(0xb4),'isWhatsappValid'],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':_0x1d2feb(0xee),'attributes':['id','name']},{'model':CampaignShipping_1[_0x1d2feb(0x130)],'as':'shipping','include':[{'model':ContactListItem_1[_0x1d2feb(0x130)],'as':'contact'}]}]});if(!_0x51e646||!_0x51e646[_0x1d2feb(0xab)])throw new sequelize_1[(_0x1d2feb(0xea))]('Campaign\x20or\x20ContactList\x20not\x20found');return _0x51e646;}async[a572_0x368397(0x127)](_0x535ae1){const _0x17fe9c=a572_0x368397,_0x3dab72=new Date(new Date()['getTime']()+0x3c*0x3c*0x3e8);let _0x6425f5=await Campaign_1['default']['findAll']({'where':{'scheduledAt':{[sequelize_1['Op'][_0x17fe9c(0x108)]]:+_0x3dab72},'status':_0x17fe9c(0xc8)},'attributes':['id','scheduledAt']});if(_0x6425f5['length']>0x0)logger_1[_0x17fe9c(0xf8)][_0x17fe9c(0xdc)](_0x17fe9c(0xff)+_0x6425f5[_0x17fe9c(0x124)]);for(let _0xbfaaf2 of _0x6425f5){try{const _0x5daa6d=(0x0,moment_1[_0x17fe9c(0x130)])(),_0x373d79=(0x0,moment_1[_0x17fe9c(0x130)])(_0xbfaaf2['scheduledAt']),_0x541a0f=_0x373d79[_0x17fe9c(0xc0)](_0x5daa6d,_0x17fe9c(0xf2));logger_1[_0x17fe9c(0xf8)][_0x17fe9c(0xdc)]('Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha='+_0xbfaaf2['id']+_0x17fe9c(0xe6)+_0x541a0f);const _0x9bccc3=await this[_0x17fe9c(0xbd)](_0xbfaaf2['id']);if(!_0x9bccc3[_0x17fe9c(0xab)]||!_0x9bccc3[_0x17fe9c(0xab)][_0x17fe9c(0xf1)])throw new sequelize_1['Error']('ContactList\x20not\x20found\x20or\x20empty');await queues_1[_0x17fe9c(0x13d)][_0x17fe9c(0x11f)](_0x17fe9c(0xa8),{'id':_0xbfaaf2['id'],'delay':_0x541a0f},{'delay':_0x541a0f,'removeOnComplete':!![]});}catch(_0xf6670e){return Sentry[_0x17fe9c(0x11d)](_0xf6670e),Promise[_0x17fe9c(0xb1)](new sequelize_1[(_0x17fe9c(0xea))](_0xf6670e));}}return Promise['resolve']({'count':_0x6425f5[_0x17fe9c(0x124)]});}}exports[a572_0x368397(0x130)]=CampaingJob;