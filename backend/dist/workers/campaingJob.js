const a572_0x485854=a572_0x1065;function a572_0x1065(_0x3dc814,_0x1777cb){const _0x11d03f=a572_0x2c78();return a572_0x1065=function(_0x2147c6,_0x128d68){_0x2147c6=_0x2147c6-0x1ba;let _0x2c7804=_0x11d03f[_0x2147c6];return _0x2c7804;},a572_0x1065(_0x3dc814,_0x1777cb);}(function(_0x24178a,_0x4ca5d4){const _0x5954b6=a572_0x1065,_0x2e9273=_0x24178a();while(!![]){try{const _0x35daac=parseInt(_0x5954b6(0x202))/0x1*(parseInt(_0x5954b6(0x1da))/0x2)+parseInt(_0x5954b6(0x1c4))/0x3*(-parseInt(_0x5954b6(0x257))/0x4)+-parseInt(_0x5954b6(0x1c5))/0x5*(parseInt(_0x5954b6(0x1ba))/0x6)+parseInt(_0x5954b6(0x245))/0x7+parseInt(_0x5954b6(0x1bc))/0x8+-parseInt(_0x5954b6(0x1dd))/0x9+-parseInt(_0x5954b6(0x243))/0xa;if(_0x35daac===_0x4ca5d4)break;else _0x2e9273['push'](_0x2e9273['shift']());}catch(_0x425251){_0x2e9273['push'](_0x2e9273['shift']());}}}(a572_0x2c78,0x59e29));const a572_0x128d68=(function(){let _0x1d2bb7=!![];return function(_0x416350,_0x35c64e){const _0x5777ad=_0x1d2bb7?function(){const _0x255cf6=a572_0x1065;if(_0x35c64e){const _0x1a9d36=_0x35c64e[_0x255cf6(0x1f9)](_0x416350,arguments);return _0x35c64e=null,_0x1a9d36;}}:function(){};return _0x1d2bb7=![],_0x5777ad;};}()),a572_0x2147c6=a572_0x128d68(this,function(){const _0xbe3a23=a572_0x1065;return a572_0x2147c6[_0xbe3a23(0x209)]()[_0xbe3a23(0x23e)]('(((.+)+)+)+$')[_0xbe3a23(0x209)]()[_0xbe3a23(0x252)](a572_0x2147c6)[_0xbe3a23(0x23e)](_0xbe3a23(0x1d7));});a572_0x2147c6();'use strict';var __createBinding=this&&this[a572_0x485854(0x1c3)]||(Object[a572_0x485854(0x20c)]?function(_0x5ceb83,_0x483e1e,_0x39ec3c,_0x37a879){const _0x5ba09b=a572_0x485854;if(_0x37a879===undefined)_0x37a879=_0x39ec3c;var _0x380afc=Object[_0x5ba09b(0x1fb)](_0x483e1e,_0x39ec3c);(!_0x380afc||(_0x5ba09b(0x1fe)in _0x380afc?!_0x483e1e['__esModule']:_0x380afc['writable']||_0x380afc['configurable']))&&(_0x380afc={'enumerable':!![],'get':function(){return _0x483e1e[_0x39ec3c];}}),Object['defineProperty'](_0x5ceb83,_0x37a879,_0x380afc);}:function(_0x24440e,_0x1a4b2f,_0x1c3e53,_0x43f547){if(_0x43f547===undefined)_0x43f547=_0x1c3e53;_0x24440e[_0x43f547]=_0x1a4b2f[_0x1c3e53];}),__setModuleDefault=this&&this[a572_0x485854(0x215)]||(Object['create']?function(_0x1ea050,_0x3b0120){const _0x1f4696=a572_0x485854;Object[_0x1f4696(0x1c7)](_0x1ea050,'default',{'enumerable':!![],'value':_0x3b0120});}:function(_0x1b95ba,_0x5f4b1d){_0x1b95ba['default']=_0x5f4b1d;}),__importStar=this&&this[a572_0x485854(0x24a)]||function(_0x136a70){const _0x16f99e=a572_0x485854;if(_0x136a70&&_0x136a70[_0x16f99e(0x1bb)])return _0x136a70;var _0x23c7c3={};if(_0x136a70!=null){for(var _0x1ec279 in _0x136a70)if(_0x1ec279!=='default'&&Object['prototype'][_0x16f99e(0x1e0)]['call'](_0x136a70,_0x1ec279))__createBinding(_0x23c7c3,_0x136a70,_0x1ec279);}return __setModuleDefault(_0x23c7c3,_0x136a70),_0x23c7c3;},__importDefault=this&&this['__importDefault']||function(_0x4381a0){return _0x4381a0&&_0x4381a0['__esModule']?_0x4381a0:{'default':_0x4381a0};};Object[a572_0x485854(0x1c7)](exports,a572_0x485854(0x1bb),{'value':!![]});const bullmq_1=require(a572_0x485854(0x20b)),Campaign_1=__importDefault(require(a572_0x485854(0x1cc))),sequelize_1=require(a572_0x485854(0x23b)),logger_1=require(a572_0x485854(0x251)),moment_1=__importDefault(require(a572_0x485854(0x216))),Sentry=__importStar(require(a572_0x485854(0x21e))),ContactList_1=__importDefault(require('../models/ContactList')),ContactListItem_1=__importDefault(require('../models/ContactListItem')),Whatsapp_1=__importDefault(require(a572_0x485854(0x211))),CampaignShipping_1=__importDefault(require('../models/CampaignShipping')),queues_1=require(a572_0x485854(0x1e4)),lodash_1=require(a572_0x485854(0x22e)),date_fns_1=require(a572_0x485854(0x259)),GetWhatsappWbot_1=__importDefault(require(a572_0x485854(0x1de))),path_1=__importDefault(require(a572_0x485854(0x23a))),ShowService_1=__importDefault(require(a572_0x485854(0x1f6))),SendWhatsAppMedia_1=require(a572_0x485854(0x1f7)),socket_1=require('../libs/socket'),CampaignSetting_1=__importDefault(require(a572_0x485854(0x241))),SendPresenceStatus_1=require('../helpers/SendPresenceStatus');function a572_0x2c78(){const _0x3d449b=['4312404gCtTuU','../helpers/GetWhatsappWbot','fileList','hasOwnProperty','getCampaignValidMessages','default','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','../queues','logger','parse','deliveredAt','sendMessage','error','isWhatsappValid','shipping','ProcessCampaign','email','fileListId','message1','{numero}','info','variables','mediaPath','campaignQueue','contactId','../services/FileServices/ShowService','../services/WbotServices/SendWhatsAppMedia','getTime','apply',',\x20Delay\x20Inicial=','getOwnPropertyDescriptor','resolve','push','get','Campaign\x20or\x20ContactList\x20not\x20found','getCampaign','number','6757MpBVXm','differenceInSeconds','contactList','company-','handlePrepareContact','add','EM_ANDAMENTO','toString','-mainchannel','bullmq','create','emit','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','getSettings','company','../models/Whatsapp','../..','confirmationMessage5','save','__setModuleDefault','moment/moment','{email}','message2','message','mediaName','campaignId','replace','isArray','@sentry/node','greaterInterval','messageInterval','update','addSeconds','message5','findByPk','lte','confirmation','isNil','milliseconds','\x20failed\x20with\x20error:\x20','captureException','confirmationMessage','forEach','parseToMilliseconds','lodash','value','length','contact','handleVerifyCampaigns','SendPresenceStatus','includes','not','join','getProcessedMessage','Worker','public','path','sequelize','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','Campanhas\x20encontradas:\x20','search','getContact','DispatchCampaign','../models/CampaignSetting','Error','2290690OjDrxQ','diff','4410371eQgLHA','randomValue','name','findOrCreate','confirmationMessage3','__importStar','confirmationRequestedAt','Campaign\x20not\x20found','verifyAndFinalizeCampaign','whatsapp','getMessageOptions','confirmationMessage2','../utils/logger','constructor','contacts','scheduledAt','companyId','-campaign','1020KiudMJ','key','date-fns','entries','handleDispatchCampaign','message4','PrepareContact','map','reject','6TKQLdu','__esModule','647696uxVoDV','handleProcessCampaign','count','VerifyCampaigns','findAll','message3','failed','__createBinding','1923jotGUT','497835BjBRed','trimEnd','defineProperty','ContactList\x20not\x20found\x20or\x20empty','isEmpty','calculateDelay','data','../models/Campaign','keys','getCampaignValidConfirmationMessages','options','{nome}','getIO','confirmationMessage4','trimStart','Campanha\x20enviada\x20para:\x20Campanha=','confirmationMessage1','@s.whatsapp.net','(((.+)+)+)+$','completed','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','186iuwvLg','user','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha='];a572_0x2c78=function(){return _0x3d449b;};return a572_0x2c78();}class CampaingJob{constructor(_0x47c65f,_0x529df8){const _0x5552f6=a572_0x485854,_0x4d7ceb=new bullmq_1[(_0x5552f6(0x238))](_0x47c65f,async _0x3e617b=>{const _0x260b10=_0x5552f6;if(_0x3e617b[_0x260b10(0x247)]===_0x260b10(0x1bf))await this['handleVerifyCampaigns'](_0x3e617b);else{if(_0x3e617b[_0x260b10(0x247)]===_0x260b10(0x1ec))await this[_0x260b10(0x1bd)](_0x3e617b);else{if(_0x3e617b[_0x260b10(0x247)]===_0x260b10(0x25d))await this[_0x260b10(0x206)](_0x3e617b);else _0x3e617b['name']===_0x260b10(0x240)&&await this[_0x260b10(0x25b)](_0x3e617b);}}},{'useWorkerThreads':![],'concurrency':0x64,'connection':_0x529df8,'removeOnFail':{'count':0x0}});_0x4d7ceb['on'](_0x5552f6(0x1d8),async _0x42691b=>{const _0x443fa3=_0x5552f6;logger_1[_0x443fa3(0x1e5)][_0x443fa3(0x1f1)]('Job\x20'+_0x42691b['name']+'\x20('+_0x42691b['id']+')\x20completed');}),_0x4d7ceb['on'](_0x5552f6(0x1c2),async(_0x423806,_0xf7d640)=>{const _0x34c95a=_0x5552f6;logger_1[_0x34c95a(0x1e5)][_0x34c95a(0x1e9)]('Job\x20'+_0x423806['name']+_0x34c95a(0x229)+_0xf7d640[_0x34c95a(0x219)]);});}async[a572_0x485854(0x23f)](_0x508ce9){const _0x536e99=a572_0x485854;return ContactListItem_1['default'][_0x536e99(0x224)](_0x508ce9,{'attributes':['id',_0x536e99(0x247),'number',_0x536e99(0x1ed)]});}async[a572_0x485854(0x206)](_0x44d1e8){const _0x10622b=a572_0x485854;try{const {contactId:_0x163748,campaignId:_0x61ba72,delay:_0x15c1aa,variables:_0x4e2d3f}=_0x44d1e8[_0x10622b(0x1cb)],_0x57e4b5=await this[_0x10622b(0x200)](_0x61ba72),_0x1c5bb6=await this[_0x10622b(0x23f)](_0x163748),_0x4b1a79={};_0x4b1a79[_0x10622b(0x201)]=_0x1c5bb6[_0x10622b(0x201)],_0x4b1a79['contactId']=_0x163748,_0x4b1a79[_0x10622b(0x21b)]=_0x61ba72;const _0x257de1=this[_0x10622b(0x1e1)](_0x57e4b5);if(_0x257de1[_0x10622b(0x230)]){const _0x5c9daa=(0x0,queues_1[_0x10622b(0x246)])(0x0,_0x257de1[_0x10622b(0x230)]),_0x418d65=this[_0x10622b(0x237)](_0x257de1[_0x5c9daa],_0x4e2d3f,_0x1c5bb6);_0x4b1a79[_0x10622b(0x219)]='‌\x20'+_0x418d65;}if(_0x57e4b5['confirmation']){const _0x173149=this['getCampaignValidConfirmationMessages'](_0x57e4b5);if(_0x173149['length']){const _0x16d3da=(0x0,queues_1[_0x10622b(0x246)])(0x0,_0x173149['length']),_0x50e848=this[_0x10622b(0x237)](_0x173149[_0x16d3da],_0x4e2d3f,_0x1c5bb6);_0x4b1a79[_0x10622b(0x22b)]='‌\x20'+_0x50e848;}}const [_0x5aaaf8,_0x27fe20]=await CampaignShipping_1[_0x10622b(0x1e2)][_0x10622b(0x248)]({'where':{'campaignId':_0x4b1a79[_0x10622b(0x21b)],'contactId':_0x4b1a79[_0x10622b(0x1f5)]},'defaults':_0x4b1a79});!_0x27fe20&&_0x5aaaf8[_0x10622b(0x1e7)]===null&&_0x5aaaf8[_0x10622b(0x24b)]===null&&(_0x5aaaf8['set'](_0x4b1a79),await _0x5aaaf8[_0x10622b(0x214)]());if(_0x5aaaf8['deliveredAt']===null&&_0x5aaaf8[_0x10622b(0x24b)]===null){const _0x2213d8=await queues_1['campaignQueue']['add'](_0x10622b(0x240),{'campaignId':_0x57e4b5['id'],'campaignShippingId':_0x5aaaf8['id'],'contactListItemId':_0x163748},{'removeOnComplete':!![],'delay':_0x15c1aa});await _0x5aaaf8[_0x10622b(0x221)]({'jobId':_0x2213d8['id']});}await this[_0x10622b(0x24d)](_0x57e4b5);}catch(_0x43203d){Sentry[_0x10622b(0x22a)](_0x43203d),logger_1['logger'][_0x10622b(0x1e9)](_0x10622b(0x1e3)+_0x43203d[_0x10622b(0x219)]);}}async[a572_0x485854(0x24d)](_0xe3e1da){const _0x1129c6=a572_0x485854;if(!_0xe3e1da[_0x1129c6(0x204)])throw new sequelize_1['Error']('campaign.contactList\x20is\x20null\x20or\x20undefined');const {contacts:_0x5053e6}=_0xe3e1da['contactList'],_0x2ab726=_0x5053e6[_0x1129c6(0x230)],_0x37b5ac=await CampaignShipping_1[_0x1129c6(0x1e2)][_0x1129c6(0x1be)]({'where':{'campaignId':_0xe3e1da['id'],'deliveredAt':{[sequelize_1['Op'][_0x1129c6(0x235)]]:null}}});_0x2ab726===_0x37b5ac&&await _0xe3e1da['update']({'status':'FINALIZADA','completedAt':(0x0,moment_1[_0x1129c6(0x1e2)])()});const _0x497276=(0x0,socket_1[_0x1129c6(0x1d1)])();_0x497276['to'](_0x1129c6(0x205)+_0xe3e1da[_0x1129c6(0x255)]+_0x1129c6(0x20a))[_0x1129c6(0x20d)](_0x1129c6(0x205)+_0xe3e1da['companyId']+_0x1129c6(0x256),{'action':_0x1129c6(0x221),'record':_0xe3e1da});}[a572_0x485854(0x1ca)](_0x4ad24c,_0x29e2c4,_0x594a50,_0x12dc72,_0x4b7737){const _0x1353e3=a572_0x485854,_0x23efb4=(0x0,date_fns_1[_0x1353e3(0x203)])(_0x29e2c4,new Date());return _0x4ad24c>_0x594a50?_0x23efb4*0x3e8+_0x12dc72:_0x23efb4*0x3e8+_0x4b7737;}[a572_0x485854(0x1ce)](_0x41f5c2){const _0x3f414a=a572_0x485854,_0x46953b=[];return!(0x0,lodash_1[_0x3f414a(0x1c9)])(_0x41f5c2['confirmationMessage1'])&&!(0x0,lodash_1[_0x3f414a(0x227)])(_0x41f5c2[_0x3f414a(0x1d5)])&&_0x46953b[_0x3f414a(0x1fd)](_0x41f5c2[_0x3f414a(0x1d5)]),!(0x0,lodash_1['isEmpty'])(_0x41f5c2['confirmationMessage2'])&&!(0x0,lodash_1[_0x3f414a(0x227)])(_0x41f5c2[_0x3f414a(0x250)])&&_0x46953b[_0x3f414a(0x1fd)](_0x41f5c2[_0x3f414a(0x250)]),!(0x0,lodash_1[_0x3f414a(0x1c9)])(_0x41f5c2[_0x3f414a(0x249)])&&!(0x0,lodash_1[_0x3f414a(0x227)])(_0x41f5c2[_0x3f414a(0x249)])&&_0x46953b[_0x3f414a(0x1fd)](_0x41f5c2[_0x3f414a(0x249)]),!(0x0,lodash_1[_0x3f414a(0x1c9)])(_0x41f5c2[_0x3f414a(0x1d2)])&&!(0x0,lodash_1[_0x3f414a(0x227)])(_0x41f5c2[_0x3f414a(0x1d2)])&&_0x46953b[_0x3f414a(0x1fd)](_0x41f5c2['confirmationMessage4']),!(0x0,lodash_1[_0x3f414a(0x1c9)])(_0x41f5c2[_0x3f414a(0x213)])&&!(0x0,lodash_1['isNil'])(_0x41f5c2['confirmationMessage5'])&&_0x46953b['push'](_0x41f5c2[_0x3f414a(0x213)]),_0x46953b;}async[a572_0x485854(0x25b)](_0x52da80){const _0x244237=a572_0x485854;try{const {data:_0x4d2fae}=_0x52da80,{campaignShippingId:_0x248e7f,campaignId:_0xd0d7a6}=_0x4d2fae,_0x19523b=await this[_0x244237(0x200)](_0xd0d7a6),_0x4c565f=await(0x0,GetWhatsappWbot_1[_0x244237(0x1e2)])(_0x19523b[_0x244237(0x24e)]);if(!_0x4c565f){logger_1['logger'][_0x244237(0x1e9)](_0x244237(0x20e));return;}if(!_0x19523b[_0x244237(0x24e)]){logger_1[_0x244237(0x1e5)][_0x244237(0x1e9)](_0x244237(0x23c));return;}if(!_0x4c565f?.[_0x244237(0x1db)]?.['id']){logger_1[_0x244237(0x1e5)][_0x244237(0x1e9)](_0x244237(0x1d9));return;}logger_1[_0x244237(0x1e5)]['info'](_0x244237(0x1dc)+_0xd0d7a6+';Registro='+_0x248e7f);const _0x1e3b95=await CampaignShipping_1[_0x244237(0x1e2)][_0x244237(0x224)](_0x248e7f,{'include':[{'model':ContactListItem_1[_0x244237(0x1e2)],'as':_0x244237(0x231)}]}),_0x590174=_0x1e3b95[_0x244237(0x201)]+_0x244237(0x1d6);let _0x29d9d9=_0x1e3b95[_0x244237(0x219)][_0x244237(0x1c6)]()[_0x244237(0x1d3)]();_0x19523b[_0x244237(0x226)]&&_0x1e3b95[_0x244237(0x226)]===null&&(_0x29d9d9=_0x1e3b95['confirmationMessage']);await(0x0,SendPresenceStatus_1[_0x244237(0x233)])(_0x4c565f,_0x590174);if(!(0x0,lodash_1[_0x244237(0x227)])(_0x19523b[_0x244237(0x1ee)]))try{const _0xa55d96=path_1[_0x244237(0x1e2)][_0x244237(0x1fc)](__dirname,_0x244237(0x212),_0x244237(0x239),_0x244237(0x210)+_0x19523b['companyId']),_0x11c069=await(0x0,ShowService_1[_0x244237(0x1e2)])(_0x19523b[_0x244237(0x1ee)],_0x19523b[_0x244237(0x255)]),_0x2446a1=path_1[_0x244237(0x1e2)][_0x244237(0x1fc)](_0xa55d96,_0x244237(0x1df),String(_0x11c069['id']));for(const [_0x547038,_0x2ced68]of _0x11c069[_0x244237(0x1cf)][_0x244237(0x25a)]()){const _0x4da0d0=await(0x0,SendWhatsAppMedia_1[_0x244237(0x24f)])(_0x2ced68[_0x244237(0x23a)],path_1['default'][_0x244237(0x1fc)](_0x2446a1,_0x2ced68[_0x244237(0x23a)]),_0x2ced68[_0x244237(0x247)],_0x19523b['companyId']);await _0x4c565f[_0x244237(0x1e8)](_0x590174,{..._0x4da0d0});}}catch(_0x1a9f8b){logger_1[_0x244237(0x1e5)]['info'](_0x1a9f8b);}if(_0x19523b[_0x244237(0x1f3)]){const _0x4d1649=path_1[_0x244237(0x1e2)][_0x244237(0x1fc)](__dirname,_0x244237(0x212),'public',_0x244237(0x210)+_0x19523b[_0x244237(0x255)]),_0x4b5bba=path_1['default'][_0x244237(0x236)](_0x4d1649,_0x19523b[_0x244237(0x1f3)]),_0x5b5694=await(0x0,SendWhatsAppMedia_1[_0x244237(0x24f)])(_0x19523b[_0x244237(0x21a)],_0x4b5bba,_0x29d9d9,_0x19523b[_0x244237(0x255)]);Object[_0x244237(0x1cd)](_0x5b5694)[_0x244237(0x230)]&&await _0x4c565f[_0x244237(0x1e8)](_0x590174,{..._0x5b5694});}else _0x19523b[_0x244237(0x226)]&&_0x1e3b95['confirmation']===null?(await _0x4c565f[_0x244237(0x1e8)](_0x590174,{'text':_0x29d9d9}),await _0x1e3b95[_0x244237(0x221)]({'confirmationRequestedAt':(0x0,moment_1[_0x244237(0x1e2)])()})):await _0x4c565f['sendMessage'](_0x590174,{'text':_0x29d9d9});await _0x1e3b95[_0x244237(0x221)]({'deliveredAt':(0x0,moment_1[_0x244237(0x1e2)])()}),await this[_0x244237(0x24d)](_0x19523b);const _0x2f9c79=(0x0,socket_1[_0x244237(0x1d1)])();_0x2f9c79['to'](_0x244237(0x205)+_0x19523b[_0x244237(0x255)]+_0x244237(0x20a))['emit'](_0x244237(0x205)+_0x19523b['companyId']+_0x244237(0x256),{'action':_0x244237(0x221),'record':_0x19523b}),logger_1['logger']['info'](_0x244237(0x1d4)+_0xd0d7a6+';Contato='+_0x1e3b95[_0x244237(0x231)][_0x244237(0x247)]);}catch(_0x3a45ed){Sentry[_0x244237(0x22a)](_0x3a45ed),logger_1[_0x244237(0x1e5)]['error'](_0x3a45ed[_0x244237(0x219)]);}}[a572_0x485854(0x1e1)](_0x580f66){const _0x269a6b=a572_0x485854,_0x50c3d2=[];return!(0x0,lodash_1['isEmpty'])(_0x580f66[_0x269a6b(0x1ef)])&&!(0x0,lodash_1[_0x269a6b(0x227)])(_0x580f66[_0x269a6b(0x1ef)])&&_0x50c3d2[_0x269a6b(0x1fd)](_0x580f66['message1']),!(0x0,lodash_1[_0x269a6b(0x1c9)])(_0x580f66[_0x269a6b(0x218)])&&!(0x0,lodash_1[_0x269a6b(0x227)])(_0x580f66[_0x269a6b(0x218)])&&_0x50c3d2['push'](_0x580f66['message2']),!(0x0,lodash_1[_0x269a6b(0x1c9)])(_0x580f66['message3'])&&!(0x0,lodash_1[_0x269a6b(0x227)])(_0x580f66[_0x269a6b(0x1c1)])&&_0x50c3d2['push'](_0x580f66[_0x269a6b(0x1c1)]),!(0x0,lodash_1[_0x269a6b(0x1c9)])(_0x580f66['message4'])&&!(0x0,lodash_1[_0x269a6b(0x227)])(_0x580f66[_0x269a6b(0x25c)])&&_0x50c3d2[_0x269a6b(0x1fd)](_0x580f66['message4']),!(0x0,lodash_1['isEmpty'])(_0x580f66['message5'])&&!(0x0,lodash_1['isNil'])(_0x580f66[_0x269a6b(0x223)])&&_0x50c3d2['push'](_0x580f66[_0x269a6b(0x223)]),_0x50c3d2;}['getProcessedMessage'](_0x1f0723,_0x97b6bc,_0x153278){const _0x58a009=a572_0x485854;let _0x5a3899=_0x1f0723;return _0x5a3899[_0x58a009(0x234)](_0x58a009(0x1d0))&&(_0x5a3899=_0x5a3899['replace'](/{nome}/g,_0x153278['name'])),_0x5a3899[_0x58a009(0x234)](_0x58a009(0x217))&&(_0x5a3899=_0x5a3899[_0x58a009(0x21c)](/{email}/g,_0x153278['email'])),_0x5a3899[_0x58a009(0x234)](_0x58a009(0x1f0))&&(_0x5a3899=_0x5a3899[_0x58a009(0x21c)](/{numero}/g,_0x153278[_0x58a009(0x201)])),_0x97b6bc[_0x58a009(0x22c)](_0x5c4a9e=>{const _0x2be267=_0x58a009;if(_0x5a3899['includes']('{'+_0x5c4a9e[_0x2be267(0x258)]+'}')){const _0x367bd4=new RegExp('{'+_0x5c4a9e['key']+'}','g');_0x5a3899=_0x5a3899[_0x2be267(0x21c)](_0x367bd4,_0x5c4a9e[_0x2be267(0x22f)]);}}),_0x5a3899;}async[a572_0x485854(0x20f)](_0x148d36){const _0x4de5a7=a572_0x485854,_0x473215=await CampaignSetting_1['default'][_0x4de5a7(0x1c0)]({'where':{'companyId':_0x148d36['companyId']},'attributes':[_0x4de5a7(0x258),'value']});let _0x1706d6=0x14,_0x560e7a=0x14,_0x2eae94=0x3c,_0x14749d=[];return _0x473215['forEach'](_0x563848=>{const _0x717ea8=_0x4de5a7;_0x563848[_0x717ea8(0x258)]===_0x717ea8(0x220)&&(_0x1706d6=JSON[_0x717ea8(0x1e6)](_0x563848['value'])),_0x563848['key']==='longerIntervalAfter'&&(_0x560e7a=JSON['parse'](_0x563848[_0x717ea8(0x22f)])),_0x563848[_0x717ea8(0x258)]==='greaterInterval'&&(_0x2eae94=JSON[_0x717ea8(0x1e6)](_0x563848[_0x717ea8(0x22f)])),_0x563848[_0x717ea8(0x258)]===_0x717ea8(0x1f2)&&(_0x14749d=JSON['parse'](_0x563848['value']));}),{'messageInterval':_0x1706d6,'longerIntervalAfter':_0x560e7a,'greaterInterval':_0x2eae94,'variables':_0x14749d};}async[a572_0x485854(0x1bd)](_0x2d0d43){const _0x2238e9=a572_0x485854;try{const {id:_0x10a249}=_0x2d0d43[_0x2238e9(0x1cb)],_0x2b6c12=await this[_0x2238e9(0x200)](_0x10a249),_0x1fd9a3=await this[_0x2238e9(0x20f)](_0x2b6c12);if(!_0x2b6c12)throw new sequelize_1['Error'](_0x2238e9(0x24c));if(!_0x2b6c12[_0x2238e9(0x204)]||!_0x2b6c12[_0x2238e9(0x204)][_0x2238e9(0x253)])throw new sequelize_1[(_0x2238e9(0x242))](_0x2238e9(0x1c8));if(_0x2b6c12){const {contacts:_0x14c55d}=_0x2b6c12['contactList'];if((0x0,lodash_1[_0x2238e9(0x21d)])(_0x14c55d)){const _0x364766=_0x14c55d[_0x2238e9(0x25e)](_0x1de61a=>({'contactId':_0x1de61a['id'],'campaignId':_0x2b6c12['id'],'variables':_0x1fd9a3['variables']})),_0x2f550b=(0x0,queues_1[_0x2238e9(0x22d)])(_0x1fd9a3['longerIntervalAfter']),_0x56b23e=(0x0,queues_1[_0x2238e9(0x22d)])(_0x1fd9a3[_0x2238e9(0x21f)]),_0x3a6aed=_0x1fd9a3[_0x2238e9(0x220)];let _0x285d6c=_0x2b6c12['scheduledAt'];const _0x43177f=[];for(let _0x5a8982=0x0;_0x5a8982<_0x364766[_0x2238e9(0x230)];_0x5a8982++){_0x285d6c=(0x0,date_fns_1[_0x2238e9(0x222)])(_0x285d6c,_0x5a8982>_0x2f550b?_0x56b23e:_0x3a6aed);const {contactId:_0x518182,campaignId:_0x4903fb,variables:_0x4663f1}=_0x364766[_0x5a8982],_0x335a95=this[_0x2238e9(0x1ca)](_0x5a8982,_0x285d6c,_0x2f550b,_0x56b23e,_0x3a6aed),_0x17e693=queues_1[_0x2238e9(0x1f4)][_0x2238e9(0x207)](_0x2238e9(0x25d),{'contactId':_0x518182,'campaignId':_0x4903fb,'variables':_0x4663f1,'delay':_0x335a95+(0x0,queues_1[_0x2238e9(0x246)])(0x64,0x5dc)},{'removeOnComplete':!![]});_0x43177f[_0x2238e9(0x1fd)](_0x17e693),logger_1['logger']['info']('Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha='+_0x2b6c12['id']+';Contato='+_0x14c55d[_0x5a8982][_0x2238e9(0x247)]+';delay='+_0x335a95);}await Promise['all'](_0x43177f),await _0x2b6c12[_0x2238e9(0x221)]({'status':_0x2238e9(0x208)});}}}catch(_0x378c94){logger_1[_0x2238e9(0x1e5)][_0x2238e9(0x1e9)](_0x378c94),Sentry[_0x2238e9(0x22a)](_0x378c94);}}async[a572_0x485854(0x200)](_0x47ec39){const _0x55f1d0=a572_0x485854,_0x13f308=await Campaign_1[_0x55f1d0(0x1e2)][_0x55f1d0(0x224)](_0x47ec39,{'include':[{'model':ContactList_1[_0x55f1d0(0x1e2)],'as':_0x55f1d0(0x204),'attributes':['id',_0x55f1d0(0x247)],'include':[{'model':ContactListItem_1[_0x55f1d0(0x1e2)],'as':'contacts','attributes':['id',_0x55f1d0(0x247),'number','email',_0x55f1d0(0x1ea)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x55f1d0(0x1e2)],'as':_0x55f1d0(0x24e),'attributes':['id',_0x55f1d0(0x247)]},{'model':CampaignShipping_1[_0x55f1d0(0x1e2)],'as':_0x55f1d0(0x1eb),'include':[{'model':ContactListItem_1[_0x55f1d0(0x1e2)],'as':_0x55f1d0(0x231)}]}]});if(!_0x13f308||!_0x13f308[_0x55f1d0(0x204)])throw new sequelize_1[(_0x55f1d0(0x242))](_0x55f1d0(0x1ff));return _0x13f308;}async[a572_0x485854(0x232)](_0x11d061){const _0x479d05=a572_0x485854,_0x591794=new Date(new Date()[_0x479d05(0x1f8)]()+0x3c*0x3c*0x3e8);let _0xac53e5=await Campaign_1[_0x479d05(0x1e2)]['findAll']({'where':{'scheduledAt':{[sequelize_1['Op'][_0x479d05(0x225)]]:+_0x591794},'status':'PROGRAMADA'},'attributes':['id',_0x479d05(0x254)]});if(_0xac53e5[_0x479d05(0x230)]>0x0)logger_1['logger'][_0x479d05(0x1f1)](_0x479d05(0x23d)+_0xac53e5[_0x479d05(0x230)]);for(let _0x5133e6 of _0xac53e5){try{const _0x119f33=(0x0,moment_1[_0x479d05(0x1e2)])(),_0x2466a1=(0x0,moment_1['default'])(_0x5133e6['scheduledAt']),_0x11855a=_0x2466a1[_0x479d05(0x244)](_0x119f33,_0x479d05(0x228));logger_1[_0x479d05(0x1e5)][_0x479d05(0x1f1)]('Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha='+_0x5133e6['id']+_0x479d05(0x1fa)+_0x11855a);const _0x401dee=await this[_0x479d05(0x200)](_0x5133e6['id']);if(!_0x401dee['contactList']||!_0x401dee['contactList'][_0x479d05(0x253)])throw new sequelize_1[(_0x479d05(0x242))](_0x479d05(0x1c8));await queues_1[_0x479d05(0x1f4)]['add'](_0x479d05(0x1ec),{'id':_0x5133e6['id'],'delay':_0x11855a},{'delay':_0x11855a,'removeOnComplete':!![]});}catch(_0x478be4){return Sentry[_0x479d05(0x22a)](_0x478be4),Promise[_0x479d05(0x25f)](new sequelize_1[(_0x479d05(0x242))](_0x478be4));}}return Promise[_0x479d05(0x1fc)]({'count':_0xac53e5['length']});}}exports['default']=CampaingJob;