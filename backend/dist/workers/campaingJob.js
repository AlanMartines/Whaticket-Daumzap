function a572_0x57b8(){const _0x379570=['greaterInterval','data','sendMessage','lte','default','mediaPath','call','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','logger','milliseconds',';delay=','message5','getOwnPropertyDescriptor','add','isNil','name','handlePrepareContact','Campaign\x20not\x20found','{email}','@sentry/node','PROGRAMADA','PrepareContact','getSettings','randomValue','findByPk','{numero}','number','verifyAndFinalizeCampaign','248345KwhrcA','parse','date-fns','toString','company','forEach','__esModule','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','get','messageInterval','defineProperty','399276RcpgMm','contactId','ContactList\x20not\x20found\x20or\x20empty','handleVerifyCampaigns','__importDefault','contacts','VerifyCampaigns','confirmationRequestedAt','708888UaTGaO','SendPresenceStatus','Campanha\x20enviada\x20para:\x20Campanha=','mediaName','119aOXYcd','sequelize','../..','1018926FeonXN','Error','message2','length','confirmationMessage','DispatchCampaign','push','contact','3ToIhPw','__importStar','companyId','confirmationMessage3','addSeconds','emit',';Registro=','confirmationMessage4','getCampaignValidMessages','confirmation','search','longerIntervalAfter','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','completed',',\x20Delay\x20Inicial=','company-','update','parseToMilliseconds','../utils/logger','path','confirmationMessage1','prototype','getMessageOptions','getCampaignValidConfirmationMessages','fileList','confirmationMessage5','save','confirmationMessage2','../services/FileServices/ShowService','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','apply','shipping','message','FINALIZADA','message4','trimEnd','fileListId','key','Job\x20','value','findAll','resolve','captureException','variables','{nome}','options','set','Campanhas\x20encontradas:\x20','getTime','40bynBPa','getCampaign','82168qxsVrZ','handleProcessCampaign','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','error','hasOwnProperty','not','../models/ContactList','../libs/socket','../models/CampaignSetting',';Contato=','18120nizbYk','whatsapp','user','campaignId','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','email','lodash','create','Worker','message1','includes','385xzEIKC','-mainchannel','diff','calculateDelay','constructor','30aGEUWp','Campaign\x20or\x20ContactList\x20not\x20found','campaignQueue','217400MAJTYx','-campaign','../queues','replace','__setModuleDefault','configurable','../models/CampaignShipping','reject','entries','isEmpty','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','contactList','failed','ProcessCampaign','info','getProcessedMessage','message3','map'];a572_0x57b8=function(){return _0x379570;};return a572_0x57b8();}const a572_0x45293c=a572_0x854a;(function(_0x3be040,_0x4e6483){const _0x3e8c38=a572_0x854a,_0x2cde33=_0x3be040();while(!![]){try{const _0x3abc43=parseInt(_0x3e8c38(0x9a))/0x1+parseInt(_0x3e8c38(0xa2))/0x2+parseInt(_0x3e8c38(0xb1))/0x3*(parseInt(_0x3e8c38(0x101))/0x4)+-parseInt(_0x3e8c38(0x8f))/0x5*(parseInt(_0x3e8c38(0xfe))/0x6)+-parseInt(_0x3e8c38(0xa6))/0x7*(-parseInt(_0x3e8c38(0xe4))/0x8)+parseInt(_0x3e8c38(0xa9))/0x9*(-parseInt(_0x3e8c38(0xe2))/0xa)+parseInt(_0x3e8c38(0xf9))/0xb*(parseInt(_0x3e8c38(0xee))/0xc);if(_0x3abc43===_0x4e6483)break;else _0x2cde33['push'](_0x2cde33['shift']());}catch(_0x19f321){_0x2cde33['push'](_0x2cde33['shift']());}}}(a572_0x57b8,0x519f6));const a572_0x46d2dd=(function(){let _0x44e2f1=!![];return function(_0x579f80,_0x59887e){const _0x48dc09=_0x44e2f1?function(){const _0x5af1bb=a572_0x854a;if(_0x59887e){const _0x3f8bff=_0x59887e[_0x5af1bb(0xcf)](_0x579f80,arguments);return _0x59887e=null,_0x3f8bff;}}:function(){};return _0x44e2f1=![],_0x48dc09;};}()),a572_0x21f513=a572_0x46d2dd(this,function(){const _0x10baa8=a572_0x854a;return a572_0x21f513[_0x10baa8(0x92)]()['search']('(((.+)+)+)+$')[_0x10baa8(0x92)]()[_0x10baa8(0xfd)](a572_0x21f513)[_0x10baa8(0xbb)]('(((.+)+)+)+$');});a572_0x21f513();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a572_0x45293c(0xf5)]?function(_0x44a4c3,_0x46904b,_0x145509,_0x4e9d02){const _0x514911=a572_0x45293c;if(_0x4e9d02===undefined)_0x4e9d02=_0x145509;var _0x313b1e=Object[_0x514911(0x11f)](_0x46904b,_0x145509);(!_0x313b1e||(_0x514911(0x97)in _0x313b1e?!_0x46904b[_0x514911(0x95)]:_0x313b1e['writable']||_0x313b1e[_0x514911(0x106)]))&&(_0x313b1e={'enumerable':!![],'get':function(){return _0x46904b[_0x145509];}}),Object[_0x514911(0x99)](_0x44a4c3,_0x4e9d02,_0x313b1e);}:function(_0x60d041,_0x4a7b05,_0x81116,_0x1322f0){if(_0x1322f0===undefined)_0x1322f0=_0x81116;_0x60d041[_0x1322f0]=_0x4a7b05[_0x81116];}),__setModuleDefault=this&&this[a572_0x45293c(0x105)]||(Object['create']?function(_0x5a9c25,_0x36e378){Object['defineProperty'](_0x5a9c25,'default',{'enumerable':!![],'value':_0x36e378});}:function(_0x546f48,_0x5bbbd6){const _0x30ac1f=a572_0x45293c;_0x546f48[_0x30ac1f(0x117)]=_0x5bbbd6;}),__importStar=this&&this[a572_0x45293c(0xb2)]||function(_0x2d5ea9){const _0x288935=a572_0x45293c;if(_0x2d5ea9&&_0x2d5ea9[_0x288935(0x95)])return _0x2d5ea9;var _0x4979a2={};if(_0x2d5ea9!=null){for(var _0x5c09ba in _0x2d5ea9)if(_0x5c09ba!==_0x288935(0x117)&&Object[_0x288935(0xc6)][_0x288935(0xe8)][_0x288935(0x119)](_0x2d5ea9,_0x5c09ba))__createBinding(_0x4979a2,_0x2d5ea9,_0x5c09ba);}return __setModuleDefault(_0x4979a2,_0x2d5ea9),_0x4979a2;},__importDefault=this&&this[a572_0x45293c(0x9e)]||function(_0xb84766){return _0xb84766&&_0xb84766['__esModule']?_0xb84766:{'default':_0xb84766};};Object[a572_0x45293c(0x99)](exports,a572_0x45293c(0x95),{'value':!![]});function a572_0x854a(_0xc71283,_0x401e7e){const _0x3fdae9=a572_0x57b8();return a572_0x854a=function(_0x21f513,_0x46d2dd){_0x21f513=_0x21f513-0x81;let _0x57b8a8=_0x3fdae9[_0x21f513];return _0x57b8a8;},a572_0x854a(_0xc71283,_0x401e7e);}const bullmq_1=require('bullmq'),Campaign_1=__importDefault(require('../models/Campaign')),sequelize_1=require(a572_0x45293c(0xa7)),logger_1=require(a572_0x45293c(0xc3)),moment_1=__importDefault(require('moment/moment')),Sentry=__importStar(require(a572_0x45293c(0x86))),ContactList_1=__importDefault(require(a572_0x45293c(0xea))),ContactListItem_1=__importDefault(require('../models/ContactListItem')),Whatsapp_1=__importDefault(require('../models/Whatsapp')),CampaignShipping_1=__importDefault(require(a572_0x45293c(0x107))),queues_1=require(a572_0x45293c(0x103)),lodash_1=require(a572_0x45293c(0xf4)),date_fns_1=require(a572_0x45293c(0x91)),GetWhatsappWbot_1=__importDefault(require('../helpers/GetWhatsappWbot')),path_1=__importDefault(require(a572_0x45293c(0xc4))),ShowService_1=__importDefault(require(a572_0x45293c(0xcd))),SendWhatsAppMedia_1=require('../services/WbotServices/SendWhatsAppMedia'),socket_1=require(a572_0x45293c(0xeb)),CampaignSetting_1=__importDefault(require(a572_0x45293c(0xec))),SendPresenceStatus_1=require('../helpers/SendPresenceStatus');class CampaingJob{constructor(_0x1248e6,_0x5648f2){const _0x269d3d=a572_0x45293c,_0x3f6ec4=new bullmq_1[(_0x269d3d(0xf6))](_0x1248e6,async _0x3088fe=>{const _0x23c43d=_0x269d3d;if(_0x3088fe[_0x23c43d(0x82)]===_0x23c43d(0xa0))await this[_0x23c43d(0x9d)](_0x3088fe);else{if(_0x3088fe[_0x23c43d(0x82)]===_0x23c43d(0x10e))await this[_0x23c43d(0xe5)](_0x3088fe);else{if(_0x3088fe['name']==='PrepareContact')await this[_0x23c43d(0x83)](_0x3088fe);else _0x3088fe[_0x23c43d(0x82)]===_0x23c43d(0xae)&&await this['handleDispatchCampaign'](_0x3088fe);}}},{'useWorkerThreads':![],'concurrency':0x64,'connection':_0x5648f2,'removeOnFail':{'count':0x0}});_0x3f6ec4['on'](_0x269d3d(0xbe),async _0x110e07=>{const _0x4a23f0=_0x269d3d;logger_1['logger']['info'](_0x4a23f0(0xd7)+_0x110e07[_0x4a23f0(0x82)]+'\x20('+_0x110e07['id']+')\x20completed');}),_0x3f6ec4['on'](_0x269d3d(0x10d),async(_0x242b72,_0x3b37c1)=>{const _0x51ab5c=_0x269d3d;logger_1[_0x51ab5c(0x11b)][_0x51ab5c(0xe7)](_0x51ab5c(0xd7)+_0x242b72[_0x51ab5c(0x82)]+'\x20failed\x20with\x20error:\x20'+_0x3b37c1[_0x51ab5c(0xd1)]);});}async['getContact'](_0x3a01af){const _0x47902f=a572_0x45293c;return ContactListItem_1[_0x47902f(0x117)][_0x47902f(0x8b)](_0x3a01af,{'attributes':['id',_0x47902f(0x82),'number',_0x47902f(0xf3)]});}async[a572_0x45293c(0x83)](_0x5d6c6d){const _0x271ed7=a572_0x45293c;try{const {contactId:_0x274497,campaignId:_0x3d8247,delay:_0x21c18e,variables:_0x57808d}=_0x5d6c6d['data'],_0x3cae3f=await this['getCampaign'](_0x3d8247),_0x24e955=await this['getContact'](_0x274497),_0xe79ef9={};_0xe79ef9[_0x271ed7(0x8d)]=_0x24e955['number'],_0xe79ef9[_0x271ed7(0x9b)]=_0x274497,_0xe79ef9[_0x271ed7(0xf1)]=_0x3d8247;const _0x208998=this[_0x271ed7(0xb9)](_0x3cae3f);if(_0x208998['length']){const _0x517907=(0x0,queues_1[_0x271ed7(0x8a)])(0x0,_0x208998[_0x271ed7(0xac)]),_0x599911=this['getProcessedMessage'](_0x208998[_0x517907],_0x57808d,_0x24e955);_0xe79ef9[_0x271ed7(0xd1)]='‌\x20'+_0x599911;}if(_0x3cae3f[_0x271ed7(0xba)]){const _0x317ac4=this[_0x271ed7(0xc8)](_0x3cae3f);if(_0x317ac4[_0x271ed7(0xac)]){const _0x3614c1=(0x0,queues_1[_0x271ed7(0x8a)])(0x0,_0x317ac4[_0x271ed7(0xac)]),_0x383964=this[_0x271ed7(0x110)](_0x317ac4[_0x3614c1],_0x57808d,_0x24e955);_0xe79ef9[_0x271ed7(0xad)]='‌\x20'+_0x383964;}}const [_0x4698db,_0x363b5a]=await CampaignShipping_1[_0x271ed7(0x117)]['findOrCreate']({'where':{'campaignId':_0xe79ef9[_0x271ed7(0xf1)],'contactId':_0xe79ef9[_0x271ed7(0x9b)]},'defaults':_0xe79ef9});!_0x363b5a&&_0x4698db['deliveredAt']===null&&_0x4698db[_0x271ed7(0xa1)]===null&&(_0x4698db[_0x271ed7(0xdf)](_0xe79ef9),await _0x4698db[_0x271ed7(0xcb)]());if(_0x4698db['deliveredAt']===null&&_0x4698db[_0x271ed7(0xa1)]===null){const _0x5a5520=await queues_1[_0x271ed7(0x100)]['add'](_0x271ed7(0xae),{'campaignId':_0x3cae3f['id'],'campaignShippingId':_0x4698db['id'],'contactListItemId':_0x274497},{'removeOnComplete':!![],'delay':_0x21c18e});await _0x4698db[_0x271ed7(0xc1)]({'jobId':_0x5a5520['id']});}await this[_0x271ed7(0x8e)](_0x3cae3f);}catch(_0xd4db80){Sentry['captureException'](_0xd4db80),logger_1[_0x271ed7(0x11b)][_0x271ed7(0xe7)](_0x271ed7(0xf2)+_0xd4db80[_0x271ed7(0xd1)]);}}async[a572_0x45293c(0x8e)](_0x1cd404){const _0xe4d468=a572_0x45293c;if(!_0x1cd404['contactList'])throw new sequelize_1[(_0xe4d468(0xaa))]('campaign.contactList\x20is\x20null\x20or\x20undefined');const {contacts:_0x13ba79}=_0x1cd404[_0xe4d468(0x10c)],_0x34bb96=_0x13ba79[_0xe4d468(0xac)],_0x5bfb78=await CampaignShipping_1['default']['count']({'where':{'campaignId':_0x1cd404['id'],'deliveredAt':{[sequelize_1['Op'][_0xe4d468(0xe9)]]:null}}});_0x34bb96===_0x5bfb78&&await _0x1cd404[_0xe4d468(0xc1)]({'status':_0xe4d468(0xd2),'completedAt':(0x0,moment_1[_0xe4d468(0x117)])()});const _0x3a8b9c=(0x0,socket_1['getIO'])();_0x3a8b9c['to'](_0xe4d468(0xc0)+_0x1cd404[_0xe4d468(0xb3)]+_0xe4d468(0xfa))[_0xe4d468(0xb6)]('company-'+_0x1cd404[_0xe4d468(0xb3)]+_0xe4d468(0x102),{'action':_0xe4d468(0xc1),'record':_0x1cd404});}[a572_0x45293c(0xfc)](_0x478555,_0x3b4031,_0x1858c2,_0xfab60b,_0x567706){const _0x85707d=(0x0,date_fns_1['differenceInSeconds'])(_0x3b4031,new Date());return _0x478555>_0x1858c2?_0x85707d*0x3e8+_0xfab60b:_0x85707d*0x3e8+_0x567706;}[a572_0x45293c(0xc8)](_0x4f8505){const _0x5927ac=a572_0x45293c,_0x55cfa3=[];return!(0x0,lodash_1[_0x5927ac(0x10a)])(_0x4f8505[_0x5927ac(0xc5)])&&!(0x0,lodash_1[_0x5927ac(0x81)])(_0x4f8505[_0x5927ac(0xc5)])&&_0x55cfa3[_0x5927ac(0xaf)](_0x4f8505['confirmationMessage1']),!(0x0,lodash_1[_0x5927ac(0x10a)])(_0x4f8505[_0x5927ac(0xcc)])&&!(0x0,lodash_1[_0x5927ac(0x81)])(_0x4f8505['confirmationMessage2'])&&_0x55cfa3[_0x5927ac(0xaf)](_0x4f8505[_0x5927ac(0xcc)]),!(0x0,lodash_1[_0x5927ac(0x10a)])(_0x4f8505[_0x5927ac(0xb4)])&&!(0x0,lodash_1[_0x5927ac(0x81)])(_0x4f8505[_0x5927ac(0xb4)])&&_0x55cfa3[_0x5927ac(0xaf)](_0x4f8505[_0x5927ac(0xb4)]),!(0x0,lodash_1[_0x5927ac(0x10a)])(_0x4f8505['confirmationMessage4'])&&!(0x0,lodash_1[_0x5927ac(0x81)])(_0x4f8505['confirmationMessage4'])&&_0x55cfa3[_0x5927ac(0xaf)](_0x4f8505[_0x5927ac(0xb8)]),!(0x0,lodash_1[_0x5927ac(0x10a)])(_0x4f8505[_0x5927ac(0xca)])&&!(0x0,lodash_1['isNil'])(_0x4f8505[_0x5927ac(0xca)])&&_0x55cfa3[_0x5927ac(0xaf)](_0x4f8505[_0x5927ac(0xca)]),_0x55cfa3;}async['handleDispatchCampaign'](_0x470dd3){const _0x48a222=a572_0x45293c;try{const {data:_0x39c65a}=_0x470dd3,{campaignShippingId:_0x59e1ef,campaignId:_0x1ae2e1}=_0x39c65a,_0x3b993b=await this[_0x48a222(0xe3)](_0x1ae2e1),_0x248b82=await(0x0,GetWhatsappWbot_1[_0x48a222(0x117)])(_0x3b993b[_0x48a222(0xef)]);if(!_0x248b82){logger_1['logger'][_0x48a222(0xe7)](_0x48a222(0xce));return;}if(!_0x3b993b[_0x48a222(0xef)]){logger_1[_0x48a222(0x11b)]['error'](_0x48a222(0x11a));return;}if(!_0x248b82?.[_0x48a222(0xf0)]?.['id']){logger_1[_0x48a222(0x11b)][_0x48a222(0xe7)](_0x48a222(0xe6));return;}logger_1[_0x48a222(0x11b)][_0x48a222(0x10f)](_0x48a222(0xbd)+_0x1ae2e1+_0x48a222(0xb7)+_0x59e1ef);const _0x4610a5=await CampaignShipping_1['default'][_0x48a222(0x8b)](_0x59e1ef,{'include':[{'model':ContactListItem_1[_0x48a222(0x117)],'as':_0x48a222(0xb0)}]}),_0xab6297=_0x4610a5[_0x48a222(0x8d)]+'@s.whatsapp.net';let _0x203bc8=_0x4610a5[_0x48a222(0xd1)][_0x48a222(0xd4)]()['trimStart']();_0x3b993b[_0x48a222(0xba)]&&_0x4610a5[_0x48a222(0xba)]===null&&(_0x203bc8=_0x4610a5[_0x48a222(0xad)]);await(0x0,SendPresenceStatus_1[_0x48a222(0xa3)])(_0x248b82,_0xab6297);if(!(0x0,lodash_1[_0x48a222(0x81)])(_0x3b993b[_0x48a222(0xd5)]))try{const _0xe64b7f=path_1[_0x48a222(0x117)]['resolve'](__dirname,'../..','public',_0x48a222(0x93)+_0x3b993b[_0x48a222(0xb3)]),_0x2751e5=await(0x0,ShowService_1['default'])(_0x3b993b[_0x48a222(0xd5)],_0x3b993b[_0x48a222(0xb3)]),_0x543bc5=path_1[_0x48a222(0x117)][_0x48a222(0xda)](_0xe64b7f,_0x48a222(0xc9),String(_0x2751e5['id']));for(const [_0x3f130d,_0x463cff]of _0x2751e5[_0x48a222(0xde)][_0x48a222(0x109)]()){const _0x127b2e=await(0x0,SendWhatsAppMedia_1[_0x48a222(0xc7)])(_0x463cff[_0x48a222(0xc4)],path_1[_0x48a222(0x117)]['resolve'](_0x543bc5,_0x463cff[_0x48a222(0xc4)]),_0x463cff['name'],_0x3b993b[_0x48a222(0xb3)]);await _0x248b82[_0x48a222(0x115)](_0xab6297,{..._0x127b2e});}}catch(_0x2fda95){logger_1['logger'][_0x48a222(0x10f)](_0x2fda95);}if(_0x3b993b[_0x48a222(0x118)]){const _0xd5925e=path_1[_0x48a222(0x117)][_0x48a222(0xda)](__dirname,_0x48a222(0xa8),'public','company'+_0x3b993b['companyId']),_0x1eb5a1=path_1[_0x48a222(0x117)]['join'](_0xd5925e,_0x3b993b['mediaPath']),_0x403c04=await(0x0,SendWhatsAppMedia_1[_0x48a222(0xc7)])(_0x3b993b[_0x48a222(0xa5)],_0x1eb5a1,_0x203bc8,_0x3b993b['companyId']);Object['keys'](_0x403c04)['length']&&await _0x248b82[_0x48a222(0x115)](_0xab6297,{..._0x403c04});}else _0x3b993b[_0x48a222(0xba)]&&_0x4610a5[_0x48a222(0xba)]===null?(await _0x248b82[_0x48a222(0x115)](_0xab6297,{'text':_0x203bc8}),await _0x4610a5[_0x48a222(0xc1)]({'confirmationRequestedAt':(0x0,moment_1['default'])()})):await _0x248b82['sendMessage'](_0xab6297,{'text':_0x203bc8});await _0x4610a5['update']({'deliveredAt':(0x0,moment_1[_0x48a222(0x117)])()}),await this['verifyAndFinalizeCampaign'](_0x3b993b);const _0x398b5c=(0x0,socket_1['getIO'])();_0x398b5c['to'](_0x48a222(0xc0)+_0x3b993b[_0x48a222(0xb3)]+_0x48a222(0xfa))[_0x48a222(0xb6)](_0x48a222(0xc0)+_0x3b993b[_0x48a222(0xb3)]+_0x48a222(0x102),{'action':'update','record':_0x3b993b}),logger_1['logger'][_0x48a222(0x10f)](_0x48a222(0xa4)+_0x1ae2e1+_0x48a222(0xed)+_0x4610a5['contact']['name']);}catch(_0x1b170e){Sentry[_0x48a222(0xdb)](_0x1b170e),logger_1['logger'][_0x48a222(0xe7)](_0x1b170e[_0x48a222(0xd1)]);}}[a572_0x45293c(0xb9)](_0x102ff7){const _0x4cf848=a572_0x45293c,_0x42ff51=[];return!(0x0,lodash_1[_0x4cf848(0x10a)])(_0x102ff7[_0x4cf848(0xf7)])&&!(0x0,lodash_1[_0x4cf848(0x81)])(_0x102ff7[_0x4cf848(0xf7)])&&_0x42ff51[_0x4cf848(0xaf)](_0x102ff7[_0x4cf848(0xf7)]),!(0x0,lodash_1[_0x4cf848(0x10a)])(_0x102ff7[_0x4cf848(0xab)])&&!(0x0,lodash_1[_0x4cf848(0x81)])(_0x102ff7['message2'])&&_0x42ff51[_0x4cf848(0xaf)](_0x102ff7['message2']),!(0x0,lodash_1[_0x4cf848(0x10a)])(_0x102ff7[_0x4cf848(0x111)])&&!(0x0,lodash_1[_0x4cf848(0x81)])(_0x102ff7[_0x4cf848(0x111)])&&_0x42ff51[_0x4cf848(0xaf)](_0x102ff7[_0x4cf848(0x111)]),!(0x0,lodash_1[_0x4cf848(0x10a)])(_0x102ff7[_0x4cf848(0xd3)])&&!(0x0,lodash_1[_0x4cf848(0x81)])(_0x102ff7[_0x4cf848(0xd3)])&&_0x42ff51[_0x4cf848(0xaf)](_0x102ff7[_0x4cf848(0xd3)]),!(0x0,lodash_1['isEmpty'])(_0x102ff7['message5'])&&!(0x0,lodash_1['isNil'])(_0x102ff7['message5'])&&_0x42ff51[_0x4cf848(0xaf)](_0x102ff7[_0x4cf848(0x11e)]),_0x42ff51;}[a572_0x45293c(0x110)](_0x1c2ec8,_0x43face,_0x4e0e22){const _0xb4e7af=a572_0x45293c;let _0x306a96=_0x1c2ec8;return _0x306a96[_0xb4e7af(0xf8)](_0xb4e7af(0xdd))&&(_0x306a96=_0x306a96[_0xb4e7af(0x104)](/{nome}/g,_0x4e0e22[_0xb4e7af(0x82)])),_0x306a96[_0xb4e7af(0xf8)](_0xb4e7af(0x85))&&(_0x306a96=_0x306a96[_0xb4e7af(0x104)](/{email}/g,_0x4e0e22[_0xb4e7af(0xf3)])),_0x306a96[_0xb4e7af(0xf8)](_0xb4e7af(0x8c))&&(_0x306a96=_0x306a96[_0xb4e7af(0x104)](/{numero}/g,_0x4e0e22[_0xb4e7af(0x8d)])),_0x43face[_0xb4e7af(0x94)](_0x48db70=>{const _0xcc423=_0xb4e7af;if(_0x306a96[_0xcc423(0xf8)]('{'+_0x48db70[_0xcc423(0xd6)]+'}')){const _0x20afd4=new RegExp('{'+_0x48db70[_0xcc423(0xd6)]+'}','g');_0x306a96=_0x306a96[_0xcc423(0x104)](_0x20afd4,_0x48db70[_0xcc423(0xd8)]);}}),_0x306a96;}async[a572_0x45293c(0x89)](_0x1aed5f){const _0x189150=a572_0x45293c,_0x51d3e4=await CampaignSetting_1[_0x189150(0x117)][_0x189150(0xd9)]({'where':{'companyId':_0x1aed5f[_0x189150(0xb3)]},'attributes':[_0x189150(0xd6),_0x189150(0xd8)]});let _0x17bb95=0x14,_0x53f16e=0x14,_0x303388=0x3c,_0x5b998f=[];return _0x51d3e4[_0x189150(0x94)](_0x8b51fc=>{const _0xd07ce1=_0x189150;_0x8b51fc[_0xd07ce1(0xd6)]===_0xd07ce1(0x98)&&(_0x17bb95=JSON[_0xd07ce1(0x90)](_0x8b51fc[_0xd07ce1(0xd8)])),_0x8b51fc[_0xd07ce1(0xd6)]===_0xd07ce1(0xbc)&&(_0x53f16e=JSON[_0xd07ce1(0x90)](_0x8b51fc[_0xd07ce1(0xd8)])),_0x8b51fc[_0xd07ce1(0xd6)]==='greaterInterval'&&(_0x303388=JSON[_0xd07ce1(0x90)](_0x8b51fc['value'])),_0x8b51fc['key']==='variables'&&(_0x5b998f=JSON[_0xd07ce1(0x90)](_0x8b51fc['value']));}),{'messageInterval':_0x17bb95,'longerIntervalAfter':_0x53f16e,'greaterInterval':_0x303388,'variables':_0x5b998f};}async['handleProcessCampaign'](_0x695eaa){const _0x4d90d3=a572_0x45293c;try{const {id:_0x35118f}=_0x695eaa[_0x4d90d3(0x114)],_0x410153=await this['getCampaign'](_0x35118f),_0x5607cb=await this[_0x4d90d3(0x89)](_0x410153);if(!_0x410153)throw new sequelize_1[(_0x4d90d3(0xaa))](_0x4d90d3(0x84));if(!_0x410153[_0x4d90d3(0x10c)]||!_0x410153[_0x4d90d3(0x10c)][_0x4d90d3(0x9f)])throw new sequelize_1[(_0x4d90d3(0xaa))]('ContactList\x20not\x20found\x20or\x20empty');if(_0x410153){const {contacts:_0x31aa23}=_0x410153[_0x4d90d3(0x10c)];if((0x0,lodash_1['isArray'])(_0x31aa23)){const _0x161c5d=_0x31aa23[_0x4d90d3(0x112)](_0x5517d9=>({'contactId':_0x5517d9['id'],'campaignId':_0x410153['id'],'variables':_0x5607cb[_0x4d90d3(0xdc)]})),_0x435c0e=(0x0,queues_1['parseToMilliseconds'])(_0x5607cb['longerIntervalAfter']),_0x20c0bb=(0x0,queues_1[_0x4d90d3(0xc2)])(_0x5607cb[_0x4d90d3(0x113)]),_0x4f5ac4=_0x5607cb['messageInterval'];let _0x575950=_0x410153['scheduledAt'];const _0x101c48=[];for(let _0x5965d2=0x0;_0x5965d2<_0x161c5d[_0x4d90d3(0xac)];_0x5965d2++){_0x575950=(0x0,date_fns_1[_0x4d90d3(0xb5)])(_0x575950,_0x5965d2>_0x435c0e?_0x20c0bb:_0x4f5ac4);const {contactId:_0x130351,campaignId:_0x413950,variables:_0x395c81}=_0x161c5d[_0x5965d2],_0x5541d3=this[_0x4d90d3(0xfc)](_0x5965d2,_0x575950,_0x435c0e,_0x20c0bb,_0x4f5ac4),_0x3c1e0a=queues_1[_0x4d90d3(0x100)][_0x4d90d3(0x120)](_0x4d90d3(0x88),{'contactId':_0x130351,'campaignId':_0x413950,'variables':_0x395c81,'delay':_0x5541d3+(0x0,queues_1[_0x4d90d3(0x8a)])(0x64,0x5dc)},{'removeOnComplete':!![]});_0x101c48[_0x4d90d3(0xaf)](_0x3c1e0a),logger_1[_0x4d90d3(0x11b)]['info'](_0x4d90d3(0x10b)+_0x410153['id']+_0x4d90d3(0xed)+_0x31aa23[_0x5965d2]['name']+_0x4d90d3(0x11d)+_0x5541d3);}await Promise['all'](_0x101c48),await _0x410153[_0x4d90d3(0xc1)]({'status':'EM_ANDAMENTO'});}}}catch(_0x1bc5bb){logger_1[_0x4d90d3(0x11b)][_0x4d90d3(0xe7)](_0x1bc5bb),Sentry['captureException'](_0x1bc5bb);}}async[a572_0x45293c(0xe3)](_0x2a1ff3){const _0x161248=a572_0x45293c,_0x56087b=await Campaign_1[_0x161248(0x117)][_0x161248(0x8b)](_0x2a1ff3,{'include':[{'model':ContactList_1['default'],'as':_0x161248(0x10c),'attributes':['id',_0x161248(0x82)],'include':[{'model':ContactListItem_1[_0x161248(0x117)],'as':_0x161248(0x9f),'attributes':['id',_0x161248(0x82),_0x161248(0x8d),_0x161248(0xf3),'isWhatsappValid'],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x161248(0x117)],'as':_0x161248(0xef),'attributes':['id','name']},{'model':CampaignShipping_1[_0x161248(0x117)],'as':_0x161248(0xd0),'include':[{'model':ContactListItem_1[_0x161248(0x117)],'as':'contact'}]}]});if(!_0x56087b||!_0x56087b[_0x161248(0x10c)])throw new sequelize_1[(_0x161248(0xaa))](_0x161248(0xff));return _0x56087b;}async[a572_0x45293c(0x9d)](_0xdff37b){const _0x226fa6=a572_0x45293c,_0x528a2c=new Date(new Date()[_0x226fa6(0xe1)]()+0x3c*0x3c*0x3e8);let _0x11eb52=await Campaign_1[_0x226fa6(0x117)][_0x226fa6(0xd9)]({'where':{'scheduledAt':{[sequelize_1['Op'][_0x226fa6(0x116)]]:+_0x528a2c},'status':_0x226fa6(0x87)},'attributes':['id','scheduledAt']});if(_0x11eb52[_0x226fa6(0xac)]>0x0)logger_1[_0x226fa6(0x11b)][_0x226fa6(0x10f)](_0x226fa6(0xe0)+_0x11eb52[_0x226fa6(0xac)]);for(let _0x516fb9 of _0x11eb52){try{const _0x32533b=(0x0,moment_1[_0x226fa6(0x117)])(),_0x820086=(0x0,moment_1[_0x226fa6(0x117)])(_0x516fb9['scheduledAt']),_0x6bbbad=_0x820086[_0x226fa6(0xfb)](_0x32533b,_0x226fa6(0x11c));logger_1[_0x226fa6(0x11b)][_0x226fa6(0x10f)](_0x226fa6(0x96)+_0x516fb9['id']+_0x226fa6(0xbf)+_0x6bbbad);const _0x2a5c10=await this['getCampaign'](_0x516fb9['id']);if(!_0x2a5c10[_0x226fa6(0x10c)]||!_0x2a5c10['contactList'][_0x226fa6(0x9f)])throw new sequelize_1['Error'](_0x226fa6(0x9c));await queues_1['campaignQueue'][_0x226fa6(0x120)](_0x226fa6(0x10e),{'id':_0x516fb9['id'],'delay':_0x6bbbad},{'delay':_0x6bbbad,'removeOnComplete':!![]});}catch(_0x3c341f){return Sentry[_0x226fa6(0xdb)](_0x3c341f),Promise[_0x226fa6(0x108)](new sequelize_1[(_0x226fa6(0xaa))](_0x3c341f));}}return Promise[_0x226fa6(0xda)]({'count':_0x11eb52[_0x226fa6(0xac)]});}}exports[a572_0x45293c(0x117)]=CampaingJob;