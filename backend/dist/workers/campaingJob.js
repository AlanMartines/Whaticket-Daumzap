const a572_0x2c7da8=a572_0x7939;(function(_0x2b3914,_0x16c120){const _0x4e14eb=a572_0x7939,_0x2e7ce4=_0x2b3914();while(!![]){try{const _0x1a1e22=parseInt(_0x4e14eb(0xde))/0x1*(parseInt(_0x4e14eb(0xa1))/0x2)+-parseInt(_0x4e14eb(0x11d))/0x3+-parseInt(_0x4e14eb(0xd7))/0x4+parseInt(_0x4e14eb(0x108))/0x5*(parseInt(_0x4e14eb(0xdd))/0x6)+parseInt(_0x4e14eb(0x121))/0x7*(parseInt(_0x4e14eb(0xdf))/0x8)+parseInt(_0x4e14eb(0x99))/0x9+-parseInt(_0x4e14eb(0xc1))/0xa*(parseInt(_0x4e14eb(0xce))/0xb);if(_0x1a1e22===_0x16c120)break;else _0x2e7ce4['push'](_0x2e7ce4['shift']());}catch(_0x25f395){_0x2e7ce4['push'](_0x2e7ce4['shift']());}}}(a572_0x3a20,0x61fdf));const a572_0x302c91=(function(){let _0x365029=!![];return function(_0x480982,_0x199fd7){const _0x52ae75=_0x365029?function(){if(_0x199fd7){const _0x20ba82=_0x199fd7['apply'](_0x480982,arguments);return _0x199fd7=null,_0x20ba82;}}:function(){};return _0x365029=![],_0x52ae75;};}()),a572_0x5442fc=a572_0x302c91(this,function(){const _0x5e27d2=a572_0x7939;return a572_0x5442fc['toString']()['search'](_0x5e27d2(0x105))[_0x5e27d2(0xab)]()[_0x5e27d2(0xf2)](a572_0x5442fc)[_0x5e27d2(0xb1)]('(((.+)+)+)+$');});a572_0x5442fc();'use strict';function a572_0x3a20(){const _0x77a2f6=['campaignId','info','../models/Campaign','contactId','EM_ANDAMENTO','confirmationRequestedAt','lte','get','{numero}','../services/WbotServices/SendWhatsAppMedia','confirmationMessage3','scheduledAt','addSeconds','email','FINALIZADA','message2','resolve','longerIntervalAfter','(((.+)+)+)+$','messageInterval','confirmationMessage4','3897895wFkzDn','fileListId','confirmation','number','whatsapp','configurable','VerifyCampaigns','__importStar','ProcessCampaign','prototype','@sentry/node','__importDefault','isWhatsappValid','trimStart','getProcessedMessage','map','bullmq','logger','message4','campaignQueue','__esModule','476013RcQQQI','count',')\x20completed','completed','189735caAOiS','contact','../utils/logger','error','length','mediaPath','getIO','Job\x20','message5','variables','../helpers/SendPresenceStatus','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','greaterInterval','confirmationMessage2','PROGRAMADA','handlePrepareContact','-mainchannel','save','-campaign','contactList','../models/CampaignSetting','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','confirmationMessage5','../..','Campaign\x20not\x20found','message','sendMessage','findAll','6742539keMkyf','getCampaignValidConfirmationMessages','getCampaign','SendPresenceStatus','message3','writable','push','Error','2fcuWaS','mediaName','value','../queues','create','calculateDelay','getTime','@s.whatsapp.net','key','options','toString','diff','moment/moment','Campaign\x20or\x20ContactList\x20not\x20found','getSettings','../libs/socket','search','isEmpty','call','user','company','isNil','captureException','DispatchCampaign','emit','contacts','confirmationMessage',',\x20Delay\x20Inicial=','isArray','join','companyId','forEach','389380ypVhba','deliveredAt','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','randomValue','company-','failed','getContact','findByPk','lodash','name','__createBinding','handleDispatchCampaign','defineProperty','440GxplOm','default','parseToMilliseconds','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','path','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','{email}','includes','getCampaignValidMessages','2991860fYKcjL','parse','entries','not','hasOwnProperty','update','6TfgUJn','550736ySGmFb','232qKSvyj','data','verifyAndFinalizeCampaign','../helpers/GetWhatsappWbot','PrepareContact','../models/ContactList','ContactList\x20not\x20found\x20or\x20empty','Worker',';Contato=',';Registro=','handleVerifyCampaigns','replace','Campanha\x20enviada\x20para:\x20Campanha=','set','public','handleProcessCampaign','campaign.contactList\x20is\x20null\x20or\x20undefined','sequelize','__setModuleDefault','constructor'];a572_0x3a20=function(){return _0x77a2f6;};return a572_0x3a20();}var __createBinding=this&&this[a572_0x2c7da8(0xcb)]||(Object[a572_0x2c7da8(0xa5)]?function(_0x40d853,_0x2ffd08,_0x415f5a,_0x1decff){const _0x5d6e91=a572_0x2c7da8;if(_0x1decff===undefined)_0x1decff=_0x415f5a;var _0x43ff22=Object['getOwnPropertyDescriptor'](_0x2ffd08,_0x415f5a);(!_0x43ff22||(_0x5d6e91(0xfa)in _0x43ff22?!_0x2ffd08[_0x5d6e91(0x11c)]:_0x43ff22[_0x5d6e91(0x9e)]||_0x43ff22[_0x5d6e91(0x10d)]))&&(_0x43ff22={'enumerable':!![],'get':function(){return _0x2ffd08[_0x415f5a];}}),Object[_0x5d6e91(0xcd)](_0x40d853,_0x1decff,_0x43ff22);}:function(_0x555084,_0x591e8a,_0x4d24da,_0xc56e70){if(_0xc56e70===undefined)_0xc56e70=_0x4d24da;_0x555084[_0xc56e70]=_0x591e8a[_0x4d24da];}),__setModuleDefault=this&&this[a572_0x2c7da8(0xf1)]||(Object['create']?function(_0x1a8972,_0x187f41){const _0x238551=a572_0x2c7da8;Object['defineProperty'](_0x1a8972,_0x238551(0xcf),{'enumerable':!![],'value':_0x187f41});}:function(_0x23781d,_0x339619){const _0x488b9c=a572_0x2c7da8;_0x23781d[_0x488b9c(0xcf)]=_0x339619;}),__importStar=this&&this[a572_0x2c7da8(0x10f)]||function(_0x4ca56d){const _0x1a1da8=a572_0x2c7da8;if(_0x4ca56d&&_0x4ca56d[_0x1a1da8(0x11c)])return _0x4ca56d;var _0x2b13ce={};if(_0x4ca56d!=null){for(var _0x117f37 in _0x4ca56d)if(_0x117f37!==_0x1a1da8(0xcf)&&Object[_0x1a1da8(0x111)][_0x1a1da8(0xdb)][_0x1a1da8(0xb3)](_0x4ca56d,_0x117f37))__createBinding(_0x2b13ce,_0x4ca56d,_0x117f37);}return __setModuleDefault(_0x2b13ce,_0x4ca56d),_0x2b13ce;},__importDefault=this&&this[a572_0x2c7da8(0x113)]||function(_0xeb85a6){return _0xeb85a6&&_0xeb85a6['__esModule']?_0xeb85a6:{'default':_0xeb85a6};};function a572_0x7939(_0x383517,_0x3801bc){const _0x49740b=a572_0x3a20();return a572_0x7939=function(_0x5442fc,_0x302c91){_0x5442fc=_0x5442fc-0x99;let _0x3a20e5=_0x49740b[_0x5442fc];return _0x3a20e5;},a572_0x7939(_0x383517,_0x3801bc);}Object['defineProperty'](exports,a572_0x2c7da8(0x11c),{'value':!![]});const bullmq_1=require(a572_0x2c7da8(0x118)),Campaign_1=__importDefault(require(a572_0x2c7da8(0xf5))),sequelize_1=require(a572_0x2c7da8(0xf0)),logger_1=require(a572_0x2c7da8(0x123)),moment_1=__importDefault(require(a572_0x2c7da8(0xad))),Sentry=__importStar(require(a572_0x2c7da8(0x112))),ContactList_1=__importDefault(require(a572_0x2c7da8(0xe4))),ContactListItem_1=__importDefault(require('../models/ContactListItem')),Whatsapp_1=__importDefault(require('../models/Whatsapp')),CampaignShipping_1=__importDefault(require('../models/CampaignShipping')),queues_1=require(a572_0x2c7da8(0xa4)),lodash_1=require(a572_0x2c7da8(0xc9)),date_fns_1=require('date-fns'),GetWhatsappWbot_1=__importDefault(require(a572_0x2c7da8(0xe2))),path_1=__importDefault(require(a572_0x2c7da8(0xd2))),ShowService_1=__importDefault(require('../services/FileServices/ShowService')),SendWhatsAppMedia_1=require(a572_0x2c7da8(0xfc)),socket_1=require(a572_0x2c7da8(0xb0)),CampaignSetting_1=__importDefault(require(a572_0x2c7da8(0x135))),SendPresenceStatus_1=require(a572_0x2c7da8(0x12b));class CampaingJob{constructor(_0x35c79a,_0x5254d6){const _0x24ffc7=a572_0x2c7da8,_0x3b3234=new bullmq_1[(_0x24ffc7(0xe6))](_0x35c79a,async _0x38e55f=>{const _0x3ad28b=_0x24ffc7;if(_0x38e55f[_0x3ad28b(0xca)]===_0x3ad28b(0x10e))await this[_0x3ad28b(0xe9)](_0x38e55f);else{if(_0x38e55f[_0x3ad28b(0xca)]===_0x3ad28b(0x110))await this[_0x3ad28b(0xee)](_0x38e55f);else{if(_0x38e55f[_0x3ad28b(0xca)]==='PrepareContact')await this[_0x3ad28b(0x130)](_0x38e55f);else _0x38e55f['name']===_0x3ad28b(0xb8)&&await this[_0x3ad28b(0xcc)](_0x38e55f);}}},{'useWorkerThreads':![],'concurrency':0x64,'connection':_0x5254d6,'removeOnFail':{'count':0x0}});_0x3b3234['on'](_0x24ffc7(0x120),async _0x5a6c0f=>{const _0x39bf94=_0x24ffc7;logger_1[_0x39bf94(0x119)][_0x39bf94(0xf4)](_0x39bf94(0x128)+_0x5a6c0f['name']+'\x20('+_0x5a6c0f['id']+_0x39bf94(0x11f));}),_0x3b3234['on'](_0x24ffc7(0xc6),async(_0x10ca66,_0x5a64a2)=>{const _0x2cee90=_0x24ffc7;logger_1[_0x2cee90(0x119)][_0x2cee90(0x124)](_0x2cee90(0x128)+_0x10ca66[_0x2cee90(0xca)]+'\x20failed\x20with\x20error:\x20'+_0x5a64a2[_0x2cee90(0x13a)]);});}async['getContact'](_0x4dbbb2){const _0x9f64d4=a572_0x2c7da8;return ContactListItem_1[_0x9f64d4(0xcf)][_0x9f64d4(0xc8)](_0x4dbbb2,{'attributes':['id','name',_0x9f64d4(0x10b),_0x9f64d4(0x100)]});}async[a572_0x2c7da8(0x130)](_0x8796a4){const _0x51a183=a572_0x2c7da8;try{const {contactId:_0x10e258,campaignId:_0x170bdb,delay:_0x2a93ac,variables:_0xf98f20}=_0x8796a4[_0x51a183(0xe0)],_0x100322=await this['getCampaign'](_0x170bdb),_0x3e1644=await this[_0x51a183(0xc7)](_0x10e258),_0x48a964={};_0x48a964['number']=_0x3e1644[_0x51a183(0x10b)],_0x48a964['contactId']=_0x10e258,_0x48a964[_0x51a183(0xf3)]=_0x170bdb;const _0x1dc088=this[_0x51a183(0xd6)](_0x100322);if(_0x1dc088[_0x51a183(0x125)]){const _0x723a4d=(0x0,queues_1[_0x51a183(0xc4)])(0x0,_0x1dc088[_0x51a183(0x125)]),_0x3158cc=this['getProcessedMessage'](_0x1dc088[_0x723a4d],_0xf98f20,_0x3e1644);_0x48a964[_0x51a183(0x13a)]='‌\x20'+_0x3158cc;}if(_0x100322[_0x51a183(0x10a)]){const _0x394fa9=this[_0x51a183(0x9a)](_0x100322);if(_0x394fa9[_0x51a183(0x125)]){const _0x573782=(0x0,queues_1[_0x51a183(0xc4)])(0x0,_0x394fa9[_0x51a183(0x125)]),_0x36e7bf=this[_0x51a183(0x116)](_0x394fa9[_0x573782],_0xf98f20,_0x3e1644);_0x48a964[_0x51a183(0xbb)]='‌\x20'+_0x36e7bf;}}const [_0x4b3dcd,_0x1f4a15]=await CampaignShipping_1[_0x51a183(0xcf)]['findOrCreate']({'where':{'campaignId':_0x48a964[_0x51a183(0xf3)],'contactId':_0x48a964[_0x51a183(0xf6)]},'defaults':_0x48a964});!_0x1f4a15&&_0x4b3dcd[_0x51a183(0xc2)]===null&&_0x4b3dcd[_0x51a183(0xf8)]===null&&(_0x4b3dcd[_0x51a183(0xec)](_0x48a964),await _0x4b3dcd[_0x51a183(0x132)]());if(_0x4b3dcd[_0x51a183(0xc2)]===null&&_0x4b3dcd[_0x51a183(0xf8)]===null){const _0x267904=await queues_1['campaignQueue']['add'](_0x51a183(0xb8),{'campaignId':_0x100322['id'],'campaignShippingId':_0x4b3dcd['id'],'contactListItemId':_0x10e258},{'removeOnComplete':!![],'delay':_0x2a93ac});await _0x4b3dcd[_0x51a183(0xdc)]({'jobId':_0x267904['id']});}await this[_0x51a183(0xe1)](_0x100322);}catch(_0xacb58a){Sentry['captureException'](_0xacb58a),logger_1[_0x51a183(0x119)]['error'](_0x51a183(0xc3)+_0xacb58a['message']);}}async['verifyAndFinalizeCampaign'](_0x4387b2){const _0x341057=a572_0x2c7da8;if(!_0x4387b2[_0x341057(0x134)])throw new sequelize_1['Error'](_0x341057(0xef));const {contacts:_0x243109}=_0x4387b2['contactList'],_0x1a2305=_0x243109[_0x341057(0x125)],_0x3e322d=await CampaignShipping_1['default'][_0x341057(0x11e)]({'where':{'campaignId':_0x4387b2['id'],'deliveredAt':{[sequelize_1['Op'][_0x341057(0xda)]]:null}}});_0x1a2305===_0x3e322d&&await _0x4387b2[_0x341057(0xdc)]({'status':_0x341057(0x101),'completedAt':(0x0,moment_1['default'])()});const _0x5b5c12=(0x0,socket_1[_0x341057(0x127)])();_0x5b5c12['to'](_0x341057(0xc5)+_0x4387b2[_0x341057(0xbf)]+_0x341057(0x131))['emit'](_0x341057(0xc5)+_0x4387b2[_0x341057(0xbf)]+_0x341057(0x133),{'action':_0x341057(0xdc),'record':_0x4387b2});}[a572_0x2c7da8(0xa6)](_0x5320c5,_0x3da54c,_0x2291f6,_0x3e5b9a,_0x5dd126){const _0x3c2a1b=(0x0,date_fns_1['differenceInSeconds'])(_0x3da54c,new Date());return _0x5320c5>_0x2291f6?_0x3c2a1b*0x3e8+_0x3e5b9a:_0x3c2a1b*0x3e8+_0x5dd126;}['getCampaignValidConfirmationMessages'](_0x25acc0){const _0x4083c3=a572_0x2c7da8,_0x5b7243=[];return!(0x0,lodash_1['isEmpty'])(_0x25acc0['confirmationMessage1'])&&!(0x0,lodash_1[_0x4083c3(0xb6)])(_0x25acc0['confirmationMessage1'])&&_0x5b7243[_0x4083c3(0x9f)](_0x25acc0['confirmationMessage1']),!(0x0,lodash_1[_0x4083c3(0xb2)])(_0x25acc0[_0x4083c3(0x12e)])&&!(0x0,lodash_1[_0x4083c3(0xb6)])(_0x25acc0[_0x4083c3(0x12e)])&&_0x5b7243[_0x4083c3(0x9f)](_0x25acc0[_0x4083c3(0x12e)]),!(0x0,lodash_1[_0x4083c3(0xb2)])(_0x25acc0['confirmationMessage3'])&&!(0x0,lodash_1[_0x4083c3(0xb6)])(_0x25acc0[_0x4083c3(0xfd)])&&_0x5b7243[_0x4083c3(0x9f)](_0x25acc0[_0x4083c3(0xfd)]),!(0x0,lodash_1[_0x4083c3(0xb2)])(_0x25acc0[_0x4083c3(0x107)])&&!(0x0,lodash_1[_0x4083c3(0xb6)])(_0x25acc0[_0x4083c3(0x107)])&&_0x5b7243[_0x4083c3(0x9f)](_0x25acc0[_0x4083c3(0x107)]),!(0x0,lodash_1[_0x4083c3(0xb2)])(_0x25acc0['confirmationMessage5'])&&!(0x0,lodash_1['isNil'])(_0x25acc0[_0x4083c3(0x137)])&&_0x5b7243[_0x4083c3(0x9f)](_0x25acc0[_0x4083c3(0x137)]),_0x5b7243;}async['handleDispatchCampaign'](_0x72f7a6){const _0x52bc18=a572_0x2c7da8;try{const {data:_0x48a758}=_0x72f7a6,{campaignShippingId:_0x4d7198,campaignId:_0x27097b}=_0x48a758,_0x80c5aa=await this[_0x52bc18(0x9b)](_0x27097b),_0x478871=await(0x0,GetWhatsappWbot_1[_0x52bc18(0xcf)])(_0x80c5aa[_0x52bc18(0x10c)]);if(!_0x478871){logger_1[_0x52bc18(0x119)][_0x52bc18(0x124)](_0x52bc18(0x136));return;}if(!_0x80c5aa['whatsapp']){logger_1['logger']['error'](_0x52bc18(0xd3));return;}if(!_0x478871?.[_0x52bc18(0xb4)]?.['id']){logger_1['logger'][_0x52bc18(0x124)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found');return;}logger_1[_0x52bc18(0x119)][_0x52bc18(0xf4)]('Disparo\x20de\x20campanha\x20solicitado:\x20Campanha='+_0x27097b+_0x52bc18(0xe8)+_0x4d7198);const _0x1c21d2=await CampaignShipping_1[_0x52bc18(0xcf)][_0x52bc18(0xc8)](_0x4d7198,{'include':[{'model':ContactListItem_1[_0x52bc18(0xcf)],'as':_0x52bc18(0x122)}]}),_0x566b4f=_0x1c21d2[_0x52bc18(0x10b)]+_0x52bc18(0xa8);let _0x53d5a6=_0x1c21d2[_0x52bc18(0x13a)]['trimEnd']()[_0x52bc18(0x115)]();_0x80c5aa[_0x52bc18(0x10a)]&&_0x1c21d2[_0x52bc18(0x10a)]===null&&(_0x53d5a6=_0x1c21d2['confirmationMessage']);await(0x0,SendPresenceStatus_1[_0x52bc18(0x9c)])(_0x478871,_0x566b4f);if(!(0x0,lodash_1[_0x52bc18(0xb6)])(_0x80c5aa[_0x52bc18(0x109)]))try{const _0x2a3a76=path_1['default'][_0x52bc18(0x103)](__dirname,_0x52bc18(0x138),_0x52bc18(0xed),_0x52bc18(0xb5)+_0x80c5aa[_0x52bc18(0xbf)]),_0x488878=await(0x0,ShowService_1[_0x52bc18(0xcf)])(_0x80c5aa['fileListId'],_0x80c5aa[_0x52bc18(0xbf)]),_0x27d359=path_1[_0x52bc18(0xcf)][_0x52bc18(0x103)](_0x2a3a76,'fileList',String(_0x488878['id']));for(const [_0x3f4458,_0x5285d1]of _0x488878[_0x52bc18(0xaa)][_0x52bc18(0xd9)]()){const _0x36c565=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x5285d1['path'],path_1[_0x52bc18(0xcf)][_0x52bc18(0x103)](_0x27d359,_0x5285d1['path']),_0x5285d1['name'],_0x80c5aa['companyId']);await _0x478871[_0x52bc18(0x13b)](_0x566b4f,{..._0x36c565});}}catch(_0x2315af){logger_1[_0x52bc18(0x119)]['info'](_0x2315af);}if(_0x80c5aa[_0x52bc18(0x126)]){const _0x440955=path_1['default'][_0x52bc18(0x103)](__dirname,_0x52bc18(0x138),_0x52bc18(0xed),_0x52bc18(0xb5)+_0x80c5aa['companyId']),_0x1153b6=path_1['default'][_0x52bc18(0xbe)](_0x440955,_0x80c5aa['mediaPath']),_0x121c1e=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x80c5aa[_0x52bc18(0xa2)],_0x1153b6,_0x53d5a6,_0x80c5aa[_0x52bc18(0xbf)]);Object['keys'](_0x121c1e)['length']&&await _0x478871[_0x52bc18(0x13b)](_0x566b4f,{..._0x121c1e});}else _0x80c5aa[_0x52bc18(0x10a)]&&_0x1c21d2[_0x52bc18(0x10a)]===null?(await _0x478871['sendMessage'](_0x566b4f,{'text':_0x53d5a6}),await _0x1c21d2[_0x52bc18(0xdc)]({'confirmationRequestedAt':(0x0,moment_1[_0x52bc18(0xcf)])()})):await _0x478871[_0x52bc18(0x13b)](_0x566b4f,{'text':_0x53d5a6});await _0x1c21d2['update']({'deliveredAt':(0x0,moment_1[_0x52bc18(0xcf)])()}),await this[_0x52bc18(0xe1)](_0x80c5aa);const _0x333c70=(0x0,socket_1[_0x52bc18(0x127)])();_0x333c70['to'](_0x52bc18(0xc5)+_0x80c5aa[_0x52bc18(0xbf)]+'-mainchannel')[_0x52bc18(0xb9)](_0x52bc18(0xc5)+_0x80c5aa[_0x52bc18(0xbf)]+_0x52bc18(0x133),{'action':_0x52bc18(0xdc),'record':_0x80c5aa}),logger_1[_0x52bc18(0x119)][_0x52bc18(0xf4)](_0x52bc18(0xeb)+_0x27097b+_0x52bc18(0xe7)+_0x1c21d2[_0x52bc18(0x122)][_0x52bc18(0xca)]);}catch(_0x49d752){Sentry[_0x52bc18(0xb7)](_0x49d752),logger_1[_0x52bc18(0x119)][_0x52bc18(0x124)](_0x49d752[_0x52bc18(0x13a)]);}}['getCampaignValidMessages'](_0x58a4a3){const _0x206fb3=a572_0x2c7da8,_0x5b9109=[];return!(0x0,lodash_1[_0x206fb3(0xb2)])(_0x58a4a3['message1'])&&!(0x0,lodash_1[_0x206fb3(0xb6)])(_0x58a4a3['message1'])&&_0x5b9109[_0x206fb3(0x9f)](_0x58a4a3['message1']),!(0x0,lodash_1[_0x206fb3(0xb2)])(_0x58a4a3['message2'])&&!(0x0,lodash_1[_0x206fb3(0xb6)])(_0x58a4a3[_0x206fb3(0x102)])&&_0x5b9109[_0x206fb3(0x9f)](_0x58a4a3[_0x206fb3(0x102)]),!(0x0,lodash_1[_0x206fb3(0xb2)])(_0x58a4a3[_0x206fb3(0x9d)])&&!(0x0,lodash_1['isNil'])(_0x58a4a3[_0x206fb3(0x9d)])&&_0x5b9109[_0x206fb3(0x9f)](_0x58a4a3['message3']),!(0x0,lodash_1[_0x206fb3(0xb2)])(_0x58a4a3[_0x206fb3(0x11a)])&&!(0x0,lodash_1[_0x206fb3(0xb6)])(_0x58a4a3['message4'])&&_0x5b9109[_0x206fb3(0x9f)](_0x58a4a3['message4']),!(0x0,lodash_1[_0x206fb3(0xb2)])(_0x58a4a3[_0x206fb3(0x129)])&&!(0x0,lodash_1[_0x206fb3(0xb6)])(_0x58a4a3['message5'])&&_0x5b9109[_0x206fb3(0x9f)](_0x58a4a3[_0x206fb3(0x129)]),_0x5b9109;}[a572_0x2c7da8(0x116)](_0x3796b2,_0x33fe6,_0x5026f4){const _0x562517=a572_0x2c7da8;let _0x27f968=_0x3796b2;return _0x27f968[_0x562517(0xd5)]('{nome}')&&(_0x27f968=_0x27f968[_0x562517(0xea)](/{nome}/g,_0x5026f4[_0x562517(0xca)])),_0x27f968[_0x562517(0xd5)](_0x562517(0xd4))&&(_0x27f968=_0x27f968[_0x562517(0xea)](/{email}/g,_0x5026f4['email'])),_0x27f968[_0x562517(0xd5)](_0x562517(0xfb))&&(_0x27f968=_0x27f968['replace'](/{numero}/g,_0x5026f4[_0x562517(0x10b)])),_0x33fe6['forEach'](_0x56c4b7=>{const _0x539db3=_0x562517;if(_0x27f968[_0x539db3(0xd5)]('{'+_0x56c4b7[_0x539db3(0xa9)]+'}')){const _0x23bc0a=new RegExp('{'+_0x56c4b7[_0x539db3(0xa9)]+'}','g');_0x27f968=_0x27f968[_0x539db3(0xea)](_0x23bc0a,_0x56c4b7[_0x539db3(0xa3)]);}}),_0x27f968;}async[a572_0x2c7da8(0xaf)](_0xd0f40d){const _0x500ea2=a572_0x2c7da8,_0x222e78=await CampaignSetting_1[_0x500ea2(0xcf)]['findAll']({'where':{'companyId':_0xd0f40d[_0x500ea2(0xbf)]},'attributes':['key','value']});let _0x1cc038=0x14,_0x5220a3=0x14,_0x163adf=0x3c,_0x177ea3=[];return _0x222e78[_0x500ea2(0xc0)](_0x5d8135=>{const _0x209de4=_0x500ea2;_0x5d8135[_0x209de4(0xa9)]===_0x209de4(0x106)&&(_0x1cc038=JSON['parse'](_0x5d8135[_0x209de4(0xa3)])),_0x5d8135[_0x209de4(0xa9)]==='longerIntervalAfter'&&(_0x5220a3=JSON['parse'](_0x5d8135['value'])),_0x5d8135['key']==='greaterInterval'&&(_0x163adf=JSON['parse'](_0x5d8135[_0x209de4(0xa3)])),_0x5d8135['key']===_0x209de4(0x12a)&&(_0x177ea3=JSON[_0x209de4(0xd8)](_0x5d8135[_0x209de4(0xa3)]));}),{'messageInterval':_0x1cc038,'longerIntervalAfter':_0x5220a3,'greaterInterval':_0x163adf,'variables':_0x177ea3};}async[a572_0x2c7da8(0xee)](_0x8f2871){const _0x193ad8=a572_0x2c7da8;try{const {id:_0x298a00}=_0x8f2871[_0x193ad8(0xe0)],_0x229a8a=await this[_0x193ad8(0x9b)](_0x298a00),_0x7cd561=await this['getSettings'](_0x229a8a);if(!_0x229a8a)throw new sequelize_1[(_0x193ad8(0xa0))](_0x193ad8(0x139));if(!_0x229a8a['contactList']||!_0x229a8a['contactList'][_0x193ad8(0xba)])throw new sequelize_1['Error']('ContactList\x20not\x20found\x20or\x20empty');if(_0x229a8a){const {contacts:_0x5130c3}=_0x229a8a[_0x193ad8(0x134)];if((0x0,lodash_1[_0x193ad8(0xbd)])(_0x5130c3)){const _0xd6a743=_0x5130c3[_0x193ad8(0x117)](_0x4a5005=>({'contactId':_0x4a5005['id'],'campaignId':_0x229a8a['id'],'variables':_0x7cd561['variables']})),_0x5231eb=(0x0,queues_1[_0x193ad8(0xd0)])(_0x7cd561[_0x193ad8(0x104)]),_0x34df43=(0x0,queues_1['parseToMilliseconds'])(_0x7cd561[_0x193ad8(0x12d)]),_0x561520=_0x7cd561[_0x193ad8(0x106)];let _0x51fcca=_0x229a8a[_0x193ad8(0xfe)];const _0x45382a=[];for(let _0x5455a3=0x0;_0x5455a3<_0xd6a743[_0x193ad8(0x125)];_0x5455a3++){_0x51fcca=(0x0,date_fns_1[_0x193ad8(0xff)])(_0x51fcca,_0x5455a3>_0x5231eb?_0x34df43:_0x561520);const {contactId:_0x351c82,campaignId:_0x43ac24,variables:_0x2c3b90}=_0xd6a743[_0x5455a3],_0x5029e1=this[_0x193ad8(0xa6)](_0x5455a3,_0x51fcca,_0x5231eb,_0x34df43,_0x561520),_0x38003d=queues_1[_0x193ad8(0x11b)]['add'](_0x193ad8(0xe3),{'contactId':_0x351c82,'campaignId':_0x43ac24,'variables':_0x2c3b90,'delay':_0x5029e1+(0x0,queues_1[_0x193ad8(0xc4)])(0x64,0x5dc)},{'removeOnComplete':!![]});_0x45382a['push'](_0x38003d),logger_1[_0x193ad8(0x119)][_0x193ad8(0xf4)](_0x193ad8(0x12c)+_0x229a8a['id']+_0x193ad8(0xe7)+_0x5130c3[_0x5455a3][_0x193ad8(0xca)]+';delay='+_0x5029e1);}await Promise['all'](_0x45382a),await _0x229a8a[_0x193ad8(0xdc)]({'status':_0x193ad8(0xf7)});}}}catch(_0x1bba12){logger_1[_0x193ad8(0x119)][_0x193ad8(0x124)](_0x1bba12),Sentry[_0x193ad8(0xb7)](_0x1bba12);}}async[a572_0x2c7da8(0x9b)](_0x4c6bc5){const _0x8cca9=a572_0x2c7da8,_0x1b86d8=await Campaign_1[_0x8cca9(0xcf)]['findByPk'](_0x4c6bc5,{'include':[{'model':ContactList_1[_0x8cca9(0xcf)],'as':_0x8cca9(0x134),'attributes':['id',_0x8cca9(0xca)],'include':[{'model':ContactListItem_1[_0x8cca9(0xcf)],'as':_0x8cca9(0xba),'attributes':['id',_0x8cca9(0xca),'number','email',_0x8cca9(0x114)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x8cca9(0xcf)],'as':_0x8cca9(0x10c),'attributes':['id','name']},{'model':CampaignShipping_1[_0x8cca9(0xcf)],'as':'shipping','include':[{'model':ContactListItem_1[_0x8cca9(0xcf)],'as':_0x8cca9(0x122)}]}]});if(!_0x1b86d8||!_0x1b86d8[_0x8cca9(0x134)])throw new sequelize_1[(_0x8cca9(0xa0))](_0x8cca9(0xae));return _0x1b86d8;}async[a572_0x2c7da8(0xe9)](_0x216fba){const _0x49a761=a572_0x2c7da8,_0x41ab26=new Date(new Date()[_0x49a761(0xa7)]()+0x3c*0x3c*0x3e8);let _0x251374=await Campaign_1[_0x49a761(0xcf)][_0x49a761(0x13c)]({'where':{'scheduledAt':{[sequelize_1['Op'][_0x49a761(0xf9)]]:+_0x41ab26},'status':_0x49a761(0x12f)},'attributes':['id','scheduledAt']});if(_0x251374[_0x49a761(0x125)]>0x0)logger_1['logger']['info']('Campanhas\x20encontradas:\x20'+_0x251374['length']);for(let _0x431574 of _0x251374){try{const _0x38a37a=(0x0,moment_1[_0x49a761(0xcf)])(),_0x511704=(0x0,moment_1['default'])(_0x431574['scheduledAt']),_0x5921bd=_0x511704[_0x49a761(0xac)](_0x38a37a,'milliseconds');logger_1['logger'][_0x49a761(0xf4)](_0x49a761(0xd1)+_0x431574['id']+_0x49a761(0xbc)+_0x5921bd);const _0x2e7f7d=await this[_0x49a761(0x9b)](_0x431574['id']);if(!_0x2e7f7d[_0x49a761(0x134)]||!_0x2e7f7d['contactList'][_0x49a761(0xba)])throw new sequelize_1[(_0x49a761(0xa0))](_0x49a761(0xe5));await queues_1[_0x49a761(0x11b)]['add'](_0x49a761(0x110),{'id':_0x431574['id'],'delay':_0x5921bd},{'delay':_0x5921bd,'removeOnComplete':!![]});}catch(_0x41bc80){return Sentry[_0x49a761(0xb7)](_0x41bc80),Promise['reject'](new sequelize_1['Error'](_0x41bc80));}}return Promise['resolve']({'count':_0x251374[_0x49a761(0x125)]});}}exports[a572_0x2c7da8(0xcf)]=CampaingJob;