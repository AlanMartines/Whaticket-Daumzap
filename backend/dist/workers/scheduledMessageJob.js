const a574_0x2f6a9a=a574_0x5bb8;(function(_0x1a1be6,_0x2fc088){const _0x50121e=a574_0x5bb8,_0x4fb411=_0x1a1be6();while(!![]){try{const _0x6320d7=parseInt(_0x50121e(0x243))/0x1+parseInt(_0x50121e(0x1fa))/0x2+parseInt(_0x50121e(0x224))/0x3*(-parseInt(_0x50121e(0x207))/0x4)+-parseInt(_0x50121e(0x203))/0x5*(-parseInt(_0x50121e(0x239))/0x6)+-parseInt(_0x50121e(0x206))/0x7*(-parseInt(_0x50121e(0x22c))/0x8)+parseInt(_0x50121e(0x1f6))/0x9*(-parseInt(_0x50121e(0x214))/0xa)+parseInt(_0x50121e(0x1f0))/0xb*(parseInt(_0x50121e(0x21c))/0xc);if(_0x6320d7===_0x2fc088)break;else _0x4fb411['push'](_0x4fb411['shift']());}catch(_0x315423){_0x4fb411['push'](_0x4fb411['shift']());}}}(a574_0x49f1,0x34777));const a574_0x2c58df=(function(){let _0x3c2f52=!![];return function(_0x1de551,_0x21c07f){const _0x53c3ed=_0x3c2f52?function(){const _0x4b1490=a574_0x5bb8;if(_0x21c07f){const _0x1be6c7=_0x21c07f[_0x4b1490(0x211)](_0x1de551,arguments);return _0x21c07f=null,_0x1be6c7;}}:function(){};return _0x3c2f52=![],_0x53c3ed;};}()),a574_0x36282f=a574_0x2c58df(this,function(){const _0x4bb488=a574_0x5bb8;return a574_0x36282f['toString']()[_0x4bb488(0x20e)](_0x4bb488(0x231))[_0x4bb488(0x21e)]()[_0x4bb488(0x21d)](a574_0x36282f)[_0x4bb488(0x20e)]('(((.+)+)+)+$');});a574_0x36282f();'use strict';var __createBinding=this&&this[a574_0x2f6a9a(0x241)]||(Object['create']?function(_0x44a0d0,_0x531b9a,_0x406d06,_0x46dd74){const _0x57185c=a574_0x2f6a9a;if(_0x46dd74===undefined)_0x46dd74=_0x406d06;var _0x378663=Object[_0x57185c(0x1ee)](_0x531b9a,_0x406d06);(!_0x378663||('get'in _0x378663?!_0x531b9a[_0x57185c(0x1f8)]:_0x378663[_0x57185c(0x245)]||_0x378663['configurable']))&&(_0x378663={'enumerable':!![],'get':function(){return _0x531b9a[_0x406d06];}}),Object[_0x57185c(0x216)](_0x44a0d0,_0x46dd74,_0x378663);}:function(_0x2c0cfd,_0x30df45,_0x51a383,_0xbaa2ca){if(_0xbaa2ca===undefined)_0xbaa2ca=_0x51a383;_0x2c0cfd[_0xbaa2ca]=_0x30df45[_0x51a383];}),__setModuleDefault=this&&this[a574_0x2f6a9a(0x22e)]||(Object['create']?function(_0x2b547b,_0x51bbc4){const _0x2c2511=a574_0x2f6a9a;Object[_0x2c2511(0x216)](_0x2b547b,_0x2c2511(0x213),{'enumerable':!![],'value':_0x51bbc4});}:function(_0x53e49e,_0xbc2e4b){_0x53e49e['default']=_0xbc2e4b;}),__importStar=this&&this[a574_0x2f6a9a(0x201)]||function(_0x40ee39){const _0x3e5ee6=a574_0x2f6a9a;if(_0x40ee39&&_0x40ee39[_0x3e5ee6(0x1f8)])return _0x40ee39;var _0x4c175a={};if(_0x40ee39!=null){for(var _0xa5b10d in _0x40ee39)if(_0xa5b10d!==_0x3e5ee6(0x213)&&Object['prototype'][_0x3e5ee6(0x219)][_0x3e5ee6(0x209)](_0x40ee39,_0xa5b10d))__createBinding(_0x4c175a,_0x40ee39,_0xa5b10d);}return __setModuleDefault(_0x4c175a,_0x40ee39),_0x4c175a;},__importDefault=this&&this[a574_0x2f6a9a(0x238)]||function(_0x545318){const _0x5941e7=a574_0x2f6a9a;return _0x545318&&_0x545318[_0x5941e7(0x1f8)]?_0x545318:{'default':_0x545318};};function a574_0x49f1(){const _0x35c815=['995364WpGpFV','days','__esModule','failed','13134nbUShs','format','daysR','../helpers/GetDefaultWhatsApp','@sentry/node','sequelize','ERRO','__importStar','SendScheduledMessage\x20->\x20Verify:\x20error','545wJvtPk','SendScheduledMessage\x20->\x20SendMessage:\x20error','../../public/company','35IYqwHd','48WWmanD','info','call','findByPk','log','YYYY-MM-DD\x20HH:mm','sendAt','search','catch','getRandomArbitrary','apply','AGENDADA','default','30OgNYwL','queue','defineProperty','mediaPath','error','hasOwnProperty','number','bullmq','4210980MHGciK','constructor','toString','PENDENTE','rptDays','getQueue','captureException','Job\x20','50157bEigFg','contact','campId','handleVerifySchedules','update','logger','ENVIADA','length','89920rjjXXP','then','__setModuleDefault','moment/moment','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','(((.+)+)+)+$','map','message','name','random','Worker','handleSendScheduledMessage','__importDefault','5922SNxUVT','../helpers/SendMessage','SendMessage','companyId','../utils/logger','VerifySchedules','findAll','../models/Schedule','__createBinding','Disparo\x20agendado\x20para:\x20','226054AuLrzq','add','writable','getOwnPropertyDescriptor','Mensagem\x20agendada\x20enviada\x20para:\x20','11ldWsvh','Tag\x20não\x20encontrada','../models/Tag','Erro\x20ao\x20buscar\x20tag:','../models/Contact','resolve'];a574_0x49f1=function(){return _0x35c815;};return a574_0x49f1();}Object[a574_0x2f6a9a(0x216)](exports,a574_0x2f6a9a(0x1f8),{'value':!![]});const bullmq_1=require(a574_0x2f6a9a(0x21b)),Schedule_1=__importDefault(require(a574_0x2f6a9a(0x240))),Sentry=__importStar(require(a574_0x2f6a9a(0x1fe))),logger_1=require(a574_0x2f6a9a(0x23d)),moment_1=__importDefault(require(a574_0x2f6a9a(0x22f))),GetDefaultWhatsApp_1=__importDefault(require(a574_0x2f6a9a(0x1fd))),Tag_1=__importDefault(require(a574_0x2f6a9a(0x1f2))),SendMessage_1=require(a574_0x2f6a9a(0x23a)),path_1=__importDefault(require('path')),sequelize_1=require(a574_0x2f6a9a(0x1ff)),Contact_1=__importDefault(require(a574_0x2f6a9a(0x1f4)));function a574_0x5bb8(_0x55b535,_0xf0dc2d){const _0x5e4b30=a574_0x49f1();return a574_0x5bb8=function(_0x36282f,_0x2c58df){_0x36282f=_0x36282f-0x1ee;let _0x49f1a6=_0x5e4b30[_0x36282f];return _0x49f1a6;},a574_0x5bb8(_0x55b535,_0xf0dc2d);}class ScheduledMessageJob{[a574_0x2f6a9a(0x221)](){return this['queue'];}constructor(_0x5ac667,_0x4c41e6){const _0xcdc9f2=a574_0x2f6a9a;this[_0xcdc9f2(0x215)]=_0x5ac667;const _0x16d0d3=new bullmq_1[(_0xcdc9f2(0x236))](_0x5ac667[_0xcdc9f2(0x234)],async _0x3ce261=>{const _0x53a52d=_0xcdc9f2;if(_0x3ce261['name']==_0x53a52d(0x23b))await this[_0x53a52d(0x237)](_0x3ce261);else _0x3ce261[_0x53a52d(0x234)]==_0x53a52d(0x23e)&&await this[_0x53a52d(0x227)]();},{'concurrency':0x64,'connection':_0x4c41e6,'removeOnFail':{'count':0x0}});_0x16d0d3['on']('completed',async _0x55e54a=>{const _0x431be7=_0xcdc9f2;logger_1['logger'][_0x431be7(0x208)](_0x431be7(0x223)+_0x55e54a['id']+'\x20completed');}),_0x16d0d3['on'](_0xcdc9f2(0x1f9),async(_0x36d133,_0x1d209e)=>{const _0x4d502f=_0xcdc9f2;logger_1[_0x4d502f(0x229)][_0x4d502f(0x218)](_0x4d502f(0x223)+_0x36d133[_0x4d502f(0x234)]+'\x20failed\x20with\x20error:\x20'+_0x1d209e[_0x4d502f(0x233)]);});}async[a574_0x2f6a9a(0x227)](){const _0x1b6cf4=a574_0x2f6a9a;try{const _0x18539a=await Schedule_1['default'][_0x1b6cf4(0x23f)]({'where':{'status':_0x1b6cf4(0x21f),'sentAt':null,'sendAt':{[sequelize_1['Op']['lte']]:(0x0,moment_1[_0x1b6cf4(0x213)])()[_0x1b6cf4(0x1fb)]('YYYY-MM-DD\x20HH:mm:ss')}},'include':[{'model':Contact_1[_0x1b6cf4(0x213)],'as':_0x1b6cf4(0x225)}]});return _0x18539a?.[_0x1b6cf4(0x22b)]>0x0&&_0x18539a[_0x1b6cf4(0x232)](async _0x266b80=>{const _0x39d2c3=_0x1b6cf4;await _0x266b80['update']({'status':_0x39d2c3(0x212)}),await this[_0x39d2c3(0x215)][_0x39d2c3(0x244)](_0x39d2c3(0x23b),{'schedule':_0x266b80},{'delay':this[_0x39d2c3(0x210)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0x39d2c3(0x229)]['info'](_0x39d2c3(0x242)+_0x266b80[_0x39d2c3(0x225)][_0x39d2c3(0x234)]);}),Promise[_0x1b6cf4(0x1f5)]({'count':_0x18539a[_0x1b6cf4(0x22b)]});}catch(_0x5d3f5e){return Sentry['captureException'](_0x5d3f5e),logger_1[_0x1b6cf4(0x229)][_0x1b6cf4(0x218)](_0x1b6cf4(0x202),_0x5d3f5e[_0x1b6cf4(0x233)]),Promise['reject'](new sequelize_1['Error'](_0x5d3f5e));}}[a574_0x2f6a9a(0x210)](_0x4e0e49,_0x602a7){const _0x201738=a574_0x2f6a9a;return Math[_0x201738(0x235)]()*(_0x602a7-_0x4e0e49)+_0x4e0e49;}async['handleSendScheduledMessage'](_0x582da7){const _0x2f1b28=a574_0x2f6a9a,{data:{schedule:_0x37cbfb}}=_0x582da7;let _0x1fe158=null;try{_0x1fe158=await Schedule_1[_0x2f1b28(0x213)][_0x2f1b28(0x20a)](_0x37cbfb['id']);}catch(_0x36c0c4){Sentry[_0x2f1b28(0x222)](_0x36c0c4),logger_1[_0x2f1b28(0x229)][_0x2f1b28(0x208)](_0x2f1b28(0x230)+_0x37cbfb['id']);}try{if(_0x1fe158?.[_0x2f1b28(0x1fc)]!==null){let _0x41c2cc=(0x0,moment_1['default'])(_0x1fe158[_0x2f1b28(0x20d)]);const _0x462fbb=_0x37cbfb['companyId'],_0x15ef72=await(0x0,GetDefaultWhatsApp_1[_0x2f1b28(0x213)])(_0x37cbfb[_0x2f1b28(0x23c)]);let _0x153d82=null;const _0x3276e2=_0x1fe158?.[_0x2f1b28(0x226)];_0x3276e2?Tag_1['default'][_0x2f1b28(0x20a)](_0x3276e2)[_0x2f1b28(0x22d)](async _0x357b52=>{const _0x5a4c10=_0x2f1b28;if(_0x357b52){let _0x272658=_0x41c2cc[_0x5a4c10(0x244)](_0x357b52[_0x5a4c10(0x220)],_0x5a4c10(0x1f7))['format'](_0x5a4c10(0x20c));_0x357b52[_0x5a4c10(0x217)]&&(await(0x0,SendMessage_1['SendMessage'])(_0x15ef72,{'number':_0x37cbfb[_0x5a4c10(0x225)][_0x5a4c10(0x21a)],'body':_0x357b52['msgR']}),_0x153d82=path_1['default'][_0x5a4c10(0x1f5)]('../../public/company'+_0x462fbb,_0x357b52['mediaPath']),await(0x0,SendMessage_1[_0x5a4c10(0x23b)])(_0x15ef72,{'number':_0x37cbfb[_0x5a4c10(0x225)][_0x5a4c10(0x21a)],'body':_0x357b52['msgR'],'mediaPath':_0x153d82})),_0x357b52[_0x5a4c10(0x220)]===0x0?await _0x1fe158?.[_0x5a4c10(0x228)]({'sentAt':(0x0,moment_1[_0x5a4c10(0x213)])()[_0x5a4c10(0x1fb)]('YYYY-MM-DD\x20HH:mm'),'status':_0x5a4c10(0x22a)}):await _0x1fe158?.[_0x5a4c10(0x228)]({'sendAt':_0x272658,'status':_0x5a4c10(0x21f)}),logger_1[_0x5a4c10(0x229)][_0x5a4c10(0x208)](_0x5a4c10(0x1ef)+_0x37cbfb[_0x5a4c10(0x225)][_0x5a4c10(0x234)]+'\x20');}else console[_0x5a4c10(0x20b)](_0x5a4c10(0x1f1));})[_0x2f1b28(0x20f)](_0x5aa1a1=>{const _0x4d6a2a=_0x2f1b28;console[_0x4d6a2a(0x218)](_0x4d6a2a(0x1f3),_0x5aa1a1);}):console[_0x2f1b28(0x20b)]('ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord');}else{const _0x2e1fbd=await(0x0,GetDefaultWhatsApp_1[_0x2f1b28(0x213)])(_0x37cbfb[_0x2f1b28(0x23c)]);let _0xcf05c3=null;_0x37cbfb[_0x2f1b28(0x217)]&&(_0xcf05c3=path_1['default'][_0x2f1b28(0x1f5)](_0x2f1b28(0x205)+_0x37cbfb['companyId'],_0x37cbfb[_0x2f1b28(0x217)])),await(0x0,SendMessage_1['SendMessage'])(_0x2e1fbd,{'number':_0x37cbfb['contact']['number'],'body':_0x37cbfb['body'],'mediaPath':_0xcf05c3}),await _0x1fe158?.[_0x2f1b28(0x228)]({'sentAt':(0x0,moment_1[_0x2f1b28(0x213)])()[_0x2f1b28(0x1fb)](_0x2f1b28(0x20c)),'status':'ENVIADA'}),logger_1[_0x2f1b28(0x229)][_0x2f1b28(0x208)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x37cbfb[_0x2f1b28(0x225)][_0x2f1b28(0x234)]);}}catch(_0x5d8bbd){Sentry['captureException'](_0x5d8bbd),await _0x1fe158?.['update']({'status':_0x2f1b28(0x200)}),logger_1[_0x2f1b28(0x229)][_0x2f1b28(0x218)](_0x2f1b28(0x204),_0x5d8bbd[_0x2f1b28(0x233)]);throw _0x5d8bbd;}}}exports[a574_0x2f6a9a(0x213)]=ScheduledMessageJob;