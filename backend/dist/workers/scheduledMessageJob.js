const a574_0x19ed98=a574_0x4123;function a574_0x2754(){const _0x3182d9=['message','3436328nwgFUu','findByPk','mediaPath','6070424gwThdN','rptDays','3431970teLoBd','5KRhBne','captureException','body','path','error','moment/moment','queue','defineProperty','__esModule','map','ENVIADA','VerifySchedules','name','7FbHmOR','../helpers/SendMessage','Tag\x20não\x20encontrada','ERRO','../helpers/GetDefaultWhatsApp','bullmq','SendMessage','getRandomArbitrary','failed','SendScheduledMessage\x20->\x20Verify:\x20error','YYYY-MM-DD\x20HH:mm','toString','../models/Tag','catch','795652bPsPup','../models/Contact','__setModuleDefault','lte','configurable','resolve','daysR','companyId','843535OVHPMk','sendAt','__importStar','../utils/logger','../../public/company','info','350nYqDXL','msgR','getQueue','findAll','../models/Schedule','\x20failed\x20with\x20error:\x20','1146762TFmdUQ','constructor','random','contact','create','apply','2946042VwOGRm','Error','update','get','getOwnPropertyDescriptor','format','length','number','@sentry/node','Mensagem\x20agendada\x20enviada\x20para:\x20','completed','PENDENTE','handleVerifySchedules','(((.+)+)+)+$','log','writable','Erro\x20ao\x20buscar\x20tag:','Job\x20','logger','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','default','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','reject','\x20completed','call','2tdDCgd','add','__importDefault','search'];a574_0x2754=function(){return _0x3182d9;};return a574_0x2754();}(function(_0xa2c98e,_0xaca469){const _0x5a7dba=a574_0x4123,_0x30c606=_0xa2c98e();while(!![]){try{const _0x5d2e88=-parseInt(_0x5a7dba(0x1d0))/0x1*(parseInt(_0x5a7dba(0x1f6))/0x2)+-parseInt(_0x5a7dba(0x20a))/0x3+parseInt(_0x5a7dba(0x1d5))/0x4+-parseInt(_0x5a7dba(0x1db))/0x5*(parseInt(_0x5a7dba(0x210))/0x6)+parseInt(_0x5a7dba(0x1e8))/0x7*(-parseInt(_0x5a7dba(0x1d8))/0x8)+-parseInt(_0x5a7dba(0x1da))/0x9+-parseInt(_0x5a7dba(0x204))/0xa*(-parseInt(_0x5a7dba(0x1fe))/0xb);if(_0x5d2e88===_0xaca469)break;else _0x30c606['push'](_0x30c606['shift']());}catch(_0x4ae803){_0x30c606['push'](_0x30c606['shift']());}}}(a574_0x2754,0xb333b));const a574_0x1ced8f=(function(){let _0x870f3c=!![];return function(_0x1ced58,_0x580746){const _0x47a86c=_0x870f3c?function(){const _0x1a7f38=a574_0x4123;if(_0x580746){const _0x556253=_0x580746[_0x1a7f38(0x20f)](_0x1ced58,arguments);return _0x580746=null,_0x556253;}}:function(){};return _0x870f3c=![],_0x47a86c;};}()),a574_0x28b661=a574_0x1ced8f(this,function(){const _0x3a0142=a574_0x4123;return a574_0x28b661[_0x3a0142(0x1f3)]()['search'](_0x3a0142(0x21d))['toString']()[_0x3a0142(0x20b)](a574_0x28b661)[_0x3a0142(0x1d3)](_0x3a0142(0x21d));});a574_0x28b661();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a574_0x19ed98(0x20e)]?function(_0x513ca8,_0x4ac078,_0xcfd0ea,_0x165ea5){const _0x487a40=a574_0x19ed98;if(_0x165ea5===undefined)_0x165ea5=_0xcfd0ea;var _0x56a71f=Object[_0x487a40(0x214)](_0x4ac078,_0xcfd0ea);(!_0x56a71f||(_0x487a40(0x213)in _0x56a71f?!_0x4ac078[_0x487a40(0x1e3)]:_0x56a71f[_0x487a40(0x21f)]||_0x56a71f[_0x487a40(0x1fa)]))&&(_0x56a71f={'enumerable':!![],'get':function(){return _0x4ac078[_0xcfd0ea];}}),Object['defineProperty'](_0x513ca8,_0x165ea5,_0x56a71f);}:function(_0x4da3b1,_0x3d0e09,_0x4e670b,_0x1c1259){if(_0x1c1259===undefined)_0x1c1259=_0x4e670b;_0x4da3b1[_0x1c1259]=_0x3d0e09[_0x4e670b];}),__setModuleDefault=this&&this[a574_0x19ed98(0x1f8)]||(Object[a574_0x19ed98(0x20e)]?function(_0x22e23d,_0x292a05){const _0x95fc06=a574_0x19ed98;Object[_0x95fc06(0x1e2)](_0x22e23d,_0x95fc06(0x1cb),{'enumerable':!![],'value':_0x292a05});}:function(_0x52b3c8,_0x15c84e){const _0x2a4da4=a574_0x19ed98;_0x52b3c8[_0x2a4da4(0x1cb)]=_0x15c84e;}),__importStar=this&&this[a574_0x19ed98(0x200)]||function(_0x3ee464){const _0x29c008=a574_0x19ed98;if(_0x3ee464&&_0x3ee464[_0x29c008(0x1e3)])return _0x3ee464;var _0x5d0944={};if(_0x3ee464!=null){for(var _0x688131 in _0x3ee464)if(_0x688131!==_0x29c008(0x1cb)&&Object['prototype']['hasOwnProperty'][_0x29c008(0x1cf)](_0x3ee464,_0x688131))__createBinding(_0x5d0944,_0x3ee464,_0x688131);}return __setModuleDefault(_0x5d0944,_0x3ee464),_0x5d0944;},__importDefault=this&&this[a574_0x19ed98(0x1d2)]||function(_0x46fe26){return _0x46fe26&&_0x46fe26['__esModule']?_0x46fe26:{'default':_0x46fe26};};Object[a574_0x19ed98(0x1e2)](exports,a574_0x19ed98(0x1e3),{'value':!![]});const bullmq_1=require(a574_0x19ed98(0x1ed)),Schedule_1=__importDefault(require(a574_0x19ed98(0x208))),Sentry=__importStar(require(a574_0x19ed98(0x218))),logger_1=require(a574_0x19ed98(0x201)),moment_1=__importDefault(require(a574_0x19ed98(0x1e0))),GetDefaultWhatsApp_1=__importDefault(require(a574_0x19ed98(0x1ec))),Tag_1=__importDefault(require(a574_0x19ed98(0x1f4))),SendMessage_1=require(a574_0x19ed98(0x1e9)),path_1=__importDefault(require(a574_0x19ed98(0x1de))),sequelize_1=require('sequelize'),Contact_1=__importDefault(require(a574_0x19ed98(0x1f7)));function a574_0x4123(_0x250f16,_0x67f4ba){const _0x107d0d=a574_0x2754();return a574_0x4123=function(_0x28b661,_0x1ced8f){_0x28b661=_0x28b661-0x1cb;let _0x275448=_0x107d0d[_0x28b661];return _0x275448;},a574_0x4123(_0x250f16,_0x67f4ba);}class ScheduledMessageJob{[a574_0x19ed98(0x206)](){const _0x35141a=a574_0x19ed98;return this[_0x35141a(0x1e1)];}constructor(_0x430322,_0x179a86){const _0x45797b=a574_0x19ed98;this['queue']=_0x430322;const _0x32926a=new bullmq_1['Worker'](_0x430322['name'],async _0x367249=>{const _0x4e8c=a574_0x4123;if(_0x367249['name']=='SendMessage')await this['handleSendScheduledMessage'](_0x367249);else _0x367249[_0x4e8c(0x1e7)]==_0x4e8c(0x1e6)&&await this[_0x4e8c(0x21c)]();},{'concurrency':0x64,'connection':_0x179a86,'removeOnFail':{'count':0x0}});_0x32926a['on'](_0x45797b(0x21a),async _0x5d86ec=>{const _0x179179=_0x45797b;logger_1[_0x179179(0x222)][_0x179179(0x203)](_0x179179(0x221)+_0x5d86ec['id']+_0x179179(0x1ce));}),_0x32926a['on'](_0x45797b(0x1f0),async(_0x34845a,_0x53dcfa)=>{const _0x415ef3=_0x45797b;logger_1['logger'][_0x415ef3(0x1df)]('Job\x20'+_0x34845a[_0x415ef3(0x1e7)]+_0x415ef3(0x209)+_0x53dcfa[_0x415ef3(0x1d4)]);});}async[a574_0x19ed98(0x21c)](){const _0x1b6f99=a574_0x19ed98;try{const _0x5750e4=await Schedule_1[_0x1b6f99(0x1cb)][_0x1b6f99(0x207)]({'where':{'status':'PENDENTE','sentAt':null,'sendAt':{[sequelize_1['Op'][_0x1b6f99(0x1f9)]]:(0x0,moment_1[_0x1b6f99(0x1cb)])()[_0x1b6f99(0x215)]('YYYY-MM-DD\x20HH:mm:ss')}},'include':[{'model':Contact_1[_0x1b6f99(0x1cb)],'as':'contact'}]});return _0x5750e4?.[_0x1b6f99(0x216)]>0x0&&_0x5750e4[_0x1b6f99(0x1e4)](async _0x213749=>{const _0x50f866=_0x1b6f99;await _0x213749[_0x50f866(0x212)]({'status':'AGENDADA'}),await this[_0x50f866(0x1e1)][_0x50f866(0x1d1)](_0x50f866(0x1ee),{'schedule':_0x213749},{'delay':this['getRandomArbitrary'](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0x50f866(0x222)][_0x50f866(0x203)]('Disparo\x20agendado\x20para:\x20'+_0x213749['contact'][_0x50f866(0x1e7)]);}),Promise[_0x1b6f99(0x1fb)]({'count':_0x5750e4[_0x1b6f99(0x216)]});}catch(_0x4f27f3){return Sentry['captureException'](_0x4f27f3),logger_1[_0x1b6f99(0x222)][_0x1b6f99(0x1df)](_0x1b6f99(0x1f1),_0x4f27f3[_0x1b6f99(0x1d4)]),Promise[_0x1b6f99(0x1cd)](new sequelize_1[(_0x1b6f99(0x211))](_0x4f27f3));}}[a574_0x19ed98(0x1ef)](_0xd4986c,_0x2237f9){const _0x268ddd=a574_0x19ed98;return Math[_0x268ddd(0x20c)]()*(_0x2237f9-_0xd4986c)+_0xd4986c;}async['handleSendScheduledMessage'](_0x2aa4bc){const _0x1a9442=a574_0x19ed98,{data:{schedule:_0x964824}}=_0x2aa4bc;let _0x380820=null;try{_0x380820=await Schedule_1[_0x1a9442(0x1cb)][_0x1a9442(0x1d6)](_0x964824['id']);}catch(_0x4a492a){Sentry[_0x1a9442(0x1dc)](_0x4a492a),logger_1[_0x1a9442(0x222)][_0x1a9442(0x203)](_0x1a9442(0x1cc)+_0x964824['id']);}try{if(_0x380820?.[_0x1a9442(0x1fc)]!==null){let _0x453049=(0x0,moment_1[_0x1a9442(0x1cb)])(_0x380820[_0x1a9442(0x1ff)]);const _0x14daeb=_0x964824[_0x1a9442(0x1fd)],_0x521322=await(0x0,GetDefaultWhatsApp_1['default'])(_0x964824['companyId']);let _0x45dc6f=null;const _0x3415f4=_0x380820?.['campId'];_0x3415f4?Tag_1['default']['findByPk'](_0x3415f4)['then'](async _0xabab70=>{const _0x25d3ab=_0x1a9442;if(_0xabab70){let _0x1cab33=_0x453049[_0x25d3ab(0x1d1)](_0xabab70[_0x25d3ab(0x1d9)],'days')['format']('YYYY-MM-DD\x20HH:mm');_0xabab70['mediaPath']&&(await(0x0,SendMessage_1[_0x25d3ab(0x1ee)])(_0x521322,{'number':_0x964824[_0x25d3ab(0x20d)]['number'],'body':_0xabab70[_0x25d3ab(0x205)]}),_0x45dc6f=path_1[_0x25d3ab(0x1cb)][_0x25d3ab(0x1fb)](_0x25d3ab(0x202)+_0x14daeb,_0xabab70[_0x25d3ab(0x1d7)]),await(0x0,SendMessage_1[_0x25d3ab(0x1ee)])(_0x521322,{'number':_0x964824['contact'][_0x25d3ab(0x217)],'body':_0xabab70[_0x25d3ab(0x205)],'mediaPath':_0x45dc6f})),_0xabab70[_0x25d3ab(0x1d9)]===0x0?await _0x380820?.[_0x25d3ab(0x212)]({'sentAt':(0x0,moment_1[_0x25d3ab(0x1cb)])()[_0x25d3ab(0x215)](_0x25d3ab(0x1f2)),'status':_0x25d3ab(0x1e5)}):await _0x380820?.[_0x25d3ab(0x212)]({'sendAt':_0x1cab33,'status':_0x25d3ab(0x21b)}),logger_1[_0x25d3ab(0x222)][_0x25d3ab(0x203)](_0x25d3ab(0x219)+_0x964824[_0x25d3ab(0x20d)][_0x25d3ab(0x1e7)]+'\x20');}else console[_0x25d3ab(0x21e)](_0x25d3ab(0x1ea));})[_0x1a9442(0x1f5)](_0x1d2eed=>{const _0xe905da=_0x1a9442;console[_0xe905da(0x1df)](_0xe905da(0x220),_0x1d2eed);}):console[_0x1a9442(0x21e)](_0x1a9442(0x223));}else{const _0x3bdd3e=await(0x0,GetDefaultWhatsApp_1[_0x1a9442(0x1cb)])(_0x964824[_0x1a9442(0x1fd)]);let _0x4f2586=null;_0x964824[_0x1a9442(0x1d7)]&&(_0x4f2586=path_1[_0x1a9442(0x1cb)][_0x1a9442(0x1fb)]('../../public/company'+_0x964824[_0x1a9442(0x1fd)],_0x964824['mediaPath'])),await(0x0,SendMessage_1['SendMessage'])(_0x3bdd3e,{'number':_0x964824[_0x1a9442(0x20d)][_0x1a9442(0x217)],'body':_0x964824[_0x1a9442(0x1dd)],'mediaPath':_0x4f2586}),await _0x380820?.[_0x1a9442(0x212)]({'sentAt':(0x0,moment_1[_0x1a9442(0x1cb)])()['format'](_0x1a9442(0x1f2)),'status':_0x1a9442(0x1e5)}),logger_1[_0x1a9442(0x222)]['info'](_0x1a9442(0x219)+_0x964824[_0x1a9442(0x20d)][_0x1a9442(0x1e7)]);}}catch(_0x20b935){Sentry['captureException'](_0x20b935),await _0x380820?.['update']({'status':_0x1a9442(0x1eb)}),logger_1['logger'][_0x1a9442(0x1df)]('SendScheduledMessage\x20->\x20SendMessage:\x20error',_0x20b935['message']);throw _0x20b935;}}}exports[a574_0x19ed98(0x1cb)]=ScheduledMessageJob;