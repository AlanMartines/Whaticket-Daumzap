function a574_0x2cba(_0x46951f,_0x4e6c8c){const _0x250922=a574_0x1042();return a574_0x2cba=function(_0x197c98,_0x59eb83){_0x197c98=_0x197c98-0x65;let _0x10425e=_0x250922[_0x197c98];return _0x10425e;},a574_0x2cba(_0x46951f,_0x4e6c8c);}const a574_0x54c512=a574_0x2cba;(function(_0x314698,_0x453174){const _0xddf7e2=a574_0x2cba,_0x3ce692=_0x314698();while(!![]){try{const _0xc843e3=parseInt(_0xddf7e2(0x8d))/0x1+parseInt(_0xddf7e2(0x8b))/0x2+parseInt(_0xddf7e2(0x95))/0x3*(parseInt(_0xddf7e2(0x9c))/0x4)+parseInt(_0xddf7e2(0x6f))/0x5+parseInt(_0xddf7e2(0x8c))/0x6*(parseInt(_0xddf7e2(0x96))/0x7)+parseInt(_0xddf7e2(0x80))/0x8+-parseInt(_0xddf7e2(0xa1))/0x9;if(_0xc843e3===_0x453174)break;else _0x3ce692['push'](_0x3ce692['shift']());}catch(_0xf68630){_0x3ce692['push'](_0x3ce692['shift']());}}}(a574_0x1042,0xcc614));const a574_0x59eb83=(function(){let _0x1aa8e0=!![];return function(_0x4a805f,_0x352faf){const _0x18207d=_0x1aa8e0?function(){const _0x213f74=a574_0x2cba;if(_0x352faf){const _0x49bf30=_0x352faf[_0x213f74(0x72)](_0x4a805f,arguments);return _0x352faf=null,_0x49bf30;}}:function(){};return _0x1aa8e0=![],_0x18207d;};}()),a574_0x197c98=a574_0x59eb83(this,function(){const _0x41b64b=a574_0x2cba;return a574_0x197c98[_0x41b64b(0x90)]()[_0x41b64b(0x68)](_0x41b64b(0x7b))['toString']()[_0x41b64b(0xa3)](a574_0x197c98)['search']('(((.+)+)+)+$');});a574_0x197c98();'use strict';function a574_0x1042(){const _0xc4cf9a=['9swiYuw','7IhGYMY','catch','Erro\x20ao\x20buscar\x20tag:','rptDays','length','SendScheduledMessage\x20->\x20Verify:\x20error','1296056YAjSxI','resolve','mediaPath','handleSendScheduledMessage','captureException','46974861MBhkwP','Tag\x20não\x20encontrada','constructor','findAll','body','name','Disparo\x20agendado\x20para:\x20','findByPk','update','message','VerifySchedules','sendAt','handleVerifySchedules','getQueue','../../public/company','Error','daysR','number','add','ERRO','create','SendMessage','bullmq','PENDENTE','search','getRandomArbitrary','YYYY-MM-DD\x20HH:mm','error','path','logger','__setModuleDefault','7778670zoVpYb','SendScheduledMessage\x20->\x20SendMessage:\x20error','getOwnPropertyDescriptor','apply','../helpers/SendMessage','log','YYYY-MM-DD\x20HH:mm:ss','__esModule','then','Job\x20','ENVIADA','default','(((.+)+)+)+$','defineProperty','sequelize','info','get','3021856gxgIQl','contact','\x20completed','Mensagem\x20agendada\x20enviada\x20para:\x20','random','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','companyId','../models/Contact','call','__importDefault','msgR','2996772ySjnUQ','6582198aqWUgv','555642FDTUkz','map','format','toString','days','completed','../models/Tag','queue'];a574_0x1042=function(){return _0xc4cf9a;};return a574_0x1042();}var __createBinding=this&&this['__createBinding']||(Object[a574_0x54c512(0xb5)]?function(_0x1ed363,_0xeaaf9e,_0x59d215,_0x3f0fd3){const _0x4e6e3e=a574_0x54c512;if(_0x3f0fd3===undefined)_0x3f0fd3=_0x59d215;var _0x8c58a1=Object[_0x4e6e3e(0x71)](_0xeaaf9e,_0x59d215);(!_0x8c58a1||(_0x4e6e3e(0x7f)in _0x8c58a1?!_0xeaaf9e[_0x4e6e3e(0x76)]:_0x8c58a1['writable']||_0x8c58a1['configurable']))&&(_0x8c58a1={'enumerable':!![],'get':function(){return _0xeaaf9e[_0x59d215];}}),Object[_0x4e6e3e(0x7c)](_0x1ed363,_0x3f0fd3,_0x8c58a1);}:function(_0x532484,_0x152e22,_0x11eb67,_0x1b2860){if(_0x1b2860===undefined)_0x1b2860=_0x11eb67;_0x532484[_0x1b2860]=_0x152e22[_0x11eb67];}),__setModuleDefault=this&&this[a574_0x54c512(0x6e)]||(Object[a574_0x54c512(0xb5)]?function(_0xf420ec,_0x28a4e7){const _0x3d27fe=a574_0x54c512;Object[_0x3d27fe(0x7c)](_0xf420ec,_0x3d27fe(0x7a),{'enumerable':!![],'value':_0x28a4e7});}:function(_0x2ed59b,_0x178ef8){const _0x4ae56c=a574_0x54c512;_0x2ed59b[_0x4ae56c(0x7a)]=_0x178ef8;}),__importStar=this&&this['__importStar']||function(_0x376a61){const _0xdd7d5a=a574_0x54c512;if(_0x376a61&&_0x376a61['__esModule'])return _0x376a61;var _0xadf5bd={};if(_0x376a61!=null){for(var _0xb069fe in _0x376a61)if(_0xb069fe!==_0xdd7d5a(0x7a)&&Object['prototype']['hasOwnProperty'][_0xdd7d5a(0x88)](_0x376a61,_0xb069fe))__createBinding(_0xadf5bd,_0x376a61,_0xb069fe);}return __setModuleDefault(_0xadf5bd,_0x376a61),_0xadf5bd;},__importDefault=this&&this[a574_0x54c512(0x89)]||function(_0x5cb637){const _0x164877=a574_0x54c512;return _0x5cb637&&_0x5cb637[_0x164877(0x76)]?_0x5cb637:{'default':_0x5cb637};};Object[a574_0x54c512(0x7c)](exports,'__esModule',{'value':!![]});const bullmq_1=require(a574_0x54c512(0x66)),Schedule_1=__importDefault(require('../models/Schedule')),Sentry=__importStar(require('@sentry/node')),logger_1=require('../utils/logger'),moment_1=__importDefault(require('moment/moment')),GetDefaultWhatsApp_1=__importDefault(require('../helpers/GetDefaultWhatsApp')),Tag_1=__importDefault(require(a574_0x54c512(0x93))),SendMessage_1=require(a574_0x54c512(0x73)),path_1=__importDefault(require(a574_0x54c512(0x6c))),sequelize_1=require(a574_0x54c512(0x7d)),Contact_1=__importDefault(require(a574_0x54c512(0x87)));class ScheduledMessageJob{[a574_0x54c512(0xae)](){const _0x324ba1=a574_0x54c512;return this[_0x324ba1(0x94)];}constructor(_0x122519,_0x565770){const _0x130eb0=a574_0x54c512;this[_0x130eb0(0x94)]=_0x122519;const _0x1e7c02=new bullmq_1['Worker'](_0x122519[_0x130eb0(0xa6)],async _0x3bb756=>{const _0x46facb=_0x130eb0;if(_0x3bb756['name']==_0x46facb(0x65))await this[_0x46facb(0x9f)](_0x3bb756);else _0x3bb756[_0x46facb(0xa6)]==_0x46facb(0xab)&&await this[_0x46facb(0xad)]();},{'concurrency':0x64,'connection':_0x565770,'removeOnFail':{'count':0x0}});_0x1e7c02['on'](_0x130eb0(0x92),async _0x2888c8=>{const _0x29f6b2=_0x130eb0;logger_1[_0x29f6b2(0x6d)][_0x29f6b2(0x7e)](_0x29f6b2(0x78)+_0x2888c8['id']+_0x29f6b2(0x82));}),_0x1e7c02['on']('failed',async(_0x32a66e,_0x421210)=>{const _0x4eb04c=_0x130eb0;logger_1['logger']['error'](_0x4eb04c(0x78)+_0x32a66e[_0x4eb04c(0xa6)]+'\x20failed\x20with\x20error:\x20'+_0x421210['message']);});}async[a574_0x54c512(0xad)](){const _0x527702=a574_0x54c512;try{const _0x59d4f5=await Schedule_1[_0x527702(0x7a)][_0x527702(0xa4)]({'where':{'status':_0x527702(0x67),'sentAt':null,'sendAt':{[sequelize_1['Op']['lte']]:(0x0,moment_1[_0x527702(0x7a)])()[_0x527702(0x8f)](_0x527702(0x75))}},'include':[{'model':Contact_1['default'],'as':'contact'}]});return _0x59d4f5?.[_0x527702(0x9a)]>0x0&&_0x59d4f5[_0x527702(0x8e)](async _0x35a23b=>{const _0x4e54f9=_0x527702;await _0x35a23b[_0x4e54f9(0xa9)]({'status':'AGENDADA'}),await this[_0x4e54f9(0x94)][_0x4e54f9(0xb3)](_0x4e54f9(0x65),{'schedule':_0x35a23b},{'delay':this[_0x4e54f9(0x69)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1['logger']['info'](_0x4e54f9(0xa7)+_0x35a23b[_0x4e54f9(0x81)][_0x4e54f9(0xa6)]);}),Promise[_0x527702(0x9d)]({'count':_0x59d4f5['length']});}catch(_0x3a148c){return Sentry[_0x527702(0xa0)](_0x3a148c),logger_1[_0x527702(0x6d)][_0x527702(0x6b)](_0x527702(0x9b),_0x3a148c[_0x527702(0xaa)]),Promise['reject'](new sequelize_1[(_0x527702(0xb0))](_0x3a148c));}}[a574_0x54c512(0x69)](_0x360acf,_0x1de85c){const _0xbce052=a574_0x54c512;return Math[_0xbce052(0x84)]()*(_0x1de85c-_0x360acf)+_0x360acf;}async[a574_0x54c512(0x9f)](_0xf5c577){const _0x28d151=a574_0x54c512,{data:{schedule:_0x34f90c}}=_0xf5c577;let _0x468a62=null;try{_0x468a62=await Schedule_1[_0x28d151(0x7a)][_0x28d151(0xa8)](_0x34f90c['id']);}catch(_0x44f84c){Sentry[_0x28d151(0xa0)](_0x44f84c),logger_1['logger'][_0x28d151(0x7e)]('Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20'+_0x34f90c['id']);}try{if(_0x468a62?.[_0x28d151(0xb1)]!==null){let _0x403372=(0x0,moment_1[_0x28d151(0x7a)])(_0x468a62[_0x28d151(0xac)]);const _0x2d3cdd=_0x34f90c[_0x28d151(0x86)],_0x5c5291=await(0x0,GetDefaultWhatsApp_1['default'])(_0x34f90c['companyId']);let _0x7c2850=null;const _0x423592=_0x468a62?.['campId'];_0x423592?Tag_1[_0x28d151(0x7a)][_0x28d151(0xa8)](_0x423592)[_0x28d151(0x77)](async _0x14821c=>{const _0x1ca814=_0x28d151;if(_0x14821c){let _0x3bb0a7=_0x403372['add'](_0x14821c[_0x1ca814(0x99)],_0x1ca814(0x91))[_0x1ca814(0x8f)](_0x1ca814(0x6a));_0x14821c[_0x1ca814(0x9e)]&&(await(0x0,SendMessage_1[_0x1ca814(0x65)])(_0x5c5291,{'number':_0x34f90c['contact'][_0x1ca814(0xb2)],'body':_0x14821c['msgR']}),_0x7c2850=path_1[_0x1ca814(0x7a)][_0x1ca814(0x9d)](_0x1ca814(0xaf)+_0x2d3cdd,_0x14821c[_0x1ca814(0x9e)]),await(0x0,SendMessage_1['SendMessage'])(_0x5c5291,{'number':_0x34f90c[_0x1ca814(0x81)][_0x1ca814(0xb2)],'body':_0x14821c[_0x1ca814(0x8a)],'mediaPath':_0x7c2850})),_0x14821c[_0x1ca814(0x99)]===0x0?await _0x468a62?.[_0x1ca814(0xa9)]({'sentAt':(0x0,moment_1[_0x1ca814(0x7a)])()[_0x1ca814(0x8f)]('YYYY-MM-DD\x20HH:mm'),'status':_0x1ca814(0x79)}):await _0x468a62?.['update']({'sendAt':_0x3bb0a7,'status':_0x1ca814(0x67)}),logger_1[_0x1ca814(0x6d)][_0x1ca814(0x7e)](_0x1ca814(0x83)+_0x34f90c[_0x1ca814(0x81)][_0x1ca814(0xa6)]+'\x20');}else console[_0x1ca814(0x74)](_0x1ca814(0xa2));})[_0x28d151(0x97)](_0x6caab5=>{const _0x1aa6db=_0x28d151;console['error'](_0x1aa6db(0x98),_0x6caab5);}):console[_0x28d151(0x74)](_0x28d151(0x85));}else{const _0x5a3c55=await(0x0,GetDefaultWhatsApp_1['default'])(_0x34f90c['companyId']);let _0x4456b0=null;_0x34f90c[_0x28d151(0x9e)]&&(_0x4456b0=path_1[_0x28d151(0x7a)][_0x28d151(0x9d)]('../../public/company'+_0x34f90c[_0x28d151(0x86)],_0x34f90c['mediaPath'])),await(0x0,SendMessage_1['SendMessage'])(_0x5a3c55,{'number':_0x34f90c['contact'][_0x28d151(0xb2)],'body':_0x34f90c[_0x28d151(0xa5)],'mediaPath':_0x4456b0}),await _0x468a62?.[_0x28d151(0xa9)]({'sentAt':(0x0,moment_1[_0x28d151(0x7a)])()['format']('YYYY-MM-DD\x20HH:mm'),'status':_0x28d151(0x79)}),logger_1[_0x28d151(0x6d)][_0x28d151(0x7e)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x34f90c[_0x28d151(0x81)][_0x28d151(0xa6)]);}}catch(_0x1b29f3){Sentry[_0x28d151(0xa0)](_0x1b29f3),await _0x468a62?.['update']({'status':_0x28d151(0xb4)}),logger_1[_0x28d151(0x6d)][_0x28d151(0x6b)](_0x28d151(0x70),_0x1b29f3[_0x28d151(0xaa)]);throw _0x1b29f3;}}}exports[a574_0x54c512(0x7a)]=ScheduledMessageJob;