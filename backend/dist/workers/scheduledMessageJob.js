const a574_0x3d2815=a574_0x2bf9;(function(_0x42125b,_0x23eb62){const _0x4a6c51=a574_0x2bf9,_0x237154=_0x42125b();while(!![]){try{const _0x48b97e=parseInt(_0x4a6c51(0x109))/0x1*(-parseInt(_0x4a6c51(0xde))/0x2)+-parseInt(_0x4a6c51(0x10b))/0x3*(parseInt(_0x4a6c51(0xfe))/0x4)+parseInt(_0x4a6c51(0xe1))/0x5+parseInt(_0x4a6c51(0x128))/0x6+-parseInt(_0x4a6c51(0x101))/0x7*(-parseInt(_0x4a6c51(0xf5))/0x8)+parseInt(_0x4a6c51(0x12c))/0x9+-parseInt(_0x4a6c51(0x11d))/0xa;if(_0x48b97e===_0x23eb62)break;else _0x237154['push'](_0x237154['shift']());}catch(_0x4e7a31){_0x237154['push'](_0x237154['shift']());}}}(a574_0x446d,0xded4e));const a574_0xedaedb=(function(){let _0x4eec92=!![];return function(_0x4c245d,_0x33c394){const _0x16ef58=_0x4eec92?function(){const _0x5ac1d2=a574_0x2bf9;if(_0x33c394){const _0x46c3a4=_0x33c394[_0x5ac1d2(0x11f)](_0x4c245d,arguments);return _0x33c394=null,_0x46c3a4;}}:function(){};return _0x4eec92=![],_0x16ef58;};}()),a574_0xcec780=a574_0xedaedb(this,function(){const _0x21d7d5=a574_0x2bf9;return a574_0xcec780[_0x21d7d5(0xff)]()[_0x21d7d5(0xfd)]('(((.+)+)+)+$')[_0x21d7d5(0xff)]()[_0x21d7d5(0xe8)](a574_0xcec780)[_0x21d7d5(0xfd)](_0x21d7d5(0xe6));});a574_0xcec780();'use strict';var __createBinding=this&&this[a574_0x3d2815(0x10a)]||(Object[a574_0x3d2815(0x102)]?function(_0x5c6a78,_0x4ec9b8,_0x71a067,_0x326b73){const _0x900e20=a574_0x3d2815;if(_0x326b73===undefined)_0x326b73=_0x71a067;var _0x5613cb=Object[_0x900e20(0x124)](_0x4ec9b8,_0x71a067);(!_0x5613cb||(_0x900e20(0x12f)in _0x5613cb?!_0x4ec9b8[_0x900e20(0x118)]:_0x5613cb['writable']||_0x5613cb[_0x900e20(0x108)]))&&(_0x5613cb={'enumerable':!![],'get':function(){return _0x4ec9b8[_0x71a067];}}),Object[_0x900e20(0xe9)](_0x5c6a78,_0x326b73,_0x5613cb);}:function(_0x30dd20,_0x59e87f,_0x744a73,_0x43216e){if(_0x43216e===undefined)_0x43216e=_0x744a73;_0x30dd20[_0x43216e]=_0x59e87f[_0x744a73];}),__setModuleDefault=this&&this[a574_0x3d2815(0xeb)]||(Object[a574_0x3d2815(0x102)]?function(_0x337ed4,_0x507e9b){const _0x152a09=a574_0x3d2815;Object[_0x152a09(0xe9)](_0x337ed4,_0x152a09(0x107),{'enumerable':!![],'value':_0x507e9b});}:function(_0x44044f,_0x248f85){const _0x6b34f4=a574_0x3d2815;_0x44044f[_0x6b34f4(0x107)]=_0x248f85;}),__importStar=this&&this['__importStar']||function(_0x2c1d49){const _0x2bfc4a=a574_0x3d2815;if(_0x2c1d49&&_0x2c1d49['__esModule'])return _0x2c1d49;var _0xbf81e0={};if(_0x2c1d49!=null){for(var _0x50d6a0 in _0x2c1d49)if(_0x50d6a0!=='default'&&Object['prototype'][_0x2bfc4a(0x125)][_0x2bfc4a(0x112)](_0x2c1d49,_0x50d6a0))__createBinding(_0xbf81e0,_0x2c1d49,_0x50d6a0);}return __setModuleDefault(_0xbf81e0,_0x2c1d49),_0xbf81e0;},__importDefault=this&&this[a574_0x3d2815(0xf8)]||function(_0x2794ef){const _0x4b30ed=a574_0x3d2815;return _0x2794ef&&_0x2794ef[_0x4b30ed(0x118)]?_0x2794ef:{'default':_0x2794ef};};Object[a574_0x3d2815(0xe9)](exports,a574_0x3d2815(0x118),{'value':!![]});function a574_0x446d(){const _0x1ae5a3=['defineProperty','path','__setModuleDefault','bullmq','@sentry/node','message','Mensagem\x20agendada\x20enviada\x20para:\x20','PENDENTE','\x20failed\x20with\x20error:\x20','number','completed','Erro\x20ao\x20buscar\x20tag:','2214400XnBpjJ','add','handleVerifySchedules','__importDefault','findByPk','AGENDADA','companyId','../helpers/GetDefaultWhatsApp','search','40648PvSGON','toString','YYYY-MM-DD\x20HH:mm:ss','28rRAtSy','create','update','rptDays','queue','YYYY-MM-DD\x20HH:mm','default','configurable','83WecnvE','__createBinding','507UbTLgz','days','mediaPath','getRandomArbitrary','info','captureException','error','call','random','\x20completed','reject','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','Job\x20','__esModule','SendMessage','sendAt','resolve','Worker','2154670pLkBTd','format','apply','findAll','Disparo\x20agendado\x20para:\x20','SendScheduledMessage\x20->\x20Verify:\x20error','name','getOwnPropertyDescriptor','hasOwnProperty','logger','SendScheduledMessage\x20->\x20SendMessage:\x20error','2596434ShrMsT','sequelize','../../public/company','handleSendScheduledMessage','4562397gwkkdo','../models/Schedule','msgR','get','length','contact','17044rjoZww','ENVIADA','log','7530085kSwxaD','Error','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','getQueue','campId','(((.+)+)+)+$','../utils/logger','constructor'];a574_0x446d=function(){return _0x1ae5a3;};return a574_0x446d();}function a574_0x2bf9(_0x73dab5,_0x1e0126){const _0xb220cf=a574_0x446d();return a574_0x2bf9=function(_0xcec780,_0xedaedb){_0xcec780=_0xcec780-0xde;let _0x446d23=_0xb220cf[_0xcec780];return _0x446d23;},a574_0x2bf9(_0x73dab5,_0x1e0126);}const bullmq_1=require(a574_0x3d2815(0xec)),Schedule_1=__importDefault(require(a574_0x3d2815(0x12d))),Sentry=__importStar(require(a574_0x3d2815(0xed))),logger_1=require(a574_0x3d2815(0xe7)),moment_1=__importDefault(require('moment/moment')),GetDefaultWhatsApp_1=__importDefault(require(a574_0x3d2815(0xfc))),Tag_1=__importDefault(require('../models/Tag')),SendMessage_1=require('../helpers/SendMessage'),path_1=__importDefault(require(a574_0x3d2815(0xea))),sequelize_1=require(a574_0x3d2815(0x129)),Contact_1=__importDefault(require('../models/Contact'));class ScheduledMessageJob{[a574_0x3d2815(0xe4)](){const _0x387e00=a574_0x3d2815;return this[_0x387e00(0x105)];}constructor(_0x22f50b,_0x5d4948){const _0x4cf10a=a574_0x3d2815;this[_0x4cf10a(0x105)]=_0x22f50b;const _0x30cb59=new bullmq_1[(_0x4cf10a(0x11c))](_0x22f50b['name'],async _0x356063=>{const _0x1149ee=_0x4cf10a;if(_0x356063[_0x1149ee(0x123)]==_0x1149ee(0x119))await this[_0x1149ee(0x12b)](_0x356063);else _0x356063['name']=='VerifySchedules'&&await this['handleVerifySchedules']();},{'concurrency':0x64,'connection':_0x5d4948,'removeOnFail':{'count':0x0}});_0x30cb59['on'](_0x4cf10a(0xf3),async _0x83682d=>{const _0x46b18a=_0x4cf10a;logger_1[_0x46b18a(0x126)][_0x46b18a(0x10f)](_0x46b18a(0x117)+_0x83682d['id']+_0x46b18a(0x114));}),_0x30cb59['on']('failed',async(_0x251ed4,_0x556e53)=>{const _0xc6fddd=_0x4cf10a;logger_1['logger'][_0xc6fddd(0x111)]('Job\x20'+_0x251ed4['name']+_0xc6fddd(0xf1)+_0x556e53[_0xc6fddd(0xee)]);});}async[a574_0x3d2815(0xf7)](){const _0xe3808a=a574_0x3d2815;try{const _0x4d3899=await Schedule_1['default'][_0xe3808a(0x120)]({'where':{'status':_0xe3808a(0xf0),'sentAt':null,'sendAt':{[sequelize_1['Op']['lte']]:(0x0,moment_1[_0xe3808a(0x107)])()['format'](_0xe3808a(0x100))}},'include':[{'model':Contact_1[_0xe3808a(0x107)],'as':'contact'}]});return _0x4d3899?.['length']>0x0&&_0x4d3899['map'](async _0x327ca2=>{const _0x30f38b=_0xe3808a;await _0x327ca2[_0x30f38b(0x103)]({'status':_0x30f38b(0xfa)}),await this['queue'][_0x30f38b(0xf6)](_0x30f38b(0x119),{'schedule':_0x327ca2},{'delay':this['getRandomArbitrary'](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0x30f38b(0x126)][_0x30f38b(0x10f)](_0x30f38b(0x121)+_0x327ca2[_0x30f38b(0x131)][_0x30f38b(0x123)]);}),Promise['resolve']({'count':_0x4d3899[_0xe3808a(0x130)]});}catch(_0x2c8e53){return Sentry[_0xe3808a(0x110)](_0x2c8e53),logger_1['logger']['error'](_0xe3808a(0x122),_0x2c8e53['message']),Promise[_0xe3808a(0x115)](new sequelize_1[(_0xe3808a(0xe2))](_0x2c8e53));}}[a574_0x3d2815(0x10e)](_0x1e1f26,_0x1442f3){const _0x55d4a8=a574_0x3d2815;return Math[_0x55d4a8(0x113)]()*(_0x1442f3-_0x1e1f26)+_0x1e1f26;}async[a574_0x3d2815(0x12b)](_0x4998e1){const _0x387f65=a574_0x3d2815,{data:{schedule:_0x5cd134}}=_0x4998e1;let _0x1dc02a=null;try{_0x1dc02a=await Schedule_1[_0x387f65(0x107)][_0x387f65(0xf9)](_0x5cd134['id']);}catch(_0x3c1740){Sentry[_0x387f65(0x110)](_0x3c1740),logger_1[_0x387f65(0x126)][_0x387f65(0x10f)](_0x387f65(0x116)+_0x5cd134['id']);}try{if(_0x1dc02a?.['daysR']!==null){let _0x3621e2=(0x0,moment_1[_0x387f65(0x107)])(_0x1dc02a[_0x387f65(0x11a)]);const _0x5e8db9=_0x5cd134[_0x387f65(0xfb)],_0x10c142=await(0x0,GetDefaultWhatsApp_1['default'])(_0x5cd134[_0x387f65(0xfb)]);let _0x1efaae=null;const _0x12aa85=_0x1dc02a?.[_0x387f65(0xe5)];_0x12aa85?Tag_1['default']['findByPk'](_0x12aa85)['then'](async _0x3ac4d6=>{const _0x2159a8=_0x387f65;if(_0x3ac4d6){let _0x19bfc4=_0x3621e2[_0x2159a8(0xf6)](_0x3ac4d6[_0x2159a8(0x104)],_0x2159a8(0x10c))[_0x2159a8(0x11e)]('YYYY-MM-DD\x20HH:mm');_0x3ac4d6[_0x2159a8(0x10d)]&&(await(0x0,SendMessage_1[_0x2159a8(0x119)])(_0x10c142,{'number':_0x5cd134[_0x2159a8(0x131)][_0x2159a8(0xf2)],'body':_0x3ac4d6[_0x2159a8(0x12e)]}),_0x1efaae=path_1[_0x2159a8(0x107)][_0x2159a8(0x11b)](_0x2159a8(0x12a)+_0x5e8db9,_0x3ac4d6['mediaPath']),await(0x0,SendMessage_1[_0x2159a8(0x119)])(_0x10c142,{'number':_0x5cd134[_0x2159a8(0x131)][_0x2159a8(0xf2)],'body':_0x3ac4d6[_0x2159a8(0x12e)],'mediaPath':_0x1efaae})),_0x3ac4d6[_0x2159a8(0x104)]===0x0?await _0x1dc02a?.[_0x2159a8(0x103)]({'sentAt':(0x0,moment_1[_0x2159a8(0x107)])()[_0x2159a8(0x11e)](_0x2159a8(0x106)),'status':_0x2159a8(0xdf)}):await _0x1dc02a?.[_0x2159a8(0x103)]({'sendAt':_0x19bfc4,'status':_0x2159a8(0xf0)}),logger_1[_0x2159a8(0x126)]['info'](_0x2159a8(0xef)+_0x5cd134[_0x2159a8(0x131)][_0x2159a8(0x123)]+'\x20');}else console['log']('Tag\x20não\x20encontrada');})['catch'](_0x32e023=>{const _0x3447bb=_0x387f65;console[_0x3447bb(0x111)](_0x3447bb(0xf4),_0x32e023);}):console[_0x387f65(0xe0)](_0x387f65(0xe3));}else{const _0xa9c0db=await(0x0,GetDefaultWhatsApp_1[_0x387f65(0x107)])(_0x5cd134['companyId']);let _0x6c78d7=null;_0x5cd134[_0x387f65(0x10d)]&&(_0x6c78d7=path_1['default']['resolve'](_0x387f65(0x12a)+_0x5cd134[_0x387f65(0xfb)],_0x5cd134[_0x387f65(0x10d)])),await(0x0,SendMessage_1[_0x387f65(0x119)])(_0xa9c0db,{'number':_0x5cd134[_0x387f65(0x131)][_0x387f65(0xf2)],'body':_0x5cd134['body'],'mediaPath':_0x6c78d7}),await _0x1dc02a?.['update']({'sentAt':(0x0,moment_1[_0x387f65(0x107)])()[_0x387f65(0x11e)](_0x387f65(0x106)),'status':_0x387f65(0xdf)}),logger_1['logger'][_0x387f65(0x10f)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x5cd134[_0x387f65(0x131)]['name']);}}catch(_0xad4cf8){Sentry['captureException'](_0xad4cf8),await _0x1dc02a?.[_0x387f65(0x103)]({'status':'ERRO'}),logger_1['logger'][_0x387f65(0x111)](_0x387f65(0x127),_0xad4cf8[_0x387f65(0xee)]);throw _0xad4cf8;}}}exports[a574_0x3d2815(0x107)]=ScheduledMessageJob;