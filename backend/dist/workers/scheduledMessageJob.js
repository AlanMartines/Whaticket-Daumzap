const a574_0x101aee=a574_0x1e0e;(function(_0x415217,_0x4ff2ad){const _0x405d68=a574_0x1e0e,_0x1344c7=_0x415217();while(!![]){try{const _0x20c894=-parseInt(_0x405d68(0xa9))/0x1*(parseInt(_0x405d68(0x6b))/0x2)+parseInt(_0x405d68(0x7c))/0x3+-parseInt(_0x405d68(0x98))/0x4+-parseInt(_0x405d68(0x8e))/0x5*(-parseInt(_0x405d68(0xbd))/0x6)+-parseInt(_0x405d68(0xb3))/0x7+-parseInt(_0x405d68(0x95))/0x8*(parseInt(_0x405d68(0xa0))/0x9)+parseInt(_0x405d68(0xa4))/0xa*(parseInt(_0x405d68(0xaf))/0xb);if(_0x20c894===_0x4ff2ad)break;else _0x1344c7['push'](_0x1344c7['shift']());}catch(_0x2afa22){_0x1344c7['push'](_0x1344c7['shift']());}}}(a574_0x216f,0x23feb));const a574_0x32001c=(function(){let _0x3df57d=!![];return function(_0x3f7612,_0x1ae66d){const _0x2cd1f9=_0x3df57d?function(){const _0x406813=a574_0x1e0e;if(_0x1ae66d){const _0x115593=_0x1ae66d[_0x406813(0xae)](_0x3f7612,arguments);return _0x1ae66d=null,_0x115593;}}:function(){};return _0x3df57d=![],_0x2cd1f9;};}()),a574_0x129a03=a574_0x32001c(this,function(){const _0x241970=a574_0x1e0e;return a574_0x129a03[_0x241970(0x9c)]()[_0x241970(0x8f)](_0x241970(0x84))[_0x241970(0x9c)]()[_0x241970(0xa6)](a574_0x129a03)[_0x241970(0x8f)](_0x241970(0x84));});a574_0x129a03();'use strict';var __createBinding=this&&this[a574_0x101aee(0xb8)]||(Object[a574_0x101aee(0x71)]?function(_0x2f5237,_0x361365,_0x4b3eb3,_0xc522ff){const _0x13d017=a574_0x101aee;if(_0xc522ff===undefined)_0xc522ff=_0x4b3eb3;var _0x4ce0dc=Object[_0x13d017(0x73)](_0x361365,_0x4b3eb3);(!_0x4ce0dc||('get'in _0x4ce0dc?!_0x361365['__esModule']:_0x4ce0dc[_0x13d017(0x6d)]||_0x4ce0dc[_0x13d017(0x7b)]))&&(_0x4ce0dc={'enumerable':!![],'get':function(){return _0x361365[_0x4b3eb3];}}),Object[_0x13d017(0x9f)](_0x2f5237,_0xc522ff,_0x4ce0dc);}:function(_0x2565f0,_0xbe8b28,_0x5d31dd,_0x2ef646){if(_0x2ef646===undefined)_0x2ef646=_0x5d31dd;_0x2565f0[_0x2ef646]=_0xbe8b28[_0x5d31dd];}),__setModuleDefault=this&&this[a574_0x101aee(0x9d)]||(Object[a574_0x101aee(0x71)]?function(_0x5d073d,_0x34ceb3){const _0x290557=a574_0x101aee;Object[_0x290557(0x9f)](_0x5d073d,_0x290557(0x76),{'enumerable':!![],'value':_0x34ceb3});}:function(_0x70ac35,_0x5cc610){_0x70ac35['default']=_0x5cc610;}),__importStar=this&&this['__importStar']||function(_0x3c5d9e){const _0x483407=a574_0x101aee;if(_0x3c5d9e&&_0x3c5d9e[_0x483407(0x93)])return _0x3c5d9e;var _0xcf138b={};if(_0x3c5d9e!=null){for(var _0x5862f4 in _0x3c5d9e)if(_0x5862f4!=='default'&&Object[_0x483407(0xa2)][_0x483407(0x86)][_0x483407(0xba)](_0x3c5d9e,_0x5862f4))__createBinding(_0xcf138b,_0x3c5d9e,_0x5862f4);}return __setModuleDefault(_0xcf138b,_0x3c5d9e),_0xcf138b;},__importDefault=this&&this['__importDefault']||function(_0x149b9d){const _0x35ebb2=a574_0x101aee;return _0x149b9d&&_0x149b9d[_0x35ebb2(0x93)]?_0x149b9d:{'default':_0x149b9d};};function a574_0x216f(){const _0x151f96=['../../public/company','create','YYYY-MM-DD\x20HH:mm','getOwnPropertyDescriptor','getRandomArbitrary','PENDENTE','default','../models/Schedule','update','\x20failed\x20with\x20error:\x20','msgR','configurable','60024yjPKyA','logger','../models/Contact','mediaPath','SendScheduledMessage\x20->\x20SendMessage:\x20error','captureException','campId','rptDays','(((.+)+)+)+$','days','hasOwnProperty','contact','queue','Job\x20','AGENDADA','Error','@sentry/node','info','29255PDXaPw','search','YYYY-MM-DD\x20HH:mm:ss','../helpers/GetDefaultWhatsApp','error','__esModule','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','3008sQUIqR','moment/moment','Mensagem\x20agendada\x20enviada\x20para:\x20','355264AzEIAg','Erro\x20ao\x20buscar\x20tag:','log','map','toString','__setModuleDefault','add','defineProperty','3897uhjnVo','handleVerifySchedules','prototype','name','10jZtYbq','length','constructor','sendAt','findByPk','13841qNeEYH','number','message','Disparo\x20agendado\x20para:\x20','then','apply','6074717AVyFir','companyId','bullmq','format','1525055TRKQOI','resolve','ERRO','ENVIADA','VerifySchedules','__createBinding','failed','call','handleSendScheduledMessage','getQueue','60zEkZvl','2GjbriM','path','writable','Tag\x20não\x20encontrada','SendMessage'];a574_0x216f=function(){return _0x151f96;};return a574_0x216f();}Object[a574_0x101aee(0x9f)](exports,a574_0x101aee(0x93),{'value':!![]});const bullmq_1=require(a574_0x101aee(0xb1)),Schedule_1=__importDefault(require(a574_0x101aee(0x77))),Sentry=__importStar(require(a574_0x101aee(0x8c))),logger_1=require('../utils/logger'),moment_1=__importDefault(require(a574_0x101aee(0x96))),GetDefaultWhatsApp_1=__importDefault(require(a574_0x101aee(0x91))),Tag_1=__importDefault(require('../models/Tag')),SendMessage_1=require('../helpers/SendMessage'),path_1=__importDefault(require(a574_0x101aee(0x6c))),sequelize_1=require('sequelize'),Contact_1=__importDefault(require(a574_0x101aee(0x7e)));function a574_0x1e0e(_0x189170,_0x1880d8){const _0x541aac=a574_0x216f();return a574_0x1e0e=function(_0x129a03,_0x32001c){_0x129a03=_0x129a03-0x6b;let _0x216f62=_0x541aac[_0x129a03];return _0x216f62;},a574_0x1e0e(_0x189170,_0x1880d8);}class ScheduledMessageJob{[a574_0x101aee(0xbc)](){const _0x310580=a574_0x101aee;return this[_0x310580(0x88)];}constructor(_0x1a0c8f,_0x1dc9cf){const _0x2a4070=a574_0x101aee;this[_0x2a4070(0x88)]=_0x1a0c8f;const _0x808271=new bullmq_1['Worker'](_0x1a0c8f['name'],async _0x34bf28=>{const _0x5eb941=_0x2a4070;if(_0x34bf28['name']==_0x5eb941(0x6f))await this[_0x5eb941(0xbb)](_0x34bf28);else _0x34bf28[_0x5eb941(0xa3)]==_0x5eb941(0xb7)&&await this[_0x5eb941(0xa1)]();},{'concurrency':0x64,'connection':_0x1dc9cf,'removeOnFail':{'count':0x0}});_0x808271['on']('completed',async _0x106814=>{const _0x31da73=_0x2a4070;logger_1['logger'][_0x31da73(0x8d)]('Job\x20'+_0x106814['id']+'\x20completed');}),_0x808271['on'](_0x2a4070(0xb9),async(_0x1e525b,_0x4348fb)=>{const _0x17cc91=_0x2a4070;logger_1[_0x17cc91(0x7d)]['error'](_0x17cc91(0x89)+_0x1e525b[_0x17cc91(0xa3)]+_0x17cc91(0x79)+_0x4348fb['message']);});}async[a574_0x101aee(0xa1)](){const _0x9188d7=a574_0x101aee;try{const _0x1d4186=await Schedule_1[_0x9188d7(0x76)]['findAll']({'where':{'status':'PENDENTE','sentAt':null,'sendAt':{[sequelize_1['Op']['lte']]:(0x0,moment_1[_0x9188d7(0x76)])()[_0x9188d7(0xb2)](_0x9188d7(0x90))}},'include':[{'model':Contact_1[_0x9188d7(0x76)],'as':_0x9188d7(0x87)}]});return _0x1d4186?.[_0x9188d7(0xa5)]>0x0&&_0x1d4186[_0x9188d7(0x9b)](async _0x33bc28=>{const _0xc9bd1d=_0x9188d7;await _0x33bc28[_0xc9bd1d(0x78)]({'status':_0xc9bd1d(0x8a)}),await this['queue'][_0xc9bd1d(0x9e)](_0xc9bd1d(0x6f),{'schedule':_0x33bc28},{'delay':this[_0xc9bd1d(0x74)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0xc9bd1d(0x7d)][_0xc9bd1d(0x8d)](_0xc9bd1d(0xac)+_0x33bc28[_0xc9bd1d(0x87)][_0xc9bd1d(0xa3)]);}),Promise['resolve']({'count':_0x1d4186[_0x9188d7(0xa5)]});}catch(_0x2a7544){return Sentry[_0x9188d7(0x81)](_0x2a7544),logger_1['logger'][_0x9188d7(0x92)]('SendScheduledMessage\x20->\x20Verify:\x20error',_0x2a7544['message']),Promise['reject'](new sequelize_1[(_0x9188d7(0x8b))](_0x2a7544));}}[a574_0x101aee(0x74)](_0x4f7099,_0x57ca3f){return Math['random']()*(_0x57ca3f-_0x4f7099)+_0x4f7099;}async[a574_0x101aee(0xbb)](_0x531792){const _0x54d812=a574_0x101aee,{data:{schedule:_0x2df5f3}}=_0x531792;let _0x2e3a2d=null;try{_0x2e3a2d=await Schedule_1[_0x54d812(0x76)][_0x54d812(0xa8)](_0x2df5f3['id']);}catch(_0x2bfa8e){Sentry['captureException'](_0x2bfa8e),logger_1[_0x54d812(0x7d)][_0x54d812(0x8d)]('Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20'+_0x2df5f3['id']);}try{if(_0x2e3a2d?.['daysR']!==null){let _0x18c840=(0x0,moment_1[_0x54d812(0x76)])(_0x2e3a2d[_0x54d812(0xa7)]);const _0x365de1=_0x2df5f3[_0x54d812(0xb0)],_0x34223b=await(0x0,GetDefaultWhatsApp_1['default'])(_0x2df5f3[_0x54d812(0xb0)]);let _0x4d5d2f=null;const _0x44f57e=_0x2e3a2d?.[_0x54d812(0x82)];_0x44f57e?Tag_1[_0x54d812(0x76)][_0x54d812(0xa8)](_0x44f57e)[_0x54d812(0xad)](async _0x4b81ef=>{const _0x4888be=_0x54d812;if(_0x4b81ef){let _0x23b02d=_0x18c840[_0x4888be(0x9e)](_0x4b81ef[_0x4888be(0x83)],_0x4888be(0x85))[_0x4888be(0xb2)](_0x4888be(0x72));_0x4b81ef[_0x4888be(0x7f)]&&(await(0x0,SendMessage_1[_0x4888be(0x6f)])(_0x34223b,{'number':_0x2df5f3[_0x4888be(0x87)][_0x4888be(0xaa)],'body':_0x4b81ef['msgR']}),_0x4d5d2f=path_1[_0x4888be(0x76)][_0x4888be(0xb4)](_0x4888be(0x70)+_0x365de1,_0x4b81ef[_0x4888be(0x7f)]),await(0x0,SendMessage_1['SendMessage'])(_0x34223b,{'number':_0x2df5f3['contact']['number'],'body':_0x4b81ef[_0x4888be(0x7a)],'mediaPath':_0x4d5d2f})),_0x4b81ef[_0x4888be(0x83)]===0x0?await _0x2e3a2d?.[_0x4888be(0x78)]({'sentAt':(0x0,moment_1[_0x4888be(0x76)])()[_0x4888be(0xb2)](_0x4888be(0x72)),'status':'ENVIADA'}):await _0x2e3a2d?.['update']({'sendAt':_0x23b02d,'status':_0x4888be(0x75)}),logger_1['logger'][_0x4888be(0x8d)](_0x4888be(0x97)+_0x2df5f3[_0x4888be(0x87)][_0x4888be(0xa3)]+'\x20');}else console[_0x4888be(0x9a)](_0x4888be(0x6e));})['catch'](_0x552bfc=>{const _0x43babc=_0x54d812;console[_0x43babc(0x92)](_0x43babc(0x99),_0x552bfc);}):console['log'](_0x54d812(0x94));}else{const _0x3fb556=await(0x0,GetDefaultWhatsApp_1[_0x54d812(0x76)])(_0x2df5f3[_0x54d812(0xb0)]);let _0xd6855c=null;_0x2df5f3[_0x54d812(0x7f)]&&(_0xd6855c=path_1[_0x54d812(0x76)]['resolve'](_0x54d812(0x70)+_0x2df5f3[_0x54d812(0xb0)],_0x2df5f3[_0x54d812(0x7f)])),await(0x0,SendMessage_1['SendMessage'])(_0x3fb556,{'number':_0x2df5f3[_0x54d812(0x87)][_0x54d812(0xaa)],'body':_0x2df5f3['body'],'mediaPath':_0xd6855c}),await _0x2e3a2d?.[_0x54d812(0x78)]({'sentAt':(0x0,moment_1[_0x54d812(0x76)])()['format'](_0x54d812(0x72)),'status':_0x54d812(0xb6)}),logger_1[_0x54d812(0x7d)][_0x54d812(0x8d)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x2df5f3[_0x54d812(0x87)][_0x54d812(0xa3)]);}}catch(_0x2e1d35){Sentry['captureException'](_0x2e1d35),await _0x2e3a2d?.['update']({'status':_0x54d812(0xb5)}),logger_1[_0x54d812(0x7d)]['error'](_0x54d812(0x80),_0x2e1d35[_0x54d812(0xab)]);throw _0x2e1d35;}}}exports[a574_0x101aee(0x76)]=ScheduledMessageJob;