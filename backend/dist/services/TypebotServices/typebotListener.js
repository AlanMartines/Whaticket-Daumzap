const a530_0x53bdad=a530_0x1bab;(function(_0x5cdd47,_0x1221ce){const _0x2bd52d=a530_0x1bab,_0x33577c=_0x5cdd47();while(!![]){try{const _0x12c7af=-parseInt(_0x2bd52d(0xea))/0x1+-parseInt(_0x2bd52d(0xd8))/0x2+parseInt(_0x2bd52d(0x105))/0x3+-parseInt(_0x2bd52d(0x109))/0x4*(parseInt(_0x2bd52d(0xf5))/0x5)+-parseInt(_0x2bd52d(0xee))/0x6+-parseInt(_0x2bd52d(0xe9))/0x7*(-parseInt(_0x2bd52d(0xd4))/0x8)+parseInt(_0x2bd52d(0x108))/0x9;if(_0x12c7af===_0x1221ce)break;else _0x33577c['push'](_0x33577c['shift']());}catch(_0x3399aa){_0x33577c['push'](_0x33577c['shift']());}}}(a530_0x1db5,0xd87e6));function a530_0x1db5(){const _0x364c95=['contact','3108080zvpUEg','stopBot','lodash','content','164176cXwbtK','choice\x20input','Error\x20on\x20typebotListener:\x20','reload','companyId','messages','underline','/startChat','__esModule','search','sendMessage','pushName','request','update','children','▶️\x20','application/json','7ALYGaa','478253Hrnjlt','audio','typebotStatus','SendPresenceStatus','2907186AvSKwP','logger','url','toString','constructor','../../utils/logger','length','7775755jRMVgd','type','default','../../helpers/SendPresenceStatus','stringify','post','@c.us','isNil','bold','string','key','Invalid\x20message.\x20Please,\x20try\x20again.','../TicketServices/UpdateTicketService','parse','userId','../WbotServices/wbotMessageListener','3890712uTYfAj','/api/v1/typebots/','queueId','16212303ZeReco','4lWHcOT','sessionId','defineProperty','status@broadcast','text','updatedAt','/continueChat','typebotSessionId','closed','replace','italic','info','data','remoteJid','audio/mp4'];a530_0x1db5=function(){return _0x364c95;};return a530_0x1db5();}const a530_0x5a3d53=(function(){let _0x379aae=!![];return function(_0x341140,_0x49cd2f){const _0x2b1a8b=_0x379aae?function(){if(_0x49cd2f){const _0x2280e2=_0x49cd2f['apply'](_0x341140,arguments);return _0x49cd2f=null,_0x2280e2;}}:function(){};return _0x379aae=![],_0x2b1a8b;};}()),a530_0x5c003c=a530_0x5a3d53(this,function(){const _0x4c8ac5=a530_0x1bab;return a530_0x5c003c[_0x4c8ac5(0xf1)]()[_0x4c8ac5(0xe1)]('(((.+)+)+)+$')[_0x4c8ac5(0xf1)]()[_0x4c8ac5(0xf2)](a530_0x5c003c)[_0x4c8ac5(0xe1)]('(((.+)+)+)+$');});a530_0x5c003c();function a530_0x1bab(_0x2b1778,_0x3607da){const _0x48b3f9=a530_0x1db5();return a530_0x1bab=function(_0x5c003c,_0x5a3d53){_0x5c003c=_0x5c003c-0xc6;let _0x1db54f=_0x48b3f9[_0x5c003c];return _0x1db54f;},a530_0x1bab(_0x2b1778,_0x3607da);}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x56268c){const _0x3ad8b8=a530_0x1bab;return _0x56268c&&_0x56268c[_0x3ad8b8(0xe0)]?_0x56268c:{'default':_0x56268c};};Object[a530_0x53bdad(0xc6)](exports,'__esModule',{'value':!![]});const axios_1=__importDefault(require('axios')),wbotMessageListener_1=require(a530_0x53bdad(0x104)),logger_1=require(a530_0x53bdad(0xf3)),lodash_1=require(a530_0x53bdad(0xd6)),UpdateTicketService_1=__importDefault(require(a530_0x53bdad(0x101))),SendPresenceStatus_1=require(a530_0x53bdad(0xf8)),typebotListener=async({wbot:_0x58dafc,msg:_0x4a527a,ticket:_0x3b0096,typebot:_0x35db5d})=>{const _0xcd9f91=a530_0x53bdad;if(_0x4a527a['key'][_0xcd9f91(0xd1)]===_0xcd9f91(0xc7))return;const {urlN8N:_0x434072,typebotExpires:_0x2d1934,typebotKeywordFinish:_0x1bdf11,typebotKeywordRestart:_0x8e662f,typebotUnknownMessage:_0x45508b,typebotSlug:_0x18d31b,typebotDelayMessage:_0x15826f,typebotRestartMessage:_0x4b84f0}=_0x35db5d,_0x1423bf=_0x4a527a[_0xcd9f91(0xff)]['remoteJid'][_0xcd9f91(0xcd)](/\D/g,'');let _0x128cc0=(0x0,wbotMessageListener_1['getBodyMessage'])(_0x4a527a);async function _0x4c8bac(_0x513ee5,_0x5e8b6e,_0x22db18){const _0x51d7db=_0xcd9f91;try{const _0x58e0cc=JSON[_0x51d7db(0xf9)]({'isStreamEnabled':!![],'message':_0x51d7db(0xfe),'resultId':_0x51d7db(0xfe),'isOnlyRegistering':![],'prefilledVariables':{'number':_0x22db18,'pushName':_0x513ee5[_0x51d7db(0xe3)]||'','remoteJid':_0x3b0096?.[_0x51d7db(0xd3)]?.['remoteJid']}}),_0x5a0ec8={'method':'post','maxBodyLength':Infinity,'url':_0x434072+_0x51d7db(0x106)+_0x18d31b+_0x51d7db(0xdf),'headers':{'Content-Type':_0x51d7db(0xe8),'Accept':_0x51d7db(0xe8)},'data':_0x58e0cc},_0x3c9c12=await axios_1[_0x51d7db(0xf7)][_0x51d7db(0xe4)](_0x5a0ec8);return _0x3c9c12['data'];}catch(_0x31f69f){logger_1[_0x51d7db(0xef)][_0x51d7db(0xcf)]('Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20',_0x31f69f);throw _0x31f69f;}}let _0x37f7f4,_0x1be86a,_0x1094ec=![];try{const _0x3e44da=new Date();_0x3e44da['setMinutes'](_0x3e44da['getMinutes']()-Number(_0x2d1934));_0x2d1934>0x0&&_0x3b0096[_0xcd9f91(0xc9)]<_0x3e44da&&(await _0x3b0096[_0xcd9f91(0xe5)]({'typebotSessionId':null,'chatbot':!![]}),await _0x3b0096[_0xcd9f91(0xdb)]());!_0x3b0096[_0xcd9f91(0xcb)]?(_0x1be86a=await _0x4c8bac(_0x4a527a,_0x35db5d,_0x1423bf),_0x37f7f4=_0x1be86a[_0xcd9f91(0x10a)],_0x1094ec=!![],await _0x3b0096[_0xcd9f91(0xe5)]({'typebotSessionId':_0x37f7f4,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x35db5d['id']}),await _0x3b0096[_0xcd9f91(0xdb)]()):(_0x37f7f4=_0x3b0096[_0xcd9f91(0xcb)],_0x1094ec=_0x3b0096[_0xcd9f91(0xec)]);if(!_0x1094ec)return;;if(_0x128cc0!==_0x1bdf11&&_0x128cc0!==_0x8e662f){let _0x3ba1c9,_0x3c957b,_0x372a0a;if(_0x1be86a?.[_0xcd9f91(0xdd)][_0xcd9f91(0xf4)]===0x0||_0x1be86a===undefined){const _0x487cf4=JSON['stringify']({'message':_0x128cc0});let _0x2f4c33={'method':_0xcd9f91(0xfa),'maxBodyLength':Infinity,'url':_0x434072+'/api/v1/sessions/'+_0x37f7f4+_0xcd9f91(0xca),'headers':{'Content-Type':_0xcd9f91(0xe8),'Accept':_0xcd9f91(0xe8)},'data':_0x487cf4};_0x3ba1c9=await axios_1[_0xcd9f91(0xf7)]['request'](_0x2f4c33),_0x3c957b=_0x3ba1c9[_0xcd9f91(0xd0)]?.['messages'],_0x372a0a=_0x3ba1c9[_0xcd9f91(0xd0)]?.['input'];}else _0x3c957b=_0x1be86a?.[_0xcd9f91(0xdd)],_0x372a0a=_0x1be86a?.['input'];if(_0x3c957b?.[_0xcd9f91(0xf4)]===0x0)await _0x58dafc['sendMessage'](_0x1423bf+_0xcd9f91(0xfb),{'text':_0x45508b});else{for(const _0x149197 of _0x3c957b){if(_0x149197[_0xcd9f91(0xf6)]===_0xcd9f91(0xc8)){let _0x15991a='',_0x41e6f2=![];for(const _0x5dc5d3 of _0x149197[_0xcd9f91(0xd7)]['richText']){for(const _0x3f6630 of _0x5dc5d3[_0xcd9f91(0xe6)]){let _0x38ad1b='';_0x3f6630[_0xcd9f91(0xc8)]&&(_0x38ad1b=_0x3f6630[_0xcd9f91(0xc8)]);if(_0x3f6630[_0xcd9f91(0xf6)]&&_0x3f6630[_0xcd9f91(0xe6)])for(const _0x46788f of _0x3f6630[_0xcd9f91(0xe6)]){let _0x42b540='';_0x46788f[_0xcd9f91(0xc8)]&&(_0x42b540=_0x46788f[_0xcd9f91(0xc8)]);if(_0x46788f[_0xcd9f91(0xf6)]&&_0x46788f['children'])for(const _0x34c22e of _0x46788f[_0xcd9f91(0xe6)]){let _0xdf0f30='';_0x34c22e[_0xcd9f91(0xc8)]&&(_0xdf0f30=_0x34c22e['text']);_0x34c22e[_0xcd9f91(0xfd)]&&(_0xdf0f30='*'+_0xdf0f30+'*');_0x34c22e[_0xcd9f91(0xce)]&&(_0xdf0f30='_'+_0xdf0f30+'_');_0x34c22e[_0xcd9f91(0xde)]&&(_0xdf0f30='~'+_0xdf0f30+'~');if(_0x34c22e[_0xcd9f91(0xf0)]){const _0x269c5f=_0x34c22e[_0xcd9f91(0xe6)][0x0][_0xcd9f91(0xc8)];_0xdf0f30='['+_0x269c5f+']('+_0x34c22e['url']+')',_0x41e6f2=!![];}_0x15991a+=_0xdf0f30;}_0x46788f[_0xcd9f91(0xfd)]&&(_0x42b540='*'+_0x42b540+'*');_0x46788f[_0xcd9f91(0xce)]&&(_0x42b540='_'+_0x42b540+'_');_0x46788f[_0xcd9f91(0xde)]&&(_0x42b540='~'+_0x42b540+'~');if(_0x46788f[_0xcd9f91(0xf0)]){const _0x42c9d0=_0x46788f[_0xcd9f91(0xe6)][0x0][_0xcd9f91(0xc8)];_0x42b540='['+_0x42c9d0+']('+_0x46788f[_0xcd9f91(0xf0)]+')',_0x41e6f2=!![];}_0x15991a+=_0x42b540;}_0x3f6630['bold']&&(_0x38ad1b='*'+_0x38ad1b+'*');_0x3f6630[_0xcd9f91(0xce)]&&(_0x38ad1b='_'+_0x38ad1b+'_');_0x3f6630[_0xcd9f91(0xde)]&&(_0x38ad1b='~'+_0x38ad1b+'~');if(_0x3f6630[_0xcd9f91(0xf0)]){const _0x2303d8=_0x3f6630['children'][0x0][_0xcd9f91(0xc8)];_0x38ad1b='['+_0x2303d8+']('+_0x3f6630['url']+')',_0x41e6f2=!![];}_0x15991a+=_0x38ad1b;}_0x15991a+='\x0a';}_0x15991a=_0x15991a[_0xcd9f91(0xcd)]('**','')[_0xcd9f91(0xcd)](/\n$/,'');_0x15991a===_0xcd9f91(0x100)&&(_0x15991a=_0x45508b);if(_0x15991a['startsWith']('#')){let _0x137159=_0x15991a[_0xcd9f91(0xcd)]('#','');try{let _0x2ae2d0=JSON[_0xcd9f91(0x102)](_0x137159);if(_0x2ae2d0[_0xcd9f91(0xd5)]&&(0x0,lodash_1[_0xcd9f91(0xfc)])(_0x2ae2d0['userId'])&&(0x0,lodash_1[_0xcd9f91(0xfc)])(_0x2ae2d0[_0xcd9f91(0x107)])){await _0x3b0096[_0xcd9f91(0xe5)]({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1['isNil'])(_0x2ae2d0[_0xcd9f91(0x107)])&&_0x2ae2d0[_0xcd9f91(0x107)]>0x0&&(0x0,lodash_1[_0xcd9f91(0xfc)])(_0x2ae2d0[_0xcd9f91(0x103)])){await(0x0,UpdateTicketService_1[_0xcd9f91(0xf7)])({'ticketData':{'queueId':_0x2ae2d0[_0xcd9f91(0x107)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x3b0096['id'],'companyId':_0x3b0096[_0xcd9f91(0xdc)]});return;}if(!(0x0,lodash_1[_0xcd9f91(0xfc)])(_0x2ae2d0['queueId'])&&_0x2ae2d0[_0xcd9f91(0x107)]>0x0&&!(0x0,lodash_1['isNil'])(_0x2ae2d0[_0xcd9f91(0x103)])&&_0x2ae2d0[_0xcd9f91(0x103)]>0x0){await(0x0,UpdateTicketService_1[_0xcd9f91(0xf7)])({'ticketData':{'queueId':_0x2ae2d0[_0xcd9f91(0x107)],'userId':_0x2ae2d0[_0xcd9f91(0x103)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x3b0096['id'],'companyId':_0x3b0096[_0xcd9f91(0xdc)]});return;}}catch(_0x6265a1){throw _0x6265a1;}}await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x58dafc,_0x4a527a[_0xcd9f91(0xff)][_0xcd9f91(0xd1)],_0x15826f),await _0x58dafc[_0xcd9f91(0xe2)](_0x4a527a[_0xcd9f91(0xff)][_0xcd9f91(0xd1)],{'text':_0x15991a});}if(_0x149197[_0xcd9f91(0xf6)]===_0xcd9f91(0xeb)){await(0x0,SendPresenceStatus_1[_0xcd9f91(0xed)])(_0x58dafc,_0x4a527a[_0xcd9f91(0xff)][_0xcd9f91(0xd1)],_0x15826f);const _0x337b30={'audio':{'url':_0x149197[_0xcd9f91(0xd7)][_0xcd9f91(0xf0)],'mimetype':_0xcd9f91(0xd2),'ptt':!![]}};await _0x58dafc[_0xcd9f91(0xe2)](_0x4a527a['key'][_0xcd9f91(0xd1)],_0x337b30);}if(_0x149197[_0xcd9f91(0xf6)]==='image'){await(0x0,SendPresenceStatus_1[_0xcd9f91(0xed)])(_0x58dafc,_0x4a527a[_0xcd9f91(0xff)][_0xcd9f91(0xd1)],_0x15826f);const _0x65353={'image':{'url':_0x149197[_0xcd9f91(0xd7)][_0xcd9f91(0xf0)]}};await _0x58dafc[_0xcd9f91(0xe2)](_0x4a527a['key'][_0xcd9f91(0xd1)],_0x65353);}}if(_0x372a0a){if(_0x372a0a[_0xcd9f91(0xf6)]===_0xcd9f91(0xd9)){let _0x9855da='';const _0x516115=_0x372a0a['items'];for(const _0x37d329 of _0x516115){_0x9855da+=_0xcd9f91(0xe7)+_0x37d329[_0xcd9f91(0xd7)]+'\x0a';}_0x9855da=_0x9855da['replace'](/\n$/,''),await(0x0,SendPresenceStatus_1[_0xcd9f91(0xed)])(_0x58dafc,_0x4a527a[_0xcd9f91(0xff)][_0xcd9f91(0xd1)],_0x15826f),await _0x58dafc[_0xcd9f91(0xe2)](_0x4a527a[_0xcd9f91(0xff)][_0xcd9f91(0xd1)],{'text':_0x9855da});}}}}_0x128cc0===_0x8e662f&&(await _0x3b0096[_0xcd9f91(0xe5)]({'chatbot':!![],'typebotSessionId':null}),await _0x3b0096['reload'](),await _0x58dafc[_0xcd9f91(0xe2)](_0x1423bf+_0xcd9f91(0xfb),{'text':_0x4b84f0}));if(_0x128cc0===_0x1bdf11){await(0x0,UpdateTicketService_1[_0xcd9f91(0xf7)])({'ticketData':{'status':_0xcd9f91(0xcc),'useIntegration':![],'integrationId':null},'ticketId':_0x3b0096['id'],'companyId':_0x3b0096[_0xcd9f91(0xdc)]});return;}}catch(_0x5a0d0b){logger_1[_0xcd9f91(0xef)][_0xcd9f91(0xcf)](_0xcd9f91(0xda),_0x5a0d0b),await _0x3b0096['update']({'typebotSessionId':null});}};exports[a530_0x53bdad(0xf7)]=typebotListener;