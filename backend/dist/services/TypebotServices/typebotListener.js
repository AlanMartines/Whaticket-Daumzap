const a530_0x259e8d=a530_0x3fed;(function(_0x3dc028,_0x42c405){const _0x41c7af=a530_0x3fed,_0x5eec5b=_0x3dc028();while(!![]){try{const _0x1f9038=-parseInt(_0x41c7af(0xe0))/0x1*(-parseInt(_0x41c7af(0xf4))/0x2)+parseInt(_0x41c7af(0xd8))/0x3*(parseInt(_0x41c7af(0xe5))/0x4)+-parseInt(_0x41c7af(0xd5))/0x5*(parseInt(_0x41c7af(0xc8))/0x6)+parseInt(_0x41c7af(0xf9))/0x7*(parseInt(_0x41c7af(0x109))/0x8)+-parseInt(_0x41c7af(0xc3))/0x9*(parseInt(_0x41c7af(0xee))/0xa)+-parseInt(_0x41c7af(0xd0))/0xb*(-parseInt(_0x41c7af(0xda))/0xc)+-parseInt(_0x41c7af(0xed))/0xd;if(_0x1f9038===_0x42c405)break;else _0x5eec5b['push'](_0x5eec5b['shift']());}catch(_0x190e26){_0x5eec5b['push'](_0x5eec5b['shift']());}}}(a530_0x2edd,0xef1f3));const a530_0x48c836=(function(){let _0xb86df8=!![];return function(_0x2b29d1,_0x56866a){const _0x366317=_0xb86df8?function(){if(_0x56866a){const _0x1e0cee=_0x56866a['apply'](_0x2b29d1,arguments);return _0x56866a=null,_0x1e0cee;}}:function(){};return _0xb86df8=![],_0x366317;};}()),a530_0x3a111f=a530_0x48c836(this,function(){const _0x40116a=a530_0x3fed;return a530_0x3a111f[_0x40116a(0xcb)]()[_0x40116a(0xfb)]('(((.+)+)+)+$')['toString']()[_0x40116a(0xe9)](a530_0x3a111f)['search'](_0x40116a(0xfc));});function a530_0x2edd(){const _0x2b207e=['key','/api/v1/sessions/','Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20','url','pushName','32HUQIIT','contact','__importDefault','7765551SfKzMZ','defineProperty','application/json','text','parse','1974yfweUx','updatedAt','type','toString','▶️\x20','logger','audio/mp4','data','2407746sKjBFd','underline','audio','default','userId','8430zdnron','queueId','content','5074683GcqzLQ','../../helpers/SendPresenceStatus','96DKCyBt','italic','replace','/continueChat','children','remoteJid','10193OQMsqs','companyId','setMinutes','sessionId','string','4jjZNrM','isNil','closed','messages','constructor','../../utils/logger','@c.us','__esModule','48654736AEwAGu','10qNcuzB','/startChat','SendPresenceStatus','getMinutes','typebotSessionId','getBodyMessage','214AoLTEA','typebotStatus','axios','request','post','2811109swEpFW','sendMessage','search','(((.+)+)+)+$','info','update','length','reload','stopBot','stringify','input'];a530_0x2edd=function(){return _0x2b207e;};return a530_0x2edd();}a530_0x3a111f();'use strict';function a530_0x3fed(_0xa4e280,_0x547b17){const _0x5141d1=a530_0x2edd();return a530_0x3fed=function(_0x3a111f,_0x48c836){_0x3a111f=_0x3a111f-0xc1;let _0x2edd75=_0x5141d1[_0x3a111f];return _0x2edd75;},a530_0x3fed(_0xa4e280,_0x547b17);}var __importDefault=this&&this[a530_0x259e8d(0xc2)]||function(_0x5384b7){const _0x5ce54c=a530_0x259e8d;return _0x5384b7&&_0x5384b7[_0x5ce54c(0xec)]?_0x5384b7:{'default':_0x5384b7};};Object[a530_0x259e8d(0xc4)](exports,a530_0x259e8d(0xec),{'value':!![]});const axios_1=__importDefault(require(a530_0x259e8d(0xf6))),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),logger_1=require(a530_0x259e8d(0xea)),lodash_1=require('lodash'),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),SendPresenceStatus_1=require(a530_0x259e8d(0xd9)),typebotListener=async({wbot:_0x2867f4,msg:_0x1ed9b0,ticket:_0x24e372,typebot:_0x4db452})=>{const _0x4e4864=a530_0x259e8d;if(_0x1ed9b0['key']['remoteJid']==='status@broadcast')return;const {urlN8N:_0x464238,typebotExpires:_0x1b7208,typebotKeywordFinish:_0x2efdba,typebotKeywordRestart:_0x23741e,typebotUnknownMessage:_0x96f342,typebotSlug:_0x503ccb,typebotDelayMessage:_0x43d665,typebotRestartMessage:_0x5ded90}=_0x4db452,_0x45c8e3=_0x1ed9b0[_0x4e4864(0x104)]['remoteJid']['replace'](/\D/g,'');let _0x24b1bf=(0x0,wbotMessageListener_1[_0x4e4864(0xf3)])(_0x1ed9b0);async function _0x570d06(_0x61901a,_0x4fbf91,_0x53ce5c){const _0x14b3ac=_0x4e4864;try{const _0x4edb53=JSON[_0x14b3ac(0x102)]({'isStreamEnabled':!![],'message':_0x14b3ac(0xe4),'resultId':_0x14b3ac(0xe4),'isOnlyRegistering':![],'prefilledVariables':{'number':_0x53ce5c,'pushName':_0x61901a[_0x14b3ac(0x108)]||'','remoteJid':_0x24e372?.[_0x14b3ac(0xc1)]?.[_0x14b3ac(0xdf)]}}),_0x1c12f7={'method':_0x14b3ac(0xf8),'maxBodyLength':Infinity,'url':_0x464238+'/api/v1/typebots/'+_0x503ccb+_0x14b3ac(0xef),'headers':{'Content-Type':_0x14b3ac(0xc5),'Accept':_0x14b3ac(0xc5)},'data':_0x4edb53},_0x3adec7=await axios_1[_0x14b3ac(0xd3)][_0x14b3ac(0xf7)](_0x1c12f7);return _0x3adec7[_0x14b3ac(0xcf)];}catch(_0x16fcf1){logger_1[_0x14b3ac(0xcd)][_0x14b3ac(0xfd)](_0x14b3ac(0x106),_0x16fcf1);throw _0x16fcf1;}}let _0x321566,_0x2b7a40,_0x15b2cb=![];try{const _0x29b71a=new Date();_0x29b71a[_0x4e4864(0xe2)](_0x29b71a[_0x4e4864(0xf1)]()-Number(_0x1b7208));_0x1b7208>0x0&&_0x24e372[_0x4e4864(0xc9)]<_0x29b71a&&(await _0x24e372[_0x4e4864(0xfe)]({'typebotSessionId':null,'chatbot':!![]}),await _0x24e372[_0x4e4864(0x100)]());!_0x24e372[_0x4e4864(0xf2)]?(_0x2b7a40=await _0x570d06(_0x1ed9b0,_0x4db452,_0x45c8e3),_0x321566=_0x2b7a40[_0x4e4864(0xe3)],_0x15b2cb=!![],await _0x24e372[_0x4e4864(0xfe)]({'typebotSessionId':_0x321566,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x4db452['id']}),await _0x24e372[_0x4e4864(0x100)]()):(_0x321566=_0x24e372[_0x4e4864(0xf2)],_0x15b2cb=_0x24e372[_0x4e4864(0xf5)]);if(!_0x15b2cb)return;;if(_0x24b1bf!==_0x2efdba&&_0x24b1bf!==_0x23741e){let _0x12b199,_0x1e99b3,_0xb7cbef;if(_0x2b7a40?.[_0x4e4864(0xe8)]['length']===0x0||_0x2b7a40===undefined){const _0x26c859=JSON[_0x4e4864(0x102)]({'message':_0x24b1bf});let _0x42395a={'method':'post','maxBodyLength':Infinity,'url':_0x464238+_0x4e4864(0x105)+_0x321566+_0x4e4864(0xdd),'headers':{'Content-Type':'application/json','Accept':_0x4e4864(0xc5)},'data':_0x26c859};_0x12b199=await axios_1['default']['request'](_0x42395a),_0x1e99b3=_0x12b199[_0x4e4864(0xcf)]?.[_0x4e4864(0xe8)],_0xb7cbef=_0x12b199[_0x4e4864(0xcf)]?.['input'];}else _0x1e99b3=_0x2b7a40?.[_0x4e4864(0xe8)],_0xb7cbef=_0x2b7a40?.[_0x4e4864(0x103)];if(_0x1e99b3?.[_0x4e4864(0xff)]===0x0)await _0x2867f4['sendMessage'](_0x45c8e3+_0x4e4864(0xeb),{'text':_0x96f342});else{for(const _0x46b41c of _0x1e99b3){if(_0x46b41c[_0x4e4864(0xca)]==='text'){let _0x83b135='',_0x45bdbe=![];for(const _0x114361 of _0x46b41c[_0x4e4864(0xd7)]['richText']){for(const _0x372513 of _0x114361[_0x4e4864(0xde)]){let _0x56cf35='';_0x372513[_0x4e4864(0xc6)]&&(_0x56cf35=_0x372513[_0x4e4864(0xc6)]);if(_0x372513[_0x4e4864(0xca)]&&_0x372513[_0x4e4864(0xde)])for(const _0x403dfc of _0x372513[_0x4e4864(0xde)]){let _0x45fe18='';_0x403dfc[_0x4e4864(0xc6)]&&(_0x45fe18=_0x403dfc[_0x4e4864(0xc6)]);if(_0x403dfc[_0x4e4864(0xca)]&&_0x403dfc[_0x4e4864(0xde)])for(const _0x34c4e1 of _0x403dfc[_0x4e4864(0xde)]){let _0xe0551='';_0x34c4e1['text']&&(_0xe0551=_0x34c4e1['text']);_0x34c4e1['bold']&&(_0xe0551='*'+_0xe0551+'*');_0x34c4e1[_0x4e4864(0xdb)]&&(_0xe0551='_'+_0xe0551+'_');_0x34c4e1[_0x4e4864(0xd1)]&&(_0xe0551='~'+_0xe0551+'~');if(_0x34c4e1['url']){const _0x3184f0=_0x34c4e1['children'][0x0]['text'];_0xe0551='['+_0x3184f0+']('+_0x34c4e1[_0x4e4864(0x107)]+')',_0x45bdbe=!![];}_0x83b135+=_0xe0551;}_0x403dfc['bold']&&(_0x45fe18='*'+_0x45fe18+'*');_0x403dfc[_0x4e4864(0xdb)]&&(_0x45fe18='_'+_0x45fe18+'_');_0x403dfc[_0x4e4864(0xd1)]&&(_0x45fe18='~'+_0x45fe18+'~');if(_0x403dfc[_0x4e4864(0x107)]){const _0x4a6495=_0x403dfc[_0x4e4864(0xde)][0x0][_0x4e4864(0xc6)];_0x45fe18='['+_0x4a6495+']('+_0x403dfc[_0x4e4864(0x107)]+')',_0x45bdbe=!![];}_0x83b135+=_0x45fe18;}_0x372513['bold']&&(_0x56cf35='*'+_0x56cf35+'*');_0x372513[_0x4e4864(0xdb)]&&(_0x56cf35='_'+_0x56cf35+'_');_0x372513[_0x4e4864(0xd1)]&&(_0x56cf35='~'+_0x56cf35+'~');if(_0x372513['url']){const _0x1dbea2=_0x372513[_0x4e4864(0xde)][0x0][_0x4e4864(0xc6)];_0x56cf35='['+_0x1dbea2+']('+_0x372513[_0x4e4864(0x107)]+')',_0x45bdbe=!![];}_0x83b135+=_0x56cf35;}_0x83b135+='\x0a';}_0x83b135=_0x83b135[_0x4e4864(0xdc)]('**','')[_0x4e4864(0xdc)](/\n$/,'');_0x83b135==='Invalid\x20message.\x20Please,\x20try\x20again.'&&(_0x83b135=_0x96f342);if(_0x83b135['startsWith']('#')){let _0x231fb2=_0x83b135['replace']('#','');try{let _0x1ac48a=JSON[_0x4e4864(0xc7)](_0x231fb2);if(_0x1ac48a[_0x4e4864(0x101)]&&(0x0,lodash_1[_0x4e4864(0xe6)])(_0x1ac48a[_0x4e4864(0xd4)])&&(0x0,lodash_1['isNil'])(_0x1ac48a[_0x4e4864(0xd6)])){await _0x24e372[_0x4e4864(0xfe)]({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1[_0x4e4864(0xe6)])(_0x1ac48a[_0x4e4864(0xd6)])&&_0x1ac48a[_0x4e4864(0xd6)]>0x0&&(0x0,lodash_1[_0x4e4864(0xe6)])(_0x1ac48a[_0x4e4864(0xd4)])){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x1ac48a['queueId'],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x24e372['id'],'companyId':_0x24e372[_0x4e4864(0xe1)]});return;}if(!(0x0,lodash_1[_0x4e4864(0xe6)])(_0x1ac48a['queueId'])&&_0x1ac48a['queueId']>0x0&&!(0x0,lodash_1[_0x4e4864(0xe6)])(_0x1ac48a[_0x4e4864(0xd4)])&&_0x1ac48a[_0x4e4864(0xd4)]>0x0){await(0x0,UpdateTicketService_1[_0x4e4864(0xd3)])({'ticketData':{'queueId':_0x1ac48a[_0x4e4864(0xd6)],'userId':_0x1ac48a[_0x4e4864(0xd4)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x24e372['id'],'companyId':_0x24e372[_0x4e4864(0xe1)]});return;}}catch(_0x4cf5f6){throw _0x4cf5f6;}}await(0x0,SendPresenceStatus_1[_0x4e4864(0xf0)])(_0x2867f4,_0x1ed9b0[_0x4e4864(0x104)][_0x4e4864(0xdf)],_0x43d665),await _0x2867f4[_0x4e4864(0xfa)](_0x1ed9b0[_0x4e4864(0x104)]['remoteJid'],{'text':_0x83b135});}if(_0x46b41c[_0x4e4864(0xca)]===_0x4e4864(0xd2)){await(0x0,SendPresenceStatus_1[_0x4e4864(0xf0)])(_0x2867f4,_0x1ed9b0[_0x4e4864(0x104)]['remoteJid'],_0x43d665);const _0x53d7f4={'audio':{'url':_0x46b41c[_0x4e4864(0xd7)][_0x4e4864(0x107)],'mimetype':_0x4e4864(0xce),'ptt':!![]}};await _0x2867f4[_0x4e4864(0xfa)](_0x1ed9b0[_0x4e4864(0x104)][_0x4e4864(0xdf)],_0x53d7f4);}if(_0x46b41c[_0x4e4864(0xca)]==='image'){await(0x0,SendPresenceStatus_1[_0x4e4864(0xf0)])(_0x2867f4,_0x1ed9b0['key'][_0x4e4864(0xdf)],_0x43d665);const _0x51820d={'image':{'url':_0x46b41c[_0x4e4864(0xd7)][_0x4e4864(0x107)]}};await _0x2867f4[_0x4e4864(0xfa)](_0x1ed9b0[_0x4e4864(0x104)][_0x4e4864(0xdf)],_0x51820d);}}if(_0xb7cbef){if(_0xb7cbef[_0x4e4864(0xca)]==='choice\x20input'){let _0x465dbb='';const _0x3cdb9d=_0xb7cbef['items'];for(const _0x476cb3 of _0x3cdb9d){_0x465dbb+=_0x4e4864(0xcc)+_0x476cb3[_0x4e4864(0xd7)]+'\x0a';}_0x465dbb=_0x465dbb[_0x4e4864(0xdc)](/\n$/,''),await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x2867f4,_0x1ed9b0[_0x4e4864(0x104)][_0x4e4864(0xdf)],_0x43d665),await _0x2867f4['sendMessage'](_0x1ed9b0['key']['remoteJid'],{'text':_0x465dbb});}}}}_0x24b1bf===_0x23741e&&(await _0x24e372[_0x4e4864(0xfe)]({'chatbot':!![],'typebotSessionId':null}),await _0x24e372['reload'](),await _0x2867f4[_0x4e4864(0xfa)](_0x45c8e3+'@c.us',{'text':_0x5ded90}));if(_0x24b1bf===_0x2efdba){await(0x0,UpdateTicketService_1[_0x4e4864(0xd3)])({'ticketData':{'status':_0x4e4864(0xe7),'useIntegration':![],'integrationId':null},'ticketId':_0x24e372['id'],'companyId':_0x24e372[_0x4e4864(0xe1)]});return;}}catch(_0x252f96){logger_1['logger']['info']('Error\x20on\x20typebotListener:\x20',_0x252f96),await _0x24e372['update']({'typebotSessionId':null});}};exports[a530_0x259e8d(0xd3)]=typebotListener;