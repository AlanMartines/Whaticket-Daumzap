const a530_0x515f7a=a530_0x1a03;function a530_0x1a03(_0x49e7a1,_0x1eb597){const _0x136fed=a530_0x50b2();return a530_0x1a03=function(_0x2f1674,_0x5a718d){_0x2f1674=_0x2f1674-0x1b3;let _0x50b20a=_0x136fed[_0x2f1674];return _0x50b20a;},a530_0x1a03(_0x49e7a1,_0x1eb597);}(function(_0x2ec16d,_0x3e0f3d){const _0x2f3674=a530_0x1a03,_0x263961=_0x2ec16d();while(!![]){try{const _0x34cf96=parseInt(_0x2f3674(0x1b4))/0x1+parseInt(_0x2f3674(0x1bf))/0x2+-parseInt(_0x2f3674(0x1bb))/0x3+parseInt(_0x2f3674(0x1de))/0x4*(-parseInt(_0x2f3674(0x1ed))/0x5)+-parseInt(_0x2f3674(0x1d3))/0x6*(parseInt(_0x2f3674(0x1c3))/0x7)+parseInt(_0x2f3674(0x1bd))/0x8+-parseInt(_0x2f3674(0x1cd))/0x9;if(_0x34cf96===_0x3e0f3d)break;else _0x263961['push'](_0x263961['shift']());}catch(_0x336f10){_0x263961['push'](_0x263961['shift']());}}}(a530_0x50b2,0xdc110));const a530_0x5a718d=(function(){let _0x344ca4=!![];return function(_0x5b62d1,_0x11c8eb){const _0x133c53=_0x344ca4?function(){const _0x20d602=a530_0x1a03;if(_0x11c8eb){const _0x571eef=_0x11c8eb[_0x20d602(0x1e1)](_0x5b62d1,arguments);return _0x11c8eb=null,_0x571eef;}}:function(){};return _0x344ca4=![],_0x133c53;};}()),a530_0x2f1674=a530_0x5a718d(this,function(){const _0x428b9c=a530_0x1a03;return a530_0x2f1674[_0x428b9c(0x1d9)]()[_0x428b9c(0x1d8)](_0x428b9c(0x1b7))[_0x428b9c(0x1d9)]()['constructor'](a530_0x2f1674)[_0x428b9c(0x1d8)](_0x428b9c(0x1b7));});a530_0x2f1674();'use strict';var __importDefault=this&&this[a530_0x515f7a(0x1e2)]||function(_0x14938b){const _0x567b5a=a530_0x515f7a;return _0x14938b&&_0x14938b[_0x567b5a(0x1be)]?_0x14938b:{'default':_0x14938b};};function a530_0x50b2(){const _0x1ae86a=['stopBot','children','request','axios','string','data','richText','status@broadcast','80qubrJI','reload','items','../../helpers/SendPresenceStatus','sessionId','text','sendMessage','pushName','default','getMinutes','url','1411797kRfoVs','stringify','info','(((.+)+)+)+$','SendPresenceStatus','updatedAt','post','4341630JqNJhX','messages','13643360enzewy','__esModule','983854KDwcdk','getBodyMessage','companyId','logger','1108975aLvDZk','userId','lodash','setMinutes','italic','/api/v1/sessions/','replace','Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20','queueId','update','454599JGPyXG','content','bold','key','isNil','application/json','42tvyIya','type','choice\x20input','input','image','search','toString','@c.us','startsWith','closed','▶️\x20','25264AkbclJ','remoteJid','underline','apply','__importDefault','length','Error\x20on\x20typebotListener:\x20'];a530_0x50b2=function(){return _0x1ae86a;};return a530_0x50b2();}Object['defineProperty'](exports,'__esModule',{'value':!![]});const axios_1=__importDefault(require(a530_0x515f7a(0x1e8))),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),logger_1=require('../../utils/logger'),lodash_1=require(a530_0x515f7a(0x1c5)),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),SendPresenceStatus_1=require(a530_0x515f7a(0x1f0)),typebotListener=async({wbot:_0x196973,msg:_0x456f2e,ticket:_0x5708b0,typebot:_0x5a52d1})=>{const _0x13b86c=a530_0x515f7a;if(_0x456f2e['key'][_0x13b86c(0x1df)]===_0x13b86c(0x1ec))return;const {urlN8N:_0x41c2d3,typebotExpires:_0x22b209,typebotKeywordFinish:_0x5d6553,typebotKeywordRestart:_0x2f84ef,typebotUnknownMessage:_0xda84f4,typebotSlug:_0x1cee98,typebotDelayMessage:_0x4a1db7,typebotRestartMessage:_0x173654}=_0x5a52d1,_0x5ab5ce=_0x456f2e[_0x13b86c(0x1d0)]['remoteJid'][_0x13b86c(0x1c9)](/\D/g,'');let _0x23f6b7=(0x0,wbotMessageListener_1[_0x13b86c(0x1c0)])(_0x456f2e);async function _0x4e9d60(_0x1845ea,_0x292ad0,_0x470eb0){const _0x482b5f=_0x13b86c;try{const _0x12140d=JSON[_0x482b5f(0x1b5)]({'isStreamEnabled':!![],'message':_0x482b5f(0x1e9),'resultId':_0x482b5f(0x1e9),'isOnlyRegistering':![],'prefilledVariables':{'number':_0x470eb0,'pushName':_0x1845ea[_0x482b5f(0x1f4)]||'','remoteJid':_0x5708b0?.['contact']?.['remoteJid']}}),_0x2cf107={'method':_0x482b5f(0x1ba),'maxBodyLength':Infinity,'url':_0x41c2d3+'/api/v1/typebots/'+_0x1cee98+'/startChat','headers':{'Content-Type':_0x482b5f(0x1d2),'Accept':_0x482b5f(0x1d2)},'data':_0x12140d},_0x2ff51d=await axios_1[_0x482b5f(0x1f5)][_0x482b5f(0x1e7)](_0x2cf107);return _0x2ff51d[_0x482b5f(0x1ea)];}catch(_0x19d912){logger_1[_0x482b5f(0x1c2)][_0x482b5f(0x1b6)](_0x482b5f(0x1ca),_0x19d912);throw _0x19d912;}}let _0x3816b5,_0x2ef506,_0x3aee40=![];try{const _0x496da2=new Date();_0x496da2[_0x13b86c(0x1c6)](_0x496da2[_0x13b86c(0x1f6)]()-Number(_0x22b209));_0x22b209>0x0&&_0x5708b0[_0x13b86c(0x1b9)]<_0x496da2&&(await _0x5708b0['update']({'typebotSessionId':null,'chatbot':!![]}),await _0x5708b0['reload']());!_0x5708b0['typebotSessionId']?(_0x2ef506=await _0x4e9d60(_0x456f2e,_0x5a52d1,_0x5ab5ce),_0x3816b5=_0x2ef506[_0x13b86c(0x1f1)],_0x3aee40=!![],await _0x5708b0['update']({'typebotSessionId':_0x3816b5,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x5a52d1['id']}),await _0x5708b0['reload']()):(_0x3816b5=_0x5708b0['typebotSessionId'],_0x3aee40=_0x5708b0['typebotStatus']);if(!_0x3aee40)return;;if(_0x23f6b7!==_0x5d6553&&_0x23f6b7!==_0x2f84ef){let _0x279e78,_0x1c06be,_0xe4bf74;if(_0x2ef506?.[_0x13b86c(0x1bc)]['length']===0x0||_0x2ef506===undefined){const _0x388056=JSON[_0x13b86c(0x1b5)]({'message':_0x23f6b7});let _0x1214ed={'method':_0x13b86c(0x1ba),'maxBodyLength':Infinity,'url':_0x41c2d3+_0x13b86c(0x1c8)+_0x3816b5+'/continueChat','headers':{'Content-Type':_0x13b86c(0x1d2),'Accept':'application/json'},'data':_0x388056};_0x279e78=await axios_1[_0x13b86c(0x1f5)][_0x13b86c(0x1e7)](_0x1214ed),_0x1c06be=_0x279e78[_0x13b86c(0x1ea)]?.[_0x13b86c(0x1bc)],_0xe4bf74=_0x279e78['data']?.[_0x13b86c(0x1d6)];}else _0x1c06be=_0x2ef506?.[_0x13b86c(0x1bc)],_0xe4bf74=_0x2ef506?.['input'];if(_0x1c06be?.[_0x13b86c(0x1e3)]===0x0)await _0x196973[_0x13b86c(0x1f3)](_0x5ab5ce+_0x13b86c(0x1da),{'text':_0xda84f4});else{for(const _0x2bb6dd of _0x1c06be){if(_0x2bb6dd['type']===_0x13b86c(0x1f2)){let _0x40dccb='',_0x3f5c30=![];for(const _0x52ffdd of _0x2bb6dd[_0x13b86c(0x1ce)][_0x13b86c(0x1eb)]){for(const _0x36cf3a of _0x52ffdd[_0x13b86c(0x1e6)]){let _0x19afcb='';_0x36cf3a[_0x13b86c(0x1f2)]&&(_0x19afcb=_0x36cf3a[_0x13b86c(0x1f2)]);if(_0x36cf3a[_0x13b86c(0x1d4)]&&_0x36cf3a['children'])for(const _0xc5a7b4 of _0x36cf3a[_0x13b86c(0x1e6)]){let _0x38ccf6='';_0xc5a7b4[_0x13b86c(0x1f2)]&&(_0x38ccf6=_0xc5a7b4[_0x13b86c(0x1f2)]);if(_0xc5a7b4[_0x13b86c(0x1d4)]&&_0xc5a7b4[_0x13b86c(0x1e6)])for(const _0x4a01d2 of _0xc5a7b4[_0x13b86c(0x1e6)]){let _0x1c2246='';_0x4a01d2[_0x13b86c(0x1f2)]&&(_0x1c2246=_0x4a01d2[_0x13b86c(0x1f2)]);_0x4a01d2['bold']&&(_0x1c2246='*'+_0x1c2246+'*');_0x4a01d2['italic']&&(_0x1c2246='_'+_0x1c2246+'_');_0x4a01d2[_0x13b86c(0x1e0)]&&(_0x1c2246='~'+_0x1c2246+'~');if(_0x4a01d2[_0x13b86c(0x1b3)]){const _0x3f1e1f=_0x4a01d2[_0x13b86c(0x1e6)][0x0][_0x13b86c(0x1f2)];_0x1c2246='['+_0x3f1e1f+']('+_0x4a01d2[_0x13b86c(0x1b3)]+')',_0x3f5c30=!![];}_0x40dccb+=_0x1c2246;}_0xc5a7b4[_0x13b86c(0x1cf)]&&(_0x38ccf6='*'+_0x38ccf6+'*');_0xc5a7b4[_0x13b86c(0x1c7)]&&(_0x38ccf6='_'+_0x38ccf6+'_');_0xc5a7b4[_0x13b86c(0x1e0)]&&(_0x38ccf6='~'+_0x38ccf6+'~');if(_0xc5a7b4[_0x13b86c(0x1b3)]){const _0x592b36=_0xc5a7b4[_0x13b86c(0x1e6)][0x0][_0x13b86c(0x1f2)];_0x38ccf6='['+_0x592b36+']('+_0xc5a7b4['url']+')',_0x3f5c30=!![];}_0x40dccb+=_0x38ccf6;}_0x36cf3a['bold']&&(_0x19afcb='*'+_0x19afcb+'*');_0x36cf3a['italic']&&(_0x19afcb='_'+_0x19afcb+'_');_0x36cf3a[_0x13b86c(0x1e0)]&&(_0x19afcb='~'+_0x19afcb+'~');if(_0x36cf3a[_0x13b86c(0x1b3)]){const _0x4aa78a=_0x36cf3a['children'][0x0]['text'];_0x19afcb='['+_0x4aa78a+']('+_0x36cf3a[_0x13b86c(0x1b3)]+')',_0x3f5c30=!![];}_0x40dccb+=_0x19afcb;}_0x40dccb+='\x0a';}_0x40dccb=_0x40dccb[_0x13b86c(0x1c9)]('**','')[_0x13b86c(0x1c9)](/\n$/,'');_0x40dccb==='Invalid\x20message.\x20Please,\x20try\x20again.'&&(_0x40dccb=_0xda84f4);if(_0x40dccb[_0x13b86c(0x1db)]('#')){let _0x4f3ad1=_0x40dccb[_0x13b86c(0x1c9)]('#','');try{let _0x3bc308=JSON['parse'](_0x4f3ad1);if(_0x3bc308[_0x13b86c(0x1e5)]&&(0x0,lodash_1[_0x13b86c(0x1d1)])(_0x3bc308[_0x13b86c(0x1c4)])&&(0x0,lodash_1[_0x13b86c(0x1d1)])(_0x3bc308['queueId'])){await _0x5708b0['update']({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1['isNil'])(_0x3bc308[_0x13b86c(0x1cb)])&&_0x3bc308[_0x13b86c(0x1cb)]>0x0&&(0x0,lodash_1[_0x13b86c(0x1d1)])(_0x3bc308[_0x13b86c(0x1c4)])){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x3bc308[_0x13b86c(0x1cb)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x5708b0['id'],'companyId':_0x5708b0[_0x13b86c(0x1c1)]});return;}if(!(0x0,lodash_1[_0x13b86c(0x1d1)])(_0x3bc308['queueId'])&&_0x3bc308['queueId']>0x0&&!(0x0,lodash_1['isNil'])(_0x3bc308[_0x13b86c(0x1c4)])&&_0x3bc308[_0x13b86c(0x1c4)]>0x0){await(0x0,UpdateTicketService_1[_0x13b86c(0x1f5)])({'ticketData':{'queueId':_0x3bc308[_0x13b86c(0x1cb)],'userId':_0x3bc308['userId'],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x5708b0['id'],'companyId':_0x5708b0[_0x13b86c(0x1c1)]});return;}}catch(_0x1b7f1b){throw _0x1b7f1b;}}await(0x0,SendPresenceStatus_1[_0x13b86c(0x1b8)])(_0x196973,_0x456f2e[_0x13b86c(0x1d0)][_0x13b86c(0x1df)],_0x4a1db7),await _0x196973[_0x13b86c(0x1f3)](_0x456f2e['key'][_0x13b86c(0x1df)],{'text':_0x40dccb});}if(_0x2bb6dd[_0x13b86c(0x1d4)]==='audio'){await(0x0,SendPresenceStatus_1[_0x13b86c(0x1b8)])(_0x196973,_0x456f2e[_0x13b86c(0x1d0)][_0x13b86c(0x1df)],_0x4a1db7);const _0x26c54c={'audio':{'url':_0x2bb6dd[_0x13b86c(0x1ce)][_0x13b86c(0x1b3)],'mimetype':'audio/mp4','ptt':!![]}};await _0x196973[_0x13b86c(0x1f3)](_0x456f2e[_0x13b86c(0x1d0)][_0x13b86c(0x1df)],_0x26c54c);}if(_0x2bb6dd[_0x13b86c(0x1d4)]===_0x13b86c(0x1d7)){await(0x0,SendPresenceStatus_1[_0x13b86c(0x1b8)])(_0x196973,_0x456f2e[_0x13b86c(0x1d0)][_0x13b86c(0x1df)],_0x4a1db7);const _0xf23466={'image':{'url':_0x2bb6dd[_0x13b86c(0x1ce)][_0x13b86c(0x1b3)]}};await _0x196973[_0x13b86c(0x1f3)](_0x456f2e[_0x13b86c(0x1d0)]['remoteJid'],_0xf23466);}}if(_0xe4bf74){if(_0xe4bf74['type']===_0x13b86c(0x1d5)){let _0x5379f1='';const _0xcc9c62=_0xe4bf74[_0x13b86c(0x1ef)];for(const _0x2b1ab0 of _0xcc9c62){_0x5379f1+=_0x13b86c(0x1dd)+_0x2b1ab0[_0x13b86c(0x1ce)]+'\x0a';}_0x5379f1=_0x5379f1[_0x13b86c(0x1c9)](/\n$/,''),await(0x0,SendPresenceStatus_1[_0x13b86c(0x1b8)])(_0x196973,_0x456f2e[_0x13b86c(0x1d0)]['remoteJid'],_0x4a1db7),await _0x196973['sendMessage'](_0x456f2e[_0x13b86c(0x1d0)][_0x13b86c(0x1df)],{'text':_0x5379f1});}}}}_0x23f6b7===_0x2f84ef&&(await _0x5708b0[_0x13b86c(0x1cc)]({'chatbot':!![],'typebotSessionId':null}),await _0x5708b0[_0x13b86c(0x1ee)](),await _0x196973['sendMessage'](_0x5ab5ce+_0x13b86c(0x1da),{'text':_0x173654}));if(_0x23f6b7===_0x5d6553){await(0x0,UpdateTicketService_1[_0x13b86c(0x1f5)])({'ticketData':{'status':_0x13b86c(0x1dc),'useIntegration':![],'integrationId':null},'ticketId':_0x5708b0['id'],'companyId':_0x5708b0[_0x13b86c(0x1c1)]});return;}}catch(_0x3fcf59){logger_1[_0x13b86c(0x1c2)][_0x13b86c(0x1b6)](_0x13b86c(0x1e4),_0x3fcf59),await _0x5708b0[_0x13b86c(0x1cc)]({'typebotSessionId':null});}};exports[a530_0x515f7a(0x1f5)]=typebotListener;