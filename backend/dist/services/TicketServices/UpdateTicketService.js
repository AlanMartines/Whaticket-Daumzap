const a528_0x720d4b=a528_0x4ebd;function a528_0x1b9a(){const _0x17a795=['findOne','../WhatsappService/ShowWhatsAppService','update','(((.+)+)+)+$','ticketId','../../errors/AppError','*2*\x20-\x20_Insatisfeito_\x0a','default','624657CYtEBE','toString','642096KyvADC','../UserServices/ShowUserService','contactId','push','unreadMessages','*Mensagem\x20automática*:\x0aFoi\x20transferido\x20para\x20o\x20atendente\x20*','DD/MM/YYYY\x20HH:mm:ss','hasOwnProperty','promptId','../../helpers/CheckContactOpenTickets','*\x20por\x20','search','disableBot','../../helpers/SendPresenceStatus','defineProperty','notifyUpdate','contact','../WbotServices/SendWhatsAppMessage','value','captureException','isNil','dest','pending','../../helpers/SetTicketMessagesAsRead','10CvfZuc','*,\x20em\x20','findByPk','\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','*4*\x20-\x20_Satisfeito_\x0a','../SettingServices/ListSettingsServiceOne','rated','verifyMessage','chatbot','userId','getWbot','removeFromList','queueId','lodash','sendMsgTransfTicket','save','__importStar','-open','42gIYXAr','*3*\x20-\x20_Moderadamente\x20Satisfeito_\x0a','639476imvFtu','enabled','./FindOrCreateATicketTrakingService','*1*\x20-\x20_Muito\x20Insatisfeito_\x0a','*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*','*\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','emit','getOwnPropertyDescriptor','s.whatsapp.net','8097264hZBCsi','SendPresenceStatus','profile','apply','\x20em\x20','delete','-ticket','toDate','../../libs/wbot','__esModule','-mainchannel','getTime','find','queueOptionId','open','whatsappId','g.us','create','Digite\x20de\x201\x20à\x205\x20para\x20qualificar\x20nosso\x20atendimento:\x0a','companyId','closed','userRating','amountUsedBotQueues','number','sendMessage','../../models/Setting','../../models/Ticket','filter','username','*Mensagem\x20automática*:\x0aO\x20atendente\x20anterior\x20*','ratingAt','configurable','./ShowTicketService','__importDefault','format','getIO','writable','queue-','3151044DnYdIZ','queuedAt','-notification','status','*\x20transferido\x20por\x20','Need\x20companyId\x20or\x20tokenData','656648XYfcMb','admin','name','../../libs/socket','user','useIntegration','1236170crIzwg','isGroup','../../models/Queue','company-'];a528_0x1b9a=function(){return _0x17a795;};return a528_0x1b9a();}function a528_0x4ebd(_0x113256,_0x113482){const _0x537ef5=a528_0x1b9a();return a528_0x4ebd=function(_0x280fe7,_0x41c38c){_0x280fe7=_0x280fe7-0xde;let _0x1b9a3a=_0x537ef5[_0x280fe7];return _0x1b9a3a;},a528_0x4ebd(_0x113256,_0x113482);}(function(_0x4e1350,_0x4e0a3d){const _0x5b1c87=a528_0x4ebd,_0x1c9fdb=_0x4e1350();while(!![]){try{const _0x36d40f=parseInt(_0x5b1c87(0x100))/0x1+-parseInt(_0x5b1c87(0x106))/0x2+parseInt(_0x5b1c87(0x112))/0x3+-parseInt(_0x5b1c87(0x140))/0x4*(parseInt(_0x5b1c87(0x12c))/0x5)+parseInt(_0x5b1c87(0x114))/0x6*(-parseInt(_0x5b1c87(0x13e))/0x7)+parseInt(_0x5b1c87(0x149))/0x8+parseInt(_0x5b1c87(0xfa))/0x9;if(_0x36d40f===_0x4e0a3d)break;else _0x1c9fdb['push'](_0x1c9fdb['shift']());}catch(_0x35b232){_0x1c9fdb['push'](_0x1c9fdb['shift']());}}}(a528_0x1b9a,0x9e036));const a528_0x41c38c=(function(){let _0x3cffab=!![];return function(_0x5ef220,_0x2065bf){const _0x38ba6e=_0x3cffab?function(){const _0x21ed68=a528_0x4ebd;if(_0x2065bf){const _0x1e55e5=_0x2065bf[_0x21ed68(0x14c)](_0x5ef220,arguments);return _0x2065bf=null,_0x1e55e5;}}:function(){};return _0x3cffab=![],_0x38ba6e;};}()),a528_0x280fe7=a528_0x41c38c(this,function(){const _0x137e9e=a528_0x4ebd;return a528_0x280fe7[_0x137e9e(0x113)]()[_0x137e9e(0x11f)](_0x137e9e(0x10d))[_0x137e9e(0x113)]()['constructor'](a528_0x280fe7)['search'](_0x137e9e(0x10d));});a528_0x280fe7();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a528_0x720d4b(0xe5)]?function(_0x464cf2,_0x29e322,_0x218aa9,_0x33c062){const _0x28c3b5=a528_0x720d4b;if(_0x33c062===undefined)_0x33c062=_0x218aa9;var _0x271ea6=Object[_0x28c3b5(0x147)](_0x29e322,_0x218aa9);(!_0x271ea6||('get'in _0x271ea6?!_0x29e322[_0x28c3b5(0x152)]:_0x271ea6[_0x28c3b5(0xf8)]||_0x271ea6[_0x28c3b5(0xf3)]))&&(_0x271ea6={'enumerable':!![],'get':function(){return _0x29e322[_0x218aa9];}}),Object[_0x28c3b5(0x122)](_0x464cf2,_0x33c062,_0x271ea6);}:function(_0x6a2bd0,_0x31b930,_0xfbe1ab,_0x5c3f2c){if(_0x5c3f2c===undefined)_0x5c3f2c=_0xfbe1ab;_0x6a2bd0[_0x5c3f2c]=_0x31b930[_0xfbe1ab];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x31fef1,_0x414061){Object['defineProperty'](_0x31fef1,'default',{'enumerable':!![],'value':_0x414061});}:function(_0xf1b332,_0x33ccc0){const _0x473b88=a528_0x720d4b;_0xf1b332[_0x473b88(0x111)]=_0x33ccc0;}),__importStar=this&&this[a528_0x720d4b(0x13c)]||function(_0x2d46e5){const _0x34efe5=a528_0x720d4b;if(_0x2d46e5&&_0x2d46e5['__esModule'])return _0x2d46e5;var _0x59ec08={};if(_0x2d46e5!=null){for(var _0x57737b in _0x2d46e5)if(_0x57737b!==_0x34efe5(0x111)&&Object['prototype'][_0x34efe5(0x11b)]['call'](_0x2d46e5,_0x57737b))__createBinding(_0x59ec08,_0x2d46e5,_0x57737b);}return __setModuleDefault(_0x59ec08,_0x2d46e5),_0x59ec08;},__importDefault=this&&this[a528_0x720d4b(0xf5)]||function(_0x3a52f7){return _0x3a52f7&&_0x3a52f7['__esModule']?_0x3a52f7:{'default':_0x3a52f7};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['notifyUpdate']=void 0x0;const moment_1=__importDefault(require('moment')),Sentry=__importStar(require('@sentry/node')),CheckContactOpenTickets_1=__importDefault(require(a528_0x720d4b(0x11d))),SetTicketMessagesAsRead_1=__importDefault(require(a528_0x720d4b(0x12b))),socket_1=require(a528_0x720d4b(0x103)),Ticket_1=__importDefault(require(a528_0x720d4b(0xee))),Setting_1=__importDefault(require(a528_0x720d4b(0xed))),Queue_1=__importDefault(require(a528_0x720d4b(0x108))),ShowTicketService_1=__importDefault(require(a528_0x720d4b(0xf4))),ShowWhatsAppService_1=__importDefault(require(a528_0x720d4b(0x10b))),SendWhatsAppMessage_1=__importDefault(require(a528_0x720d4b(0x125))),FindOrCreateATicketTrakingService_1=__importDefault(require(a528_0x720d4b(0x142))),GetTicketWbot_1=__importDefault(require('../../helpers/GetTicketWbot')),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),ListSettingsServiceOne_1=__importDefault(require(a528_0x720d4b(0x131))),ShowUserService_1=__importDefault(require(a528_0x720d4b(0x115))),lodash_1=require(a528_0x720d4b(0x139)),AppError_1=__importDefault(require(a528_0x720d4b(0x10f))),SendPresenceStatus_1=require(a528_0x720d4b(0x121)),wbot_1=require(a528_0x720d4b(0x151));let completionMessageControl=[];const UpdateTicketService=async({ticketData:_0x5df651,ticketId:_0x1a292b,tokenData:_0x588f39,companyId:_0x59c971})=>{const _0x2845d0=a528_0x720d4b;try{if(!_0x59c971&&!_0x588f39)throw new Error(_0x2845d0(0xff));_0x588f39&&(_0x59c971=_0x588f39['companyId']);let {status:_0x5bc1b3}=_0x5df651,{queueId:_0x13b1fe,userId:_0x1e655e,whatsappId:_0x1755ba,sendFarewellMessage:_0x5bd795}=_0x5df651;_0x5bd795==null&&(_0x5bd795=!![]);let _0x95aff=_0x5df651[_0x2845d0(0x134)]||![],_0x4b911e=_0x5df651[_0x2845d0(0xe1)]||null,_0x302e6f=_0x5df651[_0x2845d0(0x11c)]||null,_0x3734fe=_0x5df651[_0x2845d0(0x105)]||![],_0x16949f=_0x5df651['integrationId']||null;const _0x579cc4=(0x0,socket_1[_0x2845d0(0xf7)])(),_0x1bb7cf=_0x2845d0(0xe9),_0x539e27=await Setting_1['default'][_0x2845d0(0x10a)]({'where':{'companyId':_0x59c971,'key':_0x1bb7cf}});let _0x4262f1=await(0x0,ShowTicketService_1['default'])(_0x1a292b,_0x59c971);if(_0x588f39&&_0x4262f1['status']!==_0x2845d0(0x12a)){if(_0x588f39[_0x2845d0(0x14b)]!==_0x2845d0(0x101)&&_0x4262f1['userId']!==parseInt(_0x588f39['id'],0xa))throw new AppError_1['default']('Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket');}const _0x45c471=await(0x0,FindOrCreateATicketTrakingService_1[_0x2845d0(0x111)])({'ticketId':_0x1a292b,'companyId':_0x59c971,'whatsappId':_0x4262f1[_0x2845d0(0xe3)]});(0x0,lodash_1[_0x2845d0(0x128)])(_0x1755ba)&&(_0x1755ba=_0x4262f1[_0x2845d0(0xe3)]['toString']());(_0x5bc1b3===_0x2845d0(0xe8)||_0x5bc1b3===_0x2845d0(0xe2))&&await(0x0,SetTicketMessagesAsRead_1['default'])(_0x4262f1);const _0x154a73=_0x4262f1[_0x2845d0(0xfd)],_0x401aba=_0x4262f1[_0x2845d0(0x104)]?.['id'],_0x1dc4b2=_0x4262f1[_0x2845d0(0x138)];(_0x154a73==='closed'||_0x1755ba!==undefined&&Number(_0x1755ba)!==_0x4262f1[_0x2845d0(0xe3)])&&(await(0x0,CheckContactOpenTickets_1['default'])(_0x4262f1[_0x2845d0(0x124)]['id'],_0x1755ba),_0x95aff=null,_0x4b911e=null);if(_0x5bc1b3===_0x2845d0(0xe8)){const {complationMessage:_0x184b6c,ratingMessage:_0x1e8211}=await(0x0,ShowWhatsAppService_1['default'])(_0x4262f1['whatsappId'],_0x59c971);if(!_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0x120)]&&_0x539e27?.[_0x2845d0(0x126)]===_0x2845d0(0x141)&&_0x5bd795&&!_0x4262f1[_0x2845d0(0x107)]){if(_0x45c471[_0x2845d0(0xf2)]==null&&!_0x4262f1['isGroup']){const _0x68c150=_0x1e8211||'';let _0x187a96='‎'+_0x68c150+'\x0a\x0a';return _0x187a96+=_0x2845d0(0xe6)+_0x2845d0(0x143)+_0x2845d0(0x110)+_0x2845d0(0x13f)+_0x2845d0(0x130)+'*5*\x20-\x20_Muito\x20Satisfeito_\x0a',await(0x0,SendPresenceStatus_1['SendPresenceStatus'])((0x0,wbot_1[_0x2845d0(0x136)])(_0x4262f1[_0x2845d0(0xe3)]),_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0xeb)]+'@'+(_0x4262f1['isGroup']?_0x2845d0(0xe4):'s.whatsapp.net')),await(0x0,SendWhatsAppMessage_1[_0x2845d0(0x111)])({'body':_0x187a96,'ticket':_0x4262f1}),await _0x45c471[_0x2845d0(0x10c)]({'rated':![],'ratingAt':(0x0,moment_1['default'])()['toDate']()}),await _0x4262f1[_0x2845d0(0x10c)]({'amountUsedBotQueues':_0x5df651[_0x2845d0(0xea)]||0x0,'status':_0x5bc1b3,'unreadMessages':_0x5df651[_0x2845d0(0x118)]||0x0,'queueId':_0x13b1fe,'userId':_0x1e655e,'whatsappId':_0x1755ba,'chatbot':_0x95aff,'queueOptionId':_0x4b911e}),_0x579cc4['to'](_0x2845d0(0x109)+_0x4262f1['companyId']+_0x2845d0(0x13d))['to'](_0x1a292b[_0x2845d0(0x113)]())[_0x2845d0(0x146)](_0x2845d0(0x109)+_0x4262f1[_0x2845d0(0xe7)]+_0x2845d0(0x14f),{'action':_0x2845d0(0x14e),'ticketId':_0x4262f1['id']}),{'ticket':_0x4262f1,'oldStatus':_0x154a73,'oldUserId':_0x401aba};}_0x45c471[_0x2845d0(0xf2)]=(0x0,moment_1[_0x2845d0(0x111)])()[_0x2845d0(0x150)](),_0x45c471[_0x2845d0(0x132)]=![];}if(completionMessageControl['length']>=0x9c4)completionMessageControl=[];if(!(0x0,lodash_1[_0x2845d0(0x128)])(_0x184b6c)&&_0x184b6c!==''&&_0x5bd795&&!_0x4262f1[_0x2845d0(0x107)]){let _0x2bfa65=completionMessageControl[_0x2845d0(0xe0)](_0xad963c=>_0xad963c[_0x2845d0(0x10e)]===_0x4262f1['id']||_0xad963c[_0x2845d0(0x129)]===_0x4262f1[_0x2845d0(0x124)]['number']);if(!_0x2bfa65||_0x2bfa65&&_0x2bfa65['time']+0x3e8*0x3c*0x1e<new Date()[_0x2845d0(0xdf)]()){_0x2bfa65&&(completionMessageControl=completionMessageControl[_0x2845d0(0xef)](_0x38a6b5=>_0x38a6b5[_0x2845d0(0x10e)]!==_0x4262f1['id']),_0x2bfa65=null);if(!_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0x120)]&&!(0x0,lodash_1[_0x2845d0(0x128)])(_0x184b6c)&&_0x184b6c!==''){const _0x544a21='‎'+_0x184b6c;await(0x0,SendPresenceStatus_1['SendPresenceStatus'])((0x0,wbot_1[_0x2845d0(0x136)])(_0x4262f1['whatsappId']),_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0xeb)]+'@'+(_0x4262f1[_0x2845d0(0x107)]?'g.us':_0x2845d0(0x148))),await(0x0,SendWhatsAppMessage_1[_0x2845d0(0x111)])({'body':_0x544a21,'ticket':_0x4262f1});}}!_0x2bfa65&&completionMessageControl[_0x2845d0(0x117)]({'ticketId':_0x4262f1['id'],'dest':_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0xeb)],'time':new Date()['getTime']()});}await _0x4262f1[_0x2845d0(0x10c)]({'promptId':null,'integrationId':null,'useIntegration':![],'typebotStatus':![],'typebotSessionId':null}),_0x45c471['finishedAt']=(0x0,moment_1[_0x2845d0(0x111)])()['toDate'](),_0x45c471[_0x2845d0(0xe3)]=_0x4262f1[_0x2845d0(0xe3)],_0x45c471[_0x2845d0(0x135)]=_0x4262f1['userId'];}_0x13b1fe!==undefined&&_0x13b1fe!==null&&(_0x45c471[_0x2845d0(0xfb)]=(0x0,moment_1['default'])()['toDate']());const _0x1d4d56=await(0x0,ListSettingsServiceOne_1[_0x2845d0(0x111)])({'companyId':_0x59c971,'key':_0x2845d0(0x13a)}),_0x501ba3=await Queue_1[_0x2845d0(0x111)][_0x2845d0(0x12e)](_0x13b1fe);if(_0x1d4d56?.[_0x2845d0(0x126)]==='enabled'){if(_0x1dc4b2!==_0x13b1fe&&_0x401aba===_0x1e655e&&!(0x0,lodash_1['isNil'])(_0x1dc4b2)&&!(0x0,lodash_1[_0x2845d0(0x128)])(_0x13b1fe)){const _0x558c00=await(0x0,GetTicketWbot_1[_0x2845d0(0x111)])(_0x4262f1),_0x6f451=_0x2845d0(0x144)+_0x501ba3?.['name']+_0x2845d0(0x145);await(0x0,SendPresenceStatus_1[_0x2845d0(0x14a)])(_0x558c00,_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0xeb)]+'@'+(_0x4262f1[_0x2845d0(0x107)]?_0x2845d0(0xe4):_0x2845d0(0x148)));const _0xbe4f45=await _0x558c00[_0x2845d0(0xec)](_0x4262f1['contact']['number']+'@'+(_0x4262f1[_0x2845d0(0x107)]?'g.us':'s.whatsapp.net'),{'text':_0x6f451});await(0x0,wbotMessageListener_1[_0x2845d0(0x133)])(_0xbe4f45,_0x4262f1,_0x4262f1[_0x2845d0(0x124)]);}else{if(_0x401aba!==_0x1e655e&&_0x1dc4b2===_0x13b1fe&&!(0x0,lodash_1['isNil'])(_0x401aba)&&!(0x0,lodash_1[_0x2845d0(0x128)])(_0x1e655e)){const _0x5ed00d=await(0x0,GetTicketWbot_1[_0x2845d0(0x111)])(_0x4262f1),_0x9b44af=await(0x0,ShowUserService_1['default'])(_0x5df651[_0x2845d0(0x135)]),_0x24127d=_0x2845d0(0x119)+_0x9b44af[_0x2845d0(0x102)]+_0x2845d0(0x11e)+_0x588f39[_0x2845d0(0xf0)]+'\x20em\x20'+(0x0,moment_1[_0x2845d0(0x111)])()[_0x2845d0(0xf6)]('DD/MM/YYYY\x20HH:mm:ss')+'\x0aAguarde,\x20já\x20vamos\x20te\x20atender!';await(0x0,SendPresenceStatus_1[_0x2845d0(0x14a)])(_0x5ed00d,_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0xeb)]+'@'+(_0x4262f1[_0x2845d0(0x107)]?_0x2845d0(0xe4):_0x2845d0(0x148)));const _0x46c83d=await _0x5ed00d[_0x2845d0(0xec)](_0x4262f1['contact'][_0x2845d0(0xeb)]+'@'+(_0x4262f1[_0x2845d0(0x107)]?'g.us':_0x2845d0(0x148)),{'text':_0x24127d});await(0x0,wbotMessageListener_1[_0x2845d0(0x133)])(_0x46c83d,_0x4262f1,_0x4262f1[_0x2845d0(0x124)]);}else{if(_0x401aba!==_0x1e655e&&!(0x0,lodash_1[_0x2845d0(0x128)])(_0x401aba)&&!(0x0,lodash_1[_0x2845d0(0x128)])(_0x1e655e)&&_0x1dc4b2!==_0x13b1fe&&!(0x0,lodash_1[_0x2845d0(0x128)])(_0x1dc4b2)&&!(0x0,lodash_1[_0x2845d0(0x128)])(_0x13b1fe)){const _0x137749=await(0x0,GetTicketWbot_1[_0x2845d0(0x111)])(_0x4262f1),_0xb94877=await(0x0,ShowUserService_1[_0x2845d0(0x111)])(_0x5df651[_0x2845d0(0x135)]),_0x28900f=await(0x0,ShowUserService_1[_0x2845d0(0x111)])(_0x401aba),_0xc01b7e=_0x2845d0(0x144)+_0x501ba3?.[_0x2845d0(0x102)]+'*\x20e\x20contará\x20com\x20a\x20presença\x20de\x20*'+_0xb94877[_0x2845d0(0x102)]+_0x2845d0(0xfe)+_0x588f39[_0x2845d0(0xf0)]+_0x2845d0(0x14d)+(0x0,moment_1[_0x2845d0(0x111)])()[_0x2845d0(0xf6)](_0x2845d0(0x11a))+_0x2845d0(0x12f);await(0x0,SendPresenceStatus_1[_0x2845d0(0x14a)])(_0x137749,_0x4262f1[_0x2845d0(0x124)]['number']+'@'+(_0x4262f1['isGroup']?'g.us':'s.whatsapp.net'));const _0x23c621=await _0x137749[_0x2845d0(0xec)](_0x4262f1['contact'][_0x2845d0(0xeb)]+'@'+(_0x4262f1[_0x2845d0(0x107)]?'g.us':_0x2845d0(0x148)),{'text':_0xc01b7e});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x23c621,_0x4262f1,_0x4262f1[_0x2845d0(0x124)]);const _0x1d571a=await(0x0,ShowUserService_1['default'])(_0x1e655e),_0x329b23=_0x2845d0(0xf1)+_0x28900f[_0x2845d0(0x102)]+'*\x20transferiu\x20o\x20ticket\x20para\x20você,\x20*'+_0xb94877[_0x2845d0(0x102)]+_0x2845d0(0x12d)+(0x0,moment_1[_0x2845d0(0x111)])()['format']('DD/MM/YYYY\x20HH:mm:ss')+_0x2845d0(0x12f);await(0x0,SendPresenceStatus_1[_0x2845d0(0x14a)])(_0x137749,_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0xeb)]+'@'+(_0x4262f1[_0x2845d0(0x107)]?_0x2845d0(0xe4):_0x2845d0(0x148)));const _0x1a72a8=await _0x137749[_0x2845d0(0xec)](_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0xeb)]+'@'+(_0x4262f1[_0x2845d0(0x107)]?_0x2845d0(0xe4):_0x2845d0(0x148)),{'text':_0x329b23});await(0x0,wbotMessageListener_1[_0x2845d0(0x133)])(_0x1a72a8,_0x4262f1,_0x4262f1['contact']);}else{if(_0x401aba!==undefined&&(0x0,lodash_1[_0x2845d0(0x128)])(_0x1e655e)&&_0x1dc4b2!==_0x13b1fe&&!(0x0,lodash_1['isNil'])(_0x13b1fe)){const _0x4a6de4=await(0x0,GetTicketWbot_1[_0x2845d0(0x111)])(_0x4262f1),_0x30e7ed=_0x2845d0(0x144)+_0x501ba3?.[_0x2845d0(0x102)]+_0x2845d0(0x145);await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x4a6de4,_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0xeb)]+'@'+(_0x4262f1['isGroup']?_0x2845d0(0xe4):_0x2845d0(0x148)));const _0x128c91=await _0x4a6de4[_0x2845d0(0xec)](_0x4262f1[_0x2845d0(0x124)][_0x2845d0(0xeb)]+'@'+(_0x4262f1[_0x2845d0(0x107)]?'g.us':_0x2845d0(0x148)),{'text':_0x30e7ed});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x128c91,_0x4262f1,_0x4262f1['contact']);}}}}}var _0x1e534d=_0x1dc4b2!==_0x13b1fe;return _0x501ba3&&(_0x1e534d&&_0x501ba3['newTicketOnTransfer']&&(_0x5bc1b3=_0x2845d0(0xe8))),await _0x4262f1[_0x2845d0(0x10c)]({'amountUsedBotQueues':_0x5df651[_0x2845d0(0xea)]||0x0,'status':_0x5bc1b3,'unreadMessages':_0x5df651[_0x2845d0(0x118)]||0x0,'queueId':_0x13b1fe,'userId':_0x1e655e,'whatsappId':_0x1755ba,'chatbot':_0x95aff,'queueOptionId':_0x4b911e}),await _0x4262f1['reload'](),_0x501ba3&&_0x1e534d&&_0x501ba3['newTicketOnTransfer']&&!_0x4262f1[_0x2845d0(0x134)]&&!_0x4262f1['useIntegration']&&(_0x579cc4['to'](_0x2845d0(0x109)+_0x4262f1['companyId']+'-'+_0x154a73)['to'](_0x2845d0(0xf9)+_0x4262f1[_0x2845d0(0x138)]+'-'+_0x154a73)['emit'](_0x2845d0(0x109)+_0x59c971+_0x2845d0(0x14f),{'action':_0x2845d0(0x14e),'ticketId':_0x4262f1['id']}),_0x579cc4['to'](_0x2845d0(0x109)+_0x4262f1[_0x2845d0(0xe7)]+'-'+_0x4262f1[_0x2845d0(0xfd)])['to']('company-'+_0x4262f1['companyId']+_0x2845d0(0xfc))['to'](_0x2845d0(0xf9)+_0x4262f1[_0x2845d0(0x138)]+_0x2845d0(0xfc))['to']('queue-'+_0x4262f1[_0x2845d0(0x138)]+'-'+_0x4262f1[_0x2845d0(0xfd)])['to'](_0x1a292b[_0x2845d0(0x113)]())[_0x2845d0(0x146)]('company-'+_0x59c971+_0x2845d0(0x14f),{'action':_0x2845d0(0x10c),'ticket':_0x4262f1}),_0x4262f1=await Ticket_1[_0x2845d0(0x111)][_0x2845d0(0xe5)]({'companyId':_0x59c971,'contactId':_0x4262f1[_0x2845d0(0x116)],'userId':_0x1e655e,'queueId':_0x13b1fe,'status':_0x2845d0(0x12a),'whatsappId':_0x4262f1[_0x2845d0(0xe3)],'chatbot':_0x95aff,'queueOptionId':_0x4b911e,'promptId':_0x302e6f,'useIntegration':_0x3734fe,'integrationId':_0x16949f,'amountUsedBotQueues':0x0,'unreadMessages':0x0})),_0x5bc1b3=_0x4262f1[_0x2845d0(0xfd)],_0x5bc1b3===_0x2845d0(0x12a)&&(_0x45c471[_0x2845d0(0x10c)]({'whatsappId':_0x1755ba,'queuedAt':(0x0,moment_1[_0x2845d0(0x111)])()[_0x2845d0(0x150)](),'startedAt':null,'userId':null}),_0x579cc4['to']('company-'+_0x59c971+_0x2845d0(0xde))[_0x2845d0(0x146)](_0x2845d0(0x109)+_0x59c971+_0x2845d0(0x14f),{'action':_0x2845d0(0x137),'ticketId':_0x4262f1?.['id']})),_0x5bc1b3===_0x2845d0(0xe2)&&(_0x45c471[_0x2845d0(0x10c)]({'startedAt':(0x0,moment_1[_0x2845d0(0x111)])()[_0x2845d0(0x150)](),'ratingAt':null,'rated':![],'whatsappId':_0x1755ba,'userId':_0x4262f1['userId']}),_0x579cc4['to'](_0x2845d0(0x109)+_0x59c971+'-mainchannel')[_0x2845d0(0x146)]('company-'+_0x59c971+'-ticket',{'action':'removeFromList','ticketId':_0x4262f1?.['id']}),_0x579cc4['to'](_0x2845d0(0x109)+_0x59c971+'-mainchannel')['emit'](_0x2845d0(0x109)+_0x59c971+'-ticket',{'action':'updateUnread','ticketId':_0x4262f1?.['id']})),await _0x45c471[_0x2845d0(0x13b)](),(_0x4262f1['status']!==_0x154a73||_0x4262f1['user']?.['id']!==_0x401aba||_0x1e534d)&&_0x579cc4['to'](_0x2845d0(0x109)+_0x4262f1[_0x2845d0(0xe7)]+'-'+_0x154a73)['to']('queue-'+_0x4262f1[_0x2845d0(0x138)]+'-'+_0x154a73)['to'](_0x2845d0(0x109)+_0x4262f1[_0x2845d0(0xe7)]+_0x2845d0(0xfc))['to']('queue-'+_0x4262f1[_0x2845d0(0x138)]+_0x2845d0(0xfc))['to'](_0x1a292b['toString']())[_0x2845d0(0x146)]('company-'+_0x59c971+_0x2845d0(0x14f),{'action':_0x2845d0(0x14e),'ticketId':_0x4262f1['id']}),_0x4262f1[_0x2845d0(0xfd)]!==_0x2845d0(0xe8)&&_0x579cc4['to'](_0x2845d0(0x109)+_0x4262f1[_0x2845d0(0xe7)]+'-'+_0x4262f1[_0x2845d0(0xfd)])['to'](_0x2845d0(0x109)+_0x4262f1[_0x2845d0(0xe7)]+_0x2845d0(0xfc))['to'](_0x2845d0(0xf9)+_0x4262f1[_0x2845d0(0x138)]+'-notification')['to'](_0x2845d0(0xf9)+_0x4262f1[_0x2845d0(0x138)]+'-'+_0x4262f1[_0x2845d0(0xfd)])['to'](_0x1a292b[_0x2845d0(0x113)]())[_0x2845d0(0x146)](_0x2845d0(0x109)+_0x59c971+_0x2845d0(0x14f),{'action':_0x2845d0(0x10c),'ticket':_0x4262f1}),{'ticket':_0x4262f1,'oldStatus':_0x154a73,'oldUserId':_0x401aba};}catch(_0x13b663){console['trace'](_0x13b663),Sentry[_0x2845d0(0x127)](_0x13b663);}};exports[a528_0x720d4b(0x111)]=UpdateTicketService;const notifyUpdate=(_0x10d8a8,_0x398b63,_0x2c991c,_0x33f4a6)=>{const _0x50a100=a528_0x720d4b;_0x10d8a8['to'](_0x50a100(0x109)+_0x398b63[_0x50a100(0xe7)]+'-'+_0x398b63['status'])['to'](_0x50a100(0x109)+_0x398b63[_0x50a100(0xe7)]+_0x50a100(0xfc))['to'](_0x2c991c[_0x50a100(0x113)]())[_0x50a100(0x146)](_0x50a100(0x109)+_0x33f4a6+_0x50a100(0x14f),{'action':_0x50a100(0x10c),'ticket':_0x398b63});};exports[a528_0x720d4b(0x123)]=notifyUpdate;