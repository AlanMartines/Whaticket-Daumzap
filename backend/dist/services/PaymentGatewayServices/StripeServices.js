const a452_0x408746=a452_0x1598;function a452_0x186f(){const _0xfe019f=['../../utils/logger','success','Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.','Webhook\x20handler\x20failed.','body','metadata','stripeWebhookHandler','client_secret','info','usd','data','findByPk','stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','stripeInitialize','type','__esModule','https://','31819572zOMCkt','1497104cJsFAL','2022-11-15','constructor','payment_intent.succeeded','paymentIntents','search','6608976WKypZS','9411640BftiSd','6574400AfUOKd','Failed\x20to\x20check\x20payment\x20status.','1pkdLXB','toString','error','Failed\x20to\x20create\x20subscription.','debug','defineProperty','../../errors/AppError','logger','default','invoiceId','(((.+)+)+)+$','Failed\x20to\x20create\x20webhook.','payment_intent.payment_failed','../SettingServices/GetSuperSettingService','stripeInitialize:\x20not\x20configured\x20for\x20Stripe.','stripe','Error\x20handling\x20webhook\x20event.','object','processInvoicePaid','/subscription/aa/webhook','startsWith','round','stripePaymentIntentId','__importDefault','Payment\x20failed.','create','Webhook\x20created\x20successfully.','json','apply','3BNYqDK','stripeCreateSubscription','webhookEndpoints','7354025hiBlvm','status','2495594NYjYVI','stripeCheckStatus','../../models/Invoices','env','succeeded','_paymentGateway','update','STRIPE_PRIVATE'];a452_0x186f=function(){return _0xfe019f;};return a452_0x186f();}(function(_0x2f7a68,_0x55dd1a){const _0x434217=a452_0x1598,_0x12cd53=_0x2f7a68();while(!![]){try{const _0x5b583a=-parseInt(_0x434217(0xa8))/0x1*(parseInt(_0x434217(0x84))/0x2)+-parseInt(_0x434217(0xc5))/0x3*(-parseInt(_0x434217(0x9e))/0x4)+parseInt(_0x434217(0xc8))/0x5+-parseInt(_0x434217(0xa4))/0x6+-parseInt(_0x434217(0xa6))/0x7+-parseInt(_0x434217(0xa5))/0x8+parseInt(_0x434217(0x9d))/0x9;if(_0x5b583a===_0x55dd1a)break;else _0x12cd53['push'](_0x12cd53['shift']());}catch(_0x5f3c90){_0x12cd53['push'](_0x12cd53['shift']());}}}(a452_0x186f,0xdf8b9));const a452_0x4a0131=(function(){let _0x1774bc=!![];return function(_0x1b5b48,_0x313ee2){const _0x30c1cc=_0x1774bc?function(){const _0x75f9ab=a452_0x1598;if(_0x313ee2){const _0x2a6c1e=_0x313ee2[_0x75f9ab(0xc4)](_0x1b5b48,arguments);return _0x313ee2=null,_0x2a6c1e;}}:function(){};return _0x1774bc=![],_0x30c1cc;};}()),a452_0x50a734=a452_0x4a0131(this,function(){const _0x12a1b8=a452_0x1598;return a452_0x50a734[_0x12a1b8(0xa9)]()['search']('(((.+)+)+)+$')[_0x12a1b8(0xa9)]()[_0x12a1b8(0xa0)](a452_0x50a734)[_0x12a1b8(0xa3)](_0x12a1b8(0xb2));});a452_0x50a734();'use strict';function a452_0x1598(_0x39fe11,_0xc997e){const _0x45026b=a452_0x186f();return a452_0x1598=function(_0x50a734,_0x4a0131){_0x50a734=_0x50a734-0x83;let _0x186fcd=_0x45026b[_0x50a734];return _0x186fcd;},a452_0x1598(_0x39fe11,_0xc997e);}var __importDefault=this&&this[a452_0x408746(0xbf)]||function(_0x56041d){const _0x82a3a1=a452_0x408746;return _0x56041d&&_0x56041d[_0x82a3a1(0x9b)]?_0x56041d:{'default':_0x56041d};};Object[a452_0x408746(0xad)](exports,'__esModule',{'value':!![]}),exports[a452_0x408746(0x85)]=exports[a452_0x408746(0xc6)]=exports['stripeWebhookHandler']=exports[a452_0x408746(0x99)]=void 0x0;const stripe_1=__importDefault(require('stripe')),GetSuperSettingService_1=__importDefault(require(a452_0x408746(0xb5))),logger_1=require(a452_0x408746(0x8c)),Invoices_1=__importDefault(require(a452_0x408746(0x86))),AppError_1=__importDefault(require(a452_0x408746(0xae))),PaymentGatewayServices_1=require('./PaymentGatewayServices'),stripe=new stripe_1['default'](process[a452_0x408746(0x87)][a452_0x408746(0x8b)],{'apiVersion':a452_0x408746(0x9f)});async function createStripeWebhook(){const _0x46c3b0=a452_0x408746;try{const _0x5afeee=await stripe[_0x46c3b0(0xc7)][_0x46c3b0(0xc1)]({'url':process[_0x46c3b0(0x87)]['BACKEND_URL']+_0x46c3b0(0xbb),'enabled_events':[_0x46c3b0(0xa1),_0x46c3b0(0xb4)]});return logger_1[_0x46c3b0(0xaf)][_0x46c3b0(0x94)]({'webhookEndpoint':_0x5afeee},_0x46c3b0(0xc2)),_0x5afeee;}catch(_0x4c3bf6){logger_1['logger'][_0x46c3b0(0xaa)]({'error':_0x4c3bf6},_0x46c3b0(0xb3));throw new AppError_1[(_0x46c3b0(0xb0))](_0x46c3b0(0xb3),0x1f4);}}const stripeInitialize=async()=>{const _0x1861b7=a452_0x408746,_0x1014db=await(0x0,GetSuperSettingService_1['default'])({'key':_0x1861b7(0x89)});if(_0x1014db!==_0x1861b7(0xb7)){logger_1[_0x1861b7(0xaf)][_0x1861b7(0xac)](_0x1861b7(0xb6));return;}if(!process[_0x1861b7(0x87)]['BACKEND_URL'][_0x1861b7(0xbc)](_0x1861b7(0x9c))){logger_1[_0x1861b7(0xaf)][_0x1861b7(0xac)](_0x1861b7(0x98));return;}await createStripeWebhook();};exports['stripeInitialize']=stripeInitialize;const stripeWebhookHandler=async(_0x58c487,_0x36d268)=>{const _0x566fad=a452_0x408746,_0x41f012=_0x58c487[_0x566fad(0x90)];try{switch(_0x41f012[_0x566fad(0x9a)]){case _0x566fad(0xa1):const _0x131e9c=_0x41f012[_0x566fad(0x96)][_0x566fad(0xb9)];await(0x0,PaymentGatewayServices_1[_0x566fad(0xba)])(_0x131e9c[_0x566fad(0x91)][_0x566fad(0xb1)]);break;case _0x566fad(0xb4):const _0x173c5b=_0x41f012['data'][_0x566fad(0xb9)];logger_1['logger'][_0x566fad(0x94)]({'failedIntent':_0x173c5b},_0x566fad(0xc0));break;default:logger_1[_0x566fad(0xaf)]['warn']({'event':_0x41f012},'Unhandled\x20event\x20type.');}return _0x36d268[_0x566fad(0x83)](0xc8)['json']({'received':!![]});}catch(_0xf14577){return logger_1[_0x566fad(0xaf)][_0x566fad(0xaa)]({'error':_0xf14577},_0x566fad(0xb8)),_0x36d268[_0x566fad(0x83)](0x190)[_0x566fad(0xc3)]({'error':_0x566fad(0x8f)});}};exports[a452_0x408746(0x92)]=stripeWebhookHandler;const stripeCreateSubscription=async(_0x37f6dc,_0x4c4adc)=>{const _0x591a85=a452_0x408746,{price:_0x3d3011,invoiceId:_0xd529be}=_0x37f6dc[_0x591a85(0x90)];try{const _0x2b7162=await stripe[_0x591a85(0xa2)][_0x591a85(0xc1)]({'amount':Math[_0x591a85(0xbd)](parseFloat(_0x3d3011)*0x64),'currency':_0x591a85(0x95),'metadata':{'invoiceId':_0xd529be}});return await Invoices_1[_0x591a85(0xb0)][_0x591a85(0x8a)]({'stripePaymentIntentId':_0x2b7162['id']},{'where':{'id':_0xd529be}}),_0x4c4adc[_0x591a85(0xc3)]({'clientSecret':_0x2b7162[_0x591a85(0x93)],'status':_0x591a85(0x8d)});}catch(_0x53c08a){logger_1[_0x591a85(0xaf)][_0x591a85(0xaa)]({'error':_0x53c08a},_0x591a85(0xab));throw new AppError_1[(_0x591a85(0xb0))](_0x591a85(0xab),0x190);}};exports[a452_0x408746(0xc6)]=stripeCreateSubscription;const stripeCheckStatus=async _0x3f5143=>{const _0x30f6c3=a452_0x408746;try{const _0x4e8e0d=await Invoices_1[_0x30f6c3(0xb0)][_0x30f6c3(0x97)](_0x3f5143);if(!_0x4e8e0d||!_0x4e8e0d[_0x30f6c3(0xbe)])return logger_1['logger']['error'](_0x30f6c3(0x8e)),![];const _0x3d23d0=await stripe[_0x30f6c3(0xa2)]['retrieve'](_0x4e8e0d[_0x30f6c3(0xbe)]);if(_0x3d23d0[_0x30f6c3(0x83)]===_0x30f6c3(0x88))return await(0x0,PaymentGatewayServices_1[_0x30f6c3(0xba)])(_0x4e8e0d),!![];return![];}catch(_0x33843f){return logger_1['logger'][_0x30f6c3(0xaa)]({'error':_0x33843f},_0x30f6c3(0xa7)),![];}};exports[a452_0x408746(0x85)]=stripeCheckStatus;