const a452_0x5ff99d=a452_0x4859;(function(_0x48ea43,_0x4765a1){const _0x13b879=a452_0x4859,_0x2aacf6=_0x48ea43();while(!![]){try{const _0x43583c=parseInt(_0x13b879(0x1ce))/0x1*(parseInt(_0x13b879(0x1f5))/0x2)+parseInt(_0x13b879(0x1c1))/0x3+-parseInt(_0x13b879(0x1e0))/0x4+-parseInt(_0x13b879(0x1e7))/0x5+-parseInt(_0x13b879(0x1fd))/0x6+parseInt(_0x13b879(0x1ef))/0x7+parseInt(_0x13b879(0x1c6))/0x8;if(_0x43583c===_0x4765a1)break;else _0x2aacf6['push'](_0x2aacf6['shift']());}catch(_0x5a4f16){_0x2aacf6['push'](_0x2aacf6['shift']());}}}(a452_0x5b3c,0xac251));const a452_0x1e9c00=(function(){let _0x3b4b76=!![];return function(_0x325b2f,_0x3881bf){const _0x50854f=_0x3b4b76?function(){const _0x76dcce=a452_0x4859;if(_0x3881bf){const _0x1fafc6=_0x3881bf[_0x76dcce(0x1ed)](_0x325b2f,arguments);return _0x3881bf=null,_0x1fafc6;}}:function(){};return _0x3b4b76=![],_0x50854f;};}()),a452_0x416614=a452_0x1e9c00(this,function(){const _0x3ebd96=a452_0x4859;return a452_0x416614[_0x3ebd96(0x1f0)]()['search']('(((.+)+)+)+$')['toString']()[_0x3ebd96(0x1cc)](a452_0x416614)[_0x3ebd96(0x1cf)](_0x3ebd96(0x1f6));});a452_0x416614();'use strict';var __importDefault=this&&this[a452_0x5ff99d(0x204)]||function(_0x54cd5d){const _0x165294=a452_0x5ff99d;return _0x54cd5d&&_0x54cd5d[_0x165294(0x1e2)]?_0x54cd5d:{'default':_0x54cd5d};};Object[a452_0x5ff99d(0x1d4)](exports,a452_0x5ff99d(0x1e2),{'value':!![]}),exports[a452_0x5ff99d(0x1c9)]=exports[a452_0x5ff99d(0x1d5)]=exports['stripeWebhookHandler']=exports[a452_0x5ff99d(0x1ff)]=void 0x0;const stripe_1=__importDefault(require(a452_0x5ff99d(0x1df))),GetSuperSettingService_1=__importDefault(require(a452_0x5ff99d(0x1c8))),logger_1=require(a452_0x5ff99d(0x1d0)),Invoices_1=__importDefault(require('../../models/Invoices')),AppError_1=__importDefault(require(a452_0x5ff99d(0x1e9))),PaymentGatewayServices_1=require(a452_0x5ff99d(0x1f2)),stripe=new stripe_1[(a452_0x5ff99d(0x1d6))](process[a452_0x5ff99d(0x1d8)][a452_0x5ff99d(0x1e8)],{'apiVersion':a452_0x5ff99d(0x1ec)});async function createStripeWebhook(){const _0x16a442=a452_0x5ff99d;try{const _0x5bf6d1=await stripe[_0x16a442(0x1dc)][_0x16a442(0x200)]({'url':process[_0x16a442(0x1d8)][_0x16a442(0x1d7)]+_0x16a442(0x1eb),'enabled_events':[_0x16a442(0x1f1),_0x16a442(0x1fe)]});return logger_1['logger'][_0x16a442(0x1f3)]({'webhookEndpoint':_0x5bf6d1},_0x16a442(0x1c7)),_0x5bf6d1;}catch(_0xa99a41){logger_1[_0x16a442(0x1c5)][_0x16a442(0x1db)]({'error':_0xa99a41},_0x16a442(0x1c3));throw new AppError_1[(_0x16a442(0x1d6))]('Failed\x20to\x20create\x20webhook.',0x1f4);}}function a452_0x4859(_0x374f26,_0x594b62){const _0x57e05e=a452_0x5b3c();return a452_0x4859=function(_0x416614,_0x1e9c00){_0x416614=_0x416614-0x1c1;let _0x5b3c65=_0x57e05e[_0x416614];return _0x5b3c65;},a452_0x4859(_0x374f26,_0x594b62);}const stripeInitialize=async()=>{const _0x37d7ce=a452_0x5ff99d,_0x4615ac=await(0x0,GetSuperSettingService_1[_0x37d7ce(0x1d6)])({'key':_0x37d7ce(0x201)});if(_0x4615ac!==_0x37d7ce(0x1df)){logger_1[_0x37d7ce(0x1c5)][_0x37d7ce(0x205)](_0x37d7ce(0x1c2));return;}if(!process['env'][_0x37d7ce(0x1d7)]['startsWith']('https://')){logger_1[_0x37d7ce(0x1c5)][_0x37d7ce(0x205)](_0x37d7ce(0x1de));return;}await createStripeWebhook();};exports[a452_0x5ff99d(0x1ff)]=stripeInitialize;const stripeWebhookHandler=async(_0x4052f7,_0x4871b2)=>{const _0x1e32c9=a452_0x5ff99d,_0x154440=_0x4052f7['body'];try{switch(_0x154440['type']){case _0x1e32c9(0x1f1):const _0x4c168f=_0x154440[_0x1e32c9(0x1e6)]['object'];await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x4c168f[_0x1e32c9(0x1f7)][_0x1e32c9(0x1e5)]);break;case _0x1e32c9(0x1fe):const _0x2d5c44=_0x154440['data'][_0x1e32c9(0x1f9)];logger_1[_0x1e32c9(0x1c5)][_0x1e32c9(0x1f3)]({'failedIntent':_0x2d5c44},_0x1e32c9(0x1ca));break;default:logger_1[_0x1e32c9(0x1c5)][_0x1e32c9(0x1e1)]({'event':_0x154440},_0x1e32c9(0x1cd));}return _0x4871b2[_0x1e32c9(0x202)](0xc8)['json']({'received':!![]});}catch(_0x95e399){return logger_1[_0x1e32c9(0x1c5)][_0x1e32c9(0x1db)]({'error':_0x95e399},_0x1e32c9(0x203)),_0x4871b2['status'](0x190)[_0x1e32c9(0x1d1)]({'error':_0x1e32c9(0x1ee)});}};exports[a452_0x5ff99d(0x1d2)]=stripeWebhookHandler;const stripeCreateSubscription=async(_0x5de8ca,_0x3523f1)=>{const _0x10d362=a452_0x5ff99d,{price:_0x2170eb,invoiceId:_0x473121}=_0x5de8ca[_0x10d362(0x1da)];try{const _0x480e57=await stripe['paymentIntents']['create']({'amount':Math['round'](parseFloat(_0x2170eb)*0x64),'currency':_0x10d362(0x1fb),'metadata':{'invoiceId':_0x473121}});return await Invoices_1['default'][_0x10d362(0x1c4)]({'stripePaymentIntentId':_0x480e57['id']},{'where':{'id':_0x473121}}),_0x3523f1[_0x10d362(0x1d1)]({'clientSecret':_0x480e57[_0x10d362(0x1d9)],'status':_0x10d362(0x1d3)});}catch(_0x4bd056){logger_1[_0x10d362(0x1c5)][_0x10d362(0x1db)]({'error':_0x4bd056},_0x10d362(0x1cb));throw new AppError_1['default'](_0x10d362(0x1cb),0x190);}};exports[a452_0x5ff99d(0x1d5)]=stripeCreateSubscription;const stripeCheckStatus=async _0x406327=>{const _0x51205c=a452_0x5ff99d;try{const _0x1ae147=await Invoices_1['default'][_0x51205c(0x1f4)](_0x406327);if(!_0x1ae147||!_0x1ae147['stripePaymentIntentId'])return logger_1[_0x51205c(0x1c5)][_0x51205c(0x1db)](_0x51205c(0x1dd)),![];const _0x5cc139=await stripe[_0x51205c(0x1fc)][_0x51205c(0x1e3)](_0x1ae147[_0x51205c(0x1fa)]);if(_0x5cc139[_0x51205c(0x202)]===_0x51205c(0x1e4))return await(0x0,PaymentGatewayServices_1[_0x51205c(0x1f8)])(_0x1ae147),!![];return![];}catch(_0x7150c9){return logger_1[_0x51205c(0x1c5)][_0x51205c(0x1db)]({'error':_0x7150c9},_0x51205c(0x1ea)),![];}};exports[a452_0x5ff99d(0x1c9)]=stripeCheckStatus;function a452_0x5b3c(){const _0x15722e=['/subscription/aa/webhook','2022-11-15','apply','Webhook\x20handler\x20failed.','1227366lzBZdh','toString','payment_intent.succeeded','./PaymentGatewayServices','info','findByPk','614986BWVukQ','(((.+)+)+)+$','metadata','processInvoicePaid','object','stripePaymentIntentId','usd','paymentIntents','8254548vZKWIf','payment_intent.payment_failed','stripeInitialize','create','_paymentGateway','status','Error\x20handling\x20webhook\x20event.','__importDefault','debug','674139NnHCvj','stripeInitialize:\x20not\x20configured\x20for\x20Stripe.','Failed\x20to\x20create\x20webhook.','update','logger','16303416qpSYEG','Webhook\x20created\x20successfully.','../SettingServices/GetSuperSettingService','stripeCheckStatus','Payment\x20failed.','Failed\x20to\x20create\x20subscription.','constructor','Unhandled\x20event\x20type.','2vlnECo','search','../../utils/logger','json','stripeWebhookHandler','success','defineProperty','stripeCreateSubscription','default','BACKEND_URL','env','client_secret','body','error','webhookEndpoints','Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.','stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','stripe','2082824mKvsAJ','warn','__esModule','retrieve','succeeded','invoiceId','data','2256975TPCOSt','STRIPE_PRIVATE','../../errors/AppError','Failed\x20to\x20check\x20payment\x20status.'];a452_0x5b3c=function(){return _0x15722e;};return a452_0x5b3c();}