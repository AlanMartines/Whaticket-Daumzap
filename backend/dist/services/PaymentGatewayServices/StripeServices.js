const a452_0x4e476b=a452_0x54aa;(function(_0x22beb3,_0x58cf9d){const _0x4c1f64=a452_0x54aa,_0xb970b3=_0x22beb3();while(!![]){try{const _0x401553=-parseInt(_0x4c1f64(0xb4))/0x1*(-parseInt(_0x4c1f64(0xd1))/0x2)+parseInt(_0x4c1f64(0xb7))/0x3*(parseInt(_0x4c1f64(0xae))/0x4)+parseInt(_0x4c1f64(0xba))/0x5+-parseInt(_0x4c1f64(0xf2))/0x6*(parseInt(_0x4c1f64(0xd0))/0x7)+-parseInt(_0x4c1f64(0xaf))/0x8*(parseInt(_0x4c1f64(0xbc))/0x9)+parseInt(_0x4c1f64(0xed))/0xa*(parseInt(_0x4c1f64(0xf4))/0xb)+-parseInt(_0x4c1f64(0xe5))/0xc*(parseInt(_0x4c1f64(0xc2))/0xd);if(_0x401553===_0x58cf9d)break;else _0xb970b3['push'](_0xb970b3['shift']());}catch(_0x5c83ae){_0xb970b3['push'](_0xb970b3['shift']());}}}(a452_0x392b,0xb9b59));const a452_0x2df9c5=(function(){let _0x454312=!![];return function(_0x4b7758,_0x442f00){const _0x5e3ada=_0x454312?function(){const _0x30a76a=a452_0x54aa;if(_0x442f00){const _0x36058e=_0x442f00[_0x30a76a(0xe8)](_0x4b7758,arguments);return _0x442f00=null,_0x36058e;}}:function(){};return _0x454312=![],_0x5e3ada;};}()),a452_0x42808d=a452_0x2df9c5(this,function(){const _0x4c9246=a452_0x54aa;return a452_0x42808d[_0x4c9246(0xd5)]()[_0x4c9246(0xbf)]('(((.+)+)+)+$')[_0x4c9246(0xd5)]()[_0x4c9246(0xd8)](a452_0x42808d)[_0x4c9246(0xbf)](_0x4c9246(0xc5));});a452_0x42808d();'use strict';var __importDefault=this&&this[a452_0x4e476b(0xc9)]||function(_0x58b895){const _0x5d2016=a452_0x4e476b;return _0x58b895&&_0x58b895[_0x5d2016(0xb1)]?_0x58b895:{'default':_0x58b895};};Object[a452_0x4e476b(0xd6)](exports,a452_0x4e476b(0xb1),{'value':!![]}),exports[a452_0x4e476b(0xf1)]=exports[a452_0x4e476b(0xc3)]=exports[a452_0x4e476b(0xe4)]=exports[a452_0x4e476b(0xd7)]=void 0x0;const stripe_1=__importDefault(require(a452_0x4e476b(0xb9))),GetSuperSettingService_1=__importDefault(require(a452_0x4e476b(0xcf))),logger_1=require(a452_0x4e476b(0xc6)),Invoices_1=__importDefault(require('../../models/Invoices')),AppError_1=__importDefault(require(a452_0x4e476b(0xdc))),PaymentGatewayServices_1=require(a452_0x4e476b(0xd3)),stripe=new stripe_1[(a452_0x4e476b(0xe9))](process[a452_0x4e476b(0xd9)][a452_0x4e476b(0xce)],{'apiVersion':a452_0x4e476b(0xb3)});async function createStripeWebhook(){const _0x5417a2=a452_0x4e476b;try{const _0x2c8177=await stripe['webhookEndpoints'][_0x5417a2(0xb6)]({'url':process['env'][_0x5417a2(0xac)]+_0x5417a2(0xb0),'enabled_events':[_0x5417a2(0xe7),'payment_intent.payment_failed']});return logger_1[_0x5417a2(0xc4)][_0x5417a2(0xc1)]({'webhookEndpoint':_0x2c8177},_0x5417a2(0xdb)),_0x2c8177;}catch(_0x2c5c4b){logger_1[_0x5417a2(0xc4)]['error']({'error':_0x2c5c4b},_0x5417a2(0xda));throw new AppError_1['default']('Failed\x20to\x20create\x20webhook.',0x1f4);}}function a452_0x54aa(_0x46451f,_0x51693f){const _0x698d24=a452_0x392b();return a452_0x54aa=function(_0x42808d,_0x2df9c5){_0x42808d=_0x42808d-0xac;let _0x392bca=_0x698d24[_0x42808d];return _0x392bca;},a452_0x54aa(_0x46451f,_0x51693f);}const stripeInitialize=async()=>{const _0x231b99=a452_0x4e476b,_0x28e54c=await(0x0,GetSuperSettingService_1['default'])({'key':_0x231b99(0xee)});if(_0x28e54c!==_0x231b99(0xb9)){logger_1[_0x231b99(0xc4)][_0x231b99(0xc7)](_0x231b99(0xcc));return;}if(!process[_0x231b99(0xd9)][_0x231b99(0xac)][_0x231b99(0xcd)](_0x231b99(0xe0))){logger_1[_0x231b99(0xc4)][_0x231b99(0xc7)](_0x231b99(0xad));return;}await createStripeWebhook();};exports['stripeInitialize']=stripeInitialize;const stripeWebhookHandler=async(_0x23a12c,_0x4e5a2b)=>{const _0x3f7f3e=a452_0x4e476b,_0x2f837f=_0x23a12c[_0x3f7f3e(0xeb)];try{switch(_0x2f837f[_0x3f7f3e(0xe6)]){case _0x3f7f3e(0xe7):const _0x3c19f2=_0x2f837f[_0x3f7f3e(0xef)][_0x3f7f3e(0xe1)];await(0x0,PaymentGatewayServices_1[_0x3f7f3e(0xec)])(_0x3c19f2['metadata'][_0x3f7f3e(0xbb)]);break;case _0x3f7f3e(0xca):const _0x562832=_0x2f837f[_0x3f7f3e(0xef)][_0x3f7f3e(0xe1)];logger_1['logger'][_0x3f7f3e(0xc1)]({'failedIntent':_0x562832},_0x3f7f3e(0xc8));break;default:logger_1[_0x3f7f3e(0xc4)][_0x3f7f3e(0xc0)]({'event':_0x2f837f},_0x3f7f3e(0xb2));}return _0x4e5a2b['status'](0xc8)['json']({'received':!![]});}catch(_0x9ee5cf){return logger_1['logger']['error']({'error':_0x9ee5cf},_0x3f7f3e(0xdf)),_0x4e5a2b['status'](0x190)[_0x3f7f3e(0xcb)]({'error':_0x3f7f3e(0xbd)});}};exports[a452_0x4e476b(0xe4)]=stripeWebhookHandler;function a452_0x392b(){const _0x19406e=['_paymentGateway','data','client_secret','stripeCheckStatus','68994MdMNgW','usd','627jMZbCj','BACKEND_URL','stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','20bCoXnu','152DGxJvj','/subscription/aa/webhook','__esModule','Unhandled\x20event\x20type.','2022-11-15','3JEKjGe','stripePaymentIntentId','create','825951IrObKT','update','stripe','598835HVRXEb','invoiceId','226017dOzHit','Webhook\x20handler\x20failed.','round','search','warn','info','6555237ZBLTzZ','stripeCreateSubscription','logger','(((.+)+)+)+$','../../utils/logger','debug','Payment\x20failed.','__importDefault','payment_intent.payment_failed','json','stripeInitialize:\x20not\x20configured\x20for\x20Stripe.','startsWith','STRIPE_PRIVATE','../SettingServices/GetSuperSettingService','252cUjrjS','948866IGVGJE','Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.','./PaymentGatewayServices','status','toString','defineProperty','stripeInitialize','constructor','env','Failed\x20to\x20create\x20webhook.','Webhook\x20created\x20successfully.','../../errors/AppError','succeeded','success','Error\x20handling\x20webhook\x20event.','https://','object','paymentIntents','Failed\x20to\x20create\x20subscription.','stripeWebhookHandler','36VLwnsv','type','payment_intent.succeeded','apply','default','error','body','processInvoicePaid','42960PobQQD'];a452_0x392b=function(){return _0x19406e;};return a452_0x392b();}const stripeCreateSubscription=async(_0x3cf75a,_0x1b900c)=>{const _0x477950=a452_0x4e476b,{price:_0x6e8555,invoiceId:_0x137137}=_0x3cf75a[_0x477950(0xeb)];try{const _0x99e4c1=await stripe[_0x477950(0xe2)][_0x477950(0xb6)]({'amount':Math[_0x477950(0xbe)](parseFloat(_0x6e8555)*0x64),'currency':_0x477950(0xf3),'metadata':{'invoiceId':_0x137137}});return await Invoices_1[_0x477950(0xe9)][_0x477950(0xb8)]({'stripePaymentIntentId':_0x99e4c1['id']},{'where':{'id':_0x137137}}),_0x1b900c[_0x477950(0xcb)]({'clientSecret':_0x99e4c1[_0x477950(0xf0)],'status':_0x477950(0xde)});}catch(_0x1c2b46){logger_1[_0x477950(0xc4)][_0x477950(0xea)]({'error':_0x1c2b46},_0x477950(0xe3));throw new AppError_1[(_0x477950(0xe9))]('Failed\x20to\x20create\x20subscription.',0x190);}};exports[a452_0x4e476b(0xc3)]=stripeCreateSubscription;const stripeCheckStatus=async _0x477527=>{const _0x513d5f=a452_0x4e476b;try{const _0x58ef19=await Invoices_1[_0x513d5f(0xe9)]['findByPk'](_0x477527);if(!_0x58ef19||!_0x58ef19[_0x513d5f(0xb5)])return logger_1[_0x513d5f(0xc4)]['error'](_0x513d5f(0xd2)),![];const _0x154232=await stripe[_0x513d5f(0xe2)]['retrieve'](_0x58ef19[_0x513d5f(0xb5)]);if(_0x154232[_0x513d5f(0xd4)]===_0x513d5f(0xdd))return await(0x0,PaymentGatewayServices_1[_0x513d5f(0xec)])(_0x58ef19),!![];return![];}catch(_0x5bdfa3){return logger_1[_0x513d5f(0xc4)]['error']({'error':_0x5bdfa3},'Failed\x20to\x20check\x20payment\x20status.'),![];}};exports[a452_0x4e476b(0xf1)]=stripeCheckStatus;