function a452_0xf562(_0x110a6d,_0x1b0c8e){const _0x2873ed=a452_0x4c9f();return a452_0xf562=function(_0x1ae518,_0x341542){_0x1ae518=_0x1ae518-0xab;let _0x4c9f98=_0x2873ed[_0x1ae518];return _0x4c9f98;},a452_0xf562(_0x110a6d,_0x1b0c8e);}const a452_0x2a986a=a452_0xf562;(function(_0x210d55,_0x2a62a2){const _0x10a6ac=a452_0xf562,_0x5efd97=_0x210d55();while(!![]){try{const _0x2b8309=parseInt(_0x10a6ac(0xd1))/0x1+parseInt(_0x10a6ac(0xdb))/0x2+parseInt(_0x10a6ac(0xd4))/0x3+-parseInt(_0x10a6ac(0xab))/0x4+-parseInt(_0x10a6ac(0xc5))/0x5*(-parseInt(_0x10a6ac(0xd2))/0x6)+parseInt(_0x10a6ac(0xeb))/0x7*(parseInt(_0x10a6ac(0xb4))/0x8)+-parseInt(_0x10a6ac(0xd8))/0x9;if(_0x2b8309===_0x2a62a2)break;else _0x5efd97['push'](_0x5efd97['shift']());}catch(_0x506385){_0x5efd97['push'](_0x5efd97['shift']());}}}(a452_0x4c9f,0x6e1d4));const a452_0x341542=(function(){let _0x58c1a4=!![];return function(_0x2068db,_0x1ab9ca){const _0x8a3bbe=_0x58c1a4?function(){const _0x343b69=a452_0xf562;if(_0x1ab9ca){const _0x4c1774=_0x1ab9ca[_0x343b69(0xb0)](_0x2068db,arguments);return _0x1ab9ca=null,_0x4c1774;}}:function(){};return _0x58c1a4=![],_0x8a3bbe;};}()),a452_0x1ae518=a452_0x341542(this,function(){const _0x4d7ce5=a452_0xf562;return a452_0x1ae518[_0x4d7ce5(0xc1)]()[_0x4d7ce5(0xaf)]('(((.+)+)+)+$')[_0x4d7ce5(0xc1)]()[_0x4d7ce5(0xcb)](a452_0x1ae518)['search'](_0x4d7ce5(0xc2));});a452_0x1ae518();'use strict';var __importDefault=this&&this[a452_0x2a986a(0xc9)]||function(_0x54bbb6){const _0x45d24d=a452_0x2a986a;return _0x54bbb6&&_0x54bbb6[_0x45d24d(0xd0)]?_0x54bbb6:{'default':_0x54bbb6};};Object[a452_0x2a986a(0xe1)](exports,a452_0x2a986a(0xd0),{'value':!![]}),exports[a452_0x2a986a(0xe0)]=exports[a452_0x2a986a(0xae)]=exports[a452_0x2a986a(0xd9)]=exports[a452_0x2a986a(0xad)]=void 0x0;const stripe_1=__importDefault(require('stripe')),GetSuperSettingService_1=__importDefault(require(a452_0x2a986a(0xed))),logger_1=require(a452_0x2a986a(0xc3)),Invoices_1=__importDefault(require('../../models/Invoices')),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require(a452_0x2a986a(0xe2)),stripe=new stripe_1[(a452_0x2a986a(0xdd))](process[a452_0x2a986a(0xe4)]['STRIPE_PRIVATE'],{'apiVersion':a452_0x2a986a(0xe8)});async function createStripeWebhook(){const _0x42bd23=a452_0x2a986a;try{const _0x329ffd=await stripe[_0x42bd23(0xc7)][_0x42bd23(0xde)]({'url':process[_0x42bd23(0xe4)][_0x42bd23(0xdf)]+_0x42bd23(0xc4),'enabled_events':[_0x42bd23(0xb3),'payment_intent.payment_failed']});return logger_1[_0x42bd23(0xcf)][_0x42bd23(0xce)]({'webhookEndpoint':_0x329ffd},_0x42bd23(0xb2)),_0x329ffd;}catch(_0x5853c2){logger_1[_0x42bd23(0xcf)][_0x42bd23(0xb6)]({'error':_0x5853c2},_0x42bd23(0xe9));throw new AppError_1[(_0x42bd23(0xdd))](_0x42bd23(0xe9),0x1f4);}}const stripeInitialize=async()=>{const _0x3c26d4=a452_0x2a986a,_0x7b6217=await(0x0,GetSuperSettingService_1[_0x3c26d4(0xdd)])({'key':_0x3c26d4(0xbe)});if(_0x7b6217!==_0x3c26d4(0xca)){logger_1[_0x3c26d4(0xcf)][_0x3c26d4(0xe6)](_0x3c26d4(0xe5));return;}if(!process['env'][_0x3c26d4(0xdf)][_0x3c26d4(0xbc)](_0x3c26d4(0xb8))){logger_1[_0x3c26d4(0xcf)][_0x3c26d4(0xe6)](_0x3c26d4(0xb7));return;}await createStripeWebhook();};exports[a452_0x2a986a(0xad)]=stripeInitialize;const stripeWebhookHandler=async(_0x230cdd,_0x5c8b7a)=>{const _0x30330e=a452_0x2a986a,_0x50ffba=_0x230cdd[_0x30330e(0xbb)];try{switch(_0x50ffba[_0x30330e(0xc0)]){case'payment_intent.succeeded':const _0x29f356=_0x50ffba[_0x30330e(0xba)]['object'];await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x29f356[_0x30330e(0xda)][_0x30330e(0xbf)]);break;case'payment_intent.payment_failed':const _0x5d9eb3=_0x50ffba[_0x30330e(0xba)][_0x30330e(0xd3)];logger_1[_0x30330e(0xcf)][_0x30330e(0xce)]({'failedIntent':_0x5d9eb3},_0x30330e(0xe3));break;default:logger_1[_0x30330e(0xcf)][_0x30330e(0xac)]({'event':_0x50ffba},_0x30330e(0xb1));}return _0x5c8b7a[_0x30330e(0xea)](0xc8)[_0x30330e(0xb9)]({'received':!![]});}catch(_0x346951){return logger_1[_0x30330e(0xcf)][_0x30330e(0xb6)]({'error':_0x346951},_0x30330e(0xc6)),_0x5c8b7a[_0x30330e(0xea)](0x190)[_0x30330e(0xb9)]({'error':_0x30330e(0xcd)});}};function a452_0x4c9f(){const _0x5700b7=['invoiceId','type','toString','(((.+)+)+)+$','../../utils/logger','/subscription/aa/webhook','2051870hlMprF','Error\x20handling\x20webhook\x20event.','webhookEndpoints','succeeded','__importDefault','stripe','constructor','usd','Webhook\x20handler\x20failed.','info','logger','__esModule','428800pICgTM','12YYHNsV','object','990825sEygao','Failed\x20to\x20create\x20subscription.','processInvoicePaid','retrieve','21868128frqrXd','stripeWebhookHandler','metadata','1248328SyNrtd','paymentIntents','default','create','BACKEND_URL','stripeCheckStatus','defineProperty','./PaymentGatewayServices','Payment\x20failed.','env','stripeInitialize:\x20not\x20configured\x20for\x20Stripe.','debug','findByPk','2022-11-15','Failed\x20to\x20create\x20webhook.','status','201334VCdihw','client_secret','../SettingServices/GetSuperSettingService','744108gChBwW','warn','stripeInitialize','stripeCreateSubscription','search','apply','Unhandled\x20event\x20type.','Webhook\x20created\x20successfully.','payment_intent.succeeded','240myCwiD','update','error','stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','https://','json','data','body','startsWith','Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.','_paymentGateway'];a452_0x4c9f=function(){return _0x5700b7;};return a452_0x4c9f();}exports['stripeWebhookHandler']=stripeWebhookHandler;const stripeCreateSubscription=async(_0x29ba71,_0x28b2b)=>{const _0x9a8f1e=a452_0x2a986a,{price:_0x4e21d3,invoiceId:_0x3d7e}=_0x29ba71['body'];try{const _0x5cb511=await stripe[_0x9a8f1e(0xdc)][_0x9a8f1e(0xde)]({'amount':Math['round'](parseFloat(_0x4e21d3)*0x64),'currency':_0x9a8f1e(0xcc),'metadata':{'invoiceId':_0x3d7e}});return await Invoices_1[_0x9a8f1e(0xdd)][_0x9a8f1e(0xb5)]({'stripePaymentIntentId':_0x5cb511['id']},{'where':{'id':_0x3d7e}}),_0x28b2b['json']({'clientSecret':_0x5cb511[_0x9a8f1e(0xec)],'status':'success'});}catch(_0x684a86){logger_1[_0x9a8f1e(0xcf)][_0x9a8f1e(0xb6)]({'error':_0x684a86},_0x9a8f1e(0xd5));throw new AppError_1[(_0x9a8f1e(0xdd))](_0x9a8f1e(0xd5),0x190);}};exports['stripeCreateSubscription']=stripeCreateSubscription;const stripeCheckStatus=async _0x19b533=>{const _0x572320=a452_0x2a986a;try{const _0x3c4456=await Invoices_1[_0x572320(0xdd)][_0x572320(0xe7)](_0x19b533);if(!_0x3c4456||!_0x3c4456['stripePaymentIntentId'])return logger_1['logger'][_0x572320(0xb6)](_0x572320(0xbd)),![];const _0x2d2101=await stripe[_0x572320(0xdc)][_0x572320(0xd7)](_0x3c4456['stripePaymentIntentId']);if(_0x2d2101[_0x572320(0xea)]===_0x572320(0xc8))return await(0x0,PaymentGatewayServices_1[_0x572320(0xd6)])(_0x3c4456),!![];return![];}catch(_0x31b1bd){return logger_1[_0x572320(0xcf)][_0x572320(0xb6)]({'error':_0x31b1bd},'Failed\x20to\x20check\x20payment\x20status.'),![];}};exports['stripeCheckStatus']=stripeCheckStatus;