const a450_0x2ef27d=a450_0x3030;(function(_0x21f8c4,_0x4337a9){const _0x36b934=a450_0x3030,_0x510abb=_0x21f8c4();while(!![]){try{const _0x179475=-parseInt(_0x36b934(0x1b7))/0x1+-parseInt(_0x36b934(0x192))/0x2*(parseInt(_0x36b934(0x199))/0x3)+parseInt(_0x36b934(0x16b))/0x4+-parseInt(_0x36b934(0x16c))/0x5+-parseInt(_0x36b934(0x170))/0x6+parseInt(_0x36b934(0x181))/0x7+parseInt(_0x36b934(0x172))/0x8;if(_0x179475===_0x4337a9)break;else _0x510abb['push'](_0x510abb['shift']());}catch(_0x12c11e){_0x510abb['push'](_0x510abb['shift']());}}}(a450_0x18d1,0xf1f27));const a450_0x4f8241=(function(){let _0x51fa9b=!![];return function(_0x3de141,_0x4c184a){const _0x26c1a6=_0x51fa9b?function(){if(_0x4c184a){const _0xfc5a7d=_0x4c184a['apply'](_0x3de141,arguments);return _0x4c184a=null,_0xfc5a7d;}}:function(){};return _0x51fa9b=![],_0x26c1a6;};}()),a450_0xace5c4=a450_0x4f8241(this,function(){const _0x558c89=a450_0x3030;return a450_0xace5c4[_0x558c89(0x18e)]()[_0x558c89(0x190)](_0x558c89(0x18b))[_0x558c89(0x18e)]()[_0x558c89(0x173)](a450_0xace5c4)['search']('(((.+)+)+)+$');});a450_0xace5c4();'use strict';var __importDefault=this&&this[a450_0x2ef27d(0x1a9)]||function(_0x37bb5e){const _0x5d793b=a450_0x2ef27d;return _0x37bb5e&&_0x37bb5e[_0x5d793b(0x1ae)]?_0x37bb5e:{'default':_0x37bb5e};};Object[a450_0x2ef27d(0x171)](exports,a450_0x2ef27d(0x1ae),{'value':!![]}),exports[a450_0x2ef27d(0x18a)]=exports[a450_0x2ef27d(0x180)]=exports[a450_0x2ef27d(0x196)]=exports['efiInitialize']=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a450_0x2ef27d(0x1a8))),path_1=__importDefault(require('path')),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require(a450_0x2ef27d(0x19f)),Invoices_1=__importDefault(require('../../models/Invoices')),Company_1=__importDefault(require(a450_0x2ef27d(0x17d))),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require(a450_0x2ef27d(0x195)),webhookUrl=process[a450_0x2ef27d(0x194)][a450_0x2ef27d(0x191)]+a450_0x2ef27d(0x17a);async function getEfiOptions(){const _0x56b802=a450_0x2ef27d,_0x5c44ad=path_1['default'][_0x56b802(0x17e)](__dirname,_0x56b802(0x174)+await(0x0,GetSuperSettingService_1[_0x56b802(0x17f)])({'key':_0x56b802(0x176)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x56b802(0x17f)])({'key':_0x56b802(0x1bb)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x56b802(0x17f)])({'key':'_efiClientSecret'}),'pix_cert':_0x5c44ad,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x5e95b8=a450_0x2ef27d,_0x429aef=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x5e95b8(0x17f))](_0x429aef);},createWebHook=async _0x84da55=>{const _0x413c50=a450_0x2ef27d,_0xf8c0de={'chave':await(0x0,GetSuperSettingService_1[_0x413c50(0x17f)])({'key':_0x413c50(0x1a2)})},_0x2206b5={'webhookUrl':webhookUrl};return _0x84da55[_0x413c50(0x1a5)](_0xf8c0de,_0x2206b5)[_0x413c50(0x19e)](_0x106602=>{const _0x1223da=_0x413c50;logger_1['logger'][_0x1223da(0x18c)]({'result':_0x106602},_0x1223da(0x1ad));},_0x1d7e08=>{const _0x2b22a4=_0x413c50;logger_1[_0x2b22a4(0x18d)][_0x2b22a4(0x1b9)]({'result':_0x1d7e08},_0x2b22a4(0x19d));});},efiInitialize=async()=>{const _0x16a6fa=a450_0x2ef27d,_0x446e78=await(0x0,GetSuperSettingService_1[_0x16a6fa(0x17f)])({'key':_0x16a6fa(0x1a7)});if(!webhookUrl['startsWith'](_0x16a6fa(0x186))){logger_1[_0x16a6fa(0x18d)][_0x16a6fa(0x1b1)]('efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported');return;}try{if(_0x446e78===_0x16a6fa(0x16d)){const _0x32f381=await getEfiOptions(),_0x4eae2d=new sdk_node_apis_efi_1['default'](_0x32f381),_0x5cf1d3={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x16a6fa(0x1a2)})};_0x4eae2d[_0x16a6fa(0x175)](_0x5cf1d3)['then'](_0x446684=>{const _0x264dfe=_0x16a6fa;_0x446684?.[_0x264dfe(0x1b4)]!==webhookUrl?createWebHook(_0x4eae2d):logger_1[_0x264dfe(0x18d)][_0x264dfe(0x1b1)]({'result':_0x446684},_0x264dfe(0x1ba));},_0x3e3adf=>{const _0x487e62=_0x16a6fa;_0x3e3adf?.[_0x487e62(0x177)]===_0x487e62(0x16e)?createWebHook(_0x4eae2d):logger_1[_0x487e62(0x18d)]['error'](_0x3e3adf,_0x487e62(0x1af));});}}catch(_0x38ee6a){logger_1['logger']['error'](_0x38ee6a,_0x16a6fa(0x187));}};function a450_0x18d1(){const _0x387166=['../../../private/','pixDetailWebhook','_efiCertFile','nome','teste_webhook','efiPollCheckStatus:\x20Invoice\x20','/subscription/aa/webhook','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','reload','../../models/Company','join','default','efiCheckStatus','13064296LgyzQt','all','pt-br','Recebido\x20valor\x20menor','pix','https://','efiInitialize:\x20','stringify','original','efiCreateSubscription','(((.+)+)+)+$','info','logger','toString','processInvoicePaid','search','BACKEND_URL','14356hPljNO','update','env','./PaymentGatewayServices','efiWebhook','value','Invoice\x20not\x20found','318mzxGZV','json','pixCopiaECola','pixCreateImmediateCharge','pixConfigWebhook\x20error:','then','../../utils/logger','efiCreateSubscription\x20error','Error\x20getting\x20detail\x20of\x20txid','_efiPixKey','txid','status','pixConfigWebhook','txId','_paymentGateway','sdk-node-apis-efi','__importDefault','valor','toLocaleString','efiInitialize','pixConfigWebhook\x20ok','__esModule','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','pixDetailCharge','debug','Processando\x20pagamento','body','webhookUrl','open','#Fatura:','1725571oaVCgo','map','error','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','_efiClientId','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','company','2241004buzpkm','9615235mfPJfL','efi','webhook_nao_encontrado','\x20already\x20paid,\x20finishing\x20polling','8640162GEqrhP','defineProperty','35311592hgGNsX','constructor'];a450_0x18d1=function(){return _0x387166;};return a450_0x18d1();}exports[a450_0x2ef27d(0x1ac)]=efiInitialize;const efiWebhook=async(_0x5aaa91,_0x51474d)=>{const _0x52675b=a450_0x2ef27d,{evento:_0x1e9455}=_0x5aaa91[_0x52675b(0x1b3)];if(_0x1e9455===_0x52675b(0x178))return _0x51474d[_0x52675b(0x19a)]({'ok':!![]});return _0x5aaa91[_0x52675b(0x1b3)][_0x52675b(0x185)]&&await Promise[_0x52675b(0x182)](_0x5aaa91[_0x52675b(0x1b3)]['pix'][_0x52675b(0x1b8)](async _0x567d8b=>{const _0x30d9b2=_0x52675b;logger_1[_0x30d9b2(0x18d)]['debug'](_0x567d8b,_0x30d9b2(0x1b2));const _0x501c14=await Invoices_1[_0x30d9b2(0x17f)]['findOne']({'where':{'txId':_0x567d8b[_0x30d9b2(0x1a3)],'status':_0x30d9b2(0x1b5)},'include':[{'model':Company_1[_0x30d9b2(0x17f)],'as':_0x30d9b2(0x1bd)}]});if(!_0x501c14){logger_1[_0x30d9b2(0x18d)]['debug'](_0x30d9b2(0x17b));return;}const _0x40e875=parseFloat(_0x567d8b[_0x30d9b2(0x1aa)]);if(_0x40e875<_0x501c14[_0x30d9b2(0x197)]){logger_1[_0x30d9b2(0x18d)][_0x30d9b2(0x1b1)](_0x30d9b2(0x184));return;}await(0x0,PaymentGatewayServices_1[_0x30d9b2(0x18f)])(_0x501c14);})),_0x51474d[_0x52675b(0x19a)]({'ok':!![]});};exports[a450_0x2ef27d(0x196)]=efiWebhook;const efiCheckStatus=async(_0x40b872,_0x498b96=null)=>{const _0xd9bcbb=a450_0x2ef27d;try{!_0x498b96&&(_0x498b96=await newEfiPayInstance());const _0x2cd7df=await _0x498b96[_0xd9bcbb(0x1b0)]({'txid':_0x40b872[_0xd9bcbb(0x1a6)]});if(_0x2cd7df[_0xd9bcbb(0x1a4)]!=='CONCLUIDA')return![];const {pix:_0x183da8}=_0x2cd7df,_0x11d8e5=parseFloat(_0x183da8[0x0]['valor']);if(_0x11d8e5>=_0x40b872[_0xd9bcbb(0x197)])return await(0x0,PaymentGatewayServices_1[_0xd9bcbb(0x18f)])(_0x40b872),!![];return![];}catch(_0xc5f760){logger_1[_0xd9bcbb(0x18d)][_0xd9bcbb(0x1b9)](_0xc5f760,_0xd9bcbb(0x1a1));}return![];};exports['efiCheckStatus']=efiCheckStatus;const efiPollCheckStatus=async(_0x2eef58,_0x16acc2,_0x4c16ea=0xa,_0x224072=0x7530)=>{let _0x5dc488=0x0;async function _0x41458d(){const _0x157d8b=a450_0x3030;await _0x16acc2[_0x157d8b(0x17c)]();if(_0x16acc2[_0x157d8b(0x1a4)]==='paid'){logger_1['logger'][_0x157d8b(0x1b1)](_0x157d8b(0x179)+_0x16acc2['id']+_0x157d8b(0x16f));return;}const _0x2056dd=await(0x0,exports['efiCheckStatus'])(_0x16acc2,_0x2eef58);if(_0x2056dd)return;_0x5dc488+=0x1;if(_0x5dc488>=_0x4c16ea){(0x0,PaymentGatewayServices_1['processInvoiceExpired'])(_0x16acc2);return;}await new Promise(_0x4a00d4=>setTimeout(_0x4a00d4,_0x224072)),await _0x41458d();}return _0x41458d();},efiCreateSubscription=async(_0x158d74,_0x5e25e7)=>{const _0x1aa48b=a450_0x2ef27d,{price:_0x279a35,invoiceId:_0x184296}=_0x158d74[_0x1aa48b(0x1b3)],_0x1e8078=parseFloat(_0x279a35),_0x35a58d={'calendario':{'expiracao':0x12c},'valor':{'original':_0x1e8078[_0x1aa48b(0x1ab)](_0x1aa48b(0x183),{'minimumFractionDigits':0x2})['replace'](',','.')},'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x1aa48b(0x1a2)}),'solicitacaoPagador':_0x1aa48b(0x1b6)+_0x184296},_0x3e711e=await getEfiOptions();try{const _0x3dea7c=await Invoices_1[_0x1aa48b(0x17f)]['findByPk'](_0x184296);if(!_0x3dea7c)throw new Error(_0x1aa48b(0x198));await(0x0,exports[_0x1aa48b(0x1ac)])();const _0x23c237=new sdk_node_apis_efi_1[(_0x1aa48b(0x17f))](_0x3e711e),_0x2270cc=await _0x23c237[_0x1aa48b(0x19c)]([],_0x35a58d);return await _0x3dea7c[_0x1aa48b(0x193)]({'txId':_0x2270cc[_0x1aa48b(0x1a3)],'payGw':_0x1aa48b(0x16d),'payGwData':JSON[_0x1aa48b(0x188)](_0x2270cc)}),await _0x3dea7c[_0x1aa48b(0x17c)](),efiPollCheckStatus(_0x23c237,_0x3dea7c),_0x5e25e7[_0x1aa48b(0x19a)]({'qrcode':{'qrcode':_0x2270cc[_0x1aa48b(0x19b)]},'valor':{'original':_0x35a58d['valor'][_0x1aa48b(0x189)]}});}catch(_0x51f008){logger_1[_0x1aa48b(0x18d)][_0x1aa48b(0x1b9)]({'efiOptions':_0x3e711e,'error':_0x51f008},_0x1aa48b(0x1a0));throw new AppError_1[(_0x1aa48b(0x17f))](_0x1aa48b(0x1bc),0x190);}};function a450_0x3030(_0x5ef05f,_0x386859){const _0x487010=a450_0x18d1();return a450_0x3030=function(_0xace5c4,_0x4f8241){_0xace5c4=_0xace5c4-0x16b;let _0x18d12f=_0x487010[_0xace5c4];return _0x18d12f;},a450_0x3030(_0x5ef05f,_0x386859);}exports[a450_0x2ef27d(0x18a)]=efiCreateSubscription;