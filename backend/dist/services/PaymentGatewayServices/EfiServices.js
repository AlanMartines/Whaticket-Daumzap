const a450_0x5a8d31=a450_0x5072;function a450_0x5072(_0x52c481,_0x5e2155){const _0x13692e=a450_0x1346();return a450_0x5072=function(_0x103d09,_0x24a9ba){_0x103d09=_0x103d09-0x64;let _0x1346aa=_0x13692e[_0x103d09];return _0x1346aa;},a450_0x5072(_0x52c481,_0x5e2155);}(function(_0x481691,_0x1d884c){const _0x50bbcd=a450_0x5072,_0x3cb121=_0x481691();while(!![]){try{const _0x511b0e=parseInt(_0x50bbcd(0xad))/0x1*(-parseInt(_0x50bbcd(0x91))/0x2)+-parseInt(_0x50bbcd(0x7e))/0x3+-parseInt(_0x50bbcd(0xb2))/0x4+parseInt(_0x50bbcd(0x9a))/0x5+parseInt(_0x50bbcd(0x65))/0x6+parseInt(_0x50bbcd(0x9d))/0x7+parseInt(_0x50bbcd(0xa9))/0x8;if(_0x511b0e===_0x1d884c)break;else _0x3cb121['push'](_0x3cb121['shift']());}catch(_0xef6e0b){_0x3cb121['push'](_0x3cb121['shift']());}}}(a450_0x1346,0xc7a0f));function a450_0x1346(){const _0xaf1d10=['efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','3696584bsqzBe','Invoice\x20not\x20found','valor','findByPk','9474912Edswzt','all','../SettingServices/GetSuperSettingService','CONCLUIDA','pixCreateImmediateCharge','toString','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','findOne','info','webhook_nao_encontrado','Recebido\x20valor\x20menor','webhookUrl','__importDefault','logger','pixCopiaECola','pix','debug','efiCreateSubscription','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','txid','_efiCertFile','sdk-node-apis-efi','reload','../../models/Invoices','startsWith','399588lXsisQ','map','processInvoiceExpired','env','original','../../utils/logger','Error\x20getting\x20detail\x20of\x20txid','status','value','pixConfigWebhook','_efiClientSecret','Processando\x20pagamento','open','teste_webhook','pixConfigWebhook\x20ok','_efiClientId','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','pixDetailCharge','pixConfigWebhook\x20error:','2EzAfCW','efiWebhook','stringify','body','default','efi','search','json','_efiPixKey','568075FfCZtu','efiInitialize','txId','8484196vITwOw','constructor','replace','../../models/Company','__esModule','defineProperty','then','(((.+)+)+)+$','/subscription/aa/webhook','https://','error','efiCheckStatus','4346440iQItBX','processInvoicePaid','efiInitialize:\x20','update','1573079bKKwuU','../../../private/','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','\x20already\x20paid,\x20finishing\x20polling'];a450_0x1346=function(){return _0xaf1d10;};return a450_0x1346();}const a450_0x24a9ba=(function(){let _0x21f081=!![];return function(_0x576073,_0x3f6693){const _0x59fd16=_0x21f081?function(){if(_0x3f6693){const _0x3230bd=_0x3f6693['apply'](_0x576073,arguments);return _0x3f6693=null,_0x3230bd;}}:function(){};return _0x21f081=![],_0x59fd16;};}()),a450_0x103d09=a450_0x24a9ba(this,function(){const _0x387cfb=a450_0x5072;return a450_0x103d09[_0x387cfb(0x6a)]()['search'](_0x387cfb(0xa4))[_0x387cfb(0x6a)]()[_0x387cfb(0x9e)](a450_0x103d09)[_0x387cfb(0x97)](_0x387cfb(0xa4));});a450_0x103d09();'use strict';var __importDefault=this&&this[a450_0x5a8d31(0x71)]||function(_0x555ae9){const _0x14d7d9=a450_0x5a8d31;return _0x555ae9&&_0x555ae9[_0x14d7d9(0xa1)]?_0x555ae9:{'default':_0x555ae9};};Object[a450_0x5a8d31(0xa2)](exports,a450_0x5a8d31(0xa1),{'value':!![]}),exports[a450_0x5a8d31(0x76)]=exports[a450_0x5a8d31(0xa8)]=exports[a450_0x5a8d31(0x92)]=exports[a450_0x5a8d31(0x9b)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a450_0x5a8d31(0x7a))),path_1=__importDefault(require('path')),GetSuperSettingService_1=__importDefault(require(a450_0x5a8d31(0x67))),logger_1=require(a450_0x5a8d31(0x83)),Invoices_1=__importDefault(require(a450_0x5a8d31(0x7c))),Company_1=__importDefault(require(a450_0x5a8d31(0xa0))),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require('./PaymentGatewayServices'),webhookUrl=process[a450_0x5a8d31(0x81)]['BACKEND_URL']+a450_0x5a8d31(0xa5);async function getEfiOptions(){const _0x5c6359=a450_0x5a8d31,_0x4c3182=path_1[_0x5c6359(0x95)]['join'](__dirname,_0x5c6359(0xae)+await(0x0,GetSuperSettingService_1[_0x5c6359(0x95)])({'key':_0x5c6359(0x79)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x5c6359(0x95)])({'key':_0x5c6359(0x8d)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x5c6359(0x95)])({'key':_0x5c6359(0x88)}),'pix_cert':_0x4c3182,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x3f9d2e=await getEfiOptions();return new sdk_node_apis_efi_1['default'](_0x3f9d2e);},createWebHook=async _0x3e80ee=>{const _0x43a4aa=a450_0x5a8d31,_0xf3f31a={'chave':await(0x0,GetSuperSettingService_1[_0x43a4aa(0x95)])({'key':_0x43a4aa(0x99)})},_0x7331d8={'webhookUrl':webhookUrl};return _0x3e80ee[_0x43a4aa(0x87)](_0xf3f31a,_0x7331d8)[_0x43a4aa(0xa3)](_0x33dc09=>{const _0x17e2c8=_0x43a4aa;logger_1['logger'][_0x17e2c8(0x6d)]({'result':_0x33dc09},_0x17e2c8(0x8c));},_0x8ff23f=>{const _0x42333b=_0x43a4aa;logger_1[_0x42333b(0x72)][_0x42333b(0xa7)]({'result':_0x8ff23f},_0x42333b(0x90));});},efiInitialize=async()=>{const _0x4c9ea7=a450_0x5a8d31,_0x47ba3e=await(0x0,GetSuperSettingService_1[_0x4c9ea7(0x95)])({'key':'_paymentGateway'});if(!webhookUrl[_0x4c9ea7(0x7d)](_0x4c9ea7(0xa6))){logger_1[_0x4c9ea7(0x72)]['debug'](_0x4c9ea7(0xaf));return;}try{if(_0x47ba3e===_0x4c9ea7(0x96)){const _0x2d85cc=await getEfiOptions(),_0x145a8a=new sdk_node_apis_efi_1[(_0x4c9ea7(0x95))](_0x2d85cc),_0x44c547={'chave':await(0x0,GetSuperSettingService_1[_0x4c9ea7(0x95)])({'key':'_efiPixKey'})};_0x145a8a['pixDetailWebhook'](_0x44c547)[_0x4c9ea7(0xa3)](_0x41eefa=>{const _0x3cee27=_0x4c9ea7;_0x41eefa?.[_0x3cee27(0x70)]!==webhookUrl?createWebHook(_0x145a8a):logger_1[_0x3cee27(0x72)]['debug']({'result':_0x41eefa},_0x3cee27(0x77));},_0x509826=>{const _0x27356f=_0x4c9ea7;_0x509826?.['nome']===_0x27356f(0x6e)?createWebHook(_0x145a8a):logger_1[_0x27356f(0x72)][_0x27356f(0xa7)](_0x509826,_0x27356f(0x6b));});}}catch(_0x1e4d81){logger_1[_0x4c9ea7(0x72)][_0x4c9ea7(0xa7)](_0x1e4d81,_0x4c9ea7(0xab));}};exports[a450_0x5a8d31(0x9b)]=efiInitialize;const efiWebhook=async(_0x3d6973,_0x282f22)=>{const _0x5b6a23=a450_0x5a8d31,{evento:_0x42f348}=_0x3d6973[_0x5b6a23(0x94)];if(_0x42f348===_0x5b6a23(0x8b))return _0x282f22['json']({'ok':!![]});return _0x3d6973[_0x5b6a23(0x94)][_0x5b6a23(0x74)]&&await Promise[_0x5b6a23(0x66)](_0x3d6973[_0x5b6a23(0x94)][_0x5b6a23(0x74)][_0x5b6a23(0x7f)](async _0x2401a0=>{const _0x53e234=_0x5b6a23;logger_1['logger'][_0x53e234(0x75)](_0x2401a0,_0x53e234(0x89));const _0x583d16=await Invoices_1[_0x53e234(0x95)][_0x53e234(0x6c)]({'where':{'txId':_0x2401a0['txid'],'status':_0x53e234(0x8a)},'include':[{'model':Company_1[_0x53e234(0x95)],'as':'company'}]});if(!_0x583d16){logger_1['logger'][_0x53e234(0x75)](_0x53e234(0xb1));return;}const _0x562159=parseFloat(_0x2401a0[_0x53e234(0xb4)]);if(_0x562159<_0x583d16[_0x53e234(0x86)]){logger_1[_0x53e234(0x72)][_0x53e234(0x75)](_0x53e234(0x6f));return;}await(0x0,PaymentGatewayServices_1[_0x53e234(0xaa)])(_0x583d16);})),_0x282f22[_0x5b6a23(0x98)]({'ok':!![]});};exports[a450_0x5a8d31(0x92)]=efiWebhook;const efiCheckStatus=async(_0x4e9cd2,_0x1a3d8d=null)=>{const _0x4456e8=a450_0x5a8d31;try{!_0x1a3d8d&&(_0x1a3d8d=await newEfiPayInstance());const _0x160e8d=await _0x1a3d8d[_0x4456e8(0x8f)]({'txid':_0x4e9cd2[_0x4456e8(0x9c)]});if(_0x160e8d['status']!==_0x4456e8(0x68))return![];const {pix:_0x18a53a}=_0x160e8d,_0x393ea0=parseFloat(_0x18a53a[0x0][_0x4456e8(0xb4)]);if(_0x393ea0>=_0x4e9cd2[_0x4456e8(0x86)])return await(0x0,PaymentGatewayServices_1[_0x4456e8(0xaa)])(_0x4e9cd2),!![];return![];}catch(_0x2e3de0){logger_1[_0x4456e8(0x72)][_0x4456e8(0xa7)](_0x2e3de0,_0x4456e8(0x84));}return![];};exports[a450_0x5a8d31(0xa8)]=efiCheckStatus;const efiPollCheckStatus=async(_0xf8ea,_0xd8a5aa,_0x191781=0xa,_0x1519be=0x7530)=>{let _0x525584=0x0;async function _0x5cf92c(){const _0x4ba7c5=a450_0x5072;await _0xd8a5aa[_0x4ba7c5(0x7b)]();if(_0xd8a5aa[_0x4ba7c5(0x85)]==='paid'){logger_1['logger'][_0x4ba7c5(0x75)]('efiPollCheckStatus:\x20Invoice\x20'+_0xd8a5aa['id']+_0x4ba7c5(0xb0));return;}const _0x3665df=await(0x0,exports['efiCheckStatus'])(_0xd8a5aa,_0xf8ea);if(_0x3665df)return;_0x525584+=0x1;if(_0x525584>=_0x191781){(0x0,PaymentGatewayServices_1[_0x4ba7c5(0x80)])(_0xd8a5aa);return;}await new Promise(_0x4bd195=>setTimeout(_0x4bd195,_0x1519be)),await _0x5cf92c();}return _0x5cf92c();},efiCreateSubscription=async(_0x6d8c28,_0x1203df)=>{const _0x5a356d=a450_0x5a8d31,{price:_0x2789e9,invoiceId:_0x435104}=_0x6d8c28['body'],_0x52f8d4=parseFloat(_0x2789e9),_0x4c53cd={'calendario':{'expiracao':0x12c},'valor':{'original':_0x52f8d4['toLocaleString']('pt-br',{'minimumFractionDigits':0x2})[_0x5a356d(0x9f)](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x5a356d(0x95)])({'key':_0x5a356d(0x99)}),'solicitacaoPagador':'#Fatura:'+_0x435104},_0x485334=await getEfiOptions();try{const _0x1ce15d=await Invoices_1[_0x5a356d(0x95)][_0x5a356d(0x64)](_0x435104);if(!_0x1ce15d)throw new Error(_0x5a356d(0xb3));await(0x0,exports[_0x5a356d(0x9b)])();const _0x46721e=new sdk_node_apis_efi_1[(_0x5a356d(0x95))](_0x485334),_0x3ed80a=await _0x46721e[_0x5a356d(0x69)]([],_0x4c53cd);return await _0x1ce15d[_0x5a356d(0xac)]({'txId':_0x3ed80a[_0x5a356d(0x78)],'payGw':_0x5a356d(0x96),'payGwData':JSON[_0x5a356d(0x93)](_0x3ed80a)}),await _0x1ce15d[_0x5a356d(0x7b)](),efiPollCheckStatus(_0x46721e,_0x1ce15d),_0x1203df['json']({'qrcode':{'qrcode':_0x3ed80a[_0x5a356d(0x73)]},'valor':{'original':_0x4c53cd['valor'][_0x5a356d(0x82)]}});}catch(_0x545482){logger_1[_0x5a356d(0x72)][_0x5a356d(0xa7)]({'efiOptions':_0x485334,'error':_0x545482},'efiCreateSubscription\x20error');throw new AppError_1[(_0x5a356d(0x95))](_0x5a356d(0x8e),0x190);}};exports[a450_0x5a8d31(0x76)]=efiCreateSubscription;