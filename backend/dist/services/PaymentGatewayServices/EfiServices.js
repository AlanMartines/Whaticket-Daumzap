const a450_0x3d6ac6=a450_0x5514;(function(_0x500845,_0x40b0b8){const _0x448355=a450_0x5514,_0x4beb07=_0x500845();while(!![]){try{const _0x52d79d=-parseInt(_0x448355(0x82))/0x1*(parseInt(_0x448355(0xce))/0x2)+parseInt(_0x448355(0xaf))/0x3*(-parseInt(_0x448355(0xd6))/0x4)+parseInt(_0x448355(0xbf))/0x5+-parseInt(_0x448355(0xad))/0x6*(parseInt(_0x448355(0xca))/0x7)+-parseInt(_0x448355(0x8d))/0x8*(-parseInt(_0x448355(0x95))/0x9)+-parseInt(_0x448355(0x9d))/0xa*(-parseInt(_0x448355(0xa8))/0xb)+-parseInt(_0x448355(0xcc))/0xc*(-parseInt(_0x448355(0x8f))/0xd);if(_0x52d79d===_0x40b0b8)break;else _0x4beb07['push'](_0x4beb07['shift']());}catch(_0x1921f4){_0x4beb07['push'](_0x4beb07['shift']());}}}(a450_0x55f3,0x41e58));const a450_0x23d85b=(function(){let _0x415212=!![];return function(_0x26f8d9,_0x317973){const _0x25d24f=_0x415212?function(){const _0x898ea1=a450_0x5514;if(_0x317973){const _0x50e3f0=_0x317973[_0x898ea1(0xb7)](_0x26f8d9,arguments);return _0x317973=null,_0x50e3f0;}}:function(){};return _0x415212=![],_0x25d24f;};}()),a450_0x10ea94=a450_0x23d85b(this,function(){const _0x24d510=a450_0x5514;return a450_0x10ea94[_0x24d510(0xa6)]()[_0x24d510(0xa3)](_0x24d510(0x99))['toString']()[_0x24d510(0x86)](a450_0x10ea94)[_0x24d510(0xa3)]('(((.+)+)+)+$');});a450_0x10ea94();'use strict';var __importDefault=this&&this[a450_0x3d6ac6(0xb8)]||function(_0x92b22f){const _0x32d89b=a450_0x3d6ac6;return _0x92b22f&&_0x92b22f[_0x32d89b(0xb6)]?_0x92b22f:{'default':_0x92b22f};};Object[a450_0x3d6ac6(0xbd)](exports,'__esModule',{'value':!![]}),exports[a450_0x3d6ac6(0x84)]=exports[a450_0x3d6ac6(0x91)]=exports[a450_0x3d6ac6(0xc7)]=exports['efiInitialize']=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a450_0x3d6ac6(0x89))),path_1=__importDefault(require('path')),GetSuperSettingService_1=__importDefault(require(a450_0x3d6ac6(0xd2))),logger_1=require(a450_0x3d6ac6(0xb2)),Invoices_1=__importDefault(require(a450_0x3d6ac6(0xc6))),Company_1=__importDefault(require('../../models/Company')),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require(a450_0x3d6ac6(0x92)),webhookUrl=process[a450_0x3d6ac6(0xcf)][a450_0x3d6ac6(0x98)]+a450_0x3d6ac6(0xac);async function getEfiOptions(){const _0x2972cf=a450_0x3d6ac6,_0x4fc86b=path_1[_0x2972cf(0xbc)][_0x2972cf(0x94)](__dirname,'../../../private/'+await(0x0,GetSuperSettingService_1[_0x2972cf(0xbc)])({'key':_0x2972cf(0xa9)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x2972cf(0xbc)])({'key':'_efiClientId'}),'client_secret':await(0x0,GetSuperSettingService_1[_0x2972cf(0xbc)])({'key':'_efiClientSecret'}),'pix_cert':_0x4fc86b,'validateMtls':![]};}function a450_0x5514(_0x4bfa69,_0x5f4383){const _0x5ab6a8=a450_0x55f3();return a450_0x5514=function(_0x10ea94,_0x23d85b){_0x10ea94=_0x10ea94-0x82;let _0x55f313=_0x5ab6a8[_0x10ea94];return _0x55f313;},a450_0x5514(_0x4bfa69,_0x5f4383);}const newEfiPayInstance=async()=>{const _0x4e348b=a450_0x3d6ac6,_0x5da3=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x4e348b(0xbc))](_0x5da3);},createWebHook=async _0x27f72c=>{const _0x2ec8d0=a450_0x3d6ac6,_0xa08447={'chave':await(0x0,GetSuperSettingService_1[_0x2ec8d0(0xbc)])({'key':_0x2ec8d0(0x83)})},_0x1b056c={'webhookUrl':webhookUrl};return _0x27f72c[_0x2ec8d0(0x8a)](_0xa08447,_0x1b056c)[_0x2ec8d0(0xc2)](_0x8880c2=>{const _0x595617=_0x2ec8d0;logger_1['logger'][_0x595617(0xba)]({'result':_0x8880c2},_0x595617(0x90));},_0x32f5c7=>{const _0xd4c4f=_0x2ec8d0;logger_1[_0xd4c4f(0xd1)][_0xd4c4f(0x93)]({'result':_0x32f5c7},_0xd4c4f(0x8b));});},efiInitialize=async()=>{const _0x1cd1e=a450_0x3d6ac6,_0x500fa=await(0x0,GetSuperSettingService_1[_0x1cd1e(0xbc)])({'key':_0x1cd1e(0xab)});if(!webhookUrl['startsWith'](_0x1cd1e(0xa2))){logger_1[_0x1cd1e(0xd1)][_0x1cd1e(0x97)](_0x1cd1e(0xc0));return;}try{if(_0x500fa==='efi'){const _0x1a062f=await getEfiOptions(),_0x5383e1=new sdk_node_apis_efi_1['default'](_0x1a062f),_0x22acc0={'chave':await(0x0,GetSuperSettingService_1[_0x1cd1e(0xbc)])({'key':_0x1cd1e(0x83)})};_0x5383e1[_0x1cd1e(0xc8)](_0x22acc0)[_0x1cd1e(0xc2)](_0x2399e5=>{const _0x211345=_0x1cd1e;_0x2399e5?.[_0x211345(0xa1)]!==webhookUrl?createWebHook(_0x5383e1):logger_1[_0x211345(0xd1)][_0x211345(0x97)]({'result':_0x2399e5},'efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado');},_0x44fa21=>{const _0x2ff268=_0x1cd1e;_0x44fa21?.['nome']===_0x2ff268(0x9b)?createWebHook(_0x5383e1):logger_1[_0x2ff268(0xd1)][_0x2ff268(0x93)](_0x44fa21,_0x2ff268(0xae));});}}catch(_0xecdeed){logger_1[_0x1cd1e(0xd1)][_0x1cd1e(0x93)](_0xecdeed,_0x1cd1e(0x8e));}};exports[a450_0x3d6ac6(0xcd)]=efiInitialize;const efiWebhook=async(_0x299e6d,_0x434900)=>{const _0x5c74a2=a450_0x3d6ac6,{evento:_0x4b1d34}=_0x299e6d['body'];if(_0x4b1d34==='teste_webhook')return _0x434900[_0x5c74a2(0xb3)]({'ok':!![]});return _0x299e6d[_0x5c74a2(0x9f)]['pix']&&await Promise[_0x5c74a2(0xb5)](_0x299e6d[_0x5c74a2(0x9f)][_0x5c74a2(0xc5)][_0x5c74a2(0x85)](async _0x97eae5=>{const _0x3d84eb=_0x5c74a2;logger_1[_0x3d84eb(0xd1)][_0x3d84eb(0x97)](_0x97eae5,'Processando\x20pagamento');const _0x598235=await Invoices_1[_0x3d84eb(0xbc)][_0x3d84eb(0xc9)]({'where':{'txId':_0x97eae5[_0x3d84eb(0xd3)],'status':'open'},'include':[{'model':Company_1[_0x3d84eb(0xbc)],'as':_0x3d84eb(0xcb)}]});if(!_0x598235){logger_1[_0x3d84eb(0xd1)][_0x3d84eb(0x97)](_0x3d84eb(0xb4));return;}const _0x4ca75e=parseFloat(_0x97eae5[_0x3d84eb(0xbb)]);if(_0x4ca75e<_0x598235[_0x3d84eb(0xc3)]){logger_1[_0x3d84eb(0xd1)][_0x3d84eb(0x97)](_0x3d84eb(0xbe));return;}await(0x0,PaymentGatewayServices_1[_0x3d84eb(0xd5)])(_0x598235);})),_0x434900[_0x5c74a2(0xb3)]({'ok':!![]});};function a450_0x55f3(){const _0x47c249=['312VLIazO','efiInitialize','8924ALmAnY','env','reload','logger','../SettingServices/GetSuperSettingService','txid','pixCopiaECola','processInvoicePaid','1332UetAdM','12AWmRRr','_efiPixKey','efiCreateSubscription','map','constructor','original','efi','sdk-node-apis-efi','pixConfigWebhook','pixConfigWebhook\x20error:','CONCLUIDA','8MmInWx','efiInitialize:\x20','359359CvVsRv','pixConfigWebhook\x20ok','efiCheckStatus','./PaymentGatewayServices','error','join','1672209BlYYeN','\x20already\x20paid,\x20finishing\x20polling','debug','BACKEND_URL','(((.+)+)+)+$','pixCreateImmediateCharge','webhook_nao_encontrado','processInvoiceExpired','10FVlnHS','paid','body','pixDetailCharge','webhookUrl','https://','search','Invoice\x20not\x20found','replace','toString','stringify','176561TFQPGL','_efiCertFile','pt-br','_paymentGateway','/subscription/aa/webhook','2096214AKfjxK','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','4506IekekJ','#Fatura:','findByPk','../../utils/logger','json','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','all','__esModule','apply','__importDefault','Error\x20getting\x20detail\x20of\x20txid','info','valor','default','defineProperty','Recebido\x20valor\x20menor','1262105sUCkbM','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','efiCreateSubscription\x20error','then','value','status','pix','../../models/Invoices','efiWebhook','pixDetailWebhook','findOne','7UzATiH','company'];a450_0x55f3=function(){return _0x47c249;};return a450_0x55f3();}exports[a450_0x3d6ac6(0xc7)]=efiWebhook;const efiCheckStatus=async(_0x47fcf8,_0x38bd0e=null)=>{const _0x2125e4=a450_0x3d6ac6;try{!_0x38bd0e&&(_0x38bd0e=await newEfiPayInstance());const _0x376fff=await _0x38bd0e[_0x2125e4(0xa0)]({'txid':_0x47fcf8['txId']});if(_0x376fff[_0x2125e4(0xc4)]!==_0x2125e4(0x8c))return![];const {pix:_0x1ba5f5}=_0x376fff,_0x431c7b=parseFloat(_0x1ba5f5[0x0][_0x2125e4(0xbb)]);if(_0x431c7b>=_0x47fcf8[_0x2125e4(0xc3)])return await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x47fcf8),!![];return![];}catch(_0x5d310c){logger_1[_0x2125e4(0xd1)][_0x2125e4(0x93)](_0x5d310c,_0x2125e4(0xb9));}return![];};exports['efiCheckStatus']=efiCheckStatus;const efiPollCheckStatus=async(_0x4c5c10,_0x18a9a3,_0x4d997b=0xa,_0x131ca6=0x7530)=>{let _0x5a41b2=0x0;async function _0x5a351d(){const _0x1d9a2a=a450_0x5514;await _0x18a9a3[_0x1d9a2a(0xd0)]();if(_0x18a9a3[_0x1d9a2a(0xc4)]===_0x1d9a2a(0x9e)){logger_1['logger']['debug']('efiPollCheckStatus:\x20Invoice\x20'+_0x18a9a3['id']+_0x1d9a2a(0x96));return;}const _0x26187e=await(0x0,exports['efiCheckStatus'])(_0x18a9a3,_0x4c5c10);if(_0x26187e)return;_0x5a41b2+=0x1;if(_0x5a41b2>=_0x4d997b){(0x0,PaymentGatewayServices_1[_0x1d9a2a(0x9c)])(_0x18a9a3);return;}await new Promise(_0x19753e=>setTimeout(_0x19753e,_0x131ca6)),await _0x5a351d();}return _0x5a351d();},efiCreateSubscription=async(_0x3139a3,_0x19d78d)=>{const _0x5865ac=a450_0x3d6ac6,{price:_0x3ceb63,invoiceId:_0x1d938b}=_0x3139a3[_0x5865ac(0x9f)],_0x3a9788=parseFloat(_0x3ceb63),_0x3807b6={'calendario':{'expiracao':0x12c},'valor':{'original':_0x3a9788['toLocaleString'](_0x5865ac(0xaa),{'minimumFractionDigits':0x2})[_0x5865ac(0xa5)](',','.')},'chave':await(0x0,GetSuperSettingService_1['default'])({'key':'_efiPixKey'}),'solicitacaoPagador':_0x5865ac(0xb0)+_0x1d938b},_0x9a04b7=await getEfiOptions();try{const _0x1410a5=await Invoices_1['default'][_0x5865ac(0xb1)](_0x1d938b);if(!_0x1410a5)throw new Error(_0x5865ac(0xa4));await(0x0,exports[_0x5865ac(0xcd)])();const _0x43e5da=new sdk_node_apis_efi_1[(_0x5865ac(0xbc))](_0x9a04b7),_0xce2f45=await _0x43e5da[_0x5865ac(0x9a)]([],_0x3807b6);return await _0x1410a5['update']({'txId':_0xce2f45[_0x5865ac(0xd3)],'payGw':_0x5865ac(0x88),'payGwData':JSON[_0x5865ac(0xa7)](_0xce2f45)}),await _0x1410a5[_0x5865ac(0xd0)](),efiPollCheckStatus(_0x43e5da,_0x1410a5),_0x19d78d[_0x5865ac(0xb3)]({'qrcode':{'qrcode':_0xce2f45[_0x5865ac(0xd4)]},'valor':{'original':_0x3807b6[_0x5865ac(0xbb)][_0x5865ac(0x87)]}});}catch(_0x2daee8){logger_1[_0x5865ac(0xd1)]['error']({'efiOptions':_0x9a04b7,'error':_0x2daee8},_0x5865ac(0xc1));throw new AppError_1['default']('Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!',0x190);}};exports['efiCreateSubscription']=efiCreateSubscription;