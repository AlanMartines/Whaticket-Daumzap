const a451_0x3b5ef9=a451_0x1e60;(function(_0x5a7ae1,_0x56844b){const _0x160f89=a451_0x1e60,_0x428072=_0x5a7ae1();while(!![]){try{const _0x1cf49b=-parseInt(_0x160f89(0x1ea))/0x1+-parseInt(_0x160f89(0x1bd))/0x2+parseInt(_0x160f89(0x1c4))/0x3*(parseInt(_0x160f89(0x1ee))/0x4)+-parseInt(_0x160f89(0x1e9))/0x5+-parseInt(_0x160f89(0x1e1))/0x6+-parseInt(_0x160f89(0x1d9))/0x7+parseInt(_0x160f89(0x1c3))/0x8;if(_0x1cf49b===_0x56844b)break;else _0x428072['push'](_0x428072['shift']());}catch(_0x4a463b){_0x428072['push'](_0x428072['shift']());}}}(a451_0xc42b,0x35526));const a451_0x360c4a=(function(){let _0x3c6200=!![];return function(_0xf92d1a,_0x5ebde2){const _0x543487=_0x3c6200?function(){const _0x423a04=a451_0x1e60;if(_0x5ebde2){const _0x3d5e82=_0x5ebde2[_0x423a04(0x1e0)](_0xf92d1a,arguments);return _0x5ebde2=null,_0x3d5e82;}}:function(){};return _0x3c6200=![],_0x543487;};}()),a451_0x22b2bd=a451_0x360c4a(this,function(){const _0x21d637=a451_0x1e60;return a451_0x22b2bd[_0x21d637(0x1eb)]()[_0x21d637(0x1e8)](_0x21d637(0x1ec))['toString']()[_0x21d637(0x1d2)](a451_0x22b2bd)['search'](_0x21d637(0x1ec));});a451_0x22b2bd();'use strict';var __importDefault=this&&this[a451_0x3b5ef9(0x1db)]||function(_0x1bf2c5){return _0x1bf2c5&&_0x1bf2c5['__esModule']?_0x1bf2c5:{'default':_0x1bf2c5};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a451_0x3b5ef9(0x1c6)]=exports[a451_0x3b5ef9(0x1c2)]=exports[a451_0x3b5ef9(0x1e6)]=exports[a451_0x3b5ef9(0x1bf)]=exports[a451_0x3b5ef9(0x1f1)]=exports[a451_0x3b5ef9(0x1ef)]=exports['payGatewayInitialize']=void 0x0;const AppError_1=__importDefault(require('../../errors/AppError')),GetSuperSettingService_1=__importDefault(require(a451_0x3b5ef9(0x1dd))),EfiServices_1=require(a451_0x3b5ef9(0x1d3)),StripeServices_1=require(a451_0x3b5ef9(0x1de)),Invoices_1=__importDefault(require('../../models/Invoices')),socket_1=require(a451_0x3b5ef9(0x1f0)),Company_1=__importDefault(require(a451_0x3b5ef9(0x1c9))),FindOpenInvoiceService_1=__importDefault(require(a451_0x3b5ef9(0x1be))),payGatewayInitialize=async()=>{const _0x3f2f90=a451_0x3b5ef9,_0xe266de=await(0x0,GetSuperSettingService_1[_0x3f2f90(0x1f4)])({'key':_0x3f2f90(0x1dc)});switch(_0xe266de){case _0x3f2f90(0x1e3):return(0x0,EfiServices_1[_0x3f2f90(0x1df)])();case _0x3f2f90(0x1cb):return(0x0,StripeServices_1[_0x3f2f90(0x1f3)])();default:throw new AppError_1[(_0x3f2f90(0x1f4))](_0x3f2f90(0x1c5),0x190);}};exports[a451_0x3b5ef9(0x1cc)]=payGatewayInitialize;const payGatewayCreateSubscription=async(_0x56a6ce,_0x4fb8e7)=>{const _0x208aee=a451_0x3b5ef9,_0x4f8db1=await(0x0,GetSuperSettingService_1[_0x208aee(0x1f4)])({'key':_0x208aee(0x1dc)});switch(_0x4f8db1){case _0x208aee(0x1e3):return(0x0,EfiServices_1[_0x208aee(0x1e2)])(_0x56a6ce,_0x4fb8e7);case _0x208aee(0x1cb):return(0x0,StripeServices_1[_0x208aee(0x1c8)])(_0x56a6ce,_0x4fb8e7);default:throw new AppError_1[(_0x208aee(0x1f4))](_0x208aee(0x1c5),0x190);}};function a451_0xc42b(){const _0x5e01a8=['emit','stripeCreateSubscription','../../models/Company','reload','stripe','payGatewayInitialize','dueDate','CONCLUIDA','-payment','company-','super','constructor','./EfiServices','efiCheckStatus','update','forEach','EXPIRADA','getIO','1263381qSYSri','getDate','__importDefault','_paymentGateway','../SettingServices/GetSuperSettingService','./StripeServices','efiInitialize','apply','1065966IsNRjk','efiCreateSubscription','efi','-mainchannel','company','processInvoiceExpired','stripeCheckStatus','search','335990mPCcRd','374509wDbslV','toString','(((.+)+)+)+$','findByPk','4GmZAcM','payGatewayCreateSubscription','../../libs/socket','payGatewayReceiveWebhook','payGw','stripeInitialize','default','309352wOIZDQ','../InvoicesService/FindOpenInvoiceService','processInvoicePaid','stripeWebhookHandler','companyId','checkInvoicePayment','6057808EiJMsX','1247121oHBFEh','Unsupported\x20payment\x20gateway','checkOpenInvoices'];a451_0xc42b=function(){return _0x5e01a8;};return a451_0xc42b();}exports['payGatewayCreateSubscription']=payGatewayCreateSubscription;function a451_0x1e60(_0x1022b2,_0x53569d){const _0x4e3026=a451_0xc42b();return a451_0x1e60=function(_0x22b2bd,_0x360c4a){_0x22b2bd=_0x22b2bd-0x1bd;let _0xc42b6a=_0x4e3026[_0x22b2bd];return _0xc42b6a;},a451_0x1e60(_0x1022b2,_0x53569d);}const payGatewayReceiveWebhook=async(_0x2acae2,_0xbaa329)=>{const _0x9c4a61=a451_0x3b5ef9,_0x542838=await(0x0,GetSuperSettingService_1['default'])({'key':'_paymentGateway'});switch(_0x542838){case _0x9c4a61(0x1e3):return(0x0,EfiServices_1['efiWebhook'])(_0x2acae2,_0xbaa329);case _0x9c4a61(0x1cb):return(0x0,StripeServices_1[_0x9c4a61(0x1c0)])(_0x2acae2,_0xbaa329);default:throw new AppError_1[(_0x9c4a61(0x1f4))]('Unsupported\x20payment\x20gateway',0x190);}};exports[a451_0x3b5ef9(0x1f1)]=payGatewayReceiveWebhook;const processInvoicePaid=async _0xd2562a=>{const _0x3760a2=a451_0x3b5ef9,_0x48a988=_0xd2562a[_0x3760a2(0x1e5)]||await Company_1['default']['findByPk'](_0xd2562a[_0x3760a2(0x1c1)]);if(_0x48a988){const _0x273547=new Date(_0x48a988[_0x3760a2(0x1cd)]);_0x273547['setDate'](_0x273547[_0x3760a2(0x1da)]()+0x1e),await _0x48a988[_0x3760a2(0x1d5)]({'dueDate':_0x273547}),await _0xd2562a[_0x3760a2(0x1d5)]({'status':'paid'}),await _0x48a988['reload']();const _0x1cffcf=(0x0,socket_1[_0x3760a2(0x1d8)])();_0x1cffcf['to'](_0x3760a2(0x1d0)+_0xd2562a[_0x3760a2(0x1c1)]+_0x3760a2(0x1e4))['to'](_0x3760a2(0x1d1))[_0x3760a2(0x1c7)]('company-'+_0xd2562a[_0x3760a2(0x1c1)]+_0x3760a2(0x1cf),{'action':_0x3760a2(0x1ce),'company':_0x48a988,'invoiceId':_0xd2562a['id']});}};exports[a451_0x3b5ef9(0x1bf)]=processInvoicePaid;const processInvoiceExpired=async _0x247921=>{const _0x2e77bd=a451_0x3b5ef9,_0x35a9ae=(0x0,socket_1['getIO'])();await _0x247921[_0x2e77bd(0x1d5)]({'txId':null,'payGw':null,'payGwData':null}),await _0x247921[_0x2e77bd(0x1ca)](),_0x35a9ae['to']('company-'+_0x247921['companyId']+_0x2e77bd(0x1e4))['to']('super')[_0x2e77bd(0x1c7)]('company-'+_0x247921['companyId']+_0x2e77bd(0x1cf),{'action':_0x2e77bd(0x1d7),'company':_0x247921[_0x2e77bd(0x1e5)]||await Invoices_1['default'][_0x2e77bd(0x1ed)](_0x247921[_0x2e77bd(0x1c1)]),'invoiceId':_0x247921['id']});};exports[a451_0x3b5ef9(0x1e6)]=processInvoiceExpired;const checkInvoicePayment=async _0x2e28bd=>{const _0x5b43f5=a451_0x3b5ef9;if(_0x2e28bd[_0x5b43f5(0x1f2)]===_0x5b43f5(0x1e3))(0x0,EfiServices_1[_0x5b43f5(0x1d4)])(_0x2e28bd);else _0x2e28bd[_0x5b43f5(0x1f2)]===_0x5b43f5(0x1cb)&&(0x0,StripeServices_1[_0x5b43f5(0x1e7)])(_0x2e28bd['id']);};exports[a451_0x3b5ef9(0x1c2)]=checkInvoicePayment;const checkOpenInvoices=async _0x16c8b0=>{const _0x42db79=a451_0x3b5ef9,_0x21be46=await(0x0,FindOpenInvoiceService_1[_0x42db79(0x1f4)])(_0x16c8b0);_0x21be46[_0x42db79(0x1d6)](_0x67d598=>{(0x0,exports['checkInvoicePayment'])(_0x67d598);});};exports['checkOpenInvoices']=checkOpenInvoices;