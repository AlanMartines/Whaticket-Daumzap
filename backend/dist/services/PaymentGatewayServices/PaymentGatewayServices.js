const a451_0x344556=a451_0x35bd;(function(_0x46dd1f,_0x24c2be){const _0x328df1=a451_0x35bd,_0x3f391e=_0x46dd1f();while(!![]){try{const _0x58f34d=-parseInt(_0x328df1(0x1f0))/0x1*(-parseInt(_0x328df1(0x21e))/0x2)+parseInt(_0x328df1(0x1f4))/0x3+parseInt(_0x328df1(0x20a))/0x4*(-parseInt(_0x328df1(0x1f2))/0x5)+-parseInt(_0x328df1(0x216))/0x6+-parseInt(_0x328df1(0x1f1))/0x7+parseInt(_0x328df1(0x201))/0x8+parseInt(_0x328df1(0x1fa))/0x9;if(_0x58f34d===_0x24c2be)break;else _0x3f391e['push'](_0x3f391e['shift']());}catch(_0x2f9ad2){_0x3f391e['push'](_0x3f391e['shift']());}}}(a451_0x39d6,0x45658));const a451_0x53412e=(function(){let _0x37db48=!![];return function(_0x371bed,_0x1b5f0a){const _0x542044=_0x37db48?function(){const _0xb33166=a451_0x35bd;if(_0x1b5f0a){const _0x5ef5ed=_0x1b5f0a[_0xb33166(0x214)](_0x371bed,arguments);return _0x1b5f0a=null,_0x5ef5ed;}}:function(){};return _0x37db48=![],_0x542044;};}()),a451_0x1fce90=a451_0x53412e(this,function(){const _0x28587a=a451_0x35bd;return a451_0x1fce90[_0x28587a(0x212)]()[_0x28587a(0x218)](_0x28587a(0x21c))['toString']()[_0x28587a(0x208)](a451_0x1fce90)['search'](_0x28587a(0x21c));});function a451_0x39d6(){const _0x25f676=['processInvoicePaid','(((.+)+)+)+$','-mainchannel','4vgygQQ','dueDate','payGw','../../errors/AppError','companyId','../../models/Invoices','processInvoiceExpired','56407OJDEVE','1666973fOivjO','10CRCEBG','paid','515256vZbEns','getDate','company-','reload','../SettingServices/GetSuperSettingService','checkOpenInvoices','5292225RFsKWm','payGatewayCreateSubscription','efiWebhook','getIO','stripe','../../libs/socket','update','2461768enqfEb','_paymentGateway','payGatewayReceiveWebhook','CONCLUIDA','stripeCreateSubscription','../InvoicesService/FindOpenInvoiceService','efiCreateSubscription','constructor','__esModule','586328HgNxvW','emit','Unsupported\x20payment\x20gateway','efi','./EfiServices','company','checkInvoicePayment','-payment','toString','findByPk','apply','payGatewayInitialize','2188566wVercB','defineProperty','search','stripeWebhookHandler','default'];a451_0x39d6=function(){return _0x25f676;};return a451_0x39d6();}a451_0x1fce90();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x224050){const _0x31935f=a451_0x35bd;return _0x224050&&_0x224050[_0x31935f(0x209)]?_0x224050:{'default':_0x224050};};Object[a451_0x344556(0x217)](exports,a451_0x344556(0x209),{'value':!![]}),exports[a451_0x344556(0x1f9)]=exports['checkInvoicePayment']=exports[a451_0x344556(0x1ef)]=exports[a451_0x344556(0x21b)]=exports[a451_0x344556(0x203)]=exports[a451_0x344556(0x1fb)]=exports[a451_0x344556(0x215)]=void 0x0;const AppError_1=__importDefault(require(a451_0x344556(0x221))),GetSuperSettingService_1=__importDefault(require(a451_0x344556(0x1f8))),EfiServices_1=require(a451_0x344556(0x20e)),StripeServices_1=require('./StripeServices'),Invoices_1=__importDefault(require(a451_0x344556(0x1ee))),socket_1=require(a451_0x344556(0x1ff)),Company_1=__importDefault(require('../../models/Company')),FindOpenInvoiceService_1=__importDefault(require(a451_0x344556(0x206))),payGatewayInitialize=async()=>{const _0x2f1ec8=a451_0x344556,_0x2a7bb6=await(0x0,GetSuperSettingService_1[_0x2f1ec8(0x21a)])({'key':_0x2f1ec8(0x202)});switch(_0x2a7bb6){case'efi':return(0x0,EfiServices_1['efiInitialize'])();case _0x2f1ec8(0x1fe):return(0x0,StripeServices_1['stripeInitialize'])();default:throw new AppError_1[(_0x2f1ec8(0x21a))](_0x2f1ec8(0x20c),0x190);}};exports[a451_0x344556(0x215)]=payGatewayInitialize;const payGatewayCreateSubscription=async(_0x50acfc,_0x2f2b11)=>{const _0x3f2011=a451_0x344556,_0x309dd1=await(0x0,GetSuperSettingService_1[_0x3f2011(0x21a)])({'key':_0x3f2011(0x202)});switch(_0x309dd1){case _0x3f2011(0x20d):return(0x0,EfiServices_1[_0x3f2011(0x207)])(_0x50acfc,_0x2f2b11);case _0x3f2011(0x1fe):return(0x0,StripeServices_1[_0x3f2011(0x205)])(_0x50acfc,_0x2f2b11);default:throw new AppError_1[(_0x3f2011(0x21a))]('Unsupported\x20payment\x20gateway',0x190);}};exports['payGatewayCreateSubscription']=payGatewayCreateSubscription;const payGatewayReceiveWebhook=async(_0x137f6e,_0x35a1a7)=>{const _0x2aa9dd=a451_0x344556,_0x5ef266=await(0x0,GetSuperSettingService_1['default'])({'key':_0x2aa9dd(0x202)});switch(_0x5ef266){case _0x2aa9dd(0x20d):return(0x0,EfiServices_1[_0x2aa9dd(0x1fc)])(_0x137f6e,_0x35a1a7);case _0x2aa9dd(0x1fe):return(0x0,StripeServices_1[_0x2aa9dd(0x219)])(_0x137f6e,_0x35a1a7);default:throw new AppError_1[(_0x2aa9dd(0x21a))](_0x2aa9dd(0x20c),0x190);}};exports[a451_0x344556(0x203)]=payGatewayReceiveWebhook;const processInvoicePaid=async _0x340ddf=>{const _0x2fada1=a451_0x344556,_0x585c66=_0x340ddf[_0x2fada1(0x20f)]||await Company_1[_0x2fada1(0x21a)][_0x2fada1(0x213)](_0x340ddf[_0x2fada1(0x222)]);if(_0x585c66){const _0x4b4e96=new Date(_0x585c66[_0x2fada1(0x21f)]);_0x4b4e96['setDate'](_0x4b4e96[_0x2fada1(0x1f5)]()+0x1e),await _0x585c66[_0x2fada1(0x200)]({'dueDate':_0x4b4e96}),await _0x340ddf[_0x2fada1(0x200)]({'status':_0x2fada1(0x1f3)}),await _0x585c66[_0x2fada1(0x1f7)]();const _0x1e0c43=(0x0,socket_1[_0x2fada1(0x1fd)])();_0x1e0c43['to'](_0x2fada1(0x1f6)+_0x340ddf['companyId']+_0x2fada1(0x21d))['to']('super')[_0x2fada1(0x20b)](_0x2fada1(0x1f6)+_0x340ddf['companyId']+_0x2fada1(0x211),{'action':_0x2fada1(0x204),'company':_0x585c66,'invoiceId':_0x340ddf['id']});}};function a451_0x35bd(_0x22e61c,_0x4a11e8){const _0x1e0e41=a451_0x39d6();return a451_0x35bd=function(_0x1fce90,_0x53412e){_0x1fce90=_0x1fce90-0x1ee;let _0x39d685=_0x1e0e41[_0x1fce90];return _0x39d685;},a451_0x35bd(_0x22e61c,_0x4a11e8);}exports[a451_0x344556(0x21b)]=processInvoicePaid;const processInvoiceExpired=async _0x2af926=>{const _0x174026=a451_0x344556,_0x417077=(0x0,socket_1[_0x174026(0x1fd)])();await _0x2af926['update']({'txId':null,'payGw':null,'payGwData':null}),await _0x2af926[_0x174026(0x1f7)](),_0x417077['to']('company-'+_0x2af926[_0x174026(0x222)]+'-mainchannel')['to']('super')[_0x174026(0x20b)](_0x174026(0x1f6)+_0x2af926[_0x174026(0x222)]+'-payment',{'action':'EXPIRADA','company':_0x2af926['company']||await Invoices_1[_0x174026(0x21a)][_0x174026(0x213)](_0x2af926[_0x174026(0x222)]),'invoiceId':_0x2af926['id']});};exports[a451_0x344556(0x1ef)]=processInvoiceExpired;const checkInvoicePayment=async _0x1c1f8b=>{const _0x63d951=a451_0x344556;if(_0x1c1f8b['payGw']==='efi')(0x0,EfiServices_1['efiCheckStatus'])(_0x1c1f8b);else _0x1c1f8b[_0x63d951(0x220)]===_0x63d951(0x1fe)&&(0x0,StripeServices_1['stripeCheckStatus'])(_0x1c1f8b['id']);};exports['checkInvoicePayment']=checkInvoicePayment;const checkOpenInvoices=async _0x1356f7=>{const _0x409efd=a451_0x344556,_0x294494=await(0x0,FindOpenInvoiceService_1[_0x409efd(0x21a)])(_0x1356f7);_0x294494['forEach'](_0x4345d9=>{const _0x168359=_0x409efd;(0x0,exports[_0x168359(0x210)])(_0x4345d9);});};exports[a451_0x344556(0x1f9)]=checkOpenInvoices;