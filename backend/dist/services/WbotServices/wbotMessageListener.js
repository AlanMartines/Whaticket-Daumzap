const a558_0xe1cba4=a558_0x1c99;(function(_0x38ff82,_0x3ab42a){const _0x3c1f46=a558_0x1c99,_0x192797=_0x38ff82();while(!![]){try{const _0x4baa17=-parseInt(_0x3c1f46(0x1a7))/0x1*(-parseInt(_0x3c1f46(0x28c))/0x2)+parseInt(_0x3c1f46(0x27a))/0x3*(-parseInt(_0x3c1f46(0x163))/0x4)+parseInt(_0x3c1f46(0x1f7))/0x5*(parseInt(_0x3c1f46(0x1af))/0x6)+-parseInt(_0x3c1f46(0x2d5))/0x7+-parseInt(_0x3c1f46(0x11a))/0x8+-parseInt(_0x3c1f46(0x262))/0x9+parseInt(_0x3c1f46(0x17b))/0xa;if(_0x4baa17===_0x3ab42a)break;else _0x192797['push'](_0x192797['shift']());}catch(_0x3db80b){_0x192797['push'](_0x192797['shift']());}}}(a558_0x5704,0x6278f));const a558_0x4c15f0=(function(){let _0x425b69=!![];return function(_0x3b91ec,_0x211eee){const _0x37aa6c=_0x425b69?function(){if(_0x211eee){const _0x554e0f=_0x211eee['apply'](_0x3b91ec,arguments);return _0x211eee=null,_0x554e0f;}}:function(){};return _0x425b69=![],_0x37aa6c;};}()),a558_0x5d23ce=a558_0x4c15f0(this,function(){const _0xb2b4ba=a558_0x1c99;return a558_0x5d23ce[_0xb2b4ba(0x1ae)]()[_0xb2b4ba(0x269)]('(((.+)+)+)+$')[_0xb2b4ba(0x1ae)]()[_0xb2b4ba(0x2aa)](a558_0x5d23ce)[_0xb2b4ba(0x269)](_0xb2b4ba(0x129));});a558_0x5d23ce();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a558_0xe1cba4(0x2d9)]?function(_0x45625e,_0x16c552,_0x2fa979,_0x375f37){const _0x317e2e=a558_0xe1cba4;if(_0x375f37===undefined)_0x375f37=_0x2fa979;var _0x439ca4=Object[_0x317e2e(0x24f)](_0x16c552,_0x2fa979);(!_0x439ca4||(_0x317e2e(0x271)in _0x439ca4?!_0x16c552[_0x317e2e(0x1ed)]:_0x439ca4[_0x317e2e(0x270)]||_0x439ca4[_0x317e2e(0x1d4)]))&&(_0x439ca4={'enumerable':!![],'get':function(){return _0x16c552[_0x2fa979];}}),Object['defineProperty'](_0x45625e,_0x375f37,_0x439ca4);}:function(_0x2a4cd0,_0x218641,_0x5d8d73,_0x346116){if(_0x346116===undefined)_0x346116=_0x5d8d73;_0x2a4cd0[_0x346116]=_0x218641[_0x5d8d73];}),__setModuleDefault=this&&this[a558_0xe1cba4(0x15f)]||(Object[a558_0xe1cba4(0x2d9)]?function(_0x15275b,_0x2d375f){const _0x5e4bec=a558_0xe1cba4;Object[_0x5e4bec(0x12b)](_0x15275b,_0x5e4bec(0x101),{'enumerable':!![],'value':_0x2d375f});}:function(_0x597f41,_0x284ef3){const _0x1a2a92=a558_0xe1cba4;_0x597f41[_0x1a2a92(0x101)]=_0x284ef3;}),__importStar=this&&this[a558_0xe1cba4(0x29a)]||function(_0x101e07){const _0x3dfd51=a558_0xe1cba4;if(_0x101e07&&_0x101e07[_0x3dfd51(0x1ed)])return _0x101e07;var _0x5d2a38={};if(_0x101e07!=null){for(var _0x3b07b8 in _0x101e07)if(_0x3b07b8!==_0x3dfd51(0x101)&&Object[_0x3dfd51(0x25c)][_0x3dfd51(0x1ab)][_0x3dfd51(0x1b5)](_0x101e07,_0x3b07b8))__createBinding(_0x5d2a38,_0x101e07,_0x3b07b8);}return __setModuleDefault(_0x5d2a38,_0x101e07),_0x5d2a38;},__importDefault=this&&this[a558_0xe1cba4(0x12d)]||function(_0xc3b85d){const _0x594bb1=a558_0xe1cba4;return _0xc3b85d&&_0xc3b85d[_0x594bb1(0x1ed)]?_0xc3b85d:{'default':_0xc3b85d};};Object[a558_0xe1cba4(0x12b)](exports,'__esModule',{'value':!![]}),exports[a558_0xe1cba4(0x1fd)]=exports['verifyCampaignMessageAndCloseTicket']=exports['verifyRecentCampaign']=exports[a558_0xe1cba4(0x15b)]=exports[a558_0xe1cba4(0x251)]=exports['handleMessageIntegration']=exports[a558_0xe1cba4(0x1db)]=exports[a558_0xe1cba4(0x226)]=exports[a558_0xe1cba4(0x147)]=exports['verifyMessage']=exports['verifyQuotedMessage']=exports['getQuotedMessageId']=exports[a558_0xe1cba4(0x214)]=exports[a558_0xe1cba4(0x18d)]=exports[a558_0xe1cba4(0x182)]=exports[a558_0xe1cba4(0x122)]=exports[a558_0xe1cba4(0x183)]=exports[a558_0xe1cba4(0x2ad)]=exports[a558_0xe1cba4(0x198)]=exports[a558_0xe1cba4(0x179)]=exports[a558_0xe1cba4(0x1fc)]=void 0x0;const path_1=__importStar(require(a558_0xe1cba4(0x119))),util_1=require(a558_0xe1cba4(0x169)),fs_1=require('fs'),Sentry=__importStar(require('@sentry/node')),lodash_1=require('lodash'),baileys_1=require(a558_0xe1cba4(0x2a8)),MessageUtils=__importStar(require(a558_0xe1cba4(0x26f))),stream_throttle_1=require(a558_0xe1cba4(0x1de)),Contact_1=__importDefault(require(a558_0xe1cba4(0x15c))),Ticket_1=__importDefault(require('../../models/Ticket')),Message_1=__importDefault(require('../../models/Message')),OldMessage_1=__importDefault(require(a558_0xe1cba4(0x232))),socket_1=require(a558_0xe1cba4(0x142)),CreateMessageService_1=__importDefault(require('../MessageServices/CreateMessageService')),logger_1=require(a558_0xe1cba4(0x13d)),CreateOrUpdateContactService_1=__importDefault(require(a558_0xe1cba4(0x137))),FindOrCreateTicketService_1=__importDefault(require('../TicketServices/FindOrCreateTicketService')),ShowWhatsAppService_1=__importDefault(require(a558_0xe1cba4(0x10e))),UpdateTicketService_1=__importDefault(require(a558_0xe1cba4(0x239))),Mustache_1=__importDefault(require(a558_0xe1cba4(0x29e))),UserRating_1=__importDefault(require(a558_0xe1cba4(0x247))),SendWhatsAppMessage_1=__importDefault(require(a558_0xe1cba4(0x1d1))),moment_1=__importDefault(require(a558_0xe1cba4(0x1ec))),Queue_1=__importDefault(require(a558_0xe1cba4(0x162))),QueueOption_1=__importDefault(require(a558_0xe1cba4(0x156))),FindOrCreateATicketTrakingService_1=__importDefault(require(a558_0xe1cba4(0x140))),VerifyCurrentSchedule_1=__importDefault(require(a558_0xe1cba4(0x2bd))),Campaign_1=__importDefault(require(a558_0xe1cba4(0x22c))),CampaignShipping_1=__importDefault(require(a558_0xe1cba4(0x224))),sequelize_1=require('sequelize'),queues_1=require(a558_0xe1cba4(0x153)),User_1=__importDefault(require(a558_0xe1cba4(0x1f2))),Setting_1=__importDefault(require('../../models/Setting')),cache_1=require(a558_0xe1cba4(0x196)),Debounce_1=require('../../helpers/Debounce'),openai_1=require(a558_0xe1cba4(0x1f5)),fluent_ffmpeg_1=__importDefault(require(a558_0xe1cba4(0x1e9))),microsoft_cognitiveservices_speech_sdk_1=require('microsoft-cognitiveservices-speech-sdk'),providers_1=require(a558_0xe1cba4(0x20b)),typebotListener_1=__importDefault(require(a558_0xe1cba4(0x2d3))),ShowQueueIntegrationService_1=__importDefault(require(a558_0xe1cba4(0x259))),SendWhatsAppMedia_1=require(a558_0xe1cba4(0x1cc)),fs_2=__importDefault(require('fs')),request_1=__importDefault(require(a558_0xe1cba4(0x152))),ffmpeg_static_1=__importDefault(require('ffmpeg-static')),app_1=__importDefault(require(a558_0xe1cba4(0x24b))),mime_1=__importDefault(require(a558_0xe1cba4(0x1a4))),wbot_1=require(a558_0xe1cba4(0x15d)),SendPresenceStatus_1=require(a558_0xe1cba4(0x1d9)),MakeRandomId_1=require(a558_0xe1cba4(0x131));fluent_ffmpeg_1[a558_0xe1cba4(0x101)][a558_0xe1cba4(0x159)](ffmpeg_static_1[a558_0xe1cba4(0x101)]);const sessionsOpenAi=[],isNumeric=_0x14a2d8=>/^-?\d+$/['test'](_0x14a2d8);exports[a558_0xe1cba4(0x1fc)]=isNumeric;let outOfHourMessageControl=[],completionMessageControl=[],greetingMessageControl=[],farewellMessageControl=[];const writeFileAsync=(0x0,util_1['promisify'])(fs_1[a558_0xe1cba4(0x28b)]),getTypeMessage=_0x818812=>{const _0x1717f6=a558_0xe1cba4;return(0x0,baileys_1[_0x1717f6(0x17e)])(_0x818812[_0x1717f6(0x2a7)]);},removeNonPrintableChars=_0x2fddf8=>{const _0x25c26d=a558_0xe1cba4;return _0x2fddf8[_0x25c26d(0x12e)](/[\x00-\x1F\x7F-\x9F]/g,'');};exports[a558_0xe1cba4(0x179)]=removeNonPrintableChars;async function getQueues(_0x6dbb02){const _0x156307=a558_0xe1cba4;try{const _0x17b656=await Queue_1[_0x156307(0x101)][_0x156307(0x2d8)]({'where':{'companyId':_0x6dbb02}});return _0x17b656;}catch(_0x45ef73){return console[_0x156307(0x1b7)](_0x156307(0x278),_0x45ef73),[];}}async function getContactFromTicket(_0x39db8a){const _0x3ddf88=a558_0xe1cba4;try{const _0x24a265=await Ticket_1[_0x3ddf88(0x101)][_0x3ddf88(0x12f)](_0x39db8a,{'include':[{'model':Contact_1[_0x3ddf88(0x101)],'as':_0x3ddf88(0x291)}]});return _0x24a265&&_0x24a265[_0x3ddf88(0x291)]?_0x24a265[_0x3ddf88(0x291)]:(console[_0x3ddf88(0x26b)]('No\x20contact\x20found\x20for\x20this\x20ticket.'),null);}catch(_0xefee3f){return console['error'](_0x3ddf88(0x118),_0xefee3f),null;}}function validaCpfCnpj(_0x3f2665){const _0x5ea3c3=a558_0xe1cba4;if(_0x3f2665[_0x5ea3c3(0x237)]==0xb){var _0x28d18d=_0x3f2665['trim']();_0x28d18d=_0x28d18d[_0x5ea3c3(0x12e)](/\./g,''),_0x28d18d=_0x28d18d['replace']('-',''),_0x28d18d=_0x28d18d[_0x5ea3c3(0x23b)]('');var _0x2cd335=0x0,_0x1751eb=0x0,_0x3fea73=![];for(var _0x2cf080=0x1;_0x28d18d[_0x5ea3c3(0x237)]>_0x2cf080;_0x2cf080++){_0x28d18d[_0x2cf080-0x1]!=_0x28d18d[_0x2cf080]&&(_0x3fea73=!![]);}if(_0x3fea73==![])return![];for(var _0x2cf080=0x0,_0x386daa=0xa;_0x28d18d[_0x5ea3c3(0x237)]-0x2>_0x2cf080;_0x2cf080++,_0x386daa--){_0x2cd335+=_0x28d18d[_0x2cf080]*_0x386daa;}_0x2cd335=_0x2cd335*0xa%0xb;_0x2cd335==0xa&&(_0x2cd335=0x0);if(_0x2cd335!=_0x28d18d[0x9])return![];for(var _0x2cf080=0x0,_0x386daa=0xb;_0x28d18d[_0x5ea3c3(0x237)]-0x1>_0x2cf080;_0x2cf080++,_0x386daa--){_0x1751eb+=_0x28d18d[_0x2cf080]*_0x386daa;}return _0x1751eb=_0x1751eb*0xa%0xb,_0x1751eb==0xa&&(_0x1751eb=0x0),_0x1751eb!=_0x28d18d[0xa]?![]:!![];}else{if(_0x3f2665[_0x5ea3c3(0x237)]==0xe){var _0xe9fa6e=_0x3f2665[_0x5ea3c3(0x1a5)]();_0xe9fa6e=_0xe9fa6e[_0x5ea3c3(0x12e)](/\./g,''),_0xe9fa6e=_0xe9fa6e['replace']('-',''),_0xe9fa6e=_0xe9fa6e[_0x5ea3c3(0x12e)]('/',''),_0xe9fa6e=_0xe9fa6e['split']('');var _0x2cd335=0x0,_0x1751eb=0x0,_0x3fea73=![];for(var _0x2cf080=0x1;_0xe9fa6e[_0x5ea3c3(0x237)]>_0x2cf080;_0x2cf080++){_0xe9fa6e[_0x2cf080-0x1]!=_0xe9fa6e[_0x2cf080]&&(_0x3fea73=!![]);}if(_0x3fea73==![])return![];for(var _0x2cf080=0x0,_0x58574e=0x5,_0xea3515=0xd;_0xe9fa6e['length']-0x2>_0x2cf080;_0x2cf080++,_0x58574e--,_0xea3515--){_0x58574e>=0x2?_0x2cd335+=_0xe9fa6e[_0x2cf080]*_0x58574e:_0x2cd335+=_0xe9fa6e[_0x2cf080]*_0xea3515;}_0x2cd335=_0x2cd335%0xb;_0x2cd335<0x2?_0x2cd335=0x0:_0x2cd335=0xb-_0x2cd335;if(_0x2cd335!=_0xe9fa6e[0xc])return![];for(var _0x2cf080=0x0,_0x58574e=0x6,_0xea3515=0xe;_0xe9fa6e[_0x5ea3c3(0x237)]-0x1>_0x2cf080;_0x2cf080++,_0x58574e--,_0xea3515--){_0x58574e>=0x2?_0x1751eb+=_0xe9fa6e[_0x2cf080]*_0x58574e:_0x1751eb+=_0xe9fa6e[_0x2cf080]*_0xea3515;}return _0x1751eb=_0x1751eb%0xb,_0x1751eb<0x2?_0x1751eb=0x0:_0x1751eb=0xb-_0x1751eb,_0x1751eb!=_0xe9fa6e[0xd]?![]:!![];}else return![];}}exports['validaCpfCnpj']=validaCpfCnpj;function timeout(_0x225ec9){return new Promise(_0x1d5278=>setTimeout(_0x1d5278,_0x225ec9));}async function sleep(_0x403cd2){await timeout(_0x403cd2);}exports[a558_0xe1cba4(0x2ad)]=sleep;const sendMessageImage=async(_0x1489f7,_0x53b3f1,_0x3ede89,_0x396c99,_0x3a898c)=>{const _0x510301=a558_0xe1cba4;let _0x27abc5;try{_0x27abc5=await _0x1489f7['sendMessage'](_0x53b3f1[_0x510301(0x11b)]+'@'+(_0x3ede89[_0x510301(0x165)]?'g.us':_0x510301(0x1b1)),{'image':_0x396c99?{'url':_0x396c99}:fs_2[_0x510301(0x101)][_0x510301(0x20c)](_0x510301(0x1bb)+_0x3a898c+'-'+makeid(0xa)),'fileName':_0x3a898c,'caption':_0x3a898c,'mimetype':_0x510301(0x107)});}catch(_0x909d71){_0x27abc5=await _0x1489f7[_0x510301(0x202)](_0x53b3f1[_0x510301(0x11b)]+'@'+(_0x3ede89[_0x510301(0x165)]?_0x510301(0x10d):'s.whatsapp.net'),{'text':(0x0,Mustache_1[_0x510301(0x101)])('Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!',_0x3ede89)});}(0x0,exports[_0x510301(0x1e5)])(_0x27abc5,_0x3ede89,_0x53b3f1);};exports[a558_0xe1cba4(0x183)]=sendMessageImage;const sendMessageLink=async(_0x2d1423,_0x32ef73,_0x5cb643,_0x44f3e6,_0x1a13e0)=>{const _0x529b38=a558_0xe1cba4;let _0x4ddbd7;try{_0x4ddbd7=await _0x2d1423[_0x529b38(0x202)](_0x32ef73[_0x529b38(0x11b)]+'@'+(_0x5cb643[_0x529b38(0x165)]?'g.us':_0x529b38(0x1b1)),{'document':_0x44f3e6?{'url':_0x44f3e6}:fs_2[_0x529b38(0x101)]['readFileSync'](_0x529b38(0x1bb)+_0x1a13e0+'-'+makeid(0xa)),'fileName':_0x1a13e0,'caption':_0x1a13e0,'mimetype':_0x529b38(0x2ce)});}catch(_0x12e7ad){_0x4ddbd7=await _0x2d1423['sendMessage'](_0x32ef73[_0x529b38(0x11b)]+'@'+(_0x5cb643['isGroup']?_0x529b38(0x10d):_0x529b38(0x1b1)),{'text':(0x0,Mustache_1[_0x529b38(0x101)])('Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!',_0x5cb643)});}(0x0,exports[_0x529b38(0x1e5)])(_0x4ddbd7,_0x5cb643,_0x32ef73);};exports[a558_0xe1cba4(0x122)]=sendMessageLink;function makeid(_0x37f689){const _0x3cfb0c=a558_0xe1cba4;var _0x4d37c0='',_0xc9904f=_0x3cfb0c(0x18e),_0x39a8d7=_0xc9904f[_0x3cfb0c(0x237)];for(var _0x266449=0x0;_0x266449<_0x37f689;_0x266449++){_0x4d37c0+=_0xc9904f[_0x3cfb0c(0x23c)](Math['floor'](Math[_0x3cfb0c(0x171)]()*_0x39a8d7));}return _0x4d37c0;}exports[a558_0xe1cba4(0x182)]=makeid;const msgLocation=(_0x34a44e,_0x1f097a,_0x5248d0)=>{const _0x584afe=a558_0xe1cba4;if(_0x34a44e){var _0x208dea=Buffer['from'](_0x34a44e)[_0x584afe(0x1ae)]('base64');let _0x23f202=_0x584afe(0x25a)+_0x208dea+_0x584afe(0x2b7)+_0x1f097a+_0x584afe(0x2bc)+_0x5248d0+_0x584afe(0x1cf)+_0x1f097a+',\x20'+_0x5248d0+'\x20';return _0x23f202;}},getBodyMessage=_0x1c29db=>{const _0x4db902=a558_0xe1cba4;try{let _0x5e4966=getTypeMessage(_0x1c29db);const _0x10964c={'conversation':MessageUtils[_0x4db902(0x29b)](_0x1c29db),'editedMessage':_0x1c29db?.[_0x4db902(0x2a7)]?.[_0x4db902(0x125)]?.['message']?.[_0x4db902(0x260)]?.[_0x4db902(0x125)]?.['conversation']||_0x1c29db?.[_0x4db902(0x2a7)]?.[_0x4db902(0x125)]?.[_0x4db902(0x2a7)]?.[_0x4db902(0x265)]?.[_0x4db902(0x283)],'imageMessage':MessageUtils[_0x4db902(0x27f)](_0x1c29db),'videoMessage':MessageUtils[_0x4db902(0x250)](_0x1c29db),'extendedTextMessage':_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x265)]?.[_0x4db902(0x283)],'buttonsResponseMessage':MessageUtils[_0x4db902(0x1d3)](_0x1c29db),'templateButtonReplyMessage':_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x157)]?.[_0x4db902(0x274)],'messageContextInfo':_0x1c29db[_0x4db902(0x2a7)]?.['buttonsResponseMessage']?.[_0x4db902(0x1c7)]||_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x102)]?.['title'],'buttonsMessage':MessageUtils['getBodyButton'](_0x1c29db)||_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x102)]?.['singleSelectReply']?.[_0x4db902(0x286)],'viewOnceMessage':MessageUtils[_0x4db902(0x184)](_0x1c29db),'viewOnceMessageV2':MessageUtils[_0x4db902(0x199)](_0x1c29db),'stickerMessage':MessageUtils[_0x4db902(0x2be)](_0x1c29db),'contactMessage':MessageUtils[_0x4db902(0x2d6)](_0x1c29db),'contactsArrayMessage':_0x1c29db[_0x4db902(0x2a7)]?.['contactsArrayMessage']?.[_0x4db902(0x2a2)]&&MessageUtils[_0x4db902(0x285)](_0x1c29db),'pollCreationMessageV2':_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x24d)]?.[_0x4db902(0x29f)]||'Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','pollCreationMessageV3':_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x133)]?.['name']||_0x4db902(0x299),'interactiveMessage':_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x257)]?.[_0x4db902(0x188)]||_0x1c29db[_0x4db902(0x2a7)]?.['interactiveMessage']?.[_0x4db902(0x1e4)]||_0x4db902(0x1a3),'locationMessage':MessageUtils[_0x4db902(0x27e)](_0x1c29db),'liveLocationMessage':'Latitude:\x20'+_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x110)]?.[_0x4db902(0x2d4)]+'\x20-\x20Longitude:\x20'+_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x110)]?.[_0x4db902(0x1c5)],'documentMessage':MessageUtils[_0x4db902(0x124)](_0x1c29db),'documentWithCaptionMessage':_0x1c29db['message']?.['documentWithCaptionMessage']?.[_0x4db902(0x2a7)]?.[_0x4db902(0x230)]?.[_0x4db902(0x21c)],'audioMessage':MessageUtils[_0x4db902(0x212)](_0x1c29db),'ephemeralMessage':_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x2c5)]?.[_0x4db902(0x2a7)]?.[_0x4db902(0x265)]?.[_0x4db902(0x283)],'listMessage':MessageUtils['getBodyButton'](_0x1c29db)||_0x1c29db[_0x4db902(0x2a7)]?.['listResponseMessage']?.[_0x4db902(0x150)],'listResponseMessage':MessageUtils[_0x4db902(0x21a)](_0x1c29db),'reactionMessage':MessageUtils['getReactionMessage'](_0x1c29db)||_0x4db902(0x113),'advertising':MessageUtils[_0x4db902(0x1d6)](_0x1c29db)||_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x102)]?.[_0x4db902(0x1e4)]?.[_0x4db902(0x1b6)]?.[_0x4db902(0x150)],'productMessage':_0x1c29db[_0x4db902(0x2a7)]?.[_0x4db902(0x236)]?.[_0x4db902(0x2b6)]?.[_0x4db902(0x194)]?.['caption']||_0x4db902(0x234),'multiProductMessage':_0x4db902(0x136),'orderMessage':_0x4db902(0x187),'paymentMessage':MessageUtils[_0x4db902(0x195)](_0x1c29db),'paymentRequestMessage':_0x4db902(0x21b),'groupInviteMessage':MessageUtils[_0x4db902(0x164)](_0x1c29db),'revokeInviteMessage':_0x4db902(0x289),'protocolMessage':_0x1c29db[_0x4db902(0x2a7)]?.['protocolMessage']?.[_0x4db902(0x125)]?.[_0x4db902(0x1b2)]||null,'disappearingMessage':_0x4db902(0x173),'callMessage':MessageUtils['getCallMessage'](_0x1c29db),'templateMessage':MessageUtils[_0x4db902(0x148)](_0x1c29db),'statusUpdateMessage':'Atualização\x20de\x20Status'};return _0x10964c[_0x5e4966]||null;}catch(_0x3e34f0){return console[_0x4db902(0x1b7)]('Error\x20getting\x20message\x20body:',_0x3e34f0),null;}};exports['getBodyMessage']=getBodyMessage;const getQuotedMessage=_0x534835=>{const _0x332109=a558_0xe1cba4,_0x342781=_0x534835['message']['imageMessage'][_0x332109(0x1e4)]||_0x534835[_0x332109(0x2a7)][_0x332109(0x25d)][_0x332109(0x1e4)]||_0x534835[_0x332109(0x2a7)]?.[_0x332109(0x230)]||_0x534835[_0x332109(0x2a7)][_0x332109(0x265)][_0x332109(0x1e4)]||_0x534835[_0x332109(0x2a7)][_0x332109(0x28e)][_0x332109(0x1e4)]||_0x534835[_0x332109(0x2a7)]['listResponseMessage'][_0x332109(0x1e4)]||_0x534835[_0x332109(0x2a7)][_0x332109(0x157)][_0x332109(0x1e4)]||_0x534835[_0x332109(0x2a7)]['buttonsResponseMessage']?.[_0x332109(0x1e4)]||_0x534835?.['message']?.['buttonsResponseMessage']?.[_0x332109(0x1c7)]||_0x534835['message'][_0x332109(0x102)]?.[_0x332109(0x22d)]?.[_0x332109(0x286)]||_0x534835?.['message']?.['listResponseMessage']?.['singleSelectReply'][_0x332109(0x286)]||_0x534835[_0x332109(0x2a7)][_0x332109(0x102)]?.[_0x332109(0x1e4)];return _0x534835[_0x332109(0x2a7)]['senderKeyDistributionMessage'],(0x0,baileys_1[_0x332109(0x177)])(_0x342781[Object[_0x332109(0x146)](_0x342781)['values']()['next']()['value']]);};function a558_0x1c99(_0xad6eb5,_0x19ed95){const _0x363d39=a558_0x5704();return a558_0x1c99=function(_0x5d23ce,_0x4c15f0){_0x5d23ce=_0x5d23ce-0xff;let _0x57044e=_0x363d39[_0x5d23ce];return _0x57044e;},a558_0x1c99(_0xad6eb5,_0x19ed95);}exports[a558_0xe1cba4(0x214)]=getQuotedMessage;const getQuotedMessageId=_0x485cdb=>{const _0x533d00=a558_0xe1cba4,_0x5ead78=(0x0,baileys_1['extractMessageContent'])(_0x485cdb['message'])[Object[_0x533d00(0x146)](_0x485cdb?.[_0x533d00(0x2a7)])[_0x533d00(0x268)]()[_0x533d00(0x201)]()[_0x533d00(0x1a1)]];let _0x236e77=_0x485cdb?.['message']?.[_0x533d00(0x241)]?_0x485cdb?.['message']?.[_0x533d00(0x241)]?.[_0x533d00(0x249)]?.['id']:'';return _0x236e77?_0x236e77:_0x5ead78?.[_0x533d00(0x1e4)]?.[_0x533d00(0x117)];};exports[a558_0xe1cba4(0x242)]=getQuotedMessageId;const getMeSocket=_0x4efa11=>{const _0x1ed23c=a558_0xe1cba4;return{'id':(0x0,baileys_1['jidNormalizedUser'])(_0x4efa11[_0x1ed23c(0x25e)]['id']),'name':_0x4efa11[_0x1ed23c(0x25e)][_0x1ed23c(0x29f)]};},getSenderMessage=(_0x5bac19,_0x367a88)=>{const _0x4f503d=a558_0xe1cba4,_0x217e0e=getMeSocket(_0x367a88);if(_0x5bac19[_0x4f503d(0x249)]['fromMe'])return _0x217e0e['id'];const _0x25b12f=_0x5bac19['participant']||_0x5bac19[_0x4f503d(0x249)][_0x4f503d(0x1f9)]||_0x5bac19[_0x4f503d(0x249)]['remoteJid']||undefined;return _0x25b12f&&(0x0,baileys_1[_0x4f503d(0x19d)])(_0x25b12f);},getContactMessage=async(_0x58e207,_0x5dd03c)=>{const _0x17576d=a558_0xe1cba4,_0x1cd651=_0x58e207[_0x17576d(0x249)]['remoteJid']['includes']('g.us'),_0x3f6f0c=_0x58e207['key'][_0x17576d(0x16c)]['replace'](/\D/g,'');return _0x1cd651?{'id':getSenderMessage(_0x58e207,_0x5dd03c),'name':_0x58e207[_0x17576d(0x258)]}:{'id':_0x58e207[_0x17576d(0x249)][_0x17576d(0x16c)],'name':_0x58e207[_0x17576d(0x249)][_0x17576d(0x17f)]?_0x3f6f0c:_0x58e207[_0x17576d(0x258)]};},getUnpackedMessage=_0x5c9572=>{const _0x1c9fca=a558_0xe1cba4;return _0x5c9572[_0x1c9fca(0x2a7)]?.[_0x1c9fca(0x24a)]?.[_0x1c9fca(0x2a7)]||_0x5c9572[_0x1c9fca(0x2a7)]?.[_0x1c9fca(0x265)]?.[_0x1c9fca(0x1e4)]?.[_0x1c9fca(0x211)]||_0x5c9572['message']?.['ephemeralMessage']?.[_0x1c9fca(0x2a7)]||_0x5c9572[_0x1c9fca(0x2a7)]?.['viewOnceMessage']?.[_0x1c9fca(0x2a7)]||_0x5c9572['message']?.[_0x1c9fca(0x292)]?.[_0x1c9fca(0x2a7)]||_0x5c9572[_0x1c9fca(0x2a7)]?.[_0x1c9fca(0x2c5)]?.['message']||_0x5c9572[_0x1c9fca(0x2a7)]?.[_0x1c9fca(0x27b)]?.['hydratedTemplate']||_0x5c9572[_0x1c9fca(0x2a7)]?.['templateMessage']?.[_0x1c9fca(0x26a)]||_0x5c9572[_0x1c9fca(0x2a7)]?.[_0x1c9fca(0x27b)]?.[_0x1c9fca(0x222)]||_0x5c9572[_0x1c9fca(0x2a7)]?.['interactiveMessage']?.[_0x1c9fca(0x19e)]||_0x5c9572[_0x1c9fca(0x2a7)]?.[_0x1c9fca(0x288)]?.[_0x1c9fca(0x23e)]?.[_0x1c9fca(0x189)]||_0x5c9572['message'];},getMessageMedia=_0x15df9f=>{const _0x246607=a558_0xe1cba4;return _0x15df9f?.[_0x246607(0x14c)]||_0x15df9f?.['audioMessage']||_0x15df9f?.[_0x246607(0x25d)]||_0x15df9f?.[_0x246607(0x282)]||_0x15df9f?.['documentMessage']||null;},downloadMedia=async _0x1d7188=>{const _0x13957d=a558_0xe1cba4,_0x58b8c9=getUnpackedMessage(_0x1d7188),_0x1ec9cd=getMessageMedia(_0x58b8c9);if(!_0x1ec9cd)return null;const _0x4364df=_0x58b8c9?.[_0x13957d(0x230)]?_0x13957d(0x2d2):_0x1ec9cd[_0x13957d(0x213)][_0x13957d(0x23b)]('/')[0x0][_0x13957d(0x12e)](_0x13957d(0x109),_0x13957d(0x2d2))?_0x1ec9cd['mimetype']['split']('/')[0x0]['replace'](_0x13957d(0x109),'document'):_0x1ec9cd[_0x13957d(0x213)][_0x13957d(0x23b)]('/')[0x0];let _0x3c4e00,_0x1aee03=0x0;while(_0x1aee03<0xa&&!_0x3c4e00){try{_0x1ec9cd?.[_0x13957d(0x272)]&&(_0x1ec9cd[_0x13957d(0x1ca)]=''),_0x3c4e00=await(0x0,baileys_1[_0x13957d(0x1bc)])(_0x1ec9cd,_0x4364df);}catch(_0x32737a){_0x1aee03+=0x1,await new Promise(_0x220812=>{setTimeout(_0x220812,0x3e8*_0x1aee03*0x2);}),logger_1[_0x13957d(0x19a)]['warn']('>>>>\x20erro\x20'+_0x1aee03+_0x13957d(0x248)+_0x1d7188?.[_0x13957d(0x249)]?.['id']);}}if(!_0x3c4e00)throw new Error(_0x13957d(0x1f0));let _0xe1d10a=_0x58b8c9?.[_0x13957d(0x230)]?.['fileName']||'';if(!_0xe1d10a){const _0x150953=mime_1[_0x13957d(0x101)][_0x13957d(0x1bd)](_0x1ec9cd[_0x13957d(0x213)]);_0xe1d10a=(0x0,MakeRandomId_1[_0x13957d(0x1f4)])(0x5)+'-'+new Date()[_0x13957d(0x2b2)]()+'.'+_0x150953;}else _0xe1d10a=_0xe1d10a[_0x13957d(0x23b)]('.')[_0x13957d(0x20f)](0x0,-0x1)[_0x13957d(0x145)]('.')+'.'+(0x0,MakeRandomId_1['makeRandomId'])(0x5)+'.'+_0xe1d10a[_0x13957d(0x23b)]('.')[_0x13957d(0x20f)](-0x1);const _0x38b220=0x5*0x400*0x400/0x8,_0x4cea24=0x400*0x400/0x8,_0x11f484=0x400*0x400,_0x141445=new stream_throttle_1[(_0x13957d(0x1b9))]({'rate':_0x38b220});let _0x2a532f=Buffer[_0x13957d(0x298)]([]),_0x45b7eb=0x0;const _0x5e61ad=Date['now']();try{for await(const _0x45fecc of _0x3c4e00['pipe'](_0x141445)){_0x2a532f=Buffer[_0x13957d(0x261)]([_0x2a532f,_0x45fecc]),_0x45b7eb+=_0x45fecc['length'],_0x45b7eb>_0x11f484&&(_0x141445[_0x13957d(0x1d7)]=_0x4cea24);}}catch(_0x3bdd4d){return{'data':'error','mimetype':'','filename':''};}const _0x282811=Date[_0x13957d(0x29c)](),_0x51b1b9=(_0x282811-_0x5e61ad)/0x3e8,_0x47547f=_0x45b7eb/_0x51b1b9;logger_1['logger']['debug'](_0xe1d10a+'\x20Download\x20completed\x20in\x20'+_0x51b1b9[_0x13957d(0x1e6)](0x2)+_0x13957d(0x16e)+(_0x47547f/0x400/0x400)['toFixed'](0x2)+_0x13957d(0x1e2));if(!_0x2a532f){Sentry[_0x13957d(0x2b0)](_0x13957d(0x16a),{'msg':_0x1d7188}),Sentry[_0x13957d(0x106)](new Error(_0x13957d(0x16a)));throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');}const _0x3addb3={'data':_0x2a532f,'mimetype':_0x1ec9cd[_0x13957d(0x213)],'filename':_0xe1d10a};return _0x3addb3;},verifyContact=async(_0xb8ec10,_0x5529d1,_0x552e74)=>{const _0x28c95c=a558_0xe1cba4,_0x2f7245={'name':_0xb8ec10?.[_0x28c95c(0x29f)]||_0xb8ec10['id'][_0x28c95c(0x12e)](/\D/g,''),'number':_0xb8ec10['id'][_0x28c95c(0x229)](0x0,_0xb8ec10['id']['indexOf']('@')),'isGroup':_0xb8ec10['id'][_0x28c95c(0x1ad)](_0x28c95c(0x10d)),'companyId':_0x552e74,'whatsappId':_0x5529d1['id']},_0x33c73f=(0x0,CreateOrUpdateContactService_1[_0x28c95c(0x101)])(_0x2f7245,_0x5529d1,_0xb8ec10['id']);return _0x33c73f;},verifyQuotedMessage=async _0x476c30=>{const _0x1e2c14=a558_0xe1cba4;if(!_0x476c30)return null;const _0x3992aa=(0x0,exports['getQuotedMessageId'])(_0x476c30);if(!_0x3992aa)return null;const _0x212a92=await Message_1[_0x1e2c14(0x101)]['findOne']({'where':{'id':_0x3992aa}});if(!_0x212a92)return null;return _0x212a92;};exports[a558_0xe1cba4(0x1da)]=verifyQuotedMessage;const sanitizeName=_0x3e95be=>{const _0x5c3aea=a558_0xe1cba4;let _0x144745=_0x3e95be[_0x5c3aea(0x23b)]('\x20')[0x0];return _0x144745=_0x144745[_0x5c3aea(0x12e)](/[^a-zA-Z0-9]/g,''),_0x144745['substring'](0x0,0x3c);},convertTextToSpeechAndSaveToFile=(_0x5c601f,_0xd23a67,_0x42bb32,_0x83ddc5,_0x30b230=a558_0xe1cba4(0x2a9),_0x19cff1=a558_0xe1cba4(0x1b3))=>{return new Promise((_0x1c76ea,_0x381bcc)=>{const _0x3a6ca8=a558_0x1c99,_0x11cf19=microsoft_cognitiveservices_speech_sdk_1[_0x3a6ca8(0x19b)][_0x3a6ca8(0x120)](_0x42bb32,_0x83ddc5);_0x11cf19[_0x3a6ca8(0x252)]=_0x30b230;const _0x1cfbf8=microsoft_cognitiveservices_speech_sdk_1[_0x3a6ca8(0x170)]['fromAudioFileOutput'](_0xd23a67+_0x3a6ca8(0x23a)),_0x47b015=new microsoft_cognitiveservices_speech_sdk_1[(_0x3a6ca8(0x22f))](_0x11cf19,_0x1cfbf8);_0x47b015[_0x3a6ca8(0x284)](_0x5c601f,_0x5a6504=>{const _0x2f6e00=_0x3a6ca8;_0x5a6504?convertWavToAnotherFormat(_0xd23a67+_0x2f6e00(0x23a),_0xd23a67+'.'+_0x19cff1,_0x19cff1)[_0x2f6e00(0x116)](_0x7088ec=>{_0x1c76ea();})[_0x2f6e00(0x2b8)](_0x4b9a95=>{const _0x4923f0=_0x2f6e00;console[_0x4923f0(0x1b7)](_0x4b9a95),_0x381bcc(_0x4b9a95);}):_0x381bcc(new Error(_0x2f6e00(0x20e))),_0x47b015['close']();},_0xd5af53=>{const _0x285fa5=_0x3a6ca8;console[_0x285fa5(0x1b7)](_0x285fa5(0x204)+_0xd5af53),_0x47b015[_0x285fa5(0x2b3)](),_0x381bcc(_0xd5af53);});});},convertWavToAnotherFormat=(_0x3d4867,_0x41b492,_0x4d47b5)=>{return new Promise((_0x592298,_0x47460a)=>{const _0x16383f=a558_0x1c99;(0x0,fluent_ffmpeg_1[_0x16383f(0x101)])()[_0x16383f(0x18f)](_0x3d4867)[_0x16383f(0x11c)](_0x4d47b5)['on'](_0x16383f(0x2a0),()=>_0x592298(_0x41b492))['on'](_0x16383f(0x1b7),_0x261bcf=>_0x47460a(new Error('Error\x20converting\x20file:\x20'+_0x261bcf[_0x16383f(0x2a7)])))[_0x16383f(0x206)](_0x41b492);});},deleteFileSync=_0x5a8c91=>{const _0x3a480b=a558_0xe1cba4;try{fs_2['default'][_0x3a480b(0x22b)](_0x5a8c91);}catch(_0x386218){console['error'](_0x3a480b(0x2ba),_0x386218);}},keepOnlySpecifiedChars=_0x12695b=>{const _0x3fc8ce=a558_0xe1cba4;return _0x12695b[_0x3fc8ce(0x12e)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x268180,_0x4ef6be,_0x448d36,_0x8f6e23,_0x29977e)=>{const _0x5eb063=a558_0xe1cba4,_0x5cecee=(0x0,exports['getBodyMessage'])(_0x268180);if(!_0x5cecee)return;let {prompt:_0x29549f}=await(0x0,ShowWhatsAppService_1[_0x5eb063(0x101)])(_0x4ef6be['id'],_0x448d36[_0x5eb063(0x203)]);!_0x29549f&&!(0x0,lodash_1[_0x5eb063(0x2bf)])(_0x448d36?.[_0x5eb063(0x151)]?.[_0x5eb063(0x228)])&&(_0x29549f=_0x448d36[_0x5eb063(0x151)][_0x5eb063(0x228)]);if(!_0x29549f)return;if(_0x268180['messageStubType'])return;const _0x475e56=path_1[_0x5eb063(0x101)][_0x5eb063(0x2a4)](__dirname,'..','..','..',_0x5eb063(0x210));let _0x240595;const _0x10d699=sessionsOpenAi['findIndex'](_0x3396e1=>_0x3396e1['id']===_0x4ef6be['id']);if(_0x10d699===-0x1){const _0x3f7fb2=new openai_1['Configuration']({'apiKey':_0x29549f['apiKey']});_0x240595=new openai_1['OpenAIApi'](_0x3f7fb2),_0x240595['id']=_0x4ef6be['id'],sessionsOpenAi[_0x5eb063(0x1b4)](_0x240595);}else _0x240595=sessionsOpenAi[_0x10d699];const _0x12fe45=await Message_1[_0x5eb063(0x101)][_0x5eb063(0x2d8)]({'where':{'ticketId':_0x448d36['id']},'order':[[_0x5eb063(0x100),_0x5eb063(0x219)]],'limit':_0x29549f[_0x5eb063(0x135)]}),_0x25f2ad=_0x5eb063(0x21f)+sanitizeName(_0x8f6e23[_0x5eb063(0x29f)]||'Amigo(a)')+'\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20'+_0x29549f[_0x5eb063(0x128)]+_0x5eb063(0x208)+_0x29549f[_0x5eb063(0x228)]+'\x0a';let _0x514e90=[];if(_0x268180['message']?.[_0x5eb063(0x1b2)]||_0x268180[_0x5eb063(0x2a7)]?.[_0x5eb063(0x265)]?.[_0x5eb063(0x283)]){_0x514e90=[],_0x514e90[_0x5eb063(0x1b4)]({'role':_0x5eb063(0x11f),'content':_0x25f2ad});for(let _0x2a55ef=0x0;_0x2a55ef<Math[_0x5eb063(0x13a)](_0x29549f['maxMessages'],_0x12fe45['length']);_0x2a55ef++){const _0x1f37d5=_0x12fe45[_0x2a55ef];_0x1f37d5[_0x5eb063(0x14b)]===_0x5eb063(0x28d)&&(_0x1f37d5['fromMe']?_0x514e90['push']({'role':_0x5eb063(0x273),'content':_0x1f37d5[_0x5eb063(0x188)]}):_0x514e90[_0x5eb063(0x1b4)]({'role':_0x5eb063(0x25e),'content':_0x1f37d5[_0x5eb063(0x188)]}));}_0x514e90['push']({'role':_0x5eb063(0x25e),'content':_0x5cecee});const _0x109e35=await _0x240595[_0x5eb063(0x21d)]({'model':'gpt-3.5-turbo-1106','messages':_0x514e90,'max_tokens':_0x29549f[_0x5eb063(0x128)],'temperature':_0x29549f['temperature']});let _0x1d163f=_0x109e35[_0x5eb063(0x25b)]['choices'][0x0][_0x5eb063(0x2a7)]?.[_0x5eb063(0x14a)];_0x1d163f?.['includes']('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x29549f['queueId'],_0x448d36,_0x8f6e23),_0x1d163f=_0x1d163f[_0x5eb063(0x12e)](_0x5eb063(0x14e),'')['trim']());if(_0x29549f[_0x5eb063(0x240)]===_0x5eb063(0x279)){const _0x2d2b56=await _0x4ef6be[_0x5eb063(0x202)](_0x268180[_0x5eb063(0x249)][_0x5eb063(0x16c)],{'text':_0x1d163f});await(0x0,exports[_0x5eb063(0x1e5)])(_0x2d2b56,_0x448d36,_0x8f6e23);}else{const _0x208256=_0x448d36['id']+'_'+Date[_0x5eb063(0x29c)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x1d163f),_0x475e56+'/'+_0x208256,_0x29549f[_0x5eb063(0x1b0)],_0x29549f[_0x5eb063(0x1e7)],_0x29549f[_0x5eb063(0x240)],_0x5eb063(0x1b3))[_0x5eb063(0x116)](async()=>{const _0x3293f5=_0x5eb063;try{const _0x3f6d8a=await _0x4ef6be[_0x3293f5(0x202)](_0x268180['key'][_0x3293f5(0x16c)],{'audio':{'url':_0x475e56+'/'+_0x208256+_0x3293f5(0x2ae)},'mimetype':'audio/mpeg','ptt':!![]});await verifyMediaMessage(_0x3f6d8a,_0x448d36,_0x8f6e23),deleteFileSync(_0x475e56+'/'+_0x208256+'.mp3'),deleteFileSync(_0x475e56+'/'+_0x208256+_0x3293f5(0x23a));}catch(_0x4ec406){console[_0x3293f5(0x26b)](_0x3293f5(0x23d)+_0x4ec406);}});}}else{if(_0x268180[_0x5eb063(0x2a7)]?.[_0x5eb063(0x1f8)]){const _0x3f0e11=_0x29977e['mediaUrl'][_0x5eb063(0x23b)]('/')['pop'](),_0x5ddd2a=fs_2[_0x5eb063(0x101)][_0x5eb063(0x297)](_0x475e56+'/'+_0x3f0e11),_0xbc863=await _0x240595[_0x5eb063(0x14f)](_0x5ddd2a,_0x5eb063(0x2c4));_0x514e90=[],_0x514e90[_0x5eb063(0x1b4)]({'role':_0x5eb063(0x11f),'content':_0x25f2ad});for(let _0x3e0041=0x0;_0x3e0041<Math[_0x5eb063(0x13a)](_0x29549f[_0x5eb063(0x135)],_0x12fe45['length']);_0x3e0041++){const _0x498ff2=_0x12fe45[_0x3e0041];_0x498ff2[_0x5eb063(0x14b)]===_0x5eb063(0x28d)&&(_0x498ff2['fromMe']?_0x514e90['push']({'role':'assistant','content':_0x498ff2[_0x5eb063(0x188)]}):_0x514e90[_0x5eb063(0x1b4)]({'role':_0x5eb063(0x25e),'content':_0x498ff2['body']}));}_0x514e90['push']({'role':'user','content':_0xbc863[_0x5eb063(0x25b)][_0x5eb063(0x283)]});const _0x320ad3=await _0x240595[_0x5eb063(0x21d)]({'model':_0x5eb063(0x1a8),'messages':_0x514e90,'max_tokens':_0x29549f['maxTokens'],'temperature':_0x29549f[_0x5eb063(0x27d)]});let _0x4a33fe=_0x320ad3[_0x5eb063(0x25b)][_0x5eb063(0x1a6)][0x0][_0x5eb063(0x2a7)]?.[_0x5eb063(0x14a)];_0x4a33fe?.[_0x5eb063(0x1ad)](_0x5eb063(0x14e))&&(await transferQueue(_0x29549f[_0x5eb063(0x172)],_0x448d36,_0x8f6e23),_0x4a33fe=_0x4a33fe[_0x5eb063(0x12e)](_0x5eb063(0x14e),'')['trim']());if(_0x29549f[_0x5eb063(0x240)]===_0x5eb063(0x279)){const _0x2effe8=await _0x4ef6be['sendMessage'](_0x268180[_0x5eb063(0x249)][_0x5eb063(0x16c)],{'text':_0x4a33fe});await(0x0,exports[_0x5eb063(0x1e5)])(_0x2effe8,_0x448d36,_0x8f6e23);}else{const _0x555eec=_0x448d36['id']+'_'+Date['now']();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x4a33fe),_0x475e56+'/'+_0x555eec,_0x29549f[_0x5eb063(0x1b0)],_0x29549f[_0x5eb063(0x1e7)],_0x29549f[_0x5eb063(0x240)],'mp3')[_0x5eb063(0x116)](async()=>{const _0x1a51bb=_0x5eb063;try{const _0x849011=await _0x4ef6be[_0x1a51bb(0x202)](_0x268180[_0x1a51bb(0x249)][_0x1a51bb(0x16c)],{'audio':{'url':_0x475e56+'/'+_0x555eec+_0x1a51bb(0x2ae)},'mimetype':_0x1a51bb(0x2a1),'ptt':!![]});await verifyMediaMessage(_0x849011,_0x448d36,_0x8f6e23),deleteFileSync(_0x475e56+'/'+_0x555eec+_0x1a51bb(0x2ae)),deleteFileSync(_0x475e56+'/'+_0x555eec+_0x1a51bb(0x23a));}catch(_0x4dd2c0){console[_0x1a51bb(0x26b)]('Erro\x20para\x20responder\x20com\x20audio:\x20'+_0x4dd2c0);}});}}}_0x514e90=[];},transferQueue=async(_0x5354b8,_0x3e9605,_0x9bf701)=>{const _0x22ae38=a558_0xe1cba4;console[_0x22ae38(0x1eb)](_0x22ae38(0x294)),await(0x0,UpdateTicketService_1[_0x22ae38(0x101)])({'ticketData':{'queueId':_0x5354b8,'useIntegration':![],'promptId':null},'ticketId':_0x3e9605['id'],'companyId':_0x3e9605[_0x22ae38(0x203)]});},verifyMediaMessage=async(_0x547c9d,_0x6aa847,_0x4ed25c)=>{const _0x3680ed=a558_0xe1cba4,_0x25f754=(0x0,socket_1[_0x3680ed(0x246)])();let _0xaadef3=await Message_1[_0x3680ed(0x101)][_0x3680ed(0xff)]({'where':{'id':_0x547c9d[_0x3680ed(0x249)]['id']}});if(!_0xaadef3){const _0x2a46b1=await(0x0,exports[_0x3680ed(0x1da)])(_0x547c9d),_0x297b26=(0x0,wbot_1[_0x3680ed(0x108)])(_0x6aa847[_0x3680ed(0x2cf)]),_0x4b0e4b=await downloadMedia(_0x547c9d);if(!_0x4b0e4b)throw new Error(_0x3680ed(0x16a));if(!_0x4b0e4b[_0x3680ed(0x13f)]){const _0x59cfaf=typeof _0x4b0e4b[_0x3680ed(0x213)]===_0x3680ed(0x1f6)&&_0x4b0e4b[_0x3680ed(0x213)][_0x3680ed(0x1ad)]('/')&&_0x4b0e4b['mimetype'][_0x3680ed(0x1ad)](';')?mime_1['default'][_0x3680ed(0x1bd)](_0x4b0e4b['mimetype']):'unknown';_0x4b0e4b[_0x3680ed(0x13f)]=new Date()[_0x3680ed(0x2b2)]()+'.'+_0x59cfaf;}else{let _0x2593d0=_0x4b0e4b[_0x3680ed(0x13f)]?'-'+_0x4b0e4b[_0x3680ed(0x13f)]:'';_0x4b0e4b[_0x3680ed(0x13f)]=''+new Date()['getTime']()+_0x2593d0;}try{const _0xeb914b=_0x3680ed(0x1fe)+_0x6aa847[_0x3680ed(0x203)];!fs_2[_0x3680ed(0x101)][_0x3680ed(0x16b)](_0xeb914b)&&(fs_2[_0x3680ed(0x101)][_0x3680ed(0x29d)](_0xeb914b),fs_2[_0x3680ed(0x101)]['chmodSync'](_0xeb914b,0x1ff)),await writeFileAsync((0x0,path_1[_0x3680ed(0x145)])(__dirname,'..','..','..',_0xeb914b,_0x4b0e4b[_0x3680ed(0x13f)]),_0x4b0e4b['data'],_0x3680ed(0x256));}catch(_0x3733b0){Sentry['captureException'](_0x3733b0),logger_1['logger'][_0x3680ed(0x1b7)](_0x3733b0);}const _0x3ab594=(0x0,exports[_0x3680ed(0x18d)])(_0x547c9d);var _0x378dd7=getTypeMessage(_0x547c9d);const _0x3536ff={'id':_0x547c9d['key']['id'],'ticketId':_0x6aa847['id'],'contactId':_0x547c9d[_0x3680ed(0x249)][_0x3680ed(0x17f)]?undefined:_0x4ed25c['id'],'body':_0x3ab594?(0x0,Mustache_1[_0x3680ed(0x101)])(_0x3ab594,_0x6aa847):_0x4b0e4b[_0x3680ed(0x13f)],'fromMe':_0x547c9d[_0x3680ed(0x249)][_0x3680ed(0x17f)],'read':_0x547c9d['key']['fromMe'],'mediaUrl':_0x4b0e4b[_0x3680ed(0x13f)],'mediaType':typeof _0x4b0e4b['mimetype']==='string'?_0x4b0e4b[_0x3680ed(0x213)][_0x3680ed(0x23b)]('/')[0x0]:'unknown','quotedMsgId':_0x2a46b1?.['id'],'ack':getStatus(_0x547c9d,_0x3680ed(0x2b5)),'remoteJid':_0x547c9d[_0x3680ed(0x249)][_0x3680ed(0x16c)],'participant':_0x547c9d[_0x3680ed(0x249)][_0x3680ed(0x1f9)],'dataJson':JSON[_0x3680ed(0x18c)](_0x547c9d)};var _0x2523cf=_0x3ab594||_0x4b0e4b[_0x3680ed(0x13f)];typeof _0x2523cf!=_0x3680ed(0x1f6)&&console[_0x3680ed(0x1eb)](_0x3680ed(0x105),_0x2523cf),await _0x6aa847[_0x3680ed(0x111)]({'lastMessage':_0x2523cf}),_0xaadef3=await(0x0,CreateMessageService_1['default'])({'messageData':_0x3536ff,'ticket':_0x6aa847,'companyId':_0x6aa847[_0x3680ed(0x203)]});}else typeof _0xaadef3[_0x3680ed(0x188)]!=_0x3680ed(0x1f6)&&console['trace']('body\x20is\x20not\x20a\x20string',_0xaadef3[_0x3680ed(0x188)]),await _0x6aa847[_0x3680ed(0x111)]({'lastMessage':_0xaadef3[_0x3680ed(0x188)]}),_0xaadef3[_0x3680ed(0x134)]=getStatus(_0x547c9d,'media'),_0xaadef3[_0x3680ed(0x1f9)]=_0x547c9d[_0x3680ed(0x249)][_0x3680ed(0x1f9)],_0xaadef3[_0x3680ed(0x197)]=JSON['stringify'](_0x547c9d),await _0xaadef3[_0x3680ed(0x206)]();return!_0x547c9d[_0x3680ed(0x249)][_0x3680ed(0x17f)]&&_0x6aa847[_0x3680ed(0x1d5)]===_0x3680ed(0x263)&&(await _0x6aa847[_0x3680ed(0x111)]({'status':_0x3680ed(0x138)}),await _0x6aa847[_0x3680ed(0x253)]({'include':[{'model':Queue_1[_0x3680ed(0x101)],'as':_0x3680ed(0x151)},{'model':User_1[_0x3680ed(0x101)],'as':_0x3680ed(0x25e)},{'model':Contact_1['default'],'as':'contact'}]}),_0x25f754['to'](_0x3680ed(0x1b8)+_0x6aa847[_0x3680ed(0x203)]+_0x3680ed(0x1df))['emit'](_0x3680ed(0x1b8)+_0x6aa847[_0x3680ed(0x203)]+_0x3680ed(0x266),{'action':'delete','ticket':_0x6aa847,'ticketId':_0x6aa847['id']}),_0x25f754['to'](_0x3680ed(0x1b8)+_0x6aa847[_0x3680ed(0x203)]+'-'+_0x6aa847[_0x3680ed(0x1d5)])['to'](_0x6aa847['id'][_0x3680ed(0x1ae)]())[_0x3680ed(0x24c)]('company-'+_0x6aa847['companyId']+_0x3680ed(0x266),{'action':_0x3680ed(0x111),'ticket':_0x6aa847,'ticketId':_0x6aa847['id']})),_0xaadef3;};function getStatus(_0x1bba05,_0x2d2881){const _0x2c7ae2=a558_0xe1cba4;if(_0x1bba05[_0x2c7ae2(0x1d5)]==baileys_1[_0x2c7ae2(0x144)][_0x2c7ae2(0x277)]['Status'][_0x2c7ae2(0x281)]){if(_0x1bba05['key'][_0x2c7ae2(0x17f)]&&_0x2d2881==_0x2c7ae2(0x241))return 0x3;return 0x1;}else{if(_0x1bba05[_0x2c7ae2(0x1d5)]==baileys_1['proto'][_0x2c7ae2(0x277)][_0x2c7ae2(0x28a)][_0x2c7ae2(0x166)])return 0x1;else{if(_0x1bba05[_0x2c7ae2(0x1d5)]==baileys_1[_0x2c7ae2(0x144)][_0x2c7ae2(0x277)][_0x2c7ae2(0x28a)][_0x2c7ae2(0x2cc)])return 0x2;else{if(_0x1bba05[_0x2c7ae2(0x1d5)]==baileys_1[_0x2c7ae2(0x144)][_0x2c7ae2(0x277)][_0x2c7ae2(0x28a)]['READ']||_0x1bba05[_0x2c7ae2(0x1d5)]==baileys_1[_0x2c7ae2(0x144)][_0x2c7ae2(0x277)]['Status'][_0x2c7ae2(0x290)])return 0x3;}}}return 0x0;}const verifyMessage=async(_0x3c1ea9,_0x2b4628,_0x114578)=>{const _0x65f97=a558_0xe1cba4,_0x4226ac=(0x0,socket_1['getIO'])(),_0x46fe69=await(0x0,exports[_0x65f97(0x1da)])(_0x3c1ea9),_0x33106b=(0x0,exports[_0x65f97(0x18d)])(_0x3c1ea9);if(!_0x33106b)return;let _0x1f58bb=getTypeMessage(_0x3c1ea9);const _0x2d9872=_0x1f58bb==_0x65f97(0x125)||_0x3c1ea9?.['message']?.['protocolMessage']?.[_0x65f97(0x26e)]==baileys_1[_0x65f97(0x144)][_0x65f97(0x2b1)][_0x65f97(0x200)][_0x65f97(0x168)][_0x65f97(0x127)]||_0x3c1ea9?.[_0x65f97(0x2a7)]?.[_0x65f97(0x260)]?.[_0x65f97(0x125)]?.['conversation']?.[_0x65f97(0x237)]>0x0;let _0x1a125e=_0x3c1ea9['key']['id'];if(_0x1f58bb==_0x65f97(0x260))_0x1a125e=_0x3c1ea9?.[_0x65f97(0x2a7)]?.[_0x65f97(0x260)]?.[_0x65f97(0x249)]?.['id']||_0x3c1ea9[_0x65f97(0x249)]['id'];else _0x1f58bb=='editedMessage'&&(_0x1a125e=_0x3c1ea9?.[_0x65f97(0x2a7)]?.[_0x65f97(0x125)]?.['message']?.[_0x65f97(0x260)]?.['key']?.['id']||_0x3c1ea9[_0x65f97(0x249)]['id']);const _0xfea37a={'id':_0x1a125e,'ticketId':_0x2b4628['id'],'contactId':_0x3c1ea9[_0x65f97(0x249)][_0x65f97(0x17f)]?undefined:_0x114578['id'],'body':_0x33106b,'fromMe':_0x3c1ea9['key'][_0x65f97(0x17f)],'mediaType':_0x1f58bb,'read':_0x3c1ea9[_0x65f97(0x249)][_0x65f97(0x17f)],'quotedMsgId':_0x46fe69?.['id'],'ack':getStatus(_0x3c1ea9,_0x1f58bb),'remoteJid':_0x3c1ea9[_0x65f97(0x249)][_0x65f97(0x16c)],'participant':_0x3c1ea9[_0x65f97(0x249)][_0x65f97(0x1f9)],'dataJson':JSON[_0x65f97(0x18c)](_0x3c1ea9),'isEdited':_0x2d9872};typeof _0x33106b!='string'&&console[_0x65f97(0x1eb)](_0x65f97(0x105),_0x33106b);await _0x2b4628['update']({'lastMessage':_0x33106b});if(_0x2d9872){let _0x38b1a5=await Message_1['default']['findByPk'](_0xfea37a['id']);if(_0x38b1a5){const _0x5ce83c={'messageId':_0xfea37a['id'],'body':_0x38b1a5[_0x65f97(0x188)]};await OldMessage_1['default']['upsert'](_0x5ce83c);}else console[_0x65f97(0x26b)](_0x65f97(0x2d7)+_0xfea37a['id']);}await(0x0,CreateMessageService_1[_0x65f97(0x101)])({'messageData':_0xfea37a,'ticket':_0x2b4628,'companyId':_0x2b4628[_0x65f97(0x203)]}),!_0x3c1ea9[_0x65f97(0x249)][_0x65f97(0x17f)]&&_0x2b4628[_0x65f97(0x1d5)]===_0x65f97(0x263)&&(await _0x2b4628[_0x65f97(0x111)]({'status':_0x65f97(0x138)}),await _0x2b4628['reload']({'include':[{'model':Queue_1[_0x65f97(0x101)],'as':'queue'},{'model':User_1['default'],'as':_0x65f97(0x25e)},{'model':Contact_1[_0x65f97(0x101)],'as':_0x65f97(0x291)}]}),_0x4226ac['to']('company-'+_0x2b4628['companyId']+_0x65f97(0x1df))[_0x65f97(0x24c)]('company-'+_0x2b4628['companyId']+_0x65f97(0x266),{'action':_0x65f97(0x10b),'ticket':_0x2b4628,'ticketId':_0x2b4628['id']}),_0x4226ac['to'](_0x65f97(0x1b8)+_0x2b4628[_0x65f97(0x203)]+'-'+_0x2b4628['status'])['to'](_0x2b4628['id'][_0x65f97(0x1ae)]())[_0x65f97(0x24c)]('company-'+_0x2b4628[_0x65f97(0x203)]+_0x65f97(0x266),{'action':_0x65f97(0x111),'ticket':_0x2b4628,'ticketId':_0x2b4628['id']}));};exports[a558_0xe1cba4(0x1e5)]=verifyMessage;const isValidMsg=_0x2e5718=>{const _0x2966a4=a558_0xe1cba4;if(_0x2e5718['key'][_0x2966a4(0x16c)]===_0x2966a4(0x2d0))return![];try{const _0x4b9470=getTypeMessage(_0x2e5718);if(!_0x4b9470)return![];const _0x42b795=_0x4b9470===_0x2966a4(0x1b2)||_0x4b9470===_0x2966a4(0x125)||_0x4b9470==='extendedTextMessage'||_0x4b9470===_0x2966a4(0x1f8)||_0x4b9470===_0x2966a4(0x25d)||_0x4b9470===_0x2966a4(0x24d)||_0x4b9470===_0x2966a4(0x27b)||_0x4b9470===_0x2966a4(0x133)||_0x4b9470==='interactiveMessage'||_0x4b9470===_0x2966a4(0x14c)||_0x4b9470===_0x2966a4(0x230)||_0x4b9470===_0x2966a4(0x24a)||_0x4b9470===_0x2966a4(0x282)||_0x4b9470===_0x2966a4(0x28e)||_0x4b9470===_0x2966a4(0x1be)||_0x4b9470===_0x2966a4(0x15e)||_0x4b9470==='locationMessage'||_0x4b9470===_0x2966a4(0x110)||_0x4b9470===_0x2966a4(0x130)||_0x4b9470===_0x2966a4(0x223)||_0x4b9470===_0x2966a4(0x15a)||_0x4b9470===_0x2966a4(0x2c1)||_0x4b9470===_0x2966a4(0x241)||_0x4b9470===_0x2966a4(0x2c5)||_0x4b9470===_0x2966a4(0x260)||_0x4b9470===_0x2966a4(0x102)||_0x4b9470===_0x2966a4(0x2a5)||_0x4b9470==='viewOnceMessage'||_0x4b9470===_0x2966a4(0x292)||_0x4b9470==='advertising'||_0x4b9470===_0x2966a4(0x288);return!_0x42b795&&(logger_1[_0x2966a4(0x19a)][_0x2966a4(0x1c1)](_0x2966a4(0x1fa)+_0x4b9470+'\x0a'+JSON[_0x2966a4(0x18c)](_0x2e5718?.[_0x2966a4(0x2a7)])),Sentry[_0x2966a4(0x2b0)]('Mensagem',{'BodyMsg':_0x2e5718[_0x2966a4(0x2a7)],'msg':_0x2e5718,'msgType':_0x4b9470}),Sentry[_0x2966a4(0x106)](new Error(_0x2966a4(0x1cd)))),!!_0x42b795;}catch(_0x3287e7){Sentry[_0x2966a4(0x2b0)](_0x2966a4(0x11e),{'msg':_0x2e5718}),Sentry['captureException'](_0x3287e7);}return![];};exports[a558_0xe1cba4(0x147)]=isValidMsg;const Push=_0xffc795=>{return _0xffc795['pushName'];},verifyQueue=async(_0x3598a9,_0x585757,_0x188296,_0x4f0207,_0x241509)=>{const _0x39e31e=a558_0xe1cba4,_0x21bef4=_0x188296[_0x39e31e(0x203)],{queues:_0x5ba731,greetingMessage:_0x51eab7,maxUseBotQueues:_0x2caaaf,timeUseBotQueues:_0x583331}=await(0x0,ShowWhatsAppService_1['default'])(_0x3598a9['id'],_0x188296[_0x39e31e(0x203)]);if(_0x5ba731['length']===0x1){const _0x1db10a=(0x0,lodash_1['head'])(_0x5ba731);let _0x43c0ed=![];_0x1db10a?.[_0x39e31e(0x26d)]&&(_0x43c0ed=_0x1db10a[_0x39e31e(0x26d)][_0x39e31e(0x237)]>0x0);const _0x324aa5=await Setting_1[_0x39e31e(0x101)][_0x39e31e(0xff)]({'where':{'key':_0x39e31e(0x1cb),'companyId':_0x188296[_0x39e31e(0x203)]}});greetingMessageControl['push']({'ticketId':_0x188296['id'],'greetingMessage':_0x51eab7,'companyId':_0x21bef4});if(_0x51eab7[_0x39e31e(0x237)]>0x1&&_0x324aa5?.['value']==='enabled'){const _0x357599=await Message_1[_0x39e31e(0x101)][_0x39e31e(0xff)]({'where':{'ticketId':_0x188296['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x39e31e(0x254)]]:(0x0,moment_1[_0x39e31e(0x101)])()['subtract'](0x5,'minutes')['toDate']()}}});if(_0x357599)return;const _0x1919ec=(0x0,Mustache_1[_0x39e31e(0x101)])(''+_0x51eab7,_0x188296);await _0x3598a9[_0x39e31e(0x202)](_0x4f0207[_0x39e31e(0x11b)]+'@'+(_0x188296[_0x39e31e(0x165)]?_0x39e31e(0x10d):_0x39e31e(0x1b1)),{'text':_0x1919ec});}const _0x1d1512=await(0x0,ShowWhatsAppService_1[_0x39e31e(0x101)])(_0x3598a9['id'],_0x21bef4),_0x390114=_0x5ba731[0x0]?.[_0x39e31e(0x22e)]||_0x1d1512[_0x39e31e(0x22e)];if(!_0x585757[_0x39e31e(0x249)][_0x39e31e(0x17f)]&&!_0x188296[_0x39e31e(0x165)]&&!(0x0,lodash_1[_0x39e31e(0x2bf)])(_0x390114)){const _0x4bafb6=await(0x0,ShowQueueIntegrationService_1[_0x39e31e(0x101)])(_0x390114,_0x21bef4);await(0x0,exports[_0x39e31e(0x1f3)])(_0x585757,_0x3598a9,_0x4bafb6,_0x188296),await _0x188296[_0x39e31e(0x111)]({'useIntegration':!![],'integrationId':_0x4bafb6['id']});}const _0x26d009=_0x5ba731[0x0]?.[_0x39e31e(0x123)]||_0x1d1512[_0x39e31e(0x123)];!_0x585757[_0x39e31e(0x249)]['fromMe']&&!_0x188296[_0x39e31e(0x165)]&&!(0x0,lodash_1[_0x39e31e(0x2bf)])(_0x26d009)&&(console['log'](_0x39e31e(0x243)),await handleOpenAi(_0x585757,_0x3598a9,_0x188296,_0x4f0207,_0x241509),await _0x188296[_0x39e31e(0x111)]({'useIntegration':!![],'promptId':_0x26d009}));await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x1db10a?.['id'],'chatbot':_0x43c0ed,'status':'pending'},'ticketId':_0x188296['id'],'companyId':_0x188296['companyId']});return;}const _0xfd6e41=_0x585757?.[_0x39e31e(0x2a7)]?.[_0x39e31e(0x28e)]?.[_0x39e31e(0x1c7)]||_0x585757?.[_0x39e31e(0x2a7)]?.['listResponseMessage']?.[_0x39e31e(0x22d)]?.[_0x39e31e(0x286)]||_0x585757?.[_0x39e31e(0x2a7)]?.[_0x39e31e(0x265)]?.[_0x39e31e(0x283)]||_0x585757?.[_0x39e31e(0x2a7)]?.[_0x39e31e(0x1b2)];let _0x38eadd=null;if(_0xfd6e41&&!(0x0,exports[_0x39e31e(0x1fc)])(_0xfd6e41)||+_0xfd6e41>_0x5ba731['length']){const _0x21d2d7=_0xfd6e41[_0x39e31e(0x2d1)]();for(let _0x45e9d2 of _0x5ba731){if(_0x45e9d2[_0x39e31e(0x29f)][_0x39e31e(0x2d1)]()===_0x21d2d7){_0x38eadd=_0x45e9d2;break;}if(_0x45e9d2[_0x39e31e(0x17a)]&&_0x45e9d2[_0x39e31e(0x17a)][_0x39e31e(0x237)]>0x0){let _0x39cfa3=_0x45e9d2[_0x39e31e(0x17a)][_0x39e31e(0x23b)](',\x20');for(let _0x4ff8ea of _0x39cfa3){if(_0x4ff8ea[_0x39e31e(0x2d1)]()==_0x21d2d7){_0x38eadd=_0x45e9d2;break;}}}}}else _0x38eadd=_0x5ba731[+_0xfd6e41-0x1];const _0x1d9b13=await Setting_1[_0x39e31e(0x101)]['findOne']({'where':{'key':'chatBotType','companyId':_0x21bef4}}),_0x5774f6=async()=>{const _0x11a0c8=_0x39e31e;let _0x587f23='';if(outOfHourMessageControl[_0x11a0c8(0x237)]>0x1388)outOfHourMessageControl=[];_0x5ba731['forEach']((_0x471455,_0x446644)=>{const _0x43aa5a=_0x11a0c8;_0x587f23+=_0x43aa5a(0x1e0)+(_0x446644+0x1)+_0x43aa5a(0x19f)+_0x471455[_0x43aa5a(0x29f)]+'\x0a';});if(process[_0x11a0c8(0x10c)][_0x11a0c8(0x1e8)]?.['length']>=0x8){if(_0x188296[_0x11a0c8(0x291)][_0x11a0c8(0x11b)]!=process[_0x11a0c8(0x10c)][_0x11a0c8(0x1e8)]){console['trace'](_0x11a0c8(0x2cb));return;}}const _0x13e740={'text':(0x0,Mustache_1[_0x11a0c8(0x101)])('‎'+_0x51eab7+'\x0a\x0a'+_0x587f23,_0x188296)};await(0x0,UpdateTicketService_1[_0x11a0c8(0x101)])({'ticketData':{'amountUsedBotQueues':_0x188296[_0x11a0c8(0x121)]+0x1},'ticketId':_0x188296['id'],'companyId':_0x188296['companyId']});const _0x5369ed=await _0x3598a9[_0x11a0c8(0x202)](_0x4f0207[_0x11a0c8(0x11b)]+'@'+(_0x188296[_0x11a0c8(0x165)]?_0x11a0c8(0x10d):'s.whatsapp.net'),_0x13e740);await(0x0,exports[_0x11a0c8(0x1e5)])(_0x5369ed,_0x188296,_0x188296[_0x11a0c8(0x291)]);};if(_0x38eadd){let _0x166cf3=![];_0x38eadd?.[_0x39e31e(0x26d)]&&(_0x166cf3=_0x38eadd[_0x39e31e(0x26d)][_0x39e31e(0x237)]>0x0);await(0x0,UpdateTicketService_1[_0x39e31e(0x101)])({'ticketData':{'queueId':_0x38eadd['id'],'chatbot':_0x166cf3,'status':_0x39e31e(0x138),'amountUsedBotQueues':0x0},'ticketId':_0x188296['id'],'companyId':_0x188296[_0x39e31e(0x203)]}),console[_0x39e31e(0x1eb)](_0x38eadd[_0x39e31e(0x26d)]);if(_0x38eadd[_0x39e31e(0x26d)][_0x39e31e(0x237)]===0x0){const _0x35c837=await Queue_1[_0x39e31e(0x101)][_0x39e31e(0x12f)](_0x38eadd['id']),{schedules:_0x1c80d5}=_0x35c837,_0x377bf2=(0x0,moment_1['default'])(),_0x56c3f9=_0x377bf2[_0x39e31e(0x1c0)]('dddd')[_0x39e31e(0x2d1)]();let _0x3b3be1;Array[_0x39e31e(0x2c7)](_0x1c80d5)&&_0x1c80d5[_0x39e31e(0x237)]>0x0&&(_0x3b3be1=_0x1c80d5[_0x39e31e(0x264)](_0x40a6ee=>_0x40a6ee[_0x39e31e(0x2c0)]===_0x56c3f9&&_0x40a6ee['startTime']!==''&&_0x40a6ee[_0x39e31e(0x1c3)]!==null&&_0x40a6ee[_0x39e31e(0x185)]!==''&&_0x40a6ee[_0x39e31e(0x185)]!==null));if(_0x35c837['outOfHoursMessage']!==null&&_0x35c837['outOfHoursMessage']!==''&&!(0x0,lodash_1[_0x39e31e(0x2bf)])(_0x3b3be1)){var _0x419199=outOfHourMessageControl[_0x39e31e(0x264)](_0x2576d1=>_0x2576d1[_0x39e31e(0x220)]===_0x188296['id']||_0x2576d1['dest']===_0x4f0207[_0x39e31e(0x11b)]);if(!_0x419199||_0x419199&&_0x419199[_0x39e31e(0x103)]+0x3e8*0x3c*0x5<new Date()['getTime']()){_0x419199&&(outOfHourMessageControl=outOfHourMessageControl[_0x39e31e(0x1ef)](_0x35a500=>_0x35a500[_0x39e31e(0x220)]!==_0x188296['id']),_0x419199=null);const _0x2a1b59=(0x0,moment_1['default'])(_0x3b3be1[_0x39e31e(0x1c3)],_0x39e31e(0x1a0)),_0x2feda3=(0x0,moment_1['default'])(_0x3b3be1[_0x39e31e(0x185)],_0x39e31e(0x1a0));outOfHourMessageControl['push']({'ticketId':_0x188296['id'],'time':new Date()[_0x39e31e(0x2b2)]()});if(_0x377bf2[_0x39e31e(0x18a)](_0x2a1b59)||_0x377bf2['isAfter'](_0x2feda3)){const _0x89ae5a=(0x0,Mustache_1['default'])('‎\x20'+_0x35c837[_0x39e31e(0x1ea)]+_0x39e31e(0x175),_0x188296),_0xf5dbbb=await _0x3598a9[_0x39e31e(0x202)](_0x4f0207[_0x39e31e(0x11b)]+'@'+(_0x188296[_0x39e31e(0x165)]?_0x39e31e(0x10d):_0x39e31e(0x1b1)),{'text':_0x89ae5a});await(0x0,exports['verifyMessage'])(_0xf5dbbb,_0x188296,_0x4f0207),await(0x0,UpdateTicketService_1[_0x39e31e(0x101)])({'ticketData':{'queueId':null,'chatbot':_0x166cf3},'ticketId':_0x188296['id'],'companyId':_0x188296['companyId']}),console[_0x39e31e(0x26b)](_0x39e31e(0x191));return;}}!_0x419199&&outOfHourMessageControl['push']({'ticketId':_0x188296['id'],'dest':_0x4f0207['number'],'time':new Date()[_0x39e31e(0x2b2)]()});}console['trace'](_0x38eadd[_0x39e31e(0x22e)]);if(!_0x585757[_0x39e31e(0x249)]['fromMe']&&!_0x188296[_0x39e31e(0x165)]&&_0x38eadd[_0x39e31e(0x22e)]){const _0x4f20d4=await(0x0,ShowQueueIntegrationService_1[_0x39e31e(0x101)])(_0x38eadd[_0x39e31e(0x22e)],_0x21bef4);await(0x0,exports[_0x39e31e(0x1f3)])(_0x585757,_0x3598a9,_0x4f20d4,_0x188296),await _0x188296[_0x39e31e(0x111)]({'useIntegration':!![],'integrationId':_0x4f20d4['id']});}!_0x585757['key'][_0x39e31e(0x17f)]&&!_0x188296[_0x39e31e(0x165)]&&!(0x0,lodash_1[_0x39e31e(0x2bf)])(_0x38eadd?.[_0x39e31e(0x123)])&&(await handleOpenAi(_0x585757,_0x3598a9,_0x188296,_0x4f0207,_0x241509),await _0x188296['update']({'useIntegration':!![],'promptId':_0x38eadd?.[_0x39e31e(0x123)]}));const _0x11d813=(0x0,Mustache_1[_0x39e31e(0x101)])('‎'+_0x38eadd[_0x39e31e(0x2c9)],_0x188296);if(_0x38eadd[_0x39e31e(0x2c9)]){const _0x481cfe=await _0x3598a9[_0x39e31e(0x202)](_0x4f0207[_0x39e31e(0x11b)]+'@'+(_0x188296[_0x39e31e(0x165)]?_0x39e31e(0x10d):_0x39e31e(0x1b1)),{'text':_0x11d813});await(0x0,exports[_0x39e31e(0x1e5)])(_0x481cfe,_0x188296,_0x4f0207);if(_0x38eadd['mediaPath']!==null&&_0x38eadd[_0x39e31e(0x293)]!==''){const _0x52371c=path_1[_0x39e31e(0x101)][_0x39e31e(0x2a4)]('public',_0x39e31e(0x114)+_0x38eadd[_0x39e31e(0x203)],_0x38eadd[_0x39e31e(0x293)]),_0x112850=await(0x0,SendWhatsAppMedia_1[_0x39e31e(0x1ba)])(_0x38eadd[_0x39e31e(0x2ca)],_0x52371c,null,_0x188296['companyId']);let _0x142894=await _0x3598a9[_0x39e31e(0x202)](_0x188296[_0x39e31e(0x291)][_0x39e31e(0x11b)]+'@'+(_0x188296[_0x39e31e(0x165)]?_0x39e31e(0x10d):_0x39e31e(0x1b1)),{..._0x112850});await verifyMediaMessage(_0x142894,_0x188296,_0x4f0207);}}}}else{if(_0x2caaaf&&_0x2caaaf!==0x0&&_0x188296[_0x39e31e(0x121)]>=_0x2caaaf)return;const _0x316150=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x188296['id'],'companyId':_0x21bef4});let _0x326cc7=new Date(),_0x1a6c9d=new Date();if(_0x316150['chatbotAt']!==null){_0x326cc7[_0x39e31e(0x1d8)](_0x316150[_0x39e31e(0x2c3)][_0x39e31e(0x17d)]()+Number(_0x583331));if(_0x316150[_0x39e31e(0x2c3)]!==null&&_0x1a6c9d<_0x326cc7&&_0x583331!=='0'&&_0x188296[_0x39e31e(0x121)]!==0x0)return;}await _0x316150[_0x39e31e(0x111)]({'updatedAt':new Date()});if(_0x1d9b13[_0x39e31e(0x1a1)]===_0x39e31e(0x283))return console[_0x39e31e(0x1eb)](_0x39e31e(0x10a)),_0x5774f6();}},verifyRating=_0xd85c58=>{const _0x30f59f=a558_0xe1cba4;return _0xd85c58&&_0xd85c58['finishedAt']===null&&_0xd85c58[_0x30f59f(0x2ab)]!==null&&_0xd85c58[_0x30f59f(0x1ff)]!==null;};exports[a558_0xe1cba4(0x226)]=verifyRating;const handleRating=async(_0x26e86,_0x53eb9c,_0x3d5fe2)=>{const _0x4c7d4b=a558_0xe1cba4,_0x2b4e3d=(0x0,socket_1[_0x4c7d4b(0x246)])();let _0x1f6192=null;(_0x26e86?.[_0x4c7d4b(0x2a7)]?.[_0x4c7d4b(0x1b2)]||_0x26e86?.[_0x4c7d4b(0x2a7)]?.[_0x4c7d4b(0x265)])&&(_0x1f6192=parseInt(_0x26e86[_0x4c7d4b(0x2a7)][_0x4c7d4b(0x1b2)]||_0x26e86[_0x4c7d4b(0x2a7)][_0x4c7d4b(0x265)][_0x4c7d4b(0x283)],0xa)||null);if(!Number[_0x4c7d4b(0x227)](_0x1f6192)&&Number['isInteger'](_0x1f6192)&&!(0x0,lodash_1[_0x4c7d4b(0x2c2)])(_0x1f6192)){const {complationMessage:_0x14e580}=await(0x0,ShowWhatsAppService_1[_0x4c7d4b(0x101)])(_0x53eb9c['whatsappId'],_0x53eb9c['companyId']);let _0x18886f=_0x1f6192;_0x1f6192<0x1&&(_0x18886f=0x1);_0x1f6192>0x5&&(_0x18886f=0x5);await UserRating_1[_0x4c7d4b(0x101)]['create']({'ticketId':_0x3d5fe2['ticketId'],'companyId':_0x3d5fe2[_0x4c7d4b(0x203)],'userId':_0x3d5fe2[_0x4c7d4b(0x2ab)],'rate':_0x18886f});if(_0x14e580){if(completionMessageControl[_0x4c7d4b(0x237)]>=0x9c4)completionMessageControl=[];var _0x47f694=completionMessageControl[_0x4c7d4b(0x264)](_0x5ca822=>_0x5ca822[_0x4c7d4b(0x220)]===_0x53eb9c['id']||_0x5ca822[_0x4c7d4b(0x221)]===_0x53eb9c['contact'][_0x4c7d4b(0x11b)]);if(!_0x47f694||_0x47f694&&_0x47f694['time']+0x3e8*0x3c*0x1e<new Date()[_0x4c7d4b(0x2b2)]()){_0x47f694&&(completionMessageControl=completionMessageControl['filter'](_0x4935af=>_0x4935af[_0x4c7d4b(0x220)]!==_0x53eb9c['id']),_0x47f694=null);const _0xa1be24=(0x0,Mustache_1[_0x4c7d4b(0x101)])('‎'+_0x14e580,_0x53eb9c);await(0x0,SendPresenceStatus_1[_0x4c7d4b(0x25f)])((0x0,wbot_1[_0x4c7d4b(0x108)])(_0x53eb9c[_0x4c7d4b(0x2cf)]),_0x53eb9c[_0x4c7d4b(0x291)][_0x4c7d4b(0x11b)]+'@'+(_0x53eb9c[_0x4c7d4b(0x165)]?_0x4c7d4b(0x10d):_0x4c7d4b(0x1b1))),await(0x0,SendWhatsAppMessage_1[_0x4c7d4b(0x101)])({'body':_0xa1be24,'ticket':_0x53eb9c});}!_0x47f694&&completionMessageControl['push']({'ticketId':_0x53eb9c['id'],'dest':_0x53eb9c['contact'][_0x4c7d4b(0x11b)],'time':new Date()[_0x4c7d4b(0x2b2)]()});}await _0x3d5fe2[_0x4c7d4b(0x111)]({'finishedAt':(0x0,moment_1[_0x4c7d4b(0x101)])()[_0x4c7d4b(0x275)](),'ratedAt':(0x0,moment_1[_0x4c7d4b(0x101)])()[_0x4c7d4b(0x275)](),'rated':!![]}),await _0x53eb9c[_0x4c7d4b(0x111)]({'queueId':null,'chatbot':null,'queueOptionId':null,'userId':null,'status':_0x4c7d4b(0x263)}),_0x2b4e3d['to']('company-'+_0x53eb9c[_0x4c7d4b(0x203)]+_0x4c7d4b(0x19c))[_0x4c7d4b(0x24c)]('company-'+_0x53eb9c[_0x4c7d4b(0x203)]+_0x4c7d4b(0x266),{'action':_0x4c7d4b(0x10b),'ticket':_0x53eb9c,'ticketId':_0x53eb9c['id']}),_0x2b4e3d['to'](_0x4c7d4b(0x1b8)+_0x53eb9c['companyId']+'-'+_0x53eb9c['status'])['to'](_0x53eb9c['id']['toString']())[_0x4c7d4b(0x24c)](_0x4c7d4b(0x1b8)+_0x53eb9c[_0x4c7d4b(0x203)]+'-ticket',{'action':_0x4c7d4b(0x111),'ticket':_0x53eb9c,'ticketId':_0x53eb9c['id']});}};exports[a558_0xe1cba4(0x1db)]=handleRating;const handleChartbot=async(_0x2a9787,_0x25968d,_0x3ccb22,_0x38e53f,_0x14808e=![])=>{const _0x1bbcbd=a558_0xe1cba4;if(!_0x2a9787[_0x1bbcbd(0x291)][_0x1bbcbd(0x2a6)]){const _0x2261b2=await Queue_1['default'][_0x1bbcbd(0x12f)](_0x2a9787['queueId'],{'include':[{'model':QueueOption_1[_0x1bbcbd(0x101)],'as':'options','where':{'parentId':null},'order':[[_0x1bbcbd(0x225),_0x1bbcbd(0x219)],[_0x1bbcbd(0x100),_0x1bbcbd(0x219)]]}]}),_0x22d283=_0x25968d?.[_0x1bbcbd(0x2a7)]?.['buttonsResponseMessage']?.['selectedButtonId']||_0x25968d?.[_0x1bbcbd(0x2a7)]?.[_0x1bbcbd(0x102)]?.[_0x1bbcbd(0x22d)]?.['selectedRowId']||_0x25968d?.['message']?.[_0x1bbcbd(0x265)]?.['text']||_0x25968d?.['message']?.[_0x1bbcbd(0x1b2)];if(_0x22d283=='#'&&(!_0x2a9787[_0x1bbcbd(0x2ab)]||_0x2a9787[_0x1bbcbd(0x1d5)]=='pending')){console['trace'](_0x1bbcbd(0x238)),await _0x2a9787['update']({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x3ccb22,_0x25968d,_0x2a9787,_0x2a9787['contact']);return;}if(!(0x0,lodash_1[_0x1bbcbd(0x2bf)])(_0x2261b2)&&!(0x0,lodash_1[_0x1bbcbd(0x2bf)])(_0x2a9787[_0x1bbcbd(0x2b9)])&&_0x22d283=='0'){console[_0x1bbcbd(0x1eb)](_0x1bbcbd(0x1ee));const _0x2b3eac=await QueueOption_1[_0x1bbcbd(0x101)][_0x1bbcbd(0x12f)](_0x2a9787[_0x1bbcbd(0x2b9)]);await _0x2a9787[_0x1bbcbd(0x111)]({'queueOptionId':_0x2b3eac?.[_0x1bbcbd(0x139)],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1['isNil'])(_0x2261b2)&&!(0x0,lodash_1[_0x1bbcbd(0x2bf)])(_0x2a9787[_0x1bbcbd(0x2b9)])){console[_0x1bbcbd(0x1eb)](_0x1bbcbd(0x141));const _0x40e53a=await QueueOption_1[_0x1bbcbd(0x101)][_0x1bbcbd(0x295)]({'where':{'parentId':_0x2a9787[_0x1bbcbd(0x2b9)]}});let _0x3b5002={};_0x40e53a==0x1?_0x3b5002=await QueueOption_1[_0x1bbcbd(0x101)][_0x1bbcbd(0xff)]({'where':{'parentId':_0x2a9787['queueOptionId']}}):(console[_0x1bbcbd(0x1eb)](_0x1bbcbd(0x13c)),_0x3b5002=await QueueOption_1[_0x1bbcbd(0x101)][_0x1bbcbd(0xff)]({'where':{[sequelize_1['Op']['or']]:[{'option':_0x22d283||''},{'title':_0x22d283||''}],'parentId':_0x2a9787['queueOptionId']}})),_0x3b5002&&await _0x2a9787[_0x1bbcbd(0x111)]({'queueOptionId':_0x3b5002?.['id'],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1[_0x1bbcbd(0x2bf)])(_0x2261b2)&&(0x0,lodash_1[_0x1bbcbd(0x2bf)])(_0x2a9787[_0x1bbcbd(0x2b9)])&&!_0x14808e){console[_0x1bbcbd(0x1eb)](_0x1bbcbd(0x2a3));const _0x3d4e34=_0x2261b2?.['options'][_0x1bbcbd(0x264)](_0x3cb1fd=>_0x3cb1fd[_0x1bbcbd(0x225)]==_0x22d283||_0x3cb1fd[_0x1bbcbd(0x150)][_0x1bbcbd(0x2d1)]()==_0x22d283['toLowerCase']());if(_0x3d4e34)await _0x2a9787['update']({'queueOptionId':_0x3d4e34?.['id'],'amountUsedBotQueues':0x0});else{if(_0x38e53f[_0x1bbcbd(0x28f)]&&_0x38e53f['maxUseBotQueues']!==0x0&&_0x2a9787[_0x1bbcbd(0x121)]>=_0x38e53f[_0x1bbcbd(0x28f)])return;await _0x2a9787[_0x1bbcbd(0x111)]({'amountUsedBotQueues':_0x2a9787[_0x1bbcbd(0x121)]+0x1});}}else{if(_0x38e53f[_0x1bbcbd(0x28f)]&&_0x38e53f[_0x1bbcbd(0x28f)]!==0x0&&_0x2a9787[_0x1bbcbd(0x121)]>=_0x38e53f[_0x1bbcbd(0x28f)])return;await _0x2a9787[_0x1bbcbd(0x111)]({'amountUsedBotQueues':_0x2a9787[_0x1bbcbd(0x121)]+0x1});}}}await _0x2a9787[_0x1bbcbd(0x253)]();if(!(0x0,lodash_1['isNil'])(_0x2261b2)&&(0x0,lodash_1['isNil'])(_0x2a9787[_0x1bbcbd(0x2b9)])){const _0x31f21a=await QueueOption_1[_0x1bbcbd(0x101)]['findAll']({'where':{'queueId':_0x2a9787[_0x1bbcbd(0x172)],'parentId':null},'order':[['option','ASC'],[_0x1bbcbd(0x100),_0x1bbcbd(0x219)]]}),_0x35b951=_0x2a9787[_0x1bbcbd(0x203)],_0x440384=await Setting_1['default'][_0x1bbcbd(0xff)]({'where':{'key':_0x1bbcbd(0x190),'companyId':_0x35b951}}),_0x17c832=async()=>{const _0x251724=_0x1bbcbd,_0x1b93b2=[];_0x31f21a[_0x251724(0x209)]((_0x17e4f9,_0x297399)=>{const _0x4dd665=_0x251724;_0x1b93b2['push']({'buttonId':''+_0x17e4f9[_0x4dd665(0x225)],'buttonText':{'displayText':_0x17e4f9['title']},'type':0x4});}),_0x1b93b2[_0x251724(0x1b4)]({'buttonId':'#','buttonText':{'displayText':_0x251724(0x186)},'type':0x4});const _0x51740f={'text':(0x0,Mustache_1[_0x251724(0x101)])('‎'+_0x2261b2[_0x251724(0x2c9)],_0x2a9787),'buttons':_0x1b93b2,'footer':'DAUMZAP','headerType':0x1},_0x2fddfb=await _0x3ccb22[_0x251724(0x202)](_0x2a9787[_0x251724(0x291)][_0x251724(0x11b)]+'@'+(_0x2a9787['isGroup']?_0x251724(0x10d):'s.whatsapp.net'),_0x51740f);await(0x0,exports[_0x251724(0x1e5)])(_0x2fddfb,_0x2a9787,_0x2a9787[_0x251724(0x291)]);},_0x2385db=async()=>{const _0x5b5690=_0x1bbcbd;let _0x560675='';console[_0x5b5690(0x1eb)]('botText'),console[_0x5b5690(0x26b)](_0x2261b2[_0x5b5690(0x293)]),_0x31f21a[_0x5b5690(0x209)]((_0x3179bc,_0x5ab623)=>{const _0x58f279=_0x5b5690;_0x560675+=_0x58f279(0x1e0)+_0x3179bc[_0x58f279(0x225)]+_0x58f279(0x19f)+_0x3179bc['title']+'\x0a';}),_0x560675+=_0x5b5690(0x296);const _0x52c441={'text':(0x0,Mustache_1['default'])('‎'+_0x2261b2[_0x5b5690(0x2c9)]+'\x0a\x0a'+_0x560675,_0x2a9787)};let _0x8cc445;if(!_0x2261b2[_0x5b5690(0x293)])_0x8cc445=await _0x3ccb22[_0x5b5690(0x202)](_0x2a9787['contact'][_0x5b5690(0x11b)]+'@'+(_0x2a9787[_0x5b5690(0x165)]?_0x5b5690(0x10d):_0x5b5690(0x1b1)),_0x52c441),await(0x0,exports['verifyMessage'])(_0x8cc445,_0x2a9787,_0x2a9787['contact']);else{const _0x4af7b2=path_1['default']['resolve'](_0x5b5690(0x210),_0x5b5690(0x114)+_0x2a9787['companyId'],_0x2261b2['mediaPath']),_0x344c69=await(0x0,SendWhatsAppMedia_1[_0x5b5690(0x1ba)])(_0x52c441['text'],_0x4af7b2,_0x52c441['text'],_0x2a9787[_0x5b5690(0x203)]);_0x8cc445=await _0x3ccb22['sendMessage'](_0x2a9787['contact']['number']+'@'+(_0x2a9787[_0x5b5690(0x165)]?_0x5b5690(0x10d):'s.whatsapp.net'),{..._0x344c69}),await verifyMediaMessage(_0x8cc445,_0x2a9787,_0x2a9787[_0x5b5690(0x291)]);}};if(_0x440384['value']===_0x1bbcbd(0x26c)&&QueueOption_1['default'][_0x1bbcbd(0x237)]<=0x4)return _0x17c832();if(_0x440384[_0x1bbcbd(0x1a1)]===_0x1bbcbd(0x283))return console[_0x1bbcbd(0x1eb)]('botText'),_0x2385db();if(_0x440384[_0x1bbcbd(0x1a1)]===_0x1bbcbd(0x26c)&&QueueOption_1[_0x1bbcbd(0x101)]['length']>0x4)return console[_0x1bbcbd(0x1eb)]('botText'),_0x2385db();}else{if(!(0x0,lodash_1[_0x1bbcbd(0x2bf)])(_0x2261b2)&&!(0x0,lodash_1[_0x1bbcbd(0x2bf)])(_0x2a9787[_0x1bbcbd(0x2b9)])){const _0x15adc9=await QueueOption_1['default'][_0x1bbcbd(0x12f)](_0x2a9787['queueOptionId']),_0x215cf5=await QueueOption_1[_0x1bbcbd(0x101)][_0x1bbcbd(0x2d8)]({'where':{'parentId':_0x2a9787[_0x1bbcbd(0x2b9)]},'order':[[_0x1bbcbd(0x225),'ASC'],['createdAt',_0x1bbcbd(0x219)]]});if(_0x215cf5[_0x1bbcbd(0x237)]===0x0){const _0x5a2345={'text':(0x0,Mustache_1['default'])('‎'+_0x15adc9[_0x1bbcbd(0x2a7)],_0x2a9787)},_0x5685df=await _0x3ccb22[_0x1bbcbd(0x202)](_0x2a9787[_0x1bbcbd(0x291)][_0x1bbcbd(0x11b)]+'@'+(_0x2a9787[_0x1bbcbd(0x165)]?_0x1bbcbd(0x10d):_0x1bbcbd(0x1b1)),_0x5a2345);await(0x0,exports[_0x1bbcbd(0x1e5)])(_0x5685df,_0x2a9787,_0x2a9787[_0x1bbcbd(0x291)]),await _0x2a9787[_0x1bbcbd(0x111)]({'queueOptionId':null,'chatbot':![]});return;}if(_0x215cf5['length']>-0x1){const _0x33b378=_0x2a9787['companyId'],_0x22a39e=await Setting_1[_0x1bbcbd(0x101)][_0x1bbcbd(0xff)]({'where':{'key':_0x1bbcbd(0x190),'companyId':_0x33b378}}),_0x395a27=async()=>{const _0x31f2d7=_0x1bbcbd,_0x3a684a=[],_0x59bda9=_0x2a9787['companyId'],_0x2a9041=await getQueues(_0x59bda9),_0x5b3686=await getContactFromTicket(_0x2a9787['id']);_0x2a9041['forEach']((_0x24e889,_0x5dad3a)=>{const _0x4d1979=a558_0x1c99;_0x3a684a[_0x4d1979(0x1b4)]({'title':'['+(_0x5dad3a+0x1)+_0x4d1979(0x132)+_0x24e889[_0x4d1979(0x29f)],'rowId':''+(_0x5dad3a+0x1)});});const _0x304ca5=[{'rows':_0x3a684a}],_0x4583b1={'text':(0x0,Mustache_1['default'])('‎'+_0x15adc9[_0x31f2d7(0x2a7)],_0x2a9787),'title':_0x31f2d7(0x2bb),'buttonText':_0x31f2d7(0x217),'sections':_0x304ca5};await sleep(0x3e8);const _0x4f7159=await _0x3ccb22[_0x31f2d7(0x202)](_0x31f2d7(0x18b)+_0x5b3686[_0x31f2d7(0x11b)]+'@'+(_0x2a9787[_0x31f2d7(0x165)]?'g.us':'s.whatsapp.net'),_0x4583b1);await(0x0,exports['verifyMessage'])(_0x4f7159,_0x2a9787,_0x2a9787[_0x31f2d7(0x291)]);},_0x4ecec7=async()=>{const _0x579058=_0x1bbcbd,_0x42b7d1=[];_0x215cf5['forEach']((_0x5481f2,_0x3ceca)=>{const _0x112696=a558_0x1c99;_0x42b7d1[_0x112696(0x1b4)]({'buttonId':''+_0x5481f2['option'],'buttonText':{'displayText':_0x5481f2['title']},'type':0x4});}),_0x42b7d1[_0x579058(0x1b4)]({'buttonId':'#','buttonText':{'displayText':_0x579058(0x186)},'type':0x4});const _0x7f12cd={'text':(0x0,Mustache_1[_0x579058(0x101)])('‎'+_0x15adc9[_0x579058(0x2a7)],_0x2a9787),'buttons':_0x42b7d1,'headerType':0x4};if(process[_0x579058(0x10c)][_0x579058(0x1e8)]?.['length']>=0x8){if(_0x2a9787['contact']['number']!=process[_0x579058(0x10c)][_0x579058(0x1e8)]){console['trace']('chatbot\x20desativado!');return;}}if(!_0x15adc9[_0x579058(0x293)]){const _0x1f4fa0=await _0x3ccb22[_0x579058(0x202)](_0x2a9787[_0x579058(0x291)][_0x579058(0x11b)]+'@'+(_0x2a9787[_0x579058(0x165)]?_0x579058(0x10d):_0x579058(0x1b1)),_0x7f12cd);await(0x0,exports[_0x579058(0x1e5)])(_0x1f4fa0,_0x2a9787,_0x2a9787[_0x579058(0x291)]);}else{const _0x23e787=path_1[_0x579058(0x101)]['resolve'](_0x579058(0x210),_0x579058(0x114)+_0x2a9787[_0x579058(0x203)],_0x15adc9['mediaPath']),_0x138554=await(0x0,SendWhatsAppMedia_1[_0x579058(0x1ba)])(_0x15adc9[_0x579058(0x2ca)],_0x23e787,_0x7f12cd[_0x579058(0x283)],_0x2a9787[_0x579058(0x203)]);let _0x18cb19=await _0x3ccb22[_0x579058(0x202)](_0x2a9787['contact'][_0x579058(0x11b)]+'@'+(_0x2a9787['isGroup']?_0x579058(0x10d):_0x579058(0x1b1)),{..._0x138554});await verifyMediaMessage(_0x18cb19,_0x2a9787,_0x2a9787[_0x579058(0x291)]);}const _0x24fa30=await _0x3ccb22[_0x579058(0x202)](_0x2a9787[_0x579058(0x291)][_0x579058(0x11b)]+'@'+(_0x2a9787['isGroup']?_0x579058(0x10d):_0x579058(0x1b1)),_0x7f12cd);await(0x0,exports['verifyMessage'])(_0x24fa30,_0x2a9787,_0x2a9787['contact']);},_0x2cbb73=async()=>{const _0x8979db=_0x1bbcbd;let _0x1b414d='';_0x215cf5[_0x8979db(0x209)]((_0x1fa928,_0x1a8325)=>{const _0x5af1f1=_0x8979db;_0x1b414d+=_0x5af1f1(0x1e0)+_0x1fa928['option']+'\x20]*\x20-\x20'+_0x1fa928[_0x5af1f1(0x150)]+'\x0a';}),_0x1b414d+=_0x8979db(0x1dd),_0x1b414d+=_0x8979db(0x296);const _0x1c8df4={'text':(0x0,Mustache_1[_0x8979db(0x101)])('‎'+_0x15adc9[_0x8979db(0x2a7)]+'\x0a\x0a'+_0x1b414d,_0x2a9787)};if(process[_0x8979db(0x10c)][_0x8979db(0x1e8)]?.[_0x8979db(0x237)]>=0x8){if(_0x2a9787['contact'][_0x8979db(0x11b)]!=process[_0x8979db(0x10c)][_0x8979db(0x1e8)]){console[_0x8979db(0x1eb)](_0x8979db(0x2cb));return;}}if(!_0x15adc9[_0x8979db(0x293)]){const _0x53887b=await _0x3ccb22[_0x8979db(0x202)](_0x2a9787[_0x8979db(0x291)]['number']+'@'+(_0x2a9787[_0x8979db(0x165)]?_0x8979db(0x10d):_0x8979db(0x1b1)),_0x1c8df4);await(0x0,exports[_0x8979db(0x1e5)])(_0x53887b,_0x2a9787,_0x2a9787[_0x8979db(0x291)]);}else{const _0x2c7ec0=path_1[_0x8979db(0x101)][_0x8979db(0x2a4)](_0x8979db(0x210),'company'+_0x2a9787['companyId'],_0x15adc9[_0x8979db(0x293)]),_0x378486=await(0x0,SendWhatsAppMedia_1[_0x8979db(0x1ba)])(_0x15adc9[_0x8979db(0x2ca)],_0x2c7ec0,_0x1c8df4[_0x8979db(0x283)],_0x2a9787[_0x8979db(0x203)]);let _0x540048=await _0x3ccb22['sendMessage'](_0x2a9787[_0x8979db(0x291)]['number']+'@'+(_0x2a9787[_0x8979db(0x165)]?'g.us':_0x8979db(0x1b1)),{..._0x378486});await verifyMediaMessage(_0x540048,_0x2a9787,_0x2a9787[_0x8979db(0x291)]);}};if(_0x22a39e['value']===_0x1bbcbd(0x126))return _0x395a27();if(_0x22a39e[_0x1bbcbd(0x1a1)]===_0x1bbcbd(0x26c)&&QueueOption_1[_0x1bbcbd(0x101)][_0x1bbcbd(0x237)]<=0x4)return _0x4ecec7();if(_0x22a39e[_0x1bbcbd(0x1a1)]==='text')return console[_0x1bbcbd(0x1eb)](_0x1bbcbd(0x20d)),_0x2cbb73();if(_0x22a39e[_0x1bbcbd(0x1a1)]===_0x1bbcbd(0x26c)&&QueueOption_1['default'][_0x1bbcbd(0x237)]>0x4)return console['trace'](_0x1bbcbd(0x2ac)),_0x2cbb73();}}}}},handleMessageIntegration=async(_0x346845,_0x4b9d51,_0x4281fa,_0x3ec087)=>{const _0x91041b=a558_0xe1cba4;if(process[_0x91041b(0x10c)]['CHATBOT_RESTRICT_NUMBER']){if(_0x3ec087['contact']['number']!=process[_0x91041b(0x10c)][_0x91041b(0x1e8)]){console[_0x91041b(0x26b)](_0x91041b(0x2cb));return;}}const _0x2484df=getTypeMessage(_0x346845);if(_0x4281fa['type']===_0x91041b(0x160)||_0x4281fa[_0x91041b(0x26e)]===_0x91041b(0x10f)){if(_0x4281fa?.[_0x91041b(0x1f1)]){const _0x181f28={'method':_0x91041b(0x207),'url':_0x4281fa?.[_0x91041b(0x1f1)],'headers':{'Content-Type':'application/json'},'json':_0x346845};try{(0x0,request_1[_0x91041b(0x101)])(_0x181f28,function(_0x3a07cb,_0x3af5b2){if(_0x3a07cb)throw new Error(_0x3a07cb);else console['log'](_0x3af5b2['body']);});}catch(_0x20f2f1){throw new Error(_0x20f2f1);}}}else _0x4281fa[_0x91041b(0x26e)]===_0x91041b(0x1c8)&&await(0x0,typebotListener_1[_0x91041b(0x101)])({'ticket':_0x3ec087,'msg':_0x346845,'wbot':_0x4b9d51,'typebot':_0x4281fa});};exports[a558_0xe1cba4(0x1f3)]=handleMessageIntegration;const messageContainsMedia=_0xe3101c=>{const _0x149896=a558_0xe1cba4;return _0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x14c)]||_0xe3101c['message']?.[_0x149896(0x1f8)]||_0xe3101c[_0x149896(0x2a7)]?.['videoMessage']||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x282)]||_0xe3101c['message']?.['documentMessage']||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x24a)]?.['message']?.[_0x149896(0x230)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x2c5)]?.[_0x149896(0x2a7)]?.[_0x149896(0x1f8)]||_0xe3101c[_0x149896(0x2a7)]?.['ephemeralMessage']?.[_0x149896(0x2a7)]?.['documentMessage']||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x2c5)]?.[_0x149896(0x2a7)]?.['videoMessage']||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x2c5)]?.[_0x149896(0x2a7)]?.[_0x149896(0x282)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x2c5)]?.[_0x149896(0x2a7)]?.[_0x149896(0x14c)]||_0xe3101c['message']?.[_0x149896(0x21e)]?.['message']?.[_0x149896(0x14c)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x21e)]?.[_0x149896(0x2a7)]?.[_0x149896(0x25d)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x2c5)]?.[_0x149896(0x2a7)]?.[_0x149896(0x21e)]?.[_0x149896(0x2a7)]?.[_0x149896(0x14c)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x2c5)]?.['message']?.[_0x149896(0x21e)]?.[_0x149896(0x2a7)]?.['videoMessage']||_0xe3101c['message']?.[_0x149896(0x2c5)]?.[_0x149896(0x2a7)]?.[_0x149896(0x21e)]?.[_0x149896(0x2a7)]?.[_0x149896(0x1f8)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x2c5)]?.[_0x149896(0x2a7)]?.[_0x149896(0x21e)]?.[_0x149896(0x2a7)]?.[_0x149896(0x230)]||_0xe3101c[_0x149896(0x2a7)]?.['documentWithCaptionMessage']?.['message']?.[_0x149896(0x230)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x27b)]?.[_0x149896(0x189)]?.[_0x149896(0x14c)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x27b)]?.[_0x149896(0x189)]?.['documentMessage']||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x27b)]?.[_0x149896(0x189)]?.[_0x149896(0x25d)]||_0xe3101c[_0x149896(0x2a7)]?.['templateMessage']?.[_0x149896(0x26a)]?.[_0x149896(0x14c)]||_0xe3101c['message']?.[_0x149896(0x27b)]?.[_0x149896(0x26a)]?.[_0x149896(0x230)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x27b)]?.['hydratedFourRowTemplate']?.[_0x149896(0x25d)]||_0xe3101c['message']?.[_0x149896(0x27b)]?.[_0x149896(0x222)]?.[_0x149896(0x14c)]||_0xe3101c[_0x149896(0x2a7)]?.['templateMessage']?.['fourRowTemplate']?.['documentMessage']||_0xe3101c[_0x149896(0x2a7)]?.['templateMessage']?.['fourRowTemplate']?.[_0x149896(0x25d)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x257)]?.['header']?.['imageMessage']||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x257)]?.[_0x149896(0x19e)]?.[_0x149896(0x230)]||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x257)]?.[_0x149896(0x19e)]?.[_0x149896(0x25d)]||_0xe3101c[_0x149896(0x2a7)]?.['highlyStructuredMessage']?.[_0x149896(0x23e)]?.['hydratedTemplate']?.['documentMessage']||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x288)]?.[_0x149896(0x23e)]?.[_0x149896(0x189)]?.['videoMessage']||_0xe3101c[_0x149896(0x2a7)]?.[_0x149896(0x288)]?.[_0x149896(0x23e)]?.[_0x149896(0x189)]?.[_0x149896(0x14c)]||_0xe3101c['message']?.[_0x149896(0x288)]?.[_0x149896(0x23e)]?.[_0x149896(0x189)]?.[_0x149896(0x181)];},handleMessage=async(_0x5ddc82,_0xec536f,_0x588791,_0x1adc07=![])=>{const _0x15ee5a=a558_0xe1cba4;if(_0x1adc07){console['log'](_0x15ee5a(0x176));let _0x3b4937=_0x5ddc82[_0x15ee5a(0x249)]['id'],_0x2be926=await Message_1['default'][_0x15ee5a(0x295)]({'where':{'id':_0x3b4937}});if(_0x2be926>0x0){await new Promise(_0x3392ee=>setTimeout(_0x3392ee,0x96));return;}else await new Promise(_0x4d3be4=>setTimeout(_0x4d3be4,0x14a));}let _0x35692d;if(!(0x0,exports['isValidMsg'])(_0x5ddc82)){console['log'](_0x15ee5a(0x11d)),console[_0x15ee5a(0x26b)](_0x5ddc82);return;}_0x5ddc82[_0x15ee5a(0x2a7)]?.[_0x15ee5a(0x2c5)]&&(_0x5ddc82['message']=_0x5ddc82[_0x15ee5a(0x2a7)][_0x15ee5a(0x2c5)]['message']);try{let _0x21a3cc;const _0x23fb30=_0x5ddc82['key'][_0x15ee5a(0x16c)]?.[_0x15ee5a(0x1e1)]('@g.us'),_0x1257f6=await Setting_1[_0x15ee5a(0x101)][_0x15ee5a(0xff)]({'where':{'companyId':_0x588791,'key':_0x15ee5a(0x14d)}});if(_0x1257f6?.[_0x15ee5a(0x1a1)]===_0x15ee5a(0x1d0)&&_0x23fb30){console[_0x15ee5a(0x26b)](_0x15ee5a(0x2b4));return;}let _0x46a676=(0x0,exports[_0x15ee5a(0x18d)])(_0x5ddc82);const _0x4a7818=getTypeMessage(_0x5ddc82);typeof _0x46a676===_0x15ee5a(0x1f6)&&(_0x46a676=_0x46a676[_0x15ee5a(0x12e)](/\u200c/,''));const _0x1d8101=messageContainsMedia(_0x5ddc82);if(_0x5ddc82['key'][_0x15ee5a(0x17f)]){if(!_0x1d8101&&_0x4a7818!==_0x15ee5a(0x1b2)&&_0x4a7818!=='extendedTextMessage'&&_0x4a7818!=='vcard'&&_0x4a7818!==_0x15ee5a(0x130)&&_0x4a7818!==_0x15ee5a(0x2c5)&&_0x4a7818!==_0x15ee5a(0x260)&&_0x4a7818!==_0x15ee5a(0x241)&&_0x4a7818!==_0x15ee5a(0x21e)&&_0x4a7818!==_0x15ee5a(0x181)&&_0x4a7818!==_0x15ee5a(0x216)&&_0x4a7818!=='advertising'){console['trace'](_0x4a7818);return;}}const _0x52981e=await(0x0,ShowWhatsAppService_1[_0x15ee5a(0x101)])(_0xec536f['id'],_0x588791);let _0x4050a6,_0x156e6c=await getContactMessage(_0x5ddc82,_0xec536f);_0x21a3cc=await verifyContact(_0x156e6c,_0xec536f,_0x588791);if(_0x23fb30){if(!_0x52981e[_0x15ee5a(0x276)])return;try{const _0x5550c3=await _0xec536f[_0x15ee5a(0x1dc)](_0x5ddc82['key'][_0x15ee5a(0x16c)]),_0x494f74={'id':_0x5550c3['id'],'name':_0x5550c3['subject']};_0x4050a6=await verifyContact(_0x494f74,_0xec536f,_0x588791);}catch(_0x1b8e02){console[_0x15ee5a(0x26b)](_0x15ee5a(0x13b)),console[_0x15ee5a(0x26b)](_0x1b8e02);return;}}let _0x54acd1=0x0;if(_0x5ddc82['key']['fromMe'])await cache_1['cacheLayer'][_0x15ee5a(0x143)]('contacts:'+_0x21a3cc['id']+_0x15ee5a(0x180),'0');else{const _0x434acc=await cache_1['cacheLayer'][_0x15ee5a(0x271)](_0x15ee5a(0x22a)+_0x21a3cc['id']+_0x15ee5a(0x180));_0x54acd1=+_0x434acc+0x1,await cache_1[_0x15ee5a(0x215)][_0x15ee5a(0x143)](_0x15ee5a(0x22a)+_0x21a3cc['id']+':unreads',''+_0x54acd1);}const _0x4a2d17=await(0x0,FindOrCreateTicketService_1['default'])(_0x21a3cc,_0xec536f['id'],_0x54acd1,_0x588791,_0x4050a6,_0x1adc07),_0x2a9204=await(0x0,FindOrCreateATicketTrakingService_1[_0x15ee5a(0x101)])({'ticketId':_0x4a2d17['id'],'companyId':_0x588791,'whatsappId':_0x52981e?.['id']});_0x2a9204[_0x15ee5a(0x244)]('updatedAt',!![]),await _0x2a9204[_0x15ee5a(0x111)]({'updatedAt':new Date()}),await(0x0,providers_1[_0x15ee5a(0x1bf)])(_0x4a2d17,_0x5ddc82,_0x588791,_0x21a3cc,_0xec536f);if(_0x52981e[_0x15ee5a(0x193)]&&_0x54acd1===0x0){const _0x1eeae7=await Message_1[_0x15ee5a(0x101)][_0x15ee5a(0xff)]({'where':{'contactId':_0x21a3cc['id'],'companyId':_0x588791},'order':[[_0x15ee5a(0x100),_0x15ee5a(0x2cd)]]});if((0x0,Mustache_1['default'])(_0x52981e[_0x15ee5a(0x193)],_0x4a2d17)['trim']()[_0x15ee5a(0x2d1)]()===_0x1eeae7?.[_0x15ee5a(0x188)][_0x15ee5a(0x1a5)]()['toLowerCase']())return;}if(_0x46a676=='#'&&!_0x1adc07&&(!_0x4a2d17['userId']||_0x4a2d17[_0x15ee5a(0x1d5)]==_0x15ee5a(0x138))){await _0x4a2d17[_0x15ee5a(0x111)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0xec536f,_0x5ddc82,_0x4a2d17,_0x4a2d17['contact']);return;}try{if(!_0x5ddc82[_0x15ee5a(0x249)][_0x15ee5a(0x17f)]&&!_0x1adc07){if(_0x46a676!=null&&typeof _0x46a676!==_0x15ee5a(0x1f6)){console[_0x15ee5a(0x26b)](_0x46a676),console[_0x15ee5a(0x1eb)]('Expected\x20bodyMessage\x20to\x20be\x20a\x20string,\x20got:',typeof _0x46a676);return;}if(_0x46a676?.['toUpperCase']()===_0x15ee5a(0x192)&&_0x4a2d17[_0x15ee5a(0x1d5)]!=_0x15ee5a(0x263)){await(0x0,SendPresenceStatus_1[_0x15ee5a(0x25f)])(_0xec536f,_0x4a2d17[_0x15ee5a(0x291)]['number']+'@'+(_0x4a2d17[_0x15ee5a(0x165)]?_0x15ee5a(0x10d):'s.whatsapp.net'));const _0x1dd517=await _0xec536f[_0x15ee5a(0x202)](_0x4a2d17[_0x15ee5a(0x291)][_0x15ee5a(0x11b)]+'@'+(_0x4a2d17[_0x15ee5a(0x165)]?'g.us':_0x15ee5a(0x1b1)),{'text':_0x15ee5a(0x267)});await(0x0,exports[_0x15ee5a(0x1e5)])(_0x1dd517,_0x4a2d17,_0x4a2d17[_0x15ee5a(0x291)]),await(0x0,UpdateTicketService_1[_0x15ee5a(0x101)])({'ticketData':{'queueId':null,'status':_0x15ee5a(0x263)},'ticketId':_0x4a2d17['id'],'companyId':_0x4a2d17['companyId']}),await _0x4a2d17[_0x15ee5a(0x253)]();return;}}}catch(_0x58f7b7){console['log']('Erro\x20ao\x20salvar\x20mensagem!'),console[_0x15ee5a(0x26b)](_0x58f7b7),Sentry[_0x15ee5a(0x106)](_0x58f7b7);}try{await _0x4a2d17[_0x15ee5a(0x111)]({'fromMe':_0x5ddc82[_0x15ee5a(0x249)][_0x15ee5a(0x17f)]});}catch(_0x57d10c){console[_0x15ee5a(0x26b)](_0x15ee5a(0x231)),console[_0x15ee5a(0x26b)](_0x57d10c),Sentry[_0x15ee5a(0x106)](_0x57d10c);}try{if(!_0x5ddc82[_0x15ee5a(0x249)][_0x15ee5a(0x17f)]){if((0x0,exports[_0x15ee5a(0x226)])(_0x2a9204)){await(0x0,exports[_0x15ee5a(0x1db)])(_0x5ddc82,_0x4a2d17,_0x2a9204),console[_0x15ee5a(0x26b)](_0x15ee5a(0x1a9)+_0x5ddc82);return;}}}catch(_0x555e68){console[_0x15ee5a(0x26b)](_0x15ee5a(0x255)),Sentry[_0x15ee5a(0x106)](_0x555e68),console[_0x15ee5a(0x26b)](_0x555e68);}_0x1d8101?_0x35692d=await verifyMediaMessage(_0x5ddc82,_0x4a2d17,_0x21a3cc):await(0x0,exports[_0x15ee5a(0x1e5)])(_0x5ddc82,_0x4a2d17,_0x21a3cc);const _0x3059fe=await(0x0,VerifyCurrentSchedule_1[_0x15ee5a(0x101)])(_0x588791),_0x338e72=await Setting_1[_0x15ee5a(0x101)][_0x15ee5a(0xff)]({'where':{'companyId':_0x588791,'key':_0x15ee5a(0x1ac)}});if(!_0x5ddc82['key']['fromMe']&&_0x338e72&&!_0x1adc07)await handleOutOfHour(_0xec536f,_0x4a2d17,_0x338e72,_0x21a3cc,_0x3059fe,_0x52981e);!_0x4a2d17[_0x15ee5a(0x151)]&&!_0x23fb30&&!_0x5ddc82[_0x15ee5a(0x249)][_0x15ee5a(0x17f)]&&!_0x4a2d17[_0x15ee5a(0x2ab)]&&!(0x0,lodash_1[_0x15ee5a(0x2bf)])(_0x52981e['promptId'])&&!_0x1adc07&&await handleOpenAi(_0x5ddc82,_0xec536f,_0x4a2d17,_0x21a3cc,_0x35692d);if(!_0x5ddc82[_0x15ee5a(0x249)][_0x15ee5a(0x17f)]&&!_0x4a2d17[_0x15ee5a(0x165)]&&!_0x4a2d17[_0x15ee5a(0x151)]&&!_0x4a2d17['user']&&_0x4a2d17[_0x15ee5a(0x154)]&&!(0x0,lodash_1['isNil'])(_0x52981e[_0x15ee5a(0x22e)])&&!_0x4a2d17[_0x15ee5a(0x2c8)]&&!_0x1adc07){const _0xe5d28e=await(0x0,ShowQueueIntegrationService_1[_0x15ee5a(0x101)])(_0x52981e['integrationId'],_0x588791);await(0x0,exports[_0x15ee5a(0x1f3)])(_0x5ddc82,_0xec536f,_0xe5d28e,_0x4a2d17);return;}!_0x23fb30&&!_0x5ddc82[_0x15ee5a(0x249)][_0x15ee5a(0x17f)]&&!_0x4a2d17['userId']&&!(0x0,lodash_1[_0x15ee5a(0x2bf)])(_0x4a2d17[_0x15ee5a(0x123)])&&_0x4a2d17[_0x15ee5a(0x2c8)]&&!_0x1adc07&&await handleOpenAi(_0x5ddc82,_0xec536f,_0x4a2d17,_0x21a3cc,_0x35692d);if(!_0x5ddc82['key']['fromMe']&&!_0x4a2d17[_0x15ee5a(0x165)]&&!_0x4a2d17[_0x15ee5a(0x2ab)]&&_0x4a2d17[_0x15ee5a(0x22e)]&&_0x4a2d17[_0x15ee5a(0x2c8)]&&!_0x1adc07){const _0x4b5dfc=await(0x0,ShowQueueIntegrationService_1[_0x15ee5a(0x101)])(_0x4a2d17[_0x15ee5a(0x22e)],_0x588791);await(0x0,exports[_0x15ee5a(0x1f3)])(_0x5ddc82,_0xec536f,_0x4b5dfc,_0x4a2d17);}!_0x4a2d17[_0x15ee5a(0x151)]&&!_0x4a2d17[_0x15ee5a(0x165)]&&!_0x5ddc82['key'][_0x15ee5a(0x17f)]&&!_0x4a2d17[_0x15ee5a(0x2ab)]&&_0x52981e[_0x15ee5a(0x115)][_0x15ee5a(0x237)]>=0x1&&!_0x4a2d17[_0x15ee5a(0x2c8)]&&!_0x1adc07&&(await verifyQueue(_0xec536f,_0x5ddc82,_0x4a2d17,_0x21a3cc),_0x2a9204['changed']('chatbotAt',!![]),_0x2a9204[_0x15ee5a(0x244)](_0x15ee5a(0x1d2),!![]),await _0x2a9204['update']({'chatbotAt':(0x0,moment_1[_0x15ee5a(0x101)])()[_0x15ee5a(0x275)](),'updatedAt':new Date()}));const _0x22b422=_0x4a2d17['queue']===null;await _0x4a2d17['reload']();if(!_0x1adc07&&_0x52981e[_0x15ee5a(0x2c9)])await greetingMessage(_0xec536f,_0x4a2d17,_0x5ddc82,_0x52981e,_0x23fb30);_0x52981e[_0x15ee5a(0x115)]['length']==0x1&&_0x4a2d17[_0x15ee5a(0x151)]&&!_0x1adc07&&(_0x4a2d17[_0x15ee5a(0x154)]&&!_0x5ddc82[_0x15ee5a(0x249)][_0x15ee5a(0x17f)]&&!_0x4a2d17[_0x15ee5a(0x2ab)]&&await handleChartbot(_0x4a2d17,_0x5ddc82,_0xec536f,_0x52981e)),_0x52981e[_0x15ee5a(0x115)][_0x15ee5a(0x237)]>0x1&&_0x4a2d17[_0x15ee5a(0x151)]&&!_0x1adc07&&(_0x4a2d17[_0x15ee5a(0x154)]&&!_0x5ddc82[_0x15ee5a(0x249)][_0x15ee5a(0x17f)]&&!_0x4a2d17[_0x15ee5a(0x2ab)]&&await handleChartbot(_0x4a2d17,_0x5ddc82,_0xec536f,_0x52981e,_0x22b422));}catch(_0x4728c1){console[_0x15ee5a(0x26b)](_0x4728c1),Sentry[_0x15ee5a(0x106)](_0x4728c1),logger_1[_0x15ee5a(0x19a)][_0x15ee5a(0x1b7)](_0x15ee5a(0x1c9)+_0x4728c1);}};exports[a558_0xe1cba4(0x251)]=handleMessage;const handleOutOfHour=async(_0x451c93,_0x1ff25b,_0x498f01,_0x3e80d2,_0x5d78a3,_0x540c09)=>{const _0x1fc31d=a558_0xe1cba4;try{if(outOfHourMessageControl['length']>0x1388)outOfHourMessageControl=[];let _0x5b7d98=outOfHourMessageControl[_0x1fc31d(0x264)](_0x47c2e7=>_0x47c2e7[_0x1fc31d(0x220)]===_0x1ff25b['id']||_0x47c2e7[_0x1fc31d(0x221)]===_0x3e80d2['number']);if(_0x498f01[_0x1fc31d(0x1a1)]===_0x1fc31d(0x114)&&!(0x0,lodash_1['isNil'])(_0x5d78a3)&&_0x540c09[_0x1fc31d(0x1ea)]&&(!_0x5d78a3||_0x5d78a3[_0x1fc31d(0x112)]===![])){if(!_0x5b7d98||_0x5b7d98&&_0x5b7d98[_0x1fc31d(0x103)]+0x3e8*0x3c*0x5<new Date()[_0x1fc31d(0x2b2)]()){_0x5b7d98&&(outOfHourMessageControl=outOfHourMessageControl[_0x1fc31d(0x1ef)](_0xf3e14d=>_0xf3e14d[_0x1fc31d(0x220)]!==_0x1ff25b['id']),_0x5b7d98=null);if(!_0x5b7d98)outOfHourMessageControl[_0x1fc31d(0x1b4)]({'ticketId':_0x1ff25b['id'],'dest':_0x3e80d2['number'],'time':new Date()[_0x1fc31d(0x2b2)]()});const _0x3f360a='‎\x20'+_0x540c09[_0x1fc31d(0x1ea)],_0x2c126e=(0x0,Debounce_1['debounce'])(async()=>{const _0xcad4be=_0x1fc31d;await _0x451c93[_0xcad4be(0x202)](_0x1ff25b[_0xcad4be(0x291)][_0xcad4be(0x11b)]+'@'+(_0x1ff25b[_0xcad4be(0x165)]?_0xcad4be(0x10d):_0xcad4be(0x1b1)),{'text':_0x3f360a});},(0x0,queues_1[_0x1fc31d(0x245)])(0x5dc,0xdac),_0x1ff25b['id']);_0x2c126e();return;}}if(_0x498f01[_0x1fc31d(0x1a1)]===_0x1fc31d(0x151)&&_0x1ff25b[_0x1fc31d(0x172)]!==null){const _0x1ec623=await Queue_1[_0x1fc31d(0x101)][_0x1fc31d(0x12f)](_0x1ff25b[_0x1fc31d(0x172)]),{schedules:_0x54d35d}=_0x1ec623,_0x496972=(0x0,moment_1[_0x1fc31d(0x101)])(),_0x242668=_0x496972[_0x1fc31d(0x1c0)](_0x1fc31d(0x280))[_0x1fc31d(0x2d1)]();let _0x3f5455=null;Array['isArray'](_0x54d35d)&&_0x54d35d['length']>0x0&&(_0x3f5455=_0x54d35d[_0x1fc31d(0x264)](_0x4dcf17=>_0x4dcf17[_0x1fc31d(0x2c0)]===_0x242668&&_0x4dcf17['startTime']!==''&&_0x4dcf17['startTime']!==null&&_0x4dcf17[_0x1fc31d(0x185)]!==''&&_0x4dcf17['endTime']!==null));if(_0x498f01['value']===_0x1fc31d(0x151)&&_0x1ec623['outOfHoursMessage']!==null&&_0x1ec623['outOfHoursMessage']!==''&&!(0x0,lodash_1['isNil'])(_0x3f5455)){const _0x59da6a=(0x0,moment_1['default'])(_0x3f5455['startTime'],_0x1fc31d(0x1a0)),_0x3def45=(0x0,moment_1[_0x1fc31d(0x101)])(_0x3f5455[_0x1fc31d(0x185)],_0x1fc31d(0x1a0));let _0x4f1434=_0x496972[_0x1fc31d(0x18a)](_0x59da6a)||_0x496972[_0x1fc31d(0x174)](_0x3def45);if(!_0x4f1434){if(_0x3f5455[_0x1fc31d(0x205)]&&_0x3f5455[_0x1fc31d(0x1c4)]){const _0x3806c9=(0x0,moment_1[_0x1fc31d(0x101)])(_0x3f5455[_0x1fc31d(0x205)],_0x1fc31d(0x1a0)),_0x219662=(0x0,moment_1['default'])(_0x3f5455[_0x1fc31d(0x1c4)],_0x1fc31d(0x1a0));_0x4f1434=_0x496972[_0x1fc31d(0x2af)](_0x3806c9,_0x219662);}}if(_0x4f1434){if(!_0x5b7d98||_0x5b7d98&&_0x5b7d98[_0x1fc31d(0x103)]+0x3e8*0x3c*0x1e<new Date()[_0x1fc31d(0x2b2)]()){const _0xbc59f5=_0x1ec623['outOfHoursMessage'],_0x2bdb3f=(0x0,Debounce_1[_0x1fc31d(0x1c6)])(async()=>{const _0x57ad8f=_0x1fc31d;await _0x451c93[_0x57ad8f(0x202)](_0x1ff25b['contact'][_0x57ad8f(0x11b)]+'@'+(_0x1ff25b['isGroup']?_0x57ad8f(0x10d):_0x57ad8f(0x1b1)),{'text':_0xbc59f5});},(0x0,queues_1[_0x1fc31d(0x245)])(0x3e8,0xbb8),_0x1ff25b['id']);_0x2bdb3f();return;}if(!_0x5b7d98)outOfHourMessageControl[_0x1fc31d(0x1b4)]({'ticketId':_0x1ff25b['id'],'dest':_0x3e80d2[_0x1fc31d(0x11b)],'time':new Date()['getTime']()});}}}}catch(_0xde7996){Sentry[_0x1fc31d(0x106)](_0xde7996),console[_0x1fc31d(0x26b)](_0xde7996);}},greetingMessage=async(_0x3f2bbd,_0x410a79,_0x2c2d05,_0x5514e2,_0x5c5c15)=>{const _0x444b06=a558_0xe1cba4;if(!_0x5514e2?.[_0x444b06(0x115)]?.['length']&&!_0x410a79[_0x444b06(0x2ab)]&&!_0x5c5c15&&!_0x2c2d05[_0x444b06(0x249)][_0x444b06(0x17f)]){if(process['env'][_0x444b06(0x1e8)]?.[_0x444b06(0x237)]>=0x8){if(_0x410a79[_0x444b06(0x291)]['number']!=process['env'][_0x444b06(0x1e8)])return;}if(greetingMessageControl['length']>0x1388)greetingMessageControl=[];var _0x286056=greetingMessageControl['find'](_0x59da16=>_0x59da16[_0x444b06(0x220)]===_0x410a79['id']||_0x59da16[_0x444b06(0x221)]===_0x410a79[_0x444b06(0x291)][_0x444b06(0x11b)]);if(_0x286056&&_0x286056[_0x444b06(0x103)]+0x3e8*0x3c*0x5>=new Date()['getTime']())return;const _0x344fed=await Message_1['default']['findOne']({'where':{'ticketId':_0x410a79['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x444b06(0x254)]]:(0x0,moment_1[_0x444b06(0x101)])()[_0x444b06(0x23f)](0x5,_0x444b06(0x149))[_0x444b06(0x275)]()}}});if(_0x344fed)return;const _0x3f890e=(0x0,Debounce_1[_0x444b06(0x1c6)])(async()=>{const _0x54c4f5=_0x444b06;if(!_0x5514e2[_0x54c4f5(0x1ce)])await _0x3f2bbd[_0x54c4f5(0x202)](_0x410a79[_0x54c4f5(0x291)]['number']+'@'+(_0x410a79['isGroup']?_0x54c4f5(0x10d):_0x54c4f5(0x1b1)),{'text':(0x0,Mustache_1[_0x54c4f5(0x101)])(_0x5514e2[_0x54c4f5(0x2c9)],_0x410a79)});else{const _0x3666e3=path_1['default'][_0x54c4f5(0x2a4)](_0x54c4f5(0x210),_0x54c4f5(0x114)+_0x410a79[_0x54c4f5(0x203)],_0x5514e2[_0x54c4f5(0x1ce)]),_0x9d39cb=await(0x0,SendWhatsAppMedia_1[_0x54c4f5(0x1ba)])(_0x5514e2[_0x54c4f5(0x1ce)],_0x3666e3,_0x5514e2[_0x54c4f5(0x2c9)],_0x410a79[_0x54c4f5(0x203)]);await _0x3f2bbd['sendMessage'](_0x410a79[_0x54c4f5(0x291)]['number']+'@'+(_0x410a79[_0x54c4f5(0x165)]?'g.us':'s.whatsapp.net'),{..._0x9d39cb});}},0x3e8,_0x410a79['id']);_0x3f890e();return;}},handleMsgAck=async(_0xa0c9,_0x137c36)=>{const _0x939117=a558_0xe1cba4,_0x5ff89d=(0x0,socket_1[_0x939117(0x246)])();try{const _0x5c6b0e=await Message_1[_0x939117(0x101)][_0x939117(0x12f)](_0xa0c9[_0x939117(0x249)]['id'],{'include':[_0x939117(0x291),{'model':Message_1[_0x939117(0x101)],'as':_0x939117(0x1c2),'include':[_0x939117(0x291)]}]});if(!_0x5c6b0e){console['log'](_0xa0c9),console['log'](_0x939117(0x1a2));return;}await _0x5c6b0e['update']({'ack':_0x137c36}),_0x5ff89d['to'](_0x5c6b0e[_0x939117(0x220)][_0x939117(0x1ae)]())[_0x939117(0x24c)](_0x939117(0x1b8)+_0x5c6b0e['companyId']+_0x939117(0x235),{'action':_0x939117(0x111),'message':_0x5c6b0e});}catch(_0x4f2a84){Sentry[_0x939117(0x106)](_0x4f2a84),logger_1['logger'][_0x939117(0x1b7)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x4f2a84);}};exports[a558_0xe1cba4(0x15b)]=handleMsgAck;const verifyRecentCampaign=async(_0x37b3fd,_0x10a17a)=>{const _0xe020d9=a558_0xe1cba4;if(!_0x37b3fd[_0xe020d9(0x249)]['fromMe']){const _0x5bf778=_0x37b3fd[_0xe020d9(0x249)]['remoteJid'][_0xe020d9(0x12e)](/\D/g,''),_0x492d7b=await Campaign_1[_0xe020d9(0x101)][_0xe020d9(0x2d8)]({'where':{'companyId':_0x10a17a,'status':_0xe020d9(0x178),'confirmation':!![]}});if(_0x492d7b){const _0x1fbf2d=_0x492d7b[_0xe020d9(0x1e3)](_0x15c97d=>_0x15c97d['id']),_0x249f9a=await CampaignShipping_1['default']['findOne']({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x1fbf2d},'number':_0x5bf778,'confirmation':null}});_0x249f9a&&(await _0x249f9a[_0xe020d9(0x111)]({'confirmedAt':(0x0,moment_1[_0xe020d9(0x101)])(),'confirmation':!![]}),await queues_1[_0xe020d9(0x104)][_0xe020d9(0x12a)](_0xe020d9(0x17c),{'campaignShippingId':_0x249f9a['id'],'campaignId':_0x249f9a[_0xe020d9(0x155)]},{'delay':(0x0,queues_1[_0xe020d9(0x16f)])((0x0,queues_1['randomValue'])(0x0,0xa))}));}}};function a558_0x5704(){const _0x54cd65=['emit','pollCreationMessageV2','messages','getOwnPropertyDescriptor','getVideoMessage','handleMessage','speechSynthesisVoiceName','reload','gte','Erro\x20ao\x20salvar\x20avaliação!','base64','interactiveMessage','pushName','../QueueIntegrationServices/ShowQueueIntegrationService','data:image/png;base64,\x20','data','prototype','videoMessage','user','SendPresenceStatus','protocolMessage','concat','6374520xiLnkd','closed','find','extendedTextMessage','-ticket','*Você\x20encerrou\x20este\x20atendimento\x20usando\x20o\x20comando\x20SAIR*.\x0a\x0a\x0aSe\x20você\x20finalizou\x20o\x20atendimento\x20*ANTES*\x20de\x20receber\x20um\x20retorno\x20do\x20operador,\x20ele\x20*NÃO*\x20irá\x20visualizar\x20sua\x20solicitação!\x0a\x0aVocê\x20deve\x20aguardar\x20o\x20retorno\x20do\x20operador\x20e\x20que\x20ele\x20encerre\x20seu\x20atendimento\x20quando\x20necessário.\x0a\x0aUse\x20a\x20opção\x20*SAIR*\x20somente\x20em\x20casos\x20de\x20emergência\x20ou\x20se\x20ficou\x20preso\x20em\x20algum\x20setor.\x0a\x0a\x0aPara\x20iniciar\x20um\x20novo\x20atendimento\x20basta\x20enviar\x20uma\x20nova\x20mensagem!','values','search','hydratedFourRowTemplate','log','button','options','type','./wbotGetMessageFromType','writable','get','directPath','assistant','selectedId','toDate','allowGroup','WebMessageInfo','Failed\x20to\x20fetch\x20queues:','texto','3099BxRNQp','templateMessage','MessageUpdateJob','temperature','getLocationMessage','getImageMessage','dddd','PENDING','stickerMessage','text','speakTextAsync','getContactsArrayMessage','selectedRowId','messageQueue','highlyStructuredMessage','Convite\x20Revogado','Status','writeFile','2trtLPT','chat','buttonsResponseMessage','maxUseBotQueues','PLAYED','contact','viewOnceMessageV2','mediaPath','update!','count','\x0a*[\x20#\x20]*\x20-\x20Menu\x20inicial','createReadStream','from','Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','__importStar','getTextMessage','now','mkdirSync','../../helpers/Mustache','name','end','audio/mpeg','contacts','quarto\x20if','resolve','listMessage','disableBot','message','@whiskeysockets/baileys','pt-BR-FabioNeural','constructor','userId','botText\x202','sleep','.mp3','isBetween','setExtra','Message','getTime','close','Mensagem\x20de\x20grupo\x20bloqueada!','media','product','\x20|\x20https://maps.google.com/maps?q=','catch','queueOptionId','Erro\x20ao\x20deletar\x20o\x20arquivo:','Lista','%2C','../CompanyService/VerifyCurrentSchedule','getStickerMessage','isNil','weekdayEn','contactsArrayMessage','isNull','chatbotAt','whisper-1','ephemeralMessage','subject','isArray','useIntegration','greetingMessage','mediaName','chatbot\x20desativado!','DELIVERY_ACK','DESC','application/pdf','whatsappId','status@broadcast','toLowerCase','document','../TypebotServices/typebotListener','degreesLatitude','4366628wiutSb','getContactMessage','Mensagem\x20editada\x20não\x20encontrada:\x20','findAll','create','findOne','createdAt','default','listResponseMessage','time','campaignQueue','body\x20is\x20not\x20a\x20string','captureException','image/jpeg','getWbot','application','botText','delete','env','g.us','../WhatsappService/ShowWhatsAppService','webhook','liveLocationMessage','update','inActivity','reaction','company','queues','then','stanzaId','Failed\x20to\x20fetch\x20contact\x20from\x20ticket:','path','5788048xXCdnB','number','toFormat','Mensagem\x20inválida!','Error\x20isValidMsg','system','fromSubscription','amountUsedBotQueues','sendMessageLink','promptId','getDocumentMessage','editedMessage','list','MESSAGE_EDIT','maxTokens','(((.+)+)+)+$','add','defineProperty','HandleMessageJob','__importDefault','replace','findByPk','contactMessage','../../helpers/MakeRandomId',']\x20-\x20','pollCreationMessageV3','ack','maxMessages','Múltiplos\x20Produtos','../ContactServices/CreateOrUpdateContactService','pending','parentId','min','Erro\x20ao\x20buscar\x20grupo!','terceiro\x20if','../../utils/logger','CIPHERTEXT','filename','../TicketServices/FindOrCreateATicketTrakingService','segundo\x20if','../../libs/socket','set','proto','join','keys','isValidMsg','getTemplateMessage','minutes','content','mediaType','imageMessage','CheckMsgIsGroup','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','createTranscription','title','queue','request','../../queues','chatbot','campaignId','../../models/QueueOption','templateButtonReplyMessage','messages.update','setFfmpegPath','mediaMessage','handleMsgAck','../../models/Contact','../../libs/wbot','messageContextInfo','__setModuleDefault','n8n','groups.update','../../models/Queue','176YXcuoE','getGroupInviteMessage','isGroup','SERVER_ACK','verifyCampaignMessageAndCloseTicket','Type','util','ERR_WAPP_DOWNLOAD_MEDIA','existsSync','remoteJid','E2E_IDENTITY_CHANGED','\x20seconds\x20with\x20an\x20effective\x20speed\x20of\x20','parseToMilliseconds','AudioConfig','random','queueId','Mensagem\x20que\x20Desaparece','isAfter','\x0a\x0a*[\x20#\x20]*\x20-\x20Voltar\x20ao\x20Menu\x20Principal','Importando\x20mensagens!!','extractMessageContent','EM_ANDAMENTO','removeNonPrintableChars','keywords','16209600Ujxerv','DispatchCampaign','getMinutes','getContentType','fromMe',':unreads','locationMessage','makeid','sendMessageImage','getViewOnceMessage','endTime','Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior','Pedido','body','hydratedTemplate','isBefore','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','stringify','getBodyMessage','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','input','chatBotType','fora\x20do\x20horario','SAIR','complationMessage','productImage','getPaymentMessage','../../libs/cache','dataJson','validaCpfCnpj','getViewOnceMessageV2','logger','SpeechConfig','-open','jidNormalizedUser','header','\x20]*\x20-\x20','HH:mm','value','Mensagem\x20não\x20encontrada!','Mensagem\x20interativa\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','mime','trim','choices','770470JZrnUW','gpt-3.5-turbo-1106','Mensagem\x20inválida\x208!\x20','test','hasOwnProperty','scheduleType','includes','toString','16530vAtrww','voiceKey','s.whatsapp.net','conversation','mp3','push','call','externalAdReply','error','company-','Throttle','getMessageOptions','public/temp/','downloadContentFromMessage','extension','buttonsMessage','provider','format','warn','quotedMsg','startTime','endLunchTime','degreesLongitude','debounce','selectedButtonId','typebot','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','url','sendGreetingMessageOneQueues','./SendWhatsAppMedia','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','greetingMediaAttachment','&z=17&hl=pt-BR|','enabled','./SendWhatsAppMessage','updatedAt','getButtonsMessage','configurable','status','getAd','rate','setMinutes','../../helpers/SendPresenceStatus','verifyQuotedMessage','handleRating','groupMetadata','\x0a*[\x200\x20]*\x20-\x20Menu\x20anterior','stream-throttle','-closed','*[\x20','endsWith','\x20MBps','map','contextInfo','verifyMessage','toFixed','voiceRegion','CHATBOT_RESTRICT_NUMBER','fluent-ffmpeg','outOfHoursMessage','trace','moment','__esModule','primeiro\x20if','filter','Failed\x20to\x20get\x20stream','urlN8N','../../models/User','handleMessageIntegration','makeRandomId','openai','string','205eWaGqU','audioMessage','participant','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','E2E_DEVICE_CHANGED','isNumeric','wbotMessageListener','public/company','ratingAt','ProtocolMessage','next','sendMessage','companyId','Error:\x20','startLunchTime','save','POST','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','forEach','messageStubType','./providers','readFileSync','botText\x203','No\x20result\x20from\x20synthesizer','slice','public','quotedMessage','getAudioMessage','mimetype','getQuotedMessage','cacheLayer','hydratedContentText','Escolha\x20uma\x20opção','WAMessageStubType','ASC','getListMessage','Solicitação\x20de\x20Pagamento','caption','createChatCompletion','viewOnceMessage','Nas\x20respostas\x20utilize\x20o\x20nome\x20','ticketId','dest','fourRowTemplate','voiceMessage','../../models/CampaignShipping','option','verifyRating','isNaN','prompt','substring','contacts:','unlinkSync','../../models/Campaign','singleSelectReply','integrationId','SpeechSynthesizer','documentMessage','Erro\x20ao\x20salvar\x20ticket!','../../models/OldMessage','REVOKE','Produto','-appMessage','productMessage','length','##\x20if','../TicketServices/UpdateTicketService','.wav','split','charAt','Erro\x20para\x20responder\x20com\x20audio:\x20','hydratedHsm','subtract','voice','reactionMessage','getQuotedMessageId','\x201286\x20-\x20Entrei\x20na\x20integracao\x20openai.','changed','randomValue','getIO','../../models/UserRating','\x20de\x20baixar\x20o\x20arquivo\x20','key','documentWithCaptionMessage','../../app'];a558_0x5704=function(){return _0x54cd65;};return a558_0x5704();}exports['verifyRecentCampaign']=verifyRecentCampaign;const verifyCampaignMessageAndCloseTicket=async(_0x3abee5,_0x53c46c)=>{const _0x39e2ab=a558_0xe1cba4,_0x19ad36=(0x0,socket_1[_0x39e2ab(0x246)])(),_0x38dd9f=(0x0,exports[_0x39e2ab(0x18d)])(_0x3abee5),_0x4a8071=/\u200c/[_0x39e2ab(0x1aa)](_0x38dd9f);if(_0x3abee5[_0x39e2ab(0x249)][_0x39e2ab(0x17f)]&&_0x4a8071){const _0x52b86a=await Message_1[_0x39e2ab(0x101)][_0x39e2ab(0xff)]({'where':{'id':_0x3abee5[_0x39e2ab(0x249)]['id'],'companyId':_0x53c46c}}),_0x2c8c13=await Ticket_1[_0x39e2ab(0x101)]['findByPk'](_0x52b86a[_0x39e2ab(0x220)]);await _0x2c8c13[_0x39e2ab(0x111)]({'status':_0x39e2ab(0x263)}),_0x19ad36['to'](_0x39e2ab(0x1b8)+_0x2c8c13[_0x39e2ab(0x203)]+_0x39e2ab(0x19c))[_0x39e2ab(0x24c)]('company-'+_0x2c8c13[_0x39e2ab(0x203)]+_0x39e2ab(0x266),{'action':'delete','ticket':_0x2c8c13,'ticketId':_0x2c8c13['id']}),_0x19ad36['to']('company-'+_0x53c46c+'-'+_0x2c8c13['status'])['to'](_0x2c8c13['id'][_0x39e2ab(0x1ae)]())['emit'](_0x39e2ab(0x1b8)+_0x2c8c13['companyId']+_0x39e2ab(0x266),{'action':_0x39e2ab(0x111),'ticket':_0x2c8c13,'ticketId':_0x2c8c13['id']});}};exports[a558_0xe1cba4(0x167)]=verifyCampaignMessageAndCloseTicket;const filterMessages=_0x20d3d=>{const _0x175b99=a558_0xe1cba4;if([baileys_1[_0x175b99(0x218)][_0x175b99(0x233)],baileys_1[_0x175b99(0x218)][_0x175b99(0x1fb)],baileys_1[_0x175b99(0x218)][_0x175b99(0x16d)],baileys_1[_0x175b99(0x218)][_0x175b99(0x13e)]][_0x175b99(0x1ad)](_0x20d3d[_0x175b99(0x20a)]))return![];return!![];},wbotMessageListener=async(_0x3d7257,_0x1073d5,_0xba20d)=>{const _0x5dca18=a558_0xe1cba4;_0x3d7257['ev']['on']('messages.upsert',async _0x1627c5=>{const _0x1e24fe=a558_0x1c99,_0x247b77=_0x1627c5[_0x1e24fe(0x24e)][_0x1e24fe(0x1ef)](filterMessages);if(!_0x247b77)return;await app_1[_0x1e24fe(0x101)][_0x1e24fe(0x271)](_0x1e24fe(0x115))[_0x1e24fe(0x287)][_0x1e24fe(0x12a)](_0x1e24fe(0x12c),{'whatsappId':_0xba20d['id'],'messages':_0x247b77,'companyId':_0x1073d5},{'removeOnComplete':!![],'attempts':0x3});}),_0x3d7257['ev']['on'](_0x5dca18(0x158),async _0x2f4274=>{const _0x5ab91=_0x5dca18;if(_0x2f4274[_0x5ab91(0x237)]===0x0)return;await app_1[_0x5ab91(0x101)][_0x5ab91(0x271)](_0x5ab91(0x115))[_0x5ab91(0x287)][_0x5ab91(0x12a)](_0x5ab91(0x27c),{'whatsappId':_0xba20d['id'],'messageUpdate':_0x2f4274,'companyId':_0x1073d5},{'removeOnComplete':!![],'attempts':0x3,'delay':0x64});}),_0x3d7257['ev']['on'](_0x5dca18(0x161),async _0x37d7e5=>{const _0x1bee59=_0x5dca18;console['log'](_0x37d7e5);if(_0x37d7e5[_0x1bee59(0x237)]===0x0)return;for(const _0x215354 of _0x37d7e5){const _0x35f43d=_0x215354['id'][_0x1bee59(0x23b)]('@')[0x0],_0x2a293b=_0x215354[_0x1bee59(0x2c6)]||_0x35f43d,_0x26f7ed={'name':_0x2a293b,'number':_0x35f43d,'isGroup':!![],'companyId':_0x1073d5,'remoteJid':_0x215354['id'],'whatsappId':_0x3d7257['id']};await(0x0,CreateOrUpdateContactService_1[_0x1bee59(0x101)])(_0x26f7ed,_0x3d7257,_0x215354['id']);}});};exports[a558_0xe1cba4(0x1fd)]=wbotMessageListener;