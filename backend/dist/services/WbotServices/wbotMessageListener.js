const a558_0x4f05bc=a558_0x3203;(function(_0x41451e,_0x50f59e){const _0x9b8906=a558_0x3203,_0x566681=_0x41451e();while(!![]){try{const _0x2915ce=parseInt(_0x9b8906(0x24d))/0x1*(-parseInt(_0x9b8906(0x228))/0x2)+parseInt(_0x9b8906(0x222))/0x3*(parseInt(_0x9b8906(0x217))/0x4)+-parseInt(_0x9b8906(0x27b))/0x5+parseInt(_0x9b8906(0x244))/0x6+-parseInt(_0x9b8906(0x1a5))/0x7*(parseInt(_0x9b8906(0x202))/0x8)+-parseInt(_0x9b8906(0x1a9))/0x9+parseInt(_0x9b8906(0x286))/0xa*(parseInt(_0x9b8906(0x1fd))/0xb);if(_0x2915ce===_0x50f59e)break;else _0x566681['push'](_0x566681['shift']());}catch(_0x56b3b3){_0x566681['push'](_0x566681['shift']());}}}(a558_0x429a,0x47ed7));const a558_0x52b0c4=(function(){let _0x45311a=!![];return function(_0x90d52c,_0x306574){const _0x2bcf41=_0x45311a?function(){const _0x5e43cc=a558_0x3203;if(_0x306574){const _0x4609b3=_0x306574[_0x5e43cc(0x258)](_0x90d52c,arguments);return _0x306574=null,_0x4609b3;}}:function(){};return _0x45311a=![],_0x2bcf41;};}()),a558_0x57d2c1=a558_0x52b0c4(this,function(){const _0x333148=a558_0x3203;return a558_0x57d2c1[_0x333148(0x1d0)]()[_0x333148(0x207)](_0x333148(0x2a4))[_0x333148(0x1d0)]()[_0x333148(0x1eb)](a558_0x57d2c1)[_0x333148(0x207)](_0x333148(0x2a4));});a558_0x57d2c1();'use strict';var __createBinding=this&&this[a558_0x4f05bc(0x2cd)]||(Object[a558_0x4f05bc(0x2ff)]?function(_0x4d6b82,_0x45b381,_0x39ae33,_0xd3246b){const _0x1f9674=a558_0x4f05bc;if(_0xd3246b===undefined)_0xd3246b=_0x39ae33;var _0x4d0e33=Object[_0x1f9674(0x20f)](_0x45b381,_0x39ae33);(!_0x4d0e33||('get'in _0x4d0e33?!_0x45b381[_0x1f9674(0x329)]:_0x4d0e33['writable']||_0x4d0e33['configurable']))&&(_0x4d0e33={'enumerable':!![],'get':function(){return _0x45b381[_0x39ae33];}}),Object[_0x1f9674(0x311)](_0x4d6b82,_0xd3246b,_0x4d0e33);}:function(_0x9b36c6,_0x43cab6,_0x1d00fc,_0x30369e){if(_0x30369e===undefined)_0x30369e=_0x1d00fc;_0x9b36c6[_0x30369e]=_0x43cab6[_0x1d00fc];}),__setModuleDefault=this&&this[a558_0x4f05bc(0x270)]||(Object['create']?function(_0x448db5,_0x130bb5){Object['defineProperty'](_0x448db5,'default',{'enumerable':!![],'value':_0x130bb5});}:function(_0x2f1bcb,_0x30eb46){const _0x342adb=a558_0x4f05bc;_0x2f1bcb[_0x342adb(0x289)]=_0x30eb46;}),__importStar=this&&this[a558_0x4f05bc(0x1ee)]||function(_0x740471){const _0x36b7b7=a558_0x4f05bc;if(_0x740471&&_0x740471['__esModule'])return _0x740471;var _0x43449d={};if(_0x740471!=null){for(var _0x51c4a7 in _0x740471)if(_0x51c4a7!==_0x36b7b7(0x289)&&Object[_0x36b7b7(0x224)]['hasOwnProperty'][_0x36b7b7(0x19f)](_0x740471,_0x51c4a7))__createBinding(_0x43449d,_0x740471,_0x51c4a7);}return __setModuleDefault(_0x43449d,_0x740471),_0x43449d;},__importDefault=this&&this[a558_0x4f05bc(0x1ae)]||function(_0x510fca){return _0x510fca&&_0x510fca['__esModule']?_0x510fca:{'default':_0x510fca};};Object[a558_0x4f05bc(0x311)](exports,a558_0x4f05bc(0x329),{'value':!![]}),exports['wbotMessageListener']=exports[a558_0x4f05bc(0x2bf)]=exports[a558_0x4f05bc(0x1e8)]=exports[a558_0x4f05bc(0x350)]=exports[a558_0x4f05bc(0x1ab)]=exports['handleMessageIntegration']=exports[a558_0x4f05bc(0x2cc)]=exports[a558_0x4f05bc(0x2bc)]=exports[a558_0x4f05bc(0x25e)]=exports[a558_0x4f05bc(0x25b)]=exports[a558_0x4f05bc(0x31e)]=exports[a558_0x4f05bc(0x1ac)]=exports[a558_0x4f05bc(0x23c)]=exports[a558_0x4f05bc(0x2f7)]=exports['makeid']=exports[a558_0x4f05bc(0x1ef)]=exports['sendMessageImage']=exports[a558_0x4f05bc(0x2e3)]=exports[a558_0x4f05bc(0x21d)]=exports[a558_0x4f05bc(0x2a0)]=exports[a558_0x4f05bc(0x2fd)]=void 0x0;const path_1=__importStar(require(a558_0x4f05bc(0x20a))),util_1=require('util'),fs_1=require('fs'),Sentry=__importStar(require('@sentry/node')),lodash_1=require(a558_0x4f05bc(0x20c)),baileys_1=require(a558_0x4f05bc(0x1d7)),MessageUtils=__importStar(require(a558_0x4f05bc(0x28f))),stream_throttle_1=require(a558_0x4f05bc(0x2ad)),Contact_1=__importDefault(require(a558_0x4f05bc(0x1be))),Ticket_1=__importDefault(require(a558_0x4f05bc(0x288))),Message_1=__importDefault(require(a558_0x4f05bc(0x353))),OldMessage_1=__importDefault(require(a558_0x4f05bc(0x2e2))),socket_1=require(a558_0x4f05bc(0x255)),CreateMessageService_1=__importDefault(require(a558_0x4f05bc(0x254))),logger_1=require(a558_0x4f05bc(0x252)),CreateOrUpdateContactService_1=__importDefault(require(a558_0x4f05bc(0x320))),FindOrCreateTicketService_1=__importDefault(require(a558_0x4f05bc(0x34a))),ShowWhatsAppService_1=__importDefault(require(a558_0x4f05bc(0x29f))),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),Mustache_1=__importDefault(require(a558_0x4f05bc(0x1b2))),UserRating_1=__importDefault(require(a558_0x4f05bc(0x24c))),SendWhatsAppMessage_1=__importDefault(require(a558_0x4f05bc(0x23e))),moment_1=__importDefault(require('moment')),Queue_1=__importDefault(require(a558_0x4f05bc(0x1f0))),QueueOption_1=__importDefault(require(a558_0x4f05bc(0x2ef))),FindOrCreateATicketTrakingService_1=__importDefault(require(a558_0x4f05bc(0x32c))),VerifyCurrentSchedule_1=__importDefault(require('../CompanyService/VerifyCurrentSchedule')),Campaign_1=__importDefault(require('../../models/Campaign')),CampaignShipping_1=__importDefault(require('../../models/CampaignShipping')),sequelize_1=require('sequelize'),queues_1=require('../../queues'),User_1=__importDefault(require(a558_0x4f05bc(0x345))),Setting_1=__importDefault(require('../../models/Setting')),cache_1=require(a558_0x4f05bc(0x2a2)),Debounce_1=require(a558_0x4f05bc(0x28a)),openai_1=require('openai'),fluent_ffmpeg_1=__importDefault(require(a558_0x4f05bc(0x352))),microsoft_cognitiveservices_speech_sdk_1=require('microsoft-cognitiveservices-speech-sdk'),providers_1=require(a558_0x4f05bc(0x274)),typebotListener_1=__importDefault(require('../TypebotServices/typebotListener')),ShowQueueIntegrationService_1=__importDefault(require(a558_0x4f05bc(0x330))),SendWhatsAppMedia_1=require(a558_0x4f05bc(0x26f)),fs_2=__importDefault(require('fs')),request_1=__importDefault(require(a558_0x4f05bc(0x1cc))),ffmpeg_static_1=__importDefault(require(a558_0x4f05bc(0x2e1))),app_1=__importDefault(require(a558_0x4f05bc(0x210))),mime_1=__importDefault(require('mime')),wbot_1=require(a558_0x4f05bc(0x303)),SendPresenceStatus_1=require(a558_0x4f05bc(0x1b1)),MakeRandomId_1=require(a558_0x4f05bc(0x22b));fluent_ffmpeg_1[a558_0x4f05bc(0x289)][a558_0x4f05bc(0x20b)](ffmpeg_static_1[a558_0x4f05bc(0x289)]);const sessionsOpenAi=[],isNumeric=_0x1b45e3=>/^-?\d+$/[a558_0x4f05bc(0x1e6)](_0x1b45e3);exports[a558_0x4f05bc(0x2fd)]=isNumeric;let outOfHourMessageControl=[],completionMessageControl=[],greetingMessageControl=[],farewellMessageControl=[];const writeFileAsync=(0x0,util_1[a558_0x4f05bc(0x32b)])(fs_1[a558_0x4f05bc(0x275)]),getTypeMessage=_0x514cd0=>{const _0x1c4445=a558_0x4f05bc;return(0x0,baileys_1[_0x1c4445(0x1a8)])(_0x514cd0[_0x1c4445(0x1bc)]);},removeNonPrintableChars=_0x28bd4e=>{const _0x125bde=a558_0x4f05bc;return _0x28bd4e[_0x125bde(0x2c6)](/[\x00-\x1F\x7F-\x9F]/g,'');};exports[a558_0x4f05bc(0x2a0)]=removeNonPrintableChars;async function getQueues(_0x189a78){const _0x1f8a66=a558_0x4f05bc;try{const _0x34c664=await Queue_1['default'][_0x1f8a66(0x1ed)]({'where':{'companyId':_0x189a78}});return _0x34c664;}catch(_0x3e2230){return console[_0x1f8a66(0x253)]('Failed\x20to\x20fetch\x20queues:',_0x3e2230),[];}}async function getContactFromTicket(_0x53ca00){const _0x5b45d8=a558_0x4f05bc;try{const _0x474af0=await Ticket_1['default'][_0x5b45d8(0x2ac)](_0x53ca00,{'include':[{'model':Contact_1[_0x5b45d8(0x289)],'as':'contact'}]});return _0x474af0&&_0x474af0[_0x5b45d8(0x32d)]?_0x474af0['contact']:(console[_0x5b45d8(0x1fa)](_0x5b45d8(0x1bf)),null);}catch(_0x19aa14){return console[_0x5b45d8(0x253)](_0x5b45d8(0x227),_0x19aa14),null;}}function a558_0x3203(_0x45f042,_0x39ecc7){const _0x3088e0=a558_0x429a();return a558_0x3203=function(_0x57d2c1,_0x52b0c4){_0x57d2c1=_0x57d2c1-0x194;let _0x429a63=_0x3088e0[_0x57d2c1];return _0x429a63;},a558_0x3203(_0x45f042,_0x39ecc7);}function validaCpfCnpj(_0x395df8){const _0x47228b=a558_0x4f05bc;if(_0x395df8['length']==0xb){var _0x5f57b3=_0x395df8[_0x47228b(0x1b0)]();_0x5f57b3=_0x5f57b3[_0x47228b(0x2c6)](/\./g,''),_0x5f57b3=_0x5f57b3[_0x47228b(0x2c6)]('-',''),_0x5f57b3=_0x5f57b3['split']('');var _0x5bb238=0x0,_0xdd485f=0x0,_0xd4550d=![];for(var _0x2f4ed4=0x1;_0x5f57b3[_0x47228b(0x2ae)]>_0x2f4ed4;_0x2f4ed4++){_0x5f57b3[_0x2f4ed4-0x1]!=_0x5f57b3[_0x2f4ed4]&&(_0xd4550d=!![]);}if(_0xd4550d==![])return![];for(var _0x2f4ed4=0x0,_0x580e81=0xa;_0x5f57b3['length']-0x2>_0x2f4ed4;_0x2f4ed4++,_0x580e81--){_0x5bb238+=_0x5f57b3[_0x2f4ed4]*_0x580e81;}_0x5bb238=_0x5bb238*0xa%0xb;_0x5bb238==0xa&&(_0x5bb238=0x0);if(_0x5bb238!=_0x5f57b3[0x9])return![];for(var _0x2f4ed4=0x0,_0x580e81=0xb;_0x5f57b3[_0x47228b(0x2ae)]-0x1>_0x2f4ed4;_0x2f4ed4++,_0x580e81--){_0xdd485f+=_0x5f57b3[_0x2f4ed4]*_0x580e81;}return _0xdd485f=_0xdd485f*0xa%0xb,_0xdd485f==0xa&&(_0xdd485f=0x0),_0xdd485f!=_0x5f57b3[0xa]?![]:!![];}else{if(_0x395df8['length']==0xe){var _0x5c0e34=_0x395df8[_0x47228b(0x1b0)]();_0x5c0e34=_0x5c0e34[_0x47228b(0x2c6)](/\./g,''),_0x5c0e34=_0x5c0e34[_0x47228b(0x2c6)]('-',''),_0x5c0e34=_0x5c0e34[_0x47228b(0x2c6)]('/',''),_0x5c0e34=_0x5c0e34[_0x47228b(0x27e)]('');var _0x5bb238=0x0,_0xdd485f=0x0,_0xd4550d=![];for(var _0x2f4ed4=0x1;_0x5c0e34[_0x47228b(0x2ae)]>_0x2f4ed4;_0x2f4ed4++){_0x5c0e34[_0x2f4ed4-0x1]!=_0x5c0e34[_0x2f4ed4]&&(_0xd4550d=!![]);}if(_0xd4550d==![])return![];for(var _0x2f4ed4=0x0,_0xe8f114=0x5,_0x76c016=0xd;_0x5c0e34['length']-0x2>_0x2f4ed4;_0x2f4ed4++,_0xe8f114--,_0x76c016--){_0xe8f114>=0x2?_0x5bb238+=_0x5c0e34[_0x2f4ed4]*_0xe8f114:_0x5bb238+=_0x5c0e34[_0x2f4ed4]*_0x76c016;}_0x5bb238=_0x5bb238%0xb;_0x5bb238<0x2?_0x5bb238=0x0:_0x5bb238=0xb-_0x5bb238;if(_0x5bb238!=_0x5c0e34[0xc])return![];for(var _0x2f4ed4=0x0,_0xe8f114=0x6,_0x76c016=0xe;_0x5c0e34[_0x47228b(0x2ae)]-0x1>_0x2f4ed4;_0x2f4ed4++,_0xe8f114--,_0x76c016--){_0xe8f114>=0x2?_0xdd485f+=_0x5c0e34[_0x2f4ed4]*_0xe8f114:_0xdd485f+=_0x5c0e34[_0x2f4ed4]*_0x76c016;}return _0xdd485f=_0xdd485f%0xb,_0xdd485f<0x2?_0xdd485f=0x0:_0xdd485f=0xb-_0xdd485f,_0xdd485f!=_0x5c0e34[0xd]?![]:!![];}else return![];}}exports[a558_0x4f05bc(0x21d)]=validaCpfCnpj;function timeout(_0x37e4ee){return new Promise(_0x5600da=>setTimeout(_0x5600da,_0x37e4ee));}async function sleep(_0x339af4){await timeout(_0x339af4);}exports[a558_0x4f05bc(0x2e3)]=sleep;const sendMessageImage=async(_0x5bf4c0,_0x45ed9a,_0x4345f9,_0x4dd45d,_0x3f0697)=>{const _0xb1b822=a558_0x4f05bc;let _0x145899;try{_0x145899=await _0x5bf4c0[_0xb1b822(0x26a)](_0x45ed9a['number']+'@'+(_0x4345f9[_0xb1b822(0x231)]?'g.us':_0xb1b822(0x1aa)),{'image':_0x4dd45d?{'url':_0x4dd45d}:fs_2[_0xb1b822(0x289)][_0xb1b822(0x1ad)]('public/temp/'+_0x3f0697+'-'+makeid(0xa)),'fileName':_0x3f0697,'caption':_0x3f0697,'mimetype':'image/jpeg'});}catch(_0xf1acc6){_0x145899=await _0x5bf4c0[_0xb1b822(0x26a)](_0x45ed9a[_0xb1b822(0x282)]+'@'+(_0x4345f9[_0xb1b822(0x231)]?_0xb1b822(0x2a1):_0xb1b822(0x1aa)),{'text':(0x0,Mustache_1['default'])(_0xb1b822(0x2e7),_0x4345f9)});}(0x0,exports[_0xb1b822(0x25b)])(_0x145899,_0x4345f9,_0x45ed9a);};exports['sendMessageImage']=sendMessageImage;const sendMessageLink=async(_0x1c118e,_0x520a4d,_0xc6a213,_0x498858,_0xe9ff89)=>{const _0x53c42e=a558_0x4f05bc;let _0x49d0fc;try{_0x49d0fc=await _0x1c118e['sendMessage'](_0x520a4d['number']+'@'+(_0xc6a213[_0x53c42e(0x231)]?'g.us':_0x53c42e(0x1aa)),{'document':_0x498858?{'url':_0x498858}:fs_2[_0x53c42e(0x289)][_0x53c42e(0x1ad)](_0x53c42e(0x239)+_0xe9ff89+'-'+makeid(0xa)),'fileName':_0xe9ff89,'caption':_0xe9ff89,'mimetype':_0x53c42e(0x1e4)});}catch(_0x2d98dc){_0x49d0fc=await _0x1c118e['sendMessage'](_0x520a4d['number']+'@'+(_0xc6a213[_0x53c42e(0x231)]?'g.us':_0x53c42e(0x1aa)),{'text':(0x0,Mustache_1[_0x53c42e(0x289)])('Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!',_0xc6a213)});}(0x0,exports[_0x53c42e(0x25b)])(_0x49d0fc,_0xc6a213,_0x520a4d);};exports[a558_0x4f05bc(0x1ef)]=sendMessageLink;function makeid(_0x34a3e5){const _0x47eb30=a558_0x4f05bc;var _0x106e0b='',_0x43b608='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789',_0x3e1c0d=_0x43b608[_0x47eb30(0x2ae)];for(var _0x304403=0x0;_0x304403<_0x34a3e5;_0x304403++){_0x106e0b+=_0x43b608[_0x47eb30(0x1c1)](Math[_0x47eb30(0x355)](Math['random']()*_0x3e1c0d));}return _0x106e0b;}exports['makeid']=makeid;const msgLocation=(_0x4d6bb9,_0x23f9d8,_0x116d9c)=>{const _0x246317=a558_0x4f05bc;if(_0x4d6bb9){var _0x48a484=Buffer[_0x246317(0x296)](_0x4d6bb9)['toString'](_0x246317(0x2bd));let _0x36fe73=_0x246317(0x2db)+_0x48a484+_0x246317(0x221)+_0x23f9d8+_0x246317(0x2b1)+_0x116d9c+_0x246317(0x1e5)+_0x23f9d8+',\x20'+_0x116d9c+'\x20';return _0x36fe73;}},getBodyMessage=_0x7bc84c=>{const _0x1a2f9c=a558_0x4f05bc;try{let _0x36e6b6=getTypeMessage(_0x7bc84c);const _0x19d5ce={'conversation':MessageUtils[_0x1a2f9c(0x2ca)](_0x7bc84c),'editedMessage':_0x7bc84c?.[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x2b3)]?.[_0x1a2f9c(0x1bc)]?.['protocolMessage']?.[_0x1a2f9c(0x2b3)]?.[_0x1a2f9c(0x206)]||_0x7bc84c?.[_0x1a2f9c(0x1bc)]?.['editedMessage']?.[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x261)]?.['text'],'imageMessage':MessageUtils[_0x1a2f9c(0x2a6)](_0x7bc84c),'videoMessage':MessageUtils[_0x1a2f9c(0x1de)](_0x7bc84c),'extendedTextMessage':_0x7bc84c['message']?.['extendedTextMessage']?.[_0x1a2f9c(0x26b)],'buttonsResponseMessage':MessageUtils[_0x1a2f9c(0x342)](_0x7bc84c),'templateButtonReplyMessage':_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x218)]?.[_0x1a2f9c(0x2d6)],'messageContextInfo':_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x242)]?.[_0x1a2f9c(0x200)]||_0x7bc84c[_0x1a2f9c(0x1bc)]?.['listResponseMessage']?.[_0x1a2f9c(0x23d)],'buttonsMessage':MessageUtils[_0x1a2f9c(0x256)](_0x7bc84c)||_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x268)]?.['singleSelectReply']?.[_0x1a2f9c(0x199)],'viewOnceMessage':MessageUtils[_0x1a2f9c(0x22e)](_0x7bc84c),'viewOnceMessageV2':MessageUtils[_0x1a2f9c(0x2d2)](_0x7bc84c),'stickerMessage':MessageUtils[_0x1a2f9c(0x354)](_0x7bc84c),'contactMessage':MessageUtils[_0x1a2f9c(0x213)](_0x7bc84c),'contactsArrayMessage':_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x347)]?.[_0x1a2f9c(0x35f)]&&MessageUtils[_0x1a2f9c(0x1af)](_0x7bc84c),'pollCreationMessageV2':_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x23a)]?.[_0x1a2f9c(0x314)]||'Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','pollCreationMessageV3':_0x7bc84c['message']?.[_0x1a2f9c(0x19a)]?.[_0x1a2f9c(0x314)]||_0x1a2f9c(0x2bb),'interactiveMessage':_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x1b8)]?.['body']||_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x1b8)]?.[_0x1a2f9c(0x232)]||'Mensagem\x20interativa\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','locationMessage':MessageUtils['getLocationMessage'](_0x7bc84c),'liveLocationMessage':'Latitude:\x20'+_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x19c)]?.[_0x1a2f9c(0x33f)]+_0x1a2f9c(0x297)+_0x7bc84c[_0x1a2f9c(0x1bc)]?.['liveLocationMessage']?.['degreesLongitude'],'documentMessage':MessageUtils[_0x1a2f9c(0x327)](_0x7bc84c),'documentWithCaptionMessage':_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x260)]?.[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x359)]?.[_0x1a2f9c(0x326)],'audioMessage':MessageUtils[_0x1a2f9c(0x280)](_0x7bc84c),'ephemeralMessage':_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x1c9)]?.[_0x1a2f9c(0x1bc)]?.['extendedTextMessage']?.[_0x1a2f9c(0x26b)],'listMessage':MessageUtils[_0x1a2f9c(0x256)](_0x7bc84c)||_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x268)]?.[_0x1a2f9c(0x23d)],'listResponseMessage':MessageUtils['getListMessage'](_0x7bc84c),'reactionMessage':MessageUtils[_0x1a2f9c(0x1ba)](_0x7bc84c)||_0x1a2f9c(0x1e0),'advertising':MessageUtils['getAd'](_0x7bc84c)||_0x7bc84c[_0x1a2f9c(0x1bc)]?.['listResponseMessage']?.['contextInfo']?.[_0x1a2f9c(0x30a)]?.[_0x1a2f9c(0x23d)],'productMessage':_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x1a4)]?.['product']?.['productImage']?.[_0x1a2f9c(0x326)]||_0x1a2f9c(0x25f),'multiProductMessage':_0x1a2f9c(0x1cf),'orderMessage':_0x1a2f9c(0x277),'paymentMessage':MessageUtils[_0x1a2f9c(0x29e)](_0x7bc84c),'paymentRequestMessage':_0x1a2f9c(0x24a),'groupInviteMessage':MessageUtils[_0x1a2f9c(0x1b9)](_0x7bc84c),'revokeInviteMessage':_0x1a2f9c(0x2fc),'protocolMessage':_0x7bc84c[_0x1a2f9c(0x1bc)]?.[_0x1a2f9c(0x266)]?.[_0x1a2f9c(0x2b3)]?.[_0x1a2f9c(0x206)]||null,'disappearingMessage':_0x1a2f9c(0x32a),'callMessage':MessageUtils[_0x1a2f9c(0x2d1)](_0x7bc84c),'templateMessage':MessageUtils[_0x1a2f9c(0x299)](_0x7bc84c),'statusUpdateMessage':_0x1a2f9c(0x2ec)};return _0x19d5ce[_0x36e6b6]||null;}catch(_0x51fbb5){return console[_0x1a2f9c(0x253)](_0x1a2f9c(0x312),_0x51fbb5),null;}};exports[a558_0x4f05bc(0x2f7)]=getBodyMessage;const getQuotedMessage=_0x21db0a=>{const _0x59e0a3=a558_0x4f05bc,_0x1ca926=_0x21db0a['message'][_0x59e0a3(0x1e1)][_0x59e0a3(0x232)]||_0x21db0a[_0x59e0a3(0x1bc)]['videoMessage']['contextInfo']||_0x21db0a[_0x59e0a3(0x1bc)]?.['documentMessage']||_0x21db0a[_0x59e0a3(0x1bc)][_0x59e0a3(0x261)]['contextInfo']||_0x21db0a['message'][_0x59e0a3(0x242)][_0x59e0a3(0x232)]||_0x21db0a[_0x59e0a3(0x1bc)][_0x59e0a3(0x268)]['contextInfo']||_0x21db0a[_0x59e0a3(0x1bc)][_0x59e0a3(0x218)][_0x59e0a3(0x232)]||_0x21db0a[_0x59e0a3(0x1bc)][_0x59e0a3(0x242)]?.['contextInfo']||_0x21db0a?.[_0x59e0a3(0x1bc)]?.[_0x59e0a3(0x242)]?.[_0x59e0a3(0x200)]||_0x21db0a[_0x59e0a3(0x1bc)][_0x59e0a3(0x268)]?.[_0x59e0a3(0x2b7)]?.[_0x59e0a3(0x199)]||_0x21db0a?.[_0x59e0a3(0x1bc)]?.[_0x59e0a3(0x268)]?.[_0x59e0a3(0x2b7)]['selectedRowId']||_0x21db0a['message']['listResponseMessage']?.['contextInfo'];return _0x21db0a[_0x59e0a3(0x1bc)][_0x59e0a3(0x2d9)],(0x0,baileys_1['extractMessageContent'])(_0x1ca926[Object[_0x59e0a3(0x19d)](_0x1ca926)[_0x59e0a3(0x2a5)]()[_0x59e0a3(0x325)]()['value']]);};exports['getQuotedMessage']=getQuotedMessage;const getQuotedMessageId=_0x2258f8=>{const _0xd5988e=a558_0x4f05bc,_0x582936=(0x0,baileys_1['extractMessageContent'])(_0x2258f8['message'])[Object[_0xd5988e(0x19d)](_0x2258f8?.[_0xd5988e(0x1bc)])['values']()[_0xd5988e(0x325)]()[_0xd5988e(0x259)]];let _0x4cc505=_0x2258f8?.[_0xd5988e(0x1bc)]?.['reactionMessage']?_0x2258f8?.[_0xd5988e(0x1bc)]?.['reactionMessage']?.[_0xd5988e(0x1b3)]?.['id']:'';return _0x4cc505?_0x4cc505:_0x582936?.['contextInfo']?.[_0xd5988e(0x349)];};exports[a558_0x4f05bc(0x1ac)]=getQuotedMessageId;const getMeSocket=_0x1894f0=>{const _0x559bad=a558_0x4f05bc;return{'id':(0x0,baileys_1[_0x559bad(0x338)])(_0x1894f0[_0x559bad(0x22c)]['id']),'name':_0x1894f0[_0x559bad(0x22c)]['name']};},getSenderMessage=(_0x1e08fc,_0x5c0f0d)=>{const _0x11cb2b=a558_0x4f05bc,_0x34ee87=getMeSocket(_0x5c0f0d);if(_0x1e08fc['key']['fromMe'])return _0x34ee87['id'];const _0x1d2c42=_0x1e08fc[_0x11cb2b(0x21c)]||_0x1e08fc[_0x11cb2b(0x1b3)][_0x11cb2b(0x21c)]||_0x1e08fc[_0x11cb2b(0x1b3)][_0x11cb2b(0x1f1)]||undefined;return _0x1d2c42&&(0x0,baileys_1[_0x11cb2b(0x338)])(_0x1d2c42);},getContactMessage=async(_0x5ef250,_0x43b490)=>{const _0x5d4ff2=a558_0x4f05bc,_0x2efe7c=_0x5ef250[_0x5d4ff2(0x1b3)]['remoteJid']['includes']('g.us'),_0x47b0f9=_0x5ef250[_0x5d4ff2(0x1b3)][_0x5d4ff2(0x1f1)][_0x5d4ff2(0x2c6)](/\D/g,'');return _0x2efe7c?{'id':getSenderMessage(_0x5ef250,_0x43b490),'name':_0x5ef250[_0x5d4ff2(0x360)]}:{'id':_0x5ef250[_0x5d4ff2(0x1b3)][_0x5d4ff2(0x1f1)],'name':_0x5ef250[_0x5d4ff2(0x1b3)][_0x5d4ff2(0x2b2)]?_0x47b0f9:_0x5ef250[_0x5d4ff2(0x360)]};},getUnpackedMessage=_0x26f7ec=>{const _0x3e1735=a558_0x4f05bc;return _0x26f7ec[_0x3e1735(0x1bc)]?.[_0x3e1735(0x260)]?.[_0x3e1735(0x1bc)]||_0x26f7ec['message']?.['extendedTextMessage']?.['contextInfo']?.[_0x3e1735(0x33a)]||_0x26f7ec[_0x3e1735(0x1bc)]?.[_0x3e1735(0x1c9)]?.[_0x3e1735(0x1bc)]||_0x26f7ec[_0x3e1735(0x1bc)]?.['viewOnceMessage']?.[_0x3e1735(0x1bc)]||_0x26f7ec['message']?.[_0x3e1735(0x35e)]?.[_0x3e1735(0x1bc)]||_0x26f7ec[_0x3e1735(0x1bc)]?.['ephemeralMessage']?.['message']||_0x26f7ec[_0x3e1735(0x1bc)]?.[_0x3e1735(0x1d6)]?.['hydratedTemplate']||_0x26f7ec[_0x3e1735(0x1bc)]?.[_0x3e1735(0x1d6)]?.[_0x3e1735(0x35d)]||_0x26f7ec[_0x3e1735(0x1bc)]?.['templateMessage']?.[_0x3e1735(0x305)]||_0x26f7ec[_0x3e1735(0x1bc)]?.[_0x3e1735(0x1b8)]?.[_0x3e1735(0x1ce)]||_0x26f7ec[_0x3e1735(0x1bc)]?.[_0x3e1735(0x27c)]?.[_0x3e1735(0x1b5)]?.[_0x3e1735(0x2dd)]||_0x26f7ec[_0x3e1735(0x1bc)];},getMessageMedia=_0x4eaeae=>{const _0x3ae520=a558_0x4f05bc;return _0x4eaeae?.[_0x3ae520(0x1e1)]||_0x4eaeae?.['audioMessage']||_0x4eaeae?.['videoMessage']||_0x4eaeae?.[_0x3ae520(0x257)]||_0x4eaeae?.[_0x3ae520(0x359)]||null;},downloadMedia=async _0xe03188=>{const _0x2bff55=a558_0x4f05bc,_0x3de2f4=getUnpackedMessage(_0xe03188),_0x1dd5a3=getMessageMedia(_0x3de2f4);if(!_0x1dd5a3)return null;const _0x59cb75=_0x3de2f4?.[_0x2bff55(0x359)]?_0x2bff55(0x339):_0x1dd5a3[_0x2bff55(0x285)][_0x2bff55(0x27e)]('/')[0x0][_0x2bff55(0x2c6)](_0x2bff55(0x361),_0x2bff55(0x339))?_0x1dd5a3[_0x2bff55(0x285)][_0x2bff55(0x27e)]('/')[0x0][_0x2bff55(0x2c6)](_0x2bff55(0x361),_0x2bff55(0x339)):_0x1dd5a3[_0x2bff55(0x285)][_0x2bff55(0x27e)]('/')[0x0];let _0x2bef85,_0xebf038=0x0;while(_0xebf038<0xa&&!_0x2bef85){try{_0x1dd5a3?.[_0x2bff55(0x249)]&&(_0x1dd5a3[_0x2bff55(0x2c9)]=''),_0x2bef85=await(0x0,baileys_1[_0x2bff55(0x22a)])(_0x1dd5a3,_0x59cb75);}catch(_0x3b6ace){_0xebf038+=0x1,await new Promise(_0x37ce82=>{setTimeout(_0x37ce82,0x3e8*_0xebf038*0x2);}),logger_1[_0x2bff55(0x21a)][_0x2bff55(0x2ee)](_0x2bff55(0x31b)+_0xebf038+'\x20de\x20baixar\x20o\x20arquivo\x20'+_0xe03188?.[_0x2bff55(0x1b3)]?.['id']);}}if(!_0x2bef85)throw new Error(_0x2bff55(0x1b6));let _0x2ee70f=_0x3de2f4?.[_0x2bff55(0x359)]?.['fileName']||'';if(!_0x2ee70f){const _0x17ac73=mime_1['default'][_0x2bff55(0x276)](_0x1dd5a3[_0x2bff55(0x285)]);_0x2ee70f=(0x0,MakeRandomId_1[_0x2bff55(0x315)])(0x5)+'-'+new Date()[_0x2bff55(0x304)]()+'.'+_0x17ac73;}else _0x2ee70f=_0x2ee70f[_0x2bff55(0x27e)]('.')[_0x2bff55(0x30e)](0x0,-0x1)[_0x2bff55(0x220)]('.')+'.'+(0x0,MakeRandomId_1[_0x2bff55(0x315)])(0x5)+'.'+_0x2ee70f[_0x2bff55(0x27e)]('.')[_0x2bff55(0x30e)](-0x1);const _0x41d621=0x5*0x400*0x400/0x8,_0x26f773=0x400*0x400/0x8,_0xd011e8=0x400*0x400,_0x2c5014=new stream_throttle_1['Throttle']({'rate':_0x41d621});let _0x17fee0=Buffer['from']([]),_0x15c20d=0x0;const _0x380961=Date[_0x2bff55(0x332)]();try{for await(const _0x317861 of _0x2bef85[_0x2bff55(0x2d8)](_0x2c5014)){_0x17fee0=Buffer['concat']([_0x17fee0,_0x317861]),_0x15c20d+=_0x317861[_0x2bff55(0x2ae)],_0x15c20d>_0xd011e8&&(_0x2c5014['rate']=_0x26f773);}}catch(_0x55a43c){return{'data':_0x2bff55(0x253),'mimetype':'','filename':''};}const _0x46121f=Date[_0x2bff55(0x332)](),_0x134818=(_0x46121f-_0x380961)/0x3e8,_0x1f8862=_0x15c20d/_0x134818;logger_1[_0x2bff55(0x21a)][_0x2bff55(0x2c1)](_0x2ee70f+'\x20Download\x20completed\x20in\x20'+_0x134818[_0x2bff55(0x1db)](0x2)+'\x20seconds\x20with\x20an\x20effective\x20speed\x20of\x20'+(_0x1f8862/0x400/0x400)[_0x2bff55(0x1db)](0x2)+'\x20MBps');if(!_0x17fee0){Sentry['setExtra'](_0x2bff55(0x195),{'msg':_0xe03188}),Sentry[_0x2bff55(0x2e8)](new Error(_0x2bff55(0x195)));throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');}const _0x126894={'data':_0x17fee0,'mimetype':_0x1dd5a3['mimetype'],'filename':_0x2ee70f};return _0x126894;},verifyContact=async(_0x330224,_0x24ef70,_0x4fdac6)=>{const _0x5e4765=a558_0x4f05bc,_0x2b8ecd={'name':_0x330224?.[_0x5e4765(0x314)]||_0x330224['id'][_0x5e4765(0x2c6)](/\D/g,''),'number':_0x330224['id'][_0x5e4765(0x2a9)](0x0,_0x330224['id']['indexOf']('@')),'isGroup':_0x330224['id'][_0x5e4765(0x356)](_0x5e4765(0x2a1)),'companyId':_0x4fdac6,'whatsappId':_0x24ef70['id']},_0x101de9=(0x0,CreateOrUpdateContactService_1[_0x5e4765(0x289)])(_0x2b8ecd,_0x24ef70,_0x330224['id']);return _0x101de9;},verifyQuotedMessage=async _0x27d5fb=>{const _0x3bec9d=a558_0x4f05bc;if(!_0x27d5fb)return null;const _0x442367=(0x0,exports[_0x3bec9d(0x1ac)])(_0x27d5fb);if(!_0x442367)return null;const _0xce5b39=await Message_1['default']['findOne']({'where':{'id':_0x442367}});if(!_0xce5b39)return null;return _0xce5b39;};exports[a558_0x4f05bc(0x31e)]=verifyQuotedMessage;const sanitizeName=_0x38ceb9=>{const _0x1a5c50=a558_0x4f05bc;let _0x1feb5d=_0x38ceb9[_0x1a5c50(0x27e)]('\x20')[0x0];return _0x1feb5d=_0x1feb5d[_0x1a5c50(0x2c6)](/[^a-zA-Z0-9]/g,''),_0x1feb5d[_0x1a5c50(0x2a9)](0x0,0x3c);},convertTextToSpeechAndSaveToFile=(_0x578046,_0x3f42be,_0x388726,_0x150b79,_0x4f65ef=a558_0x4f05bc(0x340),_0x17ac2a=a558_0x4f05bc(0x351))=>{return new Promise((_0x1dde6c,_0x24eca7)=>{const _0xd2f58d=a558_0x3203,_0x489dd9=microsoft_cognitiveservices_speech_sdk_1[_0xd2f58d(0x1d1)][_0xd2f58d(0x2b0)](_0x388726,_0x150b79);_0x489dd9['speechSynthesisVoiceName']=_0x4f65ef;const _0x10f4d4=microsoft_cognitiveservices_speech_sdk_1[_0xd2f58d(0x33e)][_0xd2f58d(0x2de)](_0x3f42be+'.wav'),_0x1f2037=new microsoft_cognitiveservices_speech_sdk_1[(_0xd2f58d(0x2aa))](_0x489dd9,_0x10f4d4);_0x1f2037[_0xd2f58d(0x263)](_0x578046,_0x30358d=>{const _0x3b3038=_0xd2f58d;_0x30358d?convertWavToAnotherFormat(_0x3f42be+_0x3b3038(0x344),_0x3f42be+'.'+_0x17ac2a,_0x17ac2a)[_0x3b3038(0x301)](_0x2821b5=>{_0x1dde6c();})[_0x3b3038(0x2f5)](_0x2d2c12=>{const _0x2f1e57=_0x3b3038;console[_0x2f1e57(0x253)](_0x2d2c12),_0x24eca7(_0x2d2c12);}):_0x24eca7(new Error('No\x20result\x20from\x20synthesizer')),_0x1f2037[_0x3b3038(0x35c)]();},_0x6135a4=>{const _0x540d3c=_0xd2f58d;console[_0x540d3c(0x253)]('Error:\x20'+_0x6135a4),_0x1f2037[_0x540d3c(0x35c)](),_0x24eca7(_0x6135a4);});});},convertWavToAnotherFormat=(_0x40f466,_0x40619b,_0x5ebff2)=>{return new Promise((_0x41cf4b,_0x445e1d)=>{const _0x596340=a558_0x3203;(0x0,fluent_ffmpeg_1[_0x596340(0x289)])()[_0x596340(0x22f)](_0x40f466)[_0x596340(0x26d)](_0x5ebff2)['on']('end',()=>_0x41cf4b(_0x40619b))['on']('error',_0x5758fc=>_0x445e1d(new Error(_0x596340(0x269)+_0x5758fc[_0x596340(0x1bc)])))[_0x596340(0x283)](_0x40619b);});},deleteFileSync=_0x4798ef=>{const _0x48bd3e=a558_0x4f05bc;try{fs_2[_0x48bd3e(0x289)]['unlinkSync'](_0x4798ef);}catch(_0x42fd33){console[_0x48bd3e(0x253)](_0x48bd3e(0x1a7),_0x42fd33);}},keepOnlySpecifiedChars=_0x5563f3=>{const _0x209c67=a558_0x4f05bc;return _0x5563f3[_0x209c67(0x2c6)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x2f7121,_0x50f927,_0x2bef4e,_0x4e365a,_0x537f44)=>{const _0x906c7c=a558_0x4f05bc,_0x2d9f53=(0x0,exports[_0x906c7c(0x2f7)])(_0x2f7121);if(!_0x2d9f53)return;let {prompt:_0x239487}=await(0x0,ShowWhatsAppService_1[_0x906c7c(0x289)])(_0x50f927['id'],_0x2bef4e[_0x906c7c(0x35b)]);!_0x239487&&!(0x0,lodash_1[_0x906c7c(0x1a0)])(_0x2bef4e?.['queue']?.[_0x906c7c(0x229)])&&(_0x239487=_0x2bef4e[_0x906c7c(0x230)][_0x906c7c(0x229)]);if(!_0x239487)return;if(_0x2f7121[_0x906c7c(0x1a3)])return;const _0x5417aa=path_1[_0x906c7c(0x289)]['resolve'](__dirname,'..','..','..',_0x906c7c(0x1e3));let _0x2fbcc3;const _0x4488d0=sessionsOpenAi[_0x906c7c(0x271)](_0x22667f=>_0x22667f['id']===_0x50f927['id']);if(_0x4488d0===-0x1){const _0x448ee9=new openai_1[(_0x906c7c(0x28c))]({'apiKey':_0x239487['apiKey']});_0x2fbcc3=new openai_1[(_0x906c7c(0x1d9))](_0x448ee9),_0x2fbcc3['id']=_0x50f927['id'],sessionsOpenAi[_0x906c7c(0x1d5)](_0x2fbcc3);}else _0x2fbcc3=sessionsOpenAi[_0x4488d0];const _0x454007=await Message_1[_0x906c7c(0x289)]['findAll']({'where':{'ticketId':_0x2bef4e['id']},'order':[[_0x906c7c(0x21f),_0x906c7c(0x33b)]],'limit':_0x239487[_0x906c7c(0x334)]}),_0x3bc114=_0x906c7c(0x362)+sanitizeName(_0x4e365a[_0x906c7c(0x314)]||'Amigo(a)')+_0x906c7c(0x2e5)+_0x239487[_0x906c7c(0x1f8)]+_0x906c7c(0x28d)+_0x239487[_0x906c7c(0x229)]+'\x0a';let _0x23ae69=[];if(_0x2f7121[_0x906c7c(0x1bc)]?.['conversation']||_0x2f7121[_0x906c7c(0x1bc)]?.[_0x906c7c(0x261)]?.[_0x906c7c(0x26b)]){_0x23ae69=[],_0x23ae69[_0x906c7c(0x1d5)]({'role':_0x906c7c(0x302),'content':_0x3bc114});for(let _0x525a38=0x0;_0x525a38<Math[_0x906c7c(0x1da)](_0x239487[_0x906c7c(0x334)],_0x454007[_0x906c7c(0x2ae)]);_0x525a38++){const _0x414e2d=_0x454007[_0x525a38];_0x414e2d[_0x906c7c(0x2ce)]==='chat'&&(_0x414e2d[_0x906c7c(0x2b2)]?_0x23ae69[_0x906c7c(0x1d5)]({'role':_0x906c7c(0x265),'content':_0x414e2d[_0x906c7c(0x28e)]}):_0x23ae69['push']({'role':_0x906c7c(0x22c),'content':_0x414e2d[_0x906c7c(0x28e)]}));}_0x23ae69['push']({'role':_0x906c7c(0x22c),'content':_0x2d9f53});const _0x329742=await _0x2fbcc3['createChatCompletion']({'model':_0x906c7c(0x34f),'messages':_0x23ae69,'max_tokens':_0x239487[_0x906c7c(0x1f8)],'temperature':_0x239487['temperature']});let _0x426796=_0x329742[_0x906c7c(0x248)][_0x906c7c(0x215)][0x0][_0x906c7c(0x1bc)]?.['content'];_0x426796?.[_0x906c7c(0x356)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x239487['queueId'],_0x2bef4e,_0x4e365a),_0x426796=_0x426796[_0x906c7c(0x2c6)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','')[_0x906c7c(0x1b0)]());if(_0x239487[_0x906c7c(0x1fb)]==='texto'){const _0x7c9b47=await _0x50f927[_0x906c7c(0x26a)](_0x2f7121[_0x906c7c(0x1b3)][_0x906c7c(0x1f1)],{'text':_0x426796});await(0x0,exports['verifyMessage'])(_0x7c9b47,_0x2bef4e,_0x4e365a);}else{const _0x22d5e7=_0x2bef4e['id']+'_'+Date['now']();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x426796),_0x5417aa+'/'+_0x22d5e7,_0x239487['voiceKey'],_0x239487[_0x906c7c(0x246)],_0x239487[_0x906c7c(0x1fb)],_0x906c7c(0x351))[_0x906c7c(0x301)](async()=>{const _0x21fc07=_0x906c7c;try{const _0x31b37c=await _0x50f927[_0x21fc07(0x26a)](_0x2f7121[_0x21fc07(0x1b3)][_0x21fc07(0x1f1)],{'audio':{'url':_0x5417aa+'/'+_0x22d5e7+_0x21fc07(0x216)},'mimetype':_0x21fc07(0x19e),'ptt':!![]});await verifyMediaMessage(_0x31b37c,_0x2bef4e,_0x4e365a),deleteFileSync(_0x5417aa+'/'+_0x22d5e7+'.mp3'),deleteFileSync(_0x5417aa+'/'+_0x22d5e7+_0x21fc07(0x344));}catch(_0x5bb7f8){console[_0x21fc07(0x1fa)](_0x21fc07(0x35a)+_0x5bb7f8);}});}}else{if(_0x2f7121[_0x906c7c(0x1bc)]?.[_0x906c7c(0x316)]){const _0x5b700d=_0x537f44[_0x906c7c(0x33c)][_0x906c7c(0x27e)]('/')[_0x906c7c(0x1df)](),_0xef3870=fs_2[_0x906c7c(0x289)]['createReadStream'](_0x5417aa+'/'+_0x5b700d),_0x116b8d=await _0x2fbcc3[_0x906c7c(0x29c)](_0xef3870,_0x906c7c(0x1e9));_0x23ae69=[],_0x23ae69['push']({'role':'system','content':_0x3bc114});for(let _0x284c84=0x0;_0x284c84<Math[_0x906c7c(0x1da)](_0x239487[_0x906c7c(0x334)],_0x454007[_0x906c7c(0x2ae)]);_0x284c84++){const _0xaf9622=_0x454007[_0x284c84];_0xaf9622['mediaType']==='chat'&&(_0xaf9622[_0x906c7c(0x2b2)]?_0x23ae69[_0x906c7c(0x1d5)]({'role':'assistant','content':_0xaf9622['body']}):_0x23ae69[_0x906c7c(0x1d5)]({'role':_0x906c7c(0x22c),'content':_0xaf9622[_0x906c7c(0x28e)]}));}_0x23ae69[_0x906c7c(0x1d5)]({'role':_0x906c7c(0x22c),'content':_0x116b8d['data'][_0x906c7c(0x26b)]});const _0x3e41f6=await _0x2fbcc3[_0x906c7c(0x29d)]({'model':_0x906c7c(0x34f),'messages':_0x23ae69,'max_tokens':_0x239487['maxTokens'],'temperature':_0x239487[_0x906c7c(0x24f)]});let _0x4881f4=_0x3e41f6[_0x906c7c(0x248)]['choices'][0x0][_0x906c7c(0x1bc)]?.[_0x906c7c(0x298)];_0x4881f4?.['includes']('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x239487['queueId'],_0x2bef4e,_0x4e365a),_0x4881f4=_0x4881f4[_0x906c7c(0x2c6)](_0x906c7c(0x2e6),'')[_0x906c7c(0x1b0)]());if(_0x239487[_0x906c7c(0x1fb)]===_0x906c7c(0x2f8)){const _0x3cc9e3=await _0x50f927['sendMessage'](_0x2f7121[_0x906c7c(0x1b3)][_0x906c7c(0x1f1)],{'text':_0x4881f4});await(0x0,exports[_0x906c7c(0x25b)])(_0x3cc9e3,_0x2bef4e,_0x4e365a);}else{const _0x408223=_0x2bef4e['id']+'_'+Date[_0x906c7c(0x332)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x4881f4),_0x5417aa+'/'+_0x408223,_0x239487['voiceKey'],_0x239487['voiceRegion'],_0x239487['voice'],_0x906c7c(0x351))[_0x906c7c(0x301)](async()=>{const _0x5a358f=_0x906c7c;try{const _0x25b673=await _0x50f927[_0x5a358f(0x26a)](_0x2f7121[_0x5a358f(0x1b3)][_0x5a358f(0x1f1)],{'audio':{'url':_0x5417aa+'/'+_0x408223+_0x5a358f(0x216)},'mimetype':_0x5a358f(0x19e),'ptt':!![]});await verifyMediaMessage(_0x25b673,_0x2bef4e,_0x4e365a),deleteFileSync(_0x5417aa+'/'+_0x408223+_0x5a358f(0x216)),deleteFileSync(_0x5417aa+'/'+_0x408223+_0x5a358f(0x344));}catch(_0x4968b2){console[_0x5a358f(0x1fa)](_0x5a358f(0x35a)+_0x4968b2);}});}}}_0x23ae69=[];},transferQueue=async(_0x7f1dfe,_0x472cd2,_0x132cca)=>{const _0x573fc0=a558_0x4f05bc;console[_0x573fc0(0x27d)]('update!'),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x7f1dfe,'useIntegration':![],'promptId':null},'ticketId':_0x472cd2['id'],'companyId':_0x472cd2[_0x573fc0(0x35b)]});},verifyMediaMessage=async(_0x2ed91c,_0x3f5890,_0x2df2e)=>{const _0x4aa3d4=a558_0x4f05bc,_0x4cfb67=(0x0,socket_1[_0x4aa3d4(0x2a8)])();let _0x58087a=await Message_1['default'][_0x4aa3d4(0x20d)]({'where':{'id':_0x2ed91c['key']['id']}});if(!_0x58087a){const _0x14220d=await(0x0,exports[_0x4aa3d4(0x31e)])(_0x2ed91c),_0x5b0216=(0x0,wbot_1[_0x4aa3d4(0x357)])(_0x3f5890[_0x4aa3d4(0x2c7)]),_0x16e3e1=await downloadMedia(_0x2ed91c);if(!_0x16e3e1)throw new Error(_0x4aa3d4(0x195));if(!_0x16e3e1[_0x4aa3d4(0x1c0)]){const _0x15a05f=typeof _0x16e3e1['mimetype']===_0x4aa3d4(0x2b5)&&_0x16e3e1[_0x4aa3d4(0x285)]['includes']('/')&&_0x16e3e1['mimetype'][_0x4aa3d4(0x356)](';')?mime_1['default'][_0x4aa3d4(0x276)](_0x16e3e1[_0x4aa3d4(0x285)]):_0x4aa3d4(0x284);_0x16e3e1[_0x4aa3d4(0x1c0)]=new Date()[_0x4aa3d4(0x304)]()+'.'+_0x15a05f;}else{let _0x4ac195=_0x16e3e1['filename']?'-'+_0x16e3e1['filename']:'';_0x16e3e1[_0x4aa3d4(0x1c0)]=''+new Date()[_0x4aa3d4(0x304)]()+_0x4ac195;}try{const _0x438a8c=_0x4aa3d4(0x1fc)+_0x3f5890['companyId'];!fs_2['default'][_0x4aa3d4(0x2d4)](_0x438a8c)&&(fs_2[_0x4aa3d4(0x289)][_0x4aa3d4(0x291)](_0x438a8c),fs_2[_0x4aa3d4(0x289)][_0x4aa3d4(0x208)](_0x438a8c,0x1ff)),await writeFileAsync((0x0,path_1['join'])(__dirname,'..','..','..',_0x438a8c,_0x16e3e1[_0x4aa3d4(0x1c0)]),_0x16e3e1[_0x4aa3d4(0x248)],_0x4aa3d4(0x2bd));}catch(_0x475063){Sentry[_0x4aa3d4(0x2e8)](_0x475063),logger_1['logger'][_0x4aa3d4(0x253)](_0x475063);}const _0x17f154=(0x0,exports[_0x4aa3d4(0x2f7)])(_0x2ed91c);var _0x1a0dec=getTypeMessage(_0x2ed91c);const _0x542ce6={'id':_0x2ed91c[_0x4aa3d4(0x1b3)]['id'],'ticketId':_0x3f5890['id'],'contactId':_0x2ed91c[_0x4aa3d4(0x1b3)][_0x4aa3d4(0x2b2)]?undefined:_0x2df2e['id'],'body':_0x17f154?(0x0,Mustache_1[_0x4aa3d4(0x289)])(_0x17f154,_0x3f5890):_0x16e3e1[_0x4aa3d4(0x1c0)],'fromMe':_0x2ed91c[_0x4aa3d4(0x1b3)]['fromMe'],'read':_0x2ed91c[_0x4aa3d4(0x1b3)][_0x4aa3d4(0x2b2)],'mediaUrl':_0x16e3e1[_0x4aa3d4(0x1c0)],'mediaType':typeof _0x16e3e1['mimetype']===_0x4aa3d4(0x2b5)?_0x16e3e1[_0x4aa3d4(0x285)][_0x4aa3d4(0x27e)]('/')[0x0]:_0x4aa3d4(0x284),'quotedMsgId':_0x14220d?.['id'],'ack':getStatus(_0x2ed91c,_0x4aa3d4(0x2d3)),'remoteJid':_0x2ed91c['key'][_0x4aa3d4(0x1f1)],'participant':_0x2ed91c[_0x4aa3d4(0x1b3)][_0x4aa3d4(0x21c)],'dataJson':JSON[_0x4aa3d4(0x27a)](_0x2ed91c)};var _0x572add=_0x17f154||_0x16e3e1[_0x4aa3d4(0x1c0)];typeof _0x572add!=_0x4aa3d4(0x2b5)&&console['trace'](_0x4aa3d4(0x2be),_0x572add),await _0x3f5890['update']({'lastMessage':_0x572add}),_0x58087a=await(0x0,CreateMessageService_1[_0x4aa3d4(0x289)])({'messageData':_0x542ce6,'ticket':_0x3f5890,'companyId':_0x3f5890['companyId']});}else typeof _0x58087a[_0x4aa3d4(0x28e)]!=_0x4aa3d4(0x2b5)&&console[_0x4aa3d4(0x27d)](_0x4aa3d4(0x2be),_0x58087a[_0x4aa3d4(0x28e)]),await _0x3f5890[_0x4aa3d4(0x1e7)]({'lastMessage':_0x58087a[_0x4aa3d4(0x28e)]}),_0x58087a[_0x4aa3d4(0x198)]=getStatus(_0x2ed91c,_0x4aa3d4(0x2d3)),_0x58087a['participant']=_0x2ed91c[_0x4aa3d4(0x1b3)][_0x4aa3d4(0x21c)],_0x58087a[_0x4aa3d4(0x2f1)]=JSON[_0x4aa3d4(0x27a)](_0x2ed91c),await _0x58087a[_0x4aa3d4(0x283)]();return!_0x2ed91c[_0x4aa3d4(0x1b3)]['fromMe']&&_0x3f5890[_0x4aa3d4(0x346)]===_0x4aa3d4(0x264)&&(await _0x3f5890['update']({'status':_0x4aa3d4(0x2d0)}),await _0x3f5890['reload']({'include':[{'model':Queue_1[_0x4aa3d4(0x289)],'as':_0x4aa3d4(0x230)},{'model':User_1[_0x4aa3d4(0x289)],'as':_0x4aa3d4(0x22c)},{'model':Contact_1['default'],'as':_0x4aa3d4(0x32d)}]}),_0x4cfb67['to'](_0x4aa3d4(0x1f6)+_0x3f5890[_0x4aa3d4(0x35b)]+'-closed')[_0x4aa3d4(0x2a3)](_0x4aa3d4(0x1f6)+_0x3f5890[_0x4aa3d4(0x35b)]+_0x4aa3d4(0x2d7),{'action':_0x4aa3d4(0x31d),'ticket':_0x3f5890,'ticketId':_0x3f5890['id']}),_0x4cfb67['to'](_0x4aa3d4(0x1f6)+_0x3f5890['companyId']+'-'+_0x3f5890['status'])['to'](_0x3f5890['id']['toString']())[_0x4aa3d4(0x2a3)]('company-'+_0x3f5890[_0x4aa3d4(0x35b)]+'-ticket',{'action':_0x4aa3d4(0x1e7),'ticket':_0x3f5890,'ticketId':_0x3f5890['id']})),_0x58087a;};function getStatus(_0x5bb174,_0x47b3f0){const _0x498144=a558_0x4f05bc;if(_0x5bb174['status']==baileys_1[_0x498144(0x1fe)][_0x498144(0x226)]['Status'][_0x498144(0x1f2)]){if(_0x5bb174['key'][_0x498144(0x2b2)]&&_0x47b3f0==_0x498144(0x237))return 0x3;return 0x1;}else{if(_0x5bb174['status']==baileys_1[_0x498144(0x1fe)]['WebMessageInfo'][_0x498144(0x1c2)][_0x498144(0x2f6)])return 0x1;else{if(_0x5bb174[_0x498144(0x346)]==baileys_1['proto'][_0x498144(0x226)][_0x498144(0x1c2)][_0x498144(0x1dd)])return 0x2;else{if(_0x5bb174[_0x498144(0x346)]==baileys_1[_0x498144(0x1fe)][_0x498144(0x226)]['Status'][_0x498144(0x21b)]||_0x5bb174[_0x498144(0x346)]==baileys_1[_0x498144(0x1fe)]['WebMessageInfo'][_0x498144(0x1c2)][_0x498144(0x313)])return 0x3;}}}return 0x0;}const verifyMessage=async(_0x3e61f7,_0x164caf,_0x2160ac)=>{const _0xf31763=a558_0x4f05bc,_0x1b331e=(0x0,socket_1[_0xf31763(0x2a8)])(),_0x312993=await(0x0,exports[_0xf31763(0x31e)])(_0x3e61f7),_0x491fbc=(0x0,exports[_0xf31763(0x2f7)])(_0x3e61f7);if(!_0x491fbc)return;let _0x55f177=getTypeMessage(_0x3e61f7);const _0x5d76a9=_0x55f177=='editedMessage'||_0x3e61f7?.[_0xf31763(0x1bc)]?.['protocolMessage']?.[_0xf31763(0x2b9)]==baileys_1[_0xf31763(0x1fe)][_0xf31763(0x1ec)][_0xf31763(0x1c7)][_0xf31763(0x2cf)][_0xf31763(0x319)]||_0x3e61f7?.['message']?.[_0xf31763(0x266)]?.['editedMessage']?.[_0xf31763(0x206)]?.[_0xf31763(0x2ae)]>0x0;let _0x253c94=_0x3e61f7[_0xf31763(0x1b3)]['id'];if(_0x55f177==_0xf31763(0x266))_0x253c94=_0x3e61f7?.[_0xf31763(0x1bc)]?.[_0xf31763(0x266)]?.[_0xf31763(0x1b3)]?.['id']||_0x3e61f7['key']['id'];else _0x55f177==_0xf31763(0x2b3)&&(_0x253c94=_0x3e61f7?.[_0xf31763(0x1bc)]?.['editedMessage']?.[_0xf31763(0x1bc)]?.[_0xf31763(0x266)]?.[_0xf31763(0x1b3)]?.['id']||_0x3e61f7[_0xf31763(0x1b3)]['id']);const _0x40d754={'id':_0x253c94,'ticketId':_0x164caf['id'],'contactId':_0x3e61f7['key'][_0xf31763(0x2b2)]?undefined:_0x2160ac['id'],'body':_0x491fbc,'fromMe':_0x3e61f7[_0xf31763(0x1b3)][_0xf31763(0x2b2)],'mediaType':_0x55f177,'read':_0x3e61f7[_0xf31763(0x1b3)]['fromMe'],'quotedMsgId':_0x312993?.['id'],'ack':getStatus(_0x3e61f7,_0x55f177),'remoteJid':_0x3e61f7[_0xf31763(0x1b3)][_0xf31763(0x1f1)],'participant':_0x3e61f7[_0xf31763(0x1b3)][_0xf31763(0x21c)],'dataJson':JSON[_0xf31763(0x27a)](_0x3e61f7),'isEdited':_0x5d76a9};typeof _0x491fbc!=_0xf31763(0x2b5)&&console[_0xf31763(0x27d)](_0xf31763(0x2be),_0x491fbc);await _0x164caf[_0xf31763(0x1e7)]({'lastMessage':_0x491fbc});if(_0x5d76a9){let _0x1806a1=await Message_1['default'][_0xf31763(0x2ac)](_0x40d754['id']);if(_0x1806a1){const _0x5ec368={'messageId':_0x40d754['id'],'body':_0x1806a1[_0xf31763(0x28e)]};await OldMessage_1[_0xf31763(0x289)][_0xf31763(0x25c)](_0x5ec368);}else console[_0xf31763(0x1fa)](_0xf31763(0x293)+_0x40d754['id']);}await(0x0,CreateMessageService_1[_0xf31763(0x289)])({'messageData':_0x40d754,'ticket':_0x164caf,'companyId':_0x164caf['companyId']}),!_0x3e61f7[_0xf31763(0x1b3)][_0xf31763(0x2b2)]&&_0x164caf[_0xf31763(0x346)]===_0xf31763(0x264)&&(await _0x164caf[_0xf31763(0x1e7)]({'status':_0xf31763(0x2d0)}),await _0x164caf[_0xf31763(0x2f2)]({'include':[{'model':Queue_1['default'],'as':_0xf31763(0x230)},{'model':User_1['default'],'as':'user'},{'model':Contact_1['default'],'as':_0xf31763(0x32d)}]}),_0x1b331e['to'](_0xf31763(0x1f6)+_0x164caf['companyId']+_0xf31763(0x34c))[_0xf31763(0x2a3)]('company-'+_0x164caf[_0xf31763(0x35b)]+'-ticket',{'action':'delete','ticket':_0x164caf,'ticketId':_0x164caf['id']}),_0x1b331e['to'](_0xf31763(0x1f6)+_0x164caf[_0xf31763(0x35b)]+'-'+_0x164caf[_0xf31763(0x346)])['to'](_0x164caf['id'][_0xf31763(0x1d0)]())['emit'](_0xf31763(0x1f6)+_0x164caf['companyId']+_0xf31763(0x2d7),{'action':_0xf31763(0x1e7),'ticket':_0x164caf,'ticketId':_0x164caf['id']}));};exports[a558_0x4f05bc(0x25b)]=verifyMessage;const isValidMsg=_0x310c1b=>{const _0x331c33=a558_0x4f05bc;if(_0x310c1b['key']['remoteJid']===_0x331c33(0x243))return![];try{const _0x245a65=getTypeMessage(_0x310c1b);if(!_0x245a65)return![];const _0x40df5a=_0x245a65===_0x331c33(0x206)||_0x245a65===_0x331c33(0x2b3)||_0x245a65===_0x331c33(0x261)||_0x245a65===_0x331c33(0x316)||_0x245a65===_0x331c33(0x2b6)||_0x245a65===_0x331c33(0x23a)||_0x245a65===_0x331c33(0x1d6)||_0x245a65===_0x331c33(0x19a)||_0x245a65===_0x331c33(0x1b8)||_0x245a65===_0x331c33(0x1e1)||_0x245a65===_0x331c33(0x359)||_0x245a65==='documentWithCaptionMessage'||_0x245a65==='stickerMessage'||_0x245a65===_0x331c33(0x242)||_0x245a65===_0x331c33(0x306)||_0x245a65===_0x331c33(0x2f3)||_0x245a65===_0x331c33(0x290)||_0x245a65===_0x331c33(0x19c)||_0x245a65==='contactMessage'||_0x245a65==='voiceMessage'||_0x245a65===_0x331c33(0x2ea)||_0x245a65===_0x331c33(0x347)||_0x245a65==='reactionMessage'||_0x245a65==='ephemeralMessage'||_0x245a65==='protocolMessage'||_0x245a65===_0x331c33(0x268)||_0x245a65===_0x331c33(0x32e)||_0x245a65===_0x331c33(0x1dc)||_0x245a65==='viewOnceMessageV2'||_0x245a65===_0x331c33(0x336)||_0x245a65==='highlyStructuredMessage';return!_0x40df5a&&(logger_1[_0x331c33(0x21a)]['warn'](_0x331c33(0x1b7)+_0x245a65+'\x0a'+JSON[_0x331c33(0x27a)](_0x310c1b?.[_0x331c33(0x1bc)])),Sentry[_0x331c33(0x34d)](_0x331c33(0x300),{'BodyMsg':_0x310c1b[_0x331c33(0x1bc)],'msg':_0x310c1b,'msgType':_0x245a65}),Sentry[_0x331c33(0x2e8)](new Error(_0x331c33(0x323)))),!!_0x40df5a;}catch(_0x3bcc99){Sentry[_0x331c33(0x34d)](_0x331c33(0x203),{'msg':_0x310c1b}),Sentry['captureException'](_0x3bcc99);}return![];};exports[a558_0x4f05bc(0x25e)]=isValidMsg;const Push=_0x467f48=>{const _0x24eb44=a558_0x4f05bc;return _0x467f48[_0x24eb44(0x360)];},verifyQueue=async(_0x615222,_0xd27862,_0x16a9d5,_0x5bb7c2,_0x26b1b2)=>{const _0x506ac1=a558_0x4f05bc,_0x5ad7d5=_0x16a9d5[_0x506ac1(0x35b)],{queues:_0x5ac327,greetingMessage:_0x57e3c0,maxUseBotQueues:_0xc3fedd,timeUseBotQueues:_0x40776c}=await(0x0,ShowWhatsAppService_1[_0x506ac1(0x289)])(_0x615222['id'],_0x16a9d5[_0x506ac1(0x35b)]);if(_0x5ac327[_0x506ac1(0x2ae)]===0x1){const _0x28f74b=(0x0,lodash_1[_0x506ac1(0x34e)])(_0x5ac327);let _0x55d0b1=![];_0x28f74b?.['options']&&(_0x55d0b1=_0x28f74b[_0x506ac1(0x204)][_0x506ac1(0x2ae)]>0x0);const _0x4c2b27=await Setting_1['default'][_0x506ac1(0x20d)]({'where':{'key':_0x506ac1(0x241),'companyId':_0x16a9d5['companyId']}});greetingMessageControl['push']({'ticketId':_0x16a9d5['id'],'greetingMessage':_0x57e3c0,'companyId':_0x5ad7d5});if(_0x57e3c0['length']>0x1&&_0x4c2b27?.[_0x506ac1(0x259)]===_0x506ac1(0x23b)){const _0x4fe683=await Message_1[_0x506ac1(0x289)][_0x506ac1(0x20d)]({'where':{'ticketId':_0x16a9d5['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x506ac1(0x236)]]:(0x0,moment_1[_0x506ac1(0x289)])()[_0x506ac1(0x196)](0x5,_0x506ac1(0x2e4))[_0x506ac1(0x2b8)]()}}});if(_0x4fe683)return;const _0x5af6f9=(0x0,Mustache_1['default'])(''+_0x57e3c0,_0x16a9d5);await _0x615222[_0x506ac1(0x26a)](_0x5bb7c2['number']+'@'+(_0x16a9d5[_0x506ac1(0x231)]?_0x506ac1(0x2a1):_0x506ac1(0x1aa)),{'text':_0x5af6f9});}const _0x2f094c=await(0x0,ShowWhatsAppService_1[_0x506ac1(0x289)])(_0x615222['id'],_0x5ad7d5),_0x137a65=_0x5ac327[0x0]?.[_0x506ac1(0x197)]||_0x2f094c[_0x506ac1(0x197)];if(!_0xd27862[_0x506ac1(0x1b3)][_0x506ac1(0x2b2)]&&!_0x16a9d5['isGroup']&&!(0x0,lodash_1[_0x506ac1(0x1a0)])(_0x137a65)){const _0x8be8fa=await(0x0,ShowQueueIntegrationService_1[_0x506ac1(0x289)])(_0x137a65,_0x5ad7d5);await(0x0,exports[_0x506ac1(0x1bb)])(_0xd27862,_0x615222,_0x8be8fa,_0x16a9d5),await _0x16a9d5['update']({'useIntegration':!![],'integrationId':_0x8be8fa['id']});}const _0x122d59=_0x5ac327[0x0]?.[_0x506ac1(0x1d8)]||_0x2f094c[_0x506ac1(0x1d8)];!_0xd27862['key'][_0x506ac1(0x2b2)]&&!_0x16a9d5[_0x506ac1(0x231)]&&!(0x0,lodash_1['isNil'])(_0x122d59)&&(console[_0x506ac1(0x1fa)]('\x201286\x20-\x20Entrei\x20na\x20integracao\x20openai.'),await handleOpenAi(_0xd27862,_0x615222,_0x16a9d5,_0x5bb7c2,_0x26b1b2),await _0x16a9d5[_0x506ac1(0x1e7)]({'useIntegration':!![],'promptId':_0x122d59}));await(0x0,UpdateTicketService_1[_0x506ac1(0x289)])({'ticketData':{'queueId':_0x28f74b?.['id'],'chatbot':_0x55d0b1,'status':'pending'},'ticketId':_0x16a9d5['id'],'companyId':_0x16a9d5[_0x506ac1(0x35b)]});return;}const _0x4b798e=_0xd27862?.['message']?.[_0x506ac1(0x242)]?.[_0x506ac1(0x200)]||_0xd27862?.['message']?.['listResponseMessage']?.[_0x506ac1(0x2b7)]?.[_0x506ac1(0x199)]||_0xd27862?.[_0x506ac1(0x1bc)]?.[_0x506ac1(0x261)]?.['text']||_0xd27862?.[_0x506ac1(0x1bc)]?.['conversation'];let _0x139a52=null;if(_0x4b798e&&!(0x0,exports[_0x506ac1(0x2fd)])(_0x4b798e)||+_0x4b798e>_0x5ac327[_0x506ac1(0x2ae)]){const _0x5f4443=_0x4b798e['toLowerCase']();for(let _0x2fe7fa of _0x5ac327){if(_0x2fe7fa[_0x506ac1(0x314)][_0x506ac1(0x1e2)]()===_0x5f4443){_0x139a52=_0x2fe7fa;break;}if(_0x2fe7fa[_0x506ac1(0x251)]&&_0x2fe7fa[_0x506ac1(0x251)][_0x506ac1(0x2ae)]>0x0){let _0x1ffd4d=_0x2fe7fa[_0x506ac1(0x251)][_0x506ac1(0x27e)](',\x20');for(let _0x2eee6d of _0x1ffd4d){if(_0x2eee6d[_0x506ac1(0x1e2)]()==_0x5f4443){_0x139a52=_0x2fe7fa;break;}}}}}else _0x139a52=_0x5ac327[+_0x4b798e-0x1];const _0x481906=await Setting_1[_0x506ac1(0x289)]['findOne']({'where':{'key':_0x506ac1(0x1cd),'companyId':_0x5ad7d5}}),_0x1c5e39=async()=>{const _0x3a10d3=_0x506ac1;let _0x1b9991='';if(outOfHourMessageControl['length']>0x1388)outOfHourMessageControl=[];_0x5ac327[_0x3a10d3(0x194)]((_0x427384,_0x4bf327)=>{const _0x10e87a=_0x3a10d3;_0x1b9991+=_0x10e87a(0x1c4)+(_0x4bf327+0x1)+_0x10e87a(0x307)+_0x427384['name']+'\x0a';});if(process[_0x3a10d3(0x310)][_0x3a10d3(0x2dc)]?.[_0x3a10d3(0x2ae)]>=0x8){if(_0x16a9d5[_0x3a10d3(0x32d)][_0x3a10d3(0x282)]!=process[_0x3a10d3(0x310)][_0x3a10d3(0x2dc)]){console[_0x3a10d3(0x27d)](_0x3a10d3(0x1c8));return;}}const _0x3668be={'text':(0x0,Mustache_1['default'])('‎'+_0x57e3c0+'\x0a\x0a'+_0x1b9991,_0x16a9d5)};await(0x0,UpdateTicketService_1[_0x3a10d3(0x289)])({'ticketData':{'amountUsedBotQueues':_0x16a9d5[_0x3a10d3(0x2fe)]+0x1},'ticketId':_0x16a9d5['id'],'companyId':_0x16a9d5[_0x3a10d3(0x35b)]});const _0x3f3bdf=await _0x615222[_0x3a10d3(0x26a)](_0x5bb7c2[_0x3a10d3(0x282)]+'@'+(_0x16a9d5[_0x3a10d3(0x231)]?_0x3a10d3(0x2a1):_0x3a10d3(0x1aa)),_0x3668be);await(0x0,exports[_0x3a10d3(0x25b)])(_0x3f3bdf,_0x16a9d5,_0x16a9d5['contact']);};if(_0x139a52){let _0x49cecb=![];_0x139a52?.[_0x506ac1(0x204)]&&(_0x49cecb=_0x139a52['options'][_0x506ac1(0x2ae)]>0x0);await(0x0,UpdateTicketService_1[_0x506ac1(0x289)])({'ticketData':{'queueId':_0x139a52['id'],'chatbot':_0x49cecb,'status':'pending','amountUsedBotQueues':0x0},'ticketId':_0x16a9d5['id'],'companyId':_0x16a9d5[_0x506ac1(0x35b)]}),console[_0x506ac1(0x27d)](_0x139a52[_0x506ac1(0x204)]);if(_0x139a52[_0x506ac1(0x204)][_0x506ac1(0x2ae)]===0x0){const _0x386465=await Queue_1['default'][_0x506ac1(0x2ac)](_0x139a52['id']),{schedules:_0x1035fb}=_0x386465,_0xea9ed0=(0x0,moment_1[_0x506ac1(0x289)])(),_0x552fec=_0xea9ed0[_0x506ac1(0x30b)](_0x506ac1(0x348))['toLowerCase']();let _0x3ee472;Array[_0x506ac1(0x2a7)](_0x1035fb)&&_0x1035fb['length']>0x0&&(_0x3ee472=_0x1035fb['find'](_0x42acc3=>_0x42acc3['weekdayEn']===_0x552fec&&_0x42acc3[_0x506ac1(0x1f9)]!==''&&_0x42acc3['startTime']!==null&&_0x42acc3[_0x506ac1(0x234)]!==''&&_0x42acc3[_0x506ac1(0x234)]!==null));if(_0x386465[_0x506ac1(0x1bd)]!==null&&_0x386465[_0x506ac1(0x1bd)]!==''&&!(0x0,lodash_1[_0x506ac1(0x1a0)])(_0x3ee472)){var _0x269f21=outOfHourMessageControl[_0x506ac1(0x2cb)](_0x107fd1=>_0x107fd1[_0x506ac1(0x205)]===_0x16a9d5['id']||_0x107fd1['dest']===_0x5bb7c2[_0x506ac1(0x282)]);if(!_0x269f21||_0x269f21&&_0x269f21[_0x506ac1(0x1a1)]+0x3e8*0x3c*0x5<new Date()[_0x506ac1(0x304)]()){_0x269f21&&(outOfHourMessageControl=outOfHourMessageControl['filter'](_0x5e1130=>_0x5e1130[_0x506ac1(0x205)]!==_0x16a9d5['id']),_0x269f21=null);const _0x442163=(0x0,moment_1[_0x506ac1(0x289)])(_0x3ee472[_0x506ac1(0x1f9)],_0x506ac1(0x1f7)),_0x9e52e5=(0x0,moment_1[_0x506ac1(0x289)])(_0x3ee472[_0x506ac1(0x234)],'HH:mm');outOfHourMessageControl['push']({'ticketId':_0x16a9d5['id'],'time':new Date()[_0x506ac1(0x304)]()});if(_0xea9ed0[_0x506ac1(0x225)](_0x442163)||_0xea9ed0[_0x506ac1(0x27f)](_0x9e52e5)){const _0x4b59ff=(0x0,Mustache_1[_0x506ac1(0x289)])('‎\x20'+_0x386465[_0x506ac1(0x1bd)]+_0x506ac1(0x1f4),_0x16a9d5),_0xad663a=await _0x615222[_0x506ac1(0x26a)](_0x5bb7c2[_0x506ac1(0x282)]+'@'+(_0x16a9d5['isGroup']?_0x506ac1(0x2a1):_0x506ac1(0x1aa)),{'text':_0x4b59ff});await(0x0,exports[_0x506ac1(0x25b)])(_0xad663a,_0x16a9d5,_0x5bb7c2),await(0x0,UpdateTicketService_1[_0x506ac1(0x289)])({'ticketData':{'queueId':null,'chatbot':_0x49cecb},'ticketId':_0x16a9d5['id'],'companyId':_0x16a9d5[_0x506ac1(0x35b)]}),console[_0x506ac1(0x1fa)](_0x506ac1(0x1d2));return;}}!_0x269f21&&outOfHourMessageControl[_0x506ac1(0x1d5)]({'ticketId':_0x16a9d5['id'],'dest':_0x5bb7c2[_0x506ac1(0x282)],'time':new Date()[_0x506ac1(0x304)]()});}console[_0x506ac1(0x27d)](_0x139a52[_0x506ac1(0x197)]);if(!_0xd27862[_0x506ac1(0x1b3)]['fromMe']&&!_0x16a9d5[_0x506ac1(0x231)]&&_0x139a52[_0x506ac1(0x197)]){const _0x483578=await(0x0,ShowQueueIntegrationService_1[_0x506ac1(0x289)])(_0x139a52[_0x506ac1(0x197)],_0x5ad7d5);await(0x0,exports['handleMessageIntegration'])(_0xd27862,_0x615222,_0x483578,_0x16a9d5),await _0x16a9d5['update']({'useIntegration':!![],'integrationId':_0x483578['id']});}!_0xd27862[_0x506ac1(0x1b3)][_0x506ac1(0x2b2)]&&!_0x16a9d5[_0x506ac1(0x231)]&&!(0x0,lodash_1['isNil'])(_0x139a52?.[_0x506ac1(0x1d8)])&&(await handleOpenAi(_0xd27862,_0x615222,_0x16a9d5,_0x5bb7c2,_0x26b1b2),await _0x16a9d5[_0x506ac1(0x1e7)]({'useIntegration':!![],'promptId':_0x139a52?.[_0x506ac1(0x1d8)]}));const _0xc77f43=(0x0,Mustache_1['default'])('‎'+_0x139a52[_0x506ac1(0x2eb)],_0x16a9d5);if(_0x139a52['greetingMessage']){const _0x25ad7a=await _0x615222[_0x506ac1(0x26a)](_0x5bb7c2['number']+'@'+(_0x16a9d5[_0x506ac1(0x231)]?'g.us':_0x506ac1(0x1aa)),{'text':_0xc77f43});await(0x0,exports[_0x506ac1(0x25b)])(_0x25ad7a,_0x16a9d5,_0x5bb7c2);if(_0x139a52[_0x506ac1(0x2fa)]!==null&&_0x139a52[_0x506ac1(0x2fa)]!==''){const _0x4f3cb6=path_1[_0x506ac1(0x289)]['resolve'](_0x506ac1(0x1e3),_0x506ac1(0x2f0)+_0x139a52[_0x506ac1(0x35b)],_0x139a52['mediaPath']),_0x580124=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x139a52[_0x506ac1(0x2c5)],_0x4f3cb6,null,_0x16a9d5[_0x506ac1(0x35b)]);let _0xa44ba4=await _0x615222[_0x506ac1(0x26a)](_0x16a9d5[_0x506ac1(0x32d)]['number']+'@'+(_0x16a9d5['isGroup']?_0x506ac1(0x2a1):_0x506ac1(0x1aa)),{..._0x580124});await verifyMediaMessage(_0xa44ba4,_0x16a9d5,_0x5bb7c2);}}}}else{if(_0xc3fedd&&_0xc3fedd!==0x0&&_0x16a9d5['amountUsedBotQueues']>=_0xc3fedd)return;const _0xb73486=await(0x0,FindOrCreateATicketTrakingService_1[_0x506ac1(0x289)])({'ticketId':_0x16a9d5['id'],'companyId':_0x5ad7d5});let _0x5f3824=new Date(),_0x194cce=new Date();if(_0xb73486[_0x506ac1(0x287)]!==null){_0x5f3824['setMinutes'](_0xb73486[_0x506ac1(0x287)]['getMinutes']()+Number(_0x40776c));if(_0xb73486[_0x506ac1(0x287)]!==null&&_0x194cce<_0x5f3824&&_0x40776c!=='0'&&_0x16a9d5['amountUsedBotQueues']!==0x0)return;}await _0xb73486[_0x506ac1(0x1e7)]({'updatedAt':new Date()});if(_0x481906[_0x506ac1(0x259)]===_0x506ac1(0x26b))return console['trace']('botText'),_0x1c5e39();}},verifyRating=_0x28565b=>{const _0x3c9ea7=a558_0x4f05bc;return _0x28565b&&_0x28565b[_0x3c9ea7(0x1c5)]===null&&_0x28565b[_0x3c9ea7(0x308)]!==null&&_0x28565b['ratingAt']!==null;};exports[a558_0x4f05bc(0x2bc)]=verifyRating;const handleRating=async(_0x5457cc,_0x32acc9,_0x10695a)=>{const _0x28652d=a558_0x4f05bc,_0xc2deee=(0x0,socket_1[_0x28652d(0x2a8)])();let _0x1c7f76=null;(_0x5457cc?.[_0x28652d(0x1bc)]?.['conversation']||_0x5457cc?.['message']?.['extendedTextMessage'])&&(_0x1c7f76=parseInt(_0x5457cc[_0x28652d(0x1bc)][_0x28652d(0x206)]||_0x5457cc[_0x28652d(0x1bc)][_0x28652d(0x261)][_0x28652d(0x26b)],0xa)||null);if(!Number['isNaN'](_0x1c7f76)&&Number['isInteger'](_0x1c7f76)&&!(0x0,lodash_1[_0x28652d(0x2fb)])(_0x1c7f76)){const {complationMessage:_0x3c83b3}=await(0x0,ShowWhatsAppService_1[_0x28652d(0x289)])(_0x32acc9[_0x28652d(0x2c7)],_0x32acc9[_0x28652d(0x35b)]);let _0x4ad040=_0x1c7f76;_0x1c7f76<0x1&&(_0x4ad040=0x1);_0x1c7f76>0x5&&(_0x4ad040=0x5);await UserRating_1[_0x28652d(0x289)]['create']({'ticketId':_0x10695a[_0x28652d(0x205)],'companyId':_0x10695a['companyId'],'userId':_0x10695a['userId'],'rate':_0x4ad040});if(_0x3c83b3){if(completionMessageControl[_0x28652d(0x2ae)]>=0x9c4)completionMessageControl=[];var _0x1e0e8d=completionMessageControl[_0x28652d(0x2cb)](_0x3d093d=>_0x3d093d[_0x28652d(0x205)]===_0x32acc9['id']||_0x3d093d[_0x28652d(0x1ca)]===_0x32acc9[_0x28652d(0x32d)]['number']);if(!_0x1e0e8d||_0x1e0e8d&&_0x1e0e8d[_0x28652d(0x1a1)]+0x3e8*0x3c*0x1e<new Date()['getTime']()){_0x1e0e8d&&(completionMessageControl=completionMessageControl[_0x28652d(0x19b)](_0x3d1ab2=>_0x3d1ab2[_0x28652d(0x205)]!==_0x32acc9['id']),_0x1e0e8d=null);const _0x4da0c4=(0x0,Mustache_1['default'])('‎'+_0x3c83b3,_0x32acc9);await(0x0,SendPresenceStatus_1[_0x28652d(0x33d)])((0x0,wbot_1[_0x28652d(0x357)])(_0x32acc9['whatsappId']),_0x32acc9['contact'][_0x28652d(0x282)]+'@'+(_0x32acc9['isGroup']?_0x28652d(0x2a1):'s.whatsapp.net')),await(0x0,SendWhatsAppMessage_1[_0x28652d(0x289)])({'body':_0x4da0c4,'ticket':_0x32acc9});}!_0x1e0e8d&&completionMessageControl[_0x28652d(0x1d5)]({'ticketId':_0x32acc9['id'],'dest':_0x32acc9[_0x28652d(0x32d)][_0x28652d(0x282)],'time':new Date()['getTime']()});}await _0x10695a['update']({'finishedAt':(0x0,moment_1[_0x28652d(0x289)])()['toDate'](),'ratedAt':(0x0,moment_1[_0x28652d(0x289)])()['toDate'](),'rated':!![]}),await _0x32acc9[_0x28652d(0x1e7)]({'queueId':null,'chatbot':null,'queueOptionId':null,'userId':null,'status':'closed'}),_0xc2deee['to']('company-'+_0x32acc9[_0x28652d(0x35b)]+_0x28652d(0x1d4))[_0x28652d(0x2a3)]('company-'+_0x32acc9[_0x28652d(0x35b)]+_0x28652d(0x2d7),{'action':_0x28652d(0x31d),'ticket':_0x32acc9,'ticketId':_0x32acc9['id']}),_0xc2deee['to'](_0x28652d(0x1f6)+_0x32acc9[_0x28652d(0x35b)]+'-'+_0x32acc9[_0x28652d(0x346)])['to'](_0x32acc9['id'][_0x28652d(0x1d0)]())[_0x28652d(0x2a3)]('company-'+_0x32acc9[_0x28652d(0x35b)]+_0x28652d(0x2d7),{'action':'update','ticket':_0x32acc9,'ticketId':_0x32acc9['id']});}};function a558_0x429a(){const _0x875fe0=['test','update','verifyRecentCampaign','whisper-1','campaignQueue','constructor','Message','findAll','__importStar','sendMessageLink','../../models/Queue','remoteJid','PENDING','urlN8N','\x0a\x0a*[\x20#\x20]*\x20-\x20Voltar\x20ao\x20Menu\x20Principal',':unreads','company-','HH:mm','maxTokens','startTime','log','voice','public/company','3839DVsfkH','proto','parseToMilliseconds','selectedButtonId','messageQueue','72CrBdgt','Error\x20isValidMsg','options','ticketId','conversation','search','chmodSync','Mensagem\x20inválida\x208!\x20','path','setFfmpegPath','lodash','findOne','hydratedContentText','getOwnPropertyDescriptor','../../app','cacheLayer','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','getContactMessage','messages.upsert','choices','.mp3','247984BQNxTO','templateButtonReplyMessage','set','logger','READ','participant','validaCpfCnpj','Mensagem\x20inválida!','createdAt','join','\x20|\x20https://maps.google.com/maps?q=','18VsVFNf','DESC','prototype','isBefore','WebMessageInfo','Failed\x20to\x20fetch\x20contact\x20from\x20ticket:','4JxIwYi','prompt','downloadContentFromMessage','../../helpers/MakeRandomId','user','endLunchTime','getViewOnceMessage','input','queue','isGroup','contextInfo','vcard','endTime','queues','gte','reactionMessage','queueOptionId','public/temp/','pollCreationMessageV2','enabled','getQuotedMessage','title','./SendWhatsAppMessage','HandleMessageJob','EM_ANDAMENTO','sendGreetingMessageOneQueues','buttonsResponseMessage','status@broadcast','2721078mSXGAn','botText\x202','voiceRegion','DAUMZAP','data','directPath','Solicitação\x20de\x20Pagamento','complationMessage','../../models/UserRating','239719waaZNV','greetingMediaAttachment','temperature','Erro\x20ao\x20buscar\x20grupo!','keywords','../../utils/logger','error','../MessageServices/CreateMessageService','../../libs/socket','getBodyButton','stickerMessage','apply','value','\x0a*[\x20#\x20]*\x20-\x20Menu\x20inicial','verifyMessage','upsert','list','isValidMsg','Produto','documentWithCaptionMessage','extendedTextMessage','messages','speakTextAsync','closed','assistant','protocolMessage','REVOKE','listResponseMessage','Error\x20converting\x20file:\x20','sendMessage','text','debounce','toFormat','disableBot','./SendWhatsAppMedia','__setModuleDefault','findIndex','button','Mensagem\x20de\x20grupo\x20bloqueada!','./providers','writeFile','extension','Pedido','@g.us','##\x20if','stringify','816435HoFjqc','highlyStructuredMessage','trace','split','isAfter','getAudioMessage','CIPHERTEXT','number','save','unknown','mimetype','30430YIOVVf','chatbotAt','../../models/Ticket','default','../../helpers/Debounce','\x0a*[\x200\x20]*\x20-\x20Menu\x20anterior','Configuration','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','body','./wbotGetMessageFromType','locationMessage','mkdirSync','Error\x20handling\x20message\x20ack.\x20Err:\x20','Mensagem\x20editada\x20não\x20encontrada:\x20','parentId','POST','from','\x20-\x20Longitude:\x20','content','getTemplateMessage','maxUseBotQueues','queueId','createTranscription','createChatCompletion','getPaymentMessage','../WhatsappService/ShowWhatsAppService','removeNonPrintableChars','g.us','../../libs/cache','emit','(((.+)+)+)+$','values','getImageMessage','isArray','getIO','substring','SpeechSynthesizer','changed','findByPk','stream-throttle','length','Erro\x20ao\x20salvar\x20mensagem!','fromSubscription','%2C','fromMe','editedMessage','MessageUpdateJob','string','videoMessage','singleSelectReply','toDate','type','Expected\x20bodyMessage\x20to\x20be\x20a\x20string,\x20got:','Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','verifyRating','base64','body\x20is\x20not\x20a\x20string','verifyCampaignMessageAndCloseTicket','-appMessage','debug','botText','Erro\x20ao\x20salvar\x20avaliação!','randomValue','mediaName','replace','whatsappId','E2E_DEVICE_CHANGED','url','getTextMessage','find','handleRating','__createBinding','mediaType','Type','pending','getCallMessage','getViewOnceMessageV2','media','existsSync','terceiro\x20if','selectedId','-ticket','pipe','senderKeyDistributionMessage','CheckMsgIsGroup','data:image/png;base64,\x20','CHATBOT_RESTRICT_NUMBER','hydratedTemplate','fromAudioFileOutput','WAMessageStubType','Lista','ffmpeg-static','../../models/OldMessage','sleep','minutes','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!','captureException','botText\x203','mediaMessage','greetingMessage','Atualização\x20de\x20Status','useIntegration','warn','../../models/QueueOption','company','dataJson','reload','messageContextInfo','endsWith','catch','SERVER_ACK','getBodyMessage','texto','primeiro\x20if','mediaPath','isNull','Convite\x20Revogado','isNumeric','amountUsedBotQueues','create','Mensagem','then','system','../../libs/wbot','getTime','fourRowTemplate','buttonsMessage','\x20]*\x20-\x20','userId','map','externalAdReply','format','provider','count','slice','inActivity','env','defineProperty','Error\x20getting\x20message\x20body:','PLAYED','name','makeRandomId','audioMessage','segundo\x20if','option','MESSAGE_EDIT','E2E_IDENTITY_CHANGED','>>>>\x20erro\x20','DispatchCampaign','delete','verifyQuotedMessage','chatbot','../ContactServices/CreateOrUpdateContactService','resolve','getMessageOptions','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','get','next','caption','getDocumentMessage','add','__esModule','Mensagem\x20que\x20Desaparece','promisify','../TicketServices/FindOrCreateATicketTrakingService','contact','listMessage','Importando\x20mensagens!!','../QueueIntegrationServices/ShowQueueIntegrationService','updatedAt','now','Escolha\x20uma\x20opção','maxMessages','contacts:','advertising','SAIR','jidNormalizedUser','document','quotedMessage','ASC','mediaUrl','SendPresenceStatus','AudioConfig','degreesLatitude','pt-BR-FabioNeural','webhook','getButtonsMessage','subject','.wav','../../models/User','status','contactsArrayMessage','dddd','stanzaId','../TicketServices/FindOrCreateTicketService','groupMetadata','-closed','setExtra','head','gpt-3.5-turbo-1106','handleMsgAck','mp3','fluent-ffmpeg','../../models/Message','getStickerMessage','floor','includes','getWbot','application/json','documentMessage','Erro\x20para\x20responder\x20com\x20audio:\x20','companyId','close','hydratedFourRowTemplate','viewOnceMessageV2','contacts','pushName','application','Nas\x20respostas\x20utilize\x20o\x20nome\x20','forEach','ERR_WAPP_DOWNLOAD_MEDIA','subtract','integrationId','ack','selectedRowId','pollCreationMessageV3','filter','liveLocationMessage','keys','audio/mpeg','call','isNil','time','startLunchTime','messageStubType','productMessage','430479sWMAmu','quotedMsg','Erro\x20ao\x20deletar\x20o\x20arquivo:','getContentType','3570147brnQpU','s.whatsapp.net','handleMessage','getQuotedMessageId','readFileSync','__importDefault','getContactsArrayMessage','trim','../../helpers/SendPresenceStatus','../../helpers/Mustache','key','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','hydratedHsm','Failed\x20to\x20get\x20stream','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','interactiveMessage','getGroupInviteMessage','getReactionMessage','handleMessageIntegration','message','outOfHoursMessage','../../models/Contact','No\x20contact\x20found\x20for\x20this\x20ticket.','filename','charAt','Status','groups.update','*[\x20','finishedAt','isBetween','ProtocolMessage','chatbot\x20desativado!','ephemeralMessage','dest','messages.update','request','chatBotType','header','Múltiplos\x20Produtos','toString','SpeechConfig','fora\x20do\x20horario','Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior','-open','push','templateMessage','@whiskeysockets/baileys','promptId','OpenAIApi','min','toFixed','viewOnceMessage','DELIVERY_ACK','getVideoMessage','pop','reaction','imageMessage','toLowerCase','public','application/pdf','&z=17&hl=pt-BR|'];a558_0x429a=function(){return _0x875fe0;};return a558_0x429a();}exports[a558_0x4f05bc(0x2cc)]=handleRating;const handleChartbot=async(_0x3ba6ec,_0x16ccf6,_0x4897b4,_0x239318,_0xbbee34=![])=>{const _0x400e2e=a558_0x4f05bc;if(!_0x3ba6ec[_0x400e2e(0x32d)][_0x400e2e(0x26e)]){const _0x5db02a=await Queue_1[_0x400e2e(0x289)][_0x400e2e(0x2ac)](_0x3ba6ec['queueId'],{'include':[{'model':QueueOption_1[_0x400e2e(0x289)],'as':_0x400e2e(0x204),'where':{'parentId':null},'order':[[_0x400e2e(0x318),_0x400e2e(0x33b)],[_0x400e2e(0x21f),_0x400e2e(0x33b)]]}]}),_0x3135d8=_0x16ccf6?.[_0x400e2e(0x1bc)]?.[_0x400e2e(0x242)]?.['selectedButtonId']||_0x16ccf6?.['message']?.['listResponseMessage']?.[_0x400e2e(0x2b7)]?.[_0x400e2e(0x199)]||_0x16ccf6?.[_0x400e2e(0x1bc)]?.['extendedTextMessage']?.['text']||_0x16ccf6?.['message']?.['conversation'];if(_0x3135d8=='#'&&(!_0x3ba6ec[_0x400e2e(0x308)]||_0x3ba6ec[_0x400e2e(0x346)]==_0x400e2e(0x2d0))){console[_0x400e2e(0x27d)](_0x400e2e(0x279)),await _0x3ba6ec['update']({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x4897b4,_0x16ccf6,_0x3ba6ec,_0x3ba6ec[_0x400e2e(0x32d)]);return;}if(!(0x0,lodash_1[_0x400e2e(0x1a0)])(_0x5db02a)&&!(0x0,lodash_1[_0x400e2e(0x1a0)])(_0x3ba6ec[_0x400e2e(0x238)])&&_0x3135d8=='0'){console[_0x400e2e(0x27d)](_0x400e2e(0x2f9));const _0x4a276e=await QueueOption_1[_0x400e2e(0x289)][_0x400e2e(0x2ac)](_0x3ba6ec['queueOptionId']);await _0x3ba6ec[_0x400e2e(0x1e7)]({'queueOptionId':_0x4a276e?.[_0x400e2e(0x294)],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1['isNil'])(_0x5db02a)&&!(0x0,lodash_1[_0x400e2e(0x1a0)])(_0x3ba6ec[_0x400e2e(0x238)])){console[_0x400e2e(0x27d)](_0x400e2e(0x317));const _0x47fb13=await QueueOption_1['default'][_0x400e2e(0x30d)]({'where':{'parentId':_0x3ba6ec['queueOptionId']}});let _0x4c118f={};_0x47fb13==0x1?_0x4c118f=await QueueOption_1['default'][_0x400e2e(0x20d)]({'where':{'parentId':_0x3ba6ec[_0x400e2e(0x238)]}}):(console[_0x400e2e(0x27d)](_0x400e2e(0x2d5)),_0x4c118f=await QueueOption_1[_0x400e2e(0x289)][_0x400e2e(0x20d)]({'where':{[sequelize_1['Op']['or']]:[{'option':_0x3135d8||''},{'title':_0x3135d8||''}],'parentId':_0x3ba6ec[_0x400e2e(0x238)]}})),_0x4c118f&&await _0x3ba6ec[_0x400e2e(0x1e7)]({'queueOptionId':_0x4c118f?.['id'],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1[_0x400e2e(0x1a0)])(_0x5db02a)&&(0x0,lodash_1[_0x400e2e(0x1a0)])(_0x3ba6ec['queueOptionId'])&&!_0xbbee34){console['trace']('quarto\x20if');const _0x579478=_0x5db02a?.['options']['find'](_0x2e4a48=>_0x2e4a48[_0x400e2e(0x318)]==_0x3135d8||_0x2e4a48[_0x400e2e(0x23d)]['toLowerCase']()==_0x3135d8[_0x400e2e(0x1e2)]());if(_0x579478)await _0x3ba6ec[_0x400e2e(0x1e7)]({'queueOptionId':_0x579478?.['id'],'amountUsedBotQueues':0x0});else{if(_0x239318[_0x400e2e(0x29a)]&&_0x239318[_0x400e2e(0x29a)]!==0x0&&_0x3ba6ec[_0x400e2e(0x2fe)]>=_0x239318[_0x400e2e(0x29a)])return;await _0x3ba6ec[_0x400e2e(0x1e7)]({'amountUsedBotQueues':_0x3ba6ec[_0x400e2e(0x2fe)]+0x1});}}else{if(_0x239318['maxUseBotQueues']&&_0x239318['maxUseBotQueues']!==0x0&&_0x3ba6ec[_0x400e2e(0x2fe)]>=_0x239318['maxUseBotQueues'])return;await _0x3ba6ec[_0x400e2e(0x1e7)]({'amountUsedBotQueues':_0x3ba6ec[_0x400e2e(0x2fe)]+0x1});}}}await _0x3ba6ec[_0x400e2e(0x2f2)]();if(!(0x0,lodash_1[_0x400e2e(0x1a0)])(_0x5db02a)&&(0x0,lodash_1['isNil'])(_0x3ba6ec['queueOptionId'])){const _0x516555=await QueueOption_1[_0x400e2e(0x289)]['findAll']({'where':{'queueId':_0x3ba6ec[_0x400e2e(0x29b)],'parentId':null},'order':[[_0x400e2e(0x318),_0x400e2e(0x33b)],[_0x400e2e(0x21f),_0x400e2e(0x33b)]]}),_0x38700a=_0x3ba6ec[_0x400e2e(0x35b)],_0x391346=await Setting_1[_0x400e2e(0x289)]['findOne']({'where':{'key':'chatBotType','companyId':_0x38700a}}),_0x3d4d57=async()=>{const _0x2951ce=_0x400e2e,_0x159264=[];_0x516555[_0x2951ce(0x194)]((_0x20bfe8,_0x32b6d6)=>{const _0x2e7be4=_0x2951ce;_0x159264[_0x2e7be4(0x1d5)]({'buttonId':''+_0x20bfe8[_0x2e7be4(0x318)],'buttonText':{'displayText':_0x20bfe8[_0x2e7be4(0x23d)]},'type':0x4});}),_0x159264[_0x2951ce(0x1d5)]({'buttonId':'#','buttonText':{'displayText':_0x2951ce(0x1d3)},'type':0x4});const _0x26e94c={'text':(0x0,Mustache_1[_0x2951ce(0x289)])('‎'+_0x5db02a[_0x2951ce(0x2eb)],_0x3ba6ec),'buttons':_0x159264,'footer':_0x2951ce(0x247),'headerType':0x1},_0x9b3ade=await _0x4897b4[_0x2951ce(0x26a)](_0x3ba6ec[_0x2951ce(0x32d)][_0x2951ce(0x282)]+'@'+(_0x3ba6ec['isGroup']?_0x2951ce(0x2a1):_0x2951ce(0x1aa)),_0x26e94c);await(0x0,exports[_0x2951ce(0x25b)])(_0x9b3ade,_0x3ba6ec,_0x3ba6ec[_0x2951ce(0x32d)]);},_0x236716=async()=>{const _0x409cf5=_0x400e2e;let _0x28f8a3='';console['trace']('botText'),console[_0x409cf5(0x1fa)](_0x5db02a[_0x409cf5(0x2fa)]),_0x516555['forEach']((_0x27cd70,_0x530469)=>{const _0x2cd8dd=_0x409cf5;_0x28f8a3+='*[\x20'+_0x27cd70['option']+'\x20]*\x20-\x20'+_0x27cd70[_0x2cd8dd(0x23d)]+'\x0a';}),_0x28f8a3+=_0x409cf5(0x25a);const _0x54892c={'text':(0x0,Mustache_1['default'])('‎'+_0x5db02a[_0x409cf5(0x2eb)]+'\x0a\x0a'+_0x28f8a3,_0x3ba6ec)};let _0x396c9e;if(!_0x5db02a[_0x409cf5(0x2fa)])_0x396c9e=await _0x4897b4['sendMessage'](_0x3ba6ec[_0x409cf5(0x32d)][_0x409cf5(0x282)]+'@'+(_0x3ba6ec[_0x409cf5(0x231)]?_0x409cf5(0x2a1):_0x409cf5(0x1aa)),_0x54892c),await(0x0,exports['verifyMessage'])(_0x396c9e,_0x3ba6ec,_0x3ba6ec[_0x409cf5(0x32d)]);else{const _0x5b9653=path_1[_0x409cf5(0x289)][_0x409cf5(0x321)](_0x409cf5(0x1e3),'company'+_0x3ba6ec[_0x409cf5(0x35b)],_0x5db02a[_0x409cf5(0x2fa)]),_0x24687e=await(0x0,SendWhatsAppMedia_1[_0x409cf5(0x322)])(_0x54892c['text'],_0x5b9653,_0x54892c[_0x409cf5(0x26b)],_0x3ba6ec['companyId']);_0x396c9e=await _0x4897b4[_0x409cf5(0x26a)](_0x3ba6ec['contact']['number']+'@'+(_0x3ba6ec[_0x409cf5(0x231)]?_0x409cf5(0x2a1):'s.whatsapp.net'),{..._0x24687e}),await verifyMediaMessage(_0x396c9e,_0x3ba6ec,_0x3ba6ec[_0x409cf5(0x32d)]);}};if(_0x391346[_0x400e2e(0x259)]==='button'&&QueueOption_1['default']['length']<=0x4)return _0x3d4d57();if(_0x391346[_0x400e2e(0x259)]===_0x400e2e(0x26b))return console[_0x400e2e(0x27d)]('botText'),_0x236716();if(_0x391346[_0x400e2e(0x259)]===_0x400e2e(0x272)&&QueueOption_1[_0x400e2e(0x289)][_0x400e2e(0x2ae)]>0x4)return console['trace'](_0x400e2e(0x2c2)),_0x236716();}else{if(!(0x0,lodash_1['isNil'])(_0x5db02a)&&!(0x0,lodash_1[_0x400e2e(0x1a0)])(_0x3ba6ec['queueOptionId'])){const _0x52cccc=await QueueOption_1[_0x400e2e(0x289)][_0x400e2e(0x2ac)](_0x3ba6ec['queueOptionId']),_0x2d22e1=await QueueOption_1['default'][_0x400e2e(0x1ed)]({'where':{'parentId':_0x3ba6ec[_0x400e2e(0x238)]},'order':[[_0x400e2e(0x318),_0x400e2e(0x33b)],[_0x400e2e(0x21f),_0x400e2e(0x33b)]]});if(_0x2d22e1[_0x400e2e(0x2ae)]===0x0){const _0x28553a={'text':(0x0,Mustache_1[_0x400e2e(0x289)])('‎'+_0x52cccc[_0x400e2e(0x1bc)],_0x3ba6ec)},_0xbb8b8d=await _0x4897b4[_0x400e2e(0x26a)](_0x3ba6ec['contact']['number']+'@'+(_0x3ba6ec[_0x400e2e(0x231)]?_0x400e2e(0x2a1):'s.whatsapp.net'),_0x28553a);await(0x0,exports[_0x400e2e(0x25b)])(_0xbb8b8d,_0x3ba6ec,_0x3ba6ec[_0x400e2e(0x32d)]),await _0x3ba6ec[_0x400e2e(0x1e7)]({'queueOptionId':null,'chatbot':![]});return;}if(_0x2d22e1[_0x400e2e(0x2ae)]>-0x1){const _0x17629c=_0x3ba6ec[_0x400e2e(0x35b)],_0x59c296=await Setting_1[_0x400e2e(0x289)]['findOne']({'where':{'key':'chatBotType','companyId':_0x17629c}}),_0x14d4b0=async()=>{const _0x3052ac=_0x400e2e,_0x528528=[],_0x3196f7=_0x3ba6ec[_0x3052ac(0x35b)],_0x209658=await getQueues(_0x3196f7),_0x25038a=await getContactFromTicket(_0x3ba6ec['id']);_0x209658[_0x3052ac(0x194)]((_0x33adf3,_0x4b7f0b)=>{_0x528528['push']({'title':'['+(_0x4b7f0b+0x1)+']\x20-\x20'+_0x33adf3['name'],'rowId':''+(_0x4b7f0b+0x1)});});const _0x53acc0=[{'rows':_0x528528}],_0x3b8fa6={'text':(0x0,Mustache_1[_0x3052ac(0x289)])('‎'+_0x52cccc[_0x3052ac(0x1bc)],_0x3ba6ec),'title':_0x3052ac(0x2e0),'buttonText':_0x3052ac(0x333),'sections':_0x53acc0};await sleep(0x3e8);const _0x34ebdd=await _0x4897b4[_0x3052ac(0x26a)](_0x3052ac(0x212)+_0x25038a[_0x3052ac(0x282)]+'@'+(_0x3ba6ec[_0x3052ac(0x231)]?_0x3052ac(0x2a1):_0x3052ac(0x1aa)),_0x3b8fa6);await(0x0,exports[_0x3052ac(0x25b)])(_0x34ebdd,_0x3ba6ec,_0x3ba6ec[_0x3052ac(0x32d)]);},_0x468bc6=async()=>{const _0x427b61=_0x400e2e,_0x5cf80c=[];_0x2d22e1[_0x427b61(0x194)]((_0x49830c,_0x20df0b)=>{const _0x2cef7f=_0x427b61;_0x5cf80c[_0x2cef7f(0x1d5)]({'buttonId':''+_0x49830c['option'],'buttonText':{'displayText':_0x49830c[_0x2cef7f(0x23d)]},'type':0x4});}),_0x5cf80c[_0x427b61(0x1d5)]({'buttonId':'#','buttonText':{'displayText':_0x427b61(0x1d3)},'type':0x4});const _0x47c45e={'text':(0x0,Mustache_1[_0x427b61(0x289)])('‎'+_0x52cccc[_0x427b61(0x1bc)],_0x3ba6ec),'buttons':_0x5cf80c,'headerType':0x4};if(process[_0x427b61(0x310)][_0x427b61(0x2dc)]?.[_0x427b61(0x2ae)]>=0x8){if(_0x3ba6ec[_0x427b61(0x32d)][_0x427b61(0x282)]!=process[_0x427b61(0x310)][_0x427b61(0x2dc)]){console[_0x427b61(0x27d)](_0x427b61(0x1c8));return;}}if(!_0x52cccc[_0x427b61(0x2fa)]){const _0x5d7c66=await _0x4897b4['sendMessage'](_0x3ba6ec[_0x427b61(0x32d)][_0x427b61(0x282)]+'@'+(_0x3ba6ec[_0x427b61(0x231)]?_0x427b61(0x2a1):_0x427b61(0x1aa)),_0x47c45e);await(0x0,exports[_0x427b61(0x25b)])(_0x5d7c66,_0x3ba6ec,_0x3ba6ec[_0x427b61(0x32d)]);}else{const _0x36273=path_1[_0x427b61(0x289)][_0x427b61(0x321)](_0x427b61(0x1e3),'company'+_0x3ba6ec[_0x427b61(0x35b)],_0x52cccc[_0x427b61(0x2fa)]),_0x136a48=await(0x0,SendWhatsAppMedia_1[_0x427b61(0x322)])(_0x52cccc['mediaName'],_0x36273,_0x47c45e[_0x427b61(0x26b)],_0x3ba6ec[_0x427b61(0x35b)]);let _0x52f631=await _0x4897b4[_0x427b61(0x26a)](_0x3ba6ec[_0x427b61(0x32d)]['number']+'@'+(_0x3ba6ec[_0x427b61(0x231)]?_0x427b61(0x2a1):'s.whatsapp.net'),{..._0x136a48});await verifyMediaMessage(_0x52f631,_0x3ba6ec,_0x3ba6ec[_0x427b61(0x32d)]);}const _0x2db45d=await _0x4897b4[_0x427b61(0x26a)](_0x3ba6ec['contact'][_0x427b61(0x282)]+'@'+(_0x3ba6ec['isGroup']?_0x427b61(0x2a1):_0x427b61(0x1aa)),_0x47c45e);await(0x0,exports[_0x427b61(0x25b)])(_0x2db45d,_0x3ba6ec,_0x3ba6ec[_0x427b61(0x32d)]);},_0x3dd8d1=async()=>{const _0x65f34c=_0x400e2e;let _0x45e184='';_0x2d22e1[_0x65f34c(0x194)]((_0x60c589,_0xe4df2a)=>{const _0x2c4906=_0x65f34c;_0x45e184+=_0x2c4906(0x1c4)+_0x60c589['option']+_0x2c4906(0x307)+_0x60c589[_0x2c4906(0x23d)]+'\x0a';}),_0x45e184+=_0x65f34c(0x28b),_0x45e184+=_0x65f34c(0x25a);const _0x23fcf3={'text':(0x0,Mustache_1[_0x65f34c(0x289)])('‎'+_0x52cccc[_0x65f34c(0x1bc)]+'\x0a\x0a'+_0x45e184,_0x3ba6ec)};if(process[_0x65f34c(0x310)][_0x65f34c(0x2dc)]?.[_0x65f34c(0x2ae)]>=0x8){if(_0x3ba6ec[_0x65f34c(0x32d)]['number']!=process['env'][_0x65f34c(0x2dc)]){console['trace'](_0x65f34c(0x1c8));return;}}if(!_0x52cccc[_0x65f34c(0x2fa)]){const _0x3add86=await _0x4897b4[_0x65f34c(0x26a)](_0x3ba6ec[_0x65f34c(0x32d)][_0x65f34c(0x282)]+'@'+(_0x3ba6ec[_0x65f34c(0x231)]?_0x65f34c(0x2a1):'s.whatsapp.net'),_0x23fcf3);await(0x0,exports[_0x65f34c(0x25b)])(_0x3add86,_0x3ba6ec,_0x3ba6ec['contact']);}else{const _0x497511=path_1[_0x65f34c(0x289)][_0x65f34c(0x321)]('public',_0x65f34c(0x2f0)+_0x3ba6ec[_0x65f34c(0x35b)],_0x52cccc[_0x65f34c(0x2fa)]),_0xb51ccd=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x52cccc[_0x65f34c(0x2c5)],_0x497511,_0x23fcf3[_0x65f34c(0x26b)],_0x3ba6ec['companyId']);let _0x4e0219=await _0x4897b4[_0x65f34c(0x26a)](_0x3ba6ec[_0x65f34c(0x32d)]['number']+'@'+(_0x3ba6ec[_0x65f34c(0x231)]?_0x65f34c(0x2a1):'s.whatsapp.net'),{..._0xb51ccd});await verifyMediaMessage(_0x4e0219,_0x3ba6ec,_0x3ba6ec['contact']);}};if(_0x59c296[_0x400e2e(0x259)]===_0x400e2e(0x25d))return _0x14d4b0();if(_0x59c296[_0x400e2e(0x259)]===_0x400e2e(0x272)&&QueueOption_1[_0x400e2e(0x289)][_0x400e2e(0x2ae)]<=0x4)return _0x468bc6();if(_0x59c296['value']===_0x400e2e(0x26b))return console[_0x400e2e(0x27d)](_0x400e2e(0x2e9)),_0x3dd8d1();if(_0x59c296[_0x400e2e(0x259)]==='button'&&QueueOption_1[_0x400e2e(0x289)][_0x400e2e(0x2ae)]>0x4)return console['trace'](_0x400e2e(0x245)),_0x3dd8d1();}}}}},handleMessageIntegration=async(_0x164ad1,_0x20926e,_0x5d5dae,_0x1c9a35)=>{const _0xc0a64c=a558_0x4f05bc;if(process[_0xc0a64c(0x310)][_0xc0a64c(0x2dc)]){if(_0x1c9a35[_0xc0a64c(0x32d)][_0xc0a64c(0x282)]!=process[_0xc0a64c(0x310)][_0xc0a64c(0x2dc)]){console['log'](_0xc0a64c(0x1c8));return;}}const _0x153e5a=getTypeMessage(_0x164ad1);if(_0x5d5dae[_0xc0a64c(0x2b9)]==='n8n'||_0x5d5dae['type']===_0xc0a64c(0x341)){if(_0x5d5dae?.[_0xc0a64c(0x1f3)]){const _0x43efd0={'method':_0xc0a64c(0x295),'url':_0x5d5dae?.['urlN8N'],'headers':{'Content-Type':_0xc0a64c(0x358)},'json':_0x164ad1};try{(0x0,request_1['default'])(_0x43efd0,function(_0x3276b7,_0x24abb5){const _0x21b881=_0xc0a64c;if(_0x3276b7)throw new Error(_0x3276b7);else console[_0x21b881(0x1fa)](_0x24abb5[_0x21b881(0x28e)]);});}catch(_0xe485b7){throw new Error(_0xe485b7);}}}else _0x5d5dae[_0xc0a64c(0x2b9)]==='typebot'&&await(0x0,typebotListener_1[_0xc0a64c(0x289)])({'ticket':_0x1c9a35,'msg':_0x164ad1,'wbot':_0x20926e,'typebot':_0x5d5dae});};exports[a558_0x4f05bc(0x1bb)]=handleMessageIntegration;const messageContainsMedia=_0x2cecd8=>{const _0x48c1a5=a558_0x4f05bc;return _0x2cecd8['message']?.[_0x48c1a5(0x1e1)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x316)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.['videoMessage']||_0x2cecd8[_0x48c1a5(0x1bc)]?.['stickerMessage']||_0x2cecd8[_0x48c1a5(0x1bc)]?.['documentMessage']||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x260)]?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x359)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1c9)]?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x316)]||_0x2cecd8['message']?.[_0x48c1a5(0x1c9)]?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x359)]||_0x2cecd8['message']?.[_0x48c1a5(0x1c9)]?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x2b6)]||_0x2cecd8['message']?.['ephemeralMessage']?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x257)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1c9)]?.[_0x48c1a5(0x1bc)]?.['imageMessage']||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1dc)]?.['message']?.[_0x48c1a5(0x1e1)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1dc)]?.['message']?.['videoMessage']||_0x2cecd8['message']?.[_0x48c1a5(0x1c9)]?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1dc)]?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1e1)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1c9)]?.['message']?.['viewOnceMessage']?.['message']?.[_0x48c1a5(0x2b6)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.['ephemeralMessage']?.['message']?.['viewOnceMessage']?.['message']?.[_0x48c1a5(0x316)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1c9)]?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1dc)]?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x359)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x260)]?.[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x359)]||_0x2cecd8['message']?.[_0x48c1a5(0x1d6)]?.[_0x48c1a5(0x2dd)]?.[_0x48c1a5(0x1e1)]||_0x2cecd8['message']?.[_0x48c1a5(0x1d6)]?.['hydratedTemplate']?.['documentMessage']||_0x2cecd8['message']?.[_0x48c1a5(0x1d6)]?.['hydratedTemplate']?.['videoMessage']||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1d6)]?.[_0x48c1a5(0x35d)]?.[_0x48c1a5(0x1e1)]||_0x2cecd8['message']?.[_0x48c1a5(0x1d6)]?.[_0x48c1a5(0x35d)]?.[_0x48c1a5(0x359)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1d6)]?.[_0x48c1a5(0x35d)]?.['videoMessage']||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1d6)]?.[_0x48c1a5(0x305)]?.[_0x48c1a5(0x1e1)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1d6)]?.[_0x48c1a5(0x305)]?.[_0x48c1a5(0x359)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.['templateMessage']?.[_0x48c1a5(0x305)]?.['videoMessage']||_0x2cecd8[_0x48c1a5(0x1bc)]?.['interactiveMessage']?.[_0x48c1a5(0x1ce)]?.[_0x48c1a5(0x1e1)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x1b8)]?.['header']?.[_0x48c1a5(0x359)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.['interactiveMessage']?.[_0x48c1a5(0x1ce)]?.[_0x48c1a5(0x2b6)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.[_0x48c1a5(0x27c)]?.[_0x48c1a5(0x1b5)]?.[_0x48c1a5(0x2dd)]?.[_0x48c1a5(0x359)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.['highlyStructuredMessage']?.[_0x48c1a5(0x1b5)]?.['hydratedTemplate']?.[_0x48c1a5(0x2b6)]||_0x2cecd8[_0x48c1a5(0x1bc)]?.['highlyStructuredMessage']?.[_0x48c1a5(0x1b5)]?.[_0x48c1a5(0x2dd)]?.['imageMessage']||_0x2cecd8[_0x48c1a5(0x1bc)]?.['highlyStructuredMessage']?.['hydratedHsm']?.[_0x48c1a5(0x2dd)]?.['locationMessage'];},handleMessage=async(_0xbef947,_0x1ffb17,_0x408f65,_0x241097=![])=>{const _0x28e45d=a558_0x4f05bc;if(_0x241097){console[_0x28e45d(0x1fa)](_0x28e45d(0x32f));let _0x114ef3=_0xbef947['key']['id'],_0xb512=await Message_1[_0x28e45d(0x289)]['count']({'where':{'id':_0x114ef3}});if(_0xb512>0x0){await new Promise(_0x248678=>setTimeout(_0x248678,0x96));return;}else await new Promise(_0x17fc1f=>setTimeout(_0x17fc1f,0x14a));}let _0xcb7183;if(!(0x0,exports[_0x28e45d(0x25e)])(_0xbef947)){console[_0x28e45d(0x1fa)](_0x28e45d(0x21e)),console[_0x28e45d(0x1fa)](_0xbef947);return;}_0xbef947['message']?.[_0x28e45d(0x1c9)]&&(_0xbef947[_0x28e45d(0x1bc)]=_0xbef947['message'][_0x28e45d(0x1c9)][_0x28e45d(0x1bc)]);try{let _0x48f6c1;const _0x1d79fd=_0xbef947[_0x28e45d(0x1b3)]['remoteJid']?.[_0x28e45d(0x2f4)](_0x28e45d(0x278)),_0x543bf9=await Setting_1['default'][_0x28e45d(0x20d)]({'where':{'companyId':_0x408f65,'key':_0x28e45d(0x2da)}});if(_0x543bf9?.[_0x28e45d(0x259)]===_0x28e45d(0x23b)&&_0x1d79fd){console[_0x28e45d(0x1fa)](_0x28e45d(0x273));return;}let _0x15a2f4=(0x0,exports[_0x28e45d(0x2f7)])(_0xbef947);const _0x2729ad=getTypeMessage(_0xbef947);typeof _0x15a2f4==='string'&&(_0x15a2f4=_0x15a2f4[_0x28e45d(0x2c6)](/\u200c/,''));const _0xe6d039=messageContainsMedia(_0xbef947);if(_0xbef947[_0x28e45d(0x1b3)][_0x28e45d(0x2b2)]){if(!_0xe6d039&&_0x2729ad!==_0x28e45d(0x206)&&_0x2729ad!==_0x28e45d(0x261)&&_0x2729ad!==_0x28e45d(0x233)&&_0x2729ad!=='contactMessage'&&_0x2729ad!=='ephemeralMessage'&&_0x2729ad!==_0x28e45d(0x266)&&_0x2729ad!==_0x28e45d(0x237)&&_0x2729ad!==_0x28e45d(0x1dc)&&_0x2729ad!==_0x28e45d(0x290)&&_0x2729ad!==_0x28e45d(0x20e)&&_0x2729ad!=='advertising'){console[_0x28e45d(0x27d)](_0x2729ad);return;}}const _0x7e7058=await(0x0,ShowWhatsAppService_1['default'])(_0x1ffb17['id'],_0x408f65);let _0x246fcd,_0x34e317=await getContactMessage(_0xbef947,_0x1ffb17);_0x48f6c1=await verifyContact(_0x34e317,_0x1ffb17,_0x408f65);if(_0x1d79fd){if(!_0x7e7058['allowGroup'])return;try{const _0x254d3a=await _0x1ffb17[_0x28e45d(0x34b)](_0xbef947[_0x28e45d(0x1b3)][_0x28e45d(0x1f1)]),_0x49a7b8={'id':_0x254d3a['id'],'name':_0x254d3a[_0x28e45d(0x343)]};_0x246fcd=await verifyContact(_0x49a7b8,_0x1ffb17,_0x408f65);}catch(_0x51b10b){console[_0x28e45d(0x1fa)](_0x28e45d(0x250)),console['log'](_0x51b10b);return;}}let _0x4f6f33=0x0;if(_0xbef947['key'][_0x28e45d(0x2b2)])await cache_1[_0x28e45d(0x211)][_0x28e45d(0x219)](_0x28e45d(0x335)+_0x48f6c1['id']+_0x28e45d(0x1f5),'0');else{const _0x400e6b=await cache_1[_0x28e45d(0x211)]['get']('contacts:'+_0x48f6c1['id']+_0x28e45d(0x1f5));_0x4f6f33=+_0x400e6b+0x1,await cache_1[_0x28e45d(0x211)][_0x28e45d(0x219)](_0x28e45d(0x335)+_0x48f6c1['id']+_0x28e45d(0x1f5),''+_0x4f6f33);}const _0xb54d5c=await(0x0,FindOrCreateTicketService_1[_0x28e45d(0x289)])(_0x48f6c1,_0x1ffb17['id'],_0x4f6f33,_0x408f65,_0x246fcd,_0x241097),_0x51df5d=await(0x0,FindOrCreateATicketTrakingService_1[_0x28e45d(0x289)])({'ticketId':_0xb54d5c['id'],'companyId':_0x408f65,'whatsappId':_0x7e7058?.['id']});_0x51df5d[_0x28e45d(0x2ab)](_0x28e45d(0x331),!![]),await _0x51df5d[_0x28e45d(0x1e7)]({'updatedAt':new Date()}),await(0x0,providers_1[_0x28e45d(0x30c)])(_0xb54d5c,_0xbef947,_0x408f65,_0x48f6c1,_0x1ffb17);if(_0x7e7058[_0x28e45d(0x24b)]&&_0x4f6f33===0x0){const _0x56a41d=await Message_1[_0x28e45d(0x289)][_0x28e45d(0x20d)]({'where':{'contactId':_0x48f6c1['id'],'companyId':_0x408f65},'order':[[_0x28e45d(0x21f),_0x28e45d(0x223)]]});if((0x0,Mustache_1['default'])(_0x7e7058[_0x28e45d(0x24b)],_0xb54d5c)[_0x28e45d(0x1b0)]()[_0x28e45d(0x1e2)]()===_0x56a41d?.[_0x28e45d(0x28e)][_0x28e45d(0x1b0)]()['toLowerCase']())return;}if(_0x15a2f4=='#'&&!_0x241097&&(!_0xb54d5c[_0x28e45d(0x308)]||_0xb54d5c[_0x28e45d(0x346)]=='pending')){await _0xb54d5c[_0x28e45d(0x1e7)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x1ffb17,_0xbef947,_0xb54d5c,_0xb54d5c[_0x28e45d(0x32d)]);return;}try{if(!_0xbef947[_0x28e45d(0x1b3)]['fromMe']&&!_0x241097){if(_0x15a2f4!=null&&typeof _0x15a2f4!==_0x28e45d(0x2b5)){console['log'](_0x15a2f4),console[_0x28e45d(0x27d)](_0x28e45d(0x2ba),typeof _0x15a2f4);return;}if(_0x15a2f4?.['toUpperCase']()===_0x28e45d(0x337)&&_0xb54d5c[_0x28e45d(0x346)]!='closed'){await(0x0,SendPresenceStatus_1[_0x28e45d(0x33d)])(_0x1ffb17,_0xb54d5c[_0x28e45d(0x32d)]['number']+'@'+(_0xb54d5c[_0x28e45d(0x231)]?'g.us':_0x28e45d(0x1aa)));const _0x246d7e=await _0x1ffb17[_0x28e45d(0x26a)](_0xb54d5c[_0x28e45d(0x32d)][_0x28e45d(0x282)]+'@'+(_0xb54d5c[_0x28e45d(0x231)]?_0x28e45d(0x2a1):'s.whatsapp.net'),{'text':'*Você\x20encerrou\x20este\x20atendimento\x20usando\x20o\x20comando\x20SAIR*.\x0a\x0a\x0aSe\x20você\x20finalizou\x20o\x20atendimento\x20*ANTES*\x20de\x20receber\x20um\x20retorno\x20do\x20operador,\x20ele\x20*NÃO*\x20irá\x20visualizar\x20sua\x20solicitação!\x0a\x0aVocê\x20deve\x20aguardar\x20o\x20retorno\x20do\x20operador\x20e\x20que\x20ele\x20encerre\x20seu\x20atendimento\x20quando\x20necessário.\x0a\x0aUse\x20a\x20opção\x20*SAIR*\x20somente\x20em\x20casos\x20de\x20emergência\x20ou\x20se\x20ficou\x20preso\x20em\x20algum\x20setor.\x0a\x0a\x0aPara\x20iniciar\x20um\x20novo\x20atendimento\x20basta\x20enviar\x20uma\x20nova\x20mensagem!'});await(0x0,exports[_0x28e45d(0x25b)])(_0x246d7e,_0xb54d5c,_0xb54d5c[_0x28e45d(0x32d)]),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':null,'status':_0x28e45d(0x264)},'ticketId':_0xb54d5c['id'],'companyId':_0xb54d5c[_0x28e45d(0x35b)]}),await _0xb54d5c[_0x28e45d(0x2f2)]();return;}}}catch(_0x742cfd){console['log'](_0x28e45d(0x2af)),console['log'](_0x742cfd),Sentry['captureException'](_0x742cfd);}try{await _0xb54d5c[_0x28e45d(0x1e7)]({'fromMe':_0xbef947[_0x28e45d(0x1b3)]['fromMe']});}catch(_0x1b6d08){console[_0x28e45d(0x1fa)]('Erro\x20ao\x20salvar\x20ticket!'),console[_0x28e45d(0x1fa)](_0x1b6d08),Sentry[_0x28e45d(0x2e8)](_0x1b6d08);}try{if(!_0xbef947[_0x28e45d(0x1b3)][_0x28e45d(0x2b2)]){if((0x0,exports[_0x28e45d(0x2bc)])(_0x51df5d)){await(0x0,exports[_0x28e45d(0x2cc)])(_0xbef947,_0xb54d5c,_0x51df5d),console['log'](_0x28e45d(0x209)+_0xbef947);return;}}}catch(_0x507c35){console[_0x28e45d(0x1fa)](_0x28e45d(0x2c3)),Sentry['captureException'](_0x507c35),console[_0x28e45d(0x1fa)](_0x507c35);}_0xe6d039?_0xcb7183=await verifyMediaMessage(_0xbef947,_0xb54d5c,_0x48f6c1):await(0x0,exports[_0x28e45d(0x25b)])(_0xbef947,_0xb54d5c,_0x48f6c1);const _0x535183=await(0x0,VerifyCurrentSchedule_1[_0x28e45d(0x289)])(_0x408f65),_0x4e44d3=await Setting_1['default'][_0x28e45d(0x20d)]({'where':{'companyId':_0x408f65,'key':'scheduleType'}});if(!_0xbef947[_0x28e45d(0x1b3)][_0x28e45d(0x2b2)]&&_0x4e44d3&&!_0x241097)await handleOutOfHour(_0x1ffb17,_0xb54d5c,_0x4e44d3,_0x48f6c1,_0x535183,_0x7e7058);!_0xb54d5c[_0x28e45d(0x230)]&&!_0x1d79fd&&!_0xbef947[_0x28e45d(0x1b3)]['fromMe']&&!_0xb54d5c['userId']&&!(0x0,lodash_1[_0x28e45d(0x1a0)])(_0x7e7058['promptId'])&&!_0x241097&&await handleOpenAi(_0xbef947,_0x1ffb17,_0xb54d5c,_0x48f6c1,_0xcb7183);if(!_0xbef947[_0x28e45d(0x1b3)][_0x28e45d(0x2b2)]&&!_0xb54d5c['isGroup']&&!_0xb54d5c['queue']&&!_0xb54d5c[_0x28e45d(0x22c)]&&_0xb54d5c[_0x28e45d(0x31f)]&&!(0x0,lodash_1[_0x28e45d(0x1a0)])(_0x7e7058[_0x28e45d(0x197)])&&!_0xb54d5c['useIntegration']&&!_0x241097){const _0x40fa6e=await(0x0,ShowQueueIntegrationService_1[_0x28e45d(0x289)])(_0x7e7058[_0x28e45d(0x197)],_0x408f65);await(0x0,exports[_0x28e45d(0x1bb)])(_0xbef947,_0x1ffb17,_0x40fa6e,_0xb54d5c);return;}!_0x1d79fd&&!_0xbef947[_0x28e45d(0x1b3)]['fromMe']&&!_0xb54d5c[_0x28e45d(0x308)]&&!(0x0,lodash_1['isNil'])(_0xb54d5c[_0x28e45d(0x1d8)])&&_0xb54d5c[_0x28e45d(0x2ed)]&&!_0x241097&&await handleOpenAi(_0xbef947,_0x1ffb17,_0xb54d5c,_0x48f6c1,_0xcb7183);if(!_0xbef947[_0x28e45d(0x1b3)][_0x28e45d(0x2b2)]&&!_0xb54d5c['isGroup']&&!_0xb54d5c[_0x28e45d(0x308)]&&_0xb54d5c[_0x28e45d(0x197)]&&_0xb54d5c[_0x28e45d(0x2ed)]&&!_0x241097){const _0x3ea149=await(0x0,ShowQueueIntegrationService_1[_0x28e45d(0x289)])(_0xb54d5c[_0x28e45d(0x197)],_0x408f65);await(0x0,exports[_0x28e45d(0x1bb)])(_0xbef947,_0x1ffb17,_0x3ea149,_0xb54d5c);}!_0xb54d5c['queue']&&!_0xb54d5c[_0x28e45d(0x231)]&&!_0xbef947['key'][_0x28e45d(0x2b2)]&&!_0xb54d5c[_0x28e45d(0x308)]&&_0x7e7058['queues'][_0x28e45d(0x2ae)]>=0x1&&!_0xb54d5c[_0x28e45d(0x2ed)]&&!_0x241097&&(await verifyQueue(_0x1ffb17,_0xbef947,_0xb54d5c,_0x48f6c1),_0x51df5d[_0x28e45d(0x2ab)]('chatbotAt',!![]),_0x51df5d[_0x28e45d(0x2ab)]('updatedAt',!![]),await _0x51df5d[_0x28e45d(0x1e7)]({'chatbotAt':(0x0,moment_1[_0x28e45d(0x289)])()[_0x28e45d(0x2b8)](),'updatedAt':new Date()}));const _0x2fad89=_0xb54d5c[_0x28e45d(0x230)]===null;await _0xb54d5c[_0x28e45d(0x2f2)]();if(!_0x241097&&_0x7e7058[_0x28e45d(0x2eb)])await greetingMessage(_0x1ffb17,_0xb54d5c,_0xbef947,_0x7e7058,_0x1d79fd);_0x7e7058[_0x28e45d(0x235)]['length']==0x1&&_0xb54d5c[_0x28e45d(0x230)]&&!_0x241097&&(_0xb54d5c['chatbot']&&!_0xbef947[_0x28e45d(0x1b3)][_0x28e45d(0x2b2)]&&!_0xb54d5c['userId']&&await handleChartbot(_0xb54d5c,_0xbef947,_0x1ffb17,_0x7e7058)),_0x7e7058[_0x28e45d(0x235)]['length']>0x1&&_0xb54d5c[_0x28e45d(0x230)]&&!_0x241097&&(_0xb54d5c[_0x28e45d(0x31f)]&&!_0xbef947[_0x28e45d(0x1b3)][_0x28e45d(0x2b2)]&&!_0xb54d5c[_0x28e45d(0x308)]&&await handleChartbot(_0xb54d5c,_0xbef947,_0x1ffb17,_0x7e7058,_0x2fad89));}catch(_0x5ac8aa){console[_0x28e45d(0x1fa)](_0x5ac8aa),Sentry['captureException'](_0x5ac8aa),logger_1[_0x28e45d(0x21a)][_0x28e45d(0x253)](_0x28e45d(0x1b4)+_0x5ac8aa);}};exports[a558_0x4f05bc(0x1ab)]=handleMessage;const handleOutOfHour=async(_0x32af7f,_0x5da164,_0x524fbb,_0x117714,_0x10610b,_0x280256)=>{const _0x49a501=a558_0x4f05bc;try{if(outOfHourMessageControl['length']>0x1388)outOfHourMessageControl=[];let _0x51352f=outOfHourMessageControl[_0x49a501(0x2cb)](_0x33f05b=>_0x33f05b['ticketId']===_0x5da164['id']||_0x33f05b[_0x49a501(0x1ca)]===_0x117714[_0x49a501(0x282)]);if(_0x524fbb['value']==='company'&&!(0x0,lodash_1[_0x49a501(0x1a0)])(_0x10610b)&&_0x280256[_0x49a501(0x1bd)]&&(!_0x10610b||_0x10610b[_0x49a501(0x30f)]===![])){if(!_0x51352f||_0x51352f&&_0x51352f[_0x49a501(0x1a1)]+0x3e8*0x3c*0x5<new Date()[_0x49a501(0x304)]()){_0x51352f&&(outOfHourMessageControl=outOfHourMessageControl[_0x49a501(0x19b)](_0x372944=>_0x372944[_0x49a501(0x205)]!==_0x5da164['id']),_0x51352f=null);if(!_0x51352f)outOfHourMessageControl['push']({'ticketId':_0x5da164['id'],'dest':_0x117714[_0x49a501(0x282)],'time':new Date()['getTime']()});const _0x4b6227='‎\x20'+_0x280256['outOfHoursMessage'],_0x4edc9e=(0x0,Debounce_1[_0x49a501(0x26c)])(async()=>{const _0x42fba2=_0x49a501;await _0x32af7f[_0x42fba2(0x26a)](_0x5da164['contact'][_0x42fba2(0x282)]+'@'+(_0x5da164[_0x42fba2(0x231)]?_0x42fba2(0x2a1):_0x42fba2(0x1aa)),{'text':_0x4b6227});},(0x0,queues_1[_0x49a501(0x2c4)])(0x5dc,0xdac),_0x5da164['id']);_0x4edc9e();return;}}if(_0x524fbb['value']==='queue'&&_0x5da164[_0x49a501(0x29b)]!==null){const _0x1f3046=await Queue_1['default']['findByPk'](_0x5da164[_0x49a501(0x29b)]),{schedules:_0x46d0d6}=_0x1f3046,_0x3018f2=(0x0,moment_1[_0x49a501(0x289)])(),_0x3b32fd=_0x3018f2['format']('dddd')['toLowerCase']();let _0x2c574f=null;Array[_0x49a501(0x2a7)](_0x46d0d6)&&_0x46d0d6['length']>0x0&&(_0x2c574f=_0x46d0d6[_0x49a501(0x2cb)](_0x29813f=>_0x29813f['weekdayEn']===_0x3b32fd&&_0x29813f['startTime']!==''&&_0x29813f['startTime']!==null&&_0x29813f[_0x49a501(0x234)]!==''&&_0x29813f[_0x49a501(0x234)]!==null));if(_0x524fbb[_0x49a501(0x259)]===_0x49a501(0x230)&&_0x1f3046[_0x49a501(0x1bd)]!==null&&_0x1f3046[_0x49a501(0x1bd)]!==''&&!(0x0,lodash_1[_0x49a501(0x1a0)])(_0x2c574f)){const _0x266b05=(0x0,moment_1[_0x49a501(0x289)])(_0x2c574f[_0x49a501(0x1f9)],_0x49a501(0x1f7)),_0x5df5ae=(0x0,moment_1[_0x49a501(0x289)])(_0x2c574f['endTime'],_0x49a501(0x1f7));let _0x47f79a=_0x3018f2[_0x49a501(0x225)](_0x266b05)||_0x3018f2[_0x49a501(0x27f)](_0x5df5ae);if(!_0x47f79a){if(_0x2c574f[_0x49a501(0x1a2)]&&_0x2c574f[_0x49a501(0x22d)]){const _0x1426da=(0x0,moment_1['default'])(_0x2c574f[_0x49a501(0x1a2)],_0x49a501(0x1f7)),_0x447035=(0x0,moment_1['default'])(_0x2c574f[_0x49a501(0x22d)],_0x49a501(0x1f7));_0x47f79a=_0x3018f2[_0x49a501(0x1c6)](_0x1426da,_0x447035);}}if(_0x47f79a){if(!_0x51352f||_0x51352f&&_0x51352f['time']+0x3e8*0x3c*0x1e<new Date()[_0x49a501(0x304)]()){const _0x5d7076=_0x1f3046[_0x49a501(0x1bd)],_0x437382=(0x0,Debounce_1[_0x49a501(0x26c)])(async()=>{const _0x1fa921=_0x49a501;await _0x32af7f[_0x1fa921(0x26a)](_0x5da164['contact']['number']+'@'+(_0x5da164[_0x1fa921(0x231)]?_0x1fa921(0x2a1):_0x1fa921(0x1aa)),{'text':_0x5d7076});},(0x0,queues_1['randomValue'])(0x3e8,0xbb8),_0x5da164['id']);_0x437382();return;}if(!_0x51352f)outOfHourMessageControl[_0x49a501(0x1d5)]({'ticketId':_0x5da164['id'],'dest':_0x117714['number'],'time':new Date()[_0x49a501(0x304)]()});}}}}catch(_0x20aaca){Sentry[_0x49a501(0x2e8)](_0x20aaca),console[_0x49a501(0x1fa)](_0x20aaca);}},greetingMessage=async(_0x292160,_0x1049dd,_0x4eefca,_0x1ae23b,_0x22a4df)=>{const _0x5c46e3=a558_0x4f05bc;if(!_0x1ae23b?.['queues']?.['length']&&!_0x1049dd[_0x5c46e3(0x308)]&&!_0x22a4df&&!_0x4eefca[_0x5c46e3(0x1b3)]['fromMe']){if(process[_0x5c46e3(0x310)]['CHATBOT_RESTRICT_NUMBER']?.[_0x5c46e3(0x2ae)]>=0x8){if(_0x1049dd[_0x5c46e3(0x32d)]['number']!=process[_0x5c46e3(0x310)]['CHATBOT_RESTRICT_NUMBER'])return;}if(greetingMessageControl[_0x5c46e3(0x2ae)]>0x1388)greetingMessageControl=[];var _0x132c5b=greetingMessageControl[_0x5c46e3(0x2cb)](_0x19b167=>_0x19b167[_0x5c46e3(0x205)]===_0x1049dd['id']||_0x19b167[_0x5c46e3(0x1ca)]===_0x1049dd['contact'][_0x5c46e3(0x282)]);if(_0x132c5b&&_0x132c5b[_0x5c46e3(0x1a1)]+0x3e8*0x3c*0x5>=new Date()['getTime']())return;const _0x5e0506=await Message_1['default']['findOne']({'where':{'ticketId':_0x1049dd['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x5c46e3(0x236)]]:(0x0,moment_1[_0x5c46e3(0x289)])()[_0x5c46e3(0x196)](0x5,_0x5c46e3(0x2e4))[_0x5c46e3(0x2b8)]()}}});if(_0x5e0506)return;const _0x218738=(0x0,Debounce_1['debounce'])(async()=>{const _0x46bd52=_0x5c46e3;if(!_0x1ae23b['greetingMediaAttachment'])await _0x292160['sendMessage'](_0x1049dd[_0x46bd52(0x32d)][_0x46bd52(0x282)]+'@'+(_0x1049dd[_0x46bd52(0x231)]?_0x46bd52(0x2a1):'s.whatsapp.net'),{'text':(0x0,Mustache_1[_0x46bd52(0x289)])(_0x1ae23b[_0x46bd52(0x2eb)],_0x1049dd)});else{const _0x3e4efa=path_1[_0x46bd52(0x289)][_0x46bd52(0x321)](_0x46bd52(0x1e3),_0x46bd52(0x2f0)+_0x1049dd['companyId'],_0x1ae23b[_0x46bd52(0x24e)]),_0x159f70=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x1ae23b[_0x46bd52(0x24e)],_0x3e4efa,_0x1ae23b[_0x46bd52(0x2eb)],_0x1049dd[_0x46bd52(0x35b)]);await _0x292160[_0x46bd52(0x26a)](_0x1049dd[_0x46bd52(0x32d)][_0x46bd52(0x282)]+'@'+(_0x1049dd[_0x46bd52(0x231)]?_0x46bd52(0x2a1):_0x46bd52(0x1aa)),{..._0x159f70});}},0x3e8,_0x1049dd['id']);_0x218738();return;}},handleMsgAck=async(_0x5c06a2,_0x36d7ac)=>{const _0x32f3a8=a558_0x4f05bc,_0x31a53e=(0x0,socket_1[_0x32f3a8(0x2a8)])();try{const _0x48b28f=await Message_1[_0x32f3a8(0x289)]['findByPk'](_0x5c06a2[_0x32f3a8(0x1b3)]['id'],{'include':[_0x32f3a8(0x32d),{'model':Message_1[_0x32f3a8(0x289)],'as':_0x32f3a8(0x1a6),'include':[_0x32f3a8(0x32d)]}]});if(!_0x48b28f){console[_0x32f3a8(0x1fa)](_0x5c06a2),console['log']('Mensagem\x20não\x20encontrada!');return;}await _0x48b28f[_0x32f3a8(0x1e7)]({'ack':_0x36d7ac}),_0x31a53e['to'](_0x48b28f[_0x32f3a8(0x205)][_0x32f3a8(0x1d0)]())[_0x32f3a8(0x2a3)](_0x32f3a8(0x1f6)+_0x48b28f['companyId']+_0x32f3a8(0x2c0),{'action':_0x32f3a8(0x1e7),'message':_0x48b28f});}catch(_0x545bfd){Sentry[_0x32f3a8(0x2e8)](_0x545bfd),logger_1[_0x32f3a8(0x21a)][_0x32f3a8(0x253)](_0x32f3a8(0x292)+_0x545bfd);}};exports['handleMsgAck']=handleMsgAck;const verifyRecentCampaign=async(_0x1a119e,_0x5530ac)=>{const _0x1b3ff1=a558_0x4f05bc;if(!_0x1a119e[_0x1b3ff1(0x1b3)][_0x1b3ff1(0x2b2)]){const _0xa9d61f=_0x1a119e[_0x1b3ff1(0x1b3)]['remoteJid']['replace'](/\D/g,''),_0x2f878b=await Campaign_1[_0x1b3ff1(0x289)][_0x1b3ff1(0x1ed)]({'where':{'companyId':_0x5530ac,'status':_0x1b3ff1(0x240),'confirmation':!![]}});if(_0x2f878b){const _0x1af7cb=_0x2f878b[_0x1b3ff1(0x309)](_0x22b89d=>_0x22b89d['id']),_0x9debb3=await CampaignShipping_1[_0x1b3ff1(0x289)][_0x1b3ff1(0x20d)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x1af7cb},'number':_0xa9d61f,'confirmation':null}});_0x9debb3&&(await _0x9debb3[_0x1b3ff1(0x1e7)]({'confirmedAt':(0x0,moment_1[_0x1b3ff1(0x289)])(),'confirmation':!![]}),await queues_1[_0x1b3ff1(0x1ea)][_0x1b3ff1(0x328)](_0x1b3ff1(0x31c),{'campaignShippingId':_0x9debb3['id'],'campaignId':_0x9debb3['campaignId']},{'delay':(0x0,queues_1[_0x1b3ff1(0x1ff)])((0x0,queues_1[_0x1b3ff1(0x2c4)])(0x0,0xa))}));}}};exports[a558_0x4f05bc(0x1e8)]=verifyRecentCampaign;const verifyCampaignMessageAndCloseTicket=async(_0x4e5eb7,_0x20cbf3)=>{const _0x3d91fe=a558_0x4f05bc,_0x224598=(0x0,socket_1[_0x3d91fe(0x2a8)])(),_0x590daf=(0x0,exports[_0x3d91fe(0x2f7)])(_0x4e5eb7),_0x43232b=/\u200c/[_0x3d91fe(0x1e6)](_0x590daf);if(_0x4e5eb7['key']['fromMe']&&_0x43232b){const _0x2aec59=await Message_1[_0x3d91fe(0x289)][_0x3d91fe(0x20d)]({'where':{'id':_0x4e5eb7[_0x3d91fe(0x1b3)]['id'],'companyId':_0x20cbf3}}),_0x3f36b5=await Ticket_1[_0x3d91fe(0x289)][_0x3d91fe(0x2ac)](_0x2aec59['ticketId']);await _0x3f36b5['update']({'status':_0x3d91fe(0x264)}),_0x224598['to'](_0x3d91fe(0x1f6)+_0x3f36b5[_0x3d91fe(0x35b)]+'-open')[_0x3d91fe(0x2a3)](_0x3d91fe(0x1f6)+_0x3f36b5['companyId']+_0x3d91fe(0x2d7),{'action':_0x3d91fe(0x31d),'ticket':_0x3f36b5,'ticketId':_0x3f36b5['id']}),_0x224598['to']('company-'+_0x20cbf3+'-'+_0x3f36b5['status'])['to'](_0x3f36b5['id'][_0x3d91fe(0x1d0)]())[_0x3d91fe(0x2a3)](_0x3d91fe(0x1f6)+_0x3f36b5[_0x3d91fe(0x35b)]+'-ticket',{'action':'update','ticket':_0x3f36b5,'ticketId':_0x3f36b5['id']});}};exports[a558_0x4f05bc(0x2bf)]=verifyCampaignMessageAndCloseTicket;const filterMessages=_0x473026=>{const _0x37597e=a558_0x4f05bc;if([baileys_1[_0x37597e(0x2df)][_0x37597e(0x267)],baileys_1[_0x37597e(0x2df)][_0x37597e(0x2c8)],baileys_1[_0x37597e(0x2df)][_0x37597e(0x31a)],baileys_1[_0x37597e(0x2df)][_0x37597e(0x281)]]['includes'](_0x473026[_0x37597e(0x1a3)]))return![];return!![];},wbotMessageListener=async(_0x174318,_0x649a45,_0x5a8ed2)=>{const _0x4e0aef=a558_0x4f05bc;_0x174318['ev']['on'](_0x4e0aef(0x214),async _0xe1b5c7=>{const _0x5a4c0b=_0x4e0aef,_0x198ca1=_0xe1b5c7[_0x5a4c0b(0x262)][_0x5a4c0b(0x19b)](filterMessages);if(!_0x198ca1)return;await app_1['default'][_0x5a4c0b(0x324)](_0x5a4c0b(0x235))[_0x5a4c0b(0x201)][_0x5a4c0b(0x328)](_0x5a4c0b(0x23f),{'whatsappId':_0x5a8ed2['id'],'messages':_0x198ca1,'companyId':_0x649a45},{'removeOnComplete':!![],'attempts':0x3});}),_0x174318['ev']['on'](_0x4e0aef(0x1cb),async _0x547e60=>{const _0x4dc896=_0x4e0aef;if(_0x547e60[_0x4dc896(0x2ae)]===0x0)return;await app_1[_0x4dc896(0x289)][_0x4dc896(0x324)](_0x4dc896(0x235))[_0x4dc896(0x201)][_0x4dc896(0x328)](_0x4dc896(0x2b4),{'whatsappId':_0x5a8ed2['id'],'messageUpdate':_0x547e60,'companyId':_0x649a45},{'removeOnComplete':!![],'attempts':0x3,'delay':0x64});}),_0x174318['ev']['on'](_0x4e0aef(0x1c3),async _0x11f7a9=>{const _0x6f0ae=_0x4e0aef;console['log'](_0x11f7a9);if(_0x11f7a9['length']===0x0)return;for(const _0x15c652 of _0x11f7a9){const _0x5b7849=_0x15c652['id'][_0x6f0ae(0x27e)]('@')[0x0],_0x5cd6a4=_0x15c652[_0x6f0ae(0x343)]||_0x5b7849,_0x4caa49={'name':_0x5cd6a4,'number':_0x5b7849,'isGroup':!![],'companyId':_0x649a45,'remoteJid':_0x15c652['id'],'whatsappId':_0x174318['id']};await(0x0,CreateOrUpdateContactService_1[_0x6f0ae(0x289)])(_0x4caa49,_0x174318,_0x15c652['id']);}});};exports['wbotMessageListener']=wbotMessageListener;