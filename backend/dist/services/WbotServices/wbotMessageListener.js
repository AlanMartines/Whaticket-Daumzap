const a558_0x58848f=a558_0x54f9;(function(_0x5ce67f,_0x433bb6){const _0x42d22a=a558_0x54f9,_0xe12a79=_0x5ce67f();while(!![]){try{const _0x1089c2=-parseInt(_0x42d22a(0x1e6))/0x1+parseInt(_0x42d22a(0x2e8))/0x2*(parseInt(_0x42d22a(0x327))/0x3)+parseInt(_0x42d22a(0x2bb))/0x4+-parseInt(_0x42d22a(0x196))/0x5+-parseInt(_0x42d22a(0x209))/0x6*(-parseInt(_0x42d22a(0x266))/0x7)+-parseInt(_0x42d22a(0x249))/0x8*(-parseInt(_0x42d22a(0x2e1))/0x9)+-parseInt(_0x42d22a(0x30c))/0xa;if(_0x1089c2===_0x433bb6)break;else _0xe12a79['push'](_0xe12a79['shift']());}catch(_0x4e05b0){_0xe12a79['push'](_0xe12a79['shift']());}}}(a558_0x54cd,0x2b989));const a558_0x6e1c4e=(function(){let _0x4bde67=!![];return function(_0x4a3a29,_0x34752f){const _0x207a99=_0x4bde67?function(){const _0x4d5d6e=a558_0x54f9;if(_0x34752f){const _0x3b229a=_0x34752f[_0x4d5d6e(0x1dc)](_0x4a3a29,arguments);return _0x34752f=null,_0x3b229a;}}:function(){};return _0x4bde67=![],_0x207a99;};}()),a558_0x506100=a558_0x6e1c4e(this,function(){const _0x284725=a558_0x54f9;return a558_0x506100['toString']()[_0x284725(0x33a)]('(((.+)+)+)+$')[_0x284725(0x308)]()[_0x284725(0x25c)](a558_0x506100)[_0x284725(0x33a)](_0x284725(0x2f5));});a558_0x506100();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a558_0x58848f(0x1b3)]?function(_0x3fceee,_0x30d827,_0x3f2053,_0x3ad392){const _0x44f92a=a558_0x58848f;if(_0x3ad392===undefined)_0x3ad392=_0x3f2053;var _0x59f725=Object[_0x44f92a(0x288)](_0x30d827,_0x3f2053);(!_0x59f725||(_0x44f92a(0x295)in _0x59f725?!_0x30d827[_0x44f92a(0x1af)]:_0x59f725[_0x44f92a(0x2f2)]||_0x59f725['configurable']))&&(_0x59f725={'enumerable':!![],'get':function(){return _0x30d827[_0x3f2053];}}),Object[_0x44f92a(0x252)](_0x3fceee,_0x3ad392,_0x59f725);}:function(_0xb1ee8e,_0x4f1fa4,_0x5daee3,_0x5cee87){if(_0x5cee87===undefined)_0x5cee87=_0x5daee3;_0xb1ee8e[_0x5cee87]=_0x4f1fa4[_0x5daee3];}),__setModuleDefault=this&&this[a558_0x58848f(0x27f)]||(Object[a558_0x58848f(0x1b3)]?function(_0x4dadfb,_0xd64d7c){const _0x4c7a2e=a558_0x58848f;Object[_0x4c7a2e(0x252)](_0x4dadfb,_0x4c7a2e(0x224),{'enumerable':!![],'value':_0xd64d7c});}:function(_0x985c6,_0x78240e){const _0x1d67fc=a558_0x58848f;_0x985c6[_0x1d67fc(0x224)]=_0x78240e;}),__importStar=this&&this[a558_0x58848f(0x25e)]||function(_0x42f904){const _0x2311b3=a558_0x58848f;if(_0x42f904&&_0x42f904[_0x2311b3(0x1af)])return _0x42f904;var _0x29c548={};if(_0x42f904!=null){for(var _0x583762 in _0x42f904)if(_0x583762!==_0x2311b3(0x224)&&Object[_0x2311b3(0x1fb)][_0x2311b3(0x1b1)][_0x2311b3(0x1e1)](_0x42f904,_0x583762))__createBinding(_0x29c548,_0x42f904,_0x583762);}return __setModuleDefault(_0x29c548,_0x42f904),_0x29c548;},__importDefault=this&&this[a558_0x58848f(0x246)]||function(_0x18cefb){return _0x18cefb&&_0x18cefb['__esModule']?_0x18cefb:{'default':_0x18cefb};};Object[a558_0x58848f(0x252)](exports,a558_0x58848f(0x1af),{'value':!![]}),exports[a558_0x58848f(0x2ad)]=exports[a558_0x58848f(0x22b)]=exports[a558_0x58848f(0x251)]=exports[a558_0x58848f(0x2d2)]=exports[a558_0x58848f(0x28a)]=exports['handleMessageIntegration']=exports['handleRating']=exports[a558_0x58848f(0x2dd)]=exports[a558_0x58848f(0x1bf)]=exports[a558_0x58848f(0x2c4)]=exports['verifyQuotedMessage']=exports[a558_0x58848f(0x1ef)]=exports[a558_0x58848f(0x2a0)]=exports[a558_0x58848f(0x1e9)]=exports[a558_0x58848f(0x278)]=exports['sendMessageLink']=exports[a558_0x58848f(0x2d0)]=exports[a558_0x58848f(0x23e)]=exports[a558_0x58848f(0x2ff)]=exports[a558_0x58848f(0x237)]=exports['isNumeric']=void 0x0;const path_1=__importStar(require('path')),util_1=require(a558_0x58848f(0x192)),fs_1=require('fs'),Sentry=__importStar(require(a558_0x58848f(0x229))),lodash_1=require(a558_0x58848f(0x2b3)),baileys_1=require(a558_0x58848f(0x23b)),MessageUtils=__importStar(require(a558_0x58848f(0x1f8))),stream_throttle_1=require(a558_0x58848f(0x32a)),Contact_1=__importDefault(require(a558_0x58848f(0x2a8))),Ticket_1=__importDefault(require(a558_0x58848f(0x27c))),Message_1=__importDefault(require(a558_0x58848f(0x32e))),OldMessage_1=__importDefault(require(a558_0x58848f(0x1df))),socket_1=require(a558_0x58848f(0x1ae)),CreateMessageService_1=__importDefault(require(a558_0x58848f(0x212))),logger_1=require(a558_0x58848f(0x2b2)),CreateOrUpdateContactService_1=__importDefault(require(a558_0x58848f(0x2d5))),FindOrCreateTicketService_1=__importDefault(require(a558_0x58848f(0x23f))),ShowWhatsAppService_1=__importDefault(require(a558_0x58848f(0x31a))),UpdateTicketService_1=__importDefault(require(a558_0x58848f(0x31f))),Mustache_1=__importDefault(require(a558_0x58848f(0x291))),UserRating_1=__importDefault(require(a558_0x58848f(0x31b))),SendWhatsAppMessage_1=__importDefault(require(a558_0x58848f(0x1b5))),moment_1=__importDefault(require(a558_0x58848f(0x2e0))),Queue_1=__importDefault(require(a558_0x58848f(0x22f))),QueueOption_1=__importDefault(require(a558_0x58848f(0x188))),FindOrCreateATicketTrakingService_1=__importDefault(require(a558_0x58848f(0x273))),VerifyCurrentSchedule_1=__importDefault(require(a558_0x58848f(0x315))),Campaign_1=__importDefault(require('../../models/Campaign')),CampaignShipping_1=__importDefault(require('../../models/CampaignShipping')),sequelize_1=require(a558_0x58848f(0x1ba)),queues_1=require(a558_0x58848f(0x2ab)),User_1=__importDefault(require(a558_0x58848f(0x1a1))),Setting_1=__importDefault(require('../../models/Setting')),cache_1=require(a558_0x58848f(0x185)),Debounce_1=require(a558_0x58848f(0x2bc)),openai_1=require('openai'),fluent_ffmpeg_1=__importDefault(require('fluent-ffmpeg')),microsoft_cognitiveservices_speech_sdk_1=require('microsoft-cognitiveservices-speech-sdk'),providers_1=require(a558_0x58848f(0x23d)),typebotListener_1=__importDefault(require(a558_0x58848f(0x200))),ShowQueueIntegrationService_1=__importDefault(require(a558_0x58848f(0x2bf))),SendWhatsAppMedia_1=require(a558_0x58848f(0x1cd)),fs_2=__importDefault(require('fs')),request_1=__importDefault(require('request')),ffmpeg_static_1=__importDefault(require('ffmpeg-static')),app_1=__importDefault(require(a558_0x58848f(0x1e7))),mime_1=__importDefault(require(a558_0x58848f(0x2ae))),wbot_1=require(a558_0x58848f(0x1f1)),SendPresenceStatus_1=require(a558_0x58848f(0x240)),MakeRandomId_1=require(a558_0x58848f(0x270));fluent_ffmpeg_1[a558_0x58848f(0x224)][a558_0x58848f(0x186)](ffmpeg_static_1[a558_0x58848f(0x224)]);const sessionsOpenAi=[],isNumeric=_0x392113=>/^-?\d+$/['test'](_0x392113);exports[a558_0x58848f(0x29c)]=isNumeric;let outOfHourMessageControl=[],completionMessageControl=[],greetingMessageControl=[],farewellMessageControl=[];const writeFileAsync=(0x0,util_1['promisify'])(fs_1[a558_0x58848f(0x1b0)]),getTypeMessage=_0x5669e9=>{const _0x649a47=a558_0x58848f;return(0x0,baileys_1[_0x649a47(0x27e)])(_0x5669e9[_0x649a47(0x20c)]);},removeNonPrintableChars=_0x15363e=>{const _0x59b936=a558_0x58848f;return _0x15363e[_0x59b936(0x233)](/[\x00-\x1F\x7F-\x9F]/g,'');};exports['removeNonPrintableChars']=removeNonPrintableChars;async function getQueues(_0x58e47d){const _0x2f79f9=a558_0x58848f;try{const _0x2f0832=await Queue_1[_0x2f79f9(0x224)]['findAll']({'where':{'companyId':_0x58e47d}});return _0x2f0832;}catch(_0x48672a){return console[_0x2f79f9(0x1a5)](_0x2f79f9(0x1ea),_0x48672a),[];}}async function getContactFromTicket(_0x33f7cb){const _0x4255ad=a558_0x58848f;try{const _0x31e7d7=await Ticket_1['default']['findByPk'](_0x33f7cb,{'include':[{'model':Contact_1['default'],'as':_0x4255ad(0x2d7)}]});return _0x31e7d7&&_0x31e7d7['contact']?_0x31e7d7[_0x4255ad(0x2d7)]:(console['log']('No\x20contact\x20found\x20for\x20this\x20ticket.'),null);}catch(_0x19a266){return console['error'](_0x4255ad(0x247),_0x19a266),null;}}function validaCpfCnpj(_0x2a9975){const _0x1a7fbe=a558_0x58848f;if(_0x2a9975[_0x1a7fbe(0x236)]==0xb){var _0xa5d0bf=_0x2a9975[_0x1a7fbe(0x17f)]();_0xa5d0bf=_0xa5d0bf[_0x1a7fbe(0x233)](/\./g,''),_0xa5d0bf=_0xa5d0bf[_0x1a7fbe(0x233)]('-',''),_0xa5d0bf=_0xa5d0bf['split']('');var _0x5c3de8=0x0,_0x5aa7d3=0x0,_0x243158=![];for(var _0x2acef0=0x1;_0xa5d0bf['length']>_0x2acef0;_0x2acef0++){_0xa5d0bf[_0x2acef0-0x1]!=_0xa5d0bf[_0x2acef0]&&(_0x243158=!![]);}if(_0x243158==![])return![];for(var _0x2acef0=0x0,_0x1dc153=0xa;_0xa5d0bf[_0x1a7fbe(0x236)]-0x2>_0x2acef0;_0x2acef0++,_0x1dc153--){_0x5c3de8+=_0xa5d0bf[_0x2acef0]*_0x1dc153;}_0x5c3de8=_0x5c3de8*0xa%0xb;_0x5c3de8==0xa&&(_0x5c3de8=0x0);if(_0x5c3de8!=_0xa5d0bf[0x9])return![];for(var _0x2acef0=0x0,_0x1dc153=0xb;_0xa5d0bf[_0x1a7fbe(0x236)]-0x1>_0x2acef0;_0x2acef0++,_0x1dc153--){_0x5aa7d3+=_0xa5d0bf[_0x2acef0]*_0x1dc153;}return _0x5aa7d3=_0x5aa7d3*0xa%0xb,_0x5aa7d3==0xa&&(_0x5aa7d3=0x0),_0x5aa7d3!=_0xa5d0bf[0xa]?![]:!![];}else{if(_0x2a9975['length']==0xe){var _0x5ba12a=_0x2a9975['trim']();_0x5ba12a=_0x5ba12a['replace'](/\./g,''),_0x5ba12a=_0x5ba12a[_0x1a7fbe(0x233)]('-',''),_0x5ba12a=_0x5ba12a[_0x1a7fbe(0x233)]('/',''),_0x5ba12a=_0x5ba12a[_0x1a7fbe(0x342)]('');var _0x5c3de8=0x0,_0x5aa7d3=0x0,_0x243158=![];for(var _0x2acef0=0x1;_0x5ba12a[_0x1a7fbe(0x236)]>_0x2acef0;_0x2acef0++){_0x5ba12a[_0x2acef0-0x1]!=_0x5ba12a[_0x2acef0]&&(_0x243158=!![]);}if(_0x243158==![])return![];for(var _0x2acef0=0x0,_0x516f5a=0x5,_0x5a243d=0xd;_0x5ba12a[_0x1a7fbe(0x236)]-0x2>_0x2acef0;_0x2acef0++,_0x516f5a--,_0x5a243d--){_0x516f5a>=0x2?_0x5c3de8+=_0x5ba12a[_0x2acef0]*_0x516f5a:_0x5c3de8+=_0x5ba12a[_0x2acef0]*_0x5a243d;}_0x5c3de8=_0x5c3de8%0xb;_0x5c3de8<0x2?_0x5c3de8=0x0:_0x5c3de8=0xb-_0x5c3de8;if(_0x5c3de8!=_0x5ba12a[0xc])return![];for(var _0x2acef0=0x0,_0x516f5a=0x6,_0x5a243d=0xe;_0x5ba12a[_0x1a7fbe(0x236)]-0x1>_0x2acef0;_0x2acef0++,_0x516f5a--,_0x5a243d--){_0x516f5a>=0x2?_0x5aa7d3+=_0x5ba12a[_0x2acef0]*_0x516f5a:_0x5aa7d3+=_0x5ba12a[_0x2acef0]*_0x5a243d;}return _0x5aa7d3=_0x5aa7d3%0xb,_0x5aa7d3<0x2?_0x5aa7d3=0x0:_0x5aa7d3=0xb-_0x5aa7d3,_0x5aa7d3!=_0x5ba12a[0xd]?![]:!![];}else return![];}}exports['validaCpfCnpj']=validaCpfCnpj;function timeout(_0xabf633){return new Promise(_0x424ab8=>setTimeout(_0x424ab8,_0xabf633));}async function sleep(_0x55255b){await timeout(_0x55255b);}exports['sleep']=sleep;const sendMessageImage=async(_0x2ab806,_0x17916d,_0x2d22b7,_0xb32562,_0x20fbd4)=>{const _0x5a389c=a558_0x58848f;let _0x59b0db;try{_0x59b0db=await _0x2ab806[_0x5a389c(0x2c7)](_0x17916d[_0x5a389c(0x1f9)]+'@'+(_0x2d22b7[_0x5a389c(0x335)]?_0x5a389c(0x28d):_0x5a389c(0x17c)),{'image':_0xb32562?{'url':_0xb32562}:fs_2[_0x5a389c(0x224)][_0x5a389c(0x259)](_0x5a389c(0x313)+_0x20fbd4+'-'+makeid(0xa)),'fileName':_0x20fbd4,'caption':_0x20fbd4,'mimetype':_0x5a389c(0x2d8)});}catch(_0x1af748){_0x59b0db=await _0x2ab806['sendMessage'](_0x17916d[_0x5a389c(0x1f9)]+'@'+(_0x2d22b7[_0x5a389c(0x335)]?_0x5a389c(0x28d):'s.whatsapp.net'),{'text':(0x0,Mustache_1['default'])(_0x5a389c(0x20b),_0x2d22b7)});}(0x0,exports['verifyMessage'])(_0x59b0db,_0x2d22b7,_0x17916d);};exports[a558_0x58848f(0x2d0)]=sendMessageImage;const sendMessageLink=async(_0x530fcc,_0x40b40b,_0x50f012,_0x5a7f7a,_0x1255ae)=>{const _0x27a262=a558_0x58848f;let _0x54b717;try{_0x54b717=await _0x530fcc[_0x27a262(0x2c7)](_0x40b40b[_0x27a262(0x1f9)]+'@'+(_0x50f012['isGroup']?'g.us':_0x27a262(0x17c)),{'document':_0x5a7f7a?{'url':_0x5a7f7a}:fs_2[_0x27a262(0x224)][_0x27a262(0x259)](_0x27a262(0x313)+_0x1255ae+'-'+makeid(0xa)),'fileName':_0x1255ae,'caption':_0x1255ae,'mimetype':_0x27a262(0x256)});}catch(_0x4c28ad){_0x54b717=await _0x530fcc[_0x27a262(0x2c7)](_0x40b40b['number']+'@'+(_0x50f012[_0x27a262(0x335)]?_0x27a262(0x28d):'s.whatsapp.net'),{'text':(0x0,Mustache_1['default'])(_0x27a262(0x20b),_0x50f012)});}(0x0,exports[_0x27a262(0x2c4)])(_0x54b717,_0x50f012,_0x40b40b);};exports['sendMessageLink']=sendMessageLink;function makeid(_0x47baf5){const _0x184d18=a558_0x58848f;var _0xb8822d='',_0x428549=_0x184d18(0x1c7),_0x292798=_0x428549[_0x184d18(0x236)];for(var _0x3baab3=0x0;_0x3baab3<_0x47baf5;_0x3baab3++){_0xb8822d+=_0x428549['charAt'](Math[_0x184d18(0x337)](Math[_0x184d18(0x277)]()*_0x292798));}return _0xb8822d;}exports[a558_0x58848f(0x278)]=makeid;const msgLocation=(_0x538d90,_0x18c703,_0x3998d4)=>{const _0x1146de=a558_0x58848f;if(_0x538d90){var _0x41e46d=Buffer[_0x1146de(0x2b5)](_0x538d90)[_0x1146de(0x308)](_0x1146de(0x340));let _0x130036=_0x1146de(0x298)+_0x41e46d+_0x1146de(0x1c8)+_0x18c703+_0x1146de(0x279)+_0x3998d4+'&z=17&hl=pt-BR|'+_0x18c703+',\x20'+_0x3998d4+'\x20';return _0x130036;}},getBodyMessage=_0x59c249=>{const _0x485210=a558_0x58848f;try{let _0x2f76e5=getTypeMessage(_0x59c249);const _0x14abba={'conversation':MessageUtils[_0x485210(0x309)](_0x59c249),'editedMessage':_0x59c249?.[_0x485210(0x20c)]?.[_0x485210(0x193)]?.[_0x485210(0x20c)]?.['protocolMessage']?.[_0x485210(0x193)]?.[_0x485210(0x2e6)]||_0x59c249?.['message']?.[_0x485210(0x193)]?.[_0x485210(0x20c)]?.[_0x485210(0x343)]?.['text'],'imageMessage':MessageUtils[_0x485210(0x30e)](_0x59c249),'videoMessage':MessageUtils['getVideoMessage'](_0x59c249),'extendedTextMessage':_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x343)]?.[_0x485210(0x2f0)],'buttonsResponseMessage':MessageUtils[_0x485210(0x304)](_0x59c249),'templateButtonReplyMessage':_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x1ac)]?.['selectedId'],'messageContextInfo':_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x2ea)]?.[_0x485210(0x344)]||_0x59c249['message']?.[_0x485210(0x18f)]?.['title'],'buttonsMessage':MessageUtils['getBodyButton'](_0x59c249)||_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x18f)]?.[_0x485210(0x2f3)]?.[_0x485210(0x1e2)],'viewOnceMessage':MessageUtils[_0x485210(0x253)](_0x59c249),'viewOnceMessageV2':MessageUtils[_0x485210(0x206)](_0x59c249),'stickerMessage':MessageUtils[_0x485210(0x2aa)](_0x59c249),'contactMessage':MessageUtils['getContactMessage'](_0x59c249),'contactsArrayMessage':_0x59c249['message']?.[_0x485210(0x316)]?.[_0x485210(0x239)]&&MessageUtils[_0x485210(0x1b4)](_0x59c249),'pollCreationMessageV2':_0x59c249[_0x485210(0x20c)]?.['pollCreationMessageV2']?.[_0x485210(0x29e)]||_0x485210(0x329),'pollCreationMessageV3':_0x59c249['message']?.[_0x485210(0x20a)]?.['name']||'Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','interactiveMessage':_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x1bb)]?.[_0x485210(0x22a)]||_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x1bb)]?.[_0x485210(0x1e8)]||_0x485210(0x1cc),'locationMessage':MessageUtils[_0x485210(0x294)](_0x59c249),'liveLocationMessage':_0x485210(0x322)+_0x59c249[_0x485210(0x20c)]?.['liveLocationMessage']?.[_0x485210(0x19f)]+_0x485210(0x23c)+_0x59c249['message']?.[_0x485210(0x1a8)]?.[_0x485210(0x250)],'documentMessage':MessageUtils[_0x485210(0x1ed)](_0x59c249),'documentWithCaptionMessage':_0x59c249['message']?.[_0x485210(0x321)]?.[_0x485210(0x20c)]?.[_0x485210(0x21c)]?.['caption'],'audioMessage':MessageUtils[_0x485210(0x225)](_0x59c249),'ephemeralMessage':_0x59c249[_0x485210(0x20c)]?.['ephemeralMessage']?.[_0x485210(0x20c)]?.[_0x485210(0x343)]?.[_0x485210(0x2f0)],'listMessage':MessageUtils[_0x485210(0x283)](_0x59c249)||_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x18f)]?.['title'],'listResponseMessage':MessageUtils[_0x485210(0x190)](_0x59c249),'reactionMessage':MessageUtils[_0x485210(0x1d5)](_0x59c249)||'reaction','advertising':MessageUtils[_0x485210(0x1c0)](_0x59c249)||_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x18f)]?.[_0x485210(0x1e8)]?.[_0x485210(0x24c)]?.[_0x485210(0x2c3)],'productMessage':_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x24a)]?.[_0x485210(0x176)]?.[_0x485210(0x187)]?.['caption']||_0x485210(0x274),'multiProductMessage':_0x485210(0x2f9),'orderMessage':'Pedido','paymentMessage':MessageUtils[_0x485210(0x1de)](_0x59c249),'paymentRequestMessage':'Solicitação\x20de\x20Pagamento','groupInviteMessage':MessageUtils['getGroupInviteMessage'](_0x59c249),'revokeInviteMessage':_0x485210(0x1d2),'protocolMessage':_0x59c249[_0x485210(0x20c)]?.[_0x485210(0x21e)]?.['editedMessage']?.[_0x485210(0x2e6)]||null,'disappearingMessage':'Mensagem\x20que\x20Desaparece','callMessage':MessageUtils[_0x485210(0x207)](_0x59c249),'templateMessage':MessageUtils['getTemplateMessage'](_0x59c249),'statusUpdateMessage':_0x485210(0x2cd)};return _0x14abba[_0x2f76e5]||null;}catch(_0x421e1c){return console['error']('Error\x20getting\x20message\x20body:',_0x421e1c),null;}};exports['getBodyMessage']=getBodyMessage;const getQuotedMessage=_0x7a1533=>{const _0x19a9d9=a558_0x58848f,_0x434742=_0x7a1533[_0x19a9d9(0x20c)][_0x19a9d9(0x2a3)][_0x19a9d9(0x1e8)]||_0x7a1533[_0x19a9d9(0x20c)]['videoMessage']['contextInfo']||_0x7a1533['message']?.['documentMessage']||_0x7a1533[_0x19a9d9(0x20c)][_0x19a9d9(0x343)][_0x19a9d9(0x1e8)]||_0x7a1533[_0x19a9d9(0x20c)]['buttonsResponseMessage']['contextInfo']||_0x7a1533['message'][_0x19a9d9(0x18f)][_0x19a9d9(0x1e8)]||_0x7a1533[_0x19a9d9(0x20c)][_0x19a9d9(0x1ac)][_0x19a9d9(0x1e8)]||_0x7a1533['message'][_0x19a9d9(0x2ea)]?.[_0x19a9d9(0x1e8)]||_0x7a1533?.['message']?.['buttonsResponseMessage']?.[_0x19a9d9(0x344)]||_0x7a1533[_0x19a9d9(0x20c)][_0x19a9d9(0x18f)]?.[_0x19a9d9(0x2f3)]?.['selectedRowId']||_0x7a1533?.[_0x19a9d9(0x20c)]?.[_0x19a9d9(0x18f)]?.[_0x19a9d9(0x2f3)]['selectedRowId']||_0x7a1533[_0x19a9d9(0x20c)]['listResponseMessage']?.['contextInfo'];return _0x7a1533[_0x19a9d9(0x20c)]['senderKeyDistributionMessage'],(0x0,baileys_1[_0x19a9d9(0x2d9)])(_0x434742[Object[_0x19a9d9(0x1fe)](_0x434742)[_0x19a9d9(0x19c)]()[_0x19a9d9(0x1a9)]()[_0x19a9d9(0x221)]]);};exports['getQuotedMessage']=getQuotedMessage;const getQuotedMessageId=_0x2dbe96=>{const _0x442d80=a558_0x58848f,_0x1cb390=(0x0,baileys_1[_0x442d80(0x2d9)])(_0x2dbe96[_0x442d80(0x20c)])[Object[_0x442d80(0x1fe)](_0x2dbe96?.[_0x442d80(0x20c)])[_0x442d80(0x19c)]()[_0x442d80(0x1a9)]()[_0x442d80(0x221)]];let _0x5739e3=_0x2dbe96?.[_0x442d80(0x20c)]?.['reactionMessage']?_0x2dbe96?.['message']?.[_0x442d80(0x325)]?.[_0x442d80(0x21d)]?.['id']:'';return _0x5739e3?_0x5739e3:_0x1cb390?.[_0x442d80(0x1e8)]?.[_0x442d80(0x2a1)];};exports[a558_0x58848f(0x1ef)]=getQuotedMessageId;const getMeSocket=_0x54452d=>{const _0x2fc39c=a558_0x58848f;return{'id':(0x0,baileys_1[_0x2fc39c(0x2ed)])(_0x54452d[_0x2fc39c(0x281)]['id']),'name':_0x54452d[_0x2fc39c(0x281)][_0x2fc39c(0x29e)]};},getSenderMessage=(_0x4accd1,_0x296d91)=>{const _0x5332aa=a558_0x58848f,_0x5f07a1=getMeSocket(_0x296d91);if(_0x4accd1[_0x5332aa(0x21d)]['fromMe'])return _0x5f07a1['id'];const _0x1bdb7c=_0x4accd1[_0x5332aa(0x27d)]||_0x4accd1[_0x5332aa(0x21d)]['participant']||_0x4accd1['key'][_0x5332aa(0x1f3)]||undefined;return _0x1bdb7c&&(0x0,baileys_1['jidNormalizedUser'])(_0x1bdb7c);},getContactMessage=async(_0x10f809,_0x553846)=>{const _0x105b21=a558_0x58848f,_0x225c1b=_0x10f809[_0x105b21(0x21d)][_0x105b21(0x1f3)]['includes']('g.us'),_0x25bbc9=_0x10f809[_0x105b21(0x21d)]['remoteJid'][_0x105b21(0x233)](/\D/g,'');return _0x225c1b?{'id':getSenderMessage(_0x10f809,_0x553846),'name':_0x10f809['pushName']}:{'id':_0x10f809[_0x105b21(0x21d)][_0x105b21(0x1f3)],'name':_0x10f809[_0x105b21(0x21d)]['fromMe']?_0x25bbc9:_0x10f809[_0x105b21(0x284)]};},getUnpackedMessage=_0x582373=>{const _0x100641=a558_0x58848f;return _0x582373[_0x100641(0x20c)]?.[_0x100641(0x321)]?.[_0x100641(0x20c)]||_0x582373['message']?.[_0x100641(0x343)]?.[_0x100641(0x1e8)]?.[_0x100641(0x1db)]||_0x582373[_0x100641(0x20c)]?.[_0x100641(0x18a)]?.[_0x100641(0x20c)]||_0x582373['message']?.[_0x100641(0x33b)]?.['message']||_0x582373[_0x100641(0x20c)]?.[_0x100641(0x2ef)]?.['message']||_0x582373[_0x100641(0x20c)]?.[_0x100641(0x18a)]?.[_0x100641(0x20c)]||_0x582373[_0x100641(0x20c)]?.[_0x100641(0x2e3)]?.[_0x100641(0x216)]||_0x582373['message']?.['templateMessage']?.['hydratedFourRowTemplate']||_0x582373['message']?.[_0x100641(0x2e3)]?.[_0x100641(0x311)]||_0x582373[_0x100641(0x20c)]?.[_0x100641(0x1bb)]?.[_0x100641(0x26b)]||_0x582373[_0x100641(0x20c)]?.[_0x100641(0x2fa)]?.['hydratedHsm']?.['hydratedTemplate']||_0x582373[_0x100641(0x20c)];},getMessageMedia=_0xaec7bd=>{const _0x1796e8=a558_0x58848f;return _0xaec7bd?.[_0x1796e8(0x2a3)]||_0xaec7bd?.[_0x1796e8(0x333)]||_0xaec7bd?.['videoMessage']||_0xaec7bd?.['stickerMessage']||_0xaec7bd?.[_0x1796e8(0x21c)]||null;},downloadMedia=async _0x6a5146=>{const _0x1fa88a=a558_0x58848f,_0x41cc4e=getUnpackedMessage(_0x6a5146),_0x53964d=getMessageMedia(_0x41cc4e);if(!_0x53964d)return null;const _0x882ca2=_0x41cc4e?.[_0x1fa88a(0x21c)]?_0x1fa88a(0x2fb):_0x53964d[_0x1fa88a(0x219)]['split']('/')[0x0][_0x1fa88a(0x233)]('application',_0x1fa88a(0x2fb))?_0x53964d['mimetype']['split']('/')[0x0]['replace'](_0x1fa88a(0x297),_0x1fa88a(0x2fb)):_0x53964d['mimetype'][_0x1fa88a(0x342)]('/')[0x0];let _0x17d6ce,_0x1469d9=0x0;while(_0x1469d9<0xa&&!_0x17d6ce){try{_0x53964d?.[_0x1fa88a(0x1e4)]&&(_0x53964d['url']=''),_0x17d6ce=await(0x0,baileys_1[_0x1fa88a(0x26c)])(_0x53964d,_0x882ca2);}catch(_0x1f3a56){_0x1469d9+=0x1,await new Promise(_0x538bf6=>{setTimeout(_0x538bf6,0x3e8*_0x1469d9*0x2);}),logger_1[_0x1fa88a(0x31c)][_0x1fa88a(0x245)](_0x1fa88a(0x280)+_0x1469d9+_0x1fa88a(0x30f)+_0x6a5146?.[_0x1fa88a(0x21d)]?.['id']);}}if(!_0x17d6ce)throw new Error(_0x1fa88a(0x1f2));let _0x4298fa=_0x41cc4e?.[_0x1fa88a(0x21c)]?.['fileName']||'';if(!_0x4298fa){const _0x5d85ad=mime_1[_0x1fa88a(0x224)][_0x1fa88a(0x232)](_0x53964d[_0x1fa88a(0x219)]);_0x4298fa=(0x0,MakeRandomId_1[_0x1fa88a(0x268)])(0x5)+'-'+new Date()[_0x1fa88a(0x2df)]()+'.'+_0x5d85ad;}else _0x4298fa=_0x4298fa['split']('.')[_0x1fa88a(0x317)](0x0,-0x1)['join']('.')+'.'+(0x0,MakeRandomId_1[_0x1fa88a(0x268)])(0x5)+'.'+_0x4298fa[_0x1fa88a(0x342)]('.')[_0x1fa88a(0x317)](-0x1);const _0x1173ed=0x5*0x400*0x400/0x8,_0x37e2d2=0x400*0x400/0x8,_0x3d8404=0x400*0x400,_0x27381e=new stream_throttle_1[(_0x1fa88a(0x1fa))]({'rate':_0x1173ed});let _0x189a84=Buffer['from']([]),_0x39b9e0=0x0;const _0x691ae9=Date[_0x1fa88a(0x1a6)]();try{for await(const _0x56d738 of _0x17d6ce[_0x1fa88a(0x25f)](_0x27381e)){_0x189a84=Buffer[_0x1fa88a(0x300)]([_0x189a84,_0x56d738]),_0x39b9e0+=_0x56d738[_0x1fa88a(0x236)],_0x39b9e0>_0x3d8404&&(_0x27381e[_0x1fa88a(0x18d)]=_0x37e2d2);}}catch(_0x5e3c50){return{'data':_0x1fa88a(0x1a5),'mimetype':'','filename':''};}const _0x1693f8=Date[_0x1fa88a(0x1a6)](),_0x2cc172=(_0x1693f8-_0x691ae9)/0x3e8,_0xd79d79=_0x39b9e0/_0x2cc172;logger_1[_0x1fa88a(0x31c)][_0x1fa88a(0x2e5)](_0x4298fa+_0x1fa88a(0x2f1)+_0x2cc172[_0x1fa88a(0x2a5)](0x2)+'\x20seconds\x20with\x20an\x20effective\x20speed\x20of\x20'+(_0xd79d79/0x400/0x400)[_0x1fa88a(0x2a5)](0x2)+_0x1fa88a(0x25d));if(!_0x189a84){Sentry['setExtra']('ERR_WAPP_DOWNLOAD_MEDIA',{'msg':_0x6a5146}),Sentry['captureException'](new Error(_0x1fa88a(0x18e)));throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');}const _0x2fe091={'data':_0x189a84,'mimetype':_0x53964d[_0x1fa88a(0x219)],'filename':_0x4298fa};return _0x2fe091;},verifyContact=async(_0x3c8516,_0x48901b,_0x166834)=>{const _0x53a004=a558_0x58848f,_0x17d44e={'name':_0x3c8516?.[_0x53a004(0x29e)]||_0x3c8516['id'][_0x53a004(0x233)](/\D/g,''),'number':_0x3c8516['id'][_0x53a004(0x17a)](0x0,_0x3c8516['id']['indexOf']('@')),'isGroup':_0x3c8516['id'][_0x53a004(0x299)](_0x53a004(0x28d)),'companyId':_0x166834,'whatsappId':_0x48901b['id']},_0x3bca7c=(0x0,CreateOrUpdateContactService_1[_0x53a004(0x224)])(_0x17d44e,_0x48901b,_0x3c8516['id']);return _0x3bca7c;},verifyQuotedMessage=async _0x25c78a=>{const _0x50ae3e=a558_0x58848f;if(!_0x25c78a)return null;const _0x56d496=(0x0,exports[_0x50ae3e(0x1ef)])(_0x25c78a);if(!_0x56d496)return null;const _0x4d2d46=await Message_1[_0x50ae3e(0x224)][_0x50ae3e(0x32f)]({'where':{'id':_0x56d496}});if(!_0x4d2d46)return null;return _0x4d2d46;};exports['verifyQuotedMessage']=verifyQuotedMessage;const sanitizeName=_0xf36174=>{const _0x2017fc=a558_0x58848f;let _0x3c5db3=_0xf36174['split']('\x20')[0x0];return _0x3c5db3=_0x3c5db3[_0x2017fc(0x233)](/[^a-zA-Z0-9]/g,''),_0x3c5db3['substring'](0x0,0x3c);},convertTextToSpeechAndSaveToFile=(_0x1d6a5b,_0x3b7d8d,_0x53369e,_0x2bf093,_0x328337=a558_0x58848f(0x2b8),_0x101c34=a558_0x58848f(0x254))=>{return new Promise((_0x383c39,_0x595c96)=>{const _0x4257bd=a558_0x54f9,_0x3d1a37=microsoft_cognitiveservices_speech_sdk_1[_0x4257bd(0x182)][_0x4257bd(0x2a9)](_0x53369e,_0x2bf093);_0x3d1a37[_0x4257bd(0x323)]=_0x328337;const _0x2e8d01=microsoft_cognitiveservices_speech_sdk_1[_0x4257bd(0x213)][_0x4257bd(0x1c2)](_0x3b7d8d+'.wav'),_0xc303a1=new microsoft_cognitiveservices_speech_sdk_1[(_0x4257bd(0x1a4))](_0x3d1a37,_0x2e8d01);_0xc303a1[_0x4257bd(0x235)](_0x1d6a5b,_0x1e266e=>{const _0xc78080=_0x4257bd;_0x1e266e?convertWavToAnotherFormat(_0x3b7d8d+_0xc78080(0x326),_0x3b7d8d+'.'+_0x101c34,_0x101c34)[_0xc78080(0x287)](_0xdc3719=>{_0x383c39();})[_0xc78080(0x195)](_0x19032f=>{console['error'](_0x19032f),_0x595c96(_0x19032f);}):_0x595c96(new Error(_0xc78080(0x2bd))),_0xc303a1[_0xc78080(0x262)]();},_0x43c51d=>{const _0x3437cf=_0x4257bd;console[_0x3437cf(0x1a5)]('Error:\x20'+_0x43c51d),_0xc303a1[_0x3437cf(0x262)](),_0x595c96(_0x43c51d);});});},convertWavToAnotherFormat=(_0xfb5b5a,_0x5efaa7,_0x3c66bb)=>{return new Promise((_0x1041ce,_0x17b6b7)=>{const _0x49fe5c=a558_0x54f9;(0x0,fluent_ffmpeg_1[_0x49fe5c(0x224)])()[_0x49fe5c(0x1ee)](_0xfb5b5a)[_0x49fe5c(0x2c0)](_0x3c66bb)['on'](_0x49fe5c(0x2c1),()=>_0x1041ce(_0x5efaa7))['on'](_0x49fe5c(0x1a5),_0x20e880=>_0x17b6b7(new Error(_0x49fe5c(0x314)+_0x20e880[_0x49fe5c(0x20c)])))[_0x49fe5c(0x32b)](_0x5efaa7);});},deleteFileSync=_0x26426e=>{const _0xd42b=a558_0x58848f;try{fs_2[_0xd42b(0x224)][_0xd42b(0x2cf)](_0x26426e);}catch(_0x48b8b0){console['error']('Erro\x20ao\x20deletar\x20o\x20arquivo:',_0x48b8b0);}},keepOnlySpecifiedChars=_0x249800=>{const _0x1dfa3a=a558_0x58848f;return _0x249800[_0x1dfa3a(0x233)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x594730,_0x5291ff,_0xb1ea5c,_0x58e8d9,_0x123c36)=>{const _0x1f5ca0=a558_0x58848f,_0x1fef85=(0x0,exports[_0x1f5ca0(0x1e9)])(_0x594730);if(!_0x1fef85)return;let {prompt:_0x488d76}=await(0x0,ShowWhatsAppService_1[_0x1f5ca0(0x224)])(_0x5291ff['id'],_0xb1ea5c[_0x1f5ca0(0x341)]);!_0x488d76&&!(0x0,lodash_1[_0x1f5ca0(0x1d1)])(_0xb1ea5c?.[_0x1f5ca0(0x318)]?.[_0x1f5ca0(0x181)])&&(_0x488d76=_0xb1ea5c[_0x1f5ca0(0x318)][_0x1f5ca0(0x181)]);if(!_0x488d76)return;if(_0x594730['messageStubType'])return;const _0x54ed3f=path_1['default']['resolve'](__dirname,'..','..','..',_0x1f5ca0(0x345));let _0x1a6efe;const _0x36a035=sessionsOpenAi[_0x1f5ca0(0x1c6)](_0x25b8ab=>_0x25b8ab['id']===_0x5291ff['id']);if(_0x36a035===-0x1){const _0xa6ee6d=new openai_1['Configuration']({'apiKey':_0x488d76[_0x1f5ca0(0x29f)]});_0x1a6efe=new openai_1[(_0x1f5ca0(0x2cc))](_0xa6ee6d),_0x1a6efe['id']=_0x5291ff['id'],sessionsOpenAi[_0x1f5ca0(0x1cf)](_0x1a6efe);}else _0x1a6efe=sessionsOpenAi[_0x36a035];const _0x471cfd=await Message_1[_0x1f5ca0(0x224)][_0x1f5ca0(0x1ca)]({'where':{'ticketId':_0xb1ea5c['id']},'order':[[_0x1f5ca0(0x21b),'ASC']],'limit':_0x488d76[_0x1f5ca0(0x310)]}),_0x161d8b=_0x1f5ca0(0x24f)+sanitizeName(_0x58e8d9[_0x1f5ca0(0x29e)]||_0x1f5ca0(0x22d))+_0x1f5ca0(0x1a2)+_0x488d76[_0x1f5ca0(0x272)]+_0x1f5ca0(0x1c3)+_0x488d76['prompt']+'\x0a';let _0x1772a8=[];if(_0x594730[_0x1f5ca0(0x20c)]?.['conversation']||_0x594730['message']?.['extendedTextMessage']?.[_0x1f5ca0(0x2f0)]){_0x1772a8=[],_0x1772a8[_0x1f5ca0(0x1cf)]({'role':_0x1f5ca0(0x1bc),'content':_0x161d8b});for(let _0x15b803=0x0;_0x15b803<Math[_0x1f5ca0(0x1c5)](_0x488d76[_0x1f5ca0(0x310)],_0x471cfd[_0x1f5ca0(0x236)]);_0x15b803++){const _0x41ef5c=_0x471cfd[_0x15b803];_0x41ef5c[_0x1f5ca0(0x2e2)]===_0x1f5ca0(0x19b)&&(_0x41ef5c['fromMe']?_0x1772a8[_0x1f5ca0(0x1cf)]({'role':_0x1f5ca0(0x1f4),'content':_0x41ef5c['body']}):_0x1772a8['push']({'role':_0x1f5ca0(0x281),'content':_0x41ef5c[_0x1f5ca0(0x22a)]}));}_0x1772a8[_0x1f5ca0(0x1cf)]({'role':_0x1f5ca0(0x281),'content':_0x1fef85});const _0x2042b4=await _0x1a6efe[_0x1f5ca0(0x2de)]({'model':_0x1f5ca0(0x33e),'messages':_0x1772a8,'max_tokens':_0x488d76[_0x1f5ca0(0x272)],'temperature':_0x488d76['temperature']});let _0x117884=_0x2042b4[_0x1f5ca0(0x2c9)][_0x1f5ca0(0x2e7)][0x0][_0x1f5ca0(0x20c)]?.[_0x1f5ca0(0x1ff)];_0x117884?.['includes'](_0x1f5ca0(0x242))&&(await transferQueue(_0x488d76[_0x1f5ca0(0x1d6)],_0xb1ea5c,_0x58e8d9),_0x117884=_0x117884[_0x1f5ca0(0x233)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','')[_0x1f5ca0(0x17f)]());if(_0x488d76[_0x1f5ca0(0x1bd)]===_0x1f5ca0(0x1d0)){const _0xb4747a=await _0x5291ff[_0x1f5ca0(0x2c7)](_0x594730[_0x1f5ca0(0x21d)][_0x1f5ca0(0x1f3)],{'text':_0x117884});await(0x0,exports[_0x1f5ca0(0x2c4)])(_0xb4747a,_0xb1ea5c,_0x58e8d9);}else{const _0x4829d6=_0xb1ea5c['id']+'_'+Date[_0x1f5ca0(0x1a6)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x117884),_0x54ed3f+'/'+_0x4829d6,_0x488d76[_0x1f5ca0(0x27b)],_0x488d76[_0x1f5ca0(0x2d1)],_0x488d76[_0x1f5ca0(0x1bd)],_0x1f5ca0(0x254))[_0x1f5ca0(0x287)](async()=>{const _0x21b174=_0x1f5ca0;try{const _0x53693c=await _0x5291ff[_0x21b174(0x2c7)](_0x594730['key'][_0x21b174(0x1f3)],{'audio':{'url':_0x54ed3f+'/'+_0x4829d6+_0x21b174(0x1a0)},'mimetype':_0x21b174(0x2b7),'ptt':!![]});await verifyMediaMessage(_0x53693c,_0xb1ea5c,_0x58e8d9),deleteFileSync(_0x54ed3f+'/'+_0x4829d6+'.mp3'),deleteFileSync(_0x54ed3f+'/'+_0x4829d6+_0x21b174(0x326));}catch(_0x5def71){console[_0x21b174(0x2da)](_0x21b174(0x338)+_0x5def71);}});}}else{if(_0x594730[_0x1f5ca0(0x20c)]?.[_0x1f5ca0(0x333)]){const _0x3ae81a=_0x123c36[_0x1f5ca0(0x204)][_0x1f5ca0(0x342)]('/')[_0x1f5ca0(0x2cb)](),_0x58ea73=fs_2['default'][_0x1f5ca0(0x282)](_0x54ed3f+'/'+_0x3ae81a),_0x389ee9=await _0x1a6efe[_0x1f5ca0(0x1e3)](_0x58ea73,_0x1f5ca0(0x30d));_0x1772a8=[],_0x1772a8[_0x1f5ca0(0x1cf)]({'role':'system','content':_0x161d8b});for(let _0xc1d495=0x0;_0xc1d495<Math['min'](_0x488d76[_0x1f5ca0(0x310)],_0x471cfd[_0x1f5ca0(0x236)]);_0xc1d495++){const _0x3550e4=_0x471cfd[_0xc1d495];_0x3550e4[_0x1f5ca0(0x2e2)]===_0x1f5ca0(0x19b)&&(_0x3550e4['fromMe']?_0x1772a8['push']({'role':_0x1f5ca0(0x1f4),'content':_0x3550e4[_0x1f5ca0(0x22a)]}):_0x1772a8[_0x1f5ca0(0x1cf)]({'role':_0x1f5ca0(0x281),'content':_0x3550e4[_0x1f5ca0(0x22a)]}));}_0x1772a8[_0x1f5ca0(0x1cf)]({'role':_0x1f5ca0(0x281),'content':_0x389ee9[_0x1f5ca0(0x2c9)]['text']});const _0x5492a5=await _0x1a6efe[_0x1f5ca0(0x2de)]({'model':_0x1f5ca0(0x33e),'messages':_0x1772a8,'max_tokens':_0x488d76[_0x1f5ca0(0x272)],'temperature':_0x488d76['temperature']});let _0x23d09c=_0x5492a5[_0x1f5ca0(0x2c9)]['choices'][0x0][_0x1f5ca0(0x20c)]?.[_0x1f5ca0(0x1ff)];_0x23d09c?.[_0x1f5ca0(0x299)](_0x1f5ca0(0x242))&&(await transferQueue(_0x488d76['queueId'],_0xb1ea5c,_0x58e8d9),_0x23d09c=_0x23d09c[_0x1f5ca0(0x233)](_0x1f5ca0(0x242),'')[_0x1f5ca0(0x17f)]());if(_0x488d76[_0x1f5ca0(0x1bd)]==='texto'){const _0x2cfbcf=await _0x5291ff[_0x1f5ca0(0x2c7)](_0x594730[_0x1f5ca0(0x21d)][_0x1f5ca0(0x1f3)],{'text':_0x23d09c});await(0x0,exports['verifyMessage'])(_0x2cfbcf,_0xb1ea5c,_0x58e8d9);}else{const _0x1ccbe7=_0xb1ea5c['id']+'_'+Date[_0x1f5ca0(0x1a6)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x23d09c),_0x54ed3f+'/'+_0x1ccbe7,_0x488d76['voiceKey'],_0x488d76[_0x1f5ca0(0x2d1)],_0x488d76[_0x1f5ca0(0x1bd)],_0x1f5ca0(0x254))['then'](async()=>{const _0x31d3f4=_0x1f5ca0;try{const _0x486348=await _0x5291ff[_0x31d3f4(0x2c7)](_0x594730['key'][_0x31d3f4(0x1f3)],{'audio':{'url':_0x54ed3f+'/'+_0x1ccbe7+'.mp3'},'mimetype':_0x31d3f4(0x2b7),'ptt':!![]});await verifyMediaMessage(_0x486348,_0xb1ea5c,_0x58e8d9),deleteFileSync(_0x54ed3f+'/'+_0x1ccbe7+'.mp3'),deleteFileSync(_0x54ed3f+'/'+_0x1ccbe7+_0x31d3f4(0x326));}catch(_0x118820){console['log'](_0x31d3f4(0x338)+_0x118820);}});}}}_0x1772a8=[];},transferQueue=async(_0x32f83b,_0x4719e3,_0x1a21d8)=>{const _0x415b1c=a558_0x58848f;console['trace']('update!'),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x32f83b,'useIntegration':![],'promptId':null},'ticketId':_0x4719e3['id'],'companyId':_0x4719e3[_0x415b1c(0x341)]});},verifyMediaMessage=async(_0x6d4071,_0x54ae5c,_0x323fc4)=>{const _0x2fa007=a558_0x58848f,_0x2ef092=(0x0,socket_1['getIO'])();let _0x11aec6=await Message_1['default'][_0x2fa007(0x32f)]({'where':{'id':_0x6d4071[_0x2fa007(0x21d)]['id']}});if(!_0x11aec6){const _0x50e49c=await(0x0,exports[_0x2fa007(0x211)])(_0x6d4071),_0x5a75fb=(0x0,wbot_1['getWbot'])(_0x54ae5c['whatsappId']),_0x4ed342=await downloadMedia(_0x6d4071);if(!_0x4ed342)throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');if(!_0x4ed342[_0x2fa007(0x276)]){const _0x20d395=typeof _0x4ed342[_0x2fa007(0x219)]===_0x2fa007(0x2b4)&&_0x4ed342[_0x2fa007(0x219)][_0x2fa007(0x299)]('/')&&_0x4ed342[_0x2fa007(0x219)][_0x2fa007(0x299)](';')?mime_1[_0x2fa007(0x224)][_0x2fa007(0x232)](_0x4ed342['mimetype']):_0x2fa007(0x307);_0x4ed342['filename']=new Date()[_0x2fa007(0x2df)]()+'.'+_0x20d395;}else{let _0x51333d=_0x4ed342[_0x2fa007(0x276)]?'-'+_0x4ed342[_0x2fa007(0x276)]:'';_0x4ed342[_0x2fa007(0x276)]=''+new Date()[_0x2fa007(0x2df)]()+_0x51333d;}try{const _0x31aa06=_0x2fa007(0x183)+_0x54ae5c[_0x2fa007(0x341)];!fs_2[_0x2fa007(0x224)][_0x2fa007(0x2b1)](_0x31aa06)&&(fs_2[_0x2fa007(0x224)]['mkdirSync'](_0x31aa06),fs_2[_0x2fa007(0x224)][_0x2fa007(0x2ac)](_0x31aa06,0x1ff)),await writeFileAsync((0x0,path_1[_0x2fa007(0x210)])(__dirname,'..','..','..',_0x31aa06,_0x4ed342[_0x2fa007(0x276)]),_0x4ed342[_0x2fa007(0x2c9)],_0x2fa007(0x340));}catch(_0x117983){Sentry[_0x2fa007(0x244)](_0x117983),logger_1['logger']['error'](_0x117983);}const _0x29941d=(0x0,exports[_0x2fa007(0x1e9)])(_0x6d4071);var _0x322a34=getTypeMessage(_0x6d4071);const _0x443a38={'id':_0x6d4071[_0x2fa007(0x21d)]['id'],'ticketId':_0x54ae5c['id'],'contactId':_0x6d4071[_0x2fa007(0x21d)][_0x2fa007(0x178)]?undefined:_0x323fc4['id'],'body':_0x29941d?(0x0,Mustache_1[_0x2fa007(0x224)])(_0x29941d,_0x54ae5c):_0x4ed342[_0x2fa007(0x276)],'fromMe':_0x6d4071[_0x2fa007(0x21d)][_0x2fa007(0x178)],'read':_0x6d4071['key'][_0x2fa007(0x178)],'mediaUrl':_0x4ed342[_0x2fa007(0x276)],'mediaType':typeof _0x4ed342[_0x2fa007(0x219)]==='string'?_0x4ed342[_0x2fa007(0x219)][_0x2fa007(0x342)]('/')[0x0]:_0x2fa007(0x307),'quotedMsgId':_0x50e49c?.['id'],'ack':getStatus(_0x6d4071,_0x2fa007(0x2b9)),'remoteJid':_0x6d4071[_0x2fa007(0x21d)][_0x2fa007(0x1f3)],'participant':_0x6d4071['key']['participant'],'dataJson':JSON[_0x2fa007(0x260)](_0x6d4071)};var _0xfc03fb=_0x29941d||_0x4ed342[_0x2fa007(0x276)];typeof _0xfc03fb!=_0x2fa007(0x2b4)&&console['trace'](_0x2fa007(0x1be),_0xfc03fb),await _0x54ae5c[_0x2fa007(0x19e)]({'lastMessage':_0xfc03fb}),_0x11aec6=await(0x0,CreateMessageService_1[_0x2fa007(0x224)])({'messageData':_0x443a38,'ticket':_0x54ae5c,'companyId':_0x54ae5c[_0x2fa007(0x341)]});}else typeof _0x11aec6[_0x2fa007(0x22a)]!=_0x2fa007(0x2b4)&&console['trace'](_0x2fa007(0x1be),_0x11aec6[_0x2fa007(0x22a)]),await _0x54ae5c[_0x2fa007(0x19e)]({'lastMessage':_0x11aec6[_0x2fa007(0x22a)]}),_0x11aec6['ack']=getStatus(_0x6d4071,_0x2fa007(0x2b9)),_0x11aec6['participant']=_0x6d4071[_0x2fa007(0x21d)][_0x2fa007(0x27d)],_0x11aec6[_0x2fa007(0x2af)]=JSON[_0x2fa007(0x260)](_0x6d4071),await _0x11aec6['save']();return!_0x6d4071[_0x2fa007(0x21d)]['fromMe']&&_0x54ae5c['status']===_0x2fa007(0x26a)&&(await _0x54ae5c[_0x2fa007(0x19e)]({'status':'pending'}),await _0x54ae5c['reload']({'include':[{'model':Queue_1[_0x2fa007(0x224)],'as':_0x2fa007(0x318)},{'model':User_1['default'],'as':_0x2fa007(0x281)},{'model':Contact_1[_0x2fa007(0x224)],'as':_0x2fa007(0x2d7)}]}),_0x2ef092['to'](_0x2fa007(0x20f)+_0x54ae5c['companyId']+_0x2fa007(0x22e))[_0x2fa007(0x33f)](_0x2fa007(0x20f)+_0x54ae5c[_0x2fa007(0x341)]+_0x2fa007(0x22c),{'action':_0x2fa007(0x1b2),'ticket':_0x54ae5c,'ticketId':_0x54ae5c['id']}),_0x2ef092['to'](_0x2fa007(0x20f)+_0x54ae5c[_0x2fa007(0x341)]+'-'+_0x54ae5c['status'])['to'](_0x54ae5c['id'][_0x2fa007(0x308)]())[_0x2fa007(0x33f)](_0x2fa007(0x20f)+_0x54ae5c[_0x2fa007(0x341)]+_0x2fa007(0x22c),{'action':'update','ticket':_0x54ae5c,'ticketId':_0x54ae5c['id']})),_0x11aec6;};function getStatus(_0x2e852e,_0x1e3dae){const _0x3cef80=a558_0x58848f;if(_0x2e852e[_0x3cef80(0x285)]==baileys_1[_0x3cef80(0x26d)][_0x3cef80(0x194)][_0x3cef80(0x33d)][_0x3cef80(0x32d)]){if(_0x2e852e[_0x3cef80(0x21d)]['fromMe']&&_0x1e3dae==_0x3cef80(0x325))return 0x3;return 0x1;}else{if(_0x2e852e[_0x3cef80(0x285)]==baileys_1[_0x3cef80(0x26d)]['WebMessageInfo']['Status'][_0x3cef80(0x1c9)])return 0x1;else{if(_0x2e852e['status']==baileys_1[_0x3cef80(0x26d)][_0x3cef80(0x194)][_0x3cef80(0x33d)][_0x3cef80(0x218)])return 0x2;else{if(_0x2e852e['status']==baileys_1[_0x3cef80(0x26d)][_0x3cef80(0x194)]['Status'][_0x3cef80(0x29a)]||_0x2e852e[_0x3cef80(0x285)]==baileys_1[_0x3cef80(0x26d)][_0x3cef80(0x194)][_0x3cef80(0x33d)][_0x3cef80(0x24b)])return 0x3;}}}return 0x0;}const verifyMessage=async(_0x1de06,_0x3dcd4d,_0x2c1b98)=>{const _0x2cd21c=a558_0x58848f,_0x2260a3=(0x0,socket_1[_0x2cd21c(0x197)])(),_0x59f8a5=await(0x0,exports[_0x2cd21c(0x211)])(_0x1de06),_0x35df17=(0x0,exports[_0x2cd21c(0x1e9)])(_0x1de06);if(!_0x35df17)return;let _0x5bd015=getTypeMessage(_0x1de06);const _0x3ae55a=_0x5bd015=='editedMessage'||_0x1de06?.[_0x2cd21c(0x20c)]?.[_0x2cd21c(0x21e)]?.[_0x2cd21c(0x1d9)]==baileys_1[_0x2cd21c(0x26d)][_0x2cd21c(0x177)][_0x2cd21c(0x261)]['Type']['MESSAGE_EDIT']||_0x1de06?.[_0x2cd21c(0x20c)]?.['protocolMessage']?.['editedMessage']?.[_0x2cd21c(0x2e6)]?.[_0x2cd21c(0x236)]>0x0;let _0x1f1ed8=_0x1de06[_0x2cd21c(0x21d)]['id'];if(_0x5bd015==_0x2cd21c(0x21e))_0x1f1ed8=_0x1de06?.[_0x2cd21c(0x20c)]?.[_0x2cd21c(0x21e)]?.[_0x2cd21c(0x21d)]?.['id']||_0x1de06[_0x2cd21c(0x21d)]['id'];else _0x5bd015==_0x2cd21c(0x193)&&(_0x1f1ed8=_0x1de06?.[_0x2cd21c(0x20c)]?.[_0x2cd21c(0x193)]?.[_0x2cd21c(0x20c)]?.[_0x2cd21c(0x21e)]?.[_0x2cd21c(0x21d)]?.['id']||_0x1de06[_0x2cd21c(0x21d)]['id']);const _0x243802={'id':_0x1f1ed8,'ticketId':_0x3dcd4d['id'],'contactId':_0x1de06[_0x2cd21c(0x21d)][_0x2cd21c(0x178)]?undefined:_0x2c1b98['id'],'body':_0x35df17,'fromMe':_0x1de06['key'][_0x2cd21c(0x178)],'mediaType':_0x5bd015,'read':_0x1de06[_0x2cd21c(0x21d)][_0x2cd21c(0x178)],'quotedMsgId':_0x59f8a5?.['id'],'ack':getStatus(_0x1de06,_0x5bd015),'remoteJid':_0x1de06['key']['remoteJid'],'participant':_0x1de06[_0x2cd21c(0x21d)]['participant'],'dataJson':JSON[_0x2cd21c(0x260)](_0x1de06),'isEdited':_0x3ae55a};typeof _0x35df17!=_0x2cd21c(0x2b4)&&console['trace']('body\x20is\x20not\x20a\x20string',_0x35df17);await _0x3dcd4d['update']({'lastMessage':_0x35df17});if(_0x3ae55a){let _0x3602fa=await Message_1[_0x2cd21c(0x224)][_0x2cd21c(0x214)](_0x243802['id']);if(_0x3602fa){const _0x1b6d27={'messageId':_0x243802['id'],'body':_0x3602fa[_0x2cd21c(0x22a)]};await OldMessage_1['default'][_0x2cd21c(0x31e)](_0x1b6d27);}else console[_0x2cd21c(0x2da)](_0x2cd21c(0x23a)+_0x243802['id']);}await(0x0,CreateMessageService_1[_0x2cd21c(0x224)])({'messageData':_0x243802,'ticket':_0x3dcd4d,'companyId':_0x3dcd4d['companyId']}),!_0x1de06[_0x2cd21c(0x21d)][_0x2cd21c(0x178)]&&_0x3dcd4d[_0x2cd21c(0x285)]===_0x2cd21c(0x26a)&&(await _0x3dcd4d[_0x2cd21c(0x19e)]({'status':_0x2cd21c(0x1da)}),await _0x3dcd4d[_0x2cd21c(0x29d)]({'include':[{'model':Queue_1['default'],'as':_0x2cd21c(0x318)},{'model':User_1[_0x2cd21c(0x224)],'as':_0x2cd21c(0x281)},{'model':Contact_1['default'],'as':_0x2cd21c(0x2d7)}]}),_0x2260a3['to'](_0x2cd21c(0x20f)+_0x3dcd4d[_0x2cd21c(0x341)]+'-closed')[_0x2cd21c(0x33f)](_0x2cd21c(0x20f)+_0x3dcd4d[_0x2cd21c(0x341)]+_0x2cd21c(0x22c),{'action':'delete','ticket':_0x3dcd4d,'ticketId':_0x3dcd4d['id']}),_0x2260a3['to'](_0x2cd21c(0x20f)+_0x3dcd4d[_0x2cd21c(0x341)]+'-'+_0x3dcd4d[_0x2cd21c(0x285)])['to'](_0x3dcd4d['id']['toString']())['emit'](_0x2cd21c(0x20f)+_0x3dcd4d[_0x2cd21c(0x341)]+_0x2cd21c(0x22c),{'action':_0x2cd21c(0x19e),'ticket':_0x3dcd4d,'ticketId':_0x3dcd4d['id']}));};exports[a558_0x58848f(0x2c4)]=verifyMessage;const isValidMsg=_0x59c5e9=>{const _0x347a86=a558_0x58848f;if(_0x59c5e9[_0x347a86(0x21d)][_0x347a86(0x1f3)]==='status@broadcast')return![];try{const _0x15da42=getTypeMessage(_0x59c5e9);if(!_0x15da42)return![];const _0x35e567=_0x15da42===_0x347a86(0x2e6)||_0x15da42===_0x347a86(0x193)||_0x15da42===_0x347a86(0x343)||_0x15da42===_0x347a86(0x333)||_0x15da42===_0x347a86(0x32c)||_0x15da42===_0x347a86(0x20e)||_0x15da42===_0x347a86(0x2e3)||_0x15da42===_0x347a86(0x20a)||_0x15da42===_0x347a86(0x1bb)||_0x15da42===_0x347a86(0x2a3)||_0x15da42===_0x347a86(0x21c)||_0x15da42==='documentWithCaptionMessage'||_0x15da42==='stickerMessage'||_0x15da42===_0x347a86(0x2ea)||_0x15da42==='buttonsMessage'||_0x15da42==='messageContextInfo'||_0x15da42===_0x347a86(0x30b)||_0x15da42===_0x347a86(0x1a8)||_0x15da42===_0x347a86(0x25a)||_0x15da42===_0x347a86(0x286)||_0x15da42==='mediaMessage'||_0x15da42==='contactsArrayMessage'||_0x15da42===_0x347a86(0x325)||_0x15da42===_0x347a86(0x18a)||_0x15da42==='protocolMessage'||_0x15da42===_0x347a86(0x18f)||_0x15da42==='listMessage'||_0x15da42==='viewOnceMessage'||_0x15da42===_0x347a86(0x2ef)||_0x15da42===_0x347a86(0x248)||_0x15da42===_0x347a86(0x2fa);return!_0x35e567&&(logger_1[_0x347a86(0x31c)][_0x347a86(0x245)](_0x347a86(0x265)+_0x15da42+'\x0a'+JSON[_0x347a86(0x260)](_0x59c5e9?.[_0x347a86(0x20c)])),Sentry[_0x347a86(0x2c6)]('Mensagem',{'BodyMsg':_0x59c5e9[_0x347a86(0x20c)],'msg':_0x59c5e9,'msgType':_0x15da42}),Sentry[_0x347a86(0x244)](new Error('Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg'))),!!_0x35e567;}catch(_0x4c8900){Sentry['setExtra']('Error\x20isValidMsg',{'msg':_0x59c5e9}),Sentry[_0x347a86(0x244)](_0x4c8900);}return![];};exports['isValidMsg']=isValidMsg;const Push=_0x428b77=>{const _0x202ffc=a558_0x58848f;return _0x428b77[_0x202ffc(0x284)];},verifyQueue=async(_0x53417a,_0xe5c6ef,_0x50b770,_0x5ce9ef,_0x367c2a)=>{const _0x2c8fb7=a558_0x58848f,_0x5bd9de=_0x50b770[_0x2c8fb7(0x341)],{queues:_0x37a42b,greetingMessage:_0x254c93,maxUseBotQueues:_0x28c667,timeUseBotQueues:_0x5225e6}=await(0x0,ShowWhatsAppService_1[_0x2c8fb7(0x224)])(_0x53417a['id'],_0x50b770['companyId']);if(_0x37a42b[_0x2c8fb7(0x236)]===0x1){const _0x18e292=(0x0,lodash_1[_0x2c8fb7(0x2a6)])(_0x37a42b);let _0x4c552e=![];_0x18e292?.['options']&&(_0x4c552e=_0x18e292[_0x2c8fb7(0x330)]['length']>0x0);const _0x113a83=await Setting_1['default']['findOne']({'where':{'key':_0x2c8fb7(0x1f5),'companyId':_0x50b770[_0x2c8fb7(0x341)]}});greetingMessageControl['push']({'ticketId':_0x50b770['id'],'greetingMessage':_0x254c93,'companyId':_0x5bd9de});if(_0x254c93[_0x2c8fb7(0x236)]>0x1&&_0x113a83?.['value']===_0x2c8fb7(0x191)){const _0x32863a=await Message_1['default'][_0x2c8fb7(0x32f)]({'where':{'ticketId':_0x50b770['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x2c8fb7(0x2f6)]]:(0x0,moment_1[_0x2c8fb7(0x224)])()[_0x2c8fb7(0x2ba)](0x5,_0x2c8fb7(0x2eb))[_0x2c8fb7(0x2db)]()}}});if(_0x32863a)return;const _0x25e9da=(0x0,Mustache_1[_0x2c8fb7(0x224)])(''+_0x254c93,_0x50b770);await _0x53417a[_0x2c8fb7(0x2c7)](_0x5ce9ef['number']+'@'+(_0x50b770[_0x2c8fb7(0x335)]?_0x2c8fb7(0x28d):_0x2c8fb7(0x17c)),{'text':_0x25e9da});}const _0x421d06=await(0x0,ShowWhatsAppService_1['default'])(_0x53417a['id'],_0x5bd9de),_0x566406=_0x37a42b[0x0]?.[_0x2c8fb7(0x230)]||_0x421d06[_0x2c8fb7(0x230)];if(!_0xe5c6ef['key']['fromMe']&&!_0x50b770[_0x2c8fb7(0x335)]&&!(0x0,lodash_1[_0x2c8fb7(0x1d1)])(_0x566406)){const _0x37f1a3=await(0x0,ShowQueueIntegrationService_1[_0x2c8fb7(0x224)])(_0x566406,_0x5bd9de);await(0x0,exports[_0x2c8fb7(0x2f4)])(_0xe5c6ef,_0x53417a,_0x37f1a3,_0x50b770),await _0x50b770[_0x2c8fb7(0x19e)]({'useIntegration':!![],'integrationId':_0x37f1a3['id']});}const _0x115aed=_0x37a42b[0x0]?.[_0x2c8fb7(0x2f7)]||_0x421d06[_0x2c8fb7(0x2f7)];!_0xe5c6ef[_0x2c8fb7(0x21d)][_0x2c8fb7(0x178)]&&!_0x50b770[_0x2c8fb7(0x335)]&&!(0x0,lodash_1[_0x2c8fb7(0x1d1)])(_0x115aed)&&(console[_0x2c8fb7(0x2da)](_0x2c8fb7(0x255)),await handleOpenAi(_0xe5c6ef,_0x53417a,_0x50b770,_0x5ce9ef,_0x367c2a),await _0x50b770[_0x2c8fb7(0x19e)]({'useIntegration':!![],'promptId':_0x115aed}));await(0x0,UpdateTicketService_1[_0x2c8fb7(0x224)])({'ticketData':{'queueId':_0x18e292?.['id'],'chatbot':_0x4c552e,'status':_0x2c8fb7(0x1da)},'ticketId':_0x50b770['id'],'companyId':_0x50b770[_0x2c8fb7(0x341)]});return;}const _0x31f0f0=_0xe5c6ef?.[_0x2c8fb7(0x20c)]?.['buttonsResponseMessage']?.[_0x2c8fb7(0x344)]||_0xe5c6ef?.[_0x2c8fb7(0x20c)]?.['listResponseMessage']?.[_0x2c8fb7(0x2f3)]?.[_0x2c8fb7(0x1e2)]||_0xe5c6ef?.[_0x2c8fb7(0x20c)]?.['extendedTextMessage']?.['text']||_0xe5c6ef?.[_0x2c8fb7(0x20c)]?.[_0x2c8fb7(0x2e6)];let _0x54282d=null;if(_0x31f0f0&&!(0x0,exports[_0x2c8fb7(0x29c)])(_0x31f0f0)||+_0x31f0f0>_0x37a42b[_0x2c8fb7(0x236)]){const _0x5b3f0d=_0x31f0f0[_0x2c8fb7(0x18b)]();for(let _0x8e9e0a of _0x37a42b){if(_0x8e9e0a[_0x2c8fb7(0x29e)][_0x2c8fb7(0x18b)]()===_0x5b3f0d){_0x54282d=_0x8e9e0a;break;}if(_0x8e9e0a[_0x2c8fb7(0x2fc)]&&_0x8e9e0a[_0x2c8fb7(0x2fc)][_0x2c8fb7(0x236)]>0x0){let _0x5b682a=_0x8e9e0a[_0x2c8fb7(0x2fc)][_0x2c8fb7(0x342)](',\x20');for(let _0x462372 of _0x5b682a){if(_0x462372['toLowerCase']()==_0x5b3f0d){_0x54282d=_0x8e9e0a;break;}}}}}else _0x54282d=_0x37a42b[+_0x31f0f0-0x1];const _0x202b69=await Setting_1[_0x2c8fb7(0x224)]['findOne']({'where':{'key':_0x2c8fb7(0x2a4),'companyId':_0x5bd9de}}),_0x496d8e=async()=>{const _0x1bc858=_0x2c8fb7;let _0x2a6c3e='';if(outOfHourMessageControl['length']>0x1388)outOfHourMessageControl=[];_0x37a42b[_0x1bc858(0x1f7)]((_0x4a898e,_0x27e159)=>{const _0x195917=_0x1bc858;_0x2a6c3e+='*[\x20'+(_0x27e159+0x1)+_0x195917(0x301)+_0x4a898e[_0x195917(0x29e)]+'\x0a';});if(process['env']['CHATBOT_RESTRICT_NUMBER']?.['length']>=0x8){if(_0x50b770['contact'][_0x1bc858(0x1f9)]!=process['env'][_0x1bc858(0x238)]){console['trace'](_0x1bc858(0x205));return;}}const _0x57b449={'text':(0x0,Mustache_1[_0x1bc858(0x224)])('‎'+_0x254c93+'\x0a\x0a'+_0x2a6c3e,_0x50b770)};await(0x0,UpdateTicketService_1[_0x1bc858(0x224)])({'ticketData':{'amountUsedBotQueues':_0x50b770['amountUsedBotQueues']+0x1},'ticketId':_0x50b770['id'],'companyId':_0x50b770[_0x1bc858(0x341)]});const _0xc743aa=await _0x53417a[_0x1bc858(0x2c7)](_0x5ce9ef['number']+'@'+(_0x50b770[_0x1bc858(0x335)]?_0x1bc858(0x28d):'s.whatsapp.net'),_0x57b449);await(0x0,exports[_0x1bc858(0x2c4)])(_0xc743aa,_0x50b770,_0x50b770['contact']);};if(_0x54282d){let _0x23fb99=![];_0x54282d?.[_0x2c8fb7(0x330)]&&(_0x23fb99=_0x54282d[_0x2c8fb7(0x330)][_0x2c8fb7(0x236)]>0x0);await(0x0,UpdateTicketService_1[_0x2c8fb7(0x224)])({'ticketData':{'queueId':_0x54282d['id'],'chatbot':_0x23fb99,'status':_0x2c8fb7(0x1da),'amountUsedBotQueues':0x0},'ticketId':_0x50b770['id'],'companyId':_0x50b770[_0x2c8fb7(0x341)]}),console[_0x2c8fb7(0x2ec)](_0x54282d['options']);if(_0x54282d[_0x2c8fb7(0x330)][_0x2c8fb7(0x236)]===0x0){const _0xd73c74=await Queue_1['default'][_0x2c8fb7(0x214)](_0x54282d['id']),{schedules:_0x41f133}=_0xd73c74,_0x4c679f=(0x0,moment_1['default'])(),_0x1c2dc6=_0x4c679f['format'](_0x2c8fb7(0x1a3))[_0x2c8fb7(0x18b)]();let _0x298da1;Array[_0x2c8fb7(0x223)](_0x41f133)&&_0x41f133[_0x2c8fb7(0x236)]>0x0&&(_0x298da1=_0x41f133[_0x2c8fb7(0x1d3)](_0x55664c=>_0x55664c[_0x2c8fb7(0x24e)]===_0x1c2dc6&&_0x55664c[_0x2c8fb7(0x1dd)]!==''&&_0x55664c['startTime']!==null&&_0x55664c['endTime']!==''&&_0x55664c[_0x2c8fb7(0x312)]!==null));if(_0xd73c74[_0x2c8fb7(0x243)]!==null&&_0xd73c74[_0x2c8fb7(0x243)]!==''&&!(0x0,lodash_1[_0x2c8fb7(0x1d1)])(_0x298da1)){var _0x19e25a=outOfHourMessageControl['find'](_0x192769=>_0x192769[_0x2c8fb7(0x241)]===_0x50b770['id']||_0x192769[_0x2c8fb7(0x24d)]===_0x5ce9ef[_0x2c8fb7(0x1f9)]);if(!_0x19e25a||_0x19e25a&&_0x19e25a[_0x2c8fb7(0x331)]+0x3e8*0x3c*0x5<new Date()['getTime']()){_0x19e25a&&(outOfHourMessageControl=outOfHourMessageControl[_0x2c8fb7(0x17d)](_0x4d5eab=>_0x4d5eab[_0x2c8fb7(0x241)]!==_0x50b770['id']),_0x19e25a=null);const _0x422562=(0x0,moment_1[_0x2c8fb7(0x224)])(_0x298da1[_0x2c8fb7(0x1dd)],_0x2c8fb7(0x222)),_0x8905c9=(0x0,moment_1[_0x2c8fb7(0x224)])(_0x298da1[_0x2c8fb7(0x312)],_0x2c8fb7(0x222));outOfHourMessageControl[_0x2c8fb7(0x1cf)]({'ticketId':_0x50b770['id'],'time':new Date()['getTime']()});if(_0x4c679f[_0x2c8fb7(0x1d4)](_0x422562)||_0x4c679f[_0x2c8fb7(0x2dc)](_0x8905c9)){const _0x206417=(0x0,Mustache_1['default'])('‎\x20'+_0xd73c74[_0x2c8fb7(0x243)]+'\x0a\x0a*[\x20#\x20]*\x20-\x20Voltar\x20ao\x20Menu\x20Principal',_0x50b770),_0x471310=await _0x53417a[_0x2c8fb7(0x2c7)](_0x5ce9ef[_0x2c8fb7(0x1f9)]+'@'+(_0x50b770[_0x2c8fb7(0x335)]?_0x2c8fb7(0x28d):_0x2c8fb7(0x17c)),{'text':_0x206417});await(0x0,exports[_0x2c8fb7(0x2c4)])(_0x471310,_0x50b770,_0x5ce9ef),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':null,'chatbot':_0x23fb99},'ticketId':_0x50b770['id'],'companyId':_0x50b770[_0x2c8fb7(0x341)]}),console[_0x2c8fb7(0x2da)](_0x2c8fb7(0x1e5));return;}}!_0x19e25a&&outOfHourMessageControl[_0x2c8fb7(0x1cf)]({'ticketId':_0x50b770['id'],'dest':_0x5ce9ef[_0x2c8fb7(0x1f9)],'time':new Date()[_0x2c8fb7(0x2df)]()});}console[_0x2c8fb7(0x2ec)](_0x54282d['integrationId']);if(!_0xe5c6ef[_0x2c8fb7(0x21d)]['fromMe']&&!_0x50b770[_0x2c8fb7(0x335)]&&_0x54282d[_0x2c8fb7(0x230)]){const _0x5a5c4d=await(0x0,ShowQueueIntegrationService_1[_0x2c8fb7(0x224)])(_0x54282d[_0x2c8fb7(0x230)],_0x5bd9de);await(0x0,exports[_0x2c8fb7(0x2f4)])(_0xe5c6ef,_0x53417a,_0x5a5c4d,_0x50b770),await _0x50b770[_0x2c8fb7(0x19e)]({'useIntegration':!![],'integrationId':_0x5a5c4d['id']});}!_0xe5c6ef[_0x2c8fb7(0x21d)][_0x2c8fb7(0x178)]&&!_0x50b770['isGroup']&&!(0x0,lodash_1[_0x2c8fb7(0x1d1)])(_0x54282d?.[_0x2c8fb7(0x2f7)])&&(await handleOpenAi(_0xe5c6ef,_0x53417a,_0x50b770,_0x5ce9ef,_0x367c2a),await _0x50b770[_0x2c8fb7(0x19e)]({'useIntegration':!![],'promptId':_0x54282d?.[_0x2c8fb7(0x2f7)]}));const _0x547424=(0x0,Mustache_1[_0x2c8fb7(0x224)])('‎'+_0x54282d[_0x2c8fb7(0x30a)],_0x50b770);if(_0x54282d[_0x2c8fb7(0x30a)]){const _0x10d6fd=await _0x53417a['sendMessage'](_0x5ce9ef['number']+'@'+(_0x50b770[_0x2c8fb7(0x335)]?_0x2c8fb7(0x28d):_0x2c8fb7(0x17c)),{'text':_0x547424});await(0x0,exports[_0x2c8fb7(0x2c4)])(_0x10d6fd,_0x50b770,_0x5ce9ef);if(_0x54282d[_0x2c8fb7(0x1d8)]!==null&&_0x54282d[_0x2c8fb7(0x1d8)]!==''){const _0x1a500=path_1[_0x2c8fb7(0x224)][_0x2c8fb7(0x1c4)]('public',_0x2c8fb7(0x2f8)+_0x54282d[_0x2c8fb7(0x341)],_0x54282d[_0x2c8fb7(0x1d8)]),_0x2f3a9d=await(0x0,SendWhatsAppMedia_1[_0x2c8fb7(0x234)])(_0x54282d[_0x2c8fb7(0x2c5)],_0x1a500,null,_0x50b770['companyId']);let _0xb3f061=await _0x53417a[_0x2c8fb7(0x2c7)](_0x50b770[_0x2c8fb7(0x2d7)][_0x2c8fb7(0x1f9)]+'@'+(_0x50b770[_0x2c8fb7(0x335)]?_0x2c8fb7(0x28d):_0x2c8fb7(0x17c)),{..._0x2f3a9d});await verifyMediaMessage(_0xb3f061,_0x50b770,_0x5ce9ef);}}}}else{if(_0x28c667&&_0x28c667!==0x0&&_0x50b770[_0x2c8fb7(0x2e4)]>=_0x28c667)return;const _0x38d947=await(0x0,FindOrCreateATicketTrakingService_1[_0x2c8fb7(0x224)])({'ticketId':_0x50b770['id'],'companyId':_0x5bd9de});let _0x133826=new Date(),_0x356c0f=new Date();if(_0x38d947[_0x2c8fb7(0x17b)]!==null){_0x133826['setMinutes'](_0x38d947[_0x2c8fb7(0x17b)][_0x2c8fb7(0x2fe)]()+Number(_0x5225e6));if(_0x38d947[_0x2c8fb7(0x17b)]!==null&&_0x356c0f<_0x133826&&_0x5225e6!=='0'&&_0x50b770[_0x2c8fb7(0x2e4)]!==0x0)return;}await _0x38d947['update']({'updatedAt':new Date()});if(_0x202b69['value']==='text')return console[_0x2c8fb7(0x2ec)]('botText'),_0x496d8e();}},verifyRating=_0x186a13=>{const _0xa8b854=a558_0x58848f;return _0x186a13&&_0x186a13[_0xa8b854(0x2a7)]===null&&_0x186a13[_0xa8b854(0x1f6)]!==null&&_0x186a13[_0xa8b854(0x28f)]!==null;};exports['verifyRating']=verifyRating;const handleRating=async(_0x517c88,_0x31b14d,_0x453404)=>{const _0x5c3142=a558_0x58848f,_0x59a3d3=(0x0,socket_1[_0x5c3142(0x197)])();let _0xcc9d7f=null;(_0x517c88?.[_0x5c3142(0x20c)]?.[_0x5c3142(0x2e6)]||_0x517c88?.[_0x5c3142(0x20c)]?.['extendedTextMessage'])&&(_0xcc9d7f=parseInt(_0x517c88[_0x5c3142(0x20c)][_0x5c3142(0x2e6)]||_0x517c88[_0x5c3142(0x20c)]['extendedTextMessage'][_0x5c3142(0x2f0)],0xa)||null);if(!Number[_0x5c3142(0x199)](_0xcc9d7f)&&Number[_0x5c3142(0x31d)](_0xcc9d7f)&&!(0x0,lodash_1[_0x5c3142(0x2b0)])(_0xcc9d7f)){const {complationMessage:_0x1aa859}=await(0x0,ShowWhatsAppService_1[_0x5c3142(0x224)])(_0x31b14d[_0x5c3142(0x306)],_0x31b14d['companyId']);let _0x1f8048=_0xcc9d7f;_0xcc9d7f<0x1&&(_0x1f8048=0x1);_0xcc9d7f>0x5&&(_0x1f8048=0x5);await UserRating_1['default'][_0x5c3142(0x1b3)]({'ticketId':_0x453404[_0x5c3142(0x241)],'companyId':_0x453404[_0x5c3142(0x341)],'userId':_0x453404[_0x5c3142(0x1f6)],'rate':_0x1f8048});if(_0x1aa859){if(completionMessageControl[_0x5c3142(0x236)]>=0x9c4)completionMessageControl=[];var _0x4a6328=completionMessageControl[_0x5c3142(0x1d3)](_0x33fc02=>_0x33fc02[_0x5c3142(0x241)]===_0x31b14d['id']||_0x33fc02[_0x5c3142(0x24d)]===_0x31b14d[_0x5c3142(0x2d7)][_0x5c3142(0x1f9)]);if(!_0x4a6328||_0x4a6328&&_0x4a6328['time']+0x3e8*0x3c*0x1e<new Date()[_0x5c3142(0x2df)]()){_0x4a6328&&(completionMessageControl=completionMessageControl[_0x5c3142(0x17d)](_0x365a18=>_0x365a18[_0x5c3142(0x241)]!==_0x31b14d['id']),_0x4a6328=null);const _0x2714c0=(0x0,Mustache_1[_0x5c3142(0x224)])('‎'+_0x1aa859,_0x31b14d);await(0x0,SendPresenceStatus_1[_0x5c3142(0x264)])((0x0,wbot_1[_0x5c3142(0x228)])(_0x31b14d[_0x5c3142(0x306)]),_0x31b14d[_0x5c3142(0x2d7)][_0x5c3142(0x1f9)]+'@'+(_0x31b14d[_0x5c3142(0x335)]?'g.us':_0x5c3142(0x17c))),await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x2714c0,'ticket':_0x31b14d});}!_0x4a6328&&completionMessageControl[_0x5c3142(0x1cf)]({'ticketId':_0x31b14d['id'],'dest':_0x31b14d[_0x5c3142(0x2d7)][_0x5c3142(0x1f9)],'time':new Date()['getTime']()});}await _0x453404['update']({'finishedAt':(0x0,moment_1['default'])()[_0x5c3142(0x2db)](),'ratedAt':(0x0,moment_1[_0x5c3142(0x224)])()[_0x5c3142(0x2db)](),'rated':!![]}),await _0x31b14d['update']({'queueId':null,'chatbot':null,'queueOptionId':null,'userId':null,'status':_0x5c3142(0x26a)}),_0x59a3d3['to'](_0x5c3142(0x20f)+_0x31b14d['companyId']+'-open')[_0x5c3142(0x33f)](_0x5c3142(0x20f)+_0x31b14d[_0x5c3142(0x341)]+_0x5c3142(0x22c),{'action':'delete','ticket':_0x31b14d,'ticketId':_0x31b14d['id']}),_0x59a3d3['to'](_0x5c3142(0x20f)+_0x31b14d[_0x5c3142(0x341)]+'-'+_0x31b14d['status'])['to'](_0x31b14d['id'][_0x5c3142(0x308)]())[_0x5c3142(0x33f)](_0x5c3142(0x20f)+_0x31b14d['companyId']+_0x5c3142(0x22c),{'action':_0x5c3142(0x19e),'ticket':_0x31b14d,'ticketId':_0x31b14d['id']});}};exports[a558_0x58848f(0x269)]=handleRating;const handleChartbot=async(_0x791373,_0x36912e,_0x7efd61,_0x30e6f4,_0x387a6e=![])=>{const _0x298f53=a558_0x58848f;if(!_0x791373[_0x298f53(0x2d7)][_0x298f53(0x2be)]){const _0x173492=await Queue_1[_0x298f53(0x224)][_0x298f53(0x214)](_0x791373[_0x298f53(0x1d6)],{'include':[{'model':QueueOption_1['default'],'as':_0x298f53(0x330),'where':{'parentId':null},'order':[['option',_0x298f53(0x2c2)],[_0x298f53(0x21b),'ASC']]}]}),_0x220a34=_0x36912e?.['message']?.[_0x298f53(0x2ea)]?.[_0x298f53(0x344)]||_0x36912e?.[_0x298f53(0x20c)]?.['listResponseMessage']?.[_0x298f53(0x2f3)]?.[_0x298f53(0x1e2)]||_0x36912e?.[_0x298f53(0x20c)]?.[_0x298f53(0x343)]?.[_0x298f53(0x2f0)]||_0x36912e?.[_0x298f53(0x20c)]?.[_0x298f53(0x2e6)];if(_0x220a34=='#'&&(!_0x791373['userId']||_0x791373[_0x298f53(0x285)]==_0x298f53(0x1da))){console[_0x298f53(0x2ec)](_0x298f53(0x215)),await _0x791373[_0x298f53(0x19e)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x7efd61,_0x36912e,_0x791373,_0x791373[_0x298f53(0x2d7)]);return;}if(!(0x0,lodash_1[_0x298f53(0x1d1)])(_0x173492)&&!(0x0,lodash_1['isNil'])(_0x791373[_0x298f53(0x336)])&&_0x220a34=='0'){console[_0x298f53(0x2ec)]('primeiro\x20if');const _0x10310b=await QueueOption_1[_0x298f53(0x224)][_0x298f53(0x214)](_0x791373[_0x298f53(0x336)]);await _0x791373[_0x298f53(0x19e)]({'queueOptionId':_0x10310b?.[_0x298f53(0x21a)],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1[_0x298f53(0x1d1)])(_0x173492)&&!(0x0,lodash_1['isNil'])(_0x791373['queueOptionId'])){console[_0x298f53(0x2ec)]('segundo\x20if');const _0x5373fd=await QueueOption_1[_0x298f53(0x224)][_0x298f53(0x1b8)]({'where':{'parentId':_0x791373[_0x298f53(0x336)]}});let _0x2bfda4={};_0x5373fd==0x1?_0x2bfda4=await QueueOption_1[_0x298f53(0x224)][_0x298f53(0x32f)]({'where':{'parentId':_0x791373[_0x298f53(0x336)]}}):(console['trace'](_0x298f53(0x2e9)),_0x2bfda4=await QueueOption_1[_0x298f53(0x224)]['findOne']({'where':{[sequelize_1['Op']['or']]:[{'option':_0x220a34||''},{'title':_0x220a34||''}],'parentId':_0x791373[_0x298f53(0x336)]}})),_0x2bfda4&&await _0x791373[_0x298f53(0x19e)]({'queueOptionId':_0x2bfda4?.['id'],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1['isNil'])(_0x173492)&&(0x0,lodash_1['isNil'])(_0x791373['queueOptionId'])&&!_0x387a6e){console[_0x298f53(0x2ec)](_0x298f53(0x220));const _0x21cf5a=_0x173492?.[_0x298f53(0x330)]['find'](_0x5d19a2=>_0x5d19a2[_0x298f53(0x1f0)]==_0x220a34||_0x5d19a2[_0x298f53(0x2c3)][_0x298f53(0x18b)]()==_0x220a34['toLowerCase']());if(_0x21cf5a)await _0x791373[_0x298f53(0x19e)]({'queueOptionId':_0x21cf5a?.['id'],'amountUsedBotQueues':0x0});else{if(_0x30e6f4[_0x298f53(0x320)]&&_0x30e6f4['maxUseBotQueues']!==0x0&&_0x791373[_0x298f53(0x2e4)]>=_0x30e6f4[_0x298f53(0x320)])return;await _0x791373[_0x298f53(0x19e)]({'amountUsedBotQueues':_0x791373[_0x298f53(0x2e4)]+0x1});}}else{if(_0x30e6f4[_0x298f53(0x320)]&&_0x30e6f4['maxUseBotQueues']!==0x0&&_0x791373[_0x298f53(0x2e4)]>=_0x30e6f4[_0x298f53(0x320)])return;await _0x791373['update']({'amountUsedBotQueues':_0x791373['amountUsedBotQueues']+0x1});}}}await _0x791373[_0x298f53(0x29d)]();if(!(0x0,lodash_1[_0x298f53(0x1d1)])(_0x173492)&&(0x0,lodash_1[_0x298f53(0x1d1)])(_0x791373[_0x298f53(0x336)])){const _0x821736=await QueueOption_1[_0x298f53(0x224)][_0x298f53(0x1ca)]({'where':{'queueId':_0x791373[_0x298f53(0x1d6)],'parentId':null},'order':[[_0x298f53(0x1f0),'ASC'],[_0x298f53(0x21b),_0x298f53(0x2c2)]]}),_0xc01e8e=_0x791373['companyId'],_0x469f0f=await Setting_1[_0x298f53(0x224)][_0x298f53(0x32f)]({'where':{'key':_0x298f53(0x2a4),'companyId':_0xc01e8e}}),_0x3374ef=async()=>{const _0xb8d99f=_0x298f53,_0x3da732=[];_0x821736[_0xb8d99f(0x1f7)]((_0x4dfcdb,_0x1bcc88)=>{const _0x279d7e=_0xb8d99f;_0x3da732[_0x279d7e(0x1cf)]({'buttonId':''+_0x4dfcdb[_0x279d7e(0x1f0)],'buttonText':{'displayText':_0x4dfcdb['title']},'type':0x4});}),_0x3da732['push']({'buttonId':'#','buttonText':{'displayText':_0xb8d99f(0x217)},'type':0x4});const _0x2f6795={'text':(0x0,Mustache_1[_0xb8d99f(0x224)])('‎'+_0x173492['greetingMessage'],_0x791373),'buttons':_0x3da732,'footer':_0xb8d99f(0x226),'headerType':0x1},_0xac41bc=await _0x7efd61['sendMessage'](_0x791373[_0xb8d99f(0x2d7)][_0xb8d99f(0x1f9)]+'@'+(_0x791373['isGroup']?_0xb8d99f(0x28d):_0xb8d99f(0x17c)),_0x2f6795);await(0x0,exports[_0xb8d99f(0x2c4)])(_0xac41bc,_0x791373,_0x791373[_0xb8d99f(0x2d7)]);},_0x3cfe80=async()=>{const _0x1d88e4=_0x298f53;let _0x5c59c0='';console[_0x1d88e4(0x2ec)](_0x1d88e4(0x179)),console[_0x1d88e4(0x2da)](_0x173492[_0x1d88e4(0x1d8)]),_0x821736[_0x1d88e4(0x1f7)]((_0x3758ab,_0x566670)=>{const _0x4ffd11=_0x1d88e4;_0x5c59c0+='*[\x20'+_0x3758ab[_0x4ffd11(0x1f0)]+'\x20]*\x20-\x20'+_0x3758ab['title']+'\x0a';}),_0x5c59c0+=_0x1d88e4(0x1b9);const _0x57668b={'text':(0x0,Mustache_1[_0x1d88e4(0x224)])('‎'+_0x173492['greetingMessage']+'\x0a\x0a'+_0x5c59c0,_0x791373)};let _0x3af5d3;if(!_0x173492[_0x1d88e4(0x1d8)])_0x3af5d3=await _0x7efd61[_0x1d88e4(0x2c7)](_0x791373[_0x1d88e4(0x2d7)]['number']+'@'+(_0x791373[_0x1d88e4(0x335)]?_0x1d88e4(0x28d):_0x1d88e4(0x17c)),_0x57668b),await(0x0,exports[_0x1d88e4(0x2c4)])(_0x3af5d3,_0x791373,_0x791373[_0x1d88e4(0x2d7)]);else{const _0x5542f4=path_1[_0x1d88e4(0x224)][_0x1d88e4(0x1c4)](_0x1d88e4(0x345),_0x1d88e4(0x2f8)+_0x791373['companyId'],_0x173492[_0x1d88e4(0x1d8)]),_0x42568f=await(0x0,SendWhatsAppMedia_1[_0x1d88e4(0x234)])(_0x57668b[_0x1d88e4(0x2f0)],_0x5542f4,_0x57668b[_0x1d88e4(0x2f0)],_0x791373[_0x1d88e4(0x341)]);_0x3af5d3=await _0x7efd61[_0x1d88e4(0x2c7)](_0x791373['contact'][_0x1d88e4(0x1f9)]+'@'+(_0x791373[_0x1d88e4(0x335)]?'g.us':_0x1d88e4(0x17c)),{..._0x42568f}),await verifyMediaMessage(_0x3af5d3,_0x791373,_0x791373[_0x1d88e4(0x2d7)]);}};if(_0x469f0f['value']===_0x298f53(0x2d6)&&QueueOption_1[_0x298f53(0x224)]['length']<=0x4)return _0x3374ef();if(_0x469f0f[_0x298f53(0x221)]===_0x298f53(0x2f0))return console[_0x298f53(0x2ec)](_0x298f53(0x179)),_0x3cfe80();if(_0x469f0f[_0x298f53(0x221)]===_0x298f53(0x2d6)&&QueueOption_1[_0x298f53(0x224)][_0x298f53(0x236)]>0x4)return console['trace'](_0x298f53(0x179)),_0x3cfe80();}else{if(!(0x0,lodash_1[_0x298f53(0x1d1)])(_0x173492)&&!(0x0,lodash_1['isNil'])(_0x791373['queueOptionId'])){const _0xabc4a2=await QueueOption_1[_0x298f53(0x224)][_0x298f53(0x214)](_0x791373['queueOptionId']),_0x4687df=await QueueOption_1[_0x298f53(0x224)][_0x298f53(0x1ca)]({'where':{'parentId':_0x791373[_0x298f53(0x336)]},'order':[[_0x298f53(0x1f0),'ASC'],[_0x298f53(0x21b),_0x298f53(0x2c2)]]});if(_0x4687df[_0x298f53(0x236)]===0x0){const _0x4b46ff={'text':(0x0,Mustache_1[_0x298f53(0x224)])('‎'+_0xabc4a2[_0x298f53(0x20c)],_0x791373)},_0x4fd466=await _0x7efd61['sendMessage'](_0x791373['contact'][_0x298f53(0x1f9)]+'@'+(_0x791373[_0x298f53(0x335)]?_0x298f53(0x28d):_0x298f53(0x17c)),_0x4b46ff);await(0x0,exports[_0x298f53(0x2c4)])(_0x4fd466,_0x791373,_0x791373[_0x298f53(0x2d7)]),await _0x791373[_0x298f53(0x19e)]({'queueOptionId':null,'chatbot':![]});return;}if(_0x4687df[_0x298f53(0x236)]>-0x1){const _0x56f817=_0x791373['companyId'],_0x21e0c1=await Setting_1[_0x298f53(0x224)][_0x298f53(0x32f)]({'where':{'key':_0x298f53(0x2a4),'companyId':_0x56f817}}),_0x38556c=async()=>{const _0x2ca46c=_0x298f53,_0x4dc383=[],_0x5834f3=_0x791373[_0x2ca46c(0x341)],_0x5e8b61=await getQueues(_0x5834f3),_0x470c24=await getContactFromTicket(_0x791373['id']);_0x5e8b61[_0x2ca46c(0x1f7)]((_0x940d3c,_0x20eadc)=>{const _0x527853=_0x2ca46c;_0x4dc383[_0x527853(0x1cf)]({'title':'['+(_0x20eadc+0x1)+_0x527853(0x1eb)+_0x940d3c['name'],'rowId':''+(_0x20eadc+0x1)});});const _0x50c9db=[{'rows':_0x4dc383}],_0x51aba8={'text':(0x0,Mustache_1['default'])('‎'+_0xabc4a2[_0x2ca46c(0x20c)],_0x791373),'title':_0x2ca46c(0x258),'buttonText':'Escolha\x20uma\x20opção','sections':_0x50c9db};await sleep(0x3e8);const _0x277aaf=await _0x7efd61[_0x2ca46c(0x2c7)](_0x2ca46c(0x28e)+_0x470c24[_0x2ca46c(0x1f9)]+'@'+(_0x791373[_0x2ca46c(0x335)]?_0x2ca46c(0x28d):_0x2ca46c(0x17c)),_0x51aba8);await(0x0,exports['verifyMessage'])(_0x277aaf,_0x791373,_0x791373['contact']);},_0x56d670=async()=>{const _0x8b171a=_0x298f53,_0x13a0e6=[];_0x4687df[_0x8b171a(0x1f7)]((_0x5b56b1,_0x438ec3)=>{const _0x340043=_0x8b171a;_0x13a0e6[_0x340043(0x1cf)]({'buttonId':''+_0x5b56b1[_0x340043(0x1f0)],'buttonText':{'displayText':_0x5b56b1[_0x340043(0x2c3)]},'type':0x4});}),_0x13a0e6[_0x8b171a(0x1cf)]({'buttonId':'#','buttonText':{'displayText':_0x8b171a(0x217)},'type':0x4});const _0x195066={'text':(0x0,Mustache_1['default'])('‎'+_0xabc4a2[_0x8b171a(0x20c)],_0x791373),'buttons':_0x13a0e6,'headerType':0x4};if(process[_0x8b171a(0x227)]['CHATBOT_RESTRICT_NUMBER']?.[_0x8b171a(0x236)]>=0x8){if(_0x791373[_0x8b171a(0x2d7)]['number']!=process[_0x8b171a(0x227)][_0x8b171a(0x238)]){console[_0x8b171a(0x2ec)]('chatbot\x20desativado!');return;}}if(!_0xabc4a2[_0x8b171a(0x1d8)]){const _0x58e105=await _0x7efd61['sendMessage'](_0x791373[_0x8b171a(0x2d7)][_0x8b171a(0x1f9)]+'@'+(_0x791373[_0x8b171a(0x335)]?_0x8b171a(0x28d):'s.whatsapp.net'),_0x195066);await(0x0,exports[_0x8b171a(0x2c4)])(_0x58e105,_0x791373,_0x791373[_0x8b171a(0x2d7)]);}else{const _0x503f78=path_1[_0x8b171a(0x224)][_0x8b171a(0x1c4)]('public',_0x8b171a(0x2f8)+_0x791373[_0x8b171a(0x341)],_0xabc4a2['mediaPath']),_0x3b3e88=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0xabc4a2[_0x8b171a(0x2c5)],_0x503f78,_0x195066[_0x8b171a(0x2f0)],_0x791373['companyId']);let _0x5bde4f=await _0x7efd61['sendMessage'](_0x791373[_0x8b171a(0x2d7)][_0x8b171a(0x1f9)]+'@'+(_0x791373[_0x8b171a(0x335)]?_0x8b171a(0x28d):_0x8b171a(0x17c)),{..._0x3b3e88});await verifyMediaMessage(_0x5bde4f,_0x791373,_0x791373['contact']);}const _0xb9660b=await _0x7efd61[_0x8b171a(0x2c7)](_0x791373['contact'][_0x8b171a(0x1f9)]+'@'+(_0x791373['isGroup']?_0x8b171a(0x28d):'s.whatsapp.net'),_0x195066);await(0x0,exports[_0x8b171a(0x2c4)])(_0xb9660b,_0x791373,_0x791373[_0x8b171a(0x2d7)]);},_0x26daa9=async()=>{const _0x3a16ba=_0x298f53;let _0x151a94='';_0x4687df['forEach']((_0x46835d,_0x4732e7)=>{const _0x47fe13=a558_0x54f9;_0x151a94+='*[\x20'+_0x46835d[_0x47fe13(0x1f0)]+'\x20]*\x20-\x20'+_0x46835d[_0x47fe13(0x2c3)]+'\x0a';}),_0x151a94+=_0x3a16ba(0x2ca),_0x151a94+=_0x3a16ba(0x1b9);const _0x3b737e={'text':(0x0,Mustache_1[_0x3a16ba(0x224)])('‎'+_0xabc4a2[_0x3a16ba(0x20c)]+'\x0a\x0a'+_0x151a94,_0x791373)};if(process[_0x3a16ba(0x227)][_0x3a16ba(0x238)]?.[_0x3a16ba(0x236)]>=0x8){if(_0x791373['contact']['number']!=process[_0x3a16ba(0x227)][_0x3a16ba(0x238)]){console[_0x3a16ba(0x2ec)](_0x3a16ba(0x205));return;}}if(!_0xabc4a2[_0x3a16ba(0x1d8)]){const _0x1c134b=await _0x7efd61['sendMessage'](_0x791373[_0x3a16ba(0x2d7)]['number']+'@'+(_0x791373[_0x3a16ba(0x335)]?_0x3a16ba(0x28d):_0x3a16ba(0x17c)),_0x3b737e);await(0x0,exports['verifyMessage'])(_0x1c134b,_0x791373,_0x791373[_0x3a16ba(0x2d7)]);}else{const _0x40999e=path_1[_0x3a16ba(0x224)][_0x3a16ba(0x1c4)]('public',_0x3a16ba(0x2f8)+_0x791373[_0x3a16ba(0x341)],_0xabc4a2['mediaPath']),_0x25e85d=await(0x0,SendWhatsAppMedia_1[_0x3a16ba(0x234)])(_0xabc4a2[_0x3a16ba(0x2c5)],_0x40999e,_0x3b737e[_0x3a16ba(0x2f0)],_0x791373[_0x3a16ba(0x341)]);let _0x433d5a=await _0x7efd61['sendMessage'](_0x791373[_0x3a16ba(0x2d7)][_0x3a16ba(0x1f9)]+'@'+(_0x791373[_0x3a16ba(0x335)]?'g.us':_0x3a16ba(0x17c)),{..._0x25e85d});await verifyMediaMessage(_0x433d5a,_0x791373,_0x791373['contact']);}};if(_0x21e0c1[_0x298f53(0x221)]===_0x298f53(0x2ce))return _0x38556c();if(_0x21e0c1[_0x298f53(0x221)]===_0x298f53(0x2d6)&&QueueOption_1['default'][_0x298f53(0x236)]<=0x4)return _0x56d670();if(_0x21e0c1[_0x298f53(0x221)]==='text')return console[_0x298f53(0x2ec)](_0x298f53(0x2fd)),_0x26daa9();if(_0x21e0c1[_0x298f53(0x221)]===_0x298f53(0x2d6)&&QueueOption_1[_0x298f53(0x224)][_0x298f53(0x236)]>0x4)return console[_0x298f53(0x2ec)]('botText\x202'),_0x26daa9();}}}}},handleMessageIntegration=async(_0x4d2c25,_0x1f5bf0,_0xabe4f0,_0x5a8e78)=>{const _0x41b342=a558_0x58848f;if(process[_0x41b342(0x227)][_0x41b342(0x238)]){if(_0x5a8e78[_0x41b342(0x2d7)]['number']!=process['env'][_0x41b342(0x238)]){console[_0x41b342(0x2da)](_0x41b342(0x205));return;}}const _0x40d236=getTypeMessage(_0x4d2c25);if(_0xabe4f0[_0x41b342(0x1d9)]===_0x41b342(0x1e0)||_0xabe4f0[_0x41b342(0x1d9)]===_0x41b342(0x328)){if(_0xabe4f0?.[_0x41b342(0x263)]){const _0x3c402b={'method':'POST','url':_0xabe4f0?.[_0x41b342(0x263)],'headers':{'Content-Type':_0x41b342(0x1b7)},'json':_0x4d2c25};try{(0x0,request_1[_0x41b342(0x224)])(_0x3c402b,function(_0x327eb6,_0x44f355){const _0x514b0f=_0x41b342;if(_0x327eb6)throw new Error(_0x327eb6);else console['log'](_0x44f355[_0x514b0f(0x22a)]);});}catch(_0x4d8839){throw new Error(_0x4d8839);}}}else _0xabe4f0[_0x41b342(0x1d9)]===_0x41b342(0x1ce)&&await(0x0,typebotListener_1[_0x41b342(0x224)])({'ticket':_0x5a8e78,'msg':_0x4d2c25,'wbot':_0x1f5bf0,'typebot':_0xabe4f0});};exports[a558_0x58848f(0x2f4)]=handleMessageIntegration;const messageContainsMedia=_0x596da3=>{const _0x3419a7=a558_0x58848f;return _0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x2a3)]||_0x596da3[_0x3419a7(0x20c)]?.['audioMessage']||_0x596da3['message']?.[_0x3419a7(0x32c)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x275)]||_0x596da3[_0x3419a7(0x20c)]?.['documentMessage']||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x321)]?.[_0x3419a7(0x20c)]?.['documentMessage']||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x18a)]?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x333)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x18a)]?.['message']?.['documentMessage']||_0x596da3[_0x3419a7(0x20c)]?.['ephemeralMessage']?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x32c)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x18a)]?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x275)]||_0x596da3[_0x3419a7(0x20c)]?.['ephemeralMessage']?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x2a3)]||_0x596da3[_0x3419a7(0x20c)]?.['viewOnceMessage']?.['message']?.[_0x3419a7(0x2a3)]||_0x596da3[_0x3419a7(0x20c)]?.['viewOnceMessage']?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x32c)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x18a)]?.['message']?.[_0x3419a7(0x33b)]?.['message']?.[_0x3419a7(0x2a3)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x18a)]?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x33b)]?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x32c)]||_0x596da3['message']?.[_0x3419a7(0x18a)]?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x33b)]?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x333)]||_0x596da3['message']?.[_0x3419a7(0x18a)]?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x33b)]?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x21c)]||_0x596da3['message']?.[_0x3419a7(0x321)]?.[_0x3419a7(0x20c)]?.[_0x3419a7(0x21c)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x2e3)]?.['hydratedTemplate']?.['imageMessage']||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x2e3)]?.[_0x3419a7(0x216)]?.[_0x3419a7(0x21c)]||_0x596da3[_0x3419a7(0x20c)]?.['templateMessage']?.['hydratedTemplate']?.[_0x3419a7(0x32c)]||_0x596da3['message']?.[_0x3419a7(0x2e3)]?.[_0x3419a7(0x334)]?.[_0x3419a7(0x2a3)]||_0x596da3[_0x3419a7(0x20c)]?.['templateMessage']?.['hydratedFourRowTemplate']?.[_0x3419a7(0x21c)]||_0x596da3['message']?.[_0x3419a7(0x2e3)]?.[_0x3419a7(0x334)]?.[_0x3419a7(0x32c)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x2e3)]?.[_0x3419a7(0x311)]?.['imageMessage']||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x2e3)]?.[_0x3419a7(0x311)]?.[_0x3419a7(0x21c)]||_0x596da3['message']?.[_0x3419a7(0x2e3)]?.[_0x3419a7(0x311)]?.['videoMessage']||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x1bb)]?.[_0x3419a7(0x26b)]?.[_0x3419a7(0x2a3)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x1bb)]?.[_0x3419a7(0x26b)]?.[_0x3419a7(0x21c)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x1bb)]?.[_0x3419a7(0x26b)]?.[_0x3419a7(0x32c)]||_0x596da3[_0x3419a7(0x20c)]?.['highlyStructuredMessage']?.[_0x3419a7(0x2ee)]?.['hydratedTemplate']?.[_0x3419a7(0x21c)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x2fa)]?.[_0x3419a7(0x2ee)]?.['hydratedTemplate']?.[_0x3419a7(0x32c)]||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x2fa)]?.[_0x3419a7(0x2ee)]?.[_0x3419a7(0x216)]?.['imageMessage']||_0x596da3[_0x3419a7(0x20c)]?.[_0x3419a7(0x2fa)]?.[_0x3419a7(0x2ee)]?.['hydratedTemplate']?.[_0x3419a7(0x30b)];},handleMessage=async(_0x2ea5d9,_0x54cac8,_0x45391e,_0x2a52f1=![])=>{const _0x2b25a9=a558_0x58848f;if(_0x2a52f1){console[_0x2b25a9(0x2da)]('Importando\x20mensagens!!');let _0x5488a6=_0x2ea5d9['key']['id'],_0x242655=await Message_1[_0x2b25a9(0x224)]['count']({'where':{'id':_0x5488a6}});if(_0x242655>0x0){await new Promise(_0x246905=>setTimeout(_0x246905,0x96));return;}else await new Promise(_0x428690=>setTimeout(_0x428690,0x14a));}let _0x56eb39;if(!(0x0,exports[_0x2b25a9(0x1bf)])(_0x2ea5d9)){console['log'](_0x2b25a9(0x28b)),console[_0x2b25a9(0x2da)](_0x2ea5d9);return;}_0x2ea5d9['message']?.[_0x2b25a9(0x18a)]&&(_0x2ea5d9[_0x2b25a9(0x20c)]=_0x2ea5d9[_0x2b25a9(0x20c)][_0x2b25a9(0x18a)][_0x2b25a9(0x20c)]);try{let _0x26251c;const _0x360109=_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x1f3)]?.[_0x2b25a9(0x305)]('@g.us'),_0x15e1ce=await Setting_1[_0x2b25a9(0x224)][_0x2b25a9(0x32f)]({'where':{'companyId':_0x45391e,'key':_0x2b25a9(0x198)}});if(_0x15e1ce?.[_0x2b25a9(0x221)]===_0x2b25a9(0x191)&&_0x360109){console[_0x2b25a9(0x2da)](_0x2b25a9(0x202));return;}let _0x45b037=(0x0,exports[_0x2b25a9(0x1e9)])(_0x2ea5d9);const _0x28a658=getTypeMessage(_0x2ea5d9);typeof _0x45b037===_0x2b25a9(0x2b4)&&(_0x45b037=_0x45b037[_0x2b25a9(0x233)](/\u200c/,''));const _0x3781ff=messageContainsMedia(_0x2ea5d9);if(_0x2ea5d9['key'][_0x2b25a9(0x178)]){if(!_0x3781ff&&_0x28a658!==_0x2b25a9(0x2e6)&&_0x28a658!=='extendedTextMessage'&&_0x28a658!==_0x2b25a9(0x29b)&&_0x28a658!=='contactMessage'&&_0x28a658!==_0x2b25a9(0x18a)&&_0x28a658!=='protocolMessage'&&_0x28a658!==_0x2b25a9(0x325)&&_0x28a658!==_0x2b25a9(0x33b)&&_0x28a658!=='locationMessage'&&_0x28a658!=='hydratedContentText'&&_0x28a658!=='advertising'){console[_0x2b25a9(0x2ec)](_0x28a658);return;}}const _0x136a82=await(0x0,ShowWhatsAppService_1[_0x2b25a9(0x224)])(_0x54cac8['id'],_0x45391e);let _0x3edf83,_0x56fd6f=await getContactMessage(_0x2ea5d9,_0x54cac8);_0x26251c=await verifyContact(_0x56fd6f,_0x54cac8,_0x45391e);if(_0x360109){if(!_0x136a82[_0x2b25a9(0x19a)])return;try{const _0x32e5e5=await _0x54cac8[_0x2b25a9(0x296)](_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x1f3)]),_0x19ba52={'id':_0x32e5e5['id'],'name':_0x32e5e5[_0x2b25a9(0x2a2)]};_0x3edf83=await verifyContact(_0x19ba52,_0x54cac8,_0x45391e);}catch(_0x5539b8){console[_0x2b25a9(0x2da)](_0x2b25a9(0x26f)),console[_0x2b25a9(0x2da)](_0x5539b8);return;}}let _0x1ec906=0x0;if(_0x2ea5d9['key'][_0x2b25a9(0x178)])await cache_1[_0x2b25a9(0x290)][_0x2b25a9(0x25b)]('contacts:'+_0x26251c['id']+':unreads','0');else{const _0x4aa06a=await cache_1['cacheLayer'][_0x2b25a9(0x295)]('contacts:'+_0x26251c['id']+_0x2b25a9(0x201));_0x1ec906=+_0x4aa06a+0x1,await cache_1[_0x2b25a9(0x290)][_0x2b25a9(0x25b)]('contacts:'+_0x26251c['id']+_0x2b25a9(0x201),''+_0x1ec906);}const _0x1d6260=await(0x0,FindOrCreateTicketService_1[_0x2b25a9(0x224)])(_0x26251c,_0x54cac8['id'],_0x1ec906,_0x45391e,_0x3edf83,_0x2a52f1),_0x1c2613=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x1d6260['id'],'companyId':_0x45391e,'whatsappId':_0x136a82?.['id']});_0x1c2613[_0x2b25a9(0x271)](_0x2b25a9(0x2d3),!![]),await _0x1c2613[_0x2b25a9(0x19e)]({'updatedAt':new Date()}),await(0x0,providers_1['provider'])(_0x1d6260,_0x2ea5d9,_0x45391e,_0x26251c,_0x54cac8);if(_0x136a82[_0x2b25a9(0x267)]&&_0x1ec906===0x0){const _0x3a1664=await Message_1[_0x2b25a9(0x224)][_0x2b25a9(0x32f)]({'where':{'contactId':_0x26251c['id'],'companyId':_0x45391e},'order':[[_0x2b25a9(0x21b),_0x2b25a9(0x292)]]});if((0x0,Mustache_1[_0x2b25a9(0x224)])(_0x136a82[_0x2b25a9(0x267)],_0x1d6260)[_0x2b25a9(0x17f)]()['toLowerCase']()===_0x3a1664?.[_0x2b25a9(0x22a)]['trim']()[_0x2b25a9(0x18b)]())return;}if(_0x45b037=='#'&&!_0x2a52f1&&(!_0x1d6260[_0x2b25a9(0x1f6)]||_0x1d6260['status']=='pending')){await _0x1d6260[_0x2b25a9(0x19e)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x54cac8,_0x2ea5d9,_0x1d6260,_0x1d6260['contact']);return;}try{if(!_0x2ea5d9['key'][_0x2b25a9(0x178)]&&!_0x2a52f1){if(_0x45b037!=null&&typeof _0x45b037!=='string'){console['log'](_0x45b037),console['trace'](_0x2b25a9(0x324),typeof _0x45b037);return;}if(_0x45b037?.[_0x2b25a9(0x203)]()===_0x2b25a9(0x33c)&&_0x1d6260[_0x2b25a9(0x285)]!='closed'){await(0x0,SendPresenceStatus_1[_0x2b25a9(0x264)])(_0x54cac8,_0x1d6260[_0x2b25a9(0x2d7)][_0x2b25a9(0x1f9)]+'@'+(_0x1d6260['isGroup']?_0x2b25a9(0x28d):'s.whatsapp.net'));const _0x54f56f=await _0x54cac8[_0x2b25a9(0x2c7)](_0x1d6260[_0x2b25a9(0x2d7)]['number']+'@'+(_0x1d6260[_0x2b25a9(0x335)]?_0x2b25a9(0x28d):'s.whatsapp.net'),{'text':_0x2b25a9(0x289)});await(0x0,exports[_0x2b25a9(0x2c4)])(_0x54f56f,_0x1d6260,_0x1d6260[_0x2b25a9(0x2d7)]),await(0x0,UpdateTicketService_1[_0x2b25a9(0x224)])({'ticketData':{'queueId':null,'status':_0x2b25a9(0x26a)},'ticketId':_0x1d6260['id'],'companyId':_0x1d6260[_0x2b25a9(0x341)]}),await _0x1d6260['reload']();return;}}}catch(_0x235be4){console['log'](_0x2b25a9(0x1c1)),console[_0x2b25a9(0x2da)](_0x235be4),Sentry['captureException'](_0x235be4);}try{await _0x1d6260[_0x2b25a9(0x19e)]({'fromMe':_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x178)]});}catch(_0x5caf20){console[_0x2b25a9(0x2da)](_0x2b25a9(0x1cb)),console[_0x2b25a9(0x2da)](_0x5caf20),Sentry[_0x2b25a9(0x244)](_0x5caf20);}try{if(!_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x178)]){if((0x0,exports[_0x2b25a9(0x2dd)])(_0x1c2613)){await(0x0,exports[_0x2b25a9(0x269)])(_0x2ea5d9,_0x1d6260,_0x1c2613),console[_0x2b25a9(0x2da)](_0x2b25a9(0x1fd)+_0x2ea5d9);return;}}}catch(_0x4c3933){console[_0x2b25a9(0x2da)](_0x2b25a9(0x2c8)),Sentry['captureException'](_0x4c3933),console[_0x2b25a9(0x2da)](_0x4c3933);}_0x3781ff?_0x56eb39=await verifyMediaMessage(_0x2ea5d9,_0x1d6260,_0x26251c):await(0x0,exports[_0x2b25a9(0x2c4)])(_0x2ea5d9,_0x1d6260,_0x26251c);const _0x451a8f=await(0x0,VerifyCurrentSchedule_1[_0x2b25a9(0x224)])(_0x45391e),_0x50e92b=await Setting_1['default'][_0x2b25a9(0x32f)]({'where':{'companyId':_0x45391e,'key':'scheduleType'}});if(!_0x2ea5d9[_0x2b25a9(0x21d)]['fromMe']&&_0x50e92b&&!_0x2a52f1)await handleOutOfHour(_0x54cac8,_0x1d6260,_0x50e92b,_0x26251c,_0x451a8f,_0x136a82);!_0x1d6260[_0x2b25a9(0x318)]&&!_0x360109&&!_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x178)]&&!_0x1d6260['userId']&&!(0x0,lodash_1[_0x2b25a9(0x1d1)])(_0x136a82[_0x2b25a9(0x2f7)])&&!_0x2a52f1&&await handleOpenAi(_0x2ea5d9,_0x54cac8,_0x1d6260,_0x26251c,_0x56eb39);if(!_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x178)]&&!_0x1d6260[_0x2b25a9(0x335)]&&!_0x1d6260[_0x2b25a9(0x318)]&&!_0x1d6260['user']&&_0x1d6260[_0x2b25a9(0x180)]&&!(0x0,lodash_1[_0x2b25a9(0x1d1)])(_0x136a82[_0x2b25a9(0x230)])&&!_0x1d6260[_0x2b25a9(0x257)]&&!_0x2a52f1){const _0x36e212=await(0x0,ShowQueueIntegrationService_1[_0x2b25a9(0x224)])(_0x136a82[_0x2b25a9(0x230)],_0x45391e);await(0x0,exports['handleMessageIntegration'])(_0x2ea5d9,_0x54cac8,_0x36e212,_0x1d6260);return;}!_0x360109&&!_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x178)]&&!_0x1d6260['userId']&&!(0x0,lodash_1['isNil'])(_0x1d6260[_0x2b25a9(0x2f7)])&&_0x1d6260[_0x2b25a9(0x257)]&&!_0x2a52f1&&await handleOpenAi(_0x2ea5d9,_0x54cac8,_0x1d6260,_0x26251c,_0x56eb39);if(!_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x178)]&&!_0x1d6260[_0x2b25a9(0x335)]&&!_0x1d6260[_0x2b25a9(0x1f6)]&&_0x1d6260['integrationId']&&_0x1d6260[_0x2b25a9(0x257)]&&!_0x2a52f1){const _0x16d7ae=await(0x0,ShowQueueIntegrationService_1[_0x2b25a9(0x224)])(_0x1d6260['integrationId'],_0x45391e);await(0x0,exports[_0x2b25a9(0x2f4)])(_0x2ea5d9,_0x54cac8,_0x16d7ae,_0x1d6260);}!_0x1d6260[_0x2b25a9(0x318)]&&!_0x1d6260[_0x2b25a9(0x335)]&&!_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x178)]&&!_0x1d6260['userId']&&_0x136a82['queues']['length']>=0x1&&!_0x1d6260['useIntegration']&&!_0x2a52f1&&(await verifyQueue(_0x54cac8,_0x2ea5d9,_0x1d6260,_0x26251c),_0x1c2613[_0x2b25a9(0x271)]('chatbotAt',!![]),_0x1c2613[_0x2b25a9(0x271)](_0x2b25a9(0x2d3),!![]),await _0x1c2613['update']({'chatbotAt':(0x0,moment_1[_0x2b25a9(0x224)])()[_0x2b25a9(0x2db)](),'updatedAt':new Date()}));const _0x48dbd5=_0x1d6260[_0x2b25a9(0x318)]===null;await _0x1d6260[_0x2b25a9(0x29d)]();if(!_0x2a52f1&&_0x136a82[_0x2b25a9(0x30a)])await greetingMessage(_0x54cac8,_0x1d6260,_0x2ea5d9,_0x136a82,_0x360109);_0x136a82[_0x2b25a9(0x208)][_0x2b25a9(0x236)]==0x1&&_0x1d6260['queue']&&!_0x2a52f1&&(_0x1d6260[_0x2b25a9(0x180)]&&!_0x2ea5d9[_0x2b25a9(0x21d)][_0x2b25a9(0x178)]&&!_0x1d6260[_0x2b25a9(0x1f6)]&&await handleChartbot(_0x1d6260,_0x2ea5d9,_0x54cac8,_0x136a82)),_0x136a82[_0x2b25a9(0x208)][_0x2b25a9(0x236)]>0x1&&_0x1d6260[_0x2b25a9(0x318)]&&!_0x2a52f1&&(_0x1d6260['chatbot']&&!_0x2ea5d9[_0x2b25a9(0x21d)]['fromMe']&&!_0x1d6260[_0x2b25a9(0x1f6)]&&await handleChartbot(_0x1d6260,_0x2ea5d9,_0x54cac8,_0x136a82,_0x48dbd5));}catch(_0x2dd761){console[_0x2b25a9(0x2da)](_0x2dd761),Sentry[_0x2b25a9(0x244)](_0x2dd761),logger_1[_0x2b25a9(0x31c)][_0x2b25a9(0x1a5)](_0x2b25a9(0x19d)+_0x2dd761);}};exports[a558_0x58848f(0x28a)]=handleMessage;const handleOutOfHour=async(_0x4fded6,_0x4cb2a0,_0x3d63d1,_0x11d000,_0x508840,_0x245a34)=>{const _0x33e3e7=a558_0x58848f;try{if(outOfHourMessageControl[_0x33e3e7(0x236)]>0x1388)outOfHourMessageControl=[];let _0x3c8cb2=outOfHourMessageControl[_0x33e3e7(0x1d3)](_0x52c74f=>_0x52c74f[_0x33e3e7(0x241)]===_0x4cb2a0['id']||_0x52c74f[_0x33e3e7(0x24d)]===_0x11d000[_0x33e3e7(0x1f9)]);if(_0x3d63d1[_0x33e3e7(0x221)]==='company'&&!(0x0,lodash_1[_0x33e3e7(0x1d1)])(_0x508840)&&_0x245a34[_0x33e3e7(0x243)]&&(!_0x508840||_0x508840[_0x33e3e7(0x1aa)]===![])){if(!_0x3c8cb2||_0x3c8cb2&&_0x3c8cb2['time']+0x3e8*0x3c*0x5<new Date()[_0x33e3e7(0x2df)]()){_0x3c8cb2&&(outOfHourMessageControl=outOfHourMessageControl['filter'](_0x19d7fe=>_0x19d7fe[_0x33e3e7(0x241)]!==_0x4cb2a0['id']),_0x3c8cb2=null);if(!_0x3c8cb2)outOfHourMessageControl[_0x33e3e7(0x1cf)]({'ticketId':_0x4cb2a0['id'],'dest':_0x11d000['number'],'time':new Date()[_0x33e3e7(0x2df)]()});const _0x63c312='‎\x20'+_0x245a34[_0x33e3e7(0x243)],_0x38f231=(0x0,Debounce_1[_0x33e3e7(0x189)])(async()=>{const _0x3c86bd=_0x33e3e7;await _0x4fded6[_0x3c86bd(0x2c7)](_0x4cb2a0[_0x3c86bd(0x2d7)][_0x3c86bd(0x1f9)]+'@'+(_0x4cb2a0[_0x3c86bd(0x335)]?'g.us':_0x3c86bd(0x17c)),{'text':_0x63c312});},(0x0,queues_1['randomValue'])(0x5dc,0xdac),_0x4cb2a0['id']);_0x38f231();return;}}if(_0x3d63d1[_0x33e3e7(0x221)]===_0x33e3e7(0x318)&&_0x4cb2a0[_0x33e3e7(0x1d6)]!==null){const _0x11e2cc=await Queue_1[_0x33e3e7(0x224)][_0x33e3e7(0x214)](_0x4cb2a0[_0x33e3e7(0x1d6)]),{schedules:_0xcc913}=_0x11e2cc,_0x42e2f8=(0x0,moment_1['default'])(),_0x369787=_0x42e2f8[_0x33e3e7(0x231)]('dddd')[_0x33e3e7(0x18b)]();let _0x14a463=null;Array['isArray'](_0xcc913)&&_0xcc913[_0x33e3e7(0x236)]>0x0&&(_0x14a463=_0xcc913['find'](_0x2dddeb=>_0x2dddeb[_0x33e3e7(0x24e)]===_0x369787&&_0x2dddeb['startTime']!==''&&_0x2dddeb['startTime']!==null&&_0x2dddeb[_0x33e3e7(0x312)]!==''&&_0x2dddeb[_0x33e3e7(0x312)]!==null));if(_0x3d63d1[_0x33e3e7(0x221)]===_0x33e3e7(0x318)&&_0x11e2cc[_0x33e3e7(0x243)]!==null&&_0x11e2cc[_0x33e3e7(0x243)]!==''&&!(0x0,lodash_1[_0x33e3e7(0x1d1)])(_0x14a463)){const _0x130bbc=(0x0,moment_1[_0x33e3e7(0x224)])(_0x14a463['startTime'],_0x33e3e7(0x222)),_0x619900=(0x0,moment_1[_0x33e3e7(0x224)])(_0x14a463['endTime'],_0x33e3e7(0x222));let _0xb3d87f=_0x42e2f8[_0x33e3e7(0x1d4)](_0x130bbc)||_0x42e2f8[_0x33e3e7(0x2dc)](_0x619900);if(!_0xb3d87f){if(_0x14a463[_0x33e3e7(0x2b6)]&&_0x14a463[_0x33e3e7(0x1b6)]){const _0x27fcae=(0x0,moment_1[_0x33e3e7(0x224)])(_0x14a463['startLunchTime'],_0x33e3e7(0x222)),_0x1015d1=(0x0,moment_1[_0x33e3e7(0x224)])(_0x14a463[_0x33e3e7(0x1b6)],'HH:mm');_0xb3d87f=_0x42e2f8[_0x33e3e7(0x26e)](_0x27fcae,_0x1015d1);}}if(_0xb3d87f){if(!_0x3c8cb2||_0x3c8cb2&&_0x3c8cb2[_0x33e3e7(0x331)]+0x3e8*0x3c*0x1e<new Date()[_0x33e3e7(0x2df)]()){const _0x3a8ac7=_0x11e2cc['outOfHoursMessage'],_0x55e84f=(0x0,Debounce_1[_0x33e3e7(0x189)])(async()=>{const _0x70ca82=_0x33e3e7;await _0x4fded6[_0x70ca82(0x2c7)](_0x4cb2a0['contact']['number']+'@'+(_0x4cb2a0[_0x70ca82(0x335)]?_0x70ca82(0x28d):_0x70ca82(0x17c)),{'text':_0x3a8ac7});},(0x0,queues_1['randomValue'])(0x3e8,0xbb8),_0x4cb2a0['id']);_0x55e84f();return;}if(!_0x3c8cb2)outOfHourMessageControl[_0x33e3e7(0x1cf)]({'ticketId':_0x4cb2a0['id'],'dest':_0x11d000[_0x33e3e7(0x1f9)],'time':new Date()[_0x33e3e7(0x2df)]()});}}}}catch(_0x4798b7){Sentry[_0x33e3e7(0x244)](_0x4798b7),console[_0x33e3e7(0x2da)](_0x4798b7);}},greetingMessage=async(_0x19a1e9,_0x8cfeb2,_0x244325,_0x4c3877,_0x297808)=>{const _0x30871a=a558_0x58848f;if(!_0x4c3877?.[_0x30871a(0x208)]?.[_0x30871a(0x236)]&&!_0x8cfeb2[_0x30871a(0x1f6)]&&!_0x297808&&!_0x244325['key'][_0x30871a(0x178)]){if(process[_0x30871a(0x227)][_0x30871a(0x238)]?.[_0x30871a(0x236)]>=0x8){if(_0x8cfeb2['contact']['number']!=process[_0x30871a(0x227)]['CHATBOT_RESTRICT_NUMBER'])return;}if(greetingMessageControl['length']>0x1388)greetingMessageControl=[];var _0xcb1212=greetingMessageControl['find'](_0x281b7d=>_0x281b7d[_0x30871a(0x241)]===_0x8cfeb2['id']||_0x281b7d[_0x30871a(0x24d)]===_0x8cfeb2['contact'][_0x30871a(0x1f9)]);if(_0xcb1212&&_0xcb1212[_0x30871a(0x331)]+0x3e8*0x3c*0x5>=new Date()[_0x30871a(0x2df)]())return;const _0x477fd1=await Message_1[_0x30871a(0x224)][_0x30871a(0x32f)]({'where':{'ticketId':_0x8cfeb2['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op']['gte']]:(0x0,moment_1[_0x30871a(0x224)])()[_0x30871a(0x2ba)](0x5,_0x30871a(0x2eb))[_0x30871a(0x2db)]()}}});if(_0x477fd1)return;const _0x417cca=(0x0,Debounce_1[_0x30871a(0x189)])(async()=>{const _0xc903f1=_0x30871a;if(!_0x4c3877[_0xc903f1(0x184)])await _0x19a1e9[_0xc903f1(0x2c7)](_0x8cfeb2[_0xc903f1(0x2d7)][_0xc903f1(0x1f9)]+'@'+(_0x8cfeb2[_0xc903f1(0x335)]?'g.us':'s.whatsapp.net'),{'text':(0x0,Mustache_1[_0xc903f1(0x224)])(_0x4c3877[_0xc903f1(0x30a)],_0x8cfeb2)});else{const _0x484e57=path_1[_0xc903f1(0x224)][_0xc903f1(0x1c4)]('public',_0xc903f1(0x2f8)+_0x8cfeb2[_0xc903f1(0x341)],_0x4c3877[_0xc903f1(0x184)]),_0x4dc9fc=await(0x0,SendWhatsAppMedia_1[_0xc903f1(0x234)])(_0x4c3877[_0xc903f1(0x184)],_0x484e57,_0x4c3877['greetingMessage'],_0x8cfeb2[_0xc903f1(0x341)]);await _0x19a1e9[_0xc903f1(0x2c7)](_0x8cfeb2['contact']['number']+'@'+(_0x8cfeb2[_0xc903f1(0x335)]?_0xc903f1(0x28d):_0xc903f1(0x17c)),{..._0x4dc9fc});}},0x3e8,_0x8cfeb2['id']);_0x417cca();return;}},handleMsgAck=async(_0x2d8ba1,_0x12cb3e)=>{const _0x1979a1=a558_0x58848f,_0x19bb96=(0x0,socket_1[_0x1979a1(0x197)])();try{const _0x2391fe=await Message_1[_0x1979a1(0x224)][_0x1979a1(0x214)](_0x2d8ba1['key']['id'],{'include':[_0x1979a1(0x2d7),{'model':Message_1['default'],'as':'quotedMsg','include':['contact']}]});if(!_0x2391fe){console[_0x1979a1(0x2da)](_0x2d8ba1),console['log']('Mensagem\x20não\x20encontrada!');return;}await _0x2391fe['update']({'ack':_0x12cb3e}),_0x19bb96['to'](_0x2391fe['ticketId'][_0x1979a1(0x308)]())['emit'](_0x1979a1(0x20f)+_0x2391fe[_0x1979a1(0x341)]+'-appMessage',{'action':_0x1979a1(0x19e),'message':_0x2391fe});}catch(_0x492c18){Sentry[_0x1979a1(0x244)](_0x492c18),logger_1['logger'][_0x1979a1(0x1a5)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x492c18);}};exports[a558_0x58848f(0x2d2)]=handleMsgAck;function a558_0x54cd(){const _0x3a1ca7=['companyId','split','extendedTextMessage','selectedButtonId','public','product','Message','fromMe','botText','substring','chatbotAt','s.whatsapp.net','filter','messages.update','trim','chatbot','prompt','SpeechConfig','public/company','greetingMediaAttachment','../../libs/cache','setFfmpegPath','productImage','../../models/QueueOption','debounce','ephemeralMessage','toLowerCase','WAMessageStubType','rate','ERR_WAPP_DOWNLOAD_MEDIA','listResponseMessage','getListMessage','enabled','util','editedMessage','WebMessageInfo','catch','1778990nxVOmA','getIO','CheckMsgIsGroup','isNaN','allowGroup','chat','values','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','update','degreesLatitude','.mp3','../../models/User','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','dddd','SpeechSynthesizer','error','now','messageQueue','liveLocationMessage','next','inActivity','add','templateButtonReplyMessage','EM_ANDAMENTO','../../libs/socket','__esModule','writeFile','hasOwnProperty','delete','create','getContactsArrayMessage','./SendWhatsAppMessage','endLunchTime','application/json','count','\x0a*[\x20#\x20]*\x20-\x20Menu\x20inicial','sequelize','interactiveMessage','system','voice','body\x20is\x20not\x20a\x20string','isValidMsg','getAd','Erro\x20ao\x20salvar\x20mensagem!','fromAudioFileOutput','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','resolve','min','findIndex','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','\x20|\x20https://maps.google.com/maps?q=','SERVER_ACK','findAll','Erro\x20ao\x20salvar\x20ticket!','Mensagem\x20interativa\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','./SendWhatsAppMedia','typebot','push','texto','isNil','Convite\x20Revogado','find','isBefore','getReactionMessage','queueId','CIPHERTEXT','mediaPath','type','pending','quotedMessage','apply','startTime','getPaymentMessage','../../models/OldMessage','n8n','call','selectedRowId','createTranscription','directPath','fora\x20do\x20horario','68381pBYjoY','../../app','contextInfo','getBodyMessage','Failed\x20to\x20fetch\x20queues:',']\x20-\x20','HandleMessageJob','getDocumentMessage','input','getQuotedMessageId','option','../../libs/wbot','Failed\x20to\x20get\x20stream','remoteJid','assistant','sendGreetingMessageOneQueues','userId','forEach','./wbotGetMessageFromType','number','Throttle','prototype','REVOKE','Mensagem\x20inválida\x208!\x20','keys','content','../TypebotServices/typebotListener',':unreads','Mensagem\x20de\x20grupo\x20bloqueada!','toUpperCase','mediaUrl','chatbot\x20desativado!','getViewOnceMessageV2','getCallMessage','queues','18mkictE','pollCreationMessageV3','Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!','message','messages','pollCreationMessageV2','company-','join','verifyQuotedMessage','../MessageServices/CreateMessageService','AudioConfig','findByPk','##\x20if','hydratedTemplate','Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior','DELIVERY_ACK','mimetype','parentId','createdAt','documentMessage','key','protocolMessage','groups.update','quarto\x20if','value','HH:mm','isArray','default','getAudioMessage','DAUMZAP','env','getWbot','@sentry/node','body','verifyCampaignMessageAndCloseTicket','-ticket','Amigo(a)','-closed','../../models/Queue','integrationId','format','extension','replace','getMessageOptions','speakTextAsync','length','removeNonPrintableChars','CHATBOT_RESTRICT_NUMBER','contacts','Mensagem\x20editada\x20não\x20encontrada:\x20','@whiskeysockets/baileys','\x20-\x20Longitude:\x20','./providers','sleep','../TicketServices/FindOrCreateTicketService','../../helpers/SendPresenceStatus','ticketId','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','outOfHoursMessage','captureException','warn','__importDefault','Failed\x20to\x20fetch\x20contact\x20from\x20ticket:','advertising','183064LZolxj','productMessage','PLAYED','externalAdReply','dest','weekdayEn','Nas\x20respostas\x20utilize\x20o\x20nome\x20','degreesLongitude','verifyRecentCampaign','defineProperty','getViewOnceMessage','mp3','\x201286\x20-\x20Entrei\x20na\x20integracao\x20openai.','application/pdf','useIntegration','Lista','readFileSync','contactMessage','set','constructor','\x20MBps','__importStar','pipe','stringify','ProtocolMessage','close','urlN8N','SendPresenceStatus','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','544915asuAZE','complationMessage','makeRandomId','handleRating','closed','header','downloadContentFromMessage','proto','isBetween','Erro\x20ao\x20buscar\x20grupo!','../../helpers/MakeRandomId','changed','maxTokens','../TicketServices/FindOrCreateATicketTrakingService','Produto','stickerMessage','filename','random','makeid','%2C','E2E_DEVICE_CHANGED','voiceKey','../../models/Ticket','participant','getContentType','__setModuleDefault','>>>>\x20erro\x20','user','createReadStream','getBodyButton','pushName','status','voiceMessage','then','getOwnPropertyDescriptor','*Você\x20encerrou\x20este\x20atendimento\x20usando\x20o\x20comando\x20SAIR*.\x0a\x0a\x0aSe\x20você\x20finalizou\x20o\x20atendimento\x20*ANTES*\x20de\x20receber\x20um\x20retorno\x20do\x20operador,\x20ele\x20*NÃO*\x20irá\x20visualizar\x20sua\x20solicitação!\x0a\x0aVocê\x20deve\x20aguardar\x20o\x20retorno\x20do\x20operador\x20e\x20que\x20ele\x20encerre\x20seu\x20atendimento\x20quando\x20necessário.\x0a\x0aUse\x20a\x20opção\x20*SAIR*\x20somente\x20em\x20casos\x20de\x20emergência\x20ou\x20se\x20ficou\x20preso\x20em\x20algum\x20setor.\x0a\x0a\x0aPara\x20iniciar\x20um\x20novo\x20atendimento\x20basta\x20enviar\x20uma\x20nova\x20mensagem!','handleMessage','Mensagem\x20inválida!','test','g.us','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','ratingAt','cacheLayer','../../helpers/Mustache','DESC','E2E_IDENTITY_CHANGED','getLocationMessage','get','groupMetadata','application','data:image/png;base64,\x20','includes','READ','vcard','isNumeric','reload','name','apiKey','getQuotedMessage','stanzaId','subject','imageMessage','chatBotType','toFixed','head','finishedAt','../../models/Contact','fromSubscription','getStickerMessage','../../queues','chmodSync','wbotMessageListener','mime','dataJson','isNull','existsSync','../../utils/logger','lodash','string','from','startLunchTime','audio/mpeg','pt-BR-FabioNeural','media','subtract','870796MebmXV','../../helpers/Debounce','No\x20result\x20from\x20synthesizer','disableBot','../QueueIntegrationServices/ShowQueueIntegrationService','toFormat','end','ASC','title','verifyMessage','mediaName','setExtra','sendMessage','Erro\x20ao\x20salvar\x20avaliação!','data','\x0a*[\x200\x20]*\x20-\x20Menu\x20anterior','pop','OpenAIApi','Atualização\x20de\x20Status','list','unlinkSync','sendMessageImage','voiceRegion','handleMsgAck','updatedAt','-open','../ContactServices/CreateOrUpdateContactService','button','contact','image/jpeg','extractMessageContent','log','toDate','isAfter','verifyRating','createChatCompletion','getTime','moment','117aRvicd','mediaType','templateMessage','amountUsedBotQueues','debug','conversation','choices','389926eekxwL','terceiro\x20if','buttonsResponseMessage','minutes','trace','jidNormalizedUser','hydratedHsm','viewOnceMessageV2','text','\x20Download\x20completed\x20in\x20','writable','singleSelectReply','handleMessageIntegration','(((.+)+)+)+$','gte','promptId','company','Múltiplos\x20Produtos','highlyStructuredMessage','document','keywords','botText\x203','getMinutes','validaCpfCnpj','concat','\x20]*\x20-\x20','map','randomValue','getButtonsMessage','endsWith','whatsappId','unknown','toString','getTextMessage','greetingMessage','locationMessage','3409280KVTqur','whisper-1','getImageMessage','\x20de\x20baixar\x20o\x20arquivo\x20','maxMessages','fourRowTemplate','endTime','public/temp/','Error\x20converting\x20file:\x20','../CompanyService/VerifyCurrentSchedule','contactsArrayMessage','slice','queue','campaignId','../WhatsappService/ShowWhatsAppService','../../models/UserRating','logger','isInteger','upsert','../TicketServices/UpdateTicketService','maxUseBotQueues','documentWithCaptionMessage','Latitude:\x20','speechSynthesisVoiceName','Expected\x20bodyMessage\x20to\x20be\x20a\x20string,\x20got:','reactionMessage','.wav','3fgqlGT','webhook','Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','stream-throttle','save','videoMessage','PENDING','../../models/Message','findOne','options','time','messageStubType','audioMessage','hydratedFourRowTemplate','isGroup','queueOptionId','floor','Erro\x20para\x20responder\x20com\x20audio:\x20','messages.upsert','search','viewOnceMessage','SAIR','Status','gpt-3.5-turbo-1106','emit','base64'];a558_0x54cd=function(){return _0x3a1ca7;};return a558_0x54cd();}const verifyRecentCampaign=async(_0x283fc3,_0x52274f)=>{const _0x501cae=a558_0x58848f;if(!_0x283fc3[_0x501cae(0x21d)][_0x501cae(0x178)]){const _0x1cf514=_0x283fc3[_0x501cae(0x21d)][_0x501cae(0x1f3)][_0x501cae(0x233)](/\D/g,''),_0x53f6b0=await Campaign_1[_0x501cae(0x224)][_0x501cae(0x1ca)]({'where':{'companyId':_0x52274f,'status':_0x501cae(0x1ad),'confirmation':!![]}});if(_0x53f6b0){const _0x547aa6=_0x53f6b0[_0x501cae(0x302)](_0x5624fb=>_0x5624fb['id']),_0x5538d3=await CampaignShipping_1[_0x501cae(0x224)][_0x501cae(0x32f)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x547aa6},'number':_0x1cf514,'confirmation':null}});_0x5538d3&&(await _0x5538d3[_0x501cae(0x19e)]({'confirmedAt':(0x0,moment_1[_0x501cae(0x224)])(),'confirmation':!![]}),await queues_1['campaignQueue'][_0x501cae(0x1ab)]('DispatchCampaign',{'campaignShippingId':_0x5538d3['id'],'campaignId':_0x5538d3[_0x501cae(0x319)]},{'delay':(0x0,queues_1['parseToMilliseconds'])((0x0,queues_1[_0x501cae(0x303)])(0x0,0xa))}));}}};exports[a558_0x58848f(0x251)]=verifyRecentCampaign;function a558_0x54f9(_0x9dc6eb,_0x5907e3){const _0x2f838f=a558_0x54cd();return a558_0x54f9=function(_0x506100,_0x6e1c4e){_0x506100=_0x506100-0x176;let _0x54cd51=_0x2f838f[_0x506100];return _0x54cd51;},a558_0x54f9(_0x9dc6eb,_0x5907e3);}const verifyCampaignMessageAndCloseTicket=async(_0x4a8292,_0x6a047c)=>{const _0x145950=a558_0x58848f,_0x27f02a=(0x0,socket_1[_0x145950(0x197)])(),_0x31efe9=(0x0,exports[_0x145950(0x1e9)])(_0x4a8292),_0x5d04c7=/\u200c/[_0x145950(0x28c)](_0x31efe9);if(_0x4a8292[_0x145950(0x21d)][_0x145950(0x178)]&&_0x5d04c7){const _0x97ad08=await Message_1['default'][_0x145950(0x32f)]({'where':{'id':_0x4a8292[_0x145950(0x21d)]['id'],'companyId':_0x6a047c}}),_0x47a70a=await Ticket_1[_0x145950(0x224)][_0x145950(0x214)](_0x97ad08[_0x145950(0x241)]);await _0x47a70a[_0x145950(0x19e)]({'status':_0x145950(0x26a)}),_0x27f02a['to'](_0x145950(0x20f)+_0x47a70a[_0x145950(0x341)]+_0x145950(0x2d4))['emit']('company-'+_0x47a70a[_0x145950(0x341)]+_0x145950(0x22c),{'action':_0x145950(0x1b2),'ticket':_0x47a70a,'ticketId':_0x47a70a['id']}),_0x27f02a['to'](_0x145950(0x20f)+_0x6a047c+'-'+_0x47a70a[_0x145950(0x285)])['to'](_0x47a70a['id'][_0x145950(0x308)]())[_0x145950(0x33f)](_0x145950(0x20f)+_0x47a70a[_0x145950(0x341)]+_0x145950(0x22c),{'action':_0x145950(0x19e),'ticket':_0x47a70a,'ticketId':_0x47a70a['id']});}};exports[a558_0x58848f(0x22b)]=verifyCampaignMessageAndCloseTicket;const filterMessages=_0x32af79=>{const _0x4556ce=a558_0x58848f;if([baileys_1[_0x4556ce(0x18c)][_0x4556ce(0x1fc)],baileys_1['WAMessageStubType'][_0x4556ce(0x27a)],baileys_1[_0x4556ce(0x18c)][_0x4556ce(0x293)],baileys_1[_0x4556ce(0x18c)][_0x4556ce(0x1d7)]][_0x4556ce(0x299)](_0x32af79[_0x4556ce(0x332)]))return![];return!![];},wbotMessageListener=async(_0x3e7ff6,_0x596cba,_0x233be9)=>{const _0x2ef19e=a558_0x58848f;_0x3e7ff6['ev']['on'](_0x2ef19e(0x339),async _0x2eefe2=>{const _0x3f377c=_0x2ef19e,_0x118852=_0x2eefe2[_0x3f377c(0x20d)][_0x3f377c(0x17d)](filterMessages);if(!_0x118852)return;await app_1[_0x3f377c(0x224)]['get'](_0x3f377c(0x208))[_0x3f377c(0x1a7)]['add'](_0x3f377c(0x1ec),{'whatsappId':_0x233be9['id'],'messages':_0x118852,'companyId':_0x596cba},{'removeOnComplete':!![],'attempts':0x3});}),_0x3e7ff6['ev']['on'](_0x2ef19e(0x17e),async _0x512e5c=>{const _0x3d2fc9=_0x2ef19e;if(_0x512e5c['length']===0x0)return;await app_1[_0x3d2fc9(0x224)][_0x3d2fc9(0x295)](_0x3d2fc9(0x208))[_0x3d2fc9(0x1a7)]['add']('MessageUpdateJob',{'whatsappId':_0x233be9['id'],'messageUpdate':_0x512e5c,'companyId':_0x596cba},{'removeOnComplete':!![],'attempts':0x3,'delay':0x64});}),_0x3e7ff6['ev']['on'](_0x2ef19e(0x21f),async _0x783c41=>{const _0x53524c=_0x2ef19e;console[_0x53524c(0x2da)](_0x783c41);if(_0x783c41[_0x53524c(0x236)]===0x0)return;for(const _0x2c7c3b of _0x783c41){const _0x1fd191=_0x2c7c3b['id'][_0x53524c(0x342)]('@')[0x0],_0x5a4426=_0x2c7c3b[_0x53524c(0x2a2)]||_0x1fd191,_0x10e16c={'name':_0x5a4426,'number':_0x1fd191,'isGroup':!![],'companyId':_0x596cba,'remoteJid':_0x2c7c3b['id'],'whatsappId':_0x3e7ff6['id']};await(0x0,CreateOrUpdateContactService_1[_0x53524c(0x224)])(_0x10e16c,_0x3e7ff6,_0x2c7c3b['id']);}});};exports['wbotMessageListener']=wbotMessageListener;