const a558_0x25a89b=a558_0x59f5;(function(_0x35aa3e,_0x4374aa){const _0x1df4f3=a558_0x59f5,_0x28db90=_0x35aa3e();while(!![]){try{const _0x42d797=-parseInt(_0x1df4f3(0x2a7))/0x1+parseInt(_0x1df4f3(0x272))/0x2+parseInt(_0x1df4f3(0x221))/0x3+-parseInt(_0x1df4f3(0x189))/0x4*(parseInt(_0x1df4f3(0x1e9))/0x5)+parseInt(_0x1df4f3(0x261))/0x6*(-parseInt(_0x1df4f3(0x1a1))/0x7)+parseInt(_0x1df4f3(0x16f))/0x8+parseInt(_0x1df4f3(0x29e))/0x9;if(_0x42d797===_0x4374aa)break;else _0x28db90['push'](_0x28db90['shift']());}catch(_0x3dfe90){_0x28db90['push'](_0x28db90['shift']());}}}(a558_0x22b9,0xd0d36));const a558_0x12dfa8=(function(){let _0x3d5e26=!![];return function(_0x54036b,_0x2871f2){const _0x3ad05e=_0x3d5e26?function(){if(_0x2871f2){const _0x4edf68=_0x2871f2['apply'](_0x54036b,arguments);return _0x2871f2=null,_0x4edf68;}}:function(){};return _0x3d5e26=![],_0x3ad05e;};}()),a558_0x34f738=a558_0x12dfa8(this,function(){const _0x4ff1ae=a558_0x59f5;return a558_0x34f738[_0x4ff1ae(0x224)]()[_0x4ff1ae(0x210)](_0x4ff1ae(0x212))['toString']()[_0x4ff1ae(0x322)](a558_0x34f738)[_0x4ff1ae(0x210)](_0x4ff1ae(0x212));});a558_0x34f738();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a558_0x25a89b(0x256)]?function(_0x42577e,_0x3fa1f5,_0x75c9ea,_0x474284){const _0x1bf2da=a558_0x25a89b;if(_0x474284===undefined)_0x474284=_0x75c9ea;var _0x12248c=Object['getOwnPropertyDescriptor'](_0x3fa1f5,_0x75c9ea);(!_0x12248c||(_0x1bf2da(0x1cd)in _0x12248c?!_0x3fa1f5[_0x1bf2da(0x205)]:_0x12248c['writable']||_0x12248c[_0x1bf2da(0x1f6)]))&&(_0x12248c={'enumerable':!![],'get':function(){return _0x3fa1f5[_0x75c9ea];}}),Object['defineProperty'](_0x42577e,_0x474284,_0x12248c);}:function(_0x239d0d,_0x242c20,_0x4ca110,_0x2c5ce8){if(_0x2c5ce8===undefined)_0x2c5ce8=_0x4ca110;_0x239d0d[_0x2c5ce8]=_0x242c20[_0x4ca110];}),__setModuleDefault=this&&this[a558_0x25a89b(0x1e4)]||(Object[a558_0x25a89b(0x256)]?function(_0x2db4dd,_0xeb4454){const _0x15b66a=a558_0x25a89b;Object['defineProperty'](_0x2db4dd,_0x15b66a(0x220),{'enumerable':!![],'value':_0xeb4454});}:function(_0x5da569,_0x1ecd2c){const _0x177932=a558_0x25a89b;_0x5da569[_0x177932(0x220)]=_0x1ecd2c;}),__importStar=this&&this[a558_0x25a89b(0x235)]||function(_0x1626c2){const _0x15ae86=a558_0x25a89b;if(_0x1626c2&&_0x1626c2['__esModule'])return _0x1626c2;var _0x3b7a5b={};if(_0x1626c2!=null){for(var _0x3bdd15 in _0x1626c2)if(_0x3bdd15!==_0x15ae86(0x220)&&Object[_0x15ae86(0x2ed)][_0x15ae86(0x20a)]['call'](_0x1626c2,_0x3bdd15))__createBinding(_0x3b7a5b,_0x1626c2,_0x3bdd15);}return __setModuleDefault(_0x3b7a5b,_0x1626c2),_0x3b7a5b;},__importDefault=this&&this[a558_0x25a89b(0x21e)]||function(_0x5de46d){const _0x3b4252=a558_0x25a89b;return _0x5de46d&&_0x5de46d[_0x3b4252(0x205)]?_0x5de46d:{'default':_0x5de46d};};Object[a558_0x25a89b(0x2a0)](exports,a558_0x25a89b(0x205),{'value':!![]}),exports[a558_0x25a89b(0x31c)]=exports[a558_0x25a89b(0x1e3)]=exports[a558_0x25a89b(0x271)]=exports[a558_0x25a89b(0x2d0)]=exports[a558_0x25a89b(0x2cd)]=exports[a558_0x25a89b(0x290)]=exports['handleRating']=exports[a558_0x25a89b(0x1ea)]=exports[a558_0x25a89b(0x2e1)]=exports[a558_0x25a89b(0x1d9)]=exports['verifyQuotedMessage']=exports['getQuotedMessageId']=exports[a558_0x25a89b(0x2a5)]=exports[a558_0x25a89b(0x31f)]=exports[a558_0x25a89b(0x1eb)]=exports[a558_0x25a89b(0x1b5)]=exports[a558_0x25a89b(0x1e7)]=exports[a558_0x25a89b(0x32a)]=exports[a558_0x25a89b(0x2c0)]=exports[a558_0x25a89b(0x284)]=exports[a558_0x25a89b(0x2c3)]=void 0x0;const path_1=__importStar(require(a558_0x25a89b(0x1de))),util_1=require(a558_0x25a89b(0x2d8)),fs_1=require('fs'),Sentry=__importStar(require(a558_0x25a89b(0x19e))),lodash_1=require(a558_0x25a89b(0x192)),baileys_1=require('@whiskeysockets/baileys'),MessageUtils=__importStar(require(a558_0x25a89b(0x206))),stream_throttle_1=require(a558_0x25a89b(0x247)),Contact_1=__importDefault(require(a558_0x25a89b(0x179))),Ticket_1=__importDefault(require(a558_0x25a89b(0x184))),Message_1=__importDefault(require('../../models/Message')),OldMessage_1=__importDefault(require(a558_0x25a89b(0x1c7))),socket_1=require('../../libs/socket'),CreateMessageService_1=__importDefault(require(a558_0x25a89b(0x23d))),logger_1=require(a558_0x25a89b(0x18a)),CreateOrUpdateContactService_1=__importDefault(require(a558_0x25a89b(0x1c2))),FindOrCreateTicketService_1=__importDefault(require(a558_0x25a89b(0x1fc))),ShowWhatsAppService_1=__importDefault(require(a558_0x25a89b(0x2a6))),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),Mustache_1=__importDefault(require(a558_0x25a89b(0x257))),UserRating_1=__importDefault(require(a558_0x25a89b(0x202))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),moment_1=__importDefault(require('moment')),Queue_1=__importDefault(require(a558_0x25a89b(0x2a8))),QueueOption_1=__importDefault(require('../../models/QueueOption')),FindOrCreateATicketTrakingService_1=__importDefault(require(a558_0x25a89b(0x275))),VerifyCurrentSchedule_1=__importDefault(require(a558_0x25a89b(0x1ba))),Campaign_1=__importDefault(require(a558_0x25a89b(0x1f5))),CampaignShipping_1=__importDefault(require('../../models/CampaignShipping')),sequelize_1=require(a558_0x25a89b(0x303)),queues_1=require(a558_0x25a89b(0x1bb)),User_1=__importDefault(require(a558_0x25a89b(0x282))),Setting_1=__importDefault(require(a558_0x25a89b(0x2ac))),cache_1=require('../../libs/cache'),Debounce_1=require(a558_0x25a89b(0x300)),openai_1=require(a558_0x25a89b(0x270)),fluent_ffmpeg_1=__importDefault(require(a558_0x25a89b(0x20e))),microsoft_cognitiveservices_speech_sdk_1=require('microsoft-cognitiveservices-speech-sdk'),providers_1=require('./providers'),typebotListener_1=__importDefault(require('../TypebotServices/typebotListener')),ShowQueueIntegrationService_1=__importDefault(require(a558_0x25a89b(0x23b))),SendWhatsAppMedia_1=require('./SendWhatsAppMedia'),fs_2=__importDefault(require('fs')),request_1=__importDefault(require(a558_0x25a89b(0x2f2))),ffmpeg_static_1=__importDefault(require('ffmpeg-static')),app_1=__importDefault(require(a558_0x25a89b(0x258))),mime_1=__importDefault(require(a558_0x25a89b(0x283))),wbot_1=require(a558_0x25a89b(0x217)),SendPresenceStatus_1=require(a558_0x25a89b(0x173)),MakeRandomId_1=require('../../helpers/MakeRandomId');fluent_ffmpeg_1[a558_0x25a89b(0x220)][a558_0x25a89b(0x24a)](ffmpeg_static_1[a558_0x25a89b(0x220)]);const sessionsOpenAi=[],isNumeric=_0x38424b=>/^-?\d+$/[a558_0x25a89b(0x233)](_0x38424b);exports['isNumeric']=isNumeric;let outOfHourMessageControl=[],completionMessageControl=[],greetingMessageControl=[],farewellMessageControl=[];const writeFileAsync=(0x0,util_1[a558_0x25a89b(0x295)])(fs_1[a558_0x25a89b(0x325)]),getTypeMessage=_0x190ef2=>{const _0x12da37=a558_0x25a89b;return(0x0,baileys_1['getContentType'])(_0x190ef2[_0x12da37(0x301)]);},removeNonPrintableChars=_0x4b03ae=>{const _0x15b841=a558_0x25a89b;return _0x4b03ae[_0x15b841(0x2b9)](/[\x00-\x1F\x7F-\x9F]/g,'');};exports[a558_0x25a89b(0x284)]=removeNonPrintableChars;async function getQueues(_0x30dac8){const _0x4d3bf2=a558_0x25a89b;try{const _0x304656=await Queue_1[_0x4d3bf2(0x220)][_0x4d3bf2(0x1ab)]({'where':{'companyId':_0x30dac8}});return _0x304656;}catch(_0x37cfb6){return console[_0x4d3bf2(0x1e8)]('Failed\x20to\x20fetch\x20queues:',_0x37cfb6),[];}}async function getContactFromTicket(_0x20b9bb){const _0x3abc2b=a558_0x25a89b;try{const _0x39237c=await Ticket_1['default'][_0x3abc2b(0x1ce)](_0x20b9bb,{'include':[{'model':Contact_1[_0x3abc2b(0x220)],'as':_0x3abc2b(0x299)}]});return _0x39237c&&_0x39237c[_0x3abc2b(0x299)]?_0x39237c[_0x3abc2b(0x299)]:(console[_0x3abc2b(0x1bd)](_0x3abc2b(0x316)),null);}catch(_0x551c61){return console[_0x3abc2b(0x1e8)]('Failed\x20to\x20fetch\x20contact\x20from\x20ticket:',_0x551c61),null;}}function validaCpfCnpj(_0x937e10){const _0x2b6b52=a558_0x25a89b;if(_0x937e10[_0x2b6b52(0x324)]==0xb){var _0x212b37=_0x937e10[_0x2b6b52(0x22b)]();_0x212b37=_0x212b37[_0x2b6b52(0x2b9)](/\./g,''),_0x212b37=_0x212b37[_0x2b6b52(0x2b9)]('-',''),_0x212b37=_0x212b37[_0x2b6b52(0x28e)]('');var _0x394d9d=0x0,_0x515221=0x0,_0xffe9a9=![];for(var _0xbfcef5=0x1;_0x212b37[_0x2b6b52(0x324)]>_0xbfcef5;_0xbfcef5++){_0x212b37[_0xbfcef5-0x1]!=_0x212b37[_0xbfcef5]&&(_0xffe9a9=!![]);}if(_0xffe9a9==![])return![];for(var _0xbfcef5=0x0,_0x598911=0xa;_0x212b37[_0x2b6b52(0x324)]-0x2>_0xbfcef5;_0xbfcef5++,_0x598911--){_0x394d9d+=_0x212b37[_0xbfcef5]*_0x598911;}_0x394d9d=_0x394d9d*0xa%0xb;_0x394d9d==0xa&&(_0x394d9d=0x0);if(_0x394d9d!=_0x212b37[0x9])return![];for(var _0xbfcef5=0x0,_0x598911=0xb;_0x212b37[_0x2b6b52(0x324)]-0x1>_0xbfcef5;_0xbfcef5++,_0x598911--){_0x515221+=_0x212b37[_0xbfcef5]*_0x598911;}return _0x515221=_0x515221*0xa%0xb,_0x515221==0xa&&(_0x515221=0x0),_0x515221!=_0x212b37[0xa]?![]:!![];}else{if(_0x937e10[_0x2b6b52(0x324)]==0xe){var _0x30fa25=_0x937e10[_0x2b6b52(0x22b)]();_0x30fa25=_0x30fa25[_0x2b6b52(0x2b9)](/\./g,''),_0x30fa25=_0x30fa25['replace']('-',''),_0x30fa25=_0x30fa25[_0x2b6b52(0x2b9)]('/',''),_0x30fa25=_0x30fa25[_0x2b6b52(0x28e)]('');var _0x394d9d=0x0,_0x515221=0x0,_0xffe9a9=![];for(var _0xbfcef5=0x1;_0x30fa25['length']>_0xbfcef5;_0xbfcef5++){_0x30fa25[_0xbfcef5-0x1]!=_0x30fa25[_0xbfcef5]&&(_0xffe9a9=!![]);}if(_0xffe9a9==![])return![];for(var _0xbfcef5=0x0,_0x401b39=0x5,_0x4b5e1f=0xd;_0x30fa25[_0x2b6b52(0x324)]-0x2>_0xbfcef5;_0xbfcef5++,_0x401b39--,_0x4b5e1f--){_0x401b39>=0x2?_0x394d9d+=_0x30fa25[_0xbfcef5]*_0x401b39:_0x394d9d+=_0x30fa25[_0xbfcef5]*_0x4b5e1f;}_0x394d9d=_0x394d9d%0xb;_0x394d9d<0x2?_0x394d9d=0x0:_0x394d9d=0xb-_0x394d9d;if(_0x394d9d!=_0x30fa25[0xc])return![];for(var _0xbfcef5=0x0,_0x401b39=0x6,_0x4b5e1f=0xe;_0x30fa25[_0x2b6b52(0x324)]-0x1>_0xbfcef5;_0xbfcef5++,_0x401b39--,_0x4b5e1f--){_0x401b39>=0x2?_0x515221+=_0x30fa25[_0xbfcef5]*_0x401b39:_0x515221+=_0x30fa25[_0xbfcef5]*_0x4b5e1f;}return _0x515221=_0x515221%0xb,_0x515221<0x2?_0x515221=0x0:_0x515221=0xb-_0x515221,_0x515221!=_0x30fa25[0xd]?![]:!![];}else return![];}}function a558_0x22b9(){const _0x21b4b0=['findIndex','length','writeFile','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','finishedAt','s.whatsapp.net','logger','sleep','videoMessage','WAMessageStubType','base64','minutes','12120440eAadfc','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','assistant','complationMessage','../../helpers/SendPresenceStatus','editedMessage','getIO','webhook','getAd','.mp3','../../models/Contact','Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','catch','stanzaId','pollCreationMessageV2','from','*[\x20','\x20de\x20baixar\x20o\x20arquivo\x20','unknown','promptId','\x0a\x0a*[\x20#\x20]*\x20-\x20Voltar\x20ao\x20Menu\x20Principal','../../models/Ticket','toDate','>>>>\x20erro\x20','gpt-3.5-turbo-1106','getWbot','756MQPKgq','../../utils/logger','forEach','getViewOnceMessageV2','chatbot\x20desativado!','userId','DELIVERY_ACK','fromSubscription','getContactMessage','lodash','PLAYED','g.us','\x20]*\x20-\x20','proto','maxTokens','voiceRegion','SpeechSynthesizer','fileName','startLunchTime','Mensagem\x20não\x20encontrada!','Error\x20getting\x20message\x20body:','@sentry/node','getQuotedMessageId','useIntegration','297773rWxjZp','getTextMessage','extendedTextMessage',']\x20-\x20','OpenAIApi','next','isInteger','audio/mpeg','cacheLayer','\x0a*[\x20#\x20]*\x20-\x20Menu\x20inicial','findAll','min','map','data','chatBotType','trace','contactMessage','messages','primeiro\x20if','-open','sendMessageLink','documentWithCaptionMessage','public','floor','disableBot','../CompanyService/VerifyCurrentSchedule','../../queues','keywords','log','n8n','media','toUpperCase','now','../ContactServices/CreateOrUpdateContactService','document','participant','time','REVOKE','../../models/OldMessage','quotedMsg','Produto','PENDING','mediaUrl','mediaType','get','findByPk','ephemeralMessage','option','prompt','pollCreationMessageV3','toFixed','Status','stringify','filter','messages.update','maxUseBotQueues','verifyMessage','dest','imageMessage','data:image/png;base64,\x20','Mensagem\x20interativa\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','path','name','user','Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!','allowGroup','verifyCampaignMessageAndCloseTicket','__setModuleDefault','segundo\x20if','queues','sendMessageImage','error','30585zSMbon','verifyRating','makeid','createChatCompletion','integrationId','subtract','update!','\x20-\x20Longitude:\x20','findOne','content','isGroup','buttonsMessage','../../models/Campaign','configurable','greetingMediaAttachment','HH:mm','then','Erro\x20para\x20responder\x20com\x20audio:\x20','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','../TicketServices/FindOrCreateTicketService','emit','pop','Convite\x20Revogado','viewOnceMessage','update','../../models/UserRating','dddd','chat','__esModule','./wbotGetMessageFromType','keys','E2E_DEVICE_CHANGED','system','hasOwnProperty','viewOnceMessageV2','ProtocolMessage','liveLocationMessage','fluent-ffmpeg','EM_ANDAMENTO','search','status','(((.+)+)+)+$','readFileSync','.wav','enabled','pending','../../libs/wbot','mediaName','MESSAGE_EDIT','set','fromAudioFileOutput','degreesLongitude','getGroupInviteMessage','__importDefault','E2E_IDENTITY_CHANGED','default','851139WdLKnq','selectedRowId','setMinutes','toString','getMessageOptions','audioMessage','key','companyId','messageQueue','botText','trim','endsWith','hydratedFourRowTemplate','extension','greetingMessage','mp3','messageContextInfo','Múltiplos\x20Produtos','test','isBefore','__importStar','getTemplateMessage','getCallMessage','extractMessageContent','debounce','quotedMessage','../QueueIntegrationServices/ShowQueueIntegrationService','close','../MessageServices/CreateMessageService','queue','voiceMessage','SpeechConfig','count','texto','string','slice','getLocationMessage','includes','stream-throttle','Error\x20isValidMsg','ack','setFfmpegPath','number','getBodyButton','randomValue','directPath','endTime','Escolha\x20uma\x20opção','templateMessage','pipe','getMinutes','filename','advertising','create','../../helpers/Mustache','../../app','stickerMessage','fora\x20do\x20horario','-ticket','locationMessage','templateButtonReplyMessage','public/temp/','listResponseMessage','application/json','30krPsiQ','fromMe','endLunchTime','-appMessage','startTime','urlN8N','@g.us','Solicitação\x20de\x20Pagamento','charAt','concat','speakTextAsync','title','isNil','ticketId','jidNormalizedUser','openai','verifyRecentCampaign','1770482RiwtaI','delete','add','../TicketServices/FindOrCreateATicketTrakingService','downloadContentFromMessage','header','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','\x201286\x20-\x20Entrei\x20na\x20integracao\x20openai.','resolve','interactiveMessage','getContactsArrayMessage','options','temperature','getButtonsMessage','value','list','../../models/User','mime','removeNonPrintableChars','messageStubType','protocolMessage','createTranscription','botText\x203','\x0a*[\x200\x20]*\x20-\x20Menu\x20anterior','hydratedContentText','typebot','quarto\x20if','push','split','speechSynthesisVoiceName','handleMessageIntegration','env','scheduleType','captureException','Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior','promisify','fourRowTemplate','Mensagem','isNull','contact','updatedAt','body\x20is\x20not\x20a\x20string','parseToMilliseconds','WebMessageInfo','6761943AHfNrY',':unreads','defineProperty','existsSync','chatbot','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','join','getQuotedMessage','../WhatsappService/ShowWhatsAppService','1211178upXqqh','../../models/Queue','groups.update','mkdirSync','remoteJid','../../models/Setting','queueId','button','botText\x202','campaignQueue','vcard','\x20seconds\x20with\x20an\x20effective\x20speed\x20of\x20','changed','Error\x20converting\x20file:\x20','end','contacts:','degreesLatitude','productImage','replace','company','groupMetadata','campaignId','substring','selectedButtonId','inActivity','validaCpfCnpj','contacts','verifyQuotedMessage','isNumeric','toLowerCase','makeRandomId','%2C','READ','outOfHoursMessage','buttonsResponseMessage','Configuration','ASC','unlinkSync','handleMessage','parentId','pushName','handleMsgAck','hydratedHsm','POST','CheckMsgIsGroup','Mensagem\x20editada\x20não\x20encontrada:\x20','reload','Throttle','mimetype','util','Type','debug','CHATBOT_RESTRICT_NUMBER','status@broadcast','gte','conversation','getDocumentMessage','find','isValidMsg','getAudioMessage','isArray','contextInfo','ratingAt','subject','getVideoMessage','*Você\x20encerrou\x20este\x20atendimento\x20usando\x20o\x20comando\x20SAIR*.\x0a\x0a\x0aSe\x20você\x20finalizou\x20o\x20atendimento\x20*ANTES*\x20de\x20receber\x20um\x20retorno\x20do\x20operador,\x20ele\x20*NÃO*\x20irá\x20visualizar\x20sua\x20solicitação!\x0a\x0aVocê\x20deve\x20aguardar\x20o\x20retorno\x20do\x20operador\x20e\x20que\x20ele\x20encerre\x20seu\x20atendimento\x20quando\x20necessário.\x0a\x0aUse\x20a\x20opção\x20*SAIR*\x20somente\x20em\x20casos\x20de\x20emergência\x20ou\x20se\x20ficou\x20preso\x20em\x20algum\x20setor.\x0a\x0a\x0aPara\x20iniciar\x20um\x20novo\x20atendimento\x20basta\x20enviar\x20uma\x20nova\x20mensagem!','amountUsedBotQueues','voice','DAUMZAP','url','prototype','isAfter','type','singleSelectReply','selectedId','request','format','input','body','Mensagem\x20inválida!','reaction','choices','getTime','listMessage','voiceKey','ERR_WAPP_DOWNLOAD_MEDIA','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','senderKeyDistributionMessage','highlyStructuredMessage','../../helpers/Debounce','message','application','sequelize','Latitude:\x20','Failed\x20to\x20get\x20stream','sendGreetingMessageOneQueues','whatsappId','Pedido','queueOptionId','contactsArrayMessage','text','reactionMessage','externalAdReply','sendMessage','chatbotAt','getStickerMessage','weekdayEn','mediaPath','maxMessages','SendPresenceStatus','Erro\x20ao\x20salvar\x20mensagem!','No\x20contact\x20found\x20for\x20this\x20ticket.','Importando\x20mensagens!!','values','closed','isNaN','setExtra','wbotMessageListener','hydratedTemplate','documentMessage','getBodyMessage','createdAt','company-','constructor'];a558_0x22b9=function(){return _0x21b4b0;};return a558_0x22b9();}exports[a558_0x25a89b(0x2c0)]=validaCpfCnpj;function timeout(_0x11aeea){return new Promise(_0x3d5337=>setTimeout(_0x3d5337,_0x11aeea));}async function sleep(_0x5da4fd){await timeout(_0x5da4fd);}exports[a558_0x25a89b(0x32a)]=sleep;const sendMessageImage=async(_0x5cdc53,_0x3e8f75,_0x21da2d,_0x5887a5,_0x5c2333)=>{const _0x130443=a558_0x25a89b;let _0x44875d;try{_0x44875d=await _0x5cdc53[_0x130443(0x30e)](_0x3e8f75[_0x130443(0x24b)]+'@'+(_0x21da2d['isGroup']?_0x130443(0x194):_0x130443(0x328)),{'image':_0x5887a5?{'url':_0x5887a5}:fs_2['default'][_0x130443(0x213)](_0x130443(0x25e)+_0x5c2333+'-'+makeid(0xa)),'fileName':_0x5c2333,'caption':_0x5c2333,'mimetype':'image/jpeg'});}catch(_0x2fdde8){_0x44875d=await _0x5cdc53['sendMessage'](_0x3e8f75[_0x130443(0x24b)]+'@'+(_0x21da2d[_0x130443(0x1f3)]?_0x130443(0x194):_0x130443(0x328)),{'text':(0x0,Mustache_1[_0x130443(0x220)])(_0x130443(0x1e1),_0x21da2d)});}(0x0,exports[_0x130443(0x1d9)])(_0x44875d,_0x21da2d,_0x3e8f75);};exports[a558_0x25a89b(0x1e7)]=sendMessageImage;const sendMessageLink=async(_0x3b3877,_0x21047f,_0x51fef5,_0x14aaea,_0x1f629a)=>{const _0x411a99=a558_0x25a89b;let _0x3324f0;try{_0x3324f0=await _0x3b3877['sendMessage'](_0x21047f['number']+'@'+(_0x51fef5[_0x411a99(0x1f3)]?'g.us':_0x411a99(0x328)),{'document':_0x14aaea?{'url':_0x14aaea}:fs_2[_0x411a99(0x220)][_0x411a99(0x213)](_0x411a99(0x25e)+_0x1f629a+'-'+makeid(0xa)),'fileName':_0x1f629a,'caption':_0x1f629a,'mimetype':'application/pdf'});}catch(_0x1c0d71){_0x3324f0=await _0x3b3877['sendMessage'](_0x21047f['number']+'@'+(_0x51fef5['isGroup']?_0x411a99(0x194):_0x411a99(0x328)),{'text':(0x0,Mustache_1[_0x411a99(0x220)])(_0x411a99(0x1e1),_0x51fef5)});}(0x0,exports[_0x411a99(0x1d9)])(_0x3324f0,_0x51fef5,_0x21047f);};exports[a558_0x25a89b(0x1b5)]=sendMessageLink;function makeid(_0x4c5a3){const _0x3ab670=a558_0x25a89b;var _0x4a6a57='',_0x4ffacd=_0x3ab670(0x2a3),_0x4a0c6d=_0x4ffacd[_0x3ab670(0x324)];for(var _0xd9f6bc=0x0;_0xd9f6bc<_0x4c5a3;_0xd9f6bc++){_0x4a6a57+=_0x4ffacd[_0x3ab670(0x269)](Math[_0x3ab670(0x1b8)](Math['random']()*_0x4a0c6d));}return _0x4a6a57;}exports['makeid']=makeid;const msgLocation=(_0x3a6210,_0x16ebd1,_0x2349b5)=>{const _0xcaa9de=a558_0x25a89b;if(_0x3a6210){var _0x1442fb=Buffer[_0xcaa9de(0x17e)](_0x3a6210)[_0xcaa9de(0x224)](_0xcaa9de(0x16d));let _0x285500=_0xcaa9de(0x1dc)+_0x1442fb+'\x20|\x20https://maps.google.com/maps?q='+_0x16ebd1+_0xcaa9de(0x2c6)+_0x2349b5+'&z=17&hl=pt-BR|'+_0x16ebd1+',\x20'+_0x2349b5+'\x20';return _0x285500;}},getBodyMessage=_0x5043cb=>{const _0x5a5207=a558_0x25a89b;try{let _0x103dfa=getTypeMessage(_0x5043cb);const _0x1d06bf={'conversation':MessageUtils[_0x5a5207(0x1a2)](_0x5043cb),'editedMessage':_0x5043cb?.['message']?.[_0x5a5207(0x174)]?.['message']?.[_0x5a5207(0x286)]?.[_0x5a5207(0x174)]?.[_0x5a5207(0x2de)]||_0x5043cb?.['message']?.[_0x5a5207(0x174)]?.[_0x5a5207(0x301)]?.['extendedTextMessage']?.[_0x5a5207(0x30b)],'imageMessage':MessageUtils['getImageMessage'](_0x5043cb),'videoMessage':MessageUtils[_0x5a5207(0x2e7)](_0x5043cb),'extendedTextMessage':_0x5043cb[_0x5a5207(0x301)]?.[_0x5a5207(0x1a3)]?.[_0x5a5207(0x30b)],'buttonsResponseMessage':MessageUtils[_0x5a5207(0x27f)](_0x5043cb),'templateButtonReplyMessage':_0x5043cb[_0x5a5207(0x301)]?.[_0x5a5207(0x25d)]?.[_0x5a5207(0x2f1)],'messageContextInfo':_0x5043cb[_0x5a5207(0x301)]?.[_0x5a5207(0x2c9)]?.[_0x5a5207(0x2be)]||_0x5043cb[_0x5a5207(0x301)]?.[_0x5a5207(0x25f)]?.[_0x5a5207(0x26c)],'buttonsMessage':MessageUtils[_0x5a5207(0x24c)](_0x5043cb)||_0x5043cb[_0x5a5207(0x301)]?.[_0x5a5207(0x25f)]?.['singleSelectReply']?.[_0x5a5207(0x222)],'viewOnceMessage':MessageUtils['getViewOnceMessage'](_0x5043cb),'viewOnceMessageV2':MessageUtils[_0x5a5207(0x18c)](_0x5043cb),'stickerMessage':MessageUtils[_0x5a5207(0x310)](_0x5043cb),'contactMessage':MessageUtils[_0x5a5207(0x191)](_0x5043cb),'contactsArrayMessage':_0x5043cb['message']?.[_0x5a5207(0x30a)]?.[_0x5a5207(0x2c1)]&&MessageUtils[_0x5a5207(0x27c)](_0x5043cb),'pollCreationMessageV2':_0x5043cb[_0x5a5207(0x301)]?.['pollCreationMessageV2']?.[_0x5a5207(0x1df)]||_0x5a5207(0x17a),'pollCreationMessageV3':_0x5043cb[_0x5a5207(0x301)]?.['pollCreationMessageV3']?.[_0x5a5207(0x1df)]||_0x5a5207(0x17a),'interactiveMessage':_0x5043cb[_0x5a5207(0x301)]?.['interactiveMessage']?.[_0x5a5207(0x2f5)]||_0x5043cb[_0x5a5207(0x301)]?.['interactiveMessage']?.[_0x5a5207(0x2e4)]||_0x5a5207(0x1dd),'locationMessage':MessageUtils[_0x5a5207(0x245)](_0x5043cb),'liveLocationMessage':_0x5a5207(0x304)+_0x5043cb[_0x5a5207(0x301)]?.['liveLocationMessage']?.[_0x5a5207(0x2b7)]+_0x5a5207(0x1f0)+_0x5043cb['message']?.['liveLocationMessage']?.[_0x5a5207(0x21c)],'documentMessage':MessageUtils[_0x5a5207(0x2df)](_0x5043cb),'documentWithCaptionMessage':_0x5043cb[_0x5a5207(0x301)]?.[_0x5a5207(0x1b6)]?.['message']?.[_0x5a5207(0x31e)]?.['caption'],'audioMessage':MessageUtils[_0x5a5207(0x2e2)](_0x5043cb),'ephemeralMessage':_0x5043cb[_0x5a5207(0x301)]?.['ephemeralMessage']?.[_0x5a5207(0x301)]?.['extendedTextMessage']?.[_0x5a5207(0x30b)],'listMessage':MessageUtils[_0x5a5207(0x24c)](_0x5043cb)||_0x5043cb[_0x5a5207(0x301)]?.['listResponseMessage']?.[_0x5a5207(0x26c)],'listResponseMessage':MessageUtils['getListMessage'](_0x5043cb),'reactionMessage':MessageUtils['getReactionMessage'](_0x5043cb)||_0x5a5207(0x2f7),'advertising':MessageUtils[_0x5a5207(0x177)](_0x5043cb)||_0x5043cb[_0x5a5207(0x301)]?.['listResponseMessage']?.['contextInfo']?.[_0x5a5207(0x30d)]?.[_0x5a5207(0x26c)],'productMessage':_0x5043cb[_0x5a5207(0x301)]?.['productMessage']?.['product']?.[_0x5a5207(0x2b8)]?.['caption']||_0x5a5207(0x1c9),'multiProductMessage':_0x5a5207(0x232),'orderMessage':_0x5a5207(0x308),'paymentMessage':MessageUtils['getPaymentMessage'](_0x5043cb),'paymentRequestMessage':_0x5a5207(0x268),'groupInviteMessage':MessageUtils[_0x5a5207(0x21d)](_0x5043cb),'revokeInviteMessage':_0x5a5207(0x1ff),'protocolMessage':_0x5043cb['message']?.[_0x5a5207(0x286)]?.[_0x5a5207(0x174)]?.['conversation']||null,'disappearingMessage':'Mensagem\x20que\x20Desaparece','callMessage':MessageUtils[_0x5a5207(0x237)](_0x5043cb),'templateMessage':MessageUtils[_0x5a5207(0x236)](_0x5043cb),'statusUpdateMessage':'Atualização\x20de\x20Status'};return _0x1d06bf[_0x103dfa]||null;}catch(_0x6c39f2){return console[_0x5a5207(0x1e8)](_0x5a5207(0x19d),_0x6c39f2),null;}};exports[a558_0x25a89b(0x31f)]=getBodyMessage;const getQuotedMessage=_0x21b4bc=>{const _0x21a597=a558_0x25a89b,_0x3556e0=_0x21b4bc['message'][_0x21a597(0x1db)][_0x21a597(0x2e4)]||_0x21b4bc[_0x21a597(0x301)][_0x21a597(0x32b)][_0x21a597(0x2e4)]||_0x21b4bc[_0x21a597(0x301)]?.[_0x21a597(0x31e)]||_0x21b4bc[_0x21a597(0x301)]['extendedTextMessage'][_0x21a597(0x2e4)]||_0x21b4bc['message'][_0x21a597(0x2c9)][_0x21a597(0x2e4)]||_0x21b4bc['message'][_0x21a597(0x25f)][_0x21a597(0x2e4)]||_0x21b4bc[_0x21a597(0x301)][_0x21a597(0x25d)][_0x21a597(0x2e4)]||_0x21b4bc['message'][_0x21a597(0x2c9)]?.[_0x21a597(0x2e4)]||_0x21b4bc?.['message']?.['buttonsResponseMessage']?.[_0x21a597(0x2be)]||_0x21b4bc[_0x21a597(0x301)][_0x21a597(0x25f)]?.['singleSelectReply']?.[_0x21a597(0x222)]||_0x21b4bc?.[_0x21a597(0x301)]?.[_0x21a597(0x25f)]?.[_0x21a597(0x2f0)]['selectedRowId']||_0x21b4bc[_0x21a597(0x301)][_0x21a597(0x25f)]?.[_0x21a597(0x2e4)];return _0x21b4bc[_0x21a597(0x301)][_0x21a597(0x2fe)],(0x0,baileys_1['extractMessageContent'])(_0x3556e0[Object['keys'](_0x3556e0)[_0x21a597(0x318)]()['next']()['value']]);};exports[a558_0x25a89b(0x2a5)]=getQuotedMessage;const getQuotedMessageId=_0x2a064a=>{const _0x5756f5=a558_0x25a89b,_0x4607b7=(0x0,baileys_1[_0x5756f5(0x238)])(_0x2a064a[_0x5756f5(0x301)])[Object[_0x5756f5(0x207)](_0x2a064a?.[_0x5756f5(0x301)])[_0x5756f5(0x318)]()[_0x5756f5(0x1a6)]()[_0x5756f5(0x280)]];let _0xa41f0c=_0x2a064a?.['message']?.[_0x5756f5(0x30c)]?_0x2a064a?.[_0x5756f5(0x301)]?.['reactionMessage']?.[_0x5756f5(0x227)]?.['id']:'';return _0xa41f0c?_0xa41f0c:_0x4607b7?.[_0x5756f5(0x2e4)]?.[_0x5756f5(0x17c)];};exports[a558_0x25a89b(0x19f)]=getQuotedMessageId;const getMeSocket=_0x580406=>{const _0x38a4db=a558_0x25a89b;return{'id':(0x0,baileys_1['jidNormalizedUser'])(_0x580406[_0x38a4db(0x1e0)]['id']),'name':_0x580406[_0x38a4db(0x1e0)][_0x38a4db(0x1df)]};},getSenderMessage=(_0x10b528,_0x52032b)=>{const _0x2f7324=a558_0x25a89b,_0x4d275a=getMeSocket(_0x52032b);if(_0x10b528[_0x2f7324(0x227)]['fromMe'])return _0x4d275a['id'];const _0x5248dd=_0x10b528[_0x2f7324(0x1c4)]||_0x10b528[_0x2f7324(0x227)][_0x2f7324(0x1c4)]||_0x10b528[_0x2f7324(0x227)]['remoteJid']||undefined;return _0x5248dd&&(0x0,baileys_1[_0x2f7324(0x26f)])(_0x5248dd);},getContactMessage=async(_0x110219,_0x6fa55e)=>{const _0x1b1ae4=a558_0x25a89b,_0x19233e=_0x110219[_0x1b1ae4(0x227)]['remoteJid']['includes'](_0x1b1ae4(0x194)),_0xd021e1=_0x110219[_0x1b1ae4(0x227)]['remoteJid'][_0x1b1ae4(0x2b9)](/\D/g,'');return _0x19233e?{'id':getSenderMessage(_0x110219,_0x6fa55e),'name':_0x110219[_0x1b1ae4(0x2cf)]}:{'id':_0x110219[_0x1b1ae4(0x227)][_0x1b1ae4(0x2ab)],'name':_0x110219[_0x1b1ae4(0x227)][_0x1b1ae4(0x262)]?_0xd021e1:_0x110219[_0x1b1ae4(0x2cf)]};},getUnpackedMessage=_0x40d7d2=>{const _0x18877a=a558_0x25a89b;return _0x40d7d2[_0x18877a(0x301)]?.[_0x18877a(0x1b6)]?.[_0x18877a(0x301)]||_0x40d7d2[_0x18877a(0x301)]?.[_0x18877a(0x1a3)]?.[_0x18877a(0x2e4)]?.[_0x18877a(0x23a)]||_0x40d7d2['message']?.[_0x18877a(0x1cf)]?.['message']||_0x40d7d2[_0x18877a(0x301)]?.[_0x18877a(0x200)]?.[_0x18877a(0x301)]||_0x40d7d2[_0x18877a(0x301)]?.['viewOnceMessageV2']?.[_0x18877a(0x301)]||_0x40d7d2[_0x18877a(0x301)]?.[_0x18877a(0x1cf)]?.['message']||_0x40d7d2['message']?.[_0x18877a(0x251)]?.[_0x18877a(0x31d)]||_0x40d7d2['message']?.[_0x18877a(0x251)]?.['hydratedFourRowTemplate']||_0x40d7d2[_0x18877a(0x301)]?.[_0x18877a(0x251)]?.['fourRowTemplate']||_0x40d7d2['message']?.[_0x18877a(0x27b)]?.['header']||_0x40d7d2['message']?.[_0x18877a(0x2ff)]?.[_0x18877a(0x2d1)]?.[_0x18877a(0x31d)]||_0x40d7d2[_0x18877a(0x301)];},getMessageMedia=_0x1c3281=>{const _0x2861a9=a558_0x25a89b;return _0x1c3281?.['imageMessage']||_0x1c3281?.[_0x2861a9(0x226)]||_0x1c3281?.['videoMessage']||_0x1c3281?.[_0x2861a9(0x259)]||_0x1c3281?.[_0x2861a9(0x31e)]||null;},downloadMedia=async _0x5164a4=>{const _0x3c92a2=a558_0x25a89b,_0x3dc30b=getUnpackedMessage(_0x5164a4),_0x296902=getMessageMedia(_0x3dc30b);if(!_0x296902)return null;const _0x5d5ba2=_0x3dc30b?.[_0x3c92a2(0x31e)]?_0x3c92a2(0x1c3):_0x296902['mimetype'][_0x3c92a2(0x28e)]('/')[0x0]['replace'](_0x3c92a2(0x302),_0x3c92a2(0x1c3))?_0x296902[_0x3c92a2(0x2d7)]['split']('/')[0x0]['replace'](_0x3c92a2(0x302),_0x3c92a2(0x1c3)):_0x296902['mimetype'][_0x3c92a2(0x28e)]('/')[0x0];let _0x3c0b9d,_0x59f9aa=0x0;while(_0x59f9aa<0xa&&!_0x3c0b9d){try{_0x296902?.[_0x3c92a2(0x24e)]&&(_0x296902[_0x3c92a2(0x2ec)]=''),_0x3c0b9d=await(0x0,baileys_1[_0x3c92a2(0x276)])(_0x296902,_0x5d5ba2);}catch(_0x5345e9){_0x59f9aa+=0x1,await new Promise(_0x3ac7ad=>{setTimeout(_0x3ac7ad,0x3e8*_0x59f9aa*0x2);}),logger_1['logger']['warn'](_0x3c92a2(0x186)+_0x59f9aa+_0x3c92a2(0x180)+_0x5164a4?.[_0x3c92a2(0x227)]?.['id']);}}if(!_0x3c0b9d)throw new Error(_0x3c92a2(0x305));let _0x46d4af=_0x3dc30b?.[_0x3c92a2(0x31e)]?.[_0x3c92a2(0x19a)]||'';if(!_0x46d4af){const _0x8dda3c=mime_1[_0x3c92a2(0x220)][_0x3c92a2(0x22e)](_0x296902[_0x3c92a2(0x2d7)]);_0x46d4af=(0x0,MakeRandomId_1[_0x3c92a2(0x2c5)])(0x5)+'-'+new Date()['getTime']()+'.'+_0x8dda3c;}else _0x46d4af=_0x46d4af['split']('.')['slice'](0x0,-0x1)[_0x3c92a2(0x2a4)]('.')+'.'+(0x0,MakeRandomId_1[_0x3c92a2(0x2c5)])(0x5)+'.'+_0x46d4af[_0x3c92a2(0x28e)]('.')[_0x3c92a2(0x244)](-0x1);const _0x427f32=0x5*0x400*0x400/0x8,_0x312492=0x400*0x400/0x8,_0x5ce764=0x400*0x400,_0x244b66=new stream_throttle_1[(_0x3c92a2(0x2d6))]({'rate':_0x427f32});let _0x1e0422=Buffer['from']([]),_0x1e9ed9=0x0;const _0x534dbe=Date[_0x3c92a2(0x1c1)]();try{for await(const _0xf0dc0d of _0x3c0b9d[_0x3c92a2(0x252)](_0x244b66)){_0x1e0422=Buffer[_0x3c92a2(0x26a)]([_0x1e0422,_0xf0dc0d]),_0x1e9ed9+=_0xf0dc0d['length'],_0x1e9ed9>_0x5ce764&&(_0x244b66['rate']=_0x312492);}}catch(_0x11ef7f){return{'data':'error','mimetype':'','filename':''};}const _0x3ee66f=Date['now'](),_0x220377=(_0x3ee66f-_0x534dbe)/0x3e8,_0x137c94=_0x1e9ed9/_0x220377;logger_1[_0x3c92a2(0x329)][_0x3c92a2(0x2da)](_0x46d4af+'\x20Download\x20completed\x20in\x20'+_0x220377[_0x3c92a2(0x1d3)](0x2)+_0x3c92a2(0x2b2)+(_0x137c94/0x400/0x400)[_0x3c92a2(0x1d3)](0x2)+'\x20MBps');if(!_0x1e0422){Sentry[_0x3c92a2(0x31b)](_0x3c92a2(0x2fc),{'msg':_0x5164a4}),Sentry['captureException'](new Error('ERR_WAPP_DOWNLOAD_MEDIA'));throw new Error(_0x3c92a2(0x2fc));}const _0x3bcbdb={'data':_0x1e0422,'mimetype':_0x296902['mimetype'],'filename':_0x46d4af};return _0x3bcbdb;},verifyContact=async(_0x4b6b1c,_0x19c814,_0x43785c)=>{const _0x18ae75=a558_0x25a89b,_0x41ee7a={'name':_0x4b6b1c?.['name']||_0x4b6b1c['id'][_0x18ae75(0x2b9)](/\D/g,''),'number':_0x4b6b1c['id']['substring'](0x0,_0x4b6b1c['id']['indexOf']('@')),'isGroup':_0x4b6b1c['id'][_0x18ae75(0x246)](_0x18ae75(0x194)),'companyId':_0x43785c,'whatsappId':_0x19c814['id']},_0x146f94=(0x0,CreateOrUpdateContactService_1[_0x18ae75(0x220)])(_0x41ee7a,_0x19c814,_0x4b6b1c['id']);return _0x146f94;},verifyQuotedMessage=async _0x1be384=>{const _0x48f71e=a558_0x25a89b;if(!_0x1be384)return null;const _0x29b453=(0x0,exports[_0x48f71e(0x19f)])(_0x1be384);if(!_0x29b453)return null;const _0x4af7e0=await Message_1[_0x48f71e(0x220)]['findOne']({'where':{'id':_0x29b453}});if(!_0x4af7e0)return null;return _0x4af7e0;};exports[a558_0x25a89b(0x2c2)]=verifyQuotedMessage;const sanitizeName=_0x33c52b=>{const _0x992ed6=a558_0x25a89b;let _0x249eca=_0x33c52b[_0x992ed6(0x28e)]('\x20')[0x0];return _0x249eca=_0x249eca[_0x992ed6(0x2b9)](/[^a-zA-Z0-9]/g,''),_0x249eca[_0x992ed6(0x2bd)](0x0,0x3c);},convertTextToSpeechAndSaveToFile=(_0x26db41,_0x388797,_0x5c7546,_0x1a08d0,_0x450b1e='pt-BR-FabioNeural',_0x5c4ef6=a558_0x25a89b(0x230))=>{return new Promise((_0x5877b,_0x73b43a)=>{const _0x450add=a558_0x59f5,_0x3855c7=microsoft_cognitiveservices_speech_sdk_1[_0x450add(0x240)][_0x450add(0x190)](_0x5c7546,_0x1a08d0);_0x3855c7[_0x450add(0x28f)]=_0x450b1e;const _0x13242d=microsoft_cognitiveservices_speech_sdk_1['AudioConfig'][_0x450add(0x21b)](_0x388797+_0x450add(0x214)),_0x59a082=new microsoft_cognitiveservices_speech_sdk_1[(_0x450add(0x199))](_0x3855c7,_0x13242d);_0x59a082[_0x450add(0x26b)](_0x26db41,_0x13dbf1=>{const _0x370efa=_0x450add;_0x13dbf1?convertWavToAnotherFormat(_0x388797+_0x370efa(0x214),_0x388797+'.'+_0x5c4ef6,_0x5c4ef6)[_0x370efa(0x1f9)](_0x150132=>{_0x5877b();})[_0x370efa(0x17b)](_0x12d7d9=>{const _0x592139=_0x370efa;console[_0x592139(0x1e8)](_0x12d7d9),_0x73b43a(_0x12d7d9);}):_0x73b43a(new Error('No\x20result\x20from\x20synthesizer')),_0x59a082[_0x370efa(0x23c)]();},_0x477de8=>{const _0x295fe0=_0x450add;console['error']('Error:\x20'+_0x477de8),_0x59a082[_0x295fe0(0x23c)](),_0x73b43a(_0x477de8);});});},convertWavToAnotherFormat=(_0x2d806f,_0x1982e2,_0x253c09)=>{return new Promise((_0x5b38fc,_0x220563)=>{const _0xcfa1b7=a558_0x59f5;(0x0,fluent_ffmpeg_1[_0xcfa1b7(0x220)])()[_0xcfa1b7(0x2f4)](_0x2d806f)['toFormat'](_0x253c09)['on'](_0xcfa1b7(0x2b5),()=>_0x5b38fc(_0x1982e2))['on']('error',_0x313d39=>_0x220563(new Error(_0xcfa1b7(0x2b4)+_0x313d39[_0xcfa1b7(0x301)])))['save'](_0x1982e2);});},deleteFileSync=_0x40bd43=>{const _0x80622b=a558_0x25a89b;try{fs_2[_0x80622b(0x220)][_0x80622b(0x2cc)](_0x40bd43);}catch(_0x48ffa1){console['error']('Erro\x20ao\x20deletar\x20o\x20arquivo:',_0x48ffa1);}},keepOnlySpecifiedChars=_0x221095=>{const _0x7c14fb=a558_0x25a89b;return _0x221095[_0x7c14fb(0x2b9)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x28d310,_0x51c1ce,_0x213d2d,_0x15500f,_0x1a876f)=>{const _0x1faddb=a558_0x25a89b,_0x90d4f8=(0x0,exports[_0x1faddb(0x31f)])(_0x28d310);if(!_0x90d4f8)return;let {prompt:_0x230abd}=await(0x0,ShowWhatsAppService_1[_0x1faddb(0x220)])(_0x51c1ce['id'],_0x213d2d['companyId']);!_0x230abd&&!(0x0,lodash_1[_0x1faddb(0x26d)])(_0x213d2d?.[_0x1faddb(0x23e)]?.[_0x1faddb(0x1d1)])&&(_0x230abd=_0x213d2d['queue'][_0x1faddb(0x1d1)]);if(!_0x230abd)return;if(_0x28d310[_0x1faddb(0x285)])return;const _0x3d1769=path_1[_0x1faddb(0x220)][_0x1faddb(0x27a)](__dirname,'..','..','..',_0x1faddb(0x1b7));let _0x21a7ed;const _0x118263=sessionsOpenAi[_0x1faddb(0x323)](_0x357341=>_0x357341['id']===_0x51c1ce['id']);if(_0x118263===-0x1){const _0x211403=new openai_1[(_0x1faddb(0x2ca))]({'apiKey':_0x230abd['apiKey']});_0x21a7ed=new openai_1[(_0x1faddb(0x1a5))](_0x211403),_0x21a7ed['id']=_0x51c1ce['id'],sessionsOpenAi[_0x1faddb(0x28d)](_0x21a7ed);}else _0x21a7ed=sessionsOpenAi[_0x118263];const _0x583bc0=await Message_1['default'][_0x1faddb(0x1ab)]({'where':{'ticketId':_0x213d2d['id']},'order':[['createdAt',_0x1faddb(0x2cb)]],'limit':_0x230abd[_0x1faddb(0x313)]}),_0xe90a4='Nas\x20respostas\x20utilize\x20o\x20nome\x20'+sanitizeName(_0x15500f[_0x1faddb(0x1df)]||'Amigo(a)')+'\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20'+_0x230abd[_0x1faddb(0x197)]+_0x1faddb(0x1fb)+_0x230abd[_0x1faddb(0x1d1)]+'\x0a';let _0x2d2668=[];if(_0x28d310[_0x1faddb(0x301)]?.['conversation']||_0x28d310[_0x1faddb(0x301)]?.[_0x1faddb(0x1a3)]?.[_0x1faddb(0x30b)]){_0x2d2668=[],_0x2d2668[_0x1faddb(0x28d)]({'role':_0x1faddb(0x209),'content':_0xe90a4});for(let _0x5bcd19=0x0;_0x5bcd19<Math[_0x1faddb(0x1ac)](_0x230abd[_0x1faddb(0x313)],_0x583bc0[_0x1faddb(0x324)]);_0x5bcd19++){const _0x1b54bc=_0x583bc0[_0x5bcd19];_0x1b54bc[_0x1faddb(0x1cc)]==='chat'&&(_0x1b54bc[_0x1faddb(0x262)]?_0x2d2668['push']({'role':_0x1faddb(0x171),'content':_0x1b54bc[_0x1faddb(0x2f5)]}):_0x2d2668[_0x1faddb(0x28d)]({'role':_0x1faddb(0x1e0),'content':_0x1b54bc[_0x1faddb(0x2f5)]}));}_0x2d2668[_0x1faddb(0x28d)]({'role':_0x1faddb(0x1e0),'content':_0x90d4f8});const _0xa78d94=await _0x21a7ed[_0x1faddb(0x1ec)]({'model':_0x1faddb(0x187),'messages':_0x2d2668,'max_tokens':_0x230abd[_0x1faddb(0x197)],'temperature':_0x230abd['temperature']});let _0x342ee3=_0xa78d94[_0x1faddb(0x1ae)][_0x1faddb(0x2f8)][0x0][_0x1faddb(0x301)]?.['content'];_0x342ee3?.[_0x1faddb(0x246)](_0x1faddb(0x326))&&(await transferQueue(_0x230abd['queueId'],_0x213d2d,_0x15500f),_0x342ee3=_0x342ee3['replace'](_0x1faddb(0x326),'')[_0x1faddb(0x22b)]());if(_0x230abd[_0x1faddb(0x2ea)]===_0x1faddb(0x242)){const _0x147a6b=await _0x51c1ce['sendMessage'](_0x28d310[_0x1faddb(0x227)][_0x1faddb(0x2ab)],{'text':_0x342ee3});await(0x0,exports[_0x1faddb(0x1d9)])(_0x147a6b,_0x213d2d,_0x15500f);}else{const _0x3a55f0=_0x213d2d['id']+'_'+Date[_0x1faddb(0x1c1)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x342ee3),_0x3d1769+'/'+_0x3a55f0,_0x230abd[_0x1faddb(0x2fb)],_0x230abd['voiceRegion'],_0x230abd[_0x1faddb(0x2ea)],_0x1faddb(0x230))[_0x1faddb(0x1f9)](async()=>{const _0x2ce9a9=_0x1faddb;try{const _0x5c8292=await _0x51c1ce[_0x2ce9a9(0x30e)](_0x28d310[_0x2ce9a9(0x227)][_0x2ce9a9(0x2ab)],{'audio':{'url':_0x3d1769+'/'+_0x3a55f0+_0x2ce9a9(0x178)},'mimetype':'audio/mpeg','ptt':!![]});await verifyMediaMessage(_0x5c8292,_0x213d2d,_0x15500f),deleteFileSync(_0x3d1769+'/'+_0x3a55f0+_0x2ce9a9(0x178)),deleteFileSync(_0x3d1769+'/'+_0x3a55f0+_0x2ce9a9(0x214));}catch(_0x301616){console[_0x2ce9a9(0x1bd)](_0x2ce9a9(0x1fa)+_0x301616);}});}}else{if(_0x28d310[_0x1faddb(0x301)]?.[_0x1faddb(0x226)]){const _0x236412=_0x1a876f[_0x1faddb(0x1cb)][_0x1faddb(0x28e)]('/')[_0x1faddb(0x1fe)](),_0x1f456a=fs_2['default']['createReadStream'](_0x3d1769+'/'+_0x236412),_0x4d15b4=await _0x21a7ed[_0x1faddb(0x287)](_0x1f456a,'whisper-1');_0x2d2668=[],_0x2d2668['push']({'role':_0x1faddb(0x209),'content':_0xe90a4});for(let _0x11815e=0x0;_0x11815e<Math[_0x1faddb(0x1ac)](_0x230abd[_0x1faddb(0x313)],_0x583bc0[_0x1faddb(0x324)]);_0x11815e++){const _0x38343f=_0x583bc0[_0x11815e];_0x38343f[_0x1faddb(0x1cc)]===_0x1faddb(0x204)&&(_0x38343f[_0x1faddb(0x262)]?_0x2d2668[_0x1faddb(0x28d)]({'role':_0x1faddb(0x171),'content':_0x38343f[_0x1faddb(0x2f5)]}):_0x2d2668[_0x1faddb(0x28d)]({'role':'user','content':_0x38343f['body']}));}_0x2d2668['push']({'role':'user','content':_0x4d15b4[_0x1faddb(0x1ae)][_0x1faddb(0x30b)]});const _0xf56b7f=await _0x21a7ed[_0x1faddb(0x1ec)]({'model':_0x1faddb(0x187),'messages':_0x2d2668,'max_tokens':_0x230abd[_0x1faddb(0x197)],'temperature':_0x230abd[_0x1faddb(0x27e)]});let _0x46f6d4=_0xf56b7f['data']['choices'][0x0][_0x1faddb(0x301)]?.[_0x1faddb(0x1f2)];_0x46f6d4?.[_0x1faddb(0x246)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x230abd[_0x1faddb(0x2ad)],_0x213d2d,_0x15500f),_0x46f6d4=_0x46f6d4['replace'](_0x1faddb(0x326),'')[_0x1faddb(0x22b)]());if(_0x230abd[_0x1faddb(0x2ea)]===_0x1faddb(0x242)){const _0x1da221=await _0x51c1ce[_0x1faddb(0x30e)](_0x28d310[_0x1faddb(0x227)][_0x1faddb(0x2ab)],{'text':_0x46f6d4});await(0x0,exports[_0x1faddb(0x1d9)])(_0x1da221,_0x213d2d,_0x15500f);}else{const _0x5aa12f=_0x213d2d['id']+'_'+Date[_0x1faddb(0x1c1)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x46f6d4),_0x3d1769+'/'+_0x5aa12f,_0x230abd['voiceKey'],_0x230abd[_0x1faddb(0x198)],_0x230abd[_0x1faddb(0x2ea)],_0x1faddb(0x230))['then'](async()=>{const _0x4fa911=_0x1faddb;try{const _0x58539d=await _0x51c1ce['sendMessage'](_0x28d310[_0x4fa911(0x227)][_0x4fa911(0x2ab)],{'audio':{'url':_0x3d1769+'/'+_0x5aa12f+'.mp3'},'mimetype':_0x4fa911(0x1a8),'ptt':!![]});await verifyMediaMessage(_0x58539d,_0x213d2d,_0x15500f),deleteFileSync(_0x3d1769+'/'+_0x5aa12f+_0x4fa911(0x178)),deleteFileSync(_0x3d1769+'/'+_0x5aa12f+_0x4fa911(0x214));}catch(_0x267ae8){console['log'](_0x4fa911(0x1fa)+_0x267ae8);}});}}}_0x2d2668=[];},transferQueue=async(_0x1d308,_0x4ff7f5,_0x281d04)=>{const _0x39ad4c=a558_0x25a89b;console[_0x39ad4c(0x1b0)](_0x39ad4c(0x1ef)),await(0x0,UpdateTicketService_1[_0x39ad4c(0x220)])({'ticketData':{'queueId':_0x1d308,'useIntegration':![],'promptId':null},'ticketId':_0x4ff7f5['id'],'companyId':_0x4ff7f5[_0x39ad4c(0x228)]});},verifyMediaMessage=async(_0x47d5f7,_0x386316,_0x2db4a6)=>{const _0x1b0be8=a558_0x25a89b,_0x2eeab3=(0x0,socket_1[_0x1b0be8(0x175)])();let _0x2d3865=await Message_1[_0x1b0be8(0x220)]['findOne']({'where':{'id':_0x47d5f7[_0x1b0be8(0x227)]['id']}});if(!_0x2d3865){const _0x50ad1d=await(0x0,exports[_0x1b0be8(0x2c2)])(_0x47d5f7),_0x4f0764=(0x0,wbot_1[_0x1b0be8(0x188)])(_0x386316[_0x1b0be8(0x307)]),_0x289a9a=await downloadMedia(_0x47d5f7);if(!_0x289a9a)throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');if(!_0x289a9a[_0x1b0be8(0x254)]){const _0x138582=typeof _0x289a9a['mimetype']===_0x1b0be8(0x243)&&_0x289a9a['mimetype']['includes']('/')&&_0x289a9a[_0x1b0be8(0x2d7)][_0x1b0be8(0x246)](';')?mime_1[_0x1b0be8(0x220)][_0x1b0be8(0x22e)](_0x289a9a[_0x1b0be8(0x2d7)]):_0x1b0be8(0x181);_0x289a9a['filename']=new Date()['getTime']()+'.'+_0x138582;}else{let _0x58fcb4=_0x289a9a[_0x1b0be8(0x254)]?'-'+_0x289a9a[_0x1b0be8(0x254)]:'';_0x289a9a['filename']=''+new Date()['getTime']()+_0x58fcb4;}try{const _0xd0a0a4='public/company'+_0x386316[_0x1b0be8(0x228)];!fs_2[_0x1b0be8(0x220)][_0x1b0be8(0x2a1)](_0xd0a0a4)&&(fs_2[_0x1b0be8(0x220)][_0x1b0be8(0x2aa)](_0xd0a0a4),fs_2['default']['chmodSync'](_0xd0a0a4,0x1ff)),await writeFileAsync((0x0,path_1[_0x1b0be8(0x2a4)])(__dirname,'..','..','..',_0xd0a0a4,_0x289a9a['filename']),_0x289a9a['data'],_0x1b0be8(0x16d));}catch(_0x3602da){Sentry[_0x1b0be8(0x293)](_0x3602da),logger_1[_0x1b0be8(0x329)]['error'](_0x3602da);}const _0x1909d8=(0x0,exports[_0x1b0be8(0x31f)])(_0x47d5f7);var _0x295701=getTypeMessage(_0x47d5f7);const _0xb02c47={'id':_0x47d5f7[_0x1b0be8(0x227)]['id'],'ticketId':_0x386316['id'],'contactId':_0x47d5f7[_0x1b0be8(0x227)][_0x1b0be8(0x262)]?undefined:_0x2db4a6['id'],'body':_0x1909d8?(0x0,Mustache_1[_0x1b0be8(0x220)])(_0x1909d8,_0x386316):_0x289a9a[_0x1b0be8(0x254)],'fromMe':_0x47d5f7['key'][_0x1b0be8(0x262)],'read':_0x47d5f7['key'][_0x1b0be8(0x262)],'mediaUrl':_0x289a9a[_0x1b0be8(0x254)],'mediaType':typeof _0x289a9a[_0x1b0be8(0x2d7)]===_0x1b0be8(0x243)?_0x289a9a[_0x1b0be8(0x2d7)]['split']('/')[0x0]:_0x1b0be8(0x181),'quotedMsgId':_0x50ad1d?.['id'],'ack':getStatus(_0x47d5f7,_0x1b0be8(0x1bf)),'remoteJid':_0x47d5f7[_0x1b0be8(0x227)][_0x1b0be8(0x2ab)],'participant':_0x47d5f7[_0x1b0be8(0x227)][_0x1b0be8(0x1c4)],'dataJson':JSON[_0x1b0be8(0x1d5)](_0x47d5f7)};var _0x3432ab=_0x1909d8||_0x289a9a['filename'];typeof _0x3432ab!=_0x1b0be8(0x243)&&console['trace']('body\x20is\x20not\x20a\x20string',_0x3432ab),await _0x386316[_0x1b0be8(0x201)]({'lastMessage':_0x3432ab}),_0x2d3865=await(0x0,CreateMessageService_1['default'])({'messageData':_0xb02c47,'ticket':_0x386316,'companyId':_0x386316['companyId']});}else typeof _0x2d3865[_0x1b0be8(0x2f5)]!=_0x1b0be8(0x243)&&console[_0x1b0be8(0x1b0)](_0x1b0be8(0x29b),_0x2d3865['body']),await _0x386316[_0x1b0be8(0x201)]({'lastMessage':_0x2d3865[_0x1b0be8(0x2f5)]}),_0x2d3865[_0x1b0be8(0x249)]=getStatus(_0x47d5f7,_0x1b0be8(0x1bf)),_0x2d3865[_0x1b0be8(0x1c4)]=_0x47d5f7[_0x1b0be8(0x227)]['participant'],_0x2d3865['dataJson']=JSON[_0x1b0be8(0x1d5)](_0x47d5f7),await _0x2d3865['save']();return!_0x47d5f7[_0x1b0be8(0x227)]['fromMe']&&_0x386316[_0x1b0be8(0x211)]===_0x1b0be8(0x319)&&(await _0x386316[_0x1b0be8(0x201)]({'status':_0x1b0be8(0x216)}),await _0x386316[_0x1b0be8(0x2d5)]({'include':[{'model':Queue_1['default'],'as':_0x1b0be8(0x23e)},{'model':User_1[_0x1b0be8(0x220)],'as':_0x1b0be8(0x1e0)},{'model':Contact_1[_0x1b0be8(0x220)],'as':_0x1b0be8(0x299)}]}),_0x2eeab3['to'](_0x1b0be8(0x321)+_0x386316[_0x1b0be8(0x228)]+'-closed')[_0x1b0be8(0x1fd)](_0x1b0be8(0x321)+_0x386316[_0x1b0be8(0x228)]+_0x1b0be8(0x25b),{'action':_0x1b0be8(0x273),'ticket':_0x386316,'ticketId':_0x386316['id']}),_0x2eeab3['to'](_0x1b0be8(0x321)+_0x386316[_0x1b0be8(0x228)]+'-'+_0x386316[_0x1b0be8(0x211)])['to'](_0x386316['id'][_0x1b0be8(0x224)]())['emit'](_0x1b0be8(0x321)+_0x386316[_0x1b0be8(0x228)]+_0x1b0be8(0x25b),{'action':_0x1b0be8(0x201),'ticket':_0x386316,'ticketId':_0x386316['id']})),_0x2d3865;};function getStatus(_0x1b0a10,_0x162929){const _0x1c3b38=a558_0x25a89b;if(_0x1b0a10[_0x1c3b38(0x211)]==baileys_1[_0x1c3b38(0x196)][_0x1c3b38(0x29d)][_0x1c3b38(0x1d4)][_0x1c3b38(0x1ca)]){if(_0x1b0a10[_0x1c3b38(0x227)][_0x1c3b38(0x262)]&&_0x162929==_0x1c3b38(0x30c))return 0x3;return 0x1;}else{if(_0x1b0a10[_0x1c3b38(0x211)]==baileys_1['proto'][_0x1c3b38(0x29d)]['Status']['SERVER_ACK'])return 0x1;else{if(_0x1b0a10[_0x1c3b38(0x211)]==baileys_1[_0x1c3b38(0x196)][_0x1c3b38(0x29d)][_0x1c3b38(0x1d4)][_0x1c3b38(0x18f)])return 0x2;else{if(_0x1b0a10[_0x1c3b38(0x211)]==baileys_1['proto'][_0x1c3b38(0x29d)]['Status'][_0x1c3b38(0x2c7)]||_0x1b0a10[_0x1c3b38(0x211)]==baileys_1[_0x1c3b38(0x196)][_0x1c3b38(0x29d)][_0x1c3b38(0x1d4)][_0x1c3b38(0x193)])return 0x3;}}}return 0x0;}const verifyMessage=async(_0x3b1a2d,_0x374ff8,_0x44da6f)=>{const _0x3b3921=a558_0x25a89b,_0x3cc63e=(0x0,socket_1[_0x3b3921(0x175)])(),_0x9615a0=await(0x0,exports[_0x3b3921(0x2c2)])(_0x3b1a2d),_0x4eff87=(0x0,exports[_0x3b3921(0x31f)])(_0x3b1a2d);if(!_0x4eff87)return;let _0x4fb02f=getTypeMessage(_0x3b1a2d);const _0x491be0=_0x4fb02f==_0x3b3921(0x174)||_0x3b1a2d?.[_0x3b3921(0x301)]?.[_0x3b3921(0x286)]?.[_0x3b3921(0x2ef)]==baileys_1[_0x3b3921(0x196)]['Message'][_0x3b3921(0x20c)][_0x3b3921(0x2d9)][_0x3b3921(0x219)]||_0x3b1a2d?.['message']?.[_0x3b3921(0x286)]?.[_0x3b3921(0x174)]?.['conversation']?.[_0x3b3921(0x324)]>0x0;let _0x44d25b=_0x3b1a2d[_0x3b3921(0x227)]['id'];if(_0x4fb02f==_0x3b3921(0x286))_0x44d25b=_0x3b1a2d?.[_0x3b3921(0x301)]?.[_0x3b3921(0x286)]?.[_0x3b3921(0x227)]?.['id']||_0x3b1a2d[_0x3b3921(0x227)]['id'];else _0x4fb02f==_0x3b3921(0x174)&&(_0x44d25b=_0x3b1a2d?.[_0x3b3921(0x301)]?.[_0x3b3921(0x174)]?.[_0x3b3921(0x301)]?.[_0x3b3921(0x286)]?.['key']?.['id']||_0x3b1a2d[_0x3b3921(0x227)]['id']);const _0x222f38={'id':_0x44d25b,'ticketId':_0x374ff8['id'],'contactId':_0x3b1a2d[_0x3b3921(0x227)][_0x3b3921(0x262)]?undefined:_0x44da6f['id'],'body':_0x4eff87,'fromMe':_0x3b1a2d[_0x3b3921(0x227)][_0x3b3921(0x262)],'mediaType':_0x4fb02f,'read':_0x3b1a2d[_0x3b3921(0x227)][_0x3b3921(0x262)],'quotedMsgId':_0x9615a0?.['id'],'ack':getStatus(_0x3b1a2d,_0x4fb02f),'remoteJid':_0x3b1a2d[_0x3b3921(0x227)]['remoteJid'],'participant':_0x3b1a2d['key'][_0x3b3921(0x1c4)],'dataJson':JSON[_0x3b3921(0x1d5)](_0x3b1a2d),'isEdited':_0x491be0};typeof _0x4eff87!='string'&&console[_0x3b3921(0x1b0)]('body\x20is\x20not\x20a\x20string',_0x4eff87);await _0x374ff8[_0x3b3921(0x201)]({'lastMessage':_0x4eff87});if(_0x491be0){let _0x5eec01=await Message_1[_0x3b3921(0x220)][_0x3b3921(0x1ce)](_0x222f38['id']);if(_0x5eec01){const _0x10612f={'messageId':_0x222f38['id'],'body':_0x5eec01['body']};await OldMessage_1[_0x3b3921(0x220)]['upsert'](_0x10612f);}else console[_0x3b3921(0x1bd)](_0x3b3921(0x2d4)+_0x222f38['id']);}await(0x0,CreateMessageService_1[_0x3b3921(0x220)])({'messageData':_0x222f38,'ticket':_0x374ff8,'companyId':_0x374ff8[_0x3b3921(0x228)]}),!_0x3b1a2d[_0x3b3921(0x227)]['fromMe']&&_0x374ff8['status']===_0x3b3921(0x319)&&(await _0x374ff8[_0x3b3921(0x201)]({'status':_0x3b3921(0x216)}),await _0x374ff8[_0x3b3921(0x2d5)]({'include':[{'model':Queue_1[_0x3b3921(0x220)],'as':'queue'},{'model':User_1[_0x3b3921(0x220)],'as':'user'},{'model':Contact_1['default'],'as':_0x3b3921(0x299)}]}),_0x3cc63e['to'](_0x3b3921(0x321)+_0x374ff8['companyId']+'-closed')[_0x3b3921(0x1fd)](_0x3b3921(0x321)+_0x374ff8['companyId']+_0x3b3921(0x25b),{'action':_0x3b3921(0x273),'ticket':_0x374ff8,'ticketId':_0x374ff8['id']}),_0x3cc63e['to']('company-'+_0x374ff8[_0x3b3921(0x228)]+'-'+_0x374ff8['status'])['to'](_0x374ff8['id'][_0x3b3921(0x224)]())['emit']('company-'+_0x374ff8[_0x3b3921(0x228)]+_0x3b3921(0x25b),{'action':_0x3b3921(0x201),'ticket':_0x374ff8,'ticketId':_0x374ff8['id']}));};exports['verifyMessage']=verifyMessage;const isValidMsg=_0x5bfbcb=>{const _0x1a1a2a=a558_0x25a89b;if(_0x5bfbcb['key']['remoteJid']===_0x1a1a2a(0x2dc))return![];try{const _0x5b0223=getTypeMessage(_0x5bfbcb);if(!_0x5b0223)return![];const _0xfbbaf5=_0x5b0223==='conversation'||_0x5b0223===_0x1a1a2a(0x174)||_0x5b0223===_0x1a1a2a(0x1a3)||_0x5b0223==='audioMessage'||_0x5b0223===_0x1a1a2a(0x32b)||_0x5b0223===_0x1a1a2a(0x17d)||_0x5b0223==='templateMessage'||_0x5b0223===_0x1a1a2a(0x1d2)||_0x5b0223==='interactiveMessage'||_0x5b0223==='imageMessage'||_0x5b0223===_0x1a1a2a(0x31e)||_0x5b0223===_0x1a1a2a(0x1b6)||_0x5b0223===_0x1a1a2a(0x259)||_0x5b0223===_0x1a1a2a(0x2c9)||_0x5b0223===_0x1a1a2a(0x1f4)||_0x5b0223===_0x1a1a2a(0x231)||_0x5b0223===_0x1a1a2a(0x25c)||_0x5b0223===_0x1a1a2a(0x20d)||_0x5b0223==='contactMessage'||_0x5b0223===_0x1a1a2a(0x23f)||_0x5b0223==='mediaMessage'||_0x5b0223===_0x1a1a2a(0x30a)||_0x5b0223===_0x1a1a2a(0x30c)||_0x5b0223===_0x1a1a2a(0x1cf)||_0x5b0223==='protocolMessage'||_0x5b0223==='listResponseMessage'||_0x5b0223===_0x1a1a2a(0x2fa)||_0x5b0223===_0x1a1a2a(0x200)||_0x5b0223===_0x1a1a2a(0x20b)||_0x5b0223===_0x1a1a2a(0x255)||_0x5b0223===_0x1a1a2a(0x2ff);return!_0xfbbaf5&&(logger_1[_0x1a1a2a(0x329)]['warn'](_0x1a1a2a(0x278)+_0x5b0223+'\x0a'+JSON[_0x1a1a2a(0x1d5)](_0x5bfbcb?.[_0x1a1a2a(0x301)])),Sentry['setExtra'](_0x1a1a2a(0x297),{'BodyMsg':_0x5bfbcb[_0x1a1a2a(0x301)],'msg':_0x5bfbcb,'msgType':_0x5b0223}),Sentry[_0x1a1a2a(0x293)](new Error(_0x1a1a2a(0x2fd)))),!!_0xfbbaf5;}catch(_0x51ebc8){Sentry[_0x1a1a2a(0x31b)](_0x1a1a2a(0x248),{'msg':_0x5bfbcb}),Sentry['captureException'](_0x51ebc8);}return![];};function a558_0x59f5(_0x3a831e,_0x28ce31){const _0x51ee19=a558_0x22b9();return a558_0x59f5=function(_0x34f738,_0x12dfa8){_0x34f738=_0x34f738-0x16c;let _0x22b987=_0x51ee19[_0x34f738];return _0x22b987;},a558_0x59f5(_0x3a831e,_0x28ce31);}exports[a558_0x25a89b(0x2e1)]=isValidMsg;const Push=_0xe048a=>{const _0x5d4022=a558_0x25a89b;return _0xe048a[_0x5d4022(0x2cf)];},verifyQueue=async(_0x57b3b3,_0x5d52fb,_0x2e4a0b,_0x27cccd,_0x193878)=>{const _0x199d7c=a558_0x25a89b,_0x42965d=_0x2e4a0b['companyId'],{queues:_0x278781,greetingMessage:_0x3c4ff6,maxUseBotQueues:_0x2e1559,timeUseBotQueues:_0xccee02}=await(0x0,ShowWhatsAppService_1['default'])(_0x57b3b3['id'],_0x2e4a0b['companyId']);if(_0x278781[_0x199d7c(0x324)]===0x1){const _0x8a856a=(0x0,lodash_1['head'])(_0x278781);let _0x36b078=![];_0x8a856a?.[_0x199d7c(0x27d)]&&(_0x36b078=_0x8a856a[_0x199d7c(0x27d)][_0x199d7c(0x324)]>0x0);const _0x58159a=await Setting_1[_0x199d7c(0x220)]['findOne']({'where':{'key':_0x199d7c(0x306),'companyId':_0x2e4a0b[_0x199d7c(0x228)]}});greetingMessageControl['push']({'ticketId':_0x2e4a0b['id'],'greetingMessage':_0x3c4ff6,'companyId':_0x42965d});if(_0x3c4ff6[_0x199d7c(0x324)]>0x1&&_0x58159a?.[_0x199d7c(0x280)]===_0x199d7c(0x215)){const _0x342152=await Message_1[_0x199d7c(0x220)][_0x199d7c(0x1f1)]({'where':{'ticketId':_0x2e4a0b['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x199d7c(0x2dd)]]:(0x0,moment_1[_0x199d7c(0x220)])()['subtract'](0x5,_0x199d7c(0x16e))['toDate']()}}});if(_0x342152)return;const _0xf17e55=(0x0,Mustache_1[_0x199d7c(0x220)])(''+_0x3c4ff6,_0x2e4a0b);await _0x57b3b3[_0x199d7c(0x30e)](_0x27cccd[_0x199d7c(0x24b)]+'@'+(_0x2e4a0b[_0x199d7c(0x1f3)]?_0x199d7c(0x194):'s.whatsapp.net'),{'text':_0xf17e55});}const _0x9aacb0=await(0x0,ShowWhatsAppService_1[_0x199d7c(0x220)])(_0x57b3b3['id'],_0x42965d),_0x3ca9cf=_0x278781[0x0]?.['integrationId']||_0x9aacb0[_0x199d7c(0x1ed)];if(!_0x5d52fb[_0x199d7c(0x227)][_0x199d7c(0x262)]&&!_0x2e4a0b[_0x199d7c(0x1f3)]&&!(0x0,lodash_1[_0x199d7c(0x26d)])(_0x3ca9cf)){const _0x4e7cf7=await(0x0,ShowQueueIntegrationService_1['default'])(_0x3ca9cf,_0x42965d);await(0x0,exports[_0x199d7c(0x290)])(_0x5d52fb,_0x57b3b3,_0x4e7cf7,_0x2e4a0b),await _0x2e4a0b[_0x199d7c(0x201)]({'useIntegration':!![],'integrationId':_0x4e7cf7['id']});}const _0x46bd3b=_0x278781[0x0]?.[_0x199d7c(0x182)]||_0x9aacb0[_0x199d7c(0x182)];!_0x5d52fb[_0x199d7c(0x227)]['fromMe']&&!_0x2e4a0b['isGroup']&&!(0x0,lodash_1[_0x199d7c(0x26d)])(_0x46bd3b)&&(console[_0x199d7c(0x1bd)](_0x199d7c(0x279)),await handleOpenAi(_0x5d52fb,_0x57b3b3,_0x2e4a0b,_0x27cccd,_0x193878),await _0x2e4a0b['update']({'useIntegration':!![],'promptId':_0x46bd3b}));await(0x0,UpdateTicketService_1[_0x199d7c(0x220)])({'ticketData':{'queueId':_0x8a856a?.['id'],'chatbot':_0x36b078,'status':_0x199d7c(0x216)},'ticketId':_0x2e4a0b['id'],'companyId':_0x2e4a0b[_0x199d7c(0x228)]});return;}const _0x6460a0=_0x5d52fb?.['message']?.['buttonsResponseMessage']?.[_0x199d7c(0x2be)]||_0x5d52fb?.['message']?.['listResponseMessage']?.[_0x199d7c(0x2f0)]?.[_0x199d7c(0x222)]||_0x5d52fb?.[_0x199d7c(0x301)]?.[_0x199d7c(0x1a3)]?.['text']||_0x5d52fb?.[_0x199d7c(0x301)]?.[_0x199d7c(0x2de)];let _0x3d7ba9=null;if(_0x6460a0&&!(0x0,exports[_0x199d7c(0x2c3)])(_0x6460a0)||+_0x6460a0>_0x278781['length']){const _0x55edf3=_0x6460a0[_0x199d7c(0x2c4)]();for(let _0x1ae76d of _0x278781){if(_0x1ae76d['name'][_0x199d7c(0x2c4)]()===_0x55edf3){_0x3d7ba9=_0x1ae76d;break;}if(_0x1ae76d['keywords']&&_0x1ae76d['keywords']['length']>0x0){let _0x3e298e=_0x1ae76d[_0x199d7c(0x1bc)][_0x199d7c(0x28e)](',\x20');for(let _0x385487 of _0x3e298e){if(_0x385487[_0x199d7c(0x2c4)]()==_0x55edf3){_0x3d7ba9=_0x1ae76d;break;}}}}}else _0x3d7ba9=_0x278781[+_0x6460a0-0x1];const _0x5018af=await Setting_1[_0x199d7c(0x220)][_0x199d7c(0x1f1)]({'where':{'key':_0x199d7c(0x1af),'companyId':_0x42965d}}),_0x241f5a=async()=>{const _0x572ce6=_0x199d7c;let _0x1df618='';if(outOfHourMessageControl[_0x572ce6(0x324)]>0x1388)outOfHourMessageControl=[];_0x278781[_0x572ce6(0x18b)]((_0xb19061,_0x130aa6)=>{const _0x4e98ed=_0x572ce6;_0x1df618+='*[\x20'+(_0x130aa6+0x1)+_0x4e98ed(0x195)+_0xb19061[_0x4e98ed(0x1df)]+'\x0a';});if(process[_0x572ce6(0x291)]['CHATBOT_RESTRICT_NUMBER']?.[_0x572ce6(0x324)]>=0x8){if(_0x2e4a0b[_0x572ce6(0x299)][_0x572ce6(0x24b)]!=process['env']['CHATBOT_RESTRICT_NUMBER']){console[_0x572ce6(0x1b0)]('chatbot\x20desativado!');return;}}const _0x14cc36={'text':(0x0,Mustache_1[_0x572ce6(0x220)])('‎'+_0x3c4ff6+'\x0a\x0a'+_0x1df618,_0x2e4a0b)};await(0x0,UpdateTicketService_1['default'])({'ticketData':{'amountUsedBotQueues':_0x2e4a0b[_0x572ce6(0x2e9)]+0x1},'ticketId':_0x2e4a0b['id'],'companyId':_0x2e4a0b[_0x572ce6(0x228)]});const _0x4c7599=await _0x57b3b3[_0x572ce6(0x30e)](_0x27cccd[_0x572ce6(0x24b)]+'@'+(_0x2e4a0b[_0x572ce6(0x1f3)]?'g.us':_0x572ce6(0x328)),_0x14cc36);await(0x0,exports[_0x572ce6(0x1d9)])(_0x4c7599,_0x2e4a0b,_0x2e4a0b[_0x572ce6(0x299)]);};if(_0x3d7ba9){let _0x32aa0c=![];_0x3d7ba9?.['options']&&(_0x32aa0c=_0x3d7ba9['options'][_0x199d7c(0x324)]>0x0);await(0x0,UpdateTicketService_1[_0x199d7c(0x220)])({'ticketData':{'queueId':_0x3d7ba9['id'],'chatbot':_0x32aa0c,'status':_0x199d7c(0x216),'amountUsedBotQueues':0x0},'ticketId':_0x2e4a0b['id'],'companyId':_0x2e4a0b['companyId']}),console['trace'](_0x3d7ba9[_0x199d7c(0x27d)]);if(_0x3d7ba9[_0x199d7c(0x27d)][_0x199d7c(0x324)]===0x0){const _0x19db07=await Queue_1[_0x199d7c(0x220)][_0x199d7c(0x1ce)](_0x3d7ba9['id']),{schedules:_0x521e3f}=_0x19db07,_0x55af9f=(0x0,moment_1['default'])(),_0x578566=_0x55af9f[_0x199d7c(0x2f3)](_0x199d7c(0x203))['toLowerCase']();let _0x462acb;Array[_0x199d7c(0x2e3)](_0x521e3f)&&_0x521e3f['length']>0x0&&(_0x462acb=_0x521e3f[_0x199d7c(0x2e0)](_0x247d39=>_0x247d39[_0x199d7c(0x311)]===_0x578566&&_0x247d39[_0x199d7c(0x265)]!==''&&_0x247d39[_0x199d7c(0x265)]!==null&&_0x247d39['endTime']!==''&&_0x247d39[_0x199d7c(0x24f)]!==null));if(_0x19db07[_0x199d7c(0x2c8)]!==null&&_0x19db07[_0x199d7c(0x2c8)]!==''&&!(0x0,lodash_1[_0x199d7c(0x26d)])(_0x462acb)){var _0x16fd90=outOfHourMessageControl['find'](_0x4c9922=>_0x4c9922['ticketId']===_0x2e4a0b['id']||_0x4c9922[_0x199d7c(0x1da)]===_0x27cccd['number']);if(!_0x16fd90||_0x16fd90&&_0x16fd90['time']+0x3e8*0x3c*0x5<new Date()[_0x199d7c(0x2f9)]()){_0x16fd90&&(outOfHourMessageControl=outOfHourMessageControl['filter'](_0x4bc241=>_0x4bc241[_0x199d7c(0x26e)]!==_0x2e4a0b['id']),_0x16fd90=null);const _0x10af36=(0x0,moment_1[_0x199d7c(0x220)])(_0x462acb['startTime'],_0x199d7c(0x1f8)),_0xe4f477=(0x0,moment_1['default'])(_0x462acb[_0x199d7c(0x24f)],_0x199d7c(0x1f8));outOfHourMessageControl[_0x199d7c(0x28d)]({'ticketId':_0x2e4a0b['id'],'time':new Date()[_0x199d7c(0x2f9)]()});if(_0x55af9f[_0x199d7c(0x234)](_0x10af36)||_0x55af9f[_0x199d7c(0x2ee)](_0xe4f477)){const _0x33cbef=(0x0,Mustache_1[_0x199d7c(0x220)])('‎\x20'+_0x19db07[_0x199d7c(0x2c8)]+_0x199d7c(0x183),_0x2e4a0b),_0x55908b=await _0x57b3b3[_0x199d7c(0x30e)](_0x27cccd[_0x199d7c(0x24b)]+'@'+(_0x2e4a0b[_0x199d7c(0x1f3)]?_0x199d7c(0x194):_0x199d7c(0x328)),{'text':_0x33cbef});await(0x0,exports['verifyMessage'])(_0x55908b,_0x2e4a0b,_0x27cccd),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':null,'chatbot':_0x32aa0c},'ticketId':_0x2e4a0b['id'],'companyId':_0x2e4a0b[_0x199d7c(0x228)]}),console[_0x199d7c(0x1bd)](_0x199d7c(0x25a));return;}}!_0x16fd90&&outOfHourMessageControl[_0x199d7c(0x28d)]({'ticketId':_0x2e4a0b['id'],'dest':_0x27cccd['number'],'time':new Date()['getTime']()});}console['trace'](_0x3d7ba9[_0x199d7c(0x1ed)]);if(!_0x5d52fb[_0x199d7c(0x227)][_0x199d7c(0x262)]&&!_0x2e4a0b['isGroup']&&_0x3d7ba9[_0x199d7c(0x1ed)]){const _0x20285e=await(0x0,ShowQueueIntegrationService_1[_0x199d7c(0x220)])(_0x3d7ba9[_0x199d7c(0x1ed)],_0x42965d);await(0x0,exports['handleMessageIntegration'])(_0x5d52fb,_0x57b3b3,_0x20285e,_0x2e4a0b),await _0x2e4a0b[_0x199d7c(0x201)]({'useIntegration':!![],'integrationId':_0x20285e['id']});}!_0x5d52fb['key'][_0x199d7c(0x262)]&&!_0x2e4a0b[_0x199d7c(0x1f3)]&&!(0x0,lodash_1[_0x199d7c(0x26d)])(_0x3d7ba9?.[_0x199d7c(0x182)])&&(await handleOpenAi(_0x5d52fb,_0x57b3b3,_0x2e4a0b,_0x27cccd,_0x193878),await _0x2e4a0b['update']({'useIntegration':!![],'promptId':_0x3d7ba9?.[_0x199d7c(0x182)]}));const _0x3293f8=(0x0,Mustache_1[_0x199d7c(0x220)])('‎'+_0x3d7ba9[_0x199d7c(0x22f)],_0x2e4a0b);if(_0x3d7ba9[_0x199d7c(0x22f)]){const _0x56a15b=await _0x57b3b3[_0x199d7c(0x30e)](_0x27cccd['number']+'@'+(_0x2e4a0b[_0x199d7c(0x1f3)]?_0x199d7c(0x194):_0x199d7c(0x328)),{'text':_0x3293f8});await(0x0,exports[_0x199d7c(0x1d9)])(_0x56a15b,_0x2e4a0b,_0x27cccd);if(_0x3d7ba9[_0x199d7c(0x312)]!==null&&_0x3d7ba9['mediaPath']!==''){const _0x2adece=path_1['default'][_0x199d7c(0x27a)]('public',_0x199d7c(0x2ba)+_0x3d7ba9['companyId'],_0x3d7ba9[_0x199d7c(0x312)]),_0x183464=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x3d7ba9[_0x199d7c(0x218)],_0x2adece,null,_0x2e4a0b['companyId']);let _0x3e70c0=await _0x57b3b3['sendMessage'](_0x2e4a0b['contact']['number']+'@'+(_0x2e4a0b[_0x199d7c(0x1f3)]?_0x199d7c(0x194):'s.whatsapp.net'),{..._0x183464});await verifyMediaMessage(_0x3e70c0,_0x2e4a0b,_0x27cccd);}}}}else{if(_0x2e1559&&_0x2e1559!==0x0&&_0x2e4a0b['amountUsedBotQueues']>=_0x2e1559)return;const _0x3166ab=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x2e4a0b['id'],'companyId':_0x42965d});let _0x3c390c=new Date(),_0x1ccae7=new Date();if(_0x3166ab[_0x199d7c(0x30f)]!==null){_0x3c390c[_0x199d7c(0x223)](_0x3166ab[_0x199d7c(0x30f)][_0x199d7c(0x253)]()+Number(_0xccee02));if(_0x3166ab[_0x199d7c(0x30f)]!==null&&_0x1ccae7<_0x3c390c&&_0xccee02!=='0'&&_0x2e4a0b[_0x199d7c(0x2e9)]!==0x0)return;}await _0x3166ab[_0x199d7c(0x201)]({'updatedAt':new Date()});if(_0x5018af[_0x199d7c(0x280)]===_0x199d7c(0x30b))return console[_0x199d7c(0x1b0)](_0x199d7c(0x22a)),_0x241f5a();}},verifyRating=_0x3f96d4=>{const _0x4dea09=a558_0x25a89b;return _0x3f96d4&&_0x3f96d4[_0x4dea09(0x327)]===null&&_0x3f96d4[_0x4dea09(0x18e)]!==null&&_0x3f96d4[_0x4dea09(0x2e5)]!==null;};exports['verifyRating']=verifyRating;const handleRating=async(_0x445fe4,_0x4fb229,_0x1542ac)=>{const _0x26bd7e=a558_0x25a89b,_0x320417=(0x0,socket_1[_0x26bd7e(0x175)])();let _0x46edb6=null;(_0x445fe4?.[_0x26bd7e(0x301)]?.['conversation']||_0x445fe4?.[_0x26bd7e(0x301)]?.[_0x26bd7e(0x1a3)])&&(_0x46edb6=parseInt(_0x445fe4['message'][_0x26bd7e(0x2de)]||_0x445fe4['message'][_0x26bd7e(0x1a3)]['text'],0xa)||null);if(!Number[_0x26bd7e(0x31a)](_0x46edb6)&&Number[_0x26bd7e(0x1a7)](_0x46edb6)&&!(0x0,lodash_1[_0x26bd7e(0x298)])(_0x46edb6)){const {complationMessage:_0x207263}=await(0x0,ShowWhatsAppService_1[_0x26bd7e(0x220)])(_0x4fb229[_0x26bd7e(0x307)],_0x4fb229[_0x26bd7e(0x228)]);let _0x51d6ed=_0x46edb6;_0x46edb6<0x1&&(_0x51d6ed=0x1);_0x46edb6>0x5&&(_0x51d6ed=0x5);await UserRating_1[_0x26bd7e(0x220)][_0x26bd7e(0x256)]({'ticketId':_0x1542ac['ticketId'],'companyId':_0x1542ac[_0x26bd7e(0x228)],'userId':_0x1542ac[_0x26bd7e(0x18e)],'rate':_0x51d6ed});if(_0x207263){if(completionMessageControl['length']>=0x9c4)completionMessageControl=[];var _0x798897=completionMessageControl[_0x26bd7e(0x2e0)](_0x55c0e0=>_0x55c0e0[_0x26bd7e(0x26e)]===_0x4fb229['id']||_0x55c0e0[_0x26bd7e(0x1da)]===_0x4fb229[_0x26bd7e(0x299)][_0x26bd7e(0x24b)]);if(!_0x798897||_0x798897&&_0x798897[_0x26bd7e(0x1c5)]+0x3e8*0x3c*0x1e<new Date()[_0x26bd7e(0x2f9)]()){_0x798897&&(completionMessageControl=completionMessageControl[_0x26bd7e(0x1d6)](_0x3afaa8=>_0x3afaa8[_0x26bd7e(0x26e)]!==_0x4fb229['id']),_0x798897=null);const _0x3d189a=(0x0,Mustache_1[_0x26bd7e(0x220)])('‎'+_0x207263,_0x4fb229);await(0x0,SendPresenceStatus_1[_0x26bd7e(0x314)])((0x0,wbot_1['getWbot'])(_0x4fb229[_0x26bd7e(0x307)]),_0x4fb229[_0x26bd7e(0x299)][_0x26bd7e(0x24b)]+'@'+(_0x4fb229[_0x26bd7e(0x1f3)]?_0x26bd7e(0x194):_0x26bd7e(0x328))),await(0x0,SendWhatsAppMessage_1[_0x26bd7e(0x220)])({'body':_0x3d189a,'ticket':_0x4fb229});}!_0x798897&&completionMessageControl[_0x26bd7e(0x28d)]({'ticketId':_0x4fb229['id'],'dest':_0x4fb229[_0x26bd7e(0x299)][_0x26bd7e(0x24b)],'time':new Date()['getTime']()});}await _0x1542ac[_0x26bd7e(0x201)]({'finishedAt':(0x0,moment_1[_0x26bd7e(0x220)])()[_0x26bd7e(0x185)](),'ratedAt':(0x0,moment_1['default'])()['toDate'](),'rated':!![]}),await _0x4fb229['update']({'queueId':null,'chatbot':null,'queueOptionId':null,'userId':null,'status':_0x26bd7e(0x319)}),_0x320417['to']('company-'+_0x4fb229[_0x26bd7e(0x228)]+_0x26bd7e(0x1b4))[_0x26bd7e(0x1fd)](_0x26bd7e(0x321)+_0x4fb229[_0x26bd7e(0x228)]+'-ticket',{'action':'delete','ticket':_0x4fb229,'ticketId':_0x4fb229['id']}),_0x320417['to'](_0x26bd7e(0x321)+_0x4fb229[_0x26bd7e(0x228)]+'-'+_0x4fb229[_0x26bd7e(0x211)])['to'](_0x4fb229['id'][_0x26bd7e(0x224)]())[_0x26bd7e(0x1fd)]('company-'+_0x4fb229[_0x26bd7e(0x228)]+'-ticket',{'action':_0x26bd7e(0x201),'ticket':_0x4fb229,'ticketId':_0x4fb229['id']});}};exports['handleRating']=handleRating;const handleChartbot=async(_0x259b52,_0x47aa5b,_0x161695,_0x19fc77,_0x262fd2=![])=>{const _0x342bf5=a558_0x25a89b;if(!_0x259b52[_0x342bf5(0x299)][_0x342bf5(0x1b9)]){const _0x279a4b=await Queue_1['default'][_0x342bf5(0x1ce)](_0x259b52[_0x342bf5(0x2ad)],{'include':[{'model':QueueOption_1['default'],'as':_0x342bf5(0x27d),'where':{'parentId':null},'order':[[_0x342bf5(0x1d0),_0x342bf5(0x2cb)],[_0x342bf5(0x320),'ASC']]}]}),_0x45ed35=_0x47aa5b?.[_0x342bf5(0x301)]?.['buttonsResponseMessage']?.[_0x342bf5(0x2be)]||_0x47aa5b?.[_0x342bf5(0x301)]?.[_0x342bf5(0x25f)]?.['singleSelectReply']?.[_0x342bf5(0x222)]||_0x47aa5b?.[_0x342bf5(0x301)]?.[_0x342bf5(0x1a3)]?.[_0x342bf5(0x30b)]||_0x47aa5b?.[_0x342bf5(0x301)]?.[_0x342bf5(0x2de)];if(_0x45ed35=='#'&&(!_0x259b52[_0x342bf5(0x18e)]||_0x259b52[_0x342bf5(0x211)]==_0x342bf5(0x216))){console[_0x342bf5(0x1b0)]('##\x20if'),await _0x259b52['update']({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x161695,_0x47aa5b,_0x259b52,_0x259b52[_0x342bf5(0x299)]);return;}if(!(0x0,lodash_1[_0x342bf5(0x26d)])(_0x279a4b)&&!(0x0,lodash_1[_0x342bf5(0x26d)])(_0x259b52[_0x342bf5(0x309)])&&_0x45ed35=='0'){console['trace'](_0x342bf5(0x1b3));const _0x405300=await QueueOption_1[_0x342bf5(0x220)][_0x342bf5(0x1ce)](_0x259b52[_0x342bf5(0x309)]);await _0x259b52[_0x342bf5(0x201)]({'queueOptionId':_0x405300?.[_0x342bf5(0x2ce)],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1[_0x342bf5(0x26d)])(_0x279a4b)&&!(0x0,lodash_1[_0x342bf5(0x26d)])(_0x259b52[_0x342bf5(0x309)])){console[_0x342bf5(0x1b0)](_0x342bf5(0x1e5));const _0x3f0db1=await QueueOption_1['default'][_0x342bf5(0x241)]({'where':{'parentId':_0x259b52[_0x342bf5(0x309)]}});let _0x30d655={};_0x3f0db1==0x1?_0x30d655=await QueueOption_1[_0x342bf5(0x220)][_0x342bf5(0x1f1)]({'where':{'parentId':_0x259b52[_0x342bf5(0x309)]}}):(console[_0x342bf5(0x1b0)]('terceiro\x20if'),_0x30d655=await QueueOption_1[_0x342bf5(0x220)]['findOne']({'where':{[sequelize_1['Op']['or']]:[{'option':_0x45ed35||''},{'title':_0x45ed35||''}],'parentId':_0x259b52[_0x342bf5(0x309)]}})),_0x30d655&&await _0x259b52[_0x342bf5(0x201)]({'queueOptionId':_0x30d655?.['id'],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1[_0x342bf5(0x26d)])(_0x279a4b)&&(0x0,lodash_1[_0x342bf5(0x26d)])(_0x259b52[_0x342bf5(0x309)])&&!_0x262fd2){console[_0x342bf5(0x1b0)](_0x342bf5(0x28c));const _0x59fb39=_0x279a4b?.[_0x342bf5(0x27d)][_0x342bf5(0x2e0)](_0x5123ed=>_0x5123ed[_0x342bf5(0x1d0)]==_0x45ed35||_0x5123ed[_0x342bf5(0x26c)]['toLowerCase']()==_0x45ed35[_0x342bf5(0x2c4)]());if(_0x59fb39)await _0x259b52[_0x342bf5(0x201)]({'queueOptionId':_0x59fb39?.['id'],'amountUsedBotQueues':0x0});else{if(_0x19fc77[_0x342bf5(0x1d8)]&&_0x19fc77['maxUseBotQueues']!==0x0&&_0x259b52[_0x342bf5(0x2e9)]>=_0x19fc77['maxUseBotQueues'])return;await _0x259b52[_0x342bf5(0x201)]({'amountUsedBotQueues':_0x259b52['amountUsedBotQueues']+0x1});}}else{if(_0x19fc77['maxUseBotQueues']&&_0x19fc77['maxUseBotQueues']!==0x0&&_0x259b52[_0x342bf5(0x2e9)]>=_0x19fc77[_0x342bf5(0x1d8)])return;await _0x259b52['update']({'amountUsedBotQueues':_0x259b52[_0x342bf5(0x2e9)]+0x1});}}}await _0x259b52['reload']();if(!(0x0,lodash_1[_0x342bf5(0x26d)])(_0x279a4b)&&(0x0,lodash_1[_0x342bf5(0x26d)])(_0x259b52[_0x342bf5(0x309)])){const _0x4fcd12=await QueueOption_1[_0x342bf5(0x220)][_0x342bf5(0x1ab)]({'where':{'queueId':_0x259b52[_0x342bf5(0x2ad)],'parentId':null},'order':[[_0x342bf5(0x1d0),_0x342bf5(0x2cb)],['createdAt',_0x342bf5(0x2cb)]]}),_0xc1b3ed=_0x259b52[_0x342bf5(0x228)],_0x43670c=await Setting_1[_0x342bf5(0x220)][_0x342bf5(0x1f1)]({'where':{'key':_0x342bf5(0x1af),'companyId':_0xc1b3ed}}),_0x12a943=async()=>{const _0x4378d6=_0x342bf5,_0x262ff3=[];_0x4fcd12[_0x4378d6(0x18b)]((_0x5e7a25,_0x20c7c9)=>{const _0x487e13=_0x4378d6;_0x262ff3[_0x487e13(0x28d)]({'buttonId':''+_0x5e7a25['option'],'buttonText':{'displayText':_0x5e7a25['title']},'type':0x4});}),_0x262ff3[_0x4378d6(0x28d)]({'buttonId':'#','buttonText':{'displayText':'Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior'},'type':0x4});const _0x1bc5e1={'text':(0x0,Mustache_1[_0x4378d6(0x220)])('‎'+_0x279a4b['greetingMessage'],_0x259b52),'buttons':_0x262ff3,'footer':_0x4378d6(0x2eb),'headerType':0x1},_0xaa2616=await _0x161695[_0x4378d6(0x30e)](_0x259b52[_0x4378d6(0x299)]['number']+'@'+(_0x259b52[_0x4378d6(0x1f3)]?_0x4378d6(0x194):_0x4378d6(0x328)),_0x1bc5e1);await(0x0,exports['verifyMessage'])(_0xaa2616,_0x259b52,_0x259b52['contact']);},_0x1b0174=async()=>{const _0x4d0f23=_0x342bf5;let _0x17813e='';console['trace'](_0x4d0f23(0x22a)),console[_0x4d0f23(0x1bd)](_0x279a4b['mediaPath']),_0x4fcd12[_0x4d0f23(0x18b)]((_0x2b3bcc,_0x46e42e)=>{const _0x56f671=_0x4d0f23;_0x17813e+=_0x56f671(0x17f)+_0x2b3bcc[_0x56f671(0x1d0)]+_0x56f671(0x195)+_0x2b3bcc[_0x56f671(0x26c)]+'\x0a';}),_0x17813e+='\x0a*[\x20#\x20]*\x20-\x20Menu\x20inicial';const _0x2d5883={'text':(0x0,Mustache_1[_0x4d0f23(0x220)])('‎'+_0x279a4b[_0x4d0f23(0x22f)]+'\x0a\x0a'+_0x17813e,_0x259b52)};let _0x152ca1;if(!_0x279a4b[_0x4d0f23(0x312)])_0x152ca1=await _0x161695[_0x4d0f23(0x30e)](_0x259b52[_0x4d0f23(0x299)]['number']+'@'+(_0x259b52['isGroup']?_0x4d0f23(0x194):_0x4d0f23(0x328)),_0x2d5883),await(0x0,exports[_0x4d0f23(0x1d9)])(_0x152ca1,_0x259b52,_0x259b52['contact']);else{const _0x26a6dc=path_1['default'][_0x4d0f23(0x27a)]('public',_0x4d0f23(0x2ba)+_0x259b52[_0x4d0f23(0x228)],_0x279a4b['mediaPath']),_0x31625e=await(0x0,SendWhatsAppMedia_1[_0x4d0f23(0x225)])(_0x2d5883[_0x4d0f23(0x30b)],_0x26a6dc,_0x2d5883[_0x4d0f23(0x30b)],_0x259b52[_0x4d0f23(0x228)]);_0x152ca1=await _0x161695[_0x4d0f23(0x30e)](_0x259b52[_0x4d0f23(0x299)]['number']+'@'+(_0x259b52[_0x4d0f23(0x1f3)]?_0x4d0f23(0x194):_0x4d0f23(0x328)),{..._0x31625e}),await verifyMediaMessage(_0x152ca1,_0x259b52,_0x259b52['contact']);}};if(_0x43670c[_0x342bf5(0x280)]===_0x342bf5(0x2ae)&&QueueOption_1['default'][_0x342bf5(0x324)]<=0x4)return _0x12a943();if(_0x43670c[_0x342bf5(0x280)]===_0x342bf5(0x30b))return console[_0x342bf5(0x1b0)](_0x342bf5(0x22a)),_0x1b0174();if(_0x43670c[_0x342bf5(0x280)]===_0x342bf5(0x2ae)&&QueueOption_1[_0x342bf5(0x220)][_0x342bf5(0x324)]>0x4)return console[_0x342bf5(0x1b0)](_0x342bf5(0x22a)),_0x1b0174();}else{if(!(0x0,lodash_1[_0x342bf5(0x26d)])(_0x279a4b)&&!(0x0,lodash_1['isNil'])(_0x259b52['queueOptionId'])){const _0x2effd3=await QueueOption_1[_0x342bf5(0x220)][_0x342bf5(0x1ce)](_0x259b52[_0x342bf5(0x309)]),_0x39333a=await QueueOption_1[_0x342bf5(0x220)][_0x342bf5(0x1ab)]({'where':{'parentId':_0x259b52[_0x342bf5(0x309)]},'order':[[_0x342bf5(0x1d0),_0x342bf5(0x2cb)],[_0x342bf5(0x320),_0x342bf5(0x2cb)]]});if(_0x39333a[_0x342bf5(0x324)]===0x0){const _0x491151={'text':(0x0,Mustache_1['default'])('‎'+_0x2effd3['message'],_0x259b52)},_0x3c6123=await _0x161695['sendMessage'](_0x259b52[_0x342bf5(0x299)][_0x342bf5(0x24b)]+'@'+(_0x259b52['isGroup']?_0x342bf5(0x194):_0x342bf5(0x328)),_0x491151);await(0x0,exports['verifyMessage'])(_0x3c6123,_0x259b52,_0x259b52[_0x342bf5(0x299)]),await _0x259b52[_0x342bf5(0x201)]({'queueOptionId':null,'chatbot':![]});return;}if(_0x39333a[_0x342bf5(0x324)]>-0x1){const _0x38c807=_0x259b52['companyId'],_0x40827a=await Setting_1[_0x342bf5(0x220)]['findOne']({'where':{'key':'chatBotType','companyId':_0x38c807}}),_0x4955ca=async()=>{const _0x32e11e=_0x342bf5,_0x585454=[],_0x34e9f8=_0x259b52[_0x32e11e(0x228)],_0x541074=await getQueues(_0x34e9f8),_0x4a4dfa=await getContactFromTicket(_0x259b52['id']);_0x541074[_0x32e11e(0x18b)]((_0x450059,_0x1adcf7)=>{const _0xd10e4=_0x32e11e;_0x585454[_0xd10e4(0x28d)]({'title':'['+(_0x1adcf7+0x1)+_0xd10e4(0x1a4)+_0x450059[_0xd10e4(0x1df)],'rowId':''+(_0x1adcf7+0x1)});});const _0x51571b=[{'rows':_0x585454}],_0xbabb25={'text':(0x0,Mustache_1[_0x32e11e(0x220)])('‎'+_0x2effd3['message'],_0x259b52),'title':'Lista','buttonText':_0x32e11e(0x250),'sections':_0x51571b};await sleep(0x3e8);const _0x1bb7a3=await _0x161695[_0x32e11e(0x30e)](_0x32e11e(0x170)+_0x4a4dfa['number']+'@'+(_0x259b52[_0x32e11e(0x1f3)]?_0x32e11e(0x194):'s.whatsapp.net'),_0xbabb25);await(0x0,exports[_0x32e11e(0x1d9)])(_0x1bb7a3,_0x259b52,_0x259b52['contact']);},_0x47cda3=async()=>{const _0x2efa04=_0x342bf5,_0x3a08b0=[];_0x39333a['forEach']((_0x560248,_0x3cfdea)=>{const _0xf3701e=a558_0x59f5;_0x3a08b0[_0xf3701e(0x28d)]({'buttonId':''+_0x560248[_0xf3701e(0x1d0)],'buttonText':{'displayText':_0x560248[_0xf3701e(0x26c)]},'type':0x4});}),_0x3a08b0[_0x2efa04(0x28d)]({'buttonId':'#','buttonText':{'displayText':_0x2efa04(0x294)},'type':0x4});const _0x49b6db={'text':(0x0,Mustache_1[_0x2efa04(0x220)])('‎'+_0x2effd3[_0x2efa04(0x301)],_0x259b52),'buttons':_0x3a08b0,'headerType':0x4};if(process['env'][_0x2efa04(0x2db)]?.[_0x2efa04(0x324)]>=0x8){if(_0x259b52[_0x2efa04(0x299)][_0x2efa04(0x24b)]!=process[_0x2efa04(0x291)]['CHATBOT_RESTRICT_NUMBER']){console[_0x2efa04(0x1b0)](_0x2efa04(0x18d));return;}}if(!_0x2effd3[_0x2efa04(0x312)]){const _0x357e68=await _0x161695[_0x2efa04(0x30e)](_0x259b52['contact'][_0x2efa04(0x24b)]+'@'+(_0x259b52['isGroup']?_0x2efa04(0x194):_0x2efa04(0x328)),_0x49b6db);await(0x0,exports[_0x2efa04(0x1d9)])(_0x357e68,_0x259b52,_0x259b52[_0x2efa04(0x299)]);}else{const _0x53d19f=path_1[_0x2efa04(0x220)][_0x2efa04(0x27a)]('public',_0x2efa04(0x2ba)+_0x259b52[_0x2efa04(0x228)],_0x2effd3[_0x2efa04(0x312)]),_0x285484=await(0x0,SendWhatsAppMedia_1[_0x2efa04(0x225)])(_0x2effd3[_0x2efa04(0x218)],_0x53d19f,_0x49b6db[_0x2efa04(0x30b)],_0x259b52[_0x2efa04(0x228)]);let _0x540ce5=await _0x161695[_0x2efa04(0x30e)](_0x259b52[_0x2efa04(0x299)][_0x2efa04(0x24b)]+'@'+(_0x259b52[_0x2efa04(0x1f3)]?'g.us':'s.whatsapp.net'),{..._0x285484});await verifyMediaMessage(_0x540ce5,_0x259b52,_0x259b52[_0x2efa04(0x299)]);}const _0x56720e=await _0x161695[_0x2efa04(0x30e)](_0x259b52[_0x2efa04(0x299)][_0x2efa04(0x24b)]+'@'+(_0x259b52[_0x2efa04(0x1f3)]?_0x2efa04(0x194):_0x2efa04(0x328)),_0x49b6db);await(0x0,exports[_0x2efa04(0x1d9)])(_0x56720e,_0x259b52,_0x259b52[_0x2efa04(0x299)]);},_0x11fc31=async()=>{const _0x3588d1=_0x342bf5;let _0x1d565d='';_0x39333a[_0x3588d1(0x18b)]((_0x517656,_0x546ace)=>{const _0x50c944=_0x3588d1;_0x1d565d+=_0x50c944(0x17f)+_0x517656[_0x50c944(0x1d0)]+_0x50c944(0x195)+_0x517656[_0x50c944(0x26c)]+'\x0a';}),_0x1d565d+=_0x3588d1(0x289),_0x1d565d+=_0x3588d1(0x1aa);const _0x13d8b1={'text':(0x0,Mustache_1[_0x3588d1(0x220)])('‎'+_0x2effd3['message']+'\x0a\x0a'+_0x1d565d,_0x259b52)};if(process[_0x3588d1(0x291)][_0x3588d1(0x2db)]?.[_0x3588d1(0x324)]>=0x8){if(_0x259b52[_0x3588d1(0x299)]['number']!=process[_0x3588d1(0x291)][_0x3588d1(0x2db)]){console[_0x3588d1(0x1b0)](_0x3588d1(0x18d));return;}}if(!_0x2effd3[_0x3588d1(0x312)]){const _0x4b5061=await _0x161695['sendMessage'](_0x259b52[_0x3588d1(0x299)]['number']+'@'+(_0x259b52[_0x3588d1(0x1f3)]?_0x3588d1(0x194):_0x3588d1(0x328)),_0x13d8b1);await(0x0,exports[_0x3588d1(0x1d9)])(_0x4b5061,_0x259b52,_0x259b52['contact']);}else{const _0x4e312c=path_1[_0x3588d1(0x220)][_0x3588d1(0x27a)](_0x3588d1(0x1b7),_0x3588d1(0x2ba)+_0x259b52[_0x3588d1(0x228)],_0x2effd3[_0x3588d1(0x312)]),_0x19ddcc=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x2effd3[_0x3588d1(0x218)],_0x4e312c,_0x13d8b1[_0x3588d1(0x30b)],_0x259b52[_0x3588d1(0x228)]);let _0x3cf92d=await _0x161695['sendMessage'](_0x259b52[_0x3588d1(0x299)][_0x3588d1(0x24b)]+'@'+(_0x259b52[_0x3588d1(0x1f3)]?_0x3588d1(0x194):'s.whatsapp.net'),{..._0x19ddcc});await verifyMediaMessage(_0x3cf92d,_0x259b52,_0x259b52[_0x3588d1(0x299)]);}};if(_0x40827a['value']===_0x342bf5(0x281))return _0x4955ca();if(_0x40827a[_0x342bf5(0x280)]===_0x342bf5(0x2ae)&&QueueOption_1[_0x342bf5(0x220)]['length']<=0x4)return _0x47cda3();if(_0x40827a[_0x342bf5(0x280)]===_0x342bf5(0x30b))return console['trace'](_0x342bf5(0x288)),_0x11fc31();if(_0x40827a['value']===_0x342bf5(0x2ae)&&QueueOption_1['default']['length']>0x4)return console[_0x342bf5(0x1b0)](_0x342bf5(0x2af)),_0x11fc31();}}}}},handleMessageIntegration=async(_0x47f815,_0x4eb35b,_0x5938e8,_0x5b7714)=>{const _0x3bfbc5=a558_0x25a89b;if(process[_0x3bfbc5(0x291)][_0x3bfbc5(0x2db)]){if(_0x5b7714[_0x3bfbc5(0x299)][_0x3bfbc5(0x24b)]!=process[_0x3bfbc5(0x291)][_0x3bfbc5(0x2db)]){console[_0x3bfbc5(0x1bd)]('chatbot\x20desativado!');return;}}const _0x5f4880=getTypeMessage(_0x47f815);if(_0x5938e8[_0x3bfbc5(0x2ef)]===_0x3bfbc5(0x1be)||_0x5938e8[_0x3bfbc5(0x2ef)]===_0x3bfbc5(0x176)){if(_0x5938e8?.[_0x3bfbc5(0x266)]){const _0x5367c4={'method':_0x3bfbc5(0x2d2),'url':_0x5938e8?.[_0x3bfbc5(0x266)],'headers':{'Content-Type':_0x3bfbc5(0x260)},'json':_0x47f815};try{(0x0,request_1['default'])(_0x5367c4,function(_0x5818cf,_0x2bf29e){const _0x362ead=_0x3bfbc5;if(_0x5818cf)throw new Error(_0x5818cf);else console[_0x362ead(0x1bd)](_0x2bf29e[_0x362ead(0x2f5)]);});}catch(_0xd16444){throw new Error(_0xd16444);}}}else _0x5938e8[_0x3bfbc5(0x2ef)]===_0x3bfbc5(0x28b)&&await(0x0,typebotListener_1[_0x3bfbc5(0x220)])({'ticket':_0x5b7714,'msg':_0x47f815,'wbot':_0x4eb35b,'typebot':_0x5938e8});};exports[a558_0x25a89b(0x290)]=handleMessageIntegration;const messageContainsMedia=_0x5b12f9=>{const _0x248775=a558_0x25a89b;return _0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x1db)]||_0x5b12f9['message']?.[_0x248775(0x226)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x32b)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x259)]||_0x5b12f9[_0x248775(0x301)]?.['documentMessage']||_0x5b12f9[_0x248775(0x301)]?.['documentWithCaptionMessage']?.[_0x248775(0x301)]?.['documentMessage']||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x1cf)]?.['message']?.[_0x248775(0x226)]||_0x5b12f9[_0x248775(0x301)]?.['ephemeralMessage']?.[_0x248775(0x301)]?.['documentMessage']||_0x5b12f9[_0x248775(0x301)]?.['ephemeralMessage']?.[_0x248775(0x301)]?.['videoMessage']||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x1cf)]?.['message']?.[_0x248775(0x259)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x1cf)]?.[_0x248775(0x301)]?.[_0x248775(0x1db)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x200)]?.['message']?.[_0x248775(0x1db)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x200)]?.['message']?.['videoMessage']||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x1cf)]?.[_0x248775(0x301)]?.[_0x248775(0x200)]?.[_0x248775(0x301)]?.[_0x248775(0x1db)]||_0x5b12f9[_0x248775(0x301)]?.['ephemeralMessage']?.[_0x248775(0x301)]?.['viewOnceMessage']?.[_0x248775(0x301)]?.['videoMessage']||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x1cf)]?.[_0x248775(0x301)]?.[_0x248775(0x200)]?.[_0x248775(0x301)]?.[_0x248775(0x226)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x1cf)]?.[_0x248775(0x301)]?.[_0x248775(0x200)]?.[_0x248775(0x301)]?.['documentMessage']||_0x5b12f9['message']?.[_0x248775(0x1b6)]?.[_0x248775(0x301)]?.[_0x248775(0x31e)]||_0x5b12f9['message']?.[_0x248775(0x251)]?.[_0x248775(0x31d)]?.['imageMessage']||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x251)]?.[_0x248775(0x31d)]?.[_0x248775(0x31e)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x251)]?.[_0x248775(0x31d)]?.[_0x248775(0x32b)]||_0x5b12f9['message']?.[_0x248775(0x251)]?.[_0x248775(0x22d)]?.[_0x248775(0x1db)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x251)]?.[_0x248775(0x22d)]?.[_0x248775(0x31e)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x251)]?.[_0x248775(0x22d)]?.['videoMessage']||_0x5b12f9[_0x248775(0x301)]?.['templateMessage']?.['fourRowTemplate']?.['imageMessage']||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x251)]?.['fourRowTemplate']?.['documentMessage']||_0x5b12f9['message']?.[_0x248775(0x251)]?.[_0x248775(0x296)]?.['videoMessage']||_0x5b12f9['message']?.[_0x248775(0x27b)]?.[_0x248775(0x277)]?.[_0x248775(0x1db)]||_0x5b12f9[_0x248775(0x301)]?.['interactiveMessage']?.['header']?.['documentMessage']||_0x5b12f9['message']?.[_0x248775(0x27b)]?.[_0x248775(0x277)]?.[_0x248775(0x32b)]||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x2ff)]?.[_0x248775(0x2d1)]?.['hydratedTemplate']?.['documentMessage']||_0x5b12f9['message']?.[_0x248775(0x2ff)]?.[_0x248775(0x2d1)]?.['hydratedTemplate']?.[_0x248775(0x32b)]||_0x5b12f9['message']?.['highlyStructuredMessage']?.['hydratedHsm']?.[_0x248775(0x31d)]?.['imageMessage']||_0x5b12f9[_0x248775(0x301)]?.[_0x248775(0x2ff)]?.[_0x248775(0x2d1)]?.['hydratedTemplate']?.[_0x248775(0x25c)];},handleMessage=async(_0x378efc,_0x21c2b8,_0x2a44bc,_0x3b9981=![])=>{const _0x26267a=a558_0x25a89b;if(_0x3b9981){console[_0x26267a(0x1bd)](_0x26267a(0x317));let _0x4a70ee=_0x378efc[_0x26267a(0x227)]['id'],_0x4b283b=await Message_1[_0x26267a(0x220)][_0x26267a(0x241)]({'where':{'id':_0x4a70ee}});if(_0x4b283b>0x0){await new Promise(_0x38150d=>setTimeout(_0x38150d,0x96));return;}else await new Promise(_0x4d5c13=>setTimeout(_0x4d5c13,0x14a));}let _0x5b8222;if(!(0x0,exports[_0x26267a(0x2e1)])(_0x378efc)){console['log'](_0x26267a(0x2f6)),console['log'](_0x378efc);return;}_0x378efc[_0x26267a(0x301)]?.[_0x26267a(0x1cf)]&&(_0x378efc[_0x26267a(0x301)]=_0x378efc['message'][_0x26267a(0x1cf)][_0x26267a(0x301)]);try{let _0x2ed569;const _0x537fb3=_0x378efc[_0x26267a(0x227)][_0x26267a(0x2ab)]?.[_0x26267a(0x22c)](_0x26267a(0x267)),_0x295b35=await Setting_1['default'][_0x26267a(0x1f1)]({'where':{'companyId':_0x2a44bc,'key':_0x26267a(0x2d3)}});if(_0x295b35?.['value']===_0x26267a(0x215)&&_0x537fb3){console['log']('Mensagem\x20de\x20grupo\x20bloqueada!');return;}let _0x591920=(0x0,exports[_0x26267a(0x31f)])(_0x378efc);const _0x3300c9=getTypeMessage(_0x378efc);typeof _0x591920===_0x26267a(0x243)&&(_0x591920=_0x591920[_0x26267a(0x2b9)](/\u200c/,''));const _0x312eba=messageContainsMedia(_0x378efc);if(_0x378efc[_0x26267a(0x227)][_0x26267a(0x262)]){if(!_0x312eba&&_0x3300c9!=='conversation'&&_0x3300c9!=='extendedTextMessage'&&_0x3300c9!==_0x26267a(0x2b1)&&_0x3300c9!==_0x26267a(0x1b1)&&_0x3300c9!=='ephemeralMessage'&&_0x3300c9!==_0x26267a(0x286)&&_0x3300c9!==_0x26267a(0x30c)&&_0x3300c9!==_0x26267a(0x200)&&_0x3300c9!==_0x26267a(0x25c)&&_0x3300c9!==_0x26267a(0x28a)&&_0x3300c9!==_0x26267a(0x255)){console[_0x26267a(0x1b0)](_0x3300c9);return;}}const _0x2c2324=await(0x0,ShowWhatsAppService_1[_0x26267a(0x220)])(_0x21c2b8['id'],_0x2a44bc);let _0x49ba07,_0x51483c=await getContactMessage(_0x378efc,_0x21c2b8);_0x2ed569=await verifyContact(_0x51483c,_0x21c2b8,_0x2a44bc);if(_0x537fb3){if(!_0x2c2324[_0x26267a(0x1e2)])return;try{const _0x145678=await _0x21c2b8[_0x26267a(0x2bb)](_0x378efc[_0x26267a(0x227)][_0x26267a(0x2ab)]),_0x439eb4={'id':_0x145678['id'],'name':_0x145678[_0x26267a(0x2e6)]};_0x49ba07=await verifyContact(_0x439eb4,_0x21c2b8,_0x2a44bc);}catch(_0xbc0750){console['log']('Erro\x20ao\x20buscar\x20grupo!'),console[_0x26267a(0x1bd)](_0xbc0750);return;}}let _0x523487=0x0;if(_0x378efc[_0x26267a(0x227)][_0x26267a(0x262)])await cache_1[_0x26267a(0x1a9)][_0x26267a(0x21a)](_0x26267a(0x2b6)+_0x2ed569['id']+_0x26267a(0x29f),'0');else{const _0x12f092=await cache_1['cacheLayer'][_0x26267a(0x1cd)](_0x26267a(0x2b6)+_0x2ed569['id']+_0x26267a(0x29f));_0x523487=+_0x12f092+0x1,await cache_1[_0x26267a(0x1a9)][_0x26267a(0x21a)]('contacts:'+_0x2ed569['id']+':unreads',''+_0x523487);}const _0x2e80c9=await(0x0,FindOrCreateTicketService_1['default'])(_0x2ed569,_0x21c2b8['id'],_0x523487,_0x2a44bc,_0x49ba07,_0x3b9981),_0x50bb61=await(0x0,FindOrCreateATicketTrakingService_1[_0x26267a(0x220)])({'ticketId':_0x2e80c9['id'],'companyId':_0x2a44bc,'whatsappId':_0x2c2324?.['id']});_0x50bb61[_0x26267a(0x2b3)](_0x26267a(0x29a),!![]),await _0x50bb61[_0x26267a(0x201)]({'updatedAt':new Date()}),await(0x0,providers_1['provider'])(_0x2e80c9,_0x378efc,_0x2a44bc,_0x2ed569,_0x21c2b8);if(_0x2c2324[_0x26267a(0x172)]&&_0x523487===0x0){const _0x462335=await Message_1[_0x26267a(0x220)][_0x26267a(0x1f1)]({'where':{'contactId':_0x2ed569['id'],'companyId':_0x2a44bc},'order':[[_0x26267a(0x320),'DESC']]});if((0x0,Mustache_1[_0x26267a(0x220)])(_0x2c2324['complationMessage'],_0x2e80c9)['trim']()[_0x26267a(0x2c4)]()===_0x462335?.[_0x26267a(0x2f5)][_0x26267a(0x22b)]()[_0x26267a(0x2c4)]())return;}if(_0x591920=='#'&&!_0x3b9981&&(!_0x2e80c9['userId']||_0x2e80c9[_0x26267a(0x211)]==_0x26267a(0x216))){await _0x2e80c9[_0x26267a(0x201)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x21c2b8,_0x378efc,_0x2e80c9,_0x2e80c9['contact']);return;}try{if(!_0x378efc[_0x26267a(0x227)][_0x26267a(0x262)]&&!_0x3b9981){if(_0x591920!=null&&typeof _0x591920!=='string'){console[_0x26267a(0x1bd)](_0x591920),console['trace']('Expected\x20bodyMessage\x20to\x20be\x20a\x20string,\x20got:',typeof _0x591920);return;}if(_0x591920?.[_0x26267a(0x1c0)]()==='SAIR'&&_0x2e80c9[_0x26267a(0x211)]!=_0x26267a(0x319)){await(0x0,SendPresenceStatus_1[_0x26267a(0x314)])(_0x21c2b8,_0x2e80c9[_0x26267a(0x299)][_0x26267a(0x24b)]+'@'+(_0x2e80c9[_0x26267a(0x1f3)]?_0x26267a(0x194):_0x26267a(0x328)));const _0x3390d5=await _0x21c2b8[_0x26267a(0x30e)](_0x2e80c9[_0x26267a(0x299)][_0x26267a(0x24b)]+'@'+(_0x2e80c9[_0x26267a(0x1f3)]?_0x26267a(0x194):_0x26267a(0x328)),{'text':_0x26267a(0x2e8)});await(0x0,exports['verifyMessage'])(_0x3390d5,_0x2e80c9,_0x2e80c9['contact']),await(0x0,UpdateTicketService_1[_0x26267a(0x220)])({'ticketData':{'queueId':null,'status':_0x26267a(0x319)},'ticketId':_0x2e80c9['id'],'companyId':_0x2e80c9[_0x26267a(0x228)]}),await _0x2e80c9[_0x26267a(0x2d5)]();return;}}}catch(_0x5d3a82){console[_0x26267a(0x1bd)](_0x26267a(0x315)),console[_0x26267a(0x1bd)](_0x5d3a82),Sentry[_0x26267a(0x293)](_0x5d3a82);}try{await _0x2e80c9[_0x26267a(0x201)]({'fromMe':_0x378efc[_0x26267a(0x227)][_0x26267a(0x262)]});}catch(_0x4e143c){console['log']('Erro\x20ao\x20salvar\x20ticket!'),console[_0x26267a(0x1bd)](_0x4e143c),Sentry['captureException'](_0x4e143c);}try{if(!_0x378efc[_0x26267a(0x227)][_0x26267a(0x262)]){if((0x0,exports[_0x26267a(0x1ea)])(_0x50bb61)){await(0x0,exports['handleRating'])(_0x378efc,_0x2e80c9,_0x50bb61),console[_0x26267a(0x1bd)]('Mensagem\x20inválida\x208!\x20'+_0x378efc);return;}}}catch(_0x18c1a7){console[_0x26267a(0x1bd)]('Erro\x20ao\x20salvar\x20avaliação!'),Sentry[_0x26267a(0x293)](_0x18c1a7),console[_0x26267a(0x1bd)](_0x18c1a7);}_0x312eba?_0x5b8222=await verifyMediaMessage(_0x378efc,_0x2e80c9,_0x2ed569):await(0x0,exports[_0x26267a(0x1d9)])(_0x378efc,_0x2e80c9,_0x2ed569);const _0x450331=await(0x0,VerifyCurrentSchedule_1[_0x26267a(0x220)])(_0x2a44bc),_0x58f0f4=await Setting_1[_0x26267a(0x220)][_0x26267a(0x1f1)]({'where':{'companyId':_0x2a44bc,'key':_0x26267a(0x292)}});if(!_0x378efc[_0x26267a(0x227)][_0x26267a(0x262)]&&_0x58f0f4&&!_0x3b9981)await handleOutOfHour(_0x21c2b8,_0x2e80c9,_0x58f0f4,_0x2ed569,_0x450331,_0x2c2324);!_0x2e80c9['queue']&&!_0x537fb3&&!_0x378efc[_0x26267a(0x227)][_0x26267a(0x262)]&&!_0x2e80c9['userId']&&!(0x0,lodash_1['isNil'])(_0x2c2324[_0x26267a(0x182)])&&!_0x3b9981&&await handleOpenAi(_0x378efc,_0x21c2b8,_0x2e80c9,_0x2ed569,_0x5b8222);if(!_0x378efc[_0x26267a(0x227)]['fromMe']&&!_0x2e80c9[_0x26267a(0x1f3)]&&!_0x2e80c9[_0x26267a(0x23e)]&&!_0x2e80c9[_0x26267a(0x1e0)]&&_0x2e80c9[_0x26267a(0x2a2)]&&!(0x0,lodash_1[_0x26267a(0x26d)])(_0x2c2324[_0x26267a(0x1ed)])&&!_0x2e80c9[_0x26267a(0x1a0)]&&!_0x3b9981){const _0x3c813d=await(0x0,ShowQueueIntegrationService_1['default'])(_0x2c2324[_0x26267a(0x1ed)],_0x2a44bc);await(0x0,exports[_0x26267a(0x290)])(_0x378efc,_0x21c2b8,_0x3c813d,_0x2e80c9);return;}!_0x537fb3&&!_0x378efc[_0x26267a(0x227)][_0x26267a(0x262)]&&!_0x2e80c9[_0x26267a(0x18e)]&&!(0x0,lodash_1[_0x26267a(0x26d)])(_0x2e80c9['promptId'])&&_0x2e80c9[_0x26267a(0x1a0)]&&!_0x3b9981&&await handleOpenAi(_0x378efc,_0x21c2b8,_0x2e80c9,_0x2ed569,_0x5b8222);if(!_0x378efc['key'][_0x26267a(0x262)]&&!_0x2e80c9[_0x26267a(0x1f3)]&&!_0x2e80c9[_0x26267a(0x18e)]&&_0x2e80c9['integrationId']&&_0x2e80c9[_0x26267a(0x1a0)]&&!_0x3b9981){const _0x53f710=await(0x0,ShowQueueIntegrationService_1[_0x26267a(0x220)])(_0x2e80c9['integrationId'],_0x2a44bc);await(0x0,exports['handleMessageIntegration'])(_0x378efc,_0x21c2b8,_0x53f710,_0x2e80c9);}!_0x2e80c9[_0x26267a(0x23e)]&&!_0x2e80c9[_0x26267a(0x1f3)]&&!_0x378efc[_0x26267a(0x227)]['fromMe']&&!_0x2e80c9[_0x26267a(0x18e)]&&_0x2c2324[_0x26267a(0x1e6)][_0x26267a(0x324)]>=0x1&&!_0x2e80c9[_0x26267a(0x1a0)]&&!_0x3b9981&&(await verifyQueue(_0x21c2b8,_0x378efc,_0x2e80c9,_0x2ed569),_0x50bb61[_0x26267a(0x2b3)](_0x26267a(0x30f),!![]),_0x50bb61[_0x26267a(0x2b3)]('updatedAt',!![]),await _0x50bb61[_0x26267a(0x201)]({'chatbotAt':(0x0,moment_1[_0x26267a(0x220)])()['toDate'](),'updatedAt':new Date()}));const _0x3afecc=_0x2e80c9['queue']===null;await _0x2e80c9['reload']();if(!_0x3b9981&&_0x2c2324['greetingMessage'])await greetingMessage(_0x21c2b8,_0x2e80c9,_0x378efc,_0x2c2324,_0x537fb3);_0x2c2324['queues'][_0x26267a(0x324)]==0x1&&_0x2e80c9[_0x26267a(0x23e)]&&!_0x3b9981&&(_0x2e80c9[_0x26267a(0x2a2)]&&!_0x378efc[_0x26267a(0x227)][_0x26267a(0x262)]&&!_0x2e80c9[_0x26267a(0x18e)]&&await handleChartbot(_0x2e80c9,_0x378efc,_0x21c2b8,_0x2c2324)),_0x2c2324['queues'][_0x26267a(0x324)]>0x1&&_0x2e80c9['queue']&&!_0x3b9981&&(_0x2e80c9['chatbot']&&!_0x378efc['key'][_0x26267a(0x262)]&&!_0x2e80c9[_0x26267a(0x18e)]&&await handleChartbot(_0x2e80c9,_0x378efc,_0x21c2b8,_0x2c2324,_0x3afecc));}catch(_0x4c536c){console[_0x26267a(0x1bd)](_0x4c536c),Sentry[_0x26267a(0x293)](_0x4c536c),logger_1['logger']['error']('Error\x20handling\x20whatsapp\x20message:\x20Err:\x20'+_0x4c536c);}};exports['handleMessage']=handleMessage;const handleOutOfHour=async(_0x23cf1b,_0x36ac44,_0x542a8f,_0x5eea37,_0x518b08,_0x35a17f)=>{const _0x5ca5bc=a558_0x25a89b;try{if(outOfHourMessageControl[_0x5ca5bc(0x324)]>0x1388)outOfHourMessageControl=[];let _0x1ecc6a=outOfHourMessageControl['find'](_0x3e1e4b=>_0x3e1e4b[_0x5ca5bc(0x26e)]===_0x36ac44['id']||_0x3e1e4b[_0x5ca5bc(0x1da)]===_0x5eea37[_0x5ca5bc(0x24b)]);if(_0x542a8f[_0x5ca5bc(0x280)]===_0x5ca5bc(0x2ba)&&!(0x0,lodash_1['isNil'])(_0x518b08)&&_0x35a17f['outOfHoursMessage']&&(!_0x518b08||_0x518b08[_0x5ca5bc(0x2bf)]===![])){if(!_0x1ecc6a||_0x1ecc6a&&_0x1ecc6a[_0x5ca5bc(0x1c5)]+0x3e8*0x3c*0x5<new Date()['getTime']()){_0x1ecc6a&&(outOfHourMessageControl=outOfHourMessageControl[_0x5ca5bc(0x1d6)](_0x4612bd=>_0x4612bd['ticketId']!==_0x36ac44['id']),_0x1ecc6a=null);if(!_0x1ecc6a)outOfHourMessageControl[_0x5ca5bc(0x28d)]({'ticketId':_0x36ac44['id'],'dest':_0x5eea37[_0x5ca5bc(0x24b)],'time':new Date()['getTime']()});const _0x3a6a45='‎\x20'+_0x35a17f[_0x5ca5bc(0x2c8)],_0x2928a6=(0x0,Debounce_1['debounce'])(async()=>{const _0x14b7c7=_0x5ca5bc;await _0x23cf1b[_0x14b7c7(0x30e)](_0x36ac44[_0x14b7c7(0x299)][_0x14b7c7(0x24b)]+'@'+(_0x36ac44[_0x14b7c7(0x1f3)]?_0x14b7c7(0x194):_0x14b7c7(0x328)),{'text':_0x3a6a45});},(0x0,queues_1[_0x5ca5bc(0x24d)])(0x5dc,0xdac),_0x36ac44['id']);_0x2928a6();return;}}if(_0x542a8f[_0x5ca5bc(0x280)]===_0x5ca5bc(0x23e)&&_0x36ac44[_0x5ca5bc(0x2ad)]!==null){const _0x1e9ee4=await Queue_1[_0x5ca5bc(0x220)][_0x5ca5bc(0x1ce)](_0x36ac44[_0x5ca5bc(0x2ad)]),{schedules:_0x37ca70}=_0x1e9ee4,_0x5a18d4=(0x0,moment_1[_0x5ca5bc(0x220)])(),_0x4acc7b=_0x5a18d4[_0x5ca5bc(0x2f3)]('dddd')[_0x5ca5bc(0x2c4)]();let _0x3418d9=null;Array[_0x5ca5bc(0x2e3)](_0x37ca70)&&_0x37ca70[_0x5ca5bc(0x324)]>0x0&&(_0x3418d9=_0x37ca70[_0x5ca5bc(0x2e0)](_0x15c574=>_0x15c574['weekdayEn']===_0x4acc7b&&_0x15c574[_0x5ca5bc(0x265)]!==''&&_0x15c574['startTime']!==null&&_0x15c574['endTime']!==''&&_0x15c574[_0x5ca5bc(0x24f)]!==null));if(_0x542a8f[_0x5ca5bc(0x280)]==='queue'&&_0x1e9ee4[_0x5ca5bc(0x2c8)]!==null&&_0x1e9ee4[_0x5ca5bc(0x2c8)]!==''&&!(0x0,lodash_1[_0x5ca5bc(0x26d)])(_0x3418d9)){const _0x6a1eaf=(0x0,moment_1['default'])(_0x3418d9[_0x5ca5bc(0x265)],'HH:mm'),_0x15eeb3=(0x0,moment_1[_0x5ca5bc(0x220)])(_0x3418d9[_0x5ca5bc(0x24f)],_0x5ca5bc(0x1f8));let _0x371aaa=_0x5a18d4[_0x5ca5bc(0x234)](_0x6a1eaf)||_0x5a18d4['isAfter'](_0x15eeb3);if(!_0x371aaa){if(_0x3418d9[_0x5ca5bc(0x19b)]&&_0x3418d9['endLunchTime']){const _0x4e8e8d=(0x0,moment_1[_0x5ca5bc(0x220)])(_0x3418d9[_0x5ca5bc(0x19b)],_0x5ca5bc(0x1f8)),_0x437557=(0x0,moment_1[_0x5ca5bc(0x220)])(_0x3418d9[_0x5ca5bc(0x263)],_0x5ca5bc(0x1f8));_0x371aaa=_0x5a18d4['isBetween'](_0x4e8e8d,_0x437557);}}if(_0x371aaa){if(!_0x1ecc6a||_0x1ecc6a&&_0x1ecc6a[_0x5ca5bc(0x1c5)]+0x3e8*0x3c*0x1e<new Date()[_0x5ca5bc(0x2f9)]()){const _0x1dae3f=_0x1e9ee4['outOfHoursMessage'],_0x1f4bb1=(0x0,Debounce_1[_0x5ca5bc(0x239)])(async()=>{const _0x1a7f54=_0x5ca5bc;await _0x23cf1b['sendMessage'](_0x36ac44[_0x1a7f54(0x299)][_0x1a7f54(0x24b)]+'@'+(_0x36ac44[_0x1a7f54(0x1f3)]?_0x1a7f54(0x194):_0x1a7f54(0x328)),{'text':_0x1dae3f});},(0x0,queues_1[_0x5ca5bc(0x24d)])(0x3e8,0xbb8),_0x36ac44['id']);_0x1f4bb1();return;}if(!_0x1ecc6a)outOfHourMessageControl[_0x5ca5bc(0x28d)]({'ticketId':_0x36ac44['id'],'dest':_0x5eea37[_0x5ca5bc(0x24b)],'time':new Date()[_0x5ca5bc(0x2f9)]()});}}}}catch(_0xc750c9){Sentry[_0x5ca5bc(0x293)](_0xc750c9),console[_0x5ca5bc(0x1bd)](_0xc750c9);}},greetingMessage=async(_0x9a7f1e,_0x498c34,_0x120331,_0x3a8ea8,_0x164d93)=>{const _0x4340b6=a558_0x25a89b;if(!_0x3a8ea8?.[_0x4340b6(0x1e6)]?.[_0x4340b6(0x324)]&&!_0x498c34['userId']&&!_0x164d93&&!_0x120331['key'][_0x4340b6(0x262)]){if(process[_0x4340b6(0x291)][_0x4340b6(0x2db)]?.[_0x4340b6(0x324)]>=0x8){if(_0x498c34['contact']['number']!=process[_0x4340b6(0x291)][_0x4340b6(0x2db)])return;}if(greetingMessageControl[_0x4340b6(0x324)]>0x1388)greetingMessageControl=[];var _0x397caa=greetingMessageControl[_0x4340b6(0x2e0)](_0x994897=>_0x994897[_0x4340b6(0x26e)]===_0x498c34['id']||_0x994897['dest']===_0x498c34[_0x4340b6(0x299)][_0x4340b6(0x24b)]);if(_0x397caa&&_0x397caa[_0x4340b6(0x1c5)]+0x3e8*0x3c*0x5>=new Date()['getTime']())return;const _0x5d7d96=await Message_1[_0x4340b6(0x220)][_0x4340b6(0x1f1)]({'where':{'ticketId':_0x498c34['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op']['gte']]:(0x0,moment_1[_0x4340b6(0x220)])()[_0x4340b6(0x1ee)](0x5,_0x4340b6(0x16e))['toDate']()}}});if(_0x5d7d96)return;const _0x1e697a=(0x0,Debounce_1[_0x4340b6(0x239)])(async()=>{const _0x2e336f=_0x4340b6;if(!_0x3a8ea8[_0x2e336f(0x1f7)])await _0x9a7f1e[_0x2e336f(0x30e)](_0x498c34[_0x2e336f(0x299)][_0x2e336f(0x24b)]+'@'+(_0x498c34[_0x2e336f(0x1f3)]?_0x2e336f(0x194):'s.whatsapp.net'),{'text':(0x0,Mustache_1['default'])(_0x3a8ea8[_0x2e336f(0x22f)],_0x498c34)});else{const _0x44d5b7=path_1[_0x2e336f(0x220)][_0x2e336f(0x27a)]('public','company'+_0x498c34[_0x2e336f(0x228)],_0x3a8ea8[_0x2e336f(0x1f7)]),_0x4e21a7=await(0x0,SendWhatsAppMedia_1[_0x2e336f(0x225)])(_0x3a8ea8[_0x2e336f(0x1f7)],_0x44d5b7,_0x3a8ea8[_0x2e336f(0x22f)],_0x498c34['companyId']);await _0x9a7f1e[_0x2e336f(0x30e)](_0x498c34[_0x2e336f(0x299)][_0x2e336f(0x24b)]+'@'+(_0x498c34[_0x2e336f(0x1f3)]?_0x2e336f(0x194):_0x2e336f(0x328)),{..._0x4e21a7});}},0x3e8,_0x498c34['id']);_0x1e697a();return;}},handleMsgAck=async(_0x49ba74,_0x2393a5)=>{const _0x390cef=a558_0x25a89b,_0x187f0e=(0x0,socket_1[_0x390cef(0x175)])();try{const _0x4430cc=await Message_1[_0x390cef(0x220)][_0x390cef(0x1ce)](_0x49ba74[_0x390cef(0x227)]['id'],{'include':[_0x390cef(0x299),{'model':Message_1[_0x390cef(0x220)],'as':_0x390cef(0x1c8),'include':[_0x390cef(0x299)]}]});if(!_0x4430cc){console['log'](_0x49ba74),console[_0x390cef(0x1bd)](_0x390cef(0x19c));return;}await _0x4430cc[_0x390cef(0x201)]({'ack':_0x2393a5}),_0x187f0e['to'](_0x4430cc['ticketId'][_0x390cef(0x224)]())[_0x390cef(0x1fd)]('company-'+_0x4430cc['companyId']+_0x390cef(0x264),{'action':_0x390cef(0x201),'message':_0x4430cc});}catch(_0x5e07ae){Sentry[_0x390cef(0x293)](_0x5e07ae),logger_1[_0x390cef(0x329)][_0x390cef(0x1e8)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x5e07ae);}};exports[a558_0x25a89b(0x2d0)]=handleMsgAck;const verifyRecentCampaign=async(_0x1a5e56,_0x33f7dc)=>{const _0x4b4599=a558_0x25a89b;if(!_0x1a5e56['key'][_0x4b4599(0x262)]){const _0x44ae48=_0x1a5e56[_0x4b4599(0x227)][_0x4b4599(0x2ab)][_0x4b4599(0x2b9)](/\D/g,''),_0x9eab09=await Campaign_1[_0x4b4599(0x220)][_0x4b4599(0x1ab)]({'where':{'companyId':_0x33f7dc,'status':_0x4b4599(0x20f),'confirmation':!![]}});if(_0x9eab09){const _0x596130=_0x9eab09[_0x4b4599(0x1ad)](_0x2be7fc=>_0x2be7fc['id']),_0x45d3f7=await CampaignShipping_1[_0x4b4599(0x220)][_0x4b4599(0x1f1)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x596130},'number':_0x44ae48,'confirmation':null}});_0x45d3f7&&(await _0x45d3f7[_0x4b4599(0x201)]({'confirmedAt':(0x0,moment_1[_0x4b4599(0x220)])(),'confirmation':!![]}),await queues_1[_0x4b4599(0x2b0)][_0x4b4599(0x274)]('DispatchCampaign',{'campaignShippingId':_0x45d3f7['id'],'campaignId':_0x45d3f7[_0x4b4599(0x2bc)]},{'delay':(0x0,queues_1[_0x4b4599(0x29c)])((0x0,queues_1[_0x4b4599(0x24d)])(0x0,0xa))}));}}};exports[a558_0x25a89b(0x271)]=verifyRecentCampaign;const verifyCampaignMessageAndCloseTicket=async(_0x26e8a4,_0x4dfe00)=>{const _0x2e18bf=a558_0x25a89b,_0x73d89c=(0x0,socket_1[_0x2e18bf(0x175)])(),_0x195947=(0x0,exports[_0x2e18bf(0x31f)])(_0x26e8a4),_0x16336b=/\u200c/[_0x2e18bf(0x233)](_0x195947);if(_0x26e8a4['key'][_0x2e18bf(0x262)]&&_0x16336b){const _0x27acb0=await Message_1['default'][_0x2e18bf(0x1f1)]({'where':{'id':_0x26e8a4[_0x2e18bf(0x227)]['id'],'companyId':_0x4dfe00}}),_0x29e2d1=await Ticket_1[_0x2e18bf(0x220)]['findByPk'](_0x27acb0[_0x2e18bf(0x26e)]);await _0x29e2d1[_0x2e18bf(0x201)]({'status':_0x2e18bf(0x319)}),_0x73d89c['to'](_0x2e18bf(0x321)+_0x29e2d1['companyId']+_0x2e18bf(0x1b4))['emit'](_0x2e18bf(0x321)+_0x29e2d1[_0x2e18bf(0x228)]+_0x2e18bf(0x25b),{'action':'delete','ticket':_0x29e2d1,'ticketId':_0x29e2d1['id']}),_0x73d89c['to'](_0x2e18bf(0x321)+_0x4dfe00+'-'+_0x29e2d1[_0x2e18bf(0x211)])['to'](_0x29e2d1['id'][_0x2e18bf(0x224)]())[_0x2e18bf(0x1fd)](_0x2e18bf(0x321)+_0x29e2d1[_0x2e18bf(0x228)]+_0x2e18bf(0x25b),{'action':_0x2e18bf(0x201),'ticket':_0x29e2d1,'ticketId':_0x29e2d1['id']});}};exports[a558_0x25a89b(0x1e3)]=verifyCampaignMessageAndCloseTicket;const filterMessages=_0x4fcd1a=>{const _0x2c7d53=a558_0x25a89b;if([baileys_1[_0x2c7d53(0x16c)][_0x2c7d53(0x1c6)],baileys_1[_0x2c7d53(0x16c)][_0x2c7d53(0x208)],baileys_1['WAMessageStubType'][_0x2c7d53(0x21f)],baileys_1['WAMessageStubType']['CIPHERTEXT']]['includes'](_0x4fcd1a[_0x2c7d53(0x285)]))return![];return!![];},wbotMessageListener=async(_0x50d287,_0x4158e6,_0x5e0ed2)=>{const _0x223a3e=a558_0x25a89b;_0x50d287['ev']['on']('messages.upsert',async _0x55bf5f=>{const _0x764712=a558_0x59f5,_0x227d7e=_0x55bf5f[_0x764712(0x1b2)][_0x764712(0x1d6)](filterMessages);if(!_0x227d7e)return;await app_1[_0x764712(0x220)][_0x764712(0x1cd)](_0x764712(0x1e6))[_0x764712(0x229)]['add']('HandleMessageJob',{'whatsappId':_0x5e0ed2['id'],'messages':_0x227d7e,'companyId':_0x4158e6},{'removeOnComplete':!![],'attempts':0x3});}),_0x50d287['ev']['on'](_0x223a3e(0x1d7),async _0x4b6a1d=>{const _0x21c35d=_0x223a3e;if(_0x4b6a1d[_0x21c35d(0x324)]===0x0)return;await app_1[_0x21c35d(0x220)][_0x21c35d(0x1cd)](_0x21c35d(0x1e6))[_0x21c35d(0x229)][_0x21c35d(0x274)]('MessageUpdateJob',{'whatsappId':_0x5e0ed2['id'],'messageUpdate':_0x4b6a1d,'companyId':_0x4158e6},{'removeOnComplete':!![],'attempts':0x3,'delay':0x64});}),_0x50d287['ev']['on'](_0x223a3e(0x2a9),async _0x2b90dc=>{const _0x1c73f7=_0x223a3e;console[_0x1c73f7(0x1bd)](_0x2b90dc);if(_0x2b90dc['length']===0x0)return;for(const _0x5817d8 of _0x2b90dc){const _0x5b085a=_0x5817d8['id'][_0x1c73f7(0x28e)]('@')[0x0],_0x115e39=_0x5817d8[_0x1c73f7(0x2e6)]||_0x5b085a,_0x9a0a90={'name':_0x115e39,'number':_0x5b085a,'isGroup':!![],'companyId':_0x4158e6,'remoteJid':_0x5817d8['id'],'whatsappId':_0x50d287['id']};await(0x0,CreateOrUpdateContactService_1[_0x1c73f7(0x220)])(_0x9a0a90,_0x50d287,_0x5817d8['id']);}});};exports['wbotMessageListener']=wbotMessageListener;