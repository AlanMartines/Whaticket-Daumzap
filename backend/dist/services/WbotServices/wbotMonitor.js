const a559_0x5b8967=a559_0x55f9;(function(_0x58ac04,_0x308d9b){const _0x3a5405=a559_0x55f9,_0x2b1cd1=_0x58ac04();while(!![]){try{const _0x821c27=parseInt(_0x3a5405(0x179))/0x1*(parseInt(_0x3a5405(0x17a))/0x2)+parseInt(_0x3a5405(0x197))/0x3+parseInt(_0x3a5405(0x1a0))/0x4*(parseInt(_0x3a5405(0x191))/0x5)+parseInt(_0x3a5405(0x17f))/0x6+parseInt(_0x3a5405(0x196))/0x7+-parseInt(_0x3a5405(0x180))/0x8*(parseInt(_0x3a5405(0x183))/0x9)+-parseInt(_0x3a5405(0x19f))/0xa;if(_0x821c27===_0x308d9b)break;else _0x2b1cd1['push'](_0x2b1cd1['shift']());}catch(_0x2ca714){_0x2b1cd1['push'](_0x2b1cd1['shift']());}}}(a559_0xc5ec,0xdf440));const a559_0xfee90a=(function(){let _0x444f21=!![];return function(_0x3dc659,_0x17c1eb){const _0x1cecb9=_0x444f21?function(){const _0x3d6d8e=a559_0x55f9;if(_0x17c1eb){const _0x5b70ae=_0x17c1eb[_0x3d6d8e(0x189)](_0x3dc659,arguments);return _0x17c1eb=null,_0x5b70ae;}}:function(){};return _0x444f21=![],_0x1cecb9;};}()),a559_0x2f7c13=a559_0xfee90a(this,function(){const _0x14b58c=a559_0x55f9;return a559_0x2f7c13[_0x14b58c(0x172)]()['search'](_0x14b58c(0x17e))[_0x14b58c(0x172)]()[_0x14b58c(0x175)](a559_0x2f7c13)['search']('(((.+)+)+)+$');});a559_0x2f7c13();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a559_0x5b8967(0x17b)]?function(_0x2a2ce1,_0x20e321,_0x1abced,_0x5203c2){const _0x2f4c59=a559_0x5b8967;if(_0x5203c2===undefined)_0x5203c2=_0x1abced;var _0x29b883=Object['getOwnPropertyDescriptor'](_0x20e321,_0x1abced);(!_0x29b883||(_0x2f4c59(0x1a3)in _0x29b883?!_0x20e321['__esModule']:_0x29b883['writable']||_0x29b883['configurable']))&&(_0x29b883={'enumerable':!![],'get':function(){return _0x20e321[_0x1abced];}}),Object[_0x2f4c59(0x192)](_0x2a2ce1,_0x5203c2,_0x29b883);}:function(_0x2e954a,_0x2342c6,_0x2748b5,_0x31112f){if(_0x31112f===undefined)_0x31112f=_0x2748b5;_0x2e954a[_0x31112f]=_0x2342c6[_0x2748b5];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a559_0x5b8967(0x17b)]?function(_0x55c479,_0x43306f){const _0x84183c=a559_0x5b8967;Object[_0x84183c(0x192)](_0x55c479,_0x84183c(0x1a1),{'enumerable':!![],'value':_0x43306f});}:function(_0x32946c,_0x29d7bb){const _0x4a20d6=a559_0x5b8967;_0x32946c[_0x4a20d6(0x1a1)]=_0x29d7bb;}),__importStar=this&&this['__importStar']||function(_0x2f2a42){const _0x316d19=a559_0x5b8967;if(_0x2f2a42&&_0x2f2a42[_0x316d19(0x1a4)])return _0x2f2a42;var _0x55ca13={};if(_0x2f2a42!=null){for(var _0x380cec in _0x2f2a42)if(_0x380cec!=='default'&&Object[_0x316d19(0x18c)][_0x316d19(0x186)]['call'](_0x2f2a42,_0x380cec))__createBinding(_0x55ca13,_0x2f2a42,_0x380cec);}return __setModuleDefault(_0x55ca13,_0x2f2a42),_0x55ca13;},__importDefault=this&&this[a559_0x5b8967(0x19e)]||function(_0x1eb148){const _0x47ec1c=a559_0x5b8967;return _0x1eb148&&_0x1eb148[_0x47ec1c(0x1a4)]?_0x1eb148:{'default':_0x1eb148};};Object[a559_0x5b8967(0x192)](exports,a559_0x5b8967(0x1a4),{'value':!![]});const Sentry=__importStar(require(a559_0x5b8967(0x1a8))),Contact_1=__importDefault(require(a559_0x5b8967(0x1a7))),Setting_1=__importDefault(require(a559_0x5b8967(0x195))),Ticket_1=__importDefault(require(a559_0x5b8967(0x1a6))),logger_1=require('../../utils/logger'),CreateOrUpdateBaileysService_1=__importDefault(require(a559_0x5b8967(0x1aa))),CreateMessageService_1=__importDefault(require(a559_0x5b8967(0x17c))),SendPresenceStatus_1=require(a559_0x5b8967(0x1a5));let messageControl=[];function a559_0x55f9(_0x2c0954,_0x2e035d){const _0x4fc86=a559_0xc5ec();return a559_0x55f9=function(_0x2f7c13,_0xfee90a){_0x2f7c13=_0x2f7c13-0x171;let _0xc5ec1=_0x4fc86[_0x2f7c13];return _0xc5ec1;},a559_0x55f9(_0x2c0954,_0x2e035d);}const wbotMonitor=async(_0x1dd686,_0x44b64f,_0x524ef4)=>{const _0x34fc3f=a559_0x5b8967;try{_0x1dd686['ws']['on'](_0x34fc3f(0x18b),async _0x4d0a72=>{const _0x30ac30=_0x34fc3f,_0x37667a=_0x4d0a72[_0x30ac30(0x174)][0x0];if(_0x37667a[_0x30ac30(0x19a)]===_0x30ac30(0x181)){const {from:_0x1fe5e8,id:_0x479918}=_0x4d0a72[_0x30ac30(0x199)];}if(_0x37667a[_0x30ac30(0x19a)]==='terminate'){const _0x3c2248=await Setting_1['default'][_0x30ac30(0x194)]({'where':{'key':_0x30ac30(0x193),'companyId':_0x524ef4}});if(!_0x3c2248||_0x3c2248['value']===_0x30ac30(0x184)){if(messageControl[_0x30ac30(0x19d)]>0x1388)messageControl=[];var _0x1c90db=messageControl[_0x30ac30(0x173)](_0x212e3a=>_0x212e3a[_0x30ac30(0x188)]===_0x4d0a72[_0x30ac30(0x199)][_0x30ac30(0x188)]);(!_0x1c90db||new Date()[_0x30ac30(0x176)]()-_0x1c90db[_0x30ac30(0x177)]>=0x3e8*0x3c*0x5)&&(await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x1dd686,_0x4d0a72[_0x30ac30(0x199)][_0x30ac30(0x188)]),await _0x1dd686[_0x30ac30(0x190)](_0x4d0a72[_0x30ac30(0x199)]['from'],{'text':_0x30ac30(0x187)}),_0x1c90db&&(_0x1c90db=null,messageControl=messageControl[_0x30ac30(0x19b)](_0x3a7512=>_0x3a7512[_0x30ac30(0x188)]!==_0x4d0a72[_0x30ac30(0x199)][_0x30ac30(0x188)])));!_0x1c90db&&messageControl[_0x30ac30(0x198)]({'from':_0x4d0a72['attrs'][_0x30ac30(0x188)],'time':new Date()['getTime']()});const _0x5505ad=_0x4d0a72[_0x30ac30(0x199)][_0x30ac30(0x188)][_0x30ac30(0x178)](/\D/g,''),_0x1892c8=await Contact_1[_0x30ac30(0x1a1)][_0x30ac30(0x194)]({'where':{'companyId':_0x524ef4,'number':_0x5505ad}}),_0x3b480c=await Ticket_1[_0x30ac30(0x1a1)][_0x30ac30(0x194)]({'where':{'contactId':_0x1892c8['id'],'whatsappId':_0x1dd686['id'],'status':_0x30ac30(0x18a),'companyId':_0x524ef4}});if(!_0x3b480c)return;const _0x4cbe14=new Date(),_0xe7eaa1=_0x4cbe14['getHours'](),_0x22cfd9=_0x4cbe14[_0x30ac30(0x1a2)](),_0xe6375a=_0x30ac30(0x1a9)+_0xe7eaa1+':'+_0x22cfd9,_0xf35a11={'id':_0x37667a[_0x30ac30(0x199)]['call-id'],'ticketId':_0x3b480c['id'],'contactId':_0x1892c8['id'],'body':_0xe6375a,'fromMe':![],'mediaType':'call_log','read':!![],'quotedMsgId':null,'ack':0x1};return typeof _0xe6375a!==_0x30ac30(0x185)&&console[_0x30ac30(0x18d)](_0x30ac30(0x19c),_0xe6375a),await _0x3b480c[_0x30ac30(0x18e)]({'lastMessage':_0xe6375a}),_0x3b480c[_0x30ac30(0x171)]==='closed'&&await _0x3b480c[_0x30ac30(0x18e)]({'status':_0x30ac30(0x17d)}),(0x0,CreateMessageService_1['default'])({'messageData':_0xf35a11,'ticket':_0x3b480c,'companyId':_0x524ef4});}}}),_0x1dd686['ev']['on']('contacts.upsert',async _0x426225=>{const _0x2e1818=_0x34fc3f;await(0x0,CreateOrUpdateBaileysService_1[_0x2e1818(0x1a1)])({'whatsappId':_0x44b64f['id'],'contacts':_0x426225});});}catch(_0x4322f5){Sentry[_0x34fc3f(0x182)](_0x4322f5),logger_1['logger'][_0x34fc3f(0x18f)](_0x4322f5);}};function a559_0xc5ec(){const _0x5b29b2=['../../models/Ticket','../../models/Contact','@sentry/node','Chamada\x20de\x20voz/vídeo\x20perdida\x20às\x20','../BaileysServices/CreateOrUpdateBaileysService','status','toString','find','content','constructor','getTime','time','replace','2tOuttl','976276eZAknv','create','../MessageServices/CreateMessageService','pending','(((.+)+)+)+$','7446444GPtXSO','160AWdomR','offer','captureException','180198HDZNFX','disabled','string','hasOwnProperty','*Mensagem\x20Automática:*\x0a\x0aAs\x20chamadas\x20de\x20voz\x20e\x20vídeo\x20estão\x20desabilitas\x20para\x20esse\x20WhatsApp,\x20favor\x20enviar\x20uma\x20mensagem\x20de\x20texto.\x20Obrigado','from','apply','open','CB:call','prototype','trace','update','error','sendMessage','1530835lFzcuu','defineProperty','call','findOne','../../models/Setting','1859935uKQYZL','3644544xrqzZY','push','attrs','tag','filter','body\x20is\x20not\x20a\x20string','length','__importDefault','29953010fcEzrq','8VcNqjz','default','getMinutes','get','__esModule','../../helpers/SendPresenceStatus'];a559_0xc5ec=function(){return _0x5b29b2;};return a559_0xc5ec();}exports[a559_0x5b8967(0x1a1)]=wbotMonitor;