const a559_0x51118c=a559_0x365f;function a559_0x4ddf(){const _0x403627=['../../helpers/SendPresenceStatus','open','11gPKBPg','getTime','value','104043mbfFRq','51704Xozpgt','*Mensagem\x20Automática:*\x0a\x0aAs\x20chamadas\x20de\x20voz\x20e\x20vídeo\x20estão\x20desabilitas\x20para\x20esse\x20WhatsApp,\x20favor\x20enviar\x20uma\x20mensagem\x20de\x20texto.\x20Obrigado','content','25147032iqWwZn','disabled','defineProperty','138QrLayQ','apply','captureException','173971Tpqdae','toString','hasOwnProperty','@sentry/node','from','search','7605820LMbYOG','prototype','8rUEWuE','__setModuleDefault','error','SendPresenceStatus','../MessageServices/CreateMessageService','body\x20is\x20not\x20a\x20string','closed','8YGrMuf','../../models/Contact','Chamada\x20de\x20voz/vídeo\x20perdida\x20às\x20','sendMessage','trace','findOne','default','attrs','getMinutes','../../models/Ticket','../../utils/logger','contacts.upsert','(((.+)+)+)+$','5804199RkiKDl','../BaileysServices/CreateOrUpdateBaileysService','__importStar','writable','pending','length','12iJIDAS','__esModule','update','configurable','constructor','call','filter','../../models/Setting','call_log','create','terminate','1197075AktXYc','getOwnPropertyDescriptor','__importDefault'];a559_0x4ddf=function(){return _0x403627;};return a559_0x4ddf();}(function(_0x2e5a07,_0x1ccd83){const _0x29f126=a559_0x365f,_0x5f5c88=_0x2e5a07();while(!![]){try{const _0x52d90f=parseInt(_0x29f126(0x1f7))/0x1*(parseInt(_0x29f126(0x1d0))/0x2)+parseInt(_0x29f126(0x1f6))/0x3*(-parseInt(_0x29f126(0x1e3))/0x4)+parseInt(_0x29f126(0x1ee))/0x5+-parseInt(_0x29f126(0x1be))/0x6*(parseInt(_0x29f126(0x1c1))/0x7)+-parseInt(_0x29f126(0x1c9))/0x8*(parseInt(_0x29f126(0x1dd))/0x9)+-parseInt(_0x29f126(0x1c7))/0xa+-parseInt(_0x29f126(0x1f3))/0xb*(-parseInt(_0x29f126(0x1bb))/0xc);if(_0x52d90f===_0x1ccd83)break;else _0x5f5c88['push'](_0x5f5c88['shift']());}catch(_0x6e8fca){_0x5f5c88['push'](_0x5f5c88['shift']());}}}(a559_0x4ddf,0x70776));const a559_0x57adf6=(function(){let _0xa84b62=!![];return function(_0x3ce45c,_0xf1f948){const _0x531d68=_0xa84b62?function(){const _0x57bf26=a559_0x365f;if(_0xf1f948){const _0x170300=_0xf1f948[_0x57bf26(0x1bf)](_0x3ce45c,arguments);return _0xf1f948=null,_0x170300;}}:function(){};return _0xa84b62=![],_0x531d68;};}()),a559_0x2f5991=a559_0x57adf6(this,function(){const _0xb53921=a559_0x365f;return a559_0x2f5991[_0xb53921(0x1c2)]()[_0xb53921(0x1c6)](_0xb53921(0x1dc))[_0xb53921(0x1c2)]()[_0xb53921(0x1e7)](a559_0x2f5991)[_0xb53921(0x1c6)](_0xb53921(0x1dc));});function a559_0x365f(_0x1bd120,_0x3b548d){const _0x364f16=a559_0x4ddf();return a559_0x365f=function(_0x2f5991,_0x57adf6){_0x2f5991=_0x2f5991-0x1ba;let _0x4ddf6a=_0x364f16[_0x2f5991];return _0x4ddf6a;},a559_0x365f(_0x1bd120,_0x3b548d);}a559_0x2f5991();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a559_0x51118c(0x1ec)]?function(_0x2166fb,_0x3e8880,_0x58b5ef,_0x5e67fe){const _0x415b85=a559_0x51118c;if(_0x5e67fe===undefined)_0x5e67fe=_0x58b5ef;var _0x360eac=Object[_0x415b85(0x1ef)](_0x3e8880,_0x58b5ef);(!_0x360eac||('get'in _0x360eac?!_0x3e8880[_0x415b85(0x1e4)]:_0x360eac[_0x415b85(0x1e0)]||_0x360eac[_0x415b85(0x1e6)]))&&(_0x360eac={'enumerable':!![],'get':function(){return _0x3e8880[_0x58b5ef];}}),Object[_0x415b85(0x1bd)](_0x2166fb,_0x5e67fe,_0x360eac);}:function(_0x9a65ee,_0x49d9cf,_0x1d040b,_0x109d8b){if(_0x109d8b===undefined)_0x109d8b=_0x1d040b;_0x9a65ee[_0x109d8b]=_0x49d9cf[_0x1d040b];}),__setModuleDefault=this&&this[a559_0x51118c(0x1ca)]||(Object[a559_0x51118c(0x1ec)]?function(_0x17377e,_0x2ec1a2){const _0xf1ca2e=a559_0x51118c;Object[_0xf1ca2e(0x1bd)](_0x17377e,_0xf1ca2e(0x1d6),{'enumerable':!![],'value':_0x2ec1a2});}:function(_0x425fe7,_0x1a7c4f){const _0x36f252=a559_0x51118c;_0x425fe7[_0x36f252(0x1d6)]=_0x1a7c4f;}),__importStar=this&&this[a559_0x51118c(0x1df)]||function(_0x25d41e){const _0x414eab=a559_0x51118c;if(_0x25d41e&&_0x25d41e[_0x414eab(0x1e4)])return _0x25d41e;var _0x2ae8e8={};if(_0x25d41e!=null){for(var _0xab2743 in _0x25d41e)if(_0xab2743!==_0x414eab(0x1d6)&&Object[_0x414eab(0x1c8)][_0x414eab(0x1c3)][_0x414eab(0x1e8)](_0x25d41e,_0xab2743))__createBinding(_0x2ae8e8,_0x25d41e,_0xab2743);}return __setModuleDefault(_0x2ae8e8,_0x25d41e),_0x2ae8e8;},__importDefault=this&&this[a559_0x51118c(0x1f0)]||function(_0x282697){const _0xc8e733=a559_0x51118c;return _0x282697&&_0x282697[_0xc8e733(0x1e4)]?_0x282697:{'default':_0x282697};};Object['defineProperty'](exports,a559_0x51118c(0x1e4),{'value':!![]});const Sentry=__importStar(require(a559_0x51118c(0x1c4))),Contact_1=__importDefault(require(a559_0x51118c(0x1d1))),Setting_1=__importDefault(require(a559_0x51118c(0x1ea))),Ticket_1=__importDefault(require(a559_0x51118c(0x1d9))),logger_1=require(a559_0x51118c(0x1da)),CreateOrUpdateBaileysService_1=__importDefault(require(a559_0x51118c(0x1de))),CreateMessageService_1=__importDefault(require(a559_0x51118c(0x1cd))),SendPresenceStatus_1=require(a559_0x51118c(0x1f1));let messageControl=[];const wbotMonitor=async(_0x423c67,_0x405323,_0x93cdf2)=>{const _0x441762=a559_0x51118c;try{_0x423c67['ws']['on']('CB:call',async _0x2b130f=>{const _0x4c9973=a559_0x365f,_0xbbdc6c=_0x2b130f[_0x4c9973(0x1ba)][0x0];if(_0xbbdc6c['tag']==='offer'){const {from:_0x328f61,id:_0x3ca240}=_0x2b130f[_0x4c9973(0x1d7)];}if(_0xbbdc6c['tag']===_0x4c9973(0x1ed)){const _0x47fdd9=await Setting_1[_0x4c9973(0x1d6)][_0x4c9973(0x1d5)]({'where':{'key':_0x4c9973(0x1e8),'companyId':_0x93cdf2}});if(!_0x47fdd9||_0x47fdd9[_0x4c9973(0x1f5)]===_0x4c9973(0x1bc)){if(messageControl[_0x4c9973(0x1e2)]>0x1388)messageControl=[];var _0x132b14=messageControl['find'](_0x3cb5ec=>_0x3cb5ec[_0x4c9973(0x1c5)]===_0x2b130f['attrs'][_0x4c9973(0x1c5)]);(!_0x132b14||new Date()[_0x4c9973(0x1f4)]()-_0x132b14['time']>=0x3e8*0x3c*0x5)&&(await(0x0,SendPresenceStatus_1[_0x4c9973(0x1cc)])(_0x423c67,_0x2b130f[_0x4c9973(0x1d7)][_0x4c9973(0x1c5)]),await _0x423c67[_0x4c9973(0x1d3)](_0x2b130f[_0x4c9973(0x1d7)]['from'],{'text':_0x4c9973(0x1f8)}),_0x132b14&&(_0x132b14=null,messageControl=messageControl[_0x4c9973(0x1e9)](_0x4c3b78=>_0x4c3b78[_0x4c9973(0x1c5)]!==_0x2b130f[_0x4c9973(0x1d7)]['from'])));!_0x132b14&&messageControl['push']({'from':_0x2b130f[_0x4c9973(0x1d7)]['from'],'time':new Date()[_0x4c9973(0x1f4)]()});const _0xe89d07=_0x2b130f[_0x4c9973(0x1d7)][_0x4c9973(0x1c5)]['replace'](/\D/g,''),_0x459f4d=await Contact_1['default'][_0x4c9973(0x1d5)]({'where':{'companyId':_0x93cdf2,'number':_0xe89d07}}),_0x2f0915=await Ticket_1['default'][_0x4c9973(0x1d5)]({'where':{'contactId':_0x459f4d['id'],'whatsappId':_0x423c67['id'],'status':_0x4c9973(0x1f2),'companyId':_0x93cdf2}});if(!_0x2f0915)return;const _0x1b8905=new Date(),_0x34fdbd=_0x1b8905['getHours'](),_0x3ae555=_0x1b8905[_0x4c9973(0x1d8)](),_0x550c2b=_0x4c9973(0x1d2)+_0x34fdbd+':'+_0x3ae555,_0x350786={'id':_0xbbdc6c[_0x4c9973(0x1d7)]['call-id'],'ticketId':_0x2f0915['id'],'contactId':_0x459f4d['id'],'body':_0x550c2b,'fromMe':![],'mediaType':_0x4c9973(0x1eb),'read':!![],'quotedMsgId':null,'ack':0x1};return typeof _0x550c2b!=='string'&&console[_0x4c9973(0x1d4)](_0x4c9973(0x1ce),_0x550c2b),await _0x2f0915['update']({'lastMessage':_0x550c2b}),_0x2f0915['status']===_0x4c9973(0x1cf)&&await _0x2f0915[_0x4c9973(0x1e5)]({'status':_0x4c9973(0x1e1)}),(0x0,CreateMessageService_1['default'])({'messageData':_0x350786,'ticket':_0x2f0915,'companyId':_0x93cdf2});}}}),_0x423c67['ev']['on'](_0x441762(0x1db),async _0x43aa41=>{const _0x492c73=_0x441762;await(0x0,CreateOrUpdateBaileysService_1[_0x492c73(0x1d6)])({'whatsappId':_0x405323['id'],'contacts':_0x43aa41});});}catch(_0x44e4a9){Sentry[_0x441762(0x1c0)](_0x44e4a9),logger_1['logger'][_0x441762(0x1cb)](_0x44e4a9);}};exports['default']=wbotMonitor;