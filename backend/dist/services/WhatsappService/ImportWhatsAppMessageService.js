const a563_0x399f06=a563_0x178f;(function(_0x4c668d,_0x2cf1ab){const _0x7f04f2=a563_0x178f,_0x217d68=_0x4c668d();while(!![]){try{const _0x4b9259=-parseInt(_0x7f04f2(0x1f0))/0x1*(parseInt(_0x7f04f2(0x213))/0x2)+parseInt(_0x7f04f2(0x205))/0x3*(-parseInt(_0x7f04f2(0x208))/0x4)+-parseInt(_0x7f04f2(0x1f1))/0x5*(-parseInt(_0x7f04f2(0x224))/0x6)+parseInt(_0x7f04f2(0x1ff))/0x7*(-parseInt(_0x7f04f2(0x228))/0x8)+parseInt(_0x7f04f2(0x207))/0x9*(parseInt(_0x7f04f2(0x219))/0xa)+parseInt(_0x7f04f2(0x215))/0xb*(parseInt(_0x7f04f2(0x203))/0xc)+parseInt(_0x7f04f2(0x206))/0xd;if(_0x4b9259===_0x2cf1ab)break;else _0x217d68['push'](_0x217d68['shift']());}catch(_0x3086c0){_0x217d68['push'](_0x217d68['shift']());}}}(a563_0x1d52,0xa6768));function a563_0x178f(_0x497d05,_0x87b15d){const _0x45f8d6=a563_0x1d52();return a563_0x178f=function(_0x4d170c,_0xb4e0c1){_0x4d170c=_0x4d170c-0x1f0;let _0x1d52c1=_0x45f8d6[_0x4d170c];return _0x1d52c1;},a563_0x178f(_0x497d05,_0x87b15d);}const a563_0xb4e0c1=(function(){let _0x33263f=!![];return function(_0x120753,_0x54b2da){const _0x3a3681=_0x33263f?function(){const _0x1ba679=a563_0x178f;if(_0x54b2da){const _0x2401be=_0x54b2da[_0x1ba679(0x20f)](_0x120753,arguments);return _0x54b2da=null,_0x2401be;}}:function(){};return _0x33263f=![],_0x3a3681;};}()),a563_0x4d170c=a563_0xb4e0c1(this,function(){const _0x57a470=a563_0x178f;return a563_0x4d170c[_0x57a470(0x1f7)]()[_0x57a470(0x20e)]('(((.+)+)+)+$')[_0x57a470(0x1f7)]()[_0x57a470(0x211)](a563_0x4d170c)['search']('(((.+)+)+)+$');});a563_0x4d170c();'use strict';var __importDefault=this&&this[a563_0x399f06(0x21e)]||function(_0xb4b985){const _0x49cfb7=a563_0x399f06;return _0xb4b985&&_0xb4b985[_0x49cfb7(0x220)]?_0xb4b985:{'default':_0xb4b985};};Object[a563_0x399f06(0x214)](exports,a563_0x399f06(0x220),{'value':!![]}),exports[a563_0x399f06(0x1fe)]=void 0x0;const AppError_1=__importDefault(require(a563_0x399f06(0x1fd))),Whatsapp_1=__importDefault(require(a563_0x399f06(0x1f2))),Ticket_1=__importDefault(require(a563_0x399f06(0x222))),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),wbot_1=require(a563_0x399f06(0x20b)),socket_1=require(a563_0x399f06(0x1f8)),wbotMessageListener_1=require(a563_0x399f06(0x21a)),moment_1=__importDefault(require(a563_0x399f06(0x209))),sequelize_1=require('sequelize'),date_fns_1=require(a563_0x399f06(0x1f3)),closeImportedTickets=async _0x349f98=>{const _0x6bd5e7=a563_0x399f06;console[_0x6bd5e7(0x225)](_0x6bd5e7(0x1fe));const _0x628b3f=await Ticket_1[_0x6bd5e7(0x20d)][_0x6bd5e7(0x221)]({'where':{'status':'pending','whatsappId':_0x349f98,'imported':{[sequelize_1['Op']['lt']]:(0x0,date_fns_1[_0x6bd5e7(0x1f4)])(new Date(),{'hours':0x5})}}});for(const _0x40d029 of _0x628b3f){await new Promise(_0x502a03=>setTimeout(_0x502a03,0x14a)),await(0x0,UpdateTicketService_1[_0x6bd5e7(0x20d)])({'ticketData':{'status':_0x6bd5e7(0x22a)},'ticketId':_0x40d029['id'],'companyId':_0x40d029[_0x6bd5e7(0x1f5)]});}let _0x50d9f0=await Whatsapp_1[_0x6bd5e7(0x20d)][_0x6bd5e7(0x227)](_0x349f98);_0x50d9f0[_0x6bd5e7(0x226)]({'statusImportMessages':null});const _0x1b6bf6=(0x0,socket_1['getIO'])();_0x1b6bf6['to'](_0x6bd5e7(0x200)+_0x50d9f0[_0x6bd5e7(0x1f5)]+_0x6bd5e7(0x1fc))[_0x6bd5e7(0x21d)](_0x6bd5e7(0x204)+_0x50d9f0[_0x6bd5e7(0x1f5)],{'action':_0x6bd5e7(0x20c)});};exports['closeImportedTickets']=closeImportedTickets;function compareMessageTimestamps(_0x53dc75,_0x28d1cb){const _0xb18b23=a563_0x399f06;return _0x53dc75[_0xb18b23(0x201)]-_0x28d1cb[_0xb18b23(0x201)];}function removeDuplicateById(_0x52de18){const _0x4892d7=a563_0x399f06,_0x3e5665=new Map(),_0x3a790c=[];for(const _0x2215b1 of _0x52de18){const _0x4a3c26=_0x2215b1[_0x4892d7(0x216)]['id'];!_0x3e5665['has'](_0x4a3c26)&&(_0x3e5665[_0x4892d7(0x210)](_0x4a3c26,!![]),_0x3a790c[_0x4892d7(0x21b)](_0x2215b1));}return _0x3a790c[_0x4892d7(0x229)](compareMessageTimestamps);}function a563_0x1d52(){const _0x447f03=['7AGJqQS','company-','messageTimestamp','processImportMessagesWppId','12aEqShh','importMessages-','3sLEhgv','19164912iiFDqd','476046kbJzkO','3986440dHAThB','moment','closedTicketsPostImported','../../libs/wbot','refresh','default','search','apply','set','constructor','getWbot','1902746McSsFD','defineProperty','8129660iHeyqF','key','dataMessages','low','30hPYZYN','../WbotServices/wbotMessageListener','push','length','emit','__importDefault','getIO','__esModule','findAll','../../models/Ticket','format','7002XEhTrI','log','update','findByPk','6797072QYhmEe','sort','closed','floor','renderButtonCloseTickets','1BDiDjJ','4745vfDFET','../../models/Whatsapp','date-fns','add','companyId','DD/MM/YY\x20HH:mm:ss','toString','../../libs/socket','ERR_NOT_MESSAGE_TO_IMPORT','whatsapps','ERROR_IMPORTING_MESSAGE','-mainchannel','../../errors/AppError','closeImportedTickets'];a563_0x1d52=function(){return _0x447f03;};return a563_0x1d52();}const ImportWhatsAppService=async _0x1daddb=>{const _0x1fcec2=a563_0x399f06,_0x2f7fe1=(0x0,wbot_1[_0x1fcec2(0x212)])(_0x1daddb['id']);try{const _0x97813f=(0x0,socket_1[_0x1fcec2(0x21f)])(),_0x55eb7c=removeDuplicateById(wbot_1[_0x1fcec2(0x217)][_0x1daddb['id']]);console[_0x1fcec2(0x225)](_0x1fcec2(0x202));const _0x95294e=_0x55eb7c[_0x1fcec2(0x21c)];let _0x6cb410=0x0;while(_0x6cb410<_0x95294e){try{const _0x50ca52=_0x55eb7c[_0x6cb410];await(0x0,wbotMessageListener_1['handleMessage'])(_0x50ca52,_0x2f7fe1,_0x1daddb[_0x1fcec2(0x1f5)],!![]);if(_0x6cb410%0x2===0x0){const _0x524ca3=Math[_0x1fcec2(0x22b)](_0x50ca52[_0x1fcec2(0x201)][_0x1fcec2(0x218)]*0x3e8);_0x97813f[_0x1fcec2(0x21d)](_0x1fcec2(0x204)+_0x1daddb['companyId'],{'action':'update','status':{'this':_0x6cb410+0x1,'all':_0x95294e,'date':(0x0,moment_1[_0x1fcec2(0x20d)])(_0x524ca3)[_0x1fcec2(0x223)](_0x1fcec2(0x1f6))}});}_0x6cb410+0x1===_0x95294e&&(wbot_1[_0x1fcec2(0x217)][_0x1daddb['id']]=[],_0x1daddb[_0x1fcec2(0x20a)]&&await(0x0,exports['closeImportedTickets'])(_0x1daddb['id']),await _0x1daddb[_0x1fcec2(0x226)]({'statusImportMessages':_0x1daddb[_0x1fcec2(0x20a)]?null:_0x1fcec2(0x22c),'importOldMessages':null,'importRecentMessages':null}),_0x97813f['to']('company-'+_0x1daddb[_0x1fcec2(0x1f5)]+_0x1fcec2(0x1fc))['emit'](_0x1fcec2(0x204)+_0x1daddb[_0x1fcec2(0x1f5)],{'action':_0x1fcec2(0x20c)}));}catch(_0x1d4051){console[_0x1fcec2(0x225)](_0x1d4051),console['log'](_0x1fcec2(0x1fb));}_0x6cb410++;}}catch(_0x1d94ce){console[_0x1fcec2(0x225)](_0x1d94ce);throw new AppError_1['default'](_0x1fcec2(0x1f9),0x193);}return _0x1fcec2(0x1fa);};exports[a563_0x399f06(0x20d)]=ImportWhatsAppService;