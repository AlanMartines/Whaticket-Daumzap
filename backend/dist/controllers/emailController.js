const a18_0x36908a=a18_0x4587;(function(_0x4d2e08,_0x4e77ce){const _0x2e2610=a18_0x4587,_0x5c15db=_0x4d2e08();while(!![]){try{const _0x50f58b=-parseInt(_0x2e2610(0x159))/0x1+parseInt(_0x2e2610(0x150))/0x2*(-parseInt(_0x2e2610(0x15b))/0x3)+parseInt(_0x2e2610(0x14a))/0x4+parseInt(_0x2e2610(0x141))/0x5+-parseInt(_0x2e2610(0x12c))/0x6+parseInt(_0x2e2610(0x139))/0x7+-parseInt(_0x2e2610(0x12a))/0x8*(-parseInt(_0x2e2610(0x135))/0x9);if(_0x50f58b===_0x4e77ce)break;else _0x5c15db['push'](_0x5c15db['shift']());}catch(_0x5027e3){_0x5c15db['push'](_0x5c15db['shift']());}}}(a18_0x4cd0,0xb3937));const a18_0x522f24=(function(){let _0xdf808f=!![];return function(_0x42990c,_0x28f94f){const _0x527900=_0xdf808f?function(){const _0x5a7e96=a18_0x4587;if(_0x28f94f){const _0x71dc65=_0x28f94f[_0x5a7e96(0x14e)](_0x42990c,arguments);return _0x28f94f=null,_0x71dc65;}}:function(){};return _0xdf808f=![],_0x527900;};}()),a18_0x5de146=a18_0x522f24(this,function(){const _0x2ec3db=a18_0x4587;return a18_0x5de146[_0x2ec3db(0x146)]()[_0x2ec3db(0x160)](_0x2ec3db(0x15f))[_0x2ec3db(0x146)]()[_0x2ec3db(0x14f)](a18_0x5de146)[_0x2ec3db(0x160)]('(((.+)+)+)+$');});a18_0x5de146();'use strict';var __importDefault=this&&this[a18_0x36908a(0x161)]||function(_0x13ee8c){const _0x14404e=a18_0x36908a;return _0x13ee8c&&_0x13ee8c[_0x14404e(0x158)]?_0x13ee8c:{'default':_0x13ee8c};};Object[a18_0x36908a(0x140)](exports,a18_0x36908a(0x158),{'value':!![]}),exports['agendarEnvioEmail']=exports['listarEmailsAgendados']=exports[a18_0x36908a(0x13e)]=exports['enviarEmail']=void 0x0;const EmailService_1=require(a18_0x36908a(0x13f)),Email_1=__importDefault(require(a18_0x36908a(0x165))),moment_1=__importDefault(require(a18_0x36908a(0x130))),node_cron_1=__importDefault(require('node-cron')),sequelize_1=require(a18_0x36908a(0x138)),winston_1=__importDefault(require(a18_0x36908a(0x148))),logger=winston_1[a18_0x36908a(0x163)]['createLogger']({'level':a18_0x36908a(0x13d),'format':winston_1['default']['format'][a18_0x36908a(0x12f)](winston_1[a18_0x36908a(0x163)]['format']['timestamp'](),winston_1[a18_0x36908a(0x163)]['format'][a18_0x36908a(0x14b)](({timestamp:_0x1116ba,level:_0x334174,message:_0x119380})=>{return _0x1116ba+'\x20'+_0x334174+':\x20'+_0x119380;})),'transports':[new winston_1['default'][(a18_0x36908a(0x125))][(a18_0x36908a(0x128))]()]}),enviarEmail=async(_0x21a366,_0x484dd7)=>{const _0xa94235=a18_0x36908a;try{const _0x316ac1=_0x21a366[_0xa94235(0x147)][_0xa94235(0x133)],{email:_0x5a455d,tokenSenha:_0x3eef91,assunto:_0x198355,mensagem:_0x4048c1}=_0x21a366[_0xa94235(0x131)],_0x1bb225=(0x0,moment_1[_0xa94235(0x163)])()[_0xa94235(0x156)](0x1,_0xa94235(0x12b))[_0xa94235(0x126)](_0xa94235(0x15c)),_0x4b0a0d=await(0x0,EmailService_1[_0xa94235(0x137)])(_0x316ac1,_0x5a455d,_0x3eef91,_0x198355,_0x4048c1,_0x1bb225);if(_0x4b0a0d[_0xa94235(0x153)])return _0x484dd7['status'](0x1f4)['json']({'error':_0x4b0a0d[_0xa94235(0x153)]});_0x484dd7[_0xa94235(0x152)](0xc8)[_0xa94235(0x134)]({'message':_0xa94235(0x136)});}catch(_0x39fbf2){console[_0xa94235(0x153)](_0xa94235(0x129),_0x39fbf2),_0x484dd7[_0xa94235(0x152)](0x1f4)[_0xa94235(0x134)]({'error':_0xa94235(0x164)});}};exports[a18_0x36908a(0x162)]=enviarEmail;const listarEmailsEnviados=async(_0x2f7122,_0x382e04)=>{const _0x246518=a18_0x36908a;try{const _0x358247=await Email_1[_0x246518(0x163)]['findAll']({'where':{'companyId':_0x2f7122[_0x246518(0x147)][_0x246518(0x133)],'scheduled':null,'sendAt':null}});_0x382e04['status'](0xc8)[_0x246518(0x134)](_0x358247);}catch(_0xc71222){console[_0x246518(0x153)](_0x246518(0x167),_0xc71222),_0x382e04[_0x246518(0x152)](0x1f4)[_0x246518(0x134)]({'error':_0x246518(0x15d)});}};exports[a18_0x36908a(0x13e)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x4a7c91,_0x3eb5ad)=>{const _0xf7f067=a18_0x36908a;try{const _0x310f94=await Email_1[_0xf7f067(0x163)][_0xf7f067(0x132)]({'where':{'companyId':_0x4a7c91[_0xf7f067(0x147)][_0xf7f067(0x133)],'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0xf7f067(0x15e)]]:null}}});_0x3eb5ad[_0xf7f067(0x152)](0xc8)[_0xf7f067(0x134)](_0x310f94);}catch(_0xb4f376){console[_0xf7f067(0x153)](_0xf7f067(0x14d),_0xb4f376),_0x3eb5ad['status'](0x1f4)[_0xf7f067(0x134)]({'error':_0xf7f067(0x169)});}};function a18_0x4cd0(){const _0x2c7c69=['5995230qiulnJ','mensagem','subject','sender','message','toString','user','winston','toDate','2423400degvES','printf','lte','Erro\x20ao\x20listar\x20e-mails\x20agendados:','apply','constructor','133838gfMlwx','agendarEnvioEmail','status','error','E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20','E-mail\x20agendado\x20com\x20sucesso','add','toISOString','__esModule','651216hNjRrB','listarEmailsAgendados','39gSRJnj','YYYY-MM-DDTHH:mm','Erro\x20ao\x20listar\x20e-mails\x20enviados','not','(((.+)+)+)+$','search','__importDefault','enviarEmail','default','Erro\x20ao\x20enviar\x20e-mail','../models/Email','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:','Erro\x20ao\x20listar\x20e-mails\x20enviados:','Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20','Erro\x20ao\x20listar\x20e-mails\x20agendados','transports','format','email','Console','Erro\x20ao\x20enviar\x20e-mail:','8lqvdrn','hour','3368604QPfTfY','sendAt','schedule','combine','moment','body','findAll','companyId','json','8395749leplNa','E-mail\x20enviado\x20com\x20sucesso','SendMail','sequelize','562681GOZQTa','update','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','create','info','listarEmailsEnviados','../services/EmailService/EmailService','defineProperty'];a18_0x4cd0=function(){return _0x2c7c69;};return a18_0x4cd0();}function a18_0x4587(_0x4f6cd7,_0x504e68){const _0x502b4=a18_0x4cd0();return a18_0x4587=function(_0x5de146,_0x522f24){_0x5de146=_0x5de146-0x125;let _0x4cd08f=_0x502b4[_0x5de146];return _0x4cd08f;},a18_0x4587(_0x4f6cd7,_0x504e68);}exports[a18_0x36908a(0x15a)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0x4f721d,_0x14bd52)=>{const _0x26f3c7=a18_0x36908a;try{const _0x1d90fa=_0x4f721d['user'][_0x26f3c7(0x133)],{recipient:_0x37ab87,subject:_0x44e33b,message:_0x5dd19d,sendAt:_0x199637}=_0x4f721d[_0x26f3c7(0x131)],_0x29b3f5=new Date(_0x199637);if(_0x29b3f5<=new Date())return _0x14bd52[_0x26f3c7(0x152)](0x190)[_0x26f3c7(0x134)]({'error':'A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro'});await Email_1[_0x26f3c7(0x163)][_0x26f3c7(0x13c)]({'sender':_0x4f721d[_0x26f3c7(0x131)][_0x26f3c7(0x127)],'subject':_0x4f721d[_0x26f3c7(0x131)]['assunto'],'message':_0x4f721d[_0x26f3c7(0x131)][_0x26f3c7(0x142)],'companyId':_0x1d90fa,'scheduled':!![],'sendAt':new Date(_0x199637)}),_0x14bd52[_0x26f3c7(0x152)](0xc8)[_0x26f3c7(0x134)]({'message':_0x26f3c7(0x155)});}catch(_0x231862){console[_0x26f3c7(0x153)](_0x26f3c7(0x166),_0x231862),_0x14bd52['status'](0x1f4)[_0x26f3c7(0x134)]({'error':_0x26f3c7(0x13b)});}};exports[a18_0x36908a(0x151)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x43aa6e=a18_0x36908a;try{const _0x103ed4=(0x0,moment_1[_0x43aa6e(0x163)])(),_0x383b36=await Email_1[_0x43aa6e(0x163)][_0x43aa6e(0x132)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x43aa6e(0x14c)]]:_0x103ed4[_0x43aa6e(0x149)]()}}});for(const _0x4c5356 of _0x383b36){const _0x379734=await(0x0,EmailService_1[_0x43aa6e(0x137)])(_0x4c5356[_0x43aa6e(0x133)],_0x4c5356[_0x43aa6e(0x144)],'',_0x4c5356[_0x43aa6e(0x143)],_0x4c5356[_0x43aa6e(0x145)],_0x4c5356[_0x43aa6e(0x12d)][_0x43aa6e(0x157)](),'');!_0x379734['error']?(await _0x4c5356[_0x43aa6e(0x13a)]({'scheduled':![]}),logger[_0x43aa6e(0x13d)](_0x43aa6e(0x154)+_0x4c5356['sender'])):logger[_0x43aa6e(0x153)](_0x43aa6e(0x168)+_0x4c5356[_0x43aa6e(0x144)]+',\x20erro:\x20'+_0x379734['error']);}}catch(_0x428fe1){logger[_0x43aa6e(0x153)]('Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:',_0x428fe1);}};node_cron_1[a18_0x36908a(0x163)][a18_0x36908a(0x12e)]('*/30\x20*\x20*\x20*\x20*\x20*',enviarAgendamentosPendentes);