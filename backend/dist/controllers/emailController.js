const a18_0x46b686=a18_0x57f9;function a18_0x292b(){const _0x22456f=['__esModule','email','findAll','printf','body','6550qMQiFR','1675524DgJQiA','sendAt','listarEmailsAgendados','enviarEmail','11209976ERpqNn','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','toString','724EZcAFv','(((.+)+)+)+$','sender','timestamp','Console','toDate','user','10EWLhhs','20535fDVlJM','create','info','add','status','format','winston','lte','assunto',',\x20erro:\x20','not','combine','21256UTWtqI','hour','E-mail\x20agendado\x20com\x20sucesso','7vcgtys','agendarEnvioEmail','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','../models/Email','mensagem','default','13011939WsiwdQ','E-mail\x20enviado\x20com\x20sucesso','Erro\x20ao\x20listar\x20e-mails\x20agendados:','createLogger','listarEmailsEnviados','../services/EmailService/EmailService','2824086foTGiu','E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20','Erro\x20ao\x20enviar\x20e-mail:','Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20','companyId','node-cron','update','constructor','Erro\x20ao\x20listar\x20e-mails\x20agendados','error','toISOString','subject','search','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','44605IlHDKh','Erro\x20ao\x20listar\x20e-mails\x20enviados:','Erro\x20ao\x20listar\x20e-mails\x20enviados','schedule','json','SendMail'];a18_0x292b=function(){return _0x22456f;};return a18_0x292b();}(function(_0x3f8b23,_0x18ebaf){const _0x38e613=a18_0x57f9,_0x219ba3=_0x3f8b23();while(!![]){try{const _0x20f6bd=-parseInt(_0x38e613(0xc9))/0x1*(-parseInt(_0x38e613(0xbc))/0x2)+-parseInt(_0x38e613(0xd8))/0x3+parseInt(_0x38e613(0xb5))/0x4*(-parseInt(_0x38e613(0xbd))/0x5)+-parseInt(_0x38e613(0xae))/0x6*(parseInt(_0x38e613(0xcc))/0x7)+-parseInt(_0x38e613(0xb2))/0x8+parseInt(_0x38e613(0xd2))/0x9+parseInt(_0x38e613(0xad))/0xa*(parseInt(_0x38e613(0xe6))/0xb);if(_0x20f6bd===_0x18ebaf)break;else _0x219ba3['push'](_0x219ba3['shift']());}catch(_0x56970e){_0x219ba3['push'](_0x219ba3['shift']());}}}(a18_0x292b,0xcdc5e));const a18_0x4f0647=(function(){let _0x8e3bc6=!![];return function(_0x44537a,_0x5dfe2f){const _0x493928=_0x8e3bc6?function(){if(_0x5dfe2f){const _0x94cca4=_0x5dfe2f['apply'](_0x44537a,arguments);return _0x5dfe2f=null,_0x94cca4;}}:function(){};return _0x8e3bc6=![],_0x493928;};}()),a18_0x270de3=a18_0x4f0647(this,function(){const _0x5780ce=a18_0x57f9;return a18_0x270de3[_0x5780ce(0xb4)]()[_0x5780ce(0xe4)](_0x5780ce(0xb6))['toString']()[_0x5780ce(0xdf)](a18_0x270de3)['search'](_0x5780ce(0xb6));});function a18_0x57f9(_0x35c99a,_0x2f5c1a){const _0x3b9930=a18_0x292b();return a18_0x57f9=function(_0x270de3,_0x4f0647){_0x270de3=_0x270de3-0xa7;let _0x292bcf=_0x3b9930[_0x270de3];return _0x292bcf;},a18_0x57f9(_0x35c99a,_0x2f5c1a);}a18_0x270de3();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2a9489){const _0x396e5d=a18_0x57f9;return _0x2a9489&&_0x2a9489[_0x396e5d(0xa8)]?_0x2a9489:{'default':_0x2a9489};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a18_0x46b686(0xcd)]=exports['listarEmailsAgendados']=exports[a18_0x46b686(0xd6)]=exports[a18_0x46b686(0xb1)]=void 0x0;const EmailService_1=require(a18_0x46b686(0xd7)),Email_1=__importDefault(require(a18_0x46b686(0xcf))),moment_1=__importDefault(require('moment')),node_cron_1=__importDefault(require(a18_0x46b686(0xdd))),sequelize_1=require('sequelize'),winston_1=__importDefault(require(a18_0x46b686(0xc3))),logger=winston_1[a18_0x46b686(0xd1)][a18_0x46b686(0xd5)]({'level':a18_0x46b686(0xbf),'format':winston_1[a18_0x46b686(0xd1)][a18_0x46b686(0xc2)][a18_0x46b686(0xc8)](winston_1[a18_0x46b686(0xd1)]['format'][a18_0x46b686(0xb8)](),winston_1[a18_0x46b686(0xd1)][a18_0x46b686(0xc2)][a18_0x46b686(0xab)](({timestamp:_0x499c6a,level:_0x280a97,message:_0xe89fd8})=>{return _0x499c6a+'\x20'+_0x280a97+':\x20'+_0xe89fd8;})),'transports':[new winston_1[(a18_0x46b686(0xd1))]['transports'][(a18_0x46b686(0xb9))]()]}),enviarEmail=async(_0x1decd,_0x32f88e)=>{const _0x1efd5d=a18_0x46b686;try{const _0x4d91b3=_0x1decd[_0x1efd5d(0xbb)][_0x1efd5d(0xdc)],{email:_0x1a63ef,tokenSenha:_0x5e70db,assunto:_0x60b2b,mensagem:_0x23155d}=_0x1decd['body'],_0x5e7901=(0x0,moment_1[_0x1efd5d(0xd1)])()[_0x1efd5d(0xc0)](0x1,_0x1efd5d(0xca))['format']('YYYY-MM-DDTHH:mm'),_0x95a5c7=await(0x0,EmailService_1[_0x1efd5d(0xa7)])(_0x4d91b3,_0x1a63ef,_0x5e70db,_0x60b2b,_0x23155d,_0x5e7901);if(_0x95a5c7[_0x1efd5d(0xe1)])return _0x32f88e[_0x1efd5d(0xc1)](0x1f4)[_0x1efd5d(0xea)]({'error':_0x95a5c7[_0x1efd5d(0xe1)]});_0x32f88e['status'](0xc8)[_0x1efd5d(0xea)]({'message':_0x1efd5d(0xd3)});}catch(_0x1dbd24){console[_0x1efd5d(0xe1)](_0x1efd5d(0xda),_0x1dbd24),_0x32f88e[_0x1efd5d(0xc1)](0x1f4)['json']({'error':'Erro\x20ao\x20enviar\x20e-mail'});}};exports['enviarEmail']=enviarEmail;const listarEmailsEnviados=async(_0xd8e6a1,_0x5dbe2a)=>{const _0x295567=a18_0x46b686;try{const _0x4b5142=await Email_1['default']['findAll']({'where':{'companyId':_0xd8e6a1[_0x295567(0xbb)][_0x295567(0xdc)],'scheduled':null,'sendAt':null}});_0x5dbe2a[_0x295567(0xc1)](0xc8)[_0x295567(0xea)](_0x4b5142);}catch(_0x2bbab2){console[_0x295567(0xe1)](_0x295567(0xe7),_0x2bbab2),_0x5dbe2a[_0x295567(0xc1)](0x1f4)[_0x295567(0xea)]({'error':_0x295567(0xe8)});}};exports[a18_0x46b686(0xd6)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x35f8b1,_0x244be5)=>{const _0x377563=a18_0x46b686;try{const _0x4b6820=await Email_1['default']['findAll']({'where':{'companyId':_0x35f8b1[_0x377563(0xbb)][_0x377563(0xdc)],'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x377563(0xc7)]]:null}}});_0x244be5['status'](0xc8)['json'](_0x4b6820);}catch(_0x21e075){console[_0x377563(0xe1)](_0x377563(0xd4),_0x21e075),_0x244be5[_0x377563(0xc1)](0x1f4)[_0x377563(0xea)]({'error':_0x377563(0xe0)});}};exports[a18_0x46b686(0xb0)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0xe00433,_0x33e7cc)=>{const _0xfc7181=a18_0x46b686;try{const _0x34aa0e=_0xe00433['user'][_0xfc7181(0xdc)],{recipient:_0x4307da,subject:_0x4ac2e6,message:_0x4bc246,sendAt:_0x110277}=_0xe00433[_0xfc7181(0xac)],_0x1a2202=new Date(_0x110277);if(_0x1a2202<=new Date())return _0x33e7cc['status'](0x190)['json']({'error':_0xfc7181(0xe5)});await Email_1[_0xfc7181(0xd1)][_0xfc7181(0xbe)]({'sender':_0xe00433[_0xfc7181(0xac)][_0xfc7181(0xa9)],'subject':_0xe00433['body'][_0xfc7181(0xc5)],'message':_0xe00433['body'][_0xfc7181(0xd0)],'companyId':_0x34aa0e,'scheduled':!![],'sendAt':new Date(_0x110277)}),_0x33e7cc['status'](0xc8)[_0xfc7181(0xea)]({'message':_0xfc7181(0xcb)});}catch(_0xb60c05){console[_0xfc7181(0xe1)]('Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:',_0xb60c05),_0x33e7cc[_0xfc7181(0xc1)](0x1f4)[_0xfc7181(0xea)]({'error':_0xfc7181(0xb3)});}};exports['agendarEnvioEmail']=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x34980f=a18_0x46b686;try{const _0x8b83d8=(0x0,moment_1['default'])(),_0x5e0848=await Email_1[_0x34980f(0xd1)][_0x34980f(0xaa)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x34980f(0xc4)]]:_0x8b83d8[_0x34980f(0xba)]()}}});for(const _0x4cdddf of _0x5e0848){const _0x5781a7=await(0x0,EmailService_1[_0x34980f(0xa7)])(_0x4cdddf[_0x34980f(0xdc)],_0x4cdddf[_0x34980f(0xb7)],'',_0x4cdddf[_0x34980f(0xe3)],_0x4cdddf['message'],_0x4cdddf[_0x34980f(0xaf)][_0x34980f(0xe2)](),'');!_0x5781a7[_0x34980f(0xe1)]?(await _0x4cdddf[_0x34980f(0xde)]({'scheduled':![]}),logger['info'](_0x34980f(0xd9)+_0x4cdddf[_0x34980f(0xb7)])):logger[_0x34980f(0xe1)](_0x34980f(0xdb)+_0x4cdddf[_0x34980f(0xb7)]+_0x34980f(0xc6)+_0x5781a7[_0x34980f(0xe1)]);}}catch(_0x2b5706){logger[_0x34980f(0xe1)](_0x34980f(0xce),_0x2b5706);}};node_cron_1[a18_0x46b686(0xd1)][a18_0x46b686(0xe9)]('*/30\x20*\x20*\x20*\x20*\x20*',enviarAgendamentosPendentes);